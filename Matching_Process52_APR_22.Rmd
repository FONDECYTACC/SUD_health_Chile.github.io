---
title: "Ambulatory or residential? a multi-state analysis of treatments for substance use disorders (Step 5)"
date: "`r withr::with_locale(new = c('LC_TIME' = 'C'), code =format(Sys.time(),'%B %d, %Y'))`"
output:
  html_document:
    code_folding: hide  
    toc: true # table of content true
    toc_depth: 5  # upto three depths of headings (specified by #, ## and ###)
    toc_float: true
---


```{css zoom-lib-src, echo = FALSE}
script src = "https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"
```

```{js zoom-jquery, echo = FALSE}
 $(document).ready(function() {
    $('body').prepend('<div class=\"zoomDiv\"><img src=\"\" class=\"zoomImg\"></div>');
    // onClick function for all plots (img's)
    $('img:not(.zoomImg)').click(function() {
      $('.zoomImg').attr('src', $(this).attr('src')).css({width: '100%'});
      $('.zoomDiv').css({opacity: '1', width: 'auto', border: '1px solid white', borderRadius: '5px', position: 'fixed', top: '50%', left: '50%', marginRight: '-50%', transform: 'translate(-50%, -50%)', boxShadow: '0px 0px 50px #888888', zIndex: '50', overflow: 'auto', maxHeight: '100%'});
    });
    // onClick function for zoomImg
    $('img.zoomImg').click(function() {
      $('.zoomDiv').css({opacity: '0', width: '0%'}); 
    });
  });
```

```{=html}
<style type="text/css">
.tablelines table, .tablelines td, .tablelines th {
        border: 1px solid black;
        }
.centrado {
    text-align: center;
}
.table.center {
    margin-left:auto; 
    margin-right:auto;
  }
.table_wrapper{
    display: block;
    overflow-x: auto;
    white-space: nowrap;
}
code.r{
  font-size: 8px;
}
body{ /* Normal  */
      text-align: justify;
  }
.superbigimage{
    overflow-y:scroll;
    white-space: nowrap;
}
.superbigimage img{
    overflow-y: scroll;
    overflow-x: hidden;
}
</style>
```
```{=html}
<style>
div.blue { background-color:#e6f0ff; border-radius: 5px; padding: 20px; text-align: justify;}
</style>
```
```{r prev_setup, include = FALSE, cache=T}
rm(list=ls());gc()
if(!grepl("4.0.2",R.version.string)){stop("Different version (must be 4.0.2)")}
path<-rstudioapi::getSourceEditorContext()$path

if (grepl("CISS Fondecyt",path)==T){
  setwd("C:/Users/CISS Fondecyt/Mi unidad/Alvacast/SISTRAT 2019 (github)/SUD_CL/");load("C:/Users/CISS Fondecyt/Mi unidad/Alvacast/SISTRAT 2019 (github)/mult_state_4_apr22.RData")
} else if (grepl("andre",path)==T){
  setwd('C:/Users/andre/Desktop/SUD_CL/');load("E:/Mi unidad/Alvacast/SISTRAT 2019 (github)/mult_state_4_apr22.RData")
} else if (grepl("E:",path)==T){
  setwd("E:/Mi unidad/Alvacast/SISTRAT 2019 (github)/SUD_CL/");load("E:/Mi unidad/Alvacast/SISTRAT 2019 (github)/mult_state_4_apr22.RData")
} else {
  setwd("G:/Mi unidad/Alvacast/SISTRAT 2019 (github)/SUD_CL/");load("G:/Mi unidad/Alvacast/SISTRAT 2019 (github)/mult_state_4_apr22.RData")
}
```

```{r setup, include = FALSE, cache=T}
#Libraries used in the routine. Dont change the order
local({r <- getOption("repos")
       r["CRAN"] <- "http://cran.r-project.org" 
       options(repos=r)
})
copiar_nombres <- function(x,row.names=FALSE,col.names=TRUE,dec=",",...) {
  if(class(ungroup(x))[1]=="tbl_df"){
        if(options()$OutDec=="."){
            options(OutDec = dec)
            write.table(format(data.frame(x)),"clipboard",sep="\t",row.names=FALSE,col.names=col.names,...)
            options(OutDec = ".")
          return(x)
        } else {
            options(OutDec = ",")
            write.table(format(data.frame(x)),"clipboard",sep="\t",row.names=FALSE,col.names=col.names,...)
            options(OutDec = ",")
          return(x)    
        }
  } else {
        if(options()$OutDec=="."){
            options(OutDec = dec)
            write.table(format(x),"clipboard",sep="\t",row.names=FALSE,col.names=col.names,...)
            options(OutDec = ".")
          return(x)
        } else {
            options(OutDec = ",")
            write.table(format(x),"clipboard",sep="\t",row.names=FALSE,col.names=col.names,...)
            options(OutDec = ",")
          return(x)       
  }
 }
}  

library(MASS)
try(library(boot))
library(matrixStats)
library(knitr)
library(tidyr)
library(stringi)
library(stringr)
library(ggplot2)
library(Hmisc)
library(kableExtra)
library(plotly)
library(janitor)
library(rbokeh)
library(zoo)
library(broom)
library(sqldf)
library(devtools)
library(codebook)
library(data.table)
library(panelr)
library(RColorBrewer)
library(lsmeans)
library(finalfit)
suppressPackageStartupMessages(library(ggiraph))
suppressPackageStartupMessages(library(sf))
library(treemapify)
library(dplyr)
library(tidyverse)
library(epiR)
library(survminer)
library(ggfortify)
library(survMisc)

library(foreign)
library(Hmisc)
library(gridExtra)
library(reshape2)
library(stargazer)
library(tableone)
library(MatchIt)
library(cobalt)
library(eha)
library(igraph)
library(Amelia)
library(DiagrammeR) 
library(mstate)
library(flexsurv)
library(muhaz)
library(Metrics)

library(TraMineR)
library(RColorBrewer)
library(TraMineRextras)
library(WeightedCluster)
library(cluster)
library(parcats)
library(easyalluvial)
library(timereg)

library(htmltools)
library(rsvg)
library(DiagrammeR)
library(DiagrammeRsvg)
library(EValue)
library(coxphw)
library(data.tree)
library(ggh4x)
#library(mstateutils)
#remotes::install_github("chjackson/flexsurv-dev", upgrade = "never")
#devtools::install_github("stulacy/multistateutils", build_vignettes=TRUE, upgrade = "never")
#devtools::install_github("hputter/mstate", upgrade = "never")
#unlink("C:/Users/CISS Fondecyt/OneDrive/Documentos/R/win-library/4.0/mstate", recursive=T, force=T)

if(!require(radiant.update)){install.packages("radiant.update", repos = "https://radiant-rstats.github.io/minicran/")}
#install.packages( repos = "https://radiant-rstats.github.io/minicran/")
#install.packages("radiant.update", repos = "https://radiant-rstats.github.io/minicran/")

#tryCatch(source("https://raw.githubusercontent.com/radiant-rstats/minicran/gh-pages/update.R"), error = function(e) print("updated package, radiant"))

#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:
#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:
#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:

try_with_time_limit <- function(expr, cpu = Inf, elapsed = Inf)
{
  y <- try({setTimeLimit(cpu, elapsed); expr}, silent = TRUE) 
  if(inherits(y, "try-error")) NULL else y 
}
eval_fork <- function(..., timeout=60){

  #this limit must always be higher than the timeout on the fork!
  setTimeLimit(timeout+5);      

  #dispatch based on method
  ##NOTE!!!!! Due to a bug in mcparallel, we cannot use silent=TRUE for now.
  myfork <- parallel::mcparallel({
    eval(...)
  }, silent=FALSE);

  #wait max n seconds for a result.
  myresult <- parallel::mccollect(myfork, wait=FALSE, timeout=timeout);

  #try to avoid bug/race condition where mccollect returns null without waiting full timeout.
  #see https://github.com/jeroenooms/opencpu/issues/131
  #waits for max another 2 seconds if proc looks dead 
  while(is.null(myresult) && totaltime < timeout && totaltime < 2) {
     Sys.sleep(.1)
     enddtime <- Sys.time();
     totaltime <- as.numeric(enddtime - starttime, units="secs")
     myresult <- parallel::mccollect(myfork, wait = FALSE, timeout = timeout);
  }

  #kill fork after collect has returned
  tools::pskill(myfork$pid, tools::SIGKILL);    
  tools::pskill(-1 * myfork$pid, tools::SIGKILL);  

  #clean up:
  parallel::mccollect(myfork, wait=FALSE);

  #timeout?
  if(is.null(myresult)){
    stop("R call did not return within ", timeout, " seconds. Terminating process.", call.=FALSE);      
  }

  #move this to distinguish between timeout and NULL returns
  myresult <- myresult[[1]];

  #reset timer
  setTimeLimit();     

  #forks don't throw errors themselves
  if(inherits(myresult,"try-error")){
    #stop(myresult, call.=FALSE);
    stop(attr(myresult, "condition"));
  }

  #send the buffered response
  return(myresult);  
}
#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:
#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:

```

<br>


### Extended Cox

#### Weighted (GT)

```{r 0_gt, include=T,warning=F, message=F, results="hide"}
coxphw_pwp_int_gt<-
  coxphw(Surv(time,status) ~ tipo_de_plan_res_1*strata(trans)+  
           TD_1+ TD_2+ TD_3+ TD_4+ cluster(id) + strata(trans), data = ms_d_match_surv,template="AHR",  robust=T)
coxphw_pwp_int2_gt<-
  coxphw(Surv(time,status) ~ tipo_de_plan_res_1+ tipo_de_plan_res_1:strata(trans)+  
           TD_1+ TD_2+ TD_3+ TD_4+ cluster(id), data = ms_d_match_surv,template="AHR",  robust=T)

coxph_pwp_int_gt<-
  coxph(Surv(time,status) ~ tipo_de_plan_res_1*strata(trans)+  
           TD_1+ TD_2+ TD_3+ TD_4+ cluster(id) + strata(trans), data = ms_d_match_surv)
coxph_pwp_int2_gt<-
  coxph(Surv(time,status) ~ tipo_de_plan_res_1+ tipo_de_plan_res_1:strata(trans)+  
           TD_1+ TD_2+ TD_3+ TD_4+ cluster(id) + strata(trans), data = ms_d_match_surv)

A01_gt<-rbind("M - L" = c(-1, 1, 0),
                 "H - L" = c(-1, 0, 1))
A01_gt = matrix(c(1,1,1,0,0,1), ncol=3)
b01_gt <- matrix(coxphw_pwp_int2_gt$coeff[c(1,7:8)], ncol=1)
V01_gt <- vcov(coxphw_pwp_int2_gt)[c(1,7:8),c(1,7:8)]

B01 <- MASS::mvrnorm(250000, mu=b01_gt, Sigma=V01_gt)
nlcom01_gt <- exp(A01 %*% b01)
nlsim01_gt <- exp(A01 %*% t(B01))
nlcis01_gt <- apply(nlsim01_gt, 1, quantile, c(.025,.975))
```

```{r 1_gt, include=T,warning=F, message=F}
A02_gt<-matrix(c(1,1,1,1,0,0,0,1,0,0,0,1), nrow=3, ncol=4)
#A02<-matrix(c(-1,1,-1,1,0,0,0,-1,0,0,0,1), nrow=3, ncol=4)
b02_gt<-matrix(coxphw_pwp_int2_gt$coeff[c(1,7:9)], ncol=1)
V02_gt <- vcov(coxphw_pwp_int2_gt)[c(1,7:9),c(1,7:9)]

B02_gt <- MASS::mvrnorm(250000, mu=b02_gt, Sigma=V02_gt)
nlcom02_gt <- exp(A02 %*% b02)
nlsim02_gt <- exp(A02 %*% t(B02))
nlcis02_gt <- apply(nlsim02_gt, 1, quantile, c(.025,.975))
nlcis02_gt
```

```{r 2_gt, include=T,warning=F, message=F, results="hide"}
res_pwp_w_gt <- cbind.data.frame(Avg_HR=round(exp(coxphw_pwp_int_gt$coeff),2),
                               Lo_ci95=round(exp(confint(coxphw_pwp_int_gt))[,1],2),
                               Up_ci95=round(exp(confint(coxphw_pwp_int_gt))[,2],2),
                               p=round(summary(coxphw_pwp_int_gt)$prob,4))%>% 
  data.table::data.table(keep.rownames=T)

res_pwp_w2_gt <- cbind.data.frame(Avg_HR=round(exp(coxphw_pwp_int2_gt$coeff),2),
                               Lo_ci95=round(exp(confint(coxphw_pwp_int2_gt))[,1],2),
                               Up_ci95=round(exp(confint(coxphw_pwp_int2_gt))[,2],2),
                               p=round(summary(coxphw_pwp_int2_gt)$prob,4))%>% 
  data.table::data.table(keep.rownames=T)
```

```{r 2.5_gt, include=T,warning=F, message=F}
options(knitr.kable.NA = '')
res_pwp_w2_gt %>% 
dplyr::left_join(cbind.data.frame(names=attr(coxphw_pwp_int2_gt$coeff[c(7:9)],"names"),lo_ci_2=round(nlcis02_gt[1,],2),up_ci_2=round(nlcis02_gt[2,],2)), by=c("rn"="names"))%>% 
  dplyr::full_join(res_pwp_w_gt,by="rn", suffix = c("_coef1", "_coef2")) %>% 
  knitr::kable(size=8,"html") %>% 
kableExtra::kable_classic() %>% 
  kableExtra::add_header_above(c("", "Does not include transitions"=4, "Three (bootstrap)"=2,"Includes transition as an additive term"=4))
```

<br>

#### Timecox (GT)

<div style="border: 1px solid #ddd; padding: 5px; overflow-y: scroll; height:350px; overflow-x: scroll; width:100%">
```{r first_try_gt,eval=T, echo=T, paged.print=TRUE, error=T}                                 
invisible("Investigating time-varying coefficient with timereg package")
#https://www.ncbi.nlm.nih.gov/labs/pmc/articles/PMC6015946/

#Zhang, Z., Reinikainen, J., Adeleke, K. A., Pieterse, M. E., & Groothuis-Oudshoorn, C. (2018). Time-varying covariates #and coefficients in Cox regression models. Annals of translational medicine, 6(7), 121. https://doi.org/10.21037/atm.2018.02.12

#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_
#In this case the time-varying effect is tested by resampling method 

# fits Cox models with possibly time-varying effects
#fits the proportional hazards model, but allows for covariates to be included under the non-proportional hazards assumption as well,#using an extension of the traditional Cox model

#recommended for instances where testing the significance of the NPH covariate effects are important, particularly if the estimate of the hazard rate is not imperative. The timereg package is well-designed, user-friendly,#and has plenty of associated documentation, and thus it is a very valuable piece of software for implementing#a variety of complex survival models. However, for survival modeling when the estimate of the hazard rate is#needed, other more reliable functions from other packages are available for including covariates under both the
#PH and the NPH setting

#here the test processes for each covariate with 1,00 randomly choosen 
#realizations under the null hypothesis of constant effects
timecox_pwp_gt<- 
  timecox(Surv(time,status) ~ tipo_de_plan_res_1*strata(trans)+  
            TD_1+ TD_2+ TD_3+ TD_4+ cluster(id) + strata(trans), Nit = 100,
          data = ms_d_match_surv, n.sim=3000, robust = 1, weighted.test = 1)
```

</div>

```{r first_try2_gt,eval=T, echo=T, paged.print=TRUE, error=T}                                 
summary_test_t_inv0_gt<-capture.output(summary(timecox_pwp_gt_gt))
summary_test_t_inv_sel0_gt<-summary_test_t_inv0_gt[which(grepl("Test for time invariant", summary_test_t_inv0_gt)):(which(grepl("Call", summary_test_t_inv0_gt))-3)]
summary_test_t_inv_sel0_df_gt<-
data.frame(summary_test_t_inv_sel0_gt) %>% 
    dplyr::mutate(summary_test_t_inv_sel0_gt=gsub("\\s+\\s+\\s+\\s+\\s+", "\\[\\[", summary_test_t_inv_sel0)) %>%  
    tidyr::separate(summary_test_t_inv_sel0_gt,c("Variable","Test","pvalue"),sep="\\[\\[") %>% 
    dplyr::slice(-1) %>% 
  #test p-value H_0:constant effect
    dplyr::mutate(type=dplyr::case_when(grepl("Kolmogorov",Test)~ "Kolmogorov-Smirnov",
                                        grepl("Cramer",Test)~ "Cramer von Mises",
                                        T~NA_character_)) %>% 
    tidyr::fill(type,.direction = "down") %>% 
  dplyr::select(Variable, type, Test, pvalue) %>% 
  tidyr::drop_na(pvalue)

summary(timecox_pwp_gt)
```

<br>

<div style="border: 1px solid #ddd; padding: 5px; overflow-y: scroll; height:350px; overflow-x: scroll; width:100%">
```{r second_try_gt,eval=T, echo=T, paged.print=TRUE, error=T}                                 
invisible("no cambiaré el maxtime, pero sí llevaré a constantes algunas variables encontradas arriba: TD2 y TD4")
timecox_pwp_const1_gt<- 
  timecox(Surv(time,status) ~ tipo_de_plan_res_1*strata(trans)+ 
            TD_1+ const(TD_2)+ TD_3+ const(TD_4)+ cluster(id) + strata(trans), Nit = 100, data = ms_d_match_surv, n.sim=3000, robust = 1, weighted.test = 1)
```
</div>

```{r second_try2_gt,eval=T, echo=T, paged.print=TRUE, error=T}                                 
summary_test_t_inv1_gt<-capture.output(summary(timecox_pwp_const1_gt))
summary_test_t_inv_sel1_gt<-summary_test_t_inv1_gt[which(grepl("Test for time invariant|Test for non-significant", summary_test_t_inv1_gt)):(which(grepl("Parametric|Call", summary_test_t_inv1_gt))-2)]
summary_test_t_inv_sel1_df_gt<-
data.frame(summary_test_t_inv_sel1_gt) %>% 
    dplyr::mutate(summary_test_t_inv_sel1_gt=gsub("\\s+\\s+\\s+\\s+\\s+", "\\[\\[", summary_test_t_inv_sel1)) %>%  
    tidyr::separate(summary_test_t_inv_sel1_gt,c("Variable","Test","pvalue"),sep="\\[\\[") %>% 
    dplyr::slice(-1) %>% 
  #test p-value H_0:constant effect
    dplyr::mutate(type=dplyr::case_when(grepl("Supremum",Test)~"Supremum-test of significance",
                                        grepl("Kolmogorov",Test)~ "Kolmogorov-Smirnov",
                                        grepl("Cramer",Test)~ "Cramer von Mises",
                                        T~NA_character_)) %>% 
    tidyr::fill(type,.direction = "down") %>% 
  dplyr::select(Variable, type, Test, pvalue) %>% 
  tidyr::drop_na(pvalue) %>% 
  dplyr::mutate(pvalue=dplyr::case_when(pvalue=="0.00000"~"<0.001",
                                        pvalue=="0.000"~"<0.001",
                                        pvalue=="0.0000"~"<0.001",
                                        T~pvalue))

summary(timecox_pwp_const1_gt)
```

<br>

<div style="border: 1px solid #ddd; padding: 5px; overflow-y: scroll; height:350px; overflow-x: scroll; width:100%">
```{r third_try_gt,eval=T, echo=T, paged.print=TRUE, error=T}      
invisible("TD3 puede sacarse")
timecox_pwp_const2_opc1_gt<- 
  timecox(Surv(time,status) ~ const(tipo_de_plan_res_1)*strata(trans)+ 
            TD_1+ const(TD_2)+ const(TD_3)+ const(TD_4)+ cluster(id), Nit = 100,
          data = ms_d_match_surv, n.sim=3000, robust = 1, weighted.test = 1)
```
</div>

```{r third_try2_gt,eval=T, echo=T, paged.print=TRUE, error=T}    
summary_test_t_inv2_1_gt<-capture.output(summary(timecox_pwp_const2_opc1_gt))
summary_test_t_inv_sel2_1_gt<-summary_test_t_inv2_1_gt[which(grepl("Test for time invariant|Test for non-significant", summary_test_t_inv2_1_gt)):(which(grepl("Parametric|Call", summary_test_t_inv2_1_gt))-2)]
summary_test_t_inv_sel2_1_df_gt<-
data.frame(summary_test_t_inv_sel2_1_gt) %>% 
    dplyr::mutate(summary_test_t_inv_sel2_1_gt=gsub("\\s+\\s+\\s+\\s+\\s+", "\\[\\[", summary_test_t_inv_sel2_1_gt)) %>%  
    tidyr::separate(summary_test_t_inv_sel2_1_gt,c("Variable","Test","pvalue"),sep="\\[\\[") %>% 
    dplyr::slice(-1) %>% 
  #test p-value H_0:constant effect
    dplyr::mutate(type=dplyr::case_when(grepl("Supremum",Test)~"Supremum-test of significance",
                                        grepl("Kolmogorov",Test)~ "Kolmogorov-Smirnov",
                                        grepl("Cramer",Test)~ "Cramer von Mises",
                                        T~NA_character_)) %>% 
    tidyr::fill(type,.direction = "down") %>% 
  dplyr::select(Variable, type, Test, pvalue) %>% 
  tidyr::drop_na(pvalue) %>% 
  dplyr::mutate(pvalue=dplyr::case_when(pvalue=="0.00000"~"<0.001",
                                        pvalue=="0.000"~"<0.001",
                                        T~pvalue))

summary(timecox_pwp_const2_opc1_gt)
```

<br>

<div style="border: 1px solid #ddd; padding: 5px; overflow-y: scroll; height:350px; overflow-x: scroll; width:100%">
```{r fourth_try_gt,eval=T, echo=T, paged.print=TRUE, error=T}      
invisible("TD1 puede sacarse")
timecox_pwp_const2_opc2_gt<- 
  timecox(Surv(time,status) ~ const(tipo_de_plan_res_1)*strata(trans)+ 
            const(TD_1)+ const(TD_2)+ const(TD_3)+ const(TD_4)+ cluster(id), Nit = 100, data = ms_d_match_surv, n.sim=3000, robust = 1, weighted.test = 1)
```
</div>


```{r fourth_try2_gt,eval=T, echo=T, paged.print=TRUE, error=T}    
summary_test_t_inv2_2_gt<-capture.output(summary(timecox_pwp_const2_opc2_gt))
summary_test_t_inv_sel2_2_gt<-summary_test_t_inv2_2_gt[which(grepl("Test for time invariant|Test for non-significant", summary_test_t_inv2_2_gt)):(which(grepl("Parametric|Call", summary_test_t_inv2_2_gt))-2)]
summary_test_t_inv_sel2_2_df_gt<-
data.frame(summary_test_t_inv_sel2_2_gt) %>% 
    dplyr::mutate(summary_test_t_inv_sel2_2_gt=gsub("\\s+\\s+\\s+\\s+\\s+", "\\[\\[", summary_test_t_inv_sel2_2_gt)) %>%  
    tidyr::separate(summary_test_t_inv_sel2_2_gt,c("Variable","Test","pvalue"),sep="\\[\\[") %>% 
    dplyr::slice(-1) %>% 
  #test p-value H_0:constant effect
    dplyr::mutate(type=dplyr::case_when(grepl("Supremum",Test)~"Supremum-test of significance",
                                        grepl("Kolmogorov",Test)~ "Kolmogorov-Smirnov",
                                        grepl("Cramer",Test)~ "Cramer von Mises",
                                        T~NA_character_)) %>% 
    tidyr::fill(type,.direction = "down") %>% 
  dplyr::select(Variable, type, Test, pvalue) %>% 
  tidyr::drop_na(pvalue) %>% 
  dplyr::mutate(pvalue=dplyr::case_when(pvalue=="0.00000"~"<0.001",
                                        pvalue=="0.000"~"<0.001",
                                        T~pvalue))

summary(timecox_pwp_const2_opc2_gt)
```

<br>

Holding constant other effects, allows us to detect that the treatment setting had time-invariant effects indeed.

<br>

<div style="border: 1px solid #ddd; padding: 5px; overflow-y: scroll; height:350px; overflow-x: scroll; width:100%">
```{r plot_gt, echo=T, error=T, paged.print=TRUE, fig.height=9, error=T, dpi=500, fig.show='hide'}

plot_cums(timecox_pwp_const2_opc1_gt)
```
</div>

<br>

```{r plot_td_gt, echo=T, error=T, paged.print=TRUE, fig.width=10, fig.height=6, error=T, dpi=500, fig.cap="Figure 1. Observed cumulative coefficients with 95% confidence bands"}

timecox_pwp_const2_opc1_TD_1_gt %>% 
	dplyr::mutate(year=`B[, 1]`/365.25,variable="Treatment\nCompletion") %>% 
	dplyr::filter(year<=5) %>% 
	dplyr::mutate(variable=factor(variable)) %>% 
	ggplot()+
	geom_ribbon(aes(x=year, ymin = nl, ymax = ul, fill =variable), alpha=.5) +# "steelblue"
	geom_line(aes(x=year, y = est, color=variable))+ #"dodgerblue4"
	theme_void()+ 
	geom_hline(yintercept = 0)+
	scale_color_manual(name="Variable",values=c("dodgerblue4","black"))+
	scale_fill_manual(name="Variable",values=c("steelblue","grey70"))+
	labs(y="Cumulative coefficients",x="Years")+
	scale_y_continuous(breaks = seq(-450,450,by = 90), limits=c(-450,450))+
	scale_x_continuous(breaks = seq(0,5,by = .5), limits=c(0,5))+
	theme(axis.title.y = element_text(size = 15, angle=90))+
	theme(axis.title.x = element_text(size = 15))+
	theme(axis.text.x = element_text(size = 13))+
	theme(axis.text.y = element_text(size = 13))+
	theme(legend.position = "none")
```

<br>

```{r third_try4_table_gt,eval=T, echo=T, paged.print=TRUE, error=T}
 options(knitr.kable.NA = '')
#upper97.5%

coefBase(timecox_pwp_const2_opc2_gt, digits=3) %>% 
   data.table::data.table(keep.rownames = T) %>% 
  dplyr::rename("Variables"="rn") %>% 
    dplyr::mutate(HR= round(exp(`Coef.`),2), HR_95_CI_lo= round(exp(`lower2.5%`),2), HR_95_CI_up= round(exp(`upper97.5%`),2)) %>% 
  dplyr::mutate(Variables=dplyr::case_when(grepl("tipo_de_plan.*trans.*2", Variables)~"Setting at baseline x completion of 2nd treatment",
                                           grepl("tipo_de_plan.*trans.*3", Variables)~"Setting at baseline x completion of 3rd treatment",
                                           grepl("tipo_de_plan.*trans.*4", Variables)~"Setting at baseline x completion of 4th treatment",
    grepl("tipo_de_plan", Variables)~"Setting at baseline",
                                           grepl("TD_1", Variables)~"Completion at baseline",
                                           grepl("TD_2", Variables)~"Completion of the 2nd treatment",
                                           grepl("TD_3", Variables)~"Completion of the 3rd treatment",
                                           grepl("TD_4", Variables)~"Completion of the 4th treatment",
                                           grepl("trans=2", Variables)~"Second transition (stratum)",
                                           grepl("trans=3", Variables)~"Third transition (stratum)",
                                           grepl("trans=4", Variables)~"Fourth transition (stratum)",
                                           )) %>% 
    knitr::kable(.,format = "html", format.args = list(decimal.mark = ".", big.mark = ","),
       caption = paste0("Table. Coefficients"),
       col.names = c("Variables","Coef.", "SE", "Robust SE", "z", "Sig.", "95%CI Lower", "95%CI Upper", "HR", "95%CI Lower", "95%CI Upper"), align =c('l',rep('c', 101)), escape=T) %>%
  kableExtra::kable_classic(bootstrap_options = c("striped", "hover"),font_size = 12) %>%
  kableExtra::scroll_box(width = "100%", height = "375px")
```

<br>

### Sequential glimpse

```{r alluvial, echo=T, error=T, paged.print=TRUE, fig.height=9, error=T, dpi=500, fig.cap="Figure 2. Sankey Plot of Transitions by Treatment Setting"}
library(easyalluvial)
library(parcats)
p_alluvial<-
  d_match_surv_msprep[,c(1,3:6)] %>% 
    mutate_at(vars(starts_with("tipo_de_plan_res_")), funs(ifelse(is.na(.),2,.))) %>% 
    mutate_at(vars(starts_with("tipo_de_plan_res_")), funs(factor(.,labels=c("ambulatory","residential","censored"),levels=c(0,1,2)))) %>% #$fct_rev(
      alluvial_wide(
                   id = "id", 
                  bin=2,
                   bin_labels = c("ambulatory", "residential"),
                  order_levels= c("ambulatory", "residential","censored"),
                   fill_by = 'first_variable',
                    NA_label = "censored",
                   col_vector_flow=c("red","grey60"),#"#cF291D",
                    #palette_qualitative() %>% palette_filter(greys = F), #,#,"#ffe6d5","#bf6f6f","#eec1ad","#d29985","#cF291D","#b50717","#a43232","","gray",
                  col_vector_value=c("#bf6f6f","#eec1ad","#d29985") ,
                  auto_rotate_xlabs = T,
                  stratum_label_size = 3,
                   colorful_fill_variable_stratum = F)+
  theme_void()

p_alluvial
# parcats::parcats(p_alluvial, marginal_histograms = F, data=  d_match_surv_msprep[,c(1,3:6)] %>% 
#   mutate_at(vars(starts_with("tipo_de_plan_res_")), funs(ifelse(is.na(.),2,.))) %>% 
#   mutate_at(vars(starts_with("tipo_de_plan_res_")), funs(factor(.,labels=c("ambulatory","residential","censored"),levels=c(0,1,2)))), 
#                  labelfont = list(size = 12, color = "black"),
#                width = 840, height = 672)#, height=1600,width=1600) 672  480
```


<br>

```{r long_alluv, echo=T, error=T, paged.print=TRUE, fig.cap="Figure 3. Sankey Plot of Transitions by Treatment Setting", fig.width=12, fig.height=8, eval=T}

alluvial_long(data.frame(ms_d_match_surv %>% dplyr::mutate(tipo_de_plan_res=factor(tipo_de_plan_res, labels=c("ambulatory", "residential")))),key=from,id= id, 
              value= tipo_de_plan_res, 
              fill_by="first_variable",
              NA_label = "censored", 
              complete=F,
              bin=2, 
              stratum_label_size=2,
              stratum_width=1/4,
              bin_labels = c("ambulatory", "residential"),
              col_vector_flow=c("red","yellow"),
              col_vector_value=c("#bf6f6f","#eec1ad","gray60") )+
  theme_void()
```

```{r alluvial3, echo=T, error=T, paged.print=TRUE, fig.height=9, error=T, dpi=500, fig.cap="Figure 4. Sankey Plot of Transitions by Treatment Setting", eval=F}
library(ggrepel)
library(ggalluvial)

plot_flow_alluvial<-
ggplot(data.frame(ms_d_match_surv %>% dplyr::mutate(tipo_de_plan_res=factor(tipo_de_plan_res, labels=c("ambulatory", "residential"))) ), #requiere long %>% dplyr::filter(trans==1)
       aes(x = from, stratum = tipo_de_plan_res, alluvium = id,
            fill = tipo_de_plan_res)) +
  ggalluvial::geom_lode() + 
  geom_flow(curve_type = "cubic") +
  geom_stratum(alpha = 0) +
  theme_void()+
  scale_fill_manual(name="Treatment\nSetting", values=c('lightblue','gray70'))

set.seed(42)
plot_flow_alluvial2<-
  plot_flow_alluvial+
  geom_text_repel(stat = "flow",
            aes(label = scales::percent(after_stat(prop),accuracy = 1)),#hjust = (after_stat(flow) == "to"),
            size = 3,
            box.padding = unit(0.75, "lines"),
            show.legend=F,
            arrow = arrow(length = unit(0.005, "npc")))
plot_flow_alluvial2

ggsave(paste0(path,"/_mult_state_ags/Fig_plan_alt.jpg"), 
       plot_flow_alluvial2, width = 9, height = 11, dpi = 600, units= "in")

#C:\Users\CISS Fondecyt\Mi unidad\Alvacast\Matching\graphs
```

```{r alluvial32, echo=T, error=T, paged.print=TRUE}

tab_1st_tr<-
 d_match_surv_msprep[,c(1,3:6)] %>% 
    mutate_at(vars(starts_with("tipo_de_plan_res_")), funs(ifelse(is.na(.),2,.))) %>% 
    mutate_at(vars(starts_with("tipo_de_plan_res_")), funs(factor(.,labels=c("ambulatory","residential","censored"),levels=c(0,1,2)))) %>% 
    #dplyr::filter(tipo_de_plan_res_3!="censored") %>% 
    dplyr::count(tipo_de_plan_res_1,tipo_de_plan_res_2) %>% 
    dplyr::filter(case_when(.[[1]] =="censored" & .[[2]] =="censored" ~ n< 0, #When y == "", x > 3
                   T ~ n>0)) %>% 
    #dplyr::filter(.[1]!="censored" & .[2]!="censored") %>% 
    dplyr::group_by(.[1]) %>% 
    dplyr::mutate(prop=scales::percent(n/sum(n), accuracy=1)) %>% 
    dplyr::ungroup() %>% 
    dplyr::mutate(show=paste0(format(n, big.mark=","), " (",prop,")"))

tab_2nd_tr<-
 d_match_surv_msprep[,c(1,3:6)] %>% 
    mutate_at(vars(starts_with("tipo_de_plan_res_")), funs(ifelse(is.na(.),2,.))) %>% 
    mutate_at(vars(starts_with("tipo_de_plan_res_")), funs(factor(.,labels=c("ambulatory","residential","censored"),levels=c(0,1,2)))) %>% 
    #dplyr::filter(tipo_de_plan_res_3!="censored") %>% 
    dplyr::count(tipo_de_plan_res_2,tipo_de_plan_res_3) %>% 
    dplyr::filter(case_when(.[[1]] =="censored" & .[[2]] =="censored" ~ n< 0, #When y == "", x > 3
                   T ~ n>0)) %>% 
    dplyr::group_by(.[1]) %>% 
    dplyr::mutate(prop=scales::percent(n/sum(n), accuracy=1)) %>% 
    dplyr::ungroup() %>% 
    dplyr::mutate(show=paste0(format(n, big.mark=","), " (",prop,")")) 

tab_3rd_tr<-
  d_match_surv_msprep[,c(1,3:6)] %>% 
    mutate_at(vars(starts_with("tipo_de_plan_res_")), funs(ifelse(is.na(.),2,.))) %>% 
    mutate_at(vars(starts_with("tipo_de_plan_res_")), funs(factor(.,labels=c("ambulatory","residential","censored"),levels=c(0,1,2)))) %>% 
    dplyr::count(tipo_de_plan_res_3,tipo_de_plan_res_4) %>% 
    dplyr::filter(case_when(.[[1]] =="censored" & .[[2]] =="censored" ~ n< 0, #When y == "", x > 3
                   T ~ n>0)) %>% 
    #dplyr::filter(.[1]!="censored"&.[2]!="censored") %>% 
    dplyr::group_by(.[1]) %>% 
    dplyr::mutate(prop=scales::percent(n/sum(n), accuracy=1)) %>% 
    dplyr::ungroup()  %>% 
    dplyr::mutate(show=paste0(format(n, big.mark=","), " (",prop,")"))

combinacion_concatenacion_eventos<-
d_match_surv_msprep[,c(1,3:6)] %>% 
  tidyr::unite("4_ev", tipo_de_plan_res_1:tipo_de_plan_res_4, remove = FALSE) %>% 
  dplyr::group_by(`4_ev`) %>% 
  dplyr::summarise(n=n())


cat("Third row of the graphics")

comb_conc_ev2<-
combinacion_concatenacion_eventos %>% 
    tidyr::separate(`4_ev`,into=c("first","second","third", "fourth"), sep="_") %>% 
    tidyr::unite("2_ev", first:second, remove = FALSE) %>% 
    dplyr::group_by(`2_ev`) %>%
    dplyr::summarise(n=sum(n)) %>% 
    tidyr::separate(`2_ev`,into=c("first","second"), sep="_") %>% 
    dplyr::group_by(`first`) %>% 
    dplyr::mutate(perc=scales::percent(n/sum(n))) %>% 
    dplyr::ungroup() %>% 
    dplyr::filter(second!="NA")

cat("Fourth row of the graphics")

comb_conc_ev3<-
combinacion_concatenacion_eventos %>% 
    tidyr::separate(`4_ev`,into=c("first","second","third", "fourth"), sep="_") %>% 
    tidyr::unite("3_ev", first:third, remove = FALSE) %>% 
    dplyr::group_by(`3_ev`) %>%
    dplyr::summarise(n=sum(n)) %>% 
    tidyr::separate(`3_ev`,into=c("first","second","third"), sep="_") %>% 
    tidyr::unite("2_ev", first:second, remove = FALSE) %>%
    dplyr::group_by(`2_ev`) %>% 
    dplyr::mutate(perc=scales::percent(n/sum(n))) %>% 
    dplyr::ungroup() %>% 
    dplyr::filter(third!="NA")

cat("Last row of the graphics")

comb_conc_ev4<-
combinacion_concatenacion_eventos %>% 
    tidyr::separate(`4_ev`,into=c("first","second","third", "fourth"), sep="_") %>% 
    tidyr::unite("3_ev", first:third, remove = FALSE) %>% 
    dplyr::group_by(`3_ev`) %>% 
    dplyr::mutate(perc=scales::percent(n/sum(n))) %>% 
    dplyr::ungroup() %>% 
    dplyr::filter(fourth!="NA")



cbind.fill <- function(...) {
    transpoted <- lapply(list(...),t)
    transpoted_dataframe <- lapply(transpoted, as.data.table, keep.rownames=T)
    return (data.frame(t(plyr::rbind.fill(transpoted_dataframe))))                                               
} 

options(knitr.kable.NA = '')
cbind.fill(comb_conc_ev2,comb_conc_ev3,comb_conc_ev4) %>% 
  slice(-1) %>% 
  #dplyr::select(-1) %>% 
      knitr::kable(.,format = "html", format.args = list(decimal.mark = ".", big.mark = ","),
       caption = paste0("Table. Setting of readmissions and percentages by the previous one"),
       col.names = c("First\nevent","Second\nevent", "n", "%", "Concatenated\nevents", "First\nevent", "Second\nevent", "Third\nevent", "n", "%", "Concatenated\nevents","First\nevent", "Second\nevent","Third\nevent", "Fourth\nevent","n","%"),
               align =c('l',rep('c', 101)), escape=T) %>%
  kableExtra::kable_classic(bootstrap_options = c("striped", "hover"),font_size = 12) %>%
  kableExtra::add_header_above(c("Second"=5, "Third"=6, "Fouth"=7)) %>% 
  kableExtra::add_footnote("Note. 0/1 denotes Ambulatory and Residential Treatment, respectively; % denotes the percentage of the previous event", notation="none") %>% 
  kableExtra::scroll_box(width = "100%", height = "375px")
```
 
```{r alluvial322, echo=T, error=T, paged.print=TRUE}
combinacion_concatenacion_eventos2<-
d_match_surv_msprep[,c(1,3,19:21)] %>% 
  tidyr::unite("4_ev", tipo_de_plan_res_1:TD_3, remove = FALSE) %>% 
  dplyr::group_by(`4_ev`) %>% 
  dplyr::summarise(n=n())

cat("Third row of the graphics")

comb2_conc_ev2<-
combinacion_concatenacion_eventos2 %>% 
    tidyr::separate(`4_ev`,into=c("first","second","third", "fourth"), sep="_") %>% 
    tidyr::unite("2_ev", first:second, remove = FALSE) %>% 
    dplyr::group_by(`2_ev`) %>%
    dplyr::summarise(n=sum(n)) %>% 
    tidyr::separate(`2_ev`,into=c("first","second"), sep="_") %>% 
    dplyr::group_by(`first`) %>% 
    dplyr::mutate(perc=scales::percent(n/sum(n))) %>% 
    dplyr::ungroup() %>% 
    dplyr::filter(second!="NA")

cat("Fourth row of the graphics")

comb2_conc_ev3<-
combinacion_concatenacion_eventos2 %>% 
    tidyr::separate(`4_ev`,into=c("first","second","third", "fourth"), sep="_") %>% 
    tidyr::unite("3_ev", first:third, remove = FALSE) %>% 
    dplyr::group_by(`3_ev`) %>%
    dplyr::summarise(n=sum(n)) %>% 
    tidyr::separate(`3_ev`,into=c("first","second","third"), sep="_") %>% 
    tidyr::unite("2_ev", first:second, remove = FALSE) %>%
    #dplyr::group_by(`2_ev`) %>% 
    dplyr::group_by(first) %>% 
    dplyr::mutate(perc=scales::percent(n/sum(n))) %>% 
    dplyr::ungroup() %>% 
    dplyr::filter(third!="NA")

cat("Last row of the graphics")

comb2_conc_ev4<-
combinacion_concatenacion_eventos2 %>% 
    tidyr::separate(`4_ev`,into=c("first","second","third", "fourth"), sep="_") %>% 
    tidyr::unite("3_ev", first:third, remove = FALSE) %>% 
    dplyr::group_by(first) %>% 
    dplyr::mutate(perc=scales::percent(n/sum(n))) %>% 
    dplyr::ungroup() %>% 
    dplyr::filter(fourth!="NA")


options(knitr.kable.NA = '')
cbind.fill(comb2_conc_ev2,comb2_conc_ev3,comb2_conc_ev4) %>% 
  slice(-1) %>% 
  #dplyr::select(-1) %>% 
      knitr::kable(.,format = "html", format.args = list(decimal.mark = ".", big.mark = ","),
       caption = paste0("Table. Treatment completion status counts and percentages by the previous one"),
       col.names = c("Base Tr.\nSetting","Second\nevent", "n", "%", "Concatenated\nevents", "Base Tr.\nSetting", "Second\nevent", "Third\nevent", "n", "%", "Concatenated\nevents","Base Tr.\nSetting", "Second\nevent","Third\nevent", "Fourth\nevent","n","%"),
               align =c('l',rep('c', 101)), escape=T) %>%
  kableExtra::kable_classic(bootstrap_options = c("striped", "hover"),font_size = 12) %>%
  kableExtra::add_header_above(c("Second (First tr. completion status)"=5, "Third (2nd tr. completion status)"=6, "Fouth (3rd tr. completion status)"=7)) %>% 
  kableExtra::add_footnote("Note. 0/1 denotes Not-completion and Treatment Completion, respectively; % denotes the percentage of the total", notation="none") %>% 
  kableExtra::scroll_box(width = "100%", height = "375px")
``` 
 
 
```{r alluvial4, echo=T, error=T, paged.print=TRUE, error=T, fig.cap="Figure 5. Tree diagram of counts and total proportions of Type of Plan from the first to the fourth treatment"}
library(data.tree)

#scales::percent(358/2078,accuracy = 1)ä
 traveller <- Node$new("Admission")
route1 <- traveller$AddChild("1st  tr., Residential: 11,456 (50%)")
route10 <-route1$AddChild("2nd  tr., Ambulatory: 2,078 (18%)")
route100<-route10$AddChild("3rd  tr., Ambulatory: 358 (17%)")
route100$AddChild("4th  tr., Ambulatory: 73 (20%)")
route100$AddChild("4th  tr., Residential: 26 (7%)")
route101<-route10$AddChild("3rd  tr., Residential: 218 (11%)")
route101$AddChild("4th  tr., Ambulatory: 42 (19%)")
route101$AddChild("4th  tr., Residential: 37 (17%)")
route11 <-route1$AddChild("2nd  tr., Residential: 1,717 (15%)")
route110<-route11$AddChild("3rd  tr., Ambulatory: 312 (18%)")
route110$AddChild("4th  tr., Ambulatory: 51 (16%)")
route110$AddChild("4th  tr., Residential: 41 (13%)")
route111<-route11$AddChild("3rd  tr., Residential: 337 (20%)")
route111$AddChild("4th  tr., Ambulatory: 51 (15%)")
route111$AddChild("4th  tr., Residential: 80 (24%)")

route0 <- traveller$AddChild("1st  tr., Ambulatory: 11,456 (50%)")
route00 <- route0$AddChild("2nd  tr., Ambulatory: 1,858 (16%)")
route000<-route00$AddChild("3rd  tr., Ambulatory: 381 (21%)")
route000$AddChild("4th  tr., Ambulatory: 75 (20%)")
route000$AddChild("4th  tr., Residential: 25 (7%)")

route001<-route00$AddChild("3rd  tr., Residential: 125 (7%)")
route001$AddChild("4th  tr., Ambulatory: 32 (26%)")
route001$AddChild("4th  tr., Residential: 14 (11%)")

route01 <- route0$AddChild("2nd  tr., Residential: 745 (7%)")
route010<-route01$AddChild("3rd  tr., Ambulatory: 158 (21%)")
route010$AddChild("4th  tr., Ambulatory: 29 (18%)")
route010$AddChild("4th  tr., Residential: 15 (10%)")

route011<-route01$AddChild("3rd  tr., Residential: 123 (17%)")
route011$AddChild("4th  tr., Ambulatory: 28 (23%)")
route011$AddChild("4th  tr., Residential: 27 (22%)")

SetGraphStyle(traveller, rankdir = "LR")
plot(traveller)

library(rsvg)
library(DiagrammeRsvg)
plot(traveller) %>%
    export_svg %>% charToRaw %>% rsvg_pdf(paste0(path,"/_mult_state_ags/_flowchart_transition.pdf"))
plot(traveller) %>%
    export_svg %>% charToRaw %>% rsvg_png(paste0(path,"/_mult_state_ags/_flowchart_transition.png"))
#library(htmltools); html_print(HTML(gr_selected %>% export_svg))

#DiagrammeR::export_graph(gr_selected, height= 10, width=8)
```

<br>

# Sensitivity


```{r evalue, warning=FALSE, message=F, cache=T, paged.print=TRUE, eval=T, error=T}
evalue_or<-
    EValue::evalues.RR(dplyr::rename(data.table::data.table(exp(coefBase(timecox_pwp_const2_opc1, digits=8)), keep.rownames = T), "Variables"="rn")[1,2], 
                   dplyr::rename(data.table::data.table(exp(coefBase(timecox_pwp_const2_opc1, digits=8)), keep.rownames = T), "Variables"="rn")[1,7], 
                   dplyr::rename(data.table::data.table(exp(coefBase(timecox_pwp_const2_opc1, digits=8)), keep.rownames = T), "Variables"="rn")[1,8], rare=F)
evalue_or

```

We estimated the sensibility of the associations found assuming different values of the sensitivity parameter ($\Gamma$).  

<br>

```{r  eval2, warning=FALSE, fig.align = "center", message=F, fig.height=7, cache=T, fig.cap="Figure 6. Sensibility Parameters", eval= T, dpi=320}

xmax = 10
RR = unlist(evalue_or[1,1])

  x = seq( 0, xmax, 0.01 )
  
  # MM: reverse RR if it's preventive
  if ( RR < 1 ) RR = 1/RR
  
  plot( x, x, lty = 2, col = "white", type = "l", xaxs = "i", yaxs = "i", xaxt="n", yaxt = "n",
        xlab = bquote(.("Association of the Exposure and Confounder ") ~  RR[EU]), 
        ylab = bquote(.("Association of the Confounder and Outcome  ") ~ RR[UD]),
        xlim = c( 0,xmax ),
        main = "" )
  
  x = seq(RR, xmax, 0.01 )
  
  y    = RR*( RR-1 )/( x-RR )+RR
  
  lines( x, y, type = "l" )
  
  
  high = RR + sqrt( RR*( RR-1 ) )
  
  
  points( high, high, pch = 19 )
  
  label5 = seq( 5, 40, by = 5 )
  axis( 1, label5, label5, cex.axis = 1 )
  axis( 2, label5, label5, cex.axis = 1 )
  
  g = round( RR + sqrt( RR * ( RR - 1 ) ), 2 )
  label = paste( "( ", g, ", ", g, " )", sep="" )
  
  text( high + 3, high + 1, label )
  
  legend( "bottomleft", expression(
    RR[EU]*RR[UD]/( RR[EU]+RR[UD]-1 )==RR
  ), 
  lty = 1:2,
  bty = "n" )

```

<br>

With an risk ratio of `r as.numeric(round(dplyr::rename(data.table::data.table(exp(coefBase(timecox_pwp_const2_opc1, digits=8)), keep.rownames = T), "Variables"="rn")[1,2],2))`, an unmeasured confounder that was associated with both the outcome and the exposure by a RR of `r round(evalue_or[,2]$"E-values",2)`-fold each, above and beyond the measured confounders, could explain away the estimate, but weaker confounding could not.

<br>

# Session Info

```{r session_info, echo=T, error=T, paged.print=TRUE}
Sys.getenv("R_LIBS_USER")

if (grepl("CISS Fondecyt",rstudioapi::getSourceEditorContext()$path)==T){
    save.image("C:/Users/CISS Fondecyt/Mi unidad/Alvacast/SISTRAT 2019 (github)/mult_state_5_apr22.RData")
  } else if (grepl("andre",rstudioapi::getSourceEditorContext()$path)==T){
    save.image("C:/Users/andre/Desktop/SUD_CL/mult_state_5_apr22.RData")
  } else if (grepl("E:",rstudioapi::getSourceEditorContext()$path)==T){
    save.image("E:/Mi unidad/Alvacast/SISTRAT 2019 (github)/mult_state_5_apr22.RData")
  } else if (grepl("G:",rstudioapi::getSourceEditorContext()$path)==T){
    save.image("G:/Mi unidad/Alvacast/SISTRAT 2019 (github)/mult_state_5_apr22.RData")
  } else {
    save.image("~/mult_state_5_apr22.RData")
    path.expand("~/mult_state_5_apr22.RData")
  }

sessionInfo()
sesion_info <- devtools::session_info()
dplyr::select(
  tibble::as_tibble(sesion_info$packages),
  c(package, loadedversion, source)
) %>% 
  DT::datatable(filter = 'top', colnames = c('Row number' =1,'Variable' = 2, 'Percentage'= 3),
              caption = htmltools::tags$caption(
        style = 'caption-side: top; text-align: left;',
        '', htmltools::em('Packages')),
      options=list(
initComplete = htmlwidgets::JS(
      "function(settings, json) {",
      "$(this.api().tables().body()).css({'font-size': '80%'});",
      "}")))
```
