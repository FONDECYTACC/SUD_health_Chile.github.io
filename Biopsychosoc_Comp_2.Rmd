---
title: "Biopsychosocial Compromise"
author: "ags"
date: "01-01-2021"
output:
  html_document:
    code_folding: hide  
    toc: true # table of content true
    toc_depth: 4  # upto three depths of headings (specified by #, ## and ###)
    toc_float: true
bibliography: references2.bib
nocite: '@*'
csl: sage-vancouver.csl
---
<style type="text/css">
.tablelines table, .tablelines td, .tablelines th {
        border: 1px solid black;
        }
.centrado {
    text-align: center;
}
.table.center {
    margin-left:auto; 
    margin-right:auto;
  }
.table_wrapper{
    display: block;
    overflow-x: auto;
    white-space: nowrap;
}
code.r{
  font-size: 8px;
}
body{ /* Normal  */
      text-align: justify;
  }
.superbigimage{
    overflow-y:scroll;
    white-space: nowrap;
}
.superbigimage img{
    overflow-y: scroll;
    overflow-x: hidden;
}
</style>

<style>
div.blue { background-color:#e6f0ff; border-radius: 5px; padding: 20px; text-align: justify;}
</style>

```{r setup0, include = FALSE, cache=T}
#Libraries used in the routine. Dont change the order
rm(list=ls());gc()
load("G:/Mi unidad/Alvacast/SISTRAT 2019 (github)/9.RData")
```

```{r setup, include = FALSE, cache=T}
#setwd("H:/")
#rm(list=c("")
unlink('G:/Mi unidad/Alvacast/SISTRAT 2019 (github)/SUD_CL/Biopsychosoc_Comp_2_cache', recursive = TRUE)
local({r <- getOption("repos")
       r["CRAN"] <- "http://cran.r-project.org" 
       options(repos=r)
})
copiar_nombres <- function(x,row.names=FALSE,col.names=TRUE,dec=",",...) {
  if(class(ungroup(x))[1]=="tbl_df"){
        if(options()$OutDec=="."){
            options(OutDec = dec)
            write.table(format(data.frame(x)),"clipboard",sep="\t",row.names=FALSE,col.names=col.names,...)
            options(OutDec = ".")
          return(x)
        } else {
            options(OutDec = ",")
            write.table(format(data.frame(x)),"clipboard",sep="\t",row.names=FALSE,col.names=col.names,...)
            options(OutDec = ",")
          return(x)    
        }
  } else {
        if(options()$OutDec=="."){
            options(OutDec = dec)
            write.table(format(x),"clipboard",sep="\t",row.names=FALSE,col.names=col.names,...)
            options(OutDec = ".")
          return(x)
        } else {
            options(OutDec = ",")
            write.table(format(x),"clipboard",sep="\t",row.names=FALSE,col.names=col.names,...)
            options(OutDec = ",")
          return(x)       
  }
 }
}  
#packageVersion("codebook")
#https://github.com/RevolutionAnalytics/checkpoint
#if(!require(checkpoint)){install.packages("checkpoint")}
#if(!require(here)){install.packages("here")}
#checkpoint::checkpoint("2020-02-19",project=here::here(),checkpointLocation=paste0(here::here(),"/dedup"), use.lock=F, use.knitr=T, auto.install.knitr = T,scan.rnw.with.knitr=T, forceInstall=T,scanForPackages = TRUE)
#checkpointArchives(tempdir(), full.names = TRUE)

#if(!require(tidyr)){install.packages("tidyr")}
#if(!require(DataExplorer)){install.packages("DataExplorer")}
#if(!require(stringi)){install.packages("stringi")}
#if(!require(stringr)){install.packages("stringr")}
#if(!require(ggplot2)){install.packages("ggplot2")}
#if(!require(Hmisc)){install.packages("Hmisc")}
#if(!require(kableExtra)){install.packages("kableExtra")}
#if(!require(plotly)){install.packages("plotly")}
#if(!require(rbokeh)){install.packages("rbokeh")}
#if(!require(altair)){install.packages("altair")}
#if(!require(zoo)){install.packages("zoo")}
#if(!require(codebook)){install.packages("codebook")}
#if(!require(broom)){install.packages("broom")}
#if(!require(sqldf)){install.packages("sqldf")} 
#if(!require(devtools)){install.packages("devtools")}
#if(!require(Statamarkdown)){install_github("hemken/Statamarkdown")}
#if(!require(data.table)){install.packages("data.table")}
#if(!require(dplyr)){install.packages("dplyr")}

#if(!require(boot)){install.packages("boot")}
#if(!require(plyr)){install.packages("plyr")}
#if(!require(matrixStats)){install.packages("matrixStats")}
#if(!require(radiant)){install.packages("radiant", repos = "https://radiant-rstats.github.io/minicran/")}

try(library(boot))
library(matrixStats)
library(knitr)
library(tidyr)
library(stringi)
library(stringr)
library(ggplot2)
library(Hmisc)
library(kableExtra)
library(plotly)
library(janitor)
library(rbokeh)
library(altair)
library(zoo)
library(broom)
library(sqldf)
library(devtools)
library(Statamarkdown)
library(codebook)
library(data.table)
library(dplyr)
library(panelr)
library(RColorBrewer)
library(choroplethr)
library(choroplethrMaps)
library(choroplethrAdmin1)
library(lsmeans)
library(finalfit)
suppressPackageStartupMessages(library(ggiraph))
library(psych)
library(dplyr)
library(parallel)
library(ggcorrplot)
library(citr)
library(MVN)
library(compareGroups)
library(vegan)
library(pscl)
library(blorr)

#if(!require(radiant.update)){install.packages("radiant.update", repos = "https://radiant-rstats.github.io/minicran/")}
#install.packages( repos = "https://radiant-rstats.github.io/minicran/")
#install.packages("radiant.update", repos = "https://radiant-rstats.github.io/minicran/")
#tryCatch(source("https://raw.githubusercontent.com/radiant-rstats/minicran/gh-pages/update.R"), error = function(e) print("updated package, radiant"))

mycor.ci <- function (x, keys = NULL, n.iter = 100, p = 0.05, overlap = FALSE, 
    poly = FALSE, method = "pearson", plot = TRUE, minlength = 5, 
    cvars=NULL, pvars=NULL, dvars=NULL, ...) {
    cl <- match.call()
    n.obs <- dim(x)[1]
    if (is.null(keys) && overlap) 
        overlap <- FALSE
    if (poly) {
        ncat <- 8
        nvar <- dim(x)[2]
        tx <- table(as.matrix(x))
        if (dim(tx)[1] == 2) {
            tet <- tetrachoric(x)
            typ = "tet"
        }
        else {
            tab <- apply(x, 2, function(x) table(x))
            if (is.list(tab)) {
                len <- lapply(tab, function(x) length(x))
            }
            else {
                len <- dim(tab)[1]
            }
            if (is.null(dvars)) dvars <- subset(1:nvar, len == 2)
            if (is.null(pvars)) pvars <- subset(1:nvar, ((len > 2) & (len <= ncat)))
            if (is.null(cvars)) cvars <- subset(1:nvar, (len > ncat))
            if (length(pvars) == ncol(x)) {
                tet <- polychoric(x)
                typ = "poly"
            }
            else {
                plot(pvars)
                tet <- mixedCor(data=x, c=cvars, d=dvars, method="pearson")
                typ = "mixed"
            }
        }
        Rho <- tet$rho

    }
    else {
        Rho <- cor(x, use = "pairwise", method = method)
    }
    if (!is.null(keys)) {
        bad <- FALSE
        if (any(is.na(Rho))) {
            warning(sum(is.na(Rho)), " of the item correlations are NA and thus finding scales that include those items will not work.\n We will try to do it for those  scales which do not include those items.\n         \n Proceed with caution. ")
            bad <- TRUE
            rho <- apply(keys, 2, function(x) colMeans(apply(keys, 
                2, function(x) colMeans(Rho * x, na.rm = TRUE)) * 
                x, na.rm = TRUE))
        }
        else {
            rho <- t(keys) %*% Rho %*% keys
        }
    }
    else {
        rho <- Rho
    }
    if (overlap) {
        key.var <- diag(t(keys) %*% keys)
        var <- diag(rho)
        n.keys <- ncol(keys)
        key.av.r <- (var - key.var)/(key.var * (key.var - 1))
        item.cov <- t(keys) %*% Rho
        raw.cov <- item.cov %*% keys
        adj.cov <- raw.cov
        for (i in 1:(n.keys)) {
            for (j in 1:i) {
                adj.cov[i, j] <- adj.cov[j, i] <- raw.cov[i, 
                  j] - sum(keys[, i] * keys[, j]) + sum(keys[, 
                  i] * keys[, j] * sqrt(key.av.r[i] * key.av.r[j]))
            }
        }
        diag(adj.cov) <- diag(raw.cov)
        rho <- cov2cor(adj.cov)
    }
    rho <- cov2cor(rho)
    nvar <- dim(rho)[2]
    if (n.iter > 1) {
        replicates <- list()
        rep.rots <- list()
        replicates <- parallel::mclapply(1:n.iter, function(XX) {
            xs <- x[sample(n.obs, n.obs, replace = TRUE), ]
            {
                if (poly) {
                  if (typ != "tet") {
                    capture.output(tets <- mixedCor(data=xs, c=cvars, d=dvars, method="pearson"))
                  }
                  else {
                    tets <- tetrachoric(xs)
                  }
                  R <- tets$rho
                }
                else {
                  R <- cor(xs, use = "pairwise", method = method)
                }
                if (!is.null(keys)) {
                  if (bad) {
                    covariances <- apply(keys, 2, function(x) colMeans(apply(keys, 
                      2, function(x) colMeans(R * x, na.rm = TRUE)) * 
                      x, na.rm = TRUE))
                  }
                  else {
                    covariances <- t(keys) %*% R %*% keys
                  }
                  r <- cov2cor(covariances)
                }
                else {
                  r <- R
                }
                if (overlap) {
                  var <- diag(covariances)
                  item.cov <- t(keys) %*% R
                  raw.cov <- item.cov %*% keys
                  adj.cov <- raw.cov
                  key.av.r <- (var - key.var)/(key.var * (key.var - 
                    1))
                  for (i in 1:(n.keys)) {
                    for (j in 1:i) {
                      adj.cov[i, j] <- adj.cov[j, i] <- raw.cov[i, 
                        j] - sum(keys[, i] * keys[, j]) + sum(keys[, 
                        i] * keys[, j] * sqrt(key.av.r[i] * key.av.r[j]))
                    }
                  }
                  diag(adj.cov) <- diag(raw.cov)
                  r <- cov2cor(adj.cov)
                }
                rep.rots <- r[lower.tri(r)]
            }
        })
    }
    replicates <- matrix(unlist(replicates), ncol = nvar * (nvar - 
        1)/2, byrow = TRUE)
    z.rot <- fisherz(replicates)
    means.rot <- colMeans(z.rot, na.rm = TRUE)
    sds.rot <- apply(z.rot, 2, sd, na.rm = TRUE)
    sds.rot <- fisherz2r(sds.rot)
    ci.rot.lower <- means.rot + qnorm(p/2) * sds.rot
    ci.rot.upper <- means.rot + qnorm(1 - p/2) * sds.rot
    means.rot <- fisherz2r(means.rot)
    ci.rot.lower <- fisherz2r(ci.rot.lower)
    ci.rot.upper <- fisherz2r(ci.rot.upper)
    low.e <- apply(replicates, 2, quantile, p/2, na.rm = TRUE)
    up.e <- apply(replicates, 2, quantile, 1 - p/2, na.rm = TRUE)
    tci <- abs(means.rot)/sds.rot
    ptci <- pnorm(tci)
    ci.rot <- data.frame(lower = ci.rot.lower, low.e = low.e, 
        upper = ci.rot.upper, up.e = up.e, p = 2 * (1 - ptci))
    cnR <- abbreviate(colnames(rho), minlength = minlength)
    k <- 1
    for (i in 1:(nvar - 1)) {
        for (j in (i + 1):nvar) {
            rownames(ci.rot)[k] <- paste(cnR[i], cnR[j], sep = "-")
            k <- k + 1
        }
    }
    results <- list(rho = rho, means = means.rot, sds = sds.rot, 
        tci = tci, ptci = ptci, ci = ci.rot, Call = cl, replicates = replicates)
    if (plot) {
        cor.plot(rho, numbers = TRUE, cuts = c(0.001, 0.01, 0.05), 
            pval = 2 * (1 - ptci), ...)
    }
    class(results) <- c("psych", "cor.ci")
    return(results)
}

#
#https://crsh.github.io/papaja_man/writing.html
#fsdfs
#[-@smith04].
#@smith04 [p. 33] says blah.
#Blah blah [@smith04; @doe99].
#Blah blah [see @doe99, pp. 33-35; also @smith04, ch. 1].
#[@key-1; @key-2; @key-3]
#[@james_1890; @bem_2011]
```

<!--- 
Valores Posibles:
1. Leve
2. Moderado
3. Severo
Se refiere a una apreciación de la magnitud de los efectos o consecuencias negativas del consumo de sustancias en las distintas áreas de la vida de las personas que consumen sustancias, y de su entorno.

FUENTES: 
- TOP SENDA: http://sistemas.senda.gob.cl/sistema-monitoreo/biblioteca/files/Documentos/ESTRATEGIAS%20NORMAS%20ORIENTACIONES/1%20Orientaciones%20y%20Normas/Nacional/Senda/TOP%20-%20Manual%20para%20el%20Entrevistador.pdf
- Development of TOP (UK) https://sci-hub.tw/10.1111/j.1360-0443.2008.02284.x
- 
1 Substance use: days used alcohol, illicit opiates, crack
cocaine, cocaine powder, amphetamines, cannabis,
one other substance; days injecting; prevalence of
needle/syringe sharing.
2 Health: subjective rating of physical and psychological
health status.
 Crime: days committed shop theft and drug selling;
prevalence of vehicle, property and fraud and assault/
violent crime.
4 Social functioning: rating of quality of life; days paid
work and attendance for education/training; period
prevalence of acute housing problems and risk of
eviction.
#[see @doe99, pp. 33-35; also @smith04, ch. 1].
#Smith says blah [-@smith04].
--->

# Dataset Match

We used the Treatment Outcomes Profile to join users of the C1 (n= `r nrow(CONS_C1_df_dup_JUL_2020) %>% formatC(, format="f", big.mark=",", digits=0)`; users=`r CONS_C1_df_dup_JUL_2020 %>% group_by(hash_key) %>% summarise(n=n()) %>% nrow() %>% formatC(, format="f", big.mark=",", digits=0)`) that were evaluated with the Treatment Outcome Profile (TOP) in the same date of Admission to entries in C1 datasets.

<br>

```{r tab1_pers_info_edad_ini_cons,eval=T, echo=T, paged.print=TRUE}
###casos duplicados en fecha de aplicación
#1     1 97779
#2     2  2483
#3     3   149
#4     4    21
#5     5     3
#no hay casos que tengan más de una fecha de admisión Y UNA BD MÁS RECIENTE
#CONS_TOP_df_dup_ENE_2020_prev9%>% dplyr::mutate(concat=paste0(hash_key,"_",as.character(fech_ap_top)))%>% group_by(concat) %>% dplyr::mutate(n_hash_fech_ap=n(),n_dis_ano=n_distinct(ano_bd))%>% dplyr::filter(n_hash_fech_ap>1,n_dis_ano>1)

invisible(
CONS_TOP_df_dup_ENE_2020_prev9%>% dplyr::mutate(concat=paste0(hash_key,"_",as.character(fech_ap_top)))%>% group_by(concat) %>% dplyr::mutate(n_hash_fech_ap=n(),n_dis_ano=n_distinct(ano_bd))%>% dplyr::filter(n_hash_fech_ap>1,n_dis_ano>1)
)

CONS_TOP_df_dup_ENE_2020_prev9_match<-
CONS_TOP_df_dup_ENE_2020_prev9%>% dplyr::mutate(concat=paste0(hash_key,"_",as.character(fech_ap_top)))%>% group_by(concat) %>% dplyr::mutate(n_hash_fech_ap=n(),n_dis_ano=n_distinct(ano_bd))%>% dplyr::filter(n_hash_fech_ap==1)%>%
  dplyr::select(hash_key,concat,total_oh,dosis_oh,total_thc,dosis_thc,total_pbc,dosis_pbc,total_coc,dosis_coc,total_bzd,dosis_bzd,total_otra,dosis_otra,hurto,robo,venta_drogas,rina,total_vif,otro,total_transgresion,salud_psicologica,total_trabajo,total_educacion,salud_fisica,lugar_vivir,vivienda,calidad_vida,etapa_del_tratamiento)

CONS_C1_df_dup_JUL_2020_match_top<-
  CONS_C1_df_dup_JUL_2020%>%
  dplyr::mutate(concat=paste0(hash_key,"_",as.character(fech_ing)))%>%
  dplyr::left_join(CONS_TOP_df_dup_ENE_2020_prev9_match,by="concat", suffix=c("","_TOP"))%>%
  dplyr::filter(!is.na(compromiso_biopsicosocial), etapa_del_tratamiento=="Inicio Tratamiento")%>%
  dplyr::select(-hash_key_TOP)%>%
  dplyr::filter_at(vars(total_oh,dosis_oh,total_thc,dosis_thc,total_pbc,dosis_pbc,total_coc,dosis_coc,total_bzd,dosis_bzd,total_otra,dosis_otra,hurto,robo,venta_drogas,rina,total_vif,otro,total_transgresion,salud_psicologica,total_trabajo,total_educacion,salud_fisica,lugar_vivir,vivienda,calidad_vida,etapa_del_tratamiento), all_vars(!is.na(.)))

    users_top_only_one_app_match<-CONS_TOP_df_dup_ENE_2020_prev9%>% dplyr::mutate(concat=paste0(hash_key,"_",as.character(fech_ap_top)))%>% group_by(concat) %>% dplyr::mutate(n_hash_fech_ap=n(),n_dis_ano=n_distinct(ano_bd))%>% dplyr::filter(n_hash_fech_ap==1)%>% dplyr::ungroup()%>% dplyr::distinct(hash_key)%>% nrow()

#c("total_oh","dosis_oh","total_thc","dosis_thc","total_pbc","dosis_pbc","total_coc","dosis_coc","total_bzd","dosis_bzd","total_otra","dosis_otra","hurto","robo","venta_drogas","rina","total_vif","otro","total_transgresion","salud_psicologica","total_trabajo","total_educacion","salud_fisica","lugar_vivir","vivienda","calidad_vida")

# etapa_del_tratamiento      n      percent valid_percent
#                Egreso      4 3.470114e-05  0.0005719188
#    Inicio Tratamiento   6948 6.027587e-02  0.9934229339
#  Seguimiento 12 meses      0 0.000000e+00  0.0000000000
#  Seguimiento 15 meses      0 0.000000e+00  0.0000000000
#   Seguimiento 3 meses     34 2.949597e-04  0.0048613097
#   Seguimiento 6 meses      8 6.940227e-05  0.0011438376
#   Seguimiento 9 meses      0 0.000000e+00  0.0000000000
#                  <NA> 108276 9.393251e-01            NA
```

<br>

Of the total entries in TOP dataset (n= `r nrow(CONS_C1_df_dup_JUL_2020) %>% formatC(, format="f", big.mark=",", digits=0)`), we did not considered entries in TOP dataset had more than one application in the same date. We selected `r nrow(CONS_C1_df_dup_JUL_2020_match_top) %>% formatC(, format="f", big.mark=",", digits=0)` cases that had no differences between the date of application and the date of admission to treatment. Additionally, these applications must had been administered at admission (excluding the 0,6% of applications that were administered at other stage of treatment). Finally, we discarded cases with null values in the variables of interest (see Figure 1). 

<br>

# Explore variables

We defined one outcome variable to indicate early drop-out (`abandono_temp`) that should vary depending on biopsychosocial compromise. We also collapsed variables related to transgression to norms (`transg_norm`) into a continuous variable, by counting actions committed in the last 4 weeks. Additionally, we added the variable `salud_mean` to get the mean of the scores in physical health, quality of life and psychological health. To capture the substance use behaviors, we defined the average pattern of drug use in alcohol, marijuana, cocaine paste base, cocaine sedatives and tranquilizers, and other substances, in terms of scores of quantity in the last four weeks (`total_mean`). Equally, we defined a score of the average dose of the mean reported by users on each substance. At last, we created the mean of scores of days of attendance to jobs or educational institutions in the last four weeks (`trabajo_edu_mean`). In case of `total_vif_z`, their distributions were very skewed, due to the fact that `r as.character(janitor::tabyl(CONS_C1_df_dup_JUL_2020_match_top$total_vif)%>% adorn_pct_formatting()%>% select(percent)%>% slice(1))` had no scores, this is why we decided to recode it into absence of domestic violence (`vif`).

<br>

Values of doses over 50 were discarded and declared missing, due to the great amount of outliers.

<br>

Furthermore, we were interested in co-occurrent physical and psychiatric conditions among substance users. Consequently, we generated a variable called  `dg_cie_10`, composed of users that at least had been diagnosed with a psychiatric condition or professionals had been studying a possible diagnosis. Also, we included `dg_trs_fisico`, which categorizes users without a diagnosed physical condition, and those that had one in study or had been diagnosed with a physical condition. Additionally, we generated the variable `dg_cons_dep` to identify drug dependence from hazardous consumption.

<br>

To capture profiles of consumption, we generated the following variables: `oh` identifies cases that used alcohol at least one day in the last four weeks. This same criteria was applied to marijuana (`thc`), cocaine paste base (`pbc`), cocaine (`coc`), benzodiazepines (`bzd`), and other drugs (`otra`). Users that reported at least two substances according to the aforementioned rule were categorized as polydrug users (`polycons`). 

<br>

Lastly, the mean of the scores in many variables were dichotomized between users that had less than the 50% of users, compared to people that showed more scores than the 50% of the population. These were defined as Higher Frequency of Days using substances in the last four weeks (`mayor_total`), Higher Average Reported Daily Dose of Substances (`mayor_dosis`), Lower Health-Related Self-Reports (`menor_salud`), and Lower Days of Attendance to Work and Educational Centers in the last four weeks (`menor_trabajo_edu`). In a similar manner, `transg_norm_bin` identify users that reported at least one behavior that transgress the norm. 

<br>

**We discarded cases with no information in TOPs components, Biopsychosocial compromise, Cause of discharge, and Motive of admission**. 

<br>

```{r tab1, echo=FALSE}
scale2 <- function(x, na.rm = FALSE) (x - mean(x, na.rm = na.rm)) / sd(x, na.rm)

vars_to_check <- c("hurto", "robo",  "venta_drogas", "rina",  "otro", "lugar_vivir", "vivienda", "salud_fisica", "calidad_vida", "salud_psicologica", "dosis_oh", "dosis_thc", "dosis_pbc", "dosis_coc", "dosis_bzd", "dosis_otra", "total_oh", "total_thc", "total_pbc", "total_coc", "total_bzd", "total_otra", "compromiso_biopsicosocial","motivodeegreso_mod_imp", "origen_ingreso_mod")

#Selección de variables.
#table(CONS_C1_df_dup_JUL_2020_match_top_sel$total_transgresion)
CONS_C1_df_dup_JUL_2020_match_top_sel_prev<-
CONS_C1_df_dup_JUL_2020_match_top%>%
      filter(across(one_of(vars_to_check),
                ~ !is.na(.x)))%>%
  dplyr::select(compromiso_biopsicosocial,total_oh, dosis_oh, total_thc, dosis_thc, total_pbc, dosis_pbc, total_coc, dosis_coc, total_bzd, dosis_bzd, total_otra, dosis_otra, total_vif, total_transgresion, salud_psicologica, total_trabajo, total_educacion, salud_fisica, calidad_vida,  hurto, robo,  venta_drogas, rina,  otro, lugar_vivir, vivienda,origen_ingreso_mod,motivodeegreso_mod_imp,hash_key,dg_trs_cons_sus_or,diagnostico_trs_fisico,otros_probl_at_sm_or,sus_principal_mod,otras_sus1_mod,otras_sus2_mod,otras_sus3_mod,dg_trs_psiq_cie_10_or,x2_dg_trs_psiq_cie_10_or,x3_dg_trs_psiq_cie_10_or,x4_dg_trs_psiq_cie_10_or,x5_dg_trs_psiq_cie_10_or,cie_10,cnt_mod_cie_10_or,row)%>%
   #dplyr::mutate(compromiso_biopsicosocial=as.numeric(compromiso_biopsicosocial))%>%
    dplyr::mutate(dosis_oh=ifelse(dosis_oh>=50, NA,dosis_oh))%>%
    dplyr::mutate(dosis_oh=ifelse(dosis_thc>=50, NA,dosis_thc))%>%
    dplyr::mutate(dosis_pbc=ifelse(dosis_pbc>=50, NA,dosis_pbc))%>%
    dplyr::mutate(dosis_coc=ifelse(dosis_coc>=50, NA,dosis_coc))%>%
    dplyr::mutate(dosis_bzd=ifelse(dosis_bzd>=50, NA,dosis_bzd))%>%
    dplyr::mutate(dosis_otra=ifelse(dosis_otra>=50, NA,dosis_otra))%>%
    dplyr::mutate_at(vars(hurto, robo,  venta_drogas, rina,  otro, lugar_vivir, vivienda), ~as.numeric(.)-1)%>%
    dplyr::mutate(vif=ifelse(total_vif>0,1,0))%>%
    dplyr::mutate(transg_norm = base::rowSums(dplyr::select(., hurto,robo,venta_drogas,rina,otro,vif)))%>%
    dplyr::mutate(vif=as.logical(vif))%>%
    dplyr::mutate(salud_mean = base::rowSums(dplyr::select(., salud_fisica, calidad_vida, salud_psicologica))/3)%>%
    dplyr::mutate(dosis_mean = base::rowSums(dplyr::select(., dosis_oh, dosis_thc, dosis_pbc, dosis_coc, dosis_bzd, dosis_otra))/6)%>%
    dplyr::mutate(total_mean = base::rowSums(dplyr::select(., total_oh, total_thc, total_pbc, total_coc, total_bzd, total_otra))/6)%>%
    dplyr::mutate(vivienda_mean = (base::rowSums(dplyr::select(.,lugar_vivir, vivienda))/2)*5)%>%
    dplyr::mutate(trabajo_edu_mean = base::rowSums(dplyr::select(., total_trabajo, total_educacion))/2)%>%
    dplyr::mutate_at(vars(hurto, robo,  venta_drogas, rina,  otro, lugar_vivir, vivienda), ~as.logical(.))%>%
    dplyr::mutate(abandono_temp=dplyr::case_when(motivodeegreso_mod_imp=="Abandono Temprano"~1,TRUE~0),
                  alta_adm= dplyr::case_when(grepl("trativa",as.character(motivodeegreso_mod_imp))~1,TRUE~0))%>%
    dplyr::mutate(abandono_temp= as.factor(abandono_temp),alta_adm=as.factor(alta_adm),
    origen_ingreso_mod=as.factor(origen_ingreso_mod))%>%
    dplyr::mutate(dg_trs_fisico= dplyr::case_when(grepl("En estudio",as.character(diagnostico_trs_fisico))~1,
                                                  grepl("Sin trastorno",as.character(diagnostico_trs_fisico))~0,
                                                  is.na(as.character(diagnostico_trs_fisico))~0,
                                                  TRUE~1))%>%
    dplyr::mutate(dg_cons_dep= dplyr::case_when(grepl("Dependencia",as.character(dg_trs_cons_sus_or))~1,
                                                  TRUE~0))%>%
    dplyr::mutate(sin_otros_prob_sm= dplyr::case_when(grepl("Sin otros problemas de salud mental",as.character(otros_probl_at_sm_or), ignore.case=T)~1,
                                                  TRUE~0))%>%
    dplyr::mutate(dg_cie_10_rec=dplyr::case_when(grepl("Diagnosti",cie_10)~1,
                                                 grepl("En estudio",cie_10)~1,
                                                 TRUE~0))%>%
    dplyr::mutate(dg_cie_10_rec=as.factor(dg_cie_10_rec))%>%
    dplyr::mutate(dg_trs_fisico=as.factor(dg_trs_fisico))%>%
    dplyr::mutate(salud_mean_z=scale2(salud_mean), na.rm=T)%>%
    dplyr::mutate(dosis_mean_z=scale2(dosis_mean,na.rm=T))%>%
    dplyr::mutate(total_mean_z=scale2(total_mean), na.rm=T)%>%
    dplyr::mutate(vivienda_mean_z=scale2(vivienda_mean), na.rm=T)%>%
    dplyr::mutate(total_vif_z=scale2(total_vif), na.rm=T)%>%
    dplyr::mutate(total_trabajo_edu_z=scale2(trabajo_edu_mean,na.rm=T))%>%
    #dicotomizar variables
    dplyr::mutate(oh=dplyr::case_when(total_oh>0~1,TRUE~0),
                  thc=dplyr::case_when(total_thc>0~1,TRUE~0),
                  pbc=dplyr::case_when(total_pbc>0~1,TRUE~0),
                  coc=dplyr::case_when(total_coc>0~1,TRUE~0),
                  bzd=dplyr::case_when(total_bzd>0~1,TRUE~0),
                  otra=dplyr::case_when(total_otra>0~1,TRUE~0))%>%
    dplyr::mutate(transg_norm_bin=as.logical(dplyr::case_when(transg_norm>0~1,TRUE~0)))%>%
    dplyr::mutate(median_vivienda_mean=quantile(vivienda_mean,p=.5))%>%
    dplyr::mutate(median_total_mean=quantile(total_mean,p=.5))%>%
    dplyr::mutate(median_dosis_mean=quantile(dosis_mean,p=.5,na.rm=T))%>%
    dplyr::mutate(median_salud_mean=quantile(salud_mean,p=.5))%>%
    dplyr::mutate(median_trabajo_edu_mean=quantile(trabajo_edu_mean,p=.5))%>%
    dplyr::mutate(menor_vivienda=dplyr::case_when(vivienda_mean<median_vivienda_mean~1,TRUE~0))%>%
    dplyr::mutate(menor_salud=dplyr::case_when(salud_mean<median_salud_mean~1,TRUE~0))%>%
    dplyr::mutate(menor_trabajo_edu=dplyr::case_when(trabajo_edu_mean<median_trabajo_edu_mean~1,TRUE~0))%>%
    dplyr::mutate(mayor_total=dplyr::case_when(total_mean>=median_total_mean~1,TRUE~0))%>%
    dplyr::mutate(mayor_dosis=dplyr::case_when(median_dosis_mean>=dosis_mean~1,TRUE~0))%>%
    dplyr::mutate_at(vars(menor_salud, menor_trabajo_edu, mayor_total, mayor_dosis), ~as.logical(.))%>%
    dplyr::mutate(polycons = base::rowSums(dplyr::select(., oh, thc, pbc, coc, bzd, otra)),
                  polycons =as.logical(ifelse(polycons>0,1,0)))%>%
    dplyr::mutate(mayor_dosis=dplyr::case_when(median_dosis_mean>=dosis_mean~1,TRUE~0))%>%
    dplyr::mutate(mayor_dosis=as.logical(mayor_dosis))%>%
    dplyr::mutate(menor_vivienda=as.logical(menor_vivienda))%>%
    dplyr::mutate(mayor_comp_biopsicsoc=dplyr::case_when(compromiso_biopsicosocial=="3-Severo"~1,TRUE~0))%>%
    dplyr::mutate(mayor_comp_biopsicsoc=as.logical(mayor_comp_biopsicsoc))%>%
    dplyr::mutate(menor_comp_biopsicsoc=dplyr::case_when(compromiso_biopsicosocial=="1-Leve"~1,TRUE~0))%>%
    dplyr::mutate(menor_comp_biopsicsoc=as.logical(menor_comp_biopsicsoc))%>%
  #
  dplyr::select(-median_trabajo_edu_mean,-median_total_mean,-median_vivienda_mean, -median_salud_mean,-median_dosis_mean)

CONS_C1_df_dup_JUL_2020_match_top_sel<-
  CONS_C1_df_dup_JUL_2020_match_top_sel_prev%>%
    dplyr::filter(motivodeegreso_mod_imp!="En curso")%>% #Sacar los tratamientos que estén en curso 
  dplyr::filter(!is.na(dosis_mean_z))
  
#Una vez creadas las variables,se ordenan
CONS_C1_df_dup_JUL_2020_match_top_sel%>%
  dplyr::select(compromiso_biopsicosocial,total_oh,dosis_oh, total_thc, dosis_thc, total_pbc, dosis_pbc, total_coc, dosis_coc, total_bzd, dosis_bzd, total_otra, dosis_otra, total_vif,  total_transgresion, salud_psicologica, total_trabajo, total_educacion, salud_fisica, calidad_vida,  hurto, robo,  venta_drogas, rina,  otro, lugar_vivir, vivienda, cie_10, dg_trs_fisico, sin_otros_prob_sm,dg_cons_dep, abandono_temp, everything())-> CONS_C1_df_dup_JUL_2020_match_top_sel
skimr::skim(CONS_C1_df_dup_JUL_2020_match_top_sel%>% dplyr::select(-hash_key))%>%
  tibble::as_tibble() %>%
  knitr::kable(.,format = "html", format.args = list(decimal.mark = ".", big.mark = ","),
               caption = paste0("Table 1. Summary of Variables"),
               col.names = c("Type","Variable","Missing","Complete Rate","Ordered","No. Unique","Top Counts","Mean (logical)","Counts (logical)","Mean", "SD","Min","Perc. 25", "Median", "Perc. 75", "Max","Histogram"),
align =rep('c', 101)) %>%
  kableExtra::kable_styling(bootstrap_options = c("striped", "hover"),font_size = 7) %>%
  kableExtra::scroll_box(width = "100%", height = "375px")
```


```{r fig1, image-ref-for-in-text, echo=T, fig.align='center', message=FALSE, fig.caption="Figure 1.Summary of Process of Data Cleaning and Standardization", error=T}
#knitr::include_graphics("G:/Mi unidad/Alvacast/SISTRAT 2019 (github)/SUD_CL/Figures/Figure_Duplicates.svg")
#foreign::write.dta(CONS_C1_df_dup_JUL_2020_match_top_sel, "G:/Mi unidad/Alvacast/SISTRAT 2019 (github)/c1_top.dta")

#CONS_C1_df_dup_JUL_2020 CONS_C1_df_dup_JUL_2020_match_top CONS_TOP_df_dup_ENE_2020_prev9_match CONS_TOP_df_dup_ENE_2020_prev9
#sólo match
comb_datasets_a_n<-CONS_C1_df_dup_JUL_2020%>%
    dplyr::mutate(concat=paste0(hash_key,"_",as.character(fech_ing)))%>%
    dplyr::left_join(CONS_TOP_df_dup_ENE_2020_prev9_match,by="concat", suffix=c("","_TOP"))%>%
    dplyr::filter(!is.na(hash_key_TOP))%>%
    dplyr::select(-hash_key_TOP)%>% 
    nrow()
comb_datasets_a_users<-CONS_C1_df_dup_JUL_2020%>%
    dplyr::mutate(concat=paste0(hash_key,"_",as.character(fech_ing)))%>%
    dplyr::left_join(CONS_TOP_df_dup_ENE_2020_prev9_match,by="concat", suffix=c("","_TOP"))%>%
    dplyr::filter(!is.na(hash_key_TOP))%>%
    dplyr::select(-hash_key_TOP)%>% 
    dplyr::distinct(hash_key)%>% nrow()
#sólo los que tienen compromiso biopsicosocial
comb_datasets_b_n<-CONS_C1_df_dup_JUL_2020%>%
    dplyr::mutate(concat=paste0(hash_key,"_",as.character(fech_ing)))%>%
    dplyr::left_join(CONS_TOP_df_dup_ENE_2020_prev9_match,by="concat", suffix=c("","_TOP"))%>%
    dplyr::filter(!is.na(compromiso_biopsicosocial), !is.na(hash_key_TOP))%>%
    dplyr::select(-hash_key_TOP)%>% 
    nrow()
comb_datasets_b_users<-CONS_C1_df_dup_JUL_2020%>%
    dplyr::mutate(concat=paste0(hash_key,"_",as.character(fech_ing)))%>%
    dplyr::left_join(CONS_TOP_df_dup_ENE_2020_prev9_match,by="concat", suffix=c("","_TOP"))%>%
    dplyr::filter(!is.na(compromiso_biopsicosocial), !is.na(hash_key_TOP))%>%
    dplyr::select(-hash_key_TOP)%>% 
    dplyr::distinct(hash_key)%>% nrow()
#sólo los que tienen etapa de tratamiento de inicio de tratamiento
comb_datasets_c_n<-CONS_C1_df_dup_JUL_2020%>%
    dplyr::mutate(concat=paste0(hash_key,"_",as.character(fech_ing)))%>%
    dplyr::left_join(CONS_TOP_df_dup_ENE_2020_prev9_match,by="concat", suffix=c("","_TOP"))%>%
    dplyr::filter(!is.na(compromiso_biopsicosocial), !is.na(hash_key_TOP), etapa_del_tratamiento=="Inicio Tratamiento")%>%
    dplyr::select(-hash_key_TOP)%>% 
    nrow()
comb_datasets_c_users<-CONS_C1_df_dup_JUL_2020%>%
    dplyr::mutate(concat=paste0(hash_key,"_",as.character(fech_ing)))%>%
    dplyr::left_join(CONS_TOP_df_dup_ENE_2020_prev9_match,by="concat", suffix=c("","_TOP"))%>%
    dplyr::filter(!is.na(compromiso_biopsicosocial), !is.na(hash_key_TOP), etapa_del_tratamiento=="Inicio Tratamiento")%>%
    dplyr::select(-hash_key_TOP)%>% 
    dplyr::distinct(hash_key)%>% nrow()
#sólo los que tienen tratamientos finalizados (no en curso)

#  dplyr::filter(motivodeegreso_mod_imp!="En curso")%>% #Sacar los tratamientos que estén en curso 

#https://stackoverflow.com/questions/46750364/diagrammer-and-graphviz
#https://mikeyharper.uk/flowcharts-in-r-using-diagrammer/
#http://blog.nguyenvq.com/blog/2012/05/29/better-decision-tree-graphics-for-rpart-via-party-and-partykit/
#http://blog.nguyenvq.com/blog/2014/01/17/skeleton-to-create-fast-automatic-tree-diagrams-using-r-and-graphviz/
#https://cran.r-project.org/web/packages/DiagrammeR/vignettes/graphviz-mermaid.html
#https://stackoverflow.com/questions/39133058/how-to-use-graphviz-graphs-in-diagrammer-for-r
#https://subscription.packtpub.com/book/big_data_and_business_intelligence/9781789802566/1/ch01lvl1sec21/creating-diagrams-via-the-diagrammer-package
#https://justlegal.be/2019/05/using-flowcharts-to-display-legal-procedures/
#
#
library(DiagrammeR) #⋉
grViz("digraph flowchart {
      # node definitions with substituted label text
      node [fontname = Helvetica, shape = rectangle,fontsize = 10]        
      tab1 [label = '@@1']
      tab2 [label = '@@2']
      tab3 [label = '@@3']
      tab4 [label = '@@4']
      tab5 [label = '@@5']
      tab6 [label = '@@6']
      tab7 [label = '@@7']
      tab8 [label = '@@8']
      blank [label = '', width = 0.001, height = 0.001]

      # edge definitions with the node IDs
      tab1 -> tab2;
      blank -> tab3[label='',dir = none, shape=none, color = 'white',fontcolor = black, width=0, height=0];
      {rank=same; tab2 -> tab3 [label='Left join',fontsize = 11, dir=none]}; #⋉
      tab3 -> tab4 [label='  Result of the left join of the dataset',fontsize = 9];
      tab4 -> tab5 [label='  Only rows with available data on Biopsychosocial Compromise',fontsize = 9];
      tab5 -> tab6 [label='  Only strict matches with applications at the stage of admission',fontsize = 9];
      tab6 -> tab7 [label='  Only rows with available data on TOP scores and Diagnostic of CIE-10',fontsize = 9];
      tab7 -> tab8 [label='  Only rows with finished treatments',fontsize = 9];
      }
Only rows with available data on TOP scores

      [1]:  paste0('TOP Dataset \\n(n = ', formatC(nrow(CONS_TOP_df_dup_ENE_2020_prev9), format='f', big.mark=',', digits=0), ';\\n users: ',formatC(CONS_TOP_df_dup_ENE_2020_prev9%>% dplyr::distinct(hash_key)%>% nrow(), format='f', big.mark=',', digits=0),')')
      [2]:  paste0('Only applications w/ only one\\n application in the same date \\n(n = ', formatC(nrow(CONS_TOP_df_dup_ENE_2020_prev9_match), format='f', big.mark=',', digits=0), ';\\n users:',formatC(users_top_only_one_app_match, format='f', big.mark=',', digits=0),')')
      [3]:  paste0('Only applications w/ only one\\n application in the same date \\n(n = ', formatC(nrow(CONS_C1_df_dup_JUL_2020), format='f', big.mark=',', digits=0), ';\\n users:',formatC(CONS_C1_df_dup_JUL_2020%>% dplyr::distinct(hash_key)%>% nrow(), format='f', big.mark=',', digits=0),')')
      [4]:  paste0('Dataset \\n(n = ',formatC(comb_datasets_a_n,format='f', big.mark=',', digits=0),'\\nusers =',formatC(comb_datasets_a_users,format='f', big.mark=',', digits=0),')')
      [5]:  paste0('Dataset \\n(n = ',formatC(comb_datasets_b_n,format='f', big.mark=',', digits=0),'\\nusers =',formatC(comb_datasets_b_users,format='f', big.mark=',', digits=0),')')
      [6]:  paste0('Dataset \\n(n = ',formatC(comb_datasets_c_n,format='f', big.mark=',', digits=0),'\\nusers =',formatC(comb_datasets_c_users,format='f', big.mark=',', digits=0),')')
      [7]:  paste0('Dataset \\n(n = ', formatC(nrow(CONS_C1_df_dup_JUL_2020_match_top_sel_prev), format='f', big.mark=',', digits=0), ';\\n users: ',formatC(CONS_C1_df_dup_JUL_2020_match_top_sel_prev%>% dplyr::distinct(hash_key)%>% nrow(), format='f', big.mark=',', digits=0),')')
      [8]:  paste0('Final Sample \\n(n = ', formatC(nrow(CONS_C1_df_dup_JUL_2020_match_top_sel), format='f', big.mark=',', digits=0), ';\\n users: ',formatC(CONS_C1_df_dup_JUL_2020_match_top_sel%>% dplyr::distinct(hash_key)%>% nrow(), format='f', big.mark=',', digits=0),')')
      ")
```

<br>

It is reasonable to think that since the entries that matched with users with information of TOP at admission and  fulfilled with the requirements shown above represents only the `r scales::percent(nrow(CONS_C1_df_dup_JUL_2020_match_top_sel)/nrow(CONS_C1_df_dup_JUL_2020))` of the original database, we decided to compare the characteristics of the treatments selected and those that were not selected. 

<br>

```{r tab2a_descr_c1_pers,dpi = 96, message=F, error=T,eval=T, warnings=F}
#Definir la base de datos
CONS_C1_df_dup_JUL_2020_explore<-
    CONS_C1_df_dup_JUL_2020%>%
      dplyr::mutate(treat= ifelse(row %in% unlist(CONS_C1_df_dup_JUL_2020_match_top_sel$row),1,0))%>%
  dplyr::mutate(abandono_temp=dplyr::case_when(motivodeegreso_mod_imp=="Abandono Temprano"~1,TRUE~0),
                alta_adm= dplyr::case_when(grepl("trativa",as.character(motivodeegreso_mod_imp))~1,TRUE~0))%>%
  dplyr::mutate(abandono_temp= as.factor(abandono_temp),alta_adm=as.factor(alta_adm),
                origen_ingreso_mod=as.factor(origen_ingreso_mod))%>%
    dplyr::mutate(dg_trs_fisico= dplyr::case_when(grepl("En estudio",as.character(diagnostico_trs_fisico))~1,
                                                  grepl("Sin trastorno",as.character(diagnostico_trs_fisico))~0,
                                                  is.na(as.character(diagnostico_trs_fisico))~0,
                                                  TRUE~1))%>%
  dplyr::mutate(dg_cons_dep= dplyr::case_when(grepl("Dependencia",as.character(dg_trs_cons_sus_or))~1,
                                              TRUE~0))%>%
  dplyr::mutate(sin_otros_prob_sm= dplyr::case_when(grepl("Sin otros problemas de salud mental",as.character(otros_probl_at_sm_or), ignore.case=T)~1,
                                                    TRUE~0))%>%
  dplyr::mutate(across(c(dg_trs_psiq_cie_10_or,x2_dg_trs_psiq_cie_10_or,x3_dg_trs_psiq_cie_10_or,x4_dg_trs_psiq_cie_10_or,x5_dg_trs_psiq_cie_10_or),~dplyr::case_when(grepl("En estudio",as.character(.))~0,grepl("Sin trastorno",as.character(.))~0,is.na(.)~0,TRUE~1), .names="dg_{col}"))%>%
    dplyr::mutate(across(c(dg_trs_psiq_cie_10_or,x2_dg_trs_psiq_cie_10_or,x3_dg_trs_psiq_cie_10_or,x4_dg_trs_psiq_cie_10_or,x5_dg_trs_psiq_cie_10_or),~dplyr::case_when(grepl("En estudio",as.character(.))~1,grepl("Sin trastorno",as.character(.))~0,is.na(.)~0,TRUE~0), .names="instudy_{col}"))%>%
    dplyr::mutate(instudy_total_cie_10 = base::rowSums(dplyr::select(., instudy_dg_trs_psiq_cie_10_or, instudy_x2_dg_trs_psiq_cie_10_or, instudy_x3_dg_trs_psiq_cie_10_or, instudy_x4_dg_trs_psiq_cie_10_or, instudy_x5_dg_trs_psiq_cie_10_or)))%>%
      dplyr::mutate(dg_cie_10_rec=dplyr::case_when(grepl("Diagnosti",cie_10)~1,
                                             grepl("En estudio",cie_10)~1,
                                             TRUE~0))%>%
    dplyr::mutate(dg_cie_10_rec=as.factor(dg_cie_10_rec))%>%
  dplyr::mutate(dg_cie_10_rec=factor(dg_cie_10_rec,labels=c('No Disorder','In Study or Psychiatric Disorder')))%>%
  dplyr::mutate(compromiso_biopsicosocial=factor(compromiso_biopsicosocial,labels=c('1-Mild','2-Moderate','3-Severe')))%>%
  dplyr::mutate(origen_ingreso_mod=factor(origen_ingreso_mod,labels=c('Spontaneous','Assisted Referral','Other','Justice Sector','Health Sector')))%>%
  dplyr::mutate(dg_trs_fisico=factor(dg_trs_fisico,labels=c('No Disorder','In Study or Physical Disorder')))%>%
  dplyr::mutate(abandono_temp=factor(abandono_temp,labels=c('Other causes of discharge','Early Drop-out')))%>%
  dplyr::mutate(dg_cons_dep=factor(dg_cons_dep,labels=c('No Drug Dependence','Drug Dependence')))%>%
  dplyr::mutate(sin_otros_prob_sm=factor(sin_otros_prob_sm,labels=c('Other Mental Health Related Problems','No other mental health related problems')))%>%
  dplyr::filter(!grepl("En curso", as.character(motivodeegreso_mod_imp), ignore.case = T))

label(CONS_C1_df_dup_JUL_2020_explore$dg_cie_10_rec) <- "Psychiatric Condition (ICD-10)"
label(CONS_C1_df_dup_JUL_2020_explore$sin_otros_prob_sm) <- "Other health-related problems"
label(CONS_C1_df_dup_JUL_2020_explore$dg_trs_fisico) <- "Physical Condition"

label(CONS_C1_df_dup_JUL_2020_explore$dg_cons_dep) <- "Drug Dependence"
label(CONS_C1_df_dup_JUL_2020_explore$abandono_temp) <- "Early Drop-Out"
label(CONS_C1_df_dup_JUL_2020_explore$compromiso_biopsicosocial) <- "Compromiso Biopsicosocial(d)/Biopsychosocial Involvement(d)"
label(CONS_C1_df_dup_JUL_2020_explore$origen_ingreso_mod) <-"Origen de Ingreso (Primera Entrada)/Motive of Admission to Treatment (First Entry)"
CONS_C1_df_dup_JUL_2020_concat <- dplyr::mutate(CONS_C1_df_dup_JUL_2020,concat=paste0(hash_key,"_",as.character(fech_ing)))

#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_
#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_
library(compareGroups)
 
knitr::opts_chunk$set(echo = FALSE, warning=FALSE, message=FALSE)

table <- compareGroups(treat ~ compromiso_biopsicosocial+ origen_ingreso_mod+ abandono_temp+ dg_trs_fisico+ dg_cons_dep+ sin_otros_prob_sm+ dg_cie_10_rec,
                       method= c(compromiso_biopsicosocial=2, origen_ingreso_mod=2, abandono_temp=2, dg_trs_fisico=2, dg_cons_dep=2, sin_otros_prob_sm=2, dg_cie_10_rec=2),
                       data = CONS_C1_df_dup_JUL_2020_explore,
                       include.miss = T,
                       var.equal=T
                       )
pvals <- getResults(table)
#p.adjust(pvals, method = "BH")
restab <- createTable(table)
 export2md(restab, size=9,header.labels = c(p.overall = "p-value"), first.strip=T, hide.no="no", position="center",
           format="html",caption= "Table 2a. Summary descriptives table by groups, between selected rows (=1) and records that did not match (=0)")%>%
  kableExtra::add_footnote(c(paste0("Note. Variables related to C1 dataset. Records of treatments not finished were omitted (n=",CONS_C1_df_dup_JUL_2020%>% dplyr::filter(grepl("En curso", as.character(motivodeegreso_mod_imp), ignore.case = T))%>% nrow(),")")), notation = "none") %>%
  kableExtra::scroll_box(width = "100%", height = "375px")
```

<br>

As seen in the table above, the treatments that did not matched with TOP datasets (users in treatment in where the TOP was not administered at the time of admission) may have slightly different characteristics than the sample with complete TOPs, excepting in the percentage of people that may had other health-related problems. This is relevant because this last variable is closely related to information assessed in the subsection of TOP named as transgression to norms. In order to explore the characteristics regarding the treatment outcomes profiles, we decided to compare the selected treatments with those profiles that were not selected for the study.

<br>

```{r tab2b_descr_top_pers,dpi = 96, message=F, error=T,eval=T}
vars_to_check <- c("hurto", "robo",  "venta_drogas", "rina",  "otro", "lugar_vivir", "vivienda", "salud_fisica", "calidad_vida", "salud_psicologica", "dosis_oh", "dosis_thc", "dosis_pbc", "dosis_coc", "dosis_bzd", "dosis_otra", "total_oh", "total_thc", "total_pbc", "total_coc", "total_bzd", "total_otra", "total_vif")

CONS_TOP_df_dup_ENE_2020_prev9_match_explore<-
CONS_TOP_df_dup_ENE_2020_prev9_match%>%
    dplyr::left_join(CONS_C1_df_dup_JUL_2020_concat,by="concat", suffix=c("","_c1"))%>%
  dplyr::ungroup()%>%
  dplyr::filter(across(one_of(vars_to_check),
                ~ !is.na(.x)))%>%
    dplyr::mutate(treat=ifelse(!is.na(hash_key_c1),1,0))%>%
  dplyr::mutate(dosis_oh=ifelse(dosis_oh>=50, NA,dosis_oh))%>%
  dplyr::mutate(dosis_oh=ifelse(dosis_thc>=50, NA,dosis_thc))%>%
  dplyr::mutate(dosis_pbc=ifelse(dosis_pbc>=50, NA,dosis_pbc))%>%
  dplyr::mutate(dosis_coc=ifelse(dosis_coc>=50, NA,dosis_coc))%>%
  dplyr::mutate(dosis_bzd=ifelse(dosis_bzd>=50, NA,dosis_bzd))%>%
  dplyr::mutate(dosis_otra=ifelse(dosis_otra>=50, NA,dosis_otra))%>%
  dplyr::mutate_at(vars(hurto, robo,  venta_drogas, rina,  otro, lugar_vivir, vivienda), ~as.numeric(.)-1)%>%
  dplyr::mutate(vif=ifelse(total_vif>0,1,0))%>%
  dplyr::mutate(transg_norm = base::rowSums(dplyr::select(., hurto,robo,venta_drogas,rina,otro,vif), na.rm=T))%>%
  dplyr::mutate(vif=as.logical(vif))%>%
  dplyr::mutate(salud_mean = base::rowSums(dplyr::select(., salud_fisica, calidad_vida, salud_psicologica), na.rm=T)/3)%>%
  dplyr::mutate(dosis_mean = base::rowSums(dplyr::select(., dosis_oh, dosis_thc, dosis_pbc, dosis_coc, dosis_bzd, dosis_otra), na.rm=T)/6)%>%
  dplyr::mutate(total_mean = base::rowSums(dplyr::select(., total_oh, total_thc, total_pbc, total_coc, total_bzd, total_otra), na.rm=T)/6)%>%
  dplyr::mutate(vivienda_mean = (base::rowSums(dplyr::select(.,lugar_vivir, vivienda), na.rm=T)/2)*5)%>%
  dplyr::mutate(trabajo_edu_mean = base::rowSums(dplyr::select(., total_trabajo, total_educacion), na.rm=T)/2)%>%
  dplyr::mutate_at(vars(hurto, robo,  venta_drogas, rina,  otro, lugar_vivir, vivienda), ~as.logical(.))%>%
  dplyr::mutate(salud_mean_z=scale2(salud_mean,na.rm=T))%>%
  dplyr::mutate(dosis_mean_z=scale2(dosis_mean,na.rm=T))%>%
  dplyr::mutate(total_mean_z=scale2(total_mean,na.rm=T))%>%
  dplyr::mutate(vivienda_mean_z=scale2(vivienda_mean,na.rm=T))%>%
  dplyr::mutate(total_vif_z=scale2(total_vif,na.rm=T))%>%
  dplyr::mutate(total_trabajo_edu_z=scale2(trabajo_edu_mean,na.rm=T))%>%
  #dicotomizar variables
  dplyr::mutate(oh=dplyr::case_when(total_oh>0~1,TRUE~0),
                thc=dplyr::case_when(total_thc>0~1,TRUE~0),
                pbc=dplyr::case_when(total_pbc>0~1,TRUE~0),
                coc=dplyr::case_when(total_coc>0~1,TRUE~0),
                bzd=dplyr::case_when(total_bzd>0~1,TRUE~0),
                otra=dplyr::case_when(total_otra>0~1,TRUE~0))%>%
  dplyr::mutate(transg_norm_bin=as.logical(dplyr::case_when(transg_norm>0~1,TRUE~0)))%>%
  dplyr::mutate(median_vivienda_mean=quantile(vivienda_mean,p=.5,na.rm=T))%>%
  dplyr::mutate(median_total_mean=quantile(total_mean,p=.5,na.rm=T))%>%
  dplyr::mutate(median_dosis_mean=quantile(dosis_mean,p=.5,na.rm=T))%>%
  dplyr::mutate(median_salud_mean=quantile(salud_mean,p=.5,na.rm=T))%>%
  dplyr::mutate(median_trabajo_edu_mean=quantile(trabajo_edu_mean,p=.5,na.rm=T))%>%
  dplyr::mutate(menor_vivienda=dplyr::case_when(vivienda_mean<median_vivienda_mean~1,TRUE~0))%>%
  dplyr::mutate(menor_salud=dplyr::case_when(salud_mean<median_salud_mean~1,TRUE~0))%>%
  dplyr::mutate(menor_trabajo_edu=dplyr::case_when(trabajo_edu_mean<median_trabajo_edu_mean~1,TRUE~0))%>%
  dplyr::mutate(mayor_total=dplyr::case_when(total_mean>=median_total_mean~1,TRUE~0))%>%
  dplyr::mutate(mayor_dosis=dplyr::case_when(median_dosis_mean>=dosis_mean~1,TRUE~0))%>%
  dplyr::mutate_at(vars(menor_salud, menor_trabajo_edu, mayor_total, mayor_dosis), ~as.logical(.))%>%
  dplyr::mutate(polycons = base::rowSums(dplyr::select(., oh, thc, pbc, coc, bzd, otra)),
                polycons =as.logical(ifelse(polycons>0,1,0)))%>%
  dplyr::mutate(mayor_dosis=dplyr::case_when(median_dosis_mean>=dosis_mean~1,TRUE~0))%>%
  dplyr::mutate(mayor_dosis=as.logical(mayor_dosis))%>%
  dplyr::mutate(menor_vivienda=as.logical(menor_vivienda))%>%
  dplyr::filter(!is.na(dosis_mean_z))

label(CONS_TOP_df_dup_ENE_2020_prev9_match_explore$salud_mean_z) <- "Promedio ptjes. est. de estado de salud autorreportado/Average std. score of self-reported health"
label(CONS_TOP_df_dup_ENE_2020_prev9_match_explore$dosis_mean_z) <- "Promedio ptjes. est. de dosis media/Average std. score of mean dose"
label(CONS_TOP_df_dup_ENE_2020_prev9_match_explore$total_mean_z) <- "Promedio ptjes. est. de patrones de uso de sus. principales/Average std. score of patterns of drug use in main substances"
label(CONS_TOP_df_dup_ENE_2020_prev9_match_explore$total_trabajo_edu_z) <- "Promedio est. de días trabajados o asistidos a una institución educacional/Average std. days worked and attended an educational institution"
label(CONS_TOP_df_dup_ENE_2020_prev9_match_explore$total_vif_z) <- "Ptjes. est. del Total en Violencia Intrafamiliar/std. score in Domestic Violence"

label(CONS_TOP_df_dup_ENE_2020_prev9_match_explore$hurto) <- "Hurto/Theft (Transgression to Norms in past 4 weeks)"
label(CONS_TOP_df_dup_ENE_2020_prev9_match_explore$robo) <- "Robo/Robbery (Transgression to Norms in past 4 weeks)"
label(CONS_TOP_df_dup_ENE_2020_prev9_match_explore$venta_drogas) <- "Venta de Drogas/Drug-selling (Transgression to Norms in past 4 weeks)"
label(CONS_TOP_df_dup_ENE_2020_prev9_match_explore$rina) <- "Riña/Fights (Transgression to Norms in past 4 weeks)"
label(CONS_TOP_df_dup_ENE_2020_prev9_match_explore$otro) <- "Otras Transgresiones a la Norma/Other transgression to norms (Transgression to Norms in past 4 weeks)"
label(CONS_TOP_df_dup_ENE_2020_prev9_match_explore$lugar_vivir) <- "Lugar Estable para Vivir/Stable Place to Live in the past 4 weeks (Housing conditions in past 4 weeks)"
label(CONS_TOP_df_dup_ENE_2020_prev9_match_explore$vivienda) <- "Habita en una vivienda con las condiciones básicas/Lived in a Houshold with basic conditions in the past 4 weeks (Housing conditions in past 4 weeks)"
label(CONS_TOP_df_dup_ENE_2020_prev9_match_explore$vif) <- "Violencia Intrafamiliar Reportada en las últimas 4 semanas/Reported Domestic Violence Events in the past 4 weeks (Transgression to Norms)"

knitr::opts_chunk$set(echo = FALSE, warning=FALSE, message=FALSE)

table <- compareGroups(treat ~salud_mean_z+ dosis_mean_z+ total_mean_z+ total_trabajo_edu_z+ hurto+ robo+ venta_drogas+ rina+ otro+ lugar_vivir+vif+ vivienda,
                       data = CONS_TOP_df_dup_ENE_2020_prev9_match_explore,include.miss = T,var.equal=T,method=c(2,2,2,2,3,3,3,3,3,3,3,3))
pvals <- getResults(table, "p.overall")

#p.adjust(pvals, method = "BH")
restab <- createTable(table)
 export2md(restab, header.labels = c(p.overall = "p-value"), size=9,format="html",position="center",caption= "Table 2b. Summary descriptives table by groups, between selected rows (=1) and records that did not match (=0)")%>%
  kableExtra::add_footnote(c("Note. Variables related to TOP dataset.", paste0("We discarded cases with missing values in one of the variables (n=", CONS_TOP_df_dup_ENE_2020_prev9_match%>%dplyr::left_join(CONS_C1_df_dup_JUL_2020_concat,by="concat", suffix=c("","_c1"))%>%dplyr::ungroup()%>%dplyr::filter(across(one_of(vars_to_check),~ is.na(.x)))%>% nrow(),")")), notation = "none") %>%
  kableExtra::scroll_box(width = "100%", height = "375px")
```

<br>

In the Table above and despite we were focused in the treatments of the Agreement 1 dataset, we may see that the only variable that did not have greater differences between the matched records and those that did not is the basic housing conditions and the standardized average days worked or assisted to educational institutions. The rest may vary greatly.

<br>

```{r tab2c_descr_all,dpi = 96, message=F, error=T,eval=T}
vars_to_check <- c("hurto", "robo",  "venta_drogas", "rina",  "otro", "lugar_vivir", "vivienda", "salud_fisica", "calidad_vida", "salud_psicologica", "dosis_oh", "dosis_thc", "dosis_pbc", "dosis_coc", "dosis_bzd", "dosis_otra", "total_oh", "total_thc", "total_pbc", "total_coc", "total_bzd", "total_otra", "total_vif")
CONS_C1_df_dup_JUL_2020_match_top_sel_c<-
  CONS_C1_df_dup_JUL_2020_match_top_sel%>%
  dplyr::mutate(dg_cie_10_rec=as.factor(dg_cie_10_rec))%>%
      dplyr::mutate(dg_cie_10_rec=factor(dg_cie_10_rec,labels=c('No Disorder','In Study or Psychiatric Disorder')))%>%
      dplyr::mutate(compromiso_biopsicosocial=factor(compromiso_biopsicosocial,labels=c('1-Mild','2-Moderate','3-Severe')))%>%
      dplyr::mutate(origen_ingreso_mod=factor(origen_ingreso_mod,labels=c('Spontaneous','Assisted Referral','Other','Justice Sector','Health Sector')))%>%
      dplyr::mutate(dg_trs_fisico=factor(dg_trs_fisico,labels=c('No Disorder','In Study or Physical Disorder')))%>%
      dplyr::mutate(abandono_temp=factor(abandono_temp,labels=c('Other causes of discharge','Early Drop-out')))%>%
      dplyr::mutate(dg_cons_dep=factor(dg_cons_dep,labels=c('No Drug Dependence','Drug Dependence')))%>%
      dplyr::mutate(sin_otros_prob_sm=factor(sin_otros_prob_sm,labels=c('Other Mental Health Related Problems','No other mental health related problems')))%>%
  dplyr::mutate(eso=ifelse(as.character(compromiso_biopsicosocial)=="eso",1,0))


#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_

label(CONS_C1_df_dup_JUL_2020_match_top_sel_c$dg_cie_10_rec) <- "Psychiatric Condition (ICD-10)"
label(CONS_C1_df_dup_JUL_2020_match_top_sel_c$sin_otros_prob_sm) <- "Other health-related problems"
label(CONS_C1_df_dup_JUL_2020_match_top_sel_c$dg_trs_fisico) <- "Physical Condition"

label(CONS_C1_df_dup_JUL_2020_match_top_sel_c$dg_cons_dep) <- "Drug Dependence"
label(CONS_C1_df_dup_JUL_2020_match_top_sel_c$abandono_temp) <- "Early Drop-Out"
label(CONS_C1_df_dup_JUL_2020_match_top_sel_c$compromiso_biopsicosocial) <- "Compromiso Biopsicosocial(d)/Biopsychosocial Involvement(d)"
label(CONS_C1_df_dup_JUL_2020_match_top_sel_c$origen_ingreso_mod) <-"Origen de Ingreso (Primera Entrada)/Motive of Admission to Treatment (First Entry)"
label(CONS_C1_df_dup_JUL_2020_match_top_sel_c$salud_mean_z) <- "Promedio ptjes. est. de estado de salud autorreportado/Average std. score of self-reported health"
label(CONS_C1_df_dup_JUL_2020_match_top_sel_c$dosis_mean_z) <- "Promedio ptjes. est. de dosis media/Average std. score of mean dose"
label(CONS_C1_df_dup_JUL_2020_match_top_sel_c$total_mean_z) <- "Promedio ptjes. est. de patrones de uso de sus. principales/Average std. score of patterns of drug use in main substances"
label(CONS_C1_df_dup_JUL_2020_match_top_sel_c$total_trabajo_edu_z) <- "Promedio est. de días trabajados o asistidos a una institución educacional/Average std. days worked and attended an educational institution"
label(CONS_C1_df_dup_JUL_2020_match_top_sel_c$total_vif_z) <- "Ptjes. est. del Total en Violencia Intrafamiliar/std. score in Domestic Violence"

label(CONS_C1_df_dup_JUL_2020_match_top_sel_c$hurto) <- "Hurto/Theft (Transgression to Norms in past 4 weeks)"
label(CONS_C1_df_dup_JUL_2020_match_top_sel_c$robo) <- "Robo/Robbery (Transgression to Norms in past 4 weeks)"
label(CONS_C1_df_dup_JUL_2020_match_top_sel_c$venta_drogas) <- "Venta de Drogas/Drug-selling (Transgression to Norms in past 4 weeks)"
label(CONS_C1_df_dup_JUL_2020_match_top_sel_c$rina) <- "Riña/Fights (Transgression to Norms in past 4 weeks)"
label(CONS_C1_df_dup_JUL_2020_match_top_sel_c$otro) <- "Otras Transgresiones a la Norma/Other transgression to norms (Transgression to Norms in past 4 weeks)"
label(CONS_C1_df_dup_JUL_2020_match_top_sel_c$lugar_vivir) <- "Lugar Estable para Vivir/Stable Place to Live in the past 4 weeks (Housing conditions in past 4 weeks)"
label(CONS_C1_df_dup_JUL_2020_match_top_sel_c$vivienda) <- "Habita en una vivienda con las condiciones básicas/Lived in a Houshold with basic conditions in the past 4 weeks (Housing conditions in past 4 weeks)"
label(CONS_C1_df_dup_JUL_2020_match_top_sel_c$vif) <- "Violencia Intrafamiliar Reportada en las últimas 4 semanas/Reported Domestic Violence Events in the past 4 weeks (Transgression to Norms)"

#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_
#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_
library(compareGroups)
 
knitr::opts_chunk$set(echo = FALSE, warning=FALSE, message=FALSE)

table <- compareGroups(eso~compromiso_biopsicosocial+ origen_ingreso_mod+ abandono_temp+ dg_trs_fisico+ dg_cons_dep+ sin_otros_prob_sm+ dg_cie_10_rec+ salud_mean_z+ dosis_mean_z+ total_mean_z+ total_trabajo_edu_z+ hurto+ robo+ venta_drogas+ rina+ otro+ lugar_vivir+vif+ vivienda,
                       method= c(compromiso_biopsicosocial=2, origen_ingreso_mod=2, abandono_temp=2, dg_trs_fisico=2, dg_cons_dep=2, sin_otros_prob_sm=2, dg_cie_10_rec=2, salud_mean_z=2, dosis_mean_z=2, total_mean_z=2, total_trabajo_edu_z=2, hurto=3, robo=3, venta_drogas=3, rina=3, otro=3, vif=3, lugar_vivir=3, vivienda=3),
                       data = CONS_C1_df_dup_JUL_2020_match_top_sel_c,
                       include.miss = T,
                       var.equal=T
                       )
pvals <- getResults(table)
#p.adjust(pvals, method = "BH")
restab <- createTable(table)
 export2md(restab, size=9,header.labels = c(p.overall = ""), first.strip=T, hide.no="no", position="center",
           format="html",caption= "Table 2c. Summary descriptives")%>%
  kableExtra::add_footnote(c(paste0("Note.")), notation = "none")
```

<br>

To get an idea of the distribution of the biopsychosocial compromise among the selected sample, we generated a pie chart.

<br>

```{r fig2b, fig.width = 7, dpi = 96, warning=F,message=F,fig.align='center', fig.cap="Figure 2. Biopsychosocial Compromise", error=T, eval=T}
library(plotly)

CONS_C1_df_dup_JUL_2020_match_top_sel %>%
     dplyr::group_by(compromiso_biopsicosocial)%>%
      dplyr::mutate(compromiso_biopsicosocial=case_when(compromiso_biopsicosocial=="2-Moderado"~"Moderate",
                                                        compromiso_biopsicosocial=="1-Leve"~"Mild",
                                                        TRUE~"Severe"))%>%
       dplyr::summarise(n=n(),percent=round(n/sum(n),2))%>% 
     dplyr::ungroup()%>%
plot_ly( labels = ~compromiso_biopsicosocial, values = ~n, type = 'pie',hole = 0.6,textposition = 'outside',textinfo = 'label+percent', marker = list(colors = c("yellowgreen","orange","tomato"))) %>%
  layout(xaxis = list(showgrid = FALSE, zeroline = FALSE, showticklabels = FALSE),
         yaxis = list(showgrid = FALSE, zeroline = FALSE, showticklabels = FALSE))
```

<br>

We generated a correlation plot which wraps different type of variables (continuous, polytomous, dichotomous) [@RN127]. We selected mostly the original variables from the instrument.

<br>

```{r fig3, fig.width = 7, dpi = 96, warning=F,message=F,fig.align='center',fig.cap="Figure 3.Matrix Of Correlations Between Original Variables"}
# It first identifies the types of variables, organizes them by type (continuous, polytomous, dichotomous), calls the appropriate correlation function, and then binds the resulting matrices together.D
mix_cor<- psych::mixedCor(data=CONS_C1_df_dup_JUL_2020_match_top_sel%>%dplyr::mutate(compromiso_biopsicosocial=as.numeric(compromiso_biopsicosocial)),c=2:20, #total_oh,dosis_oh total_thc dosis_thc total_pbc dosis_pbc total_coc dosis_coc total_bzd dosis_bzd  total_otra dosis_otra total_vif  total_transgresion salud_psicologica total_trabajo total_educacion salud_fisica calidad_vida 
         p=1,#compromiso_biopsicosocial,
         d=21:27,#, hurto robo  venta_drogas rina  otro lugar_vivir vivienda
         smooth=TRUE,
         correct=.5,
         global=TRUE,
         ncat=8,
         use="pairwise",
         method="kendall",
         weight=NULL)

# Getting the correlation matrix of the dataset.
comp_biopsicosoc_mat <- mix_cor$rho

# Explore the correlation structure of the dataset.
library(ggcorrplot)
ggcorrplot(comp_biopsicosoc_mat,
          ggtheme = ggplot2::theme_gray,
          colors = c("#E46726", "white", "#6D9EC1"),
           tl.cex=8)

#subscript out of bounds

#mixedCor(data=CONS_C1_df_dup_JUL_2020_match_top_sel,c=c("total_oh","dosis_oh", "total_thc", "dosis_thc", "total_pbc", "dosis_pbc", "total_coc", "dosis_coc", "total_bzd", "dosis_bzd", "total_otra", "dosis_otra", "total_vif",  "total_transgresion", "salud_psicologica", "total_trabajo", "total_educacion", "salud_fisica", "calidad_vida"), p="compromiso_biopsicosocial",d=c("hurto", "robo",  "venta_drogas", "rina",  "otro", "lugar_vivir", "vivienda"), smooth=TRUE,correct=.5,global=TRUE,ncat=8,use="pairwise",method="pearson",weight=NULL)

#subscript out of bounds
#set.seed(123)
#par(mar=c(1,1,1,1))
#comp_biopsicosoc_mat_ci<-mycor.ci(x=CONS_C1_df_dup_JUL_2020_match_top_sel%>%dplyr::mutate(compromiso_biopsicosocial=as.numeric(compromiso_biopsicoso#cial)), 
#                                  method="spearman", 
#                                  poly=TRUE, 
#                                  cvars=2:20, 
#                                  pvars=1,
#                                  dvars=21:27, 
#                                   n.iter=1000,
#                                  plot = F)
#
#cor_pmat(): para ver la sig estadística de las correlaciones
```

<br>

Also we included an heterogeneus matrix of correlations, consisting of polychoric, biserial and pearson correlations [@RN128]. In the following matrix, we selected the recoded variables useful to contrast our  hypotheses.

<br>

```{r fig4_corrplot, fig.width = 7, dpi = 96, warning=F,message=F,fig.align='center', fig.cap="Figure 4.Matrix Of Correlations Between Transformed Variables", error=T}
require(polycor)
#Computes a heterogenous correlation matrix, consisting of Pearson product-moment correlations between numeric variables, polyserial correlations between numeric and ordinal variables, and polychoric correlations between ordinal variables.
hetcor_mat<-hetcor(CONS_C1_df_dup_JUL_2020_match_top_sel[c("compromiso_biopsicosocial",                                                    "dosis_mean_z","total_mean_z","salud_mean_z","total_trabajo_edu_z","hurto","robo","venta_drogas","rina","otro","lugar_vivir","vivienda","vif")], ML = T, std.err = T, use="complete.obs", bins=4, pd=TRUE)
#CONS_C1_df_dup_JUL_2020_match_top_sel%>% select(contains("dosis"))%>% hist()

attr(hetcor_mat$correlations,"dimnames")[[1]][1]<-"Biopsychosocial Compromise"
attr(hetcor_mat$correlations,"dimnames")[[1]][2]<-"Avg. std. score of mean dose"
attr(hetcor_mat$correlations,"dimnames")[[1]][3]<-"Avg. std. score of drug use"
attr(hetcor_mat$correlations,"dimnames")[[1]][4]<-"Avg. std. score of self-reported health"
attr(hetcor_mat$correlations,"dimnames")[[1]][5]<-"Avg. std. days worked & in education"
attr(hetcor_mat$correlations,"dimnames")[[1]][6]<-"Theft"
attr(hetcor_mat$correlations,"dimnames")[[1]][7]<-"Robbery"
attr(hetcor_mat$correlations,"dimnames")[[1]][8]<-"Drug-selling"

attr(hetcor_mat$correlations,"dimnames")[[1]][9]<-"Fights"
attr(hetcor_mat$correlations,"dimnames")[[1]][10]<-"Other transgression to norms"
attr(hetcor_mat$correlations,"dimnames")[[1]][11]<-"Stable Place to Live"
attr(hetcor_mat$correlations,"dimnames")[[1]][12]<-"Household with basic conditions"
attr(hetcor_mat$correlations,"dimnames")[[1]][13]<-"Domestic Violence"

attr(hetcor_mat$correlations,"dimnames")[[2]][1]<-"Biopsychosocial Compromise"
attr(hetcor_mat$correlations,"dimnames")[[2]][2]<-"Avg. std. score of mean dose"
attr(hetcor_mat$correlations,"dimnames")[[2]][3]<-"Avg. std. score of drug use"
attr(hetcor_mat$correlations,"dimnames")[[2]][4]<-"Avg. std. score of self-reported health"
attr(hetcor_mat$correlations,"dimnames")[[2]][5]<-"Avg. std. days worked & in education"
attr(hetcor_mat$correlations,"dimnames")[[2]][6]<-"Theft"
attr(hetcor_mat$correlations,"dimnames")[[2]][7]<-"Robbery"
attr(hetcor_mat$correlations,"dimnames")[[2]][8]<-"Drug-selling"

attr(hetcor_mat$correlations,"dimnames")[[2]][9]<-"Fights"
attr(hetcor_mat$correlations,"dimnames")[[2]][10]<-"Other transgression to norms"
attr(hetcor_mat$correlations,"dimnames")[[2]][11]<-"Stable Place to Live"
attr(hetcor_mat$correlations,"dimnames")[[2]][12]<-"Household with basic conditions"
attr(hetcor_mat$correlations,"dimnames")[[2]][13]<-"Domestic Violence"
p.mat <- cor_pmat(hetcor_mat$tests)

ggcorrplot(hetcor_mat$correlations,
           ggtheme = ggplot2::theme_void,insig = "pch",type = "lower",pch.cex=2,tl.srt = 45,
           colors = c("#E46726", "white", "#6D9EC1"), tl.cex=8,lab=T)+
  theme(axis.text.x = element_text(size=0.0001,color ="white"))
```
<br>

# Variables of TOP depending on Biopsychosocial Compromise

<br>

```{r fig_5_bar_fill,eval=T, echo=T, paged.print=TRUE, fig.align='center', fig.cap="Figure 5. Bar Plot of Binary Answers By Biopsychosocial Compromise"}
library(reshape2)  # for melt() function
library(ggplot2)
# First we need to restructure the data into long format:
ocdMelt <- melt(CONS_C1_df_dup_JUL_2020_match_top_sel[c('compromiso_biopsicosocial','hurto',"robo","venta_drogas","rina","otro","lugar_vivir","vivienda","vif")], id=c('compromiso_biopsicosocial'))
names(ocdMelt) <- c('Group', 'Outcome_Measure', 'Frequency')
ocdMelt <-ocdMelt%>% dplyr::mutate(Frequency=factor(Frequency))%>% dplyr::group_by(Outcome_Measure,Group,Frequency)%>% dplyr::arrange(Outcome_Measure, Group,Frequency)%>% dplyr::add_tally()%>% distinct(.,.keep_all=T)%>% dplyr::ungroup()%>% dplyr::group_by(Group, Outcome_Measure)%>% dplyr::mutate(perc=n/sum(n))%>% dplyr::ungroup()%>%
  dplyr::mutate(Group= dplyr::case_when(Group=="2-Moderado"~"2-Moderate",
                                                        Group=="1-Leve"~"1-Mild",
                                                        TRUE~"3-Severe"))%>%
  dplyr::mutate(Outcome_Measure= dplyr::case_when(as.character(Outcome_Measure)=="hurto"~"Theft",
                                                  as.character(Outcome_Measure)=="robo"~"Robbery",
                                                  as.character(Outcome_Measure)=="venta_drogas"~"Drug-selling",
                                                  as.character(Outcome_Measure)=="rina"~"Fights",
                                                  as.character(Outcome_Measure)=="otro"~"Other\ntransgression\nto norms",
                                                  as.character(Outcome_Measure)=="lugar_vivir"~"Stable Place to Live",
                                                  as.character(Outcome_Measure)=="vivienda"~"Household with\nbasic conditions",
                                                  as.character(Outcome_Measure)=="vif"~"Domestic Violence"))%>%
  dplyr::mutate(Outcome_Measure= as.factor(Outcome_Measure))
# plot
p5<-ggplot(ocdMelt, aes(Outcome_Measure,perc))+
  geom_bar(aes(fill= Frequency),stat="identity")+
  facet_grid(Group~.)+
  scale_y_continuous(labels = scales::percent_format(accuracy = 5L),limits=c(0,1))+
  scale_fill_manual(values=c("grey60","steelblue"),labels=c("Absence", "Presence")) +
  sjPlot::theme_sjplot2() + 
  ylab("Biopsychosocial Compromise")+
  theme(axis.text.x = element_text(size=8,vjust = .5,angle=25), axis.text.y = element_text(size=10),
        axis.title.y = element_text(size = 14)) +
  theme(
    panel.grid.minor = element_blank(), 
    panel.grid.major = element_blank(),
    panel.grid.major.x = element_blank(),
    panel.background = element_blank(),
    line = element_blank())
p5
```

<br>

We generated z scores for those composite scores of multiple variables, in order to make them comparable. In the following figure we may observe the distribution of continuous variables among users with different levels of biopsychosocial compromise.

<br>

```{r fig6_boxplot,eval=T, echo=T, paged.print=TRUE, fig.align='center', fig.cap="Figure 6. Box Plot of Continuous Answers By Biopsychosocial Compromise", warning=F, message=F}
library(reshape2)  # for melt() function
library(ggplot2)
# First we need to restructure the data into long format:
ocdMelt2 <- melt(CONS_C1_df_dup_JUL_2020_match_top_sel[c('compromiso_biopsicosocial',"salud_mean_z","dosis_mean_z", "total_mean_z","total_trabajo_edu_z")], id=c('compromiso_biopsicosocial'))
names(ocdMelt2) <- c('Group', 'Outcome_Measure', 'Frequency')

ocdMelt2<-
  ocdMelt2%>%
    dplyr::mutate(Group= dplyr::case_when(Group=="2-Moderado"~"2-Moderate",
                                                          Group=="1-Leve"~"1-Mild",
                                                          TRUE~"3-Severe"))%>%
    dplyr::mutate(Outcome_Measure= dplyr::case_when(as.character(Outcome_Measure)=="salud_mean_z"~"Avg. std. score of\nself-reported health",
                                                    as.character(Outcome_Measure)=="dosis_mean_z"~"Avg. std. score of\nmean dose",
                                                    as.character(Outcome_Measure)=="total_mean_z"~"Avg. std.  score of\ndrug use",
                                                    as.character(Outcome_Measure)=="total_trabajo_edu_z"~"Avg. std. days\nworked & in education"))%>%
    dplyr::mutate(Outcome_Measure= as.factor(Outcome_Measure))

# plot
ocdBoxplot <- ggplot(ocdMelt2, aes(Group, Frequency, color = Outcome_Measure)) + 
  geom_jitter(alpha=0.05) +
  geom_boxplot() + 
  labs(x='Biopsychosocial Compromise', y='Scores', color='Variable') + scale_y_continuous(breaks=seq(0,50, by=5))+  
  sjPlot::theme_sjplot2() + 
  scale_color_manual(values=c("darkslategray4","rosybrown","dimgray","coral3","grey60"),na.value="black") + #"Set2"
  theme(
    panel.grid.minor = element_blank(), 
    panel.grid.major = element_blank(),
    panel.grid.major.x = element_blank(),
    panel.background = element_blank(),
    line = element_blank())
ocdBoxplot
```

<br>

As seen above, users categorized with a severe Biopsychosocial Compromise showed slightly greater patterns of consumption and lower average health in comparison to users with a mild Biopsychosocial Compromise. However, and at least in an descriptive view, they seem to not differ much between the different levels.

<br>

We checked the multivariate normality of these four last variables, in order to choose the most adequate technique to perform the analyses. These analyses may let us infer whether that users in different levels of Biopsychosocial Compromise derive from the same population in terms of scores in the Treatment Outcomes Profile.

<br>

```{r mvn,eval=T, error=T, echo=T, paged.print=TRUE, fig.show = 'hide'}
mvn_test<-MVN::mvn(CONS_C1_df_dup_JUL_2020_match_top_sel[c("salud_mean_z","total_mean_z","dosis_mean_z","total_trabajo_edu_z")], mvnTest = "mardia", covariance = TRUE, tol = 1e-25, alpha = 0.5,scale = T, desc = TRUE, transform = "none", R = 1000,
univariateTest = "Lillie",
univariatePlot = "none", multivariatePlot = "none",
multivariateOutlierMethod = "none", bc = FALSE, bcType = "rounded",
showOutliers = FALSE, showNewData = FALSE)

#la distancia de mahalanois mide la similitud de variables aleatorias multidimensionales
mvn_test$multivariateNormality%>%
    data.frame()%>% mutate(Statistic=round(as.numeric(as.character(Statistic)),2))%>% 
      dplyr::mutate(`p.value`=sprintf("%5.3f",as.numeric(as.character(`p.value`))))%>%
  knitr::kable(.,format = "html", format.args = list(decimal.mark = ".", big.mark = ","),
               caption="Table 3. Multivariate Normality Test",
                 align =rep('c', 101),
               col.names=c("Test", "Statistic", "P Value", "Normality"))%>%
   kableExtra::kable_styling(bootstrap_options = c("striped", "hover"),font_size = 8) %>%
  kableExtra::add_footnote( c("Note. Using z-scores distributions of Average Health, Average days worked or in assistance to educational institutions, Average Frequency of Use in the last Month and Average Dose in the last Month"), notation = "none") %>%
  kableExtra::scroll_box(width = "100%", height = "175px")
```
<br>

As seen above, the continuous variables did not follow a normal distribution.

<br>

# Non-parametric Multivariate Test

Considering that our variables did not follow a normal distribution, and the test is composed by a mixture of different variable types, we performed a nonparametric test for multivariate samples. The variability of
responses on each of the variables of top was compared between the groups using a non-parametric multivariate ANOVA (mnpv) [@ellis2017nonparametric] with biopsychosocial compromise as between-subject factor (discarding inter-observer variability). The procedure generates a randomization test of 5,000 resamples to compute F-statistic (pseudo-F). Additionally, these models have the advantage that allow for differences in between-group variation, is not sensitive to multicollinearity, allows for the inclusion of more variables, and tolerate sparse data.

<br>

```{r anova,dpi = 96, message=F, echo=T,error=T,eval=F}
#mvnormtest::mshapiro.test()

dependent.vars <- cbind(CONS_C1_df_dup_JUL_2020_match_top_sel$salud_mean_z,CONS_C1_df_dup_JUL_2020_match_top_sel$dosis_mean_z, CONS_C1_df_dup_JUL_2020_match_top_sel$total_mean_z)
root.manova <- manova(dependent.vars ~ CONS_C1_df_dup_JUL_2020_match_top_sel$compromiso_biopsicosocial, intercept=F)
summary(root.manova,test="Pillai")
#test='Pillai'). The manova() function provides four multivariate tests by setting the test argument to either Pillai, #Wilks, Hotelling-Lawley, or Roy.

#La prueba de Wilk es la más comúnmente utilizada debido a que fue la primera prueba en ser derivada y a que posee una aproximación F bastante conocida.
#Lawley-Hotelling es también conocida como el estadístico T2 generalizado de Hotelling.
#La prueba de Pillai es la mejor prueba a utilizar en la mayoría de las situaciones. La prueba de Pillai proporciona resultados similares a los de las pruebas de Wilks y de Lawley-Hotelling.
#La prueba de la raíz más grande de Roy es la mejor cuando los vectores medios son colineales. La prueba de Roy no tiene una aproximación F satisfactoria.

summary.aov(root.manova)
```

<div style="border: 1px solid #ddd; padding: 5px; overflow-y: scroll; height:250px; overflow-x: scroll; width:100%">
```{r nonpar1a, dpi = 96, message=F,echo=T, error=F}
CONS_C1_df_dup_JUL_2020_match_top_sel2<-
  CONS_C1_df_dup_JUL_2020_match_top_sel%>%
      dplyr::mutate_at(vars(hurto, robo,  venta_drogas, rina,  otro, lugar_vivir, vivienda,vif), ~as.numeric(as.factor(as.numeric(.)-1)))
#https://stackoverflow.com/questions/59166335/need-help-using-npmv-package-nonparametric-testing-in-r
sys_time_a<-Sys.time()

invisible(
prueba_anormalidad1<-npmv::nonpartest(dosis_mean_z|total_mean_z|salud_mean_z|total_trabajo_edu_z|hurto|robo|venta_drogas|rina|otro|lugar_vivir|vivienda|vif~compromiso_biopsicosocial, CONS_C1_df_dup_JUL_2020_match_top_sel2,plots=F,permreps=5000,releffects=TRUE)
)

prueba_anormalidad_res1<-data.table::data.table(prueba_anormalidad1$results, keep.rownames=T)
sys_time_b<-Sys.time()

diff_ab<-difftime(sys_time_a, sys_time_b, units = "mins")

invisible(
prueba_anormalidad1_ssnonpartest<-npmv::ssnonpartest(dosis_mean_z|total_mean_z|salud_mean_z|total_trabajo_edu_z|hurto|robo|venta_drogas|rina|otro|lugar_vivir|vivienda|vif~ compromiso_biopsicosocial, data = CONS_C1_df_dup_JUL_2020_match_top_sel2, test = c(0, 0, 0, 1), alpha = 0.05, factors.and.variables = TRUE)
)
```
</div>

```{r nonpar1b, dpi = 96, message=F,echo=T, error=F}
#All appropriate subsets using response variables have been checked using a multiple testing procedure, which controls the maximum overall type I error rate at alpha= 0.05
#INOCRPORË LAS VAR DE CONTROL. SON TODAS DE TIPO FACTOR

sum_df_npmv<-data.frame(cbind(Model=paste0("npmv",c("Raw","Raw","Raw","Raw")),
  rbind(prueba_anormalidad_res1)))%>%
  dplyr::rename("Parameter"="rn")%>%
  dplyr::mutate(`P.value`=sprintf("%5.3f",P.value), `Permutation.Test.p.value`=sprintf("%5.3f",Permutation.Test.p.value))

sys_time_c<-Sys.time()

sum_df_npmv%>% 
  dplyr::mutate(Test.Statistic=round(as.numeric(as.character(Test.Statistic)),2))%>% 
  knitr::kable(.,format = "html", format.args = list(decimal.mark = ".", big.mark = ","),
               caption="Table 4. Analysis of Variance",
                 align =rep('c', 101),
               col.names=c("Model", "Parameter", "Statistic", "DF1", "DF2","p-value", "Permutation Test p-value"))%>%
   kableExtra::kable_styling(bootstrap_options = c("striped", "hover"),font_size = 8) %>%
  kableExtra::add_footnote( c("Note. Model with average dose (z score), average frequency of use (z score), average reported health (z score), average days worked or attending an educational institution (z score), theft, burglary, drug selling, fights, other, place to live, housing condition and domestic violence."), notation = "none")
##NO OCUPAR: MUY COMPLICADO
#The function ssnonpartest performs an all-subset algorithm to determine which variables cause significant effects, and between which factor levels. See the examples below for some basic uses and look in the help pages for each function for a much more detailed look.
#invisible(
#npmv::ssnonpartest(dosis_mean|total_mean|trabajo_edu_mean~compromiso_biopsicosocial,CONS_C1_df_dup_JUL_2020_match_top_sel,test=c(1,0,0,0),alpha=.05,factors.and.variables=TRUE)
#)
```

<br>

We also included the non-parametric relative treatment effects (RTE) for each variable in probabilities.

<br>

```{r fig7_nonpar2, dpi = 96,fig.align='center', message=F,fig.cap="Figure 7. RTEs for each TOP component by Biopsychosocial Compromise", error=T,echo=T, eval=T, fig.height=8}
nonpar_releffects<-
data.table(prueba_anormalidad1$releffects,keep.rownames = T)%>% 
 melt(id="rn")%>%
dplyr::rename("Group"="rn","Outcome_Measure"="variable","Frequency"="value")%>%
dplyr::mutate(Group= dplyr::case_when(Group=="2-Moderado"~"2-Moderate",
                                      Group=="1-Leve"~"1-Mild",
                                      TRUE~"3-Severe"))%>%
dplyr::mutate(Outcome_Measure= dplyr::case_when(as.character(Outcome_Measure)=="hurto"~"Theft",
                                                as.character(Outcome_Measure)=="robo"~"Robbery",
                                                as.character(Outcome_Measure)=="venta_drogas"~"Drug-selling",
                                                as.character(Outcome_Measure)=="rina"~"Fights",
                                                as.character(Outcome_Measure)=="otro"~"Other\ntransgression\nto norms",
                                                as.character(Outcome_Measure)=="lugar_vivir"~"Stable Place\nto Live",
                                                as.character(Outcome_Measure)=="vivienda"~"Household with\nbasic\nconditions",
                                                as.character(Outcome_Measure)=="vif"~"Domestic Violence",
              as.character(Outcome_Measure)=="salud_mean_z"~"Avg. std. score of\nself-reported health",
                                                as.character(Outcome_Measure)=="dosis_mean_z"~"Avg. std. score\nof mean dose",
                                                as.character(Outcome_Measure)=="total_mean_z"~"Avg. std. score\nof drug use",
   as.character(Outcome_Measure)=="total_trabajo_edu_z"~"Avg. std. days\nworked & in education"))%>%
  dplyr::mutate(Group= as.factor(Group))%>%
  dplyr::mutate(Frequency=Frequency-.5)

## Find the minimum and maximum y
mi <- min(nonpar_releffects$Frequency)
ma <- max(nonpar_releffects$Frequency)
if(1 - mi > ma - 1) { 
    newylim <- c(mi  , 2 - mi)  ## Lower limit remains same, Upper limit is increased
} else { 
    newylim <- c(2 - ma, ma)    ## Upper limit remains same, Lower limit is decreased
}

ggplot(nonpar_releffects, aes(Outcome_Measure, Frequency, fill = Group)) + 
  geom_bar(stat="identity", width = 0.7, position = position_dodge(width = .7))+
  labs(x='TOP Components', y='Probability', color='Variable')+
  scale_y_continuous(breaks=seq(-.2,.2, by=.05),limits=c(-.2,.2),labels=paste0(seq(.3,.7, by=.05)))+  
  sjPlot::theme_sjplot2() + 
  scale_fill_grey()+
  theme(
    panel.grid.minor = element_blank(), 
    panel.grid.major = element_blank(),
    panel.grid.major.x = element_blank(),
    panel.background = element_blank(),
    axis.text.y = element_text(size=10),
    plot.caption = element_text(face= "italic",hjust = 0),
    legend.position="bottom",
    legend.direction = "horizontal",
    line = element_blank())+
  coord_flip()

no_mostrar=1
if(no_mostrar==0){
  #mutate_at(vars(-rn),~scales::percent(.))%>%
  knitr::kable(.,format = "html", format.args = list(decimal.mark = ".", big.mark = ","),
               caption="Table 5. Non-parametric treatment effects for each variable",
                 align =rep('c', 101),
               col.names=c("Levels of Biopsychosocial Compromise","Std.Avg.Dose", "Std.Avg.Drug.Cons.", "Std.Avg.Health", "Std.Avg.Work  & Education", "Robbery","Theft", "Drug-Selling","Fights", "Other Transgressions", "Stable Place to Live", "Basic Housing Cond.", "Dom. Violence"))%>%
   kableExtra::kable_styling(bootstrap_options = c("striped", "hover"),font_size = 8)%>%
    kableExtra::scroll_box(width = "100%", height = "225px")
}
```

<br>

The can see that in average, there was a greater probability that the group of users with a severe biopsychosocial compromise  shows a greater percentage of each component of Treatment Outcomes Profile than a randomly chosen group, excepting those components related to health & social functioning.

<br>

```{r nonpar_vegan1, dpi = 96, message=F,echo=T, error=F, warning=F}
CONS_C1_df_dup_JUL_2020_match_top_sel2<-
  CONS_C1_df_dup_JUL_2020_match_top_sel%>%
      dplyr::mutate_at(vars(hurto, robo,  venta_drogas, rina,  otro, lugar_vivir, vivienda,vif), ~as.numeric(as.factor(as.numeric(.)-1)))
#https://www.rdocumentation.org/packages/vegan/versions/2.4-2/topics/adonis
#t looks like the jaccard distance is really only useful for binary data (presence/absence) while The bray-curtis matrix has been found to be robust for many abundance type data sets, especially those with many paired zeros like stomach content data can have.

#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_
#v To test for differences in dispersion between groups (permutational multivariate analysis of dispersion [PERMDISP] was significant), we used the betadisper function in vegan

sys_time1<-Sys.time()
#As our data are basically abundance-based data, we have to calculate Bray-Curtis 
vegdist<-vegan::vegdist(CONS_C1_df_dup_JUL_2020_match_top_sel2[,c("dosis_mean_z", "total_mean_z", "salud_mean_z","total_trabajo_edu_z", "hurto", "robo", "venta_drogas", "rina", "otro", "lugar_vivir", "vivienda", "vif"),drop = FALSE],na.rm=T,method="bray")
vegdist2<-vegan::vegdist(CONS_C1_df_dup_JUL_2020_match_top_sel2[,c("dosis_mean_z", "total_mean_z", "salud_mean_z","total_trabajo_edu_z", "hurto", "robo", "venta_drogas", "rina", "otro", "lugar_vivir", "vivienda", "vif"),drop = FALSE],na.rm=T,method="gower")
#Gower, Bray--Curtis, Jaccard and Kulczynski indices are good in detecting underlying ecological gradients
sys_time2<-Sys.time()
mod <- vegan::betadisper(vegdist, CONS_C1_df_dup_JUL_2020_match_top_sel2$compromiso_biopsicosocial)
sys_time3<-Sys.time()
#Time difference of 10.07783 mins
mod2 <- vegan::betadisper(vegdist2, CONS_C1_df_dup_JUL_2020_match_top_sel2$compromiso_biopsicosocial)
sys_time4<-Sys.time()
#print(difftime(sys_time2, sys_time1, units = "mins"))
#Time difference of 9.490239 mins
#plot(TukeyHSD(mod2))
#plot(mod2)

#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_
#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_

# Test of significance of the canonical relationship:
# 6.3. Canonical correspondence analysis (CCA)
# Beware: there are cca functions in other R packages, in particular in ade4.
#http://jinliang.weebly.com/uploads/2/5/7/8/25781074/analysis_of_community_ecology_data_in_r.pdf
#
#Statistical testing of microbial beta diversity between treatments was conducted in R using the vegan R package ADONIS function with the default 999 permutations. The betadisper function from the vegan R package was used to analyze variance between groups. Differential abundance analysis of the OTUs in microcosms of different treatments was performed using the DESeq2 R package. The DESeq2 generated the log fold change values, normalized relative abundances (“basemean”), and p-values from the Wald test with local fitting.
#ADONIS results indicate the effect of each factor, substrate, concentration and timepoint, on
#microbial community dissimilarity
sys_time5<-Sys.time()

vegan_1<- 
  vegan::adonis(CONS_C1_df_dup_JUL_2020_match_top_sel2[,c("dosis_mean_z", "total_mean_z", "salud_mean_z","total_trabajo_edu_z", "hurto", "robo", "venta_drogas", "rina", "otro", "lugar_vivir", "vivienda", "vif"),drop = FALSE] ~ compromiso_biopsicosocial, data=CONS_C1_df_dup_JUL_2020_match_top_sel2,permutations=9999, parallel = 4, na.rm=T)

sys_time6<-Sys.time()
#vegan_1b<- 
#vegan::adonis(dosis_mean_z + total_mean_z + salud_mean_z + total_trabajo_edu_z + hurto + robo + venta_drogas + rina + otro + #lugar_vivir + vivienda + vif~ compromiso_biopsicosocial, data=CONS_C1_df_dup_JUL_2020_match_top_sel2,permutations=2000, #parallel = 4, na.rm=T)

vegan_2<- 
    vegan::adonis(CONS_C1_df_dup_JUL_2020_match_top_sel2[,c("dosis_mean_z", "total_mean_z", "salud_mean_z","total_trabajo_edu_z", "hurto", "robo", "venta_drogas", "rina", "otro", "lugar_vivir", "vivienda", "vif"),drop = FALSE] ~ compromiso_biopsicosocial, data=CONS_C1_df_dup_JUL_2020_match_top_sel2,permutations=9999, parallel = 4, na.rm=T, method="gower")

sys_time7<-Sys.time()

diff67<-difftime(sys_time7, sys_time6, units = "mins")

#vegan_2b<- 
#vegan::adonis(dosis_mean_z + total_mean_z + salud_mean_z + total_trabajo_edu_z + hurto + robo + venta_drogas + rina + otro + #lugar_vivir + vivienda + vif~ compromiso_biopsicosocial, data=CONS_C1_df_dup_JUL_2020_match_top_sel2,permutations=2000, #parallel = 4, na.rm=T)
#https://trace.tennessee.edu/cgi/viewcontent.cgi?article=5817&context=utk_graddiss

#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_
#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_
    options(knitr.kable.NA = '')
sum_df_vegan<-data.frame(cbind(Model=paste0("vegan ",c("Raw (Bray)","Raw (Bray)","Raw (Bray)",rep("Raw (Gower)",3))),
          rbind(data.table::data.table(vegan_1$ aov.tab, keep.rownames=T),
                data.table::data.table(vegan_2$ aov.tab, keep.rownames=T))))%>%
            dplyr::rename("Parameter"="rn")%>%
  dplyr::mutate(`Pr..F.`=sprintf("%5.3f",`Pr..F.`),
                `SumsOfSqs`=sprintf("%8.3f",`SumsOfSqs`),
                `MeanSqs`=sprintf("%8.3f",`MeanSqs`),
                MeanSqs=ifelse(grepl("NA",MeanSqs),NA_character_,MeanSqs),
                `Pr..F.`=ifelse(grepl("NA",`Pr..F.`),NA_character_,`Pr..F.`)
                )

sum_df_vegan%>% 
  dplyr::mutate(R2=round(as.numeric(as.character(R2)),3))%>% 
  knitr::kable(.,format = "html", format.args = list(decimal.mark = ".", big.mark = ","),
               caption="Table 6. Analysis of Variance using bray-curtis and Gower distance matrix",
                 align =rep('c', 101),
               col.names=c("Model","Parameter", "Df","SS", "Mean Squares","Pseudo F","Eta-square", "p-value"))%>%
   kableExtra::kable_styling(bootstrap_options = c("striped", "hover"),font_size = 8) %>%
  kableExtra::add_footnote( c("Note. Model with average dose (z score), average frequency of use (z score), average reported health (z score), average days worked or attending an educational institution (z score), theft, burglary, drug selling, fights, other, place to live, housing condition and domestic violence."), notation = "none")%>%
  kableExtra::scroll_box(width = "100%", height = "375px")

get_adjusted_r2 <- function(adonis_object) {
  n_observations <- ncol(adonis_object$coef.sites)
  d_freedom <- adonis_object$aov.tab$Df[1]
  r2 <- adonis_object$aov.tab$R2[1]
  adjusted_r2 <- vegan::RsquareAdj(r2, n_observations, d_freedom)
}
#dg_cons_dep", "sin_otros_prob_sm","abandono_temp",,"dg_cie_10"
```

<br>

Despite both tests indicated significant differences between the levels of biopsychosocial compromise in scores of the TOP, the r-square let us interpret that these differences only explain the `r scales::percent(round(get_adjusted_r2(vegan_1),3))` of the variances of the scores, affecting the generalization of the results in terms of predictive power. The same model but comparing Gower distances, instead of the former Bray-Curtis distances, indicates that these differences only explain the `r scales::percent(round(get_adjusted_r2(vegan_2),3))`. This could mean that other factors also account for the relationship.

<br>

# Relationship with outcomes

```{r glmulti, dpi = 96, message=F,fig.align='center',echo=T, error=T, eval=T, fig.show = 'hide'}

library(glmulti)
#sin_otros_prob_sm+ dg_cons_dep
res <- glmulti(abandono_temp ~ compromiso_biopsicosocial + origen_ingreso_mod + dg_cie_10_rec + dg_trs_fisico, #tal vez  no debería meter esta última variable.
               data=CONS_C1_df_dup_JUL_2020_match_top_sel2%>%dplyr::mutate(compromiso_biopsicosocial=case_when(compromiso_biopsicosocial=="2-Moderado"~"Moderate",compromiso_biopsicosocial=="1-Leve"~"Mild",TRUE~"Severe")),
               level=2, #The level of interaction between explanatory variables to be considered. Currently only 1 (only main effects) or 2 (main effects plus all pairwise interactions) are supported.
               fitfunction=glm, crit="aicc", 
               family=binomial,
               marginality=T,#Whether to use the general marginality rule or not. Default is FALSE. With TRUE, all predictors found in interaction terms are also included as main effects.
               confsetsize = 1000 #How many models should be returned in the confidence set of models?
               )
#t is not iterative (all models are compared), and is fully automatic (no intervention of the user is required). It is primarily intended to be used for exploratory analyses with many candidate explanatory variables (say 10 to 20)
plot(res)
##########################################################################################
##################DEBIESE INCORPORAR EL TIPO DE PLAN!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
##########################################################################################

#http://www.metafor-project.org/doku.php/tips:model_selection_with_glmulti_and_mumin

#But let's take a look at the top 10 models:
top <- weightable(res) #Prepares a table with model formulas, IC values and IC relative supports
top <- top[top$aicc <= min(top$aicc) + 5,]

############################################################################################

###########################################################################################
plot.glmulti<-function(x, type="p", ...) 
{
  if ( type == "p") {
    plot(x@crits,xlab="Best models",
         ylab=paste("Support (",x@params$crit,")"),pch=19, main="IC profile", ...)
    abline(h=x@crits[1]+2,col="red")
        return(assign("ic_glmulti",data.table::data.table(data.frame(imp),keep.rownames = T),envir = .GlobalEnv))

  } else if (type == "w") {
    ww = exp(-(x@crits - x@crits[1])/2)
    ww=ww/sum(ww)
    plot(ww,xlab="Best models",
         ylab=paste("Evidence weight (",x@params$crit,")"),pch=19, main="Profile of model weights", ...)
    cucu=function(i) sum(ww[1:i])
    wwc=lapply(1:length(ww),cucu)
    abline(v=min(which(wwc>=0.95)),col="red")
  } else if (type=="r") {
    if (length(x@objects)) {
      # shows some diagnostics of the fit
      dev.new()
      par(mfrow=c(2,min(length(x@crits), 5)))
      for (k in 1:min(length(x@crits), 5)) 
        plot(x@objects[[k]],which=c(1), main=deparse(x@formulas[[k]]),...)
      for (k in 1:min(length(x@crits), 5)) 
        plot(x@objects[[k]],which=c(2),...)
    } else warning("Unavailable: use includeobjects=T when calling glmulti.")		
  } else if (type=="s") {
    # plots variable (i.e. terms) importances
    ww = exp(-(x@crits - x@crits[1])/2)
    ww=ww/sum(ww)
    # handle synonymies for interactions
    
    # this translates to unique notations (e.g. x:y and y:x are the same)
    clartou=function(x) {
      sort(strsplit(x, ":")[[1]])-> pieces
      if (length(pieces)>1) paste(pieces[1],":",pieces[2],sep="")
      else x
    }
    # list terms in models
    tet = lapply(x@formulas, function(x) sapply(attr(delete.response(terms(x)),"term.labels"), clartou))
    # all unique terms
    unique(unlist(tet))-> allt
    # importances
    sapply(allt, function(x) sum(ww[sapply(tet, function(t) x%in%t)]))-> imp
    # draw
    #par(oma=c(0,13,0,0))
    barplot(sort(imp),xlab="",xlim=c(0,1), ylab="",horiz=T,las=2, names.arg=allt[order(imp)],main="Model-averaged importance of terms", ...)
    abline(v=0.8, col="red")
    return(assign("var_imp_glmulti",data.table::data.table(data.frame(imp),keep.rownames = T),envir = .GlobalEnv))
  } else	warning("plot: Invalid type argument for plotting glmulti objects.")
}
plot(res, type="s")
############################################################################################
```

```{r fig8_glmulti_aicc, dpi = 96,fig.align='center',echo=T, message=F,fig.cap="Figure 8. Ordered Models and AICC", error=T, eval=T}
data.frame(res@crits)%>% dplyr::mutate(rn=row_number())%>%
    ggplot(aes(x=rn,y=res.crits))+
    geom_point(color="steelblue")+
   sjPlot::theme_sjplot2() + 
  ylab("Support (aicc)")+
  theme(axis.text.x = element_text(size=8,vjust = .5,angle=25), axis.text.y = element_text(size=10),
        axis.title.y = element_text(size = 14)) +
  theme(
    panel.grid.minor = element_blank(), 
    panel.grid.major = element_blank(),
    panel.grid.major.x = element_blank(),
    panel.background = element_blank(),
    line = element_blank(),
    plot.caption= element_text(hjust=0))+
  geom_hline(yintercept=res@crits[1]+2, color="red", linetype=2,size=1)+
  xlab("Best models")+
  labs(caption=paste0("Dashed red line= Minimum AICc plus 2 points (",round(res@crits[1]+2,2),")"))
```
<br>

We selected the model with lower AIC. The selected model showed the more parsimonius indices (AICc= `r round(res@objects[[1]]$aic,2)`, IC Rel. Support= `r as.numeric(round(glmulti::weightable(res)[,3],3))[1]`).

<br>

```{r fig9_glmulti_varimp, dpi = 96, message=F,fig.align='center',echo=T, fig.cap="Figure 9. Model-averaged variable importance of terms", error=T, eval=T}
#par(oma=c(0,0,0,24))
ggplot(var_imp_glmulti, aes(x=reorder(rn, -imp),y=imp))+
  geom_bar(stat="identity",alpha=.7, fill="steelblue")+
    sjPlot::theme_sjplot2() + 
  ylab("Model-averaged importance")+
  theme(axis.text.x = element_text(size=6.5,vjust = .5,angle=25), 
        axis.text.y = element_text(size=10),
        axis.title.y = element_text(size = 14),
        plot.caption= element_text(hjust=0)) +
  theme(
    panel.grid.minor = element_blank(), 
    panel.grid.major = element_blank(),
    panel.grid.major.x = element_blank(),
    panel.background = element_blank(),
    line = element_blank())+
  geom_hline(yintercept=.5, color="red", linetype=2)+
  xlab("Terms")+
  labs(caption="Note. Red dashed line= 50% of variable importance threshold")
```
<br>

The average importance of the term biopsychosocial compromise had the third major importance over the outcome variable (early drop-out) among the 1,000 models tested.

<br>

```{r glmulti2, dpi = 96, message=F, error=T, eval=T,echo=T, fig.show = 'hide'}
df_coef_glmulti<- data.frame()
for (i in 1:nrow(summary(res@objects[[1]])$coefficients)){
    df<-cbind(attr(summary(res@objects[[1]])$coefficients,"dimnames")[[1]][i],
            t(data.frame(exp(summary(res@objects[[1]])$coefficients[i,1] + 
          +     qnorm(c(0.025,.5,0.975)) * summary(res@objects[[1]])$coefficients[i,2]))))
    df_coef_glmulti<-rbind(df_coef_glmulti,df)
          }
df_coef_glmulti<-data.table::data.table(df_coef_glmulti)
 
options(knitr.kable.NA = '')
 
or_raw<-
data.table::data.table(Epi::ci.lin(
  glm(abandono_temp ~ compromiso_biopsicosocial,data=CONS_C1_df_dup_JUL_2020_match_top_sel2,family= "binomial"),Exp=T),keep.rownames = T)%>%
dplyr::select(-Estimate, -StdErr,-z)%>%
      dplyr::mutate(`exp(Est.)`=sprintf("%04.2f",as.numeric(`exp(Est.)`)))%>%
      dplyr::mutate(OR=`exp(Est.)`)%>%
      dplyr::mutate(OR=dplyr::case_when(P<.001~paste0(OR,"***"),P<.01~paste0(OR,"**"),P<.05~paste0(OR,"*"),TRUE~OR))%>%
      dplyr::mutate(`2.5%`= sprintf("%04.2f",as.numeric(`2.5%`)))%>%
      dplyr::mutate(`97.5%`=sprintf("%04.2f",as.numeric(`97.5%`)))%>%
      dplyr::mutate("95% IC"=paste0("[",`2.5%`,"-",`97.5%`,"]"))%>%
      dplyr::mutate("95% IC"= ifelse(grepl("NA]",`95% IC`),NA_character_,`95% IC`))%>%
    dplyr::select(rn,OR,`95% IC`)%>%
  dplyr::filter(!grepl("Intercept",rn))

or_1<-data.table(round(Epi::ci.lin(glm(abandono_temp ~ 1+compromiso_biopsicosocial+ origen_ingreso_mod +  dg_cie_10_rec + dg_trs_fisico,data=CONS_C1_df_dup_JUL_2020_match_top_sel2,family= "binomial"),Exp=T),3),keep.rownames = T)

#ResourceSelection::hoslem.test(res@objects[[1]]$y,res@objects[[1]]$fitted.values)  

data.table::data.table(Epi::ci.lin(res@objects[[1]],Exp=T),keep.rownames = T)%>%
dplyr::select(-Estimate, -StdErr,-z)%>%
  #dplyr::rename("OR"="exp(Est.)")%>%
  #exp(summary(m)$coefficients["DSH",1] + 
#+     qnorm(c(0.025,0.5,0.975)) * summary(m)$coefficients["DSH",2])
#[1]  1.472098  4.197368 11.967884
      dplyr::mutate(`exp(Est.)`=sprintf("%04.2f",as.numeric(`exp(Est.)`)))%>%
      dplyr::mutate(OR=`exp(Est.)`)%>%
      dplyr::mutate(OR=dplyr::case_when(P<.001~paste0(OR,"***"),P<.01~paste0(OR,"**"),P<.05~paste0(OR,"*"),TRUE~OR))%>%
      dplyr::mutate(`2.5%`= sprintf("%04.2f",as.numeric(`2.5%`)))%>%
      dplyr::mutate(`97.5%`=sprintf("%04.2f",as.numeric(`97.5%`)))%>%
      dplyr::mutate("95% IC"=paste0("[",`2.5%`,"-",`97.5%`,"]"))%>%
      dplyr::mutate("95% IC"= ifelse(grepl("NA]",`95% IC`),NA_character_,`95% IC`))%>%
      dplyr::mutate(Variable= 
                      dplyr::case_when(
                        grepl("origen_ingreso_modDerivación Asistida",rn)~"Motive of Admission to Treatment (First Entry) (0= Spontaneous)",
                        grepl("dg_cie_10_rec1$",rn)~"Psychiatric Condition (ICD-10) (0= No Disorder)",
                        grepl("dg_trs_fisico1$",rn)~"Physical Condition (ICD-10) (0= No Disorder)",
                        grepl("dg_cie_10_rec1",rn) & grepl("compromiso_biopsicosocialModerate",rn)~"Psychiatric Condition * Biopsychosocial Comp.",
                        rn=="compromiso_biopsicosocialModerate"~"Biopsychosocial Compromise (0= Mild)",
                        grepl("dg_cie_10_rec1",rn) & grepl("compromiso_biopsicosocialSevere",rn)~NA_character_))%>%
  dplyr::mutate(rn=dplyr::case_when(grepl("origen_ingreso_modDerivación Asistida",rn)~"Assisted Referral",
                                    grepl("origen_ingreso_modOtros",rn)~"Other",
                                    grepl("origen_ingreso_modSector Justicia",rn)~"Justice Sector",
                                    grepl("origen_ingreso_modSector Salud",rn)~"Health Sector",
                                    grepl("dg_cie_10_rec1$",rn)~"In Study or Psychiatric Disorder",
                                    grepl("dg_trs_fisico1$",rn)~"In Study or Physical Disorder",
                                    grepl("compromiso_biopsicosocialModerate",rn)~"Moderate",
                                    grepl("compromiso_biopsicosocialSevere",rn)~"Severe",
                                    rn=="dg_cie_10_rec1:compromiso_biopsicosocialModerate"~"Moderate",
                                    rn=="dg_cie_10_rec1:compromiso_biopsicosocialModerate"~"Severe",
                                    TRUE~rn
                                    ))%>%
  dplyr::select(Variable,rn,OR,`95% IC`)%>%
  dplyr::filter(!grepl("Intercept",rn))%>%
  knitr::kable(.,format = "html", format.args = list(decimal.mark = ".", big.mark = ","),
               caption="Table 7. Logistic Regression Coefficients",
                 align =c("l","l",rep('c', 101)),
               col.names = c("Variable","Category","OR", "95% IC"))%>%
   kableExtra::kable_styling(bootstrap_options = c("striped", "hover"),font_size = 8)%>%
  kableExtra::add_footnote( c(paste("Note. AICc=",round(res@objects[[1]]$aic,3)),
                              paste("Defined model=",top$model[1])), notation = "none")%>%
  kableExtra::scroll_box(width = "100%", height = "375px")

#mod <- res@objects[[1]]
#nullmod <- glm(abandono_temp ~ 1,data=CONS_C1_df_dup_JUL_2020_match_top_sel2,family= "binomial")
#1-logLik(mod)/logLik(nullmod)
#https://thestatsgeek.com/2014/02/08/r-squared-in-logistic-regression/

#round(Epi::ci.lin(glm(abandono_temp ~ 1+compromiso_biopsicosocial+ origen_ingreso_mod +  dg_cie_10_rec + dg_trs_fisico,data=CONS_C1_df_dup_JUL_2020_match_top_sel2,family= "binomial"),Exp=T),3)

#abandono_temp ~ 1 + compromiso_biopsicosocial + origen_ingreso_mod + dg_cie_10 + dg_trs_fisico + dg_trs_fisico:compromiso_biopsicosocial
#print(res@formulas[[2]])
```

<br>

Must take note that the model was around the `r scales::percent(with(summary(res@objects[[1]]), 1 - deviance/null.deviance))`  (McFadden R-squared) of the deviance from the null (or the worst model), same as the ,  junto a intercept-only model. This would mean that the inclusion of covariates had contributed with a small amount of predictive information about the outcome. The next figures show the marginal effects of the interaction terms among the variables.

<br>

```{r glmulti_fit, dpi = 96, message=F, error=T, eval=T,echo=T, fig.show = 'hide'}
invisible(c("https://www.r-bloggers.com/logistic-regression-in-r-using-blorr-package-2/"))
invisible(c("https://towardsdatascience.com/how-to-determine-the-best-model-6b9c584d0db4"))

#GOF
blorr::blr_model_fit_stats(res@objects[[1]])

#Not significant, good
blorr::blr_test_hosmer_lemeshow(res@objects[[1]])

#A lift chart graphically represents the improvement that a mining model provides when compared against a random guess. which suggests that the model is doing better than random chance to predict churn.
res@objects[[1]] %>%
    blr_gains_table() %>%
    plot()

#
#The Lorenz curve is a simple graphic device which illustrates the degree of inequality in the distribution of thevariable concerned. It is a visual representation of inequality used to measure the discriminatory power of the predictive model.
#blr_lorenz_curve(res@objects[[1]])
```


```{r fig10_int2,eval=T, echo=T, fig.align='center', paged.print=TRUE,fig.cap= "Figure 11. Interactive Effects in the Prob. of Early Drop-out with Diagnose of Physical Diagnosis", eval=F}
library(lsmeans)
refR_1 <- lsmeans(res@objects[[1]], specs = c("compromiso_biopsicosocial","dg_trs_fisico"))
ref_dfR_1 <- as.data.frame(cbind(summary(refR_1)[1:2],exp(summary(refR_1)[,c(3,6,7)])))

g4R_1 <- ggplot(ref_dfR_1, aes(x=compromiso_biopsicosocial, y=lsmean,group=dg_trs_fisico, colour=dg_trs_fisico))+
geom_errorbar(aes(ymin=asymp.LCL, ymax=asymp.UCL), width=.1,position=position_dodge(0.1), size=1) +
geom_line(position=position_dodge(0.1), size=.5)+
geom_point(position=position_dodge(0.1), size=2)+
  xlab("Biopsychosocial Compromise")+
  ylab("Odds Ratio (OR) of Early Drop-out")+
  sjPlot::theme_sjplot2() +
  geom_rect_interactive(alpha = 0.1, xmin=.1, xmax=.1, ymin=.1,ymax=.1) +
    # Remove plot elements added by geom_rect_interactive
  theme(legend.position="bottom")+
  guides(color=guide_legend(ncol=4))+
  labs(color="Cause of Discharge")+
  scale_colour_brewer(name="Cumulative Percentage", palette = "Set1",labels=c("No Dg.", "In study or Dg."))+
  theme(legend.title = element_blank())
  #theme(axis.text = element_blank(), axis.ticks = element_blank())

ggiraph(code = print(g4R_1))
```

```{r fig10_int1,eval=T, echo=T, paged.print=TRUE,fig.align='center', fig.cap= "Figure 10. Interactive Effects in the Prob. of Early Drop-out with Diagnose of Psychiatric Diagnosis", eval=T}
library(lsmeans)
refR_2 <- lsmeans(res@objects[[1]], specs = c("compromiso_biopsicosocial","dg_cie_10_rec"))
ref_dfR_2 <- as.data.frame(cbind(summary(refR_2)[1:2],exp(summary(refR_2)[,c(3,6,7)])))

g4R_2 <- ggplot(ref_dfR_2, aes(x=compromiso_biopsicosocial, y=lsmean,group=dg_cie_10_rec, colour=dg_cie_10_rec))+
geom_errorbar(aes(ymin=asymp.LCL, ymax=asymp.UCL), width=.1,position=position_dodge(0.1), size=1) +
geom_line(position=position_dodge(0.1), size=.5)+
geom_point(position=position_dodge(0.1), size=2)+
  xlab("Psychiatric Condition")+
  ylab("Odds Ratio (OR) of Early Drop-out")+
  sjPlot::theme_sjplot2() +
  geom_rect_interactive(alpha = 0.1, xmin=.1, xmax=.1, ymin=.1,ymax=.1) +
    # Remove plot elements added by geom_rect_interactive
  theme(legend.position="bottom")+
  guides(color=guide_legend(ncol=4,name = "Cause of Discharge"))+
  labs(color="Motive of Admission to Treatment")+
  scale_colour_brewer(palette = "Set1",labels=c("No Dg.", "In study or Dg."))+#,labels=c("No Dg.", "In study", "Dg."))+
  theme(legend.title = element_blank())
  #theme(axis.text = element_blank(), axis.ticks = element_blank())

ggiraph(code = print(g4R_2))
```


```{r fig11_KS_ ,eval=T, echo=T, paged.print=TRUE,fig.align='center', fig.cap= "Figure 11. Kolmogorov-Smirnov of cum. density functions, between Cum % of responder in groups vs. Cum % of non-responder", eval=T}

#KS Statistic or Kolmogorov-Smirnov statistic is the maximum difference between the cumulative true positive and cumulative false positive rate. It is often used as the deciding metric to judge the efficacy of models in credit scoring. The higher the ks_stat, the more efficient is the model at capturing the responders (Ones). This should not be confused with the ks.test function.
#Kolmogorov-Smirnov (KS) statistics is one of the commonly used measures to assess predictive power for marketing or credit risk models.

#Yes, this is the correct way to use the KS statistic to evaluate the performance of a model. As the true positive and false positive rates are already cumulative density functions over the range 0:1, they reasonably can fit into the paradigm of the more general use of the K-S statistic as it applies to comparison of these types of functions.
#Hay gente que dice que más o igual al 30% está 
#KS statistic = max over (i = 1 to n) {Cumulative % of responder in groups (1 to i) — Cumulative % of non-responder in groups(1 to i) }

res@objects[[1]] %>%
    blr_gains_table() %>%
    blr_ks_chart()
```

```{r glmulti_fit2, dpi = 96, message=F, error=T, eval=F,echo=T, fig.show = 'hide'}

#https://rpubs.com/riazakhan94/ksroclift
mdata=ifelse(CONS_C1_df_dup_JUL_2020_match_top_sel2$abandono_temp=="1", 1, 0)

get_Error_Rate=function(trues, predicted_prb, cutoff){
  preds=ifelse(predicted_prb<cutoff,0,1)
  tab=table(preds, trues)
  round((tab[1,2]+tab[2,1])/sum(tab), 4)
}

get_Error_Rate(mdata,res@objects[[1]]$fitted.values, 0.3)
err_rate<-data.frame()
for (x in seq(0, 1,.01)) {
  data.frame(get_Error_Rate(mdata,res@objects[[1]]$fitted.values, x))
  err_rate<-rbind(err_rate,data.frame(get_Error_Rate(mdata,res@objects[[1]]$fitted.values, x)))
}

createConfusionMatrix=function(actual, preds, cutoff_value){
  predClass=ifelse(preds<cutoff_value, 0, 1)
  message("Cutoff is : ", cutoff_value)
  table(actual,predClass)
}
## Confusion matrix for cutoff=0.5
createConfusionMatrix(mdata,res@objects[[1]]$fitted.values, 0.5)

confusionmat<-data.frame()
for (x in seq(0, 1,.01)) {
  data.frame(createConfusionMatrix(mdata,res@objects[[1]]$fitted.values, x))
  confusionmat<-rbind(confusionmat,data.frame(createConfusionMatrix(mdata,res@objects[[1]]$fitted.values, x)))
  }
```

```{r}
save.image("G:/Mi unidad/Alvacast/SISTRAT 2019 (github)/biopsychosoc_comp.RData")
sessionInfo()
```

# References

