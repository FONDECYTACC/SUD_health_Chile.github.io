---
title: "Chilean prosecutor's office Data merge"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  html_document:
    code_folding: hide  
    toc: true # table of content true
    toc_depth: 5  # upto three depths of headings (specified by #, ## and ###)
    toc_float: true
    theme: flatly
---

```{css zoom-lib-src, echo = FALSE}
script src = "https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"
```

```{js zoom-jquery, echo = FALSE}
 $(document).ready(function() {
    $('body').prepend('<div class=\"zoomDiv\"><img src=\"\" class=\"zoomImg\"></div>');
    // onClick function for all plots (img's)
    $('img:not(.zoomImg)').click(function() {
      $('.zoomImg').attr('src', $(this).attr('src')).css({width: '100%'});
      $('.zoomDiv').css({opacity: '1', width: 'auto', border: '1px solid white', borderRadius: '5px', position: 'fixed', top: '50%', left: '50%', marginRight: '-50%', transform: 'translate(-50%, -50%)', boxShadow: '0px 0px 50px #888888', zIndex: '50', overflow: 'auto', maxHeight: '100%'});
    });
    // onClick function for zoomImg
    $('img.zoomImg').click(function() {
      $('.zoomDiv').css({opacity: '0', width: '0%'}); 
    });
  });
```

```{=html}
<style type="text/css">
.tablelines table, .tablelines td, .tablelines th {
        border: 1px solid black;
        }
.centrado {
    text-align: center;
}
.table.center {
    margin-left:auto; 
    margin-right:auto;
  }
.table_wrapper{
    display: block;
    overflow-x: auto;
    white-space: nowrap;
}
code.r{
  font-size: 8px;
}
body{ /* Normal  */
      text-align: justify;
  }
.superbigimage{
    overflow-y:scroll;
    white-space: nowrap;
}
.superbigimage img{
    overflow-y: scroll;
    overflow-x: hidden;
}
</style>
```
```{=html}
<style>
div.blue { background-color:#e6f0ff; border-radius: 5px; padding: 20px; text-align: justify;}
</style>
```
```{r prev_setup, include = FALSE, cache=T}
rm(list=ls());gc()

path<-rstudioapi::getSourceEditorContext()$path

if (grepl("CISS Fondecyt",path)==T){
    setwd("C:/Users/CISS Fondecyt/Mi unidad/Alvacast/SISTRAT 2019 (github)/SUD_CL/");load("C:/Users/CISS Fondecyt/Mi unidad/Alvacast/SISTRAT 2019 (github)/9.Rdata")
  } else if (grepl("andre",path)==T){
    setwd('C:/Users/andre/Desktop/SUD_CL/');load("E:/Mi unidad/Alvacast/SISTRAT 2019 (github)/9.Rdata")
  } else if (grepl("E:",path)==T){
    setwd("E:/Mi unidad/Alvacast/SISTRAT 2019 (github)/SUD_CL/");load("E:/Mi unidad/Alvacast/SISTRAT 2019 (github)/9.Rdata")
  } else {
    setwd("G:/Mi unidad/Alvacast/SISTRAT 2019 (github)/SUD_CL/");load("G:/Mi unidad/Alvacast/SISTRAT 2019 (github)/9.Rdata")
  }
rm(list=setdiff(ls(), c("CONS_C1_df_dup_SEP_2020_match","CONS_C1_df_dup_SEP_2020","CONS_C1")))
```

```{r setup, include = FALSE, cache=T, error=T}
#Libraries used in the routine. Dont change the order
local({r <- getOption("repos")
       r["CRAN"] <- "http://cran.r-project.org" 
       options(repos=r)
})
copiar_nombres <- function(x,row.names=FALSE,col.names=TRUE,dec=",",...) {
  if(class(ungroup(x))[1]=="tbl_df"){
        if(options()$OutDec=="."){
            options(OutDec = dec)
            write.table(format(data.frame(x)),"clipboard",sep="\t",row.names=FALSE,col.names=col.names,...)
            options(OutDec = ".")
          return(x)
        } else {
            options(OutDec = ",")
            write.table(format(data.frame(x)),"clipboard",sep="\t",row.names=FALSE,col.names=col.names,...)
            options(OutDec = ",")
          return(x)    
        }
  } else {
        if(options()$OutDec=="."){
            options(OutDec = dec)
            write.table(format(x),"clipboard",sep="\t",row.names=FALSE,col.names=col.names,...)
            options(OutDec = ".")
          return(x)
        } else {
            options(OutDec = ",")
            write.table(format(x),"clipboard",sep="\t",row.names=FALSE,col.names=col.names,...)
            options(OutDec = ",")
          return(x)       
  }
 }
}  
#packageVersion("codebook")
#https://github.com/RevolutionAnalytics/checkpoint
#if(!require(checkpoint)){install.packages("checkpoint")}
#if(!require(here)){install.packages("here")}
#checkpoint::checkpoint("2020-02-19",project=here::here(),checkpointLocation=paste0(here::here(),"/dedup"), use.lock=F, use.knitr=T, auto.install.knitr = T,scan.rnw.with.knitr=T, forceInstall=T,scanForPackages = TRUE)
#checkpointArchives(tempdir(), full.names = TRUE)

#if(!require(tidyr)){install.packages("tidyr")}
#if(!require(DataExplorer)){install.packages("DataExplorer")}
#if(!require(stringi)){install.packages("stringi")}
#if(!require(stringr)){install.packages("stringr")}
#if(!require(ggplot2)){install.packages("ggplot2")}
#if(!require(Hmisc)){install.packages("Hmisc")}
#if(!require(kableExtra)){install.packages("kableExtra")}
#if(!require(plotly)){install.packages("plotly")}
#if(!require(rbokeh)){install.packages("rbokeh")}
#if(!require(altair)){install.packages("altair")}
#if(!require(zoo)){install.packages("zoo")}
#if(!require(codebook)){install.packages("codebook")}
#if(!require(broom)){install.packages("broom")}
#if(!require(sqldf)){install.packages("sqldf")} 
#if(!require(devtools)){install.packages("devtools")}
#if(!require(Statamarkdown)){install_github("hemken/Statamarkdown")}
#if(!require(data.table)){install.packages("data.table")}
#if(!require(dplyr)){install.packages("dplyr")}

#if(!require(boot)){install.packages("boot")}
#if(!require(plyr)){install.packages("plyr")}
#if(!require(matrixStats)){install.packages("matrixStats")}
#if(!require(radiant)){install.packages("radiant", repos = "https://radiant-rstats.github.io/minicran/")}

try(library(boot))
library(matrixStats)
library(knitr)
library(tidyr)
library(stringi)
library(stringr)
library(ggplot2)
library(Hmisc)
library(kableExtra)
library(plotly)
library(janitor)
library(rbokeh)
library(zoo)
library(broom)
library(sqldf)
library(devtools)
library(codebook)
library(data.table)
library(panelr)
library(RColorBrewer)
library(lsmeans)
library(finalfit)
suppressPackageStartupMessages(library(ggiraph))
suppressPackageStartupMessages(library(sf))
library(treemapify)
library(dplyr)
library(tidyverse)
library(epiR)
library(survminer)
library(ggfortify)
library(survMisc)

library(foreign)
library(Hmisc)
library(gridExtra)
library(reshape2)
library(stargazer)
library(tableone)
library(MatchIt)
library(cobalt)
library(eha)
library(igraph)
library(Amelia)
library(DiagrammeR) 
library(mstate)
library(flexsurv)
library(muhaz)
library(Metrics)
library(rpivotTable)
library(caret)
library(polycor)
library(ClusterR)
library(bnlearn)
options(scipen=999) #display numbers rather scientific number

#library(mstateutils)
#remotes::install_github("chjackson/flexsurv-dev", upgrade = "never")
#devtools::install_github("stulacy/multistateutils", build_vignettes=TRUE, upgrade = "never")
#devtools::install_github("hputter/mstate", upgrade = "never")
#unlink("C:/Users/CISS Fondecyt/OneDrive/Documentos/R/win-library/4.0/mstate", recursive=T, force=T)

if(!require(radiant.update)){install.packages("radiant.update", repos = "https://radiant-rstats.github.io/minicran/")}
#install.packages( repos = "https://radiant-rstats.github.io/minicran/")
#install.packages("radiant.update", repos = "https://radiant-rstats.github.io/minicran/")

#tryCatch(source("https://raw.githubusercontent.com/radiant-rstats/minicran/gh-pages/update.R"), error = function(e) print("updated package, radiant"))

#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:
#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:
#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:

try_with_time_limit <- function(expr, cpu = Inf, elapsed = Inf)
{
  y <- try({setTimeLimit(cpu, elapsed); expr}, silent = TRUE) 
  if(inherits(y, "try-error")) NULL else y 
}
eval_fork <- function(..., timeout=60){

  #this limit must always be higher than the timeout on the fork!
  setTimeLimit(timeout+5);      

  #dispatch based on method
  ##NOTE!!!!! Due to a bug in mcparallel, we cannot use silent=TRUE for now.
  myfork <- parallel::mcparallel({
    eval(...)
  }, silent=FALSE);

  #wait max n seconds for a result.
  myresult <- parallel::mccollect(myfork, wait=FALSE, timeout=timeout);

  #try to avoid bug/race condition where mccollect returns null without waiting full timeout.
  #see https://github.com/jeroenooms/opencpu/issues/131
  #waits for max another 2 seconds if proc looks dead 
  while(is.null(myresult) && totaltime < timeout && totaltime < 2) {
     Sys.sleep(.1)
     enddtime <- Sys.time();
     totaltime <- as.numeric(enddtime - starttime, units="secs")
     myresult <- parallel::mccollect(myfork, wait = FALSE, timeout = timeout);
  }

  #kill fork after collect has returned
  tools::pskill(myfork$pid, tools::SIGKILL);    
  tools::pskill(-1 * myfork$pid, tools::SIGKILL);  

  #clean up:
  parallel::mccollect(myfork, wait=FALSE);

  #timeout?
  if(is.null(myresult)){
    stop("R call did not return within ", timeout, " seconds. Terminating process.", call.=FALSE);      
  }

  #move this to distinguish between timeout and NULL returns
  myresult <- myresult[[1]];

  #reset timer
  setTimeLimit();     

  #forks don't throw errors themselves
  if(inherits(myresult,"try-error")){
    #stop(myresult, call.=FALSE);
    stop(attr(myresult, "condition"));
  }

  #send the buffered response
  return(myresult);  
}
#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:
#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:

#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:
#GET LOCAL
#dir.create(paste0(getwd(),"/renv_local"))
#Sys.setenv(RENV_PATHS_LOCAL = paste0(getwd(),"/renv_local"))
#install.packages(paste0(getwd(),"/renv_local/gurobi_9.1-0.zip"), repos = NULL, type="source")
#install.packages(paste0("G:/Mi unidad/Alvacast/SISTRAT 2019 (github)/renv_local/gurobi_9.1-0.zip"), repos = NULL, type="source")
#"G:/Mi unidad/Alvacast/SISTRAT 2019 (github)"
#Sys.getenv("R_LIBS_USER")

fitstats.flexsurvreg = function(x){
  ll = x$loglik
  aic = x$AIC
  k = length(x$coefficients)
  n = sum(x$data$m["(weights)"])
  aicc = aic + ((2 * k) * (k + 1) / (n - k - 1))
  bic = - 2 * ll + (k * log(n))
  data.frame(
   Df = k,
    "n2ll" = -2 * ll,
    AIC = aic,
    AICc = aicc,
    BIC = bic
  )
}


if(.Platform$OS.type == "windows") withAutoprint({
  memory.size()
  memory.size(TRUE)
  memory.limit()
})
memory.limit(size=56000)
```

<br>

# Obtain the database

<br>

<div style="border: 1px solid #ddd; padding: 5px; overflow-y: scroll; height:400px; overflow-x: scroll; width:100%">
```{r traer_base,dpi = 96, message=F, error=T,eval=T, warnings=F}
library(readxl)
base_fiscalia <- read_excel(gsub("/SUD_CL/Fiscalia_merge.Rmd","/BASE.xlsx",rstudioapi::getSourceEditorContext()$path), 
    sheet = "BASE", skip = 4, guess_max = min(1000000, 1000000)) %>% janitor::clean_names()
```
</div>

```{r tab1_descr_c1_baseline_vs_type_treatd,dpi = 96, message=F, error=T,eval=T, warnings=F}
library(compareGroups)


base_fiscalia<-
  base_fiscalia %>% 
  dplyr::mutate(gls_region=dplyr::case_when(gls_region=="REGION METROPOLITANA CENTRO NORTE"~ "RM Centro Norte",
                                            gls_region=="REGION METROPOLITANA OCCIDENTE"~ "RM Occidente",
                                            gls_region=="REGION METROPOLITANA ORIENTE"~ "RM Oriente",
                                            gls_region=="REGION METROPOLITANA SUR"~ "RM Sur",
                                            T~NA_character_)) %>% 
  dplyr::mutate(region_delito=dplyr::case_when(region_delito=="REGION METROPOLITANA CENTRO NORTE"~ "RM Centro Norte",
                                            region_delito=="REGION METROPOLITANA OCCIDENTE"~ "RM Occidente",
                                            region_delito=="REGION METROPOLITANA ORIENTE"~ "RM Oriente",
                                            region_delito=="REGION METROPOLITANA SUR"~ "RM Sur",
                                            T~NA_character_)) %>%   
   

no_mostrar=1
if(no_mostrar==0){
CONS_C1_df_dup_SEP_2020_match<-
  CONS_C1_df_dup_SEP_2020 %>% 
  dplyr::filter(dup==1) %>% #, tipo_de_plan_2 %in% c("PG-PR","M-PR","PG-PAI","M-PAI","PG-PAB","M-PAB")
  dplyr::mutate(tipo_de_plan_res=dplyr::case_when(grepl("PR",as.character(tipo_de_plan_2))~1,
                                                  grepl("PAI",as.character(tipo_de_plan_2))~0,
                                                  grepl("PAB",as.character(tipo_de_plan_2))~0,
                                                  TRUE~NA_real_)) %>% 
  dplyr::mutate(tipo_de_plan_res=factor(tipo_de_plan_res)) %>% 
  dplyr::mutate(abandono_temprano_rec=factor(if_else(as.character(motivodeegreso_mod_imp)=="Early Drop-out",TRUE,FALSE,NA))) %>% 
  dplyr::mutate(dg_trs_cons_sus_or=factor(if_else(as.character(dg_trs_cons_sus_or)=="Drug dependence",TRUE,FALSE,NA))) %>% 
  dplyr::mutate(tipo_centro_pub=factor(if_else(as.character(tipo_centro)=="Public",TRUE,FALSE,NA))) %>% 
  dplyr::mutate(condicion_ocupacional_corr=factor(condicion_ocupacional_corr),cat_ocupacional_corr=factor(cat_ocupacional_corr)) %>% 
  dplyr::mutate(dg_trs_fis_rec=factor(dplyr::case_when(as.character(diagnostico_trs_fisico)=="En estudio"~"Diagnosis unknown (under study)",as.character(diagnostico_trs_fisico)=="Sin trastorno"~'Without physical comorbidity',cnt_diagnostico_trs_fisico>0 ~'With physical comorbidity',
                                             TRUE~NA_character_)))%>%
    dplyr::mutate(escolaridad_rec=parse_factor(as.character(escolaridad_rec),levels=c('3-Completed primary school or less', '2-Completed high school or less', '1-More than high school'), ordered=T,trim_ws=T,include_na =F, locale=locale(encoding = "Latin1"))) %>%   
dplyr::mutate(freq_cons_sus_prin=parse_factor(as.character(freq_cons_sus_prin),levels=c('Did not use', 'Less than 1 day a week','2 to 3 days a week','4 to 6 days a week','1 day a week or more','Daily'), ordered =T,trim_ws=T,include_na =F, locale=locale(encoding = "UTF-8"))) %>% 
  dplyr::mutate(evaluacindelprocesoteraputico=dplyr::case_when(grepl("1",as.character(evaluacindelprocesoteraputico))~'1-High Achievement',grepl("2",as.character(evaluacindelprocesoteraputico))~'2-Medium Achievement',grepl("3",as.character(evaluacindelprocesoteraputico))~'3-Minimum Achievement', TRUE~as.character(evaluacindelprocesoteraputico))) %>% 
  dplyr::mutate(evaluacindelprocesoteraputico=parse_factor(as.character(evaluacindelprocesoteraputico),levels=c('1-High Achievement', '2-Medium Achievement','3-Minimum Achievement'), ordered =T,trim_ws=T,include_na =F, locale=locale(encoding = "UTF-8"))) %>% 
  dplyr::select_(.dots = match.on_tot) %>% 
  dplyr::mutate(more_one_treat=factor(ifelse(duplicates_filtered>1,1,0))) %>% 
  data.table::data.table()
}

invisible("Comentarios")

#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:
#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:
kableone <- function(x, caption=NULL, col.names=NA, smd=T, test=T, varLabels=T, noSpaces=T, printToggle=T, dropEqual=F, ...) {
  capture.output(x <- print(x, smd=T, test=test, varLabels=varLabels,noSpaces=noSpaces, printToggle=printToggle, dropEqual=dropEqual, ...))
  
  knitr::kable(x,format= "html", format.args= list(decimal.mark= ".", big.mark= ","),
               caption= caption, col.names= col.names)
}
as.data.frame.TableOne <- function(x, ...) {
    
    capture.output(print(x, showAllLevels = TRUE, smd=T, test=T, varLabels=T, ...) -> x)
    
    y <- as.data.frame(x)
    y$characteristic <- na_if(rownames(x), "")
    y <- y %>%
        #fill(characteristic, .direction = "down") %>%
        select(characteristic, everything())
    
    rownames(y) <- NULL
    y 
}

options(knitr.kable.NA = '')

#attr(CONS_C1_df_dup_SEP_2020_match$sus_ini_mod_mvv,"label")<-"Starting Substance"

## Vector of variables to summarize
myVars <-dput(names(dplyr::select(base_fiscalia, -c("rut_enc_saf","ruc","idrelacion","cod_delito","cod_lugarocurrencia","cod_parentescoimputado","cod_mottermino","cod_motsuspension","cod_proctermino","idsujeto_imputado","idsujeto_victima","impcod_tiposujeto","cod_lugarocurrencia","cod_sitiosuceso","cod_comunadelito","cod_region"))))

## Vector of categorical variables that need transformation
catVars <- c("encontrado_como_victima", "encontrado_como_imputado", "gls_tipo_sujeto_vic", "gls_region",
             "tipo_termino", "agrupa_terminos", "gls_materia","familia_delito","relacion_vifsaf","gls_parentesco","gls_mottermino","gls_motsuspension","gls_proctermino","gls_tipo_imputado","lugar_ocurrencia","gls_sitiosuceso","gls_comuna","region_delito","medidas_155","medidas_pp","medidas_ip","marca_suspension_43","marca_pena_44","marca_multa_45","medida_alternativa_46","clasificacion_pena_47","tramos_condena_48","clasificacion_penarpa_1_49","clasificacion_penarpa_2_50","marca_suspension_51","marca_pena_52","marca_multa_53","medida_alternativa_54","clasificacion_pena_55","tramos_condena_56","clasificacion_penarpa_1_57","clasificacion_penarpa_2_58")
## Create a TableOne object
tab1 <- CreateTableOne(vars = myVars, data = base_fiscalia[,myVars], factorVars = catVars, 
                       smd=T, includeNA=T,test=T)

kableone(as.data.frame.TableOne(tab1), size=11, first.strip=T, hide.no="no",
           format="html",caption= "Table 1. Summary descriptives",
         smd=T, test=T, varLabels=T,noSpaces=T, printToggle=T, dropEqual=F) %>% #,col.names=c("Variables","Residential", "Ambulatory", "p-value")) %>% 
    kableExtra::kable_styling(bootstrap_options = c("striped", "hover","condensed"),font_size= 10) %>%
  row_spec(1, bold=T, italic=T,color="black",hline_after=T,extra_latex_after="\\arrayrulecolor{white}",font_size= 11) %>%
  kableExtra::add_footnote(c("Note. Continuous variables are presented as Medians and Percentiles 25 and 75 were shown;", "Categorical variables are presented as number (%)"), notation = "none")%>%
  kableExtra::scroll_box(width = "100%", height = "375px")
```

```{r tab2_descr_c1_baseline_vs_type_treatd,dpi = 96, message=F, error=T,eval=T, warnings=F}
tab2 <- CreateTableOne(vars = myVars, data = base_fiscalia[,myVars], factorVars = catVars, 
                       smd=T, strata="encontrado_como_imputado", includeNA=T,test=T)

kableone(as.data.frame.TableOne(tab2), size=11, first.strip=T, hide.no="no",
           format="html",caption= "Table 2. Summary descriptives, by accused",
         smd=T, test=T, varLabels=T,noSpaces=T, printToggle=T, dropEqual=F) %>% #,col.names=c("Variables","Residential", "Ambulatory", "p-value")) %>% 
    kableExtra::kable_styling(bootstrap_options = c("striped", "hover","condensed"),font_size= 10) %>%
  row_spec(1, bold=T, italic=T,color="black",hline_after=T,extra_latex_after="\\arrayrulecolor{white}",font_size= 11) %>%
  kableExtra::add_footnote(c("Note. Continuous variables are presented as Medians and Percentiles 25 and 75 were shown;", "Categorical variables are presented as number (%)"), notation = "none")%>%
  kableExtra::scroll_box(width = "100%", height = "375px")

```

<br>

```{r hetcor, echo=T, cache= T, paged.print=TRUE, eval=F, error=F, dpi=320, fig.align="center", fig.cap="Figure 2. Latent classes"}

mydata <- 
  base_fiscalia %>% 
  dplyr::mutate(accused=dplyr::case_when(encontrado_como_victima=="SI" & encontrado_como_imputado=="SI"~"IMPUTADO",
                                 encontrado_como_victima=="NO" & encontrado_como_imputado=="SI"~"IMPUTADO",
                                 T~"VICTIMA")) %>%
  dplyr::select(-c("rut_enc_saf","gls_region","gls_tipo_sujeto_vic","ruc","idrelacion","cod_delito","cod_lugarocurrencia","cod_parentescoimputado","cod_mottermino","cod_motsuspension","cod_proctermino","idsujeto_imputado","idsujeto_victima","impcod_tiposujeto","cod_lugarocurrencia","cod_sitiosuceso","cod_comunadelito","iddelito","cod_region")) %>% 
  dplyr::select(-c("encontrado_como_victima","encontrado_como_imputado","fec_comision", "termino_relacion", "fec_cbiorelacion", "gls_comuna", "lugar_ocurrencia")) %>% 
  dplyr::filter(accused=="IMPUTADO") %>% 
   # glimpse()
  dplyr::mutate(across(, ~ifelse(is.na(.),9999,as.numeric(factor(.)))))


f_df<-with(mydata, cbind(tipo_sujeto_vic, reg, tipo_termino, agrupa_terminos, 
gls_materia, familia_delito, relacion_vifsaf, gls_parentesco, 
gls_mottermino, gls_motsuspension, gls_proctermino, gls_tipo_imputado, 
gls_sitiosuceso, region_delito, medidas_155, medidas_pp, 
medidas_ip, marca_suspension_43, marca_pena_44, marca_multa_45, 
medida_alternativa_46, clasificacion_pena_47, tramos_condena_48, 
clasificacion_penarpa_1_49, clasificacion_penarpa_2_50, marca_suspension_51, 
marca_pena_52, marca_multa_53, medida_alternativa_54, clasificacion_pena_55, 
tramos_condena_56, clasificacion_penarpa_1_57, clasificacion_penarpa_2_58, 
accused)~1)
```

<br>


# Missingness

```{r miss, echo=T, cache= T, paged.print=TRUE, eval=T, error=T, dpi=320, fig.align="center"}
cols<-base_fiscalia %>%
    #dplyr::filter(resp_status=="partial") %>%  
    dplyr::select(p3_siente_1:p47_demo_medio_transp_09) %>% names() #si fuera desde SPSS, sería p47_demo_medio_transp_otr

tot<-
base_fiscalia %>%
  # dplyr::filter(resp_status=="partial") %>% 
  nrow()
#Ordenar variables
missing.values <- 
  base_fiscalia %>%
  #dplyr::filter(resp_status=="partial") %>%  
  #dplyr::select(p3_siente_1:p47_demo_medio_transp_09) %>% #si fuera desde SPSS, sería p47_demo_medio_transp_otr
    tidyr::gather(key = "key", value = "val") %>%
    dplyr::mutate(is.missing = is.na(val)) %>%
    #dplyr::left_join(cols_labels,by=c("key"="V1")) %>% 
    dplyr::group_by(key, is.missing) %>%
    dplyr::summarise(num.missing = n()) %>%
    dplyr::filter(is.missing==T) %>%
    dplyr::mutate(perc_miss=num.missing/tot) %>% 
    dplyr::select(-is.missing) %>% 
    dplyr::ungroup() %>% 
    dplyr::group_by(key) %>% 
    dplyr::slice(1) %>% 
    dplyr::ungroup()
    #dplyr::mutate(label=paste(stringi::stri_wrap(label, width=20),"<br>"))
    #arrange(desc(num.missing)) 

plot_miss<-
missing.values %>%
  dplyr::ungroup() %>% 
 # slice(1:29) %>% 
  ggplot() +
    geom_bar(aes(x=factor(key), y=perc_miss), stat = 'identity') +
    labs(x='variable', y="Porcentaje de perdidos", caption=paste0("Nota. Porcentaje de perdidos del total (",format(tot, big.mark=","),")")) +
  #theme(axis.text.x = element_text(angle = 45, hjust = 1, size=6))+
  theme(axis.text.x = element_blank())+
  scale_y_continuous(limits=c(0,1))+
  sjPlot::theme_sjplot()+
  coord_flip()


  ggplotly(plot_miss)%>% layout(xaxis= list(showticklabels = FALSE), height = 600, width=800)

``` 
  
<br>


# Near Zero Variance


Check variables that only one unique value (i.e. are zero variance) or predictors that have both of the following characteristics: few unique values given the sample size, and the frequency of the most common value is much more big than the second most common value.

```{r nearZeroVar, echo=T, cache= T, paged.print=TRUE, eval=T, error=T, dpi=320, fig.align="center"}
nzv_vals <- nearZeroVar(base_fiscalia, saveMetrics = TRUE)
nzv_sorted <- arrange(nzv_vals, desc(freqRatio))
head(nzv_sorted)


kable(as.data.frame.TableOne(nzv_sorted), size=11, format="html",
           caption= "Table 2. Near Zero Variance",
      col.names=c("Variable", "freqRatio", "% of Unique values", "Zero Variance", "Near Zero Variance")) %>% #,col.names=c("Variables","Residential", "Ambulatory", "p-value")) %>% 
    kableExtra::kable_styling(bootstrap_options = c("striped", "hover","condensed"),font_size= 10) %>%
  kableExtra::add_footnote(c("Note. freqRatio= ratio of frequencies for the most common value over the second most common value for that variable"), notation = "none")%>%
  kableExtra::scroll_box(width = "100%", height = "375px")
```
<br>

## Times as accused

- `r table(base_fiscalia$encontrado_como_victima,base_fiscalia$encontrado_como_imputado)[4]` people that is found as accused and as a victim at the same time. Meanwhile, we considered them as accused.


```{r fig1, echo=T, cache= T, paged.print=TRUE, warning=F, eval=T, fig.align="center", fig.cap="Figure 1. Distribution of records in which a user is declared as an accused", fig.height=6}
#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_
base_fiscalia_acc_imp<-
base_fiscalia %>% 
  dplyr::mutate(accused=dplyr::case_when(encontrado_como_victima=="SI" & encontrado_como_imputado=="SI"~"IMPUTADO",
                                 encontrado_como_victima=="NO" & encontrado_como_imputado=="SI"~"IMPUTADO",
                                 T~"VICTIMA")) %>% 
  dplyr::filter(accused=="IMPUTADO") %>% 
  dplyr::group_by(rut_enc_saf) %>% 
  dplyr::count() %>% 
  ungroup()
#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_

p<-
base_fiscalia_acc_imp %>% 
  dplyr::left_join(CONS_C1_df_dup_SEP_2020[,c("hash_key","dup")] %>% distinct(hash_key, .keep_all = T),by=c("rut_enc_saf"="hash_key")) %>% ggplot(aes(x=n), alpha=.7)+
  geom_histogram_interactive(bins=120)+
  geom_vline(aes(xintercept=median(base_fiscalia_acc_imp$n)), color="darkred", linetype="dashed")+
  geom_vline(aes(xintercept=quantile(base_fiscalia_acc_imp$n, .99)), color="darkmagenta", linetype="solid")+
  geom_vline(aes(xintercept=quantile(base_fiscalia_acc_imp$n, .95)), color="darkblue", linetype="dotted")+
  sjPlot::theme_sjplot2() +
  #facet_wrap(~motivodeegreso_mod_imp)+
labs(y = "Frequency",x="Diff. Between Treatments", caption= paste0("Blue dotted line=", quantile(base_fiscalia_acc_imp$n, .95)," records; Violet solid line=",quantile(base_fiscalia_acc_imp$n, .99)," records; Red dashed line= Median=",median(base_fiscalia_acc_imp$n)," records; Maximum=",max(base_fiscalia_acc_imp$n)," records"))
# xlim(c(-1,2000))

p
```


## Times as victim


```{r fig2, echo=T, cache= T, paged.print=TRUE, warning=F, eval=T, fig.align="center", fig.cap="Figure 2. Distribution of records in which a user is declared as a Victim", fig.height=6}
#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_
base_fiscalia_acc_vic<-
base_fiscalia %>% 
  dplyr::mutate(accused=dplyr::case_when(encontrado_como_victima=="SI" & encontrado_como_imputado=="SI"~"IMPUTADO",
                                 encontrado_como_victima=="NO" & encontrado_como_imputado=="SI"~"IMPUTADO",
                                 T~"VICTIMA")) %>% 
  dplyr::filter(accused=="VICTIMA") %>% 
  dplyr::group_by(rut_enc_saf) %>% 
  dplyr::count() %>% 
  ungroup()
#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_


p2<-
base_fiscalia_acc_vic %>% 
  dplyr::left_join(CONS_C1_df_dup_SEP_2020[,c("hash_key","dup")] %>% distinct(hash_key, .keep_all = T),by=c("rut_enc_saf"="hash_key")) %>% ggplot(aes(x=n), alpha=.7)+
  geom_histogram_interactive(bins=120)+
  geom_vline(aes(xintercept=median(base_fiscalia_acc_vic$n)), color="darkred", linetype="dashed")+
  geom_vline(aes(xintercept=quantile(base_fiscalia_acc_vic$n, .99)), color="darkmagenta", linetype="solid")+
  geom_vline(aes(xintercept=quantile(base_fiscalia_acc_vic$n, .95)), color="darkblue", linetype="dotted")+
  sjPlot::theme_sjplot2() +
  #facet_wrap(~motivodeegreso_mod_imp)+
labs(y = "Frequency",x="Diff. Between Treatments", caption= paste0("Blue dotted line=", quantile(base_fiscalia_acc_vic$n, .95)," records; Violet solid line=",quantile(base_fiscalia_acc_vic$n, .99)," records; Red dashed line= Median=",median(base_fiscalia_acc_vic$n)," records; Maximum=",max(base_fiscalia_acc_vic$n)," records"))
# xlim(c(-1,2000))

p2
```

```{r fig3, echo=T, cache= T, paged.print=TRUE, warning=F, eval=T, fig.align="center", fig.cap="Figure 3. Distribution of records in which a user is declared as an accused"}

base_fiscalia_acc_vic %>% 
    dplyr::left_join(CONS_C1_df_dup_SEP_2020[,c("hash_key","dup")] %>% distinct(hash_key, .keep_all = T),by=c("rut_enc_saf"="hash_key")) %>% distinct(rut_enc_saf)

paste0("Percentage of HASHs that have records as victims: ",
scales::percent(
base_fiscalia_acc_vic %>% 
    dplyr::left_join(CONS_C1_df_dup_SEP_2020[,c("hash_key","dup")] %>% distinct(hash_key, .keep_all = T),by=c("rut_enc_saf"="hash_key")) %>%  distinct(rut_enc_saf) %>% nrow()/CONS_C1_df_dup_SEP_2020[,c("hash_key","dup")] %>% distinct(hash_key, .keep_all = T) %>% nrow(),
accuracy=.01
  )
)

```

```{r fig4, echo=T, cache= T, paged.print=TRUE, warning=F, eval=T, fig.align="center", fig.cap="Figure 4. Distribution of records in which a user is declared as a victim"}

paste0("Percentage of HASHs that have records as accused: ",
scales::percent(
base_fiscalia_acc_vic %>% 
    dplyr::left_join(CONS_C1_df_dup_SEP_2020[,c("hash_key","dup")] %>% distinct(hash_key, .keep_all = T),by=c("rut_enc_saf"="hash_key")) %>%  distinct(rut_enc_saf) %>% nrow()/CONS_C1_df_dup_SEP_2020[,c("hash_key","dup")] %>% distinct(hash_key, .keep_all = T) %>% nrow(),
accuracy=.01
  )
)
```

<br>


<div style="border: 1px solid #ddd; padding: 5px; overflow-y: scroll; height:650px; overflow-x: scroll; width:100%">
```{r exporttable, warning=FALSE, eval=F}
#https://cran.r-project.org/web/packages/rpivotTable/vignettes/rpivotTableIntroduction.html
#
CONS_C1_df_dup_SEP_2020_dup<-
CONS_C1_df_dup_SEP_2020[,c("hash_key","dup")] %>% dplyr::group_by(hash_key) %>% slice_max(dup) %>% ungroup()

pt<-
rpivotTable(data = base_fiscalia %>% 
              dplyr::left_join(CONS_C1_df_dup_SEP_2020_dup, by=c("rut_enc_saf"="hash_key")) %>% 
  dplyr::mutate(accused=dplyr::case_when(encontrado_como_victima=="SI" & encontrado_como_imputado=="SI"~"IMPUTADO",
                                 encontrado_como_victima=="NO" & encontrado_como_imputado=="SI"~"IMPUTADO",
                                 T~"VICTIMA")), 
  rows="gls_parentesco",
  cols = c("accused"),
  vals = "Cuenta", 
  aggregatorName = "Cuenta",
  subtotals=T,
  locale="es",
  rendererName = "Table",
  width="100%", height="550px")

#htmlwidgets::saveWidget(pt, "test3.html")
```
</div>

<!---
File is available in this [link](https://github.com/FONDECYTACC/SUD_health_Chile.github.io/raw/master/test3.html).
--->


# Structure

```{r s1, echo=T, error=T, paged.print=TRUE, error=T, eval=F}
#hetcor_mat<-polycor::hetcor(base_fiscalia , ML = T, std.err = T, use="pairwise.complete.obs", bins=4, pd=TRUE)
 
```

The hypothetized structure would be HASHs (`rut_enc_saf`), RUCs (`ruc`), and relationships (`idrelacion`) as the combination of an specific accused (`idsujeto_imputado`) and victim (`idsujeto_victima`) in a determined court case. But an alternative would be the established in the reports, `idsujeto_imputado` and the type of crime/offence (`id_delito`), and each crime/offence should be terminated with an indictment or filed as discontinued or suspended.

<br>

```{r s2, echo=T, error=T, paged.print=TRUE, error=T}
#sería RUT/Hash → RUC → relaciones
#
#fec_cbiorelacion
#fec_comision  
#termino_relacion 

invisible("¿Hay algún patrón por año?, ver el recuento de id_victimas==0 por cada trimestre y sacar un gráfico de densidad de eso")
require(zoo)
require(ggrepel)

base_fiscalia %>% 
    dplyr::arrange(rut_enc_saf, ruc, idrelacion) %>% 
    dplyr::mutate(fech_ing_qrt=zoo::as.yearqtr(fec_comision)) %>%
    dplyr::mutate(idsujeto_victima_0=ifelse(idsujeto_victima==0,1,0)) %>% 
    dplyr::group_by(fech_ing_qrt) %>% #%>% janitor::tabyl(sus_ini)
    dplyr::summarise(n=n(),
                     sum_0 = length(n[idsujeto_victima_0==1]),
                     perc = sum_0/n) %>% 
    dplyr::ungroup() %>% 
    dplyr::filter(fech_ing_qrt>=2000) %>% 
    dplyr::arrange(desc(fech_ing_qrt)) %>% 
    ggplot2::ggplot(aes(x = fech_ing_qrt, y = perc, label = paste0("n=",n))) +
    geom_line(color = "#0076A8", size=1) +
    geom_text_repel(aes(x = fech_ing_qrt, y = perc, label = paste0("Rows=",n,"\nNN victims= ", sum_0)), vjust = -1,hjust = 0, angle=45, size=3, arrow = arrow(length = unit(0.01, 'npc'))) +
    sjPlot::theme_sjplot2() +
    labs(y="% of Missing Data of the Victim",x="Years & Quarters, Date of commission of the crime",caption="Note. Some crimes were commited before 1960 (n= 246), and in 1900 (n=241)") + 
    scale_y_continuous(limits=c(-1, 1),labels = scales::percent) +
    scale_x_yearqtr(format="%YQ%q", n=20) +
    theme(axis.text.x = element_text(vjust = 0.5,hjust = 0.5,angle = 60), plot.caption=element_text(hjust=0)) 

base_fiscalia %>% 
  dplyr::arrange(rut_enc_saf, ruc, idrelacion) %>% 
  dplyr::mutate(fech_ing_qrt=zoo::as.yearqtr(termino_relacion)) %>%
   dplyr::mutate(idsujeto_victima_0=ifelse(idsujeto_victima==0,1,0)) %>% 
    dplyr::group_by(fech_ing_qrt) %>% #%>% janitor::tabyl(sus_ini)
   dplyr::summarise(n=n(),
                  sum_0 = length(n[idsujeto_victima_0==1]),
                  perc = sum_0/n) %>% 
  dplyr::ungroup() %>% 
  dplyr::filter(fech_ing_qrt>=2000) %>% 
  dplyr::arrange(desc(fech_ing_qrt)) %>% 
  ggplot2::ggplot(aes(x = fech_ing_qrt, y = perc, label = paste0("n=",n))) +
  geom_line(color = "#0076A8", size=1) +
    geom_text_repel(aes(x = fech_ing_qrt, y = perc, label = paste0("Rows=",n,"\nNN victims= ", sum_0)), vjust = -1,hjust = 0, angle=45, size=3, arrow = arrow(length = unit(0.01, 'npc'))) +
  sjPlot::theme_sjplot2() +
  labs(y="% of Missing Data of the Victim",x="Years & Quarters, Date of termination of the relationship") + 
  scale_y_continuous(limits=c(-1, 1),labels = scales::percent) +
  scale_x_yearqtr(format="%YQ%q", n=40) +
  theme(axis.text.x = element_text(vjust = 0.5,hjust = 0.5,angle = 60), plot.caption=element_text(hjust=0)) 

```

```{r s25, echo=T, error=T, paged.print=TRUE, error=T}


invisible("¿Puede que el RUC se repita para un mismo HASH?, ¿en qué situaciones?")
base_fiscalia %>%
  dplyr::mutate(combinacion=paste0(ruc,"_",rut_enc_saf)) %>%
  dplyr::filter(combinacion %in% as.character(unlist(agrupacion_base %>% 
  dplyr::filter(max>1) %>%dplyr::mutate(combinacion=paste0(ruc,"_",rut_enc_saf)) %>% dplyr::select(combinacion)))) %>% View()


base_fiscalia %>%
  dplyr::filter(encontrado_como_victima=="SI" & encontrado_como_imputado=="SI")

invisible("¿Hay diferencias en la fecha biorelacion y la de término de relación")
base_fiscalia %>% 
    dplyr::filter(termino_relacion!=fec_cbiorelacion) %>% 
    dplyr::mutate(diff_en_dias=as.numeric((termino_relacion-fec_cbiorelacion)/(60*24))) %>% 
    select(diff_en_dias) %>% 
    summarise(n=n(),min=min(diff_en_dias), max=max(diff_en_dias), mean=mean(diff_en_dias), median=median(diff_en_dias), p025=quantile(diff_en_dias, .025), p25=quantile(diff_en_dias, .25), p75=quantile(diff_en_dias,.75), p975=quantile(diff_en_dias, .975)) %>% copiar_nombres()


invisible("Casos en que hay filas en que un rut es imputado y víctima")
base_fiscalia %>%
    dplyr::filter(encontrado_como_victima=="SI" & encontrado_como_imputado=="SI") %>% 
    summarise(n=n_distinct(rut_enc_saf), n2=n_distinct(ruc))

invisible("Casos en que una persona comete un delito con distinta causa en la misma fecha")
base_fiscalia %>%
    dplyr::mutate(comb=paste0(rut_enc_saf,"_",fec_comision)) %>% 
                    dplyr::add_count(comb, .keep=T) %>% filter(n > 1) %>% 
    dplyr::group_by(comb) %>% 
                      dplyr::summarise(n=n_distinct(ruc)) %>% 
    dplyr::filter(n>1)

# Ejemplo de un caso

# 0007678b8b35fa0961d1e8110fbf9620	SI	NO	6	VICTIMA	47350754	5	V Región de Valparaíso	16913947	1400066420-1	SALIDA NO JUDICIAL	DECISI¿N DE NO PERSEVERAR	525	AMENAZAS CONDIC. CONTRA PERSONAS Y PROP. ART. 296 1 y 2, 297	DELITOS CONTRA LA LIBERTAD E INTIMIDAD DE LAS PERSONAS	SI	16	CONVIVIENTE	5	Decisión de no perseverar en el proced	0	NA	1	ORDINARIO	47350753	3	IMPUTADO	12909542	18-01-2014 19:40	16-04-2014	2	LUGAR HABITADO O DESTINADO A LA HABITACION Y SUS DEPENDENCIAS	1	VIVIENDA	310	VALPARAISO	5	V Región de Valparaíso	16-04-2014	NA	NA	NA	NA	NA	NA	NA	NA	NA	NA	NA	NA	NA	NA	NA	NA	NA	NA	NA

# 0007678b8b35fa0961d1e8110fbf9620	SI	NO	6	VICTIMA	47359056	5	V Región de Valparaíso	16916932	1400068650-7	SALIDA NO JUDICIAL	ARCHIVO PROVISIONAL	524	AMENAZAS SIMPLES CONTRA PERSONAS Y PROPIEDADES ART. 296 Nº3.	DELITOS CONTRA LA LIBERTAD E INTIMIDAD DE LAS PERSONAS	SI	16	CONVIVIENTE	1	Archivo Provisional	0	NA	0	SIN PROCEDIMIENTO	47359057	3	IMPUTADO	12911972	18-01-2014 19:40	27-01-2014	2	LUGAR HABITADO O DESTINADO A LA HABITACION Y SUS DEPENDENCIAS	1	VIVIENDA	310	VALPARAISO	5	V Región de Valparaíso	27-01-2014	NA	NA	NA	NA	NA	NA	NA	NA	NA	NA	NA	NA	NA	NA	NA	NA	NA	NA	NA

invisible("Gente que tendría distinto id de relación para una misma combianción de id víctima e id imputado")
base_fiscalia %>%
    dplyr::mutate(comb=paste0(idsujeto_victima,"_",idsujeto_imputado)) %>% 
    dplyr::add_count(comb, .keep=T) %>% filter(n > 1) %>% 
    dplyr::group_by(comb) %>% 
    dplyr::summarise(n=n_distinct(idrelacion)) %>% 
    dplyr::filter(!grepl("^0_", comb)) %>% 
    dplyr::filter(n>1) %>%  nrow()

base_fiscalia %>%
    dplyr::mutate(comb=paste0(idsujeto_victima,"_",idsujeto_imputado)) %>% 
    arrange(rut_enc_saf,fec_comision,ruc,idrelacion) %>% 
    dplyr::filter(comb=="10760610_10760611") %>% View()

invisible("Ver si hay alguien que comete el delito antes de terminarse la relación")
invisible("¿Puede producirse que alguno cometa el delito después de terminada la relación?, investigar tales errores")
#fec_cbiorelacion
#fec_comision  
#termino_relacion 

base_fiscalia %>%
  dplyr::mutate(fec_comision_simple=as.Date(stringr::str_extract(as.character(fec_comision), "^.{10}"))) %>% 
  dplyr::mutate(termino_relacion_simple=as.Date(stringr::str_extract(as.character(termino_relacion), "^.{10}"))) %>%
  dplyr::mutate(diff_en_dias=as.numeric((termino_relacion_simple-fec_comision_simple))) %>% 
  dplyr::filter(diff_en_dias<0)
  # dplyr::select(rut_enc_saf,ruc, fec_comision, termino_relacion, diff_en_dias) %>%  
  #     select(diff_en_dias) %>% 
  #     summarise(n=n(),min=min(diff_en_dias), max=max(diff_en_dias), mean=mean(diff_en_dias), median=median(diff_en_dias), p025=quantile(diff_en_dias, .025), p25=quantile(diff_en_dias, .25), p75=quantile(diff_en_dias,.75), p975=quantile(diff_en_dias, .975)) %>% copiar_nombres()

invisible("Ver si hay más de un código delito por materia y viceversa")
base_fiscalia %>%
    dplyr::group_by(cod_delito) %>% 
    summarise(n=n_distinct(gls_materia)) %>% 
    dplyr::filter(n>1)
base_fiscalia %>%
    dplyr::group_by(gls_materia) %>% 
    summarise(n=n_distinct(cod_delito)) %>% 
    dplyr::filter(n>1)

invisible("Puede ser que en algunos casos específicos, para un mismo RUC participen 2 o más RUT?")
base_fiscalia %>%
    dplyr::group_by(ruc) %>% 
    summarise(n=n_distinct(rut_enc_saf)) %>% 
    dplyr::filter(n>1)


```

```{r s3, echo=T, error=T, paged.print=TRUE}
#base_fiscalia %>%  dplyr::select(encontrado_como_victima:clasificacion_pena_47) %>% glimpse()
#idsujeto_imputado
#iddelito 
#idrelacion
#ruc
#idsujeto_victima
#gls_tipo_sujeto_vic


cat("ID sujeto víctima")
base_fiscalia %>%
    group_by(idsujeto_victima) %>% 
    summarise(n=n()) %>% 
    summarise(min=min(n), max=max(n), mean=mean(n), median=median(n), p025=quantile(n, .025), p25=quantile(n, .25), p75=quantile(n,.75), p975=quantile(n, .975))
#podría agrupar al resto. De hecho, hay un ID que agrupa a 18,045 filas

#Exploro ese caso aislado. ¿Hay más de una relación por cada uno?

    base_fiscalia %>%
    dplyr::filter(ruc %in% as.character(unlist(base_fiscalia %>%
        dplyr::filter(idsujeto_victima==0) %>%
        dplyr::select(ruc)))) %>% 
      dplyr::group_by(idrelacion) %>% 
      summarise(n=n()) %>% 
    summarise(min=min(n), max=max(n), mean=mean(n), median=median(n), p025=quantile(n, .025), p25=quantile(n, .25), p75=quantile(n,.75), p975=quantile(n, .975))



cat("ID sujeto imputado")
base_fiscalia %>%
    group_by(idsujeto_imputado) %>% 
    summarise(n=n()) %>% 
    summarise(min=min(n), max=max(n), mean=mean(n), median=median(n), p025=quantile(n, .025), p25=quantile(n, .25), p75=quantile(n,.75), p975=quantile(n, .975))
#agrupa al resto, me da la impresión, tiene hasta 129 filas con el mismo id sujeto imputado

cat("RUC")
base_fiscalia %>%
    group_by(ruc) %>% 
    summarise(n=n()) %>% 
    summarise(min=min(n), max=max(n), mean=mean(n), median=median(n), p025=quantile(n, .025), p25=quantile(n, .25), p75=quantile(n,.75), p975=quantile(n, .975))

 # 1 0810024146-4   129
 # 2 0901135475-8   106
 # 3 1000499758-7    56
 # 4 1000241245-K    49

#El ruc no es específico, tiene hasta 129 filas. Ver si tienen relación con los ID's sjeto imputado o víctima

#Exploremos algunos:
  base_fiscalia %>%
    dplyr::filter(ruc %in% c("0810024146-4","0901135475-8")) %>% View()

cat("ID sujeto imputado, RUC")
# base_fiscalia %>%
#     group_by(ruc,idsujeto_imputado) %>% 
#     summarise(n=n()) %>% 
#     summarise(min=min(n), max=max(n), mean=mean(n), median=median(n), p025=quantile(n, .025), p25=quantile(n, .25), p75=quantile(n,.75), p975=quantile(n, .975))
# No correr, entrega 494,929 casos

cat("ID sujeto víctima, RUC")
# base_fiscalia %>%
#     group_by(idsujeto_victima,ruc) %>% 
#     summarise(n=n()) %>% 
#     summarise(min=min(n), max=max(n), mean=mean(n), median=median(n), p025=quantile(n, .025), p25=quantile(n, .25), p75=quantile(n,.75), p975=quantile(n, .975))
#no correr. son 514,344 casos
#si pongo al revés, con el RUC primero, 
      # Error: Problem with `summarise()` column `p75`.
      # i `p75 = quantile(n, 0.75)`.
      # x argument is not interpretable as logical
      # i The error occurred in group 40782: ruc = "1000495180-3".
      # Backtrace:
      #   1. `%>%`(...)
      #   9. base::.handleSimpleError(...)
      #  10. dplyr:::h(simpleError(msg, call))
      # In addition: Warning message:
      # In if (na.rm) x <- x[!is.na(x)] else if (anyNA(x)) stop("missing values and NaN's not allowed if 'na.rm' is FALSE") :
      #   the condition has length > 1 and only the first element will be used

cat("ID delito")
base_fiscalia %>%
    group_by(iddelito) %>% 
    summarise(n=n()) %>% 
    summarise(min=min(n), max=max(n), mean=mean(n), median=median(n), p025=quantile(n, .025), p25=quantile(n, .25), p75=quantile(n,.75), p975=quantile(n, .975))
# algo específica, tiene como máximo 82 filas con el mismo id delito


cat("ID relación")
base_fiscalia %>%
    group_by(idrelacion) %>% 
    summarise(n=n()) %>% 
    summarise(min=min(n), max=max(n), mean=mean(n, na.rm=T), median=median(n, na.rm=T), p025=quantile(n, .025), p25=quantile(n, .25), p75=quantile(n,.75), p975=quantile(n, .975))
# más específica, tiene como máximo 2 filas con el mismo id relación


cat("RUC, RUT, ID relación")
agrupacion_base<-
base_fiscalia %>%
    group_by(ruc,rut_enc_saf,idrelacion) %>% 
    summarise(n=n()) %>% 
    summarise(min=min(n), max=max(n), mean=mean(n, na.rm=T), median=median(n, na.rm=T), p025=quantile(n, .025), p25=quantile(n, .25), p75=quantile(n,.75), p975=quantile(n, .975))

cat("Por qué ocurre esto???")
agrupacion_base %>% 
    dplyr::filter(max>1)
invisible("Casos en que agrupados las relaciones por rucs y a su vez por cada rut, resultan tener 2 relaciones")
invisible("ruc=='1101216380-2' tiene todo igual con la otra fila")
invisible("ruc=='1200110540-8' tiene todo igual con la otra fila")
invisible("ruc=='1200685456-5' tiene todo igual con la otra fila")
invisible("ruc=='1200685456-5' tiene todo igual con la otra fila")
# ruc          rut_enc_saf                        min   max  mean median  p025   p25   p75  p975
# 1 1101216380-2 6a72664c6071e9728753279c9e9719e5     2     2   2      2    2     2     2     2   
# 2 1200110540-8 471b17aece44998caa6f83fee6b3b483     2     2   2      2    2     2     2     2   
# 3 1200685456-5 f1966360761b422b7e826bab2e1a38dc     2     2   2      2    2     2     2     2   
# 4 1200771867-3 a2aee30c6c0693a9c13f39e3520f666c     2     2   2      2    2     2     2     2   
# 5 1201254538-8 2d3bec94a94304a0b786ab83f7d1021a     2     2   2      2    2     2     2     2   
# 6 1300390161-5 f336b9f3e4097cfe736239a8bb937596     1     2   1.5    1.5  1.02  1.25  1.75  1.98
# 7 1600027649-2 bfc39f93fe4e0958c4e0ec16dddec275     2     2   2      2    2     2     2     2   

invisible("Para ver casos posiblemente duplicados")
base_fiscalia %>%
  dplyr::mutate(combinacion=paste0(ruc,"_",rut_enc_saf)) %>%
  dplyr::filter(combinacion %in% as.character(unlist(agrupacion_base %>% 
  dplyr::filter(max>1) %>%dplyr::mutate(combinacion=paste0(ruc,"_",rut_enc_saf)) %>% dplyr::select(combinacion)))) %>% View()

cat("RUT")
base_fiscalia %>%
    group_by(rut_enc_saf) %>% 
    summarise(n=n()) %>% 
    summarise(min=min(n), max=max(n), mean=mean(n, na.rm=T), median=median(n, na.rm=T), p025=quantile(n, .025), p25=quantile(n, .25), p75=quantile(n,.75), p975=quantile(n, .975))


cat("RUC por RUT")
base_fiscalia %>%
    group_by(rut_enc_saf) %>% 
    summarise(n=n_distinct(ruc)) %>% 
    summarise(min=min(n), max=max(n), mean=mean(n, na.rm=T), median=median(n, na.rm=T), p025=quantile(n, .025), p25=quantile(n, .25), p75=quantile(n,.75), p975=quantile(n, .975)) %>% copiar_nombres()

cat("Delitos por RUT")
base_fiscalia %>%
    group_by(rut_enc_saf) %>% 
    summarise(n=n_distinct(gls_materia)) %>% 
    summarise(min=min(n), max=max(n), mean=mean(n, na.rm=T), median=median(n, na.rm=T), p025=quantile(n, .025), p25=quantile(n, .25), p75=quantile(n,.75), p975=quantile(n, .975))

cat("Relaciones por RUT")
base_fiscalia %>%
    group_by(rut_enc_saf) %>% 
    summarise(n=n_distinct(idrelacion)) %>% 
    summarise(min=min(n), max=max(n), mean=mean(n, na.rm=T), median=median(n, na.rm=T), p025=quantile(n, .025), p25=quantile(n, .25), p75=quantile(n,.75), p975=quantile(n, .975)) %>% copiar_nombres()

cat("Delitos por relación y RUC")
base_fiscalia %>%
    group_by(ruc, idrelacion, gls_materia) %>% 
    summarise(n=n()) %>% 
    summarise(min=min(n), max=max(n), mean=mean(n, na.rm=T), median=median(n, na.rm=T), p025=quantile(n, .025), p25=quantile(n, .25), p75=quantile(n,.75), p975=quantile(n, .975))

cat("Relaciones por RUC")
base_fiscalia %>%
    group_by(ruc) %>% 
    summarise(n=n_distinct(idrelacion)) %>% 
    summarise(min=min(n), max=max(n), mean=mean(n, na.rm=T), median=median(n, na.rm=T), p025=quantile(n, .025), p25=quantile(n, .25), p75=quantile(n,.75), p975=quantile(n, .975))

cat("Delitos por ruc")
base_fiscalia %>%
    group_by(ruc) %>% 
    summarise(n=n_distinct(gls_materia)) %>% 
    summarise(min=min(n), max=max(n), mean=mean(n, na.rm=T), median=median(n, na.rm=T), p025=quantile(n, .025), p25=quantile(n, .25), p75=quantile(n,.75), p975=quantile(n, .975))


#quienes tienen más de uno, son los mismos datos
base_fiscalia %>%
dplyr::filter(idrelacion %in% c(12935546, 13290172, 14124442, 14248963, 14953586, 15559264, 20446792))


```


```{r s4, echo=T, error=T, paged.print=TRUE}
cat("Vista base de datos")
base_fiscalia_ord<-
base_fiscalia %>%
    arrange(rut_enc_saf,fec_comision,ruc,idrelacion)


base_fiscalia %>%
    dplyr::filter(gls_mottermino=="Sentencia definitiva condenatoria") %>% View()
```

<br>

# Merge with SENDAs database



```{r merge_distinct_ruts, echo=T, error=T, paged.print=TRUE}

invisible("¿Hay RUTs de fiscalía que no existen en la base de datos SENDA?")

#Sólo el recuento de los RUTs
base_fiscalia_acc_imp %>% 
    #sólo dejo RUT únicos en la de septiembre, cosa que no me aumenten las filas originales
  dplyr::left_join(distinct(CONS_C1_df_dup_SEP_2020[,c("hash_key","dup")],hash_key, .keep_all = T),by=c("rut_enc_saf"="hash_key")) %>% 
  dplyr::distinct(rut_enc_saf, .keep_all = T) %>% 
      dplyr::summarise(n=n(),
                     sum_na = length(n[is.na(dup)]),
                     perc = scales::percent(sum_na/n, accuracy=.01))
#Sólo el recuento de los RUTs
base_fiscalia_acc_vic %>% 
    #sólo dejo RUT únicos en la de septiembre, cosa que no me aumenten las filas originales
  dplyr::left_join(distinct(CONS_C1_df_dup_SEP_2020[,c("hash_key","dup")],hash_key, .keep_all = T),by=c("rut_enc_saf"="hash_key")) %>% 
  dplyr::distinct(rut_enc_saf, .keep_all = T) %>% 
      dplyr::summarise(n=n(),
                     sum_na = length(n[is.na(dup)]),
                     perc = scales::percent(sum_na/n, accuracy=.01))

invisible("Base anterior")
#Sólo el recuento de los RUTs
base_fiscalia_acc_imp %>% 
    #sólo dejo RUT únicos en la de septiembre, cosa que no me aumenten las filas originales
  dplyr::left_join(distinct(CONS_C1[,c("HASH_KEY","row")],HASH_KEY, .keep_all = T),by=c("rut_enc_saf"="HASH_KEY")) %>% 
  dplyr::distinct(rut_enc_saf, .keep_all = T) %>% 
      dplyr::summarise(n=n(),
                     sum_na = length(n[is.na(row)]),
                     perc = scales::percent(sum_na/n, accuracy=.01))
#Sólo el recuento de los RUTs
base_fiscalia_acc_vic %>% 
    #sólo dejo RUT únicos en la de septiembre, cosa que no me aumenten las filas originales
  dplyr::left_join(distinct(CONS_C1[,c("HASH_KEY","row")],HASH_KEY, .keep_all = T),by=c("rut_enc_saf"="HASH_KEY")) %>% 
  dplyr::distinct(rut_enc_saf, .keep_all = T) %>% 
      dplyr::summarise(n=n(),
                     sum_na = length(n[is.na(row)]),
                     perc = scales::percent(sum_na/n, accuracy=.01))
```

<br>

# Codebook

```{r codebook, echo=T, error=T, paged.print=TRUE}
knitr::opts_chunk$set(
  warning = TRUE, # show warnings during codebook generation
  message = TRUE, # show messages during codebook generation
  error = TRUE, # do not interrupt codebook generation in case of errors,
                # usually better for debugging
  echo = TRUE  # show R code
)
ggplot2::theme_set(ggplot2::theme_bw())
pander::panderOptions("table.split.table", Inf)

if(!require(codebook)){install.packages("codebook")}
if(!require(future)){install.packages("future")}
if(!require(dplyr)){install.packages("dplyr")}
```


```{r prepare_codebook, include=T}

codebook_data <- dplyr::select(base_fiscalia, -c("rut_enc_saf","ruc","idrelacion","cod_delito","cod_lugarocurrencia","cod_parentescoimputado","cod_mottermino","cod_motsuspension","cod_proctermino","idsujeto_imputado","impcod_tiposujeto","cod_lugarocurrencia","cod_sitiosuceso","cod_comunadelito","cod_region"))

muestra=0
if(muestra==1){
# omit the following lines, if your missing values are already properly labelled
codebook_data <- detect_missing(codebook_data,
    only_labelled = TRUE, # only labelled values are autodetected as
                                   # missing
    negative_values_are_missing = FALSE, # negative values are missing values
    ninety_nine_problems = FALSE,   # 99/999 are missing values, if they
                                   # are more than 5 MAD from the median
    )
}
# If you are not using formr, the codebook package needs to guess which items
# form a scale. The following line finds item aggregates with names like this:
# scale = scale_1 + scale_2R + scale_3R
# identifying these aggregates allows the codebook function to
# automatically compute reliabilities.
# However, it will not reverse items automatically.
#codebook_data <- detect_scales(codebook_data)
```

<br>

In the following Tables and graphics, there is a summary of the variables and documentation of their characteristics. This high-level summary may permit us find errors on coding, help us to understand missingness and guide us towards an objective, or lead us to more questions. If a variable contains the symbol `(*)`, it means that this variable has a concatenation of values among continuous entries in treatments.

<br>

```{r codebook_display}
  metadata(codebook_data)$name <- "Prosecutor Support System (SAF), database of the Public Prosecutor's Office."
  metadata(codebook_data)$description <- "The information was extracted and processed from the Prosecutor Support System (SAF) database in accordance with the criteria established in the methodological document 'Criteria for Extracting Information from the SAF - 11_04_2018', prepared and updated in 2018 by the Studies, Evaluation, Control and Management Development Division. Data obtained at 2021-08-13; Period= 2010 to 2019; Unit of measurement= Relationships; Offenses considered= All; Date to consider= Date of termination of the case; National Coverage; Detail or summary= Detail; In the search for victims, only direct victims were considered; The RUTs indicated are searched only in cases terminated or suspended in the period 2010 - 2019;
The following types of accused are considered: COMPLAINED, ACCUSED, QUERELLED, WITNESS, SUSPECTED AND INVESTIGATED"

codebook(codebook_data)
```

<br>

# Session Info

```{r session_info, echo=T, error=T, paged.print=TRUE}
Sys.getenv("R_LIBS_USER")

rstudioapi::getSourceEditorContext()
#save.image("G:/Mi unidad/Alvacast/SISTRAT 2019 (github)/mult_state_carla.RData")

if (grepl("CISS Fondecyt",rstudioapi::getSourceEditorContext()$path)==T){
    save.image("C:/Users/CISS Fondecyt/Mi unidad/Alvacast/SISTRAT 2019 (github)/10.RData")
  } else if (grepl("andre",rstudioapi::getSourceEditorContext()$path)==T){
    save.image("C:/Users/andre/Desktop/SUD_CL/10.RData")
  } else if (grepl("E:",rstudioapi::getSourceEditorContext()$path)==T){
    save.image("E:/Mi unidad/Alvacast/SISTRAT 2019 (github)/10.RData")
  } else {
    save.image("G:/Mi unidad/Alvacast/SISTRAT 2019 (github)/10.RData")
  }

sessionInfo()
```


# Exportar

```{r export, warning=FALSE}
if(no_mostrar==0){
  codebook::var_label(surveymonkey_accionsalududp_df2_cor_sel_2) <-
  var_labels_df%>% 
    codebook::dict_to_list()
    
  attr(surveymonkey_accionsalududp_df2_cor_sel_2$rn,"label")<-'Número de Fila'  
    
  for (i in 1:length(surveymonkey_accionsalududp_df2_cor_table)){
      x<-names(surveymonkey_accionsalududp_df2_cor_table)[i]
      attr(surveymonkey_accionsalududp_df2_cor_sel_2[[x]],"label")<- attr(surveymonkey_accionsalududp_df2_cor_table[[x]],"label")
  
  var_labels_df<-data.frame()
  for (i in 1:length(surveymonkey_accionsalududp_df2_cor_sel_2)){
    x<-names(surveymonkey_accionsalududp_df2_cor_sel_2)[i]
  var_labels_df<-rbind.data.frame(var_labels_df, cbind(x, attr(surveymonkey_accionsalududp_df2_cor_sel_2[[x]],"label")))
    }
  }
}

  #dplyr::arrange(hash_key, fech_ing)%>% 
path<-rstudioapi::getSourceEditorContext()$path

  base_fiscalia %>% 
  dplyr::mutate(accused=dplyr::case_when(encontrado_como_victima=="SI" & encontrado_como_imputado=="SI"~"IMPUTADO",
                                 encontrado_como_victima=="NO" & encontrado_como_imputado=="SI"~"IMPUTADO",
                                 T~"VICTIMA")) %>% 
  dplyr::filter(accused=="VICTIMA") %>% 
    rio::export(file = paste0(gsub("SUD_CL/Fiscalia_merge.Rmd","",path),"fiscalia_mariel_ago_2021.dta"))
```
