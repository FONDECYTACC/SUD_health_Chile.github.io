---
title: "Descriptive Statistics"
date: "`r withr::with_locale(new = c('LC_TIME' = 'C'), code =format(Sys.time(),'%B %d, %Y'))`"
output:
  html_document:
    code_folding: hide  
    toc: true # table of content true
    toc_depth: 5  # upto three depths of headings (specified by #, ## and ###)
    toc_float: true
---

<style type="text/css">
.tablelines table, .tablelines td, .tablelines th {
        border: 1px solid black;
        }
.centrado {
    text-align: center;
}
.table.center {
    margin-left:auto; 
    margin-right:auto;
  }
.table_wrapper{
    display: block;
    overflow-x: auto;
    white-space: nowrap;
}
code.r{
  font-size: 8px;
}
body{ /* Normal  */
      text-align: justify;
  }
.superbigimage{
    overflow-y:scroll;
    white-space: nowrap;
}
.superbigimage img{
    overflow-y: scroll;
    overflow-x: hidden;
}
</style>

<style>
div.blue { background-color:#e6f0ff; border-radius: 5px; padding: 20px; text-align: justify;}
</style>

```{r prev_setup, include = FALSE, cache=T}
rm(list=ls());gc()
# 
# path<-rstudioapi::getSourceEditorContext()$path
# #load("E:/Mi unidad/Alvacast/SISTRAT 2019 (github)/mult_state_carla.RData")
# if (grepl("CISS Fondecyt",path)==T){
#     setwd("C:/Users/CISS Fondecyt/Mi unidad/Alvacast/SISTRAT 2019 (github)/SUD_CL/");load("C:/Users/CISS Fondecyt/Mi unidad/Alvacast/SISTRAT 2019 (github)/8.RData")
#   } else if (grepl("andre",path)==T){
#     setwd('C:/Users/andre/Desktop/SUD_CL/');load("E:/Mi unidad/Alvacast/SISTRAT 2019 (github)/8.RData")
#   } else if (grepl("E:",path)==T){
#     setwd("E:/Mi unidad/Alvacast/SISTRAT 2019 (github)/SUD_CL/");load("E:/Mi unidad/Alvacast/SISTRAT 2019 (github)/8.RData")
#   } else {
#     setwd("C:/Users/CISS Fondecyt/Mi unidad/Alvacast/SISTRAT 2019 (github)/SUD_CL/");load("C:/Users/CISS Fondecyt/Mi unidad/Alvacast/SISTRAT 2019 (github)/8.RData")
#   }

rm(list=ls());gc()
if(!require(here)){install.packages("here")}
warning(paste0(getwd()))
Sys.setlocale("LC_TIME")

unlink(paste0(here::here(),"/*_cache"), recursive = TRUE)

path<-gsub("/SUD_CL","",here::here())

check_obj<-function(x){if(!exists(x)){stop(paste0("The object ",x ," was not created"))}}

load(paste0(path,"/7.Rdata"))


    #df_print: paged
if(isTRUE(getOption('knitr.in.progress'))==T){
    nn_size= 1:5 # size= 1:5
    nn_seq=seq(0, 1, .5)
    nn_K= 10
} else {
  input <- readline('¿Are you gonna run the results seriously? (Si/No): ')
  if(input=="Si"){
    nn_size= 1:5 # size= 1:5
    nn_seq=seq(0, 1, .5)
    nn_K= 10
  } else {
    nn_size= 1 # size= 1:5
    nn_seq=1
    nn_K= 1
  }
}

#load("C:/Users/CISS Fondecyt/Mi unidad/Alvacast/SISTRAT 2019 (github)/10.RData")
```

```{r setup, include = FALSE, cache=T}
#Libraries used in the routine. Dont change the order

local({r <- getOption("repos")
       r["CRAN"] <- "http://cran.r-project.org" 
       options(repos=r)
})
copiar_nombres <- function(x,row.names=FALSE,col.names=TRUE,dec=",",...) {
  if(class(ungroup(x))[1]=="tbl_df"){
        if(options()$OutDec=="."){
            options(OutDec = dec)
            write.table(format(data.frame(x)),"clipboard",sep="\t",row.names=FALSE,col.names=col.names,...)
            options(OutDec = ".")
          return(x)
        } else {
            options(OutDec = ",")
            write.table(format(data.frame(x)),"clipboard",sep="\t",row.names=FALSE,col.names=col.names,...)
            options(OutDec = ",")
          return(x)    
        }
  } else {
        if(options()$OutDec=="."){
            options(OutDec = dec)
            write.table(format(x),"clipboard",sep="\t",row.names=FALSE,col.names=col.names,...)
            options(OutDec = ".")
          return(x)
        } else {
            options(OutDec = ",")
            write.table(format(x),"clipboard",sep="\t",row.names=FALSE,col.names=col.names,...)
            options(OutDec = ",")
          return(x)       
  }
 }
}  
#packageVersion("codebook")
#https://github.com/RevolutionAnalytics/checkpoint
#if(!require(checkpoint)){install.packages("checkpoint")}
#if(!require(here)){install.packages("here")}
#checkpoint::checkpoint("2020-02-19",project=here::here(),checkpointLocation=paste0(here::here(),"/dedup"), use.lock=F, use.knitr=T, auto.install.knitr = T,scan.rnw.with.knitr=T, forceInstall=T,scanForPackages = TRUE)
#checkpointArchives(tempdir(), full.names = TRUE)

#if(!require(tidyr)){install.packages("tidyr")}
#if(!require(DataExplorer)){install.packages("DataExplorer")}
#if(!require(stringi)){install.packages("stringi")}
#if(!require(stringr)){install.packages("stringr")}
#if(!require(ggplot2)){install.packages("ggplot2")}
#if(!require(Hmisc)){install.packages("Hmisc")}
#if(!require(kableExtra)){install.packages("kableExtra")}
#if(!require(plotly)){install.packages("plotly")}
#if(!require(rbokeh)){install.packages("rbokeh")}
#if(!require(altair)){install.packages("altair")}
#if(!require(zoo)){install.packages("zoo")}
#if(!require(codebook)){install.packages("codebook")}
#if(!require(broom)){install.packages("broom")}
#if(!require(sqldf)){install.packages("sqldf")} 
#if(!require(devtools)){install.packages("devtools")}
#if(!require(Statamarkdown)){install_github("hemken/Statamarkdown")}
#if(!require(data.table)){install.packages("data.table")}
#if(!require(dplyr)){install.packages("dplyr")}

#if(!require(boot)){install.packages("boot")}
#if(!require(plyr)){install.packages("plyr")}
#if(!require(matrixStats)){install.packages("matrixStats")}
#if(!require(radiant)){install.packages("radiant", repos = "https://radiant-rstats.github.io/minicran/")}

#2022
if(!require(biostat3)){install.packages("biostat3")}
require(Statamarkdown)

#2020
try(require(boot))
require(matrixStats)
require(knitr)
require(tidyr)
require(stringi)
require(stringr)
require(ggplot2)
require(Hmisc)
require(kableExtra)
require(plotly)
require(janitor)
require(rbokeh)
#2022: require(altair)
require(zoo)
require(broom)
require(car)
require(sqldf)
require(devtools)
require(codebook)
require(data.table)
require(panelr)
require(RColorBrewer)
require(lsmeans)
require(finalfit)
require(chilemapas)
suppressPackageStartupMessages(require(ggiraph))
suppressPackageStartupMessages(require(sf))
require(treemapify)
require(dplyr)
require(tidylog)
require(choroplethr)
require(choroplethrMaps)
require(choroplethrAdmin1)
require(tidyverse)
require(epiR)
require(survminer)
require(rateratio.test)  
require(ggfortify)
require(survMisc)
require(muhaz)
require(flexsurv)

#if(!require(radiant.update)){install.packages("radiant.update", repos = "https://radiant-rstats.github.io/minicran/")}
#install.packages( repos = "https://radiant-rstats.github.io/minicran/")
#install.packages("radiant.update", repos = "https://radiant-rstats.github.io/minicran/")

#tryCatch(source("https://raw.githubusercontent.com/radiant-rstats/minicran/gh-pages/update.R"), error = function(e) print("updated package, radiant"))

#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:
#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:
#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:
#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:
#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:

 
irrs<-function(x, y="event", z="person_days",db){
  #x= variable que agrupa
  #y= evento explicado
  #z= person days
  #db= base de datos
  fmla <- as.formula(paste0(y,"~",x))
  fmla2 <- as.formula(paste0(z,"~",x))
assign(paste0("irr_",y,"_por_",x),
       rateratio.test::rateratio.test(
     x=as.numeric(xtabs(fmla, data=get(db)))[c(2,1)],
     n=as.numeric(xtabs(fmla, data=get(db)))[c(2,1)]
    )
   )
return(
  rateratio.test::rateratio.test(
     x=as.numeric(xtabs(fmla, data=get(db)))[c(2,1)],
     n=as.numeric(xtabs(fmla2, data=get(db)))[c(2,1)]
      )
    )
}
time_before_desc<-Sys.time()
```

<!--- SÍ O SÍ, HACER LA LIMPIEZA DE LOS SENDA NO, PRINCIPALMENTE DE LOS QUE SE SUPERPONGAN, TAMBIÉN PREGUNTAR A ACC SI LOS CON 0 DÍAS DE TRATAMIENTO SE BORRARÁN O NO; DE AHI EMPEZAR A NORMALIZAR LOS PROGRAMAS Y PLANES DE ACUERDO CON CRITERIOS MAUREEN, PARA NO GENERAR DIFERENCIAS AHI Y PODER DEDUPLICAR TRANQUILO --->

<br>

For the purpose of this page, we use the terms "rows" and "cases" interchangeably to refer to the entries of the dataset. In many of the processes made along the deduplication of entries in the C1 dataset, we used unstandardized columns or many other data that was in fact duplicated by HASHs that did not depend on events related to treatment.In order to find and delete duplicated data that does not add information relevant for the purposes of the study, we now may **use these standardized variables as a criteria to achieve the goal of having a unique event per HASH, by reducing its complexity based on irrelevant differences**.

<br>

<div class = "blue">
Once we distinguished between the different treatments in the fourth part of the deduplication process, we proceeded to describe the dataset in terms of the time required for determined events to occur.
</div>

<br>

The process is shown in the following figure:

<br>

```{r fig1, flowchart, echo=T, fig.align='center', message=FALSE, fig.caption="Figure 1.Summary of Process of Data Cleaning and Standardization", error=T}
no_mostrar=0
#knitr::include_graphics("G:/Mi unidad/Alvacast/SISTRAT 2019 (github)/SUD_CL/Figures/Figure_Duplicates.svg")
#foreign::write.dta(CONS_C1_df_dup_JUL_2020_match_top_sel, "G:/Mi unidad/Alvacast/SISTRAT 2019 (github)/c1_top.dta")

#CONS_C1_df_dup_JUL_2020 CONS_C1_df_dup_JUL_2020_match_top CONS_TOP_df_dup_ENE_2020_prev9_match CONS_TOP_df_dup_ENE_2020_prev9
#sólo match
comb_datasets_a_n<-CONS_C1_df%>%
    janitor::clean_names() %>% 
    nrow()
comb_datasets_a_users<-CONS_C1_df%>%
    janitor::clean_names() %>% 
    dplyr::distinct(hash_key)%>% nrow()
#sólo los que tienen compromiso biopsicosocial
comb_datasets_b_n<-CONS_C1_df_dup_JUL_2020%>%
    nrow()
comb_datasets_b_users<-CONS_C1_df_dup_JUL_2020%>%
    dplyr::distinct(hash_key)%>% nrow()
#sólo los que tienen etapa de tratamiento de inicio de tratamiento
comb_datasets_c_n<-CONS_C1_df_dup_JUL_2020%>%
    dplyr::arrange(hash_key,fech_ing) %>% 
    dplyr::group_by(hash_key) %>% 
    dplyr::mutate(dup=row_number()) %>%
  #janitor::tabyl(dup) %>% 
#*La ventaja de duplicates_filtered es que considera los perdidos
    dplyr::mutate(duplicates_filtered= n()) %>%
    dplyr::filter(duplicates_filtered==1) %>% 
  #janitor::tabyl(duplicates_filtered)
    nrow()
comb_datasets_c_users<-CONS_C1_df_dup_JUL_2020%>%
    dplyr::group_by(hash_key) %>% 
    dplyr::mutate(dup=row_number()) %>%
  #janitor::tabyl(dup) %>% 
#*La ventaja de duplicates_filtered es que considera los perdidos
    dplyr::mutate(duplicates_filtered= n()) %>%
    dplyr::filter(duplicates_filtered==1) %>% 
    dplyr::distinct(hash_key)%>% nrow()

comb_datasets_d_n<-CONS_C1_df_dup_JUL_2020%>%
    dplyr::group_by(hash_key) %>% 
    dplyr::mutate(dup=row_number()) %>%
  #janitor::tabyl(dup) %>% 
#*La ventaja de duplicates_filtered es que considera los perdidos
    dplyr::mutate(duplicates_filtered= n()) %>%
      dplyr::filter(dup>1) %>% 
  #janitor::tabyl(duplicates_filtered)
    nrow()
comb_datasets_d_users<-CONS_C1_df_dup_JUL_2020%>%
    dplyr::group_by(hash_key) %>% 
    dplyr::mutate(dup=row_number()) %>%
  #janitor::tabyl(dup) %>% 
#*La ventaja de duplicates_filtered es que considera los perdidos
    dplyr::mutate(duplicates_filtered= n()) %>%
    dplyr::filter(dup>1) %>% 
    dplyr::distinct(hash_key)%>% nrow()

#https://stackoverflow.com/questions/46750364/diagrammer-and-graphviz
#https://mikeyharper.uk/flowcharts-in-r-using-diagrammer/
#http://blog.nguyenvq.com/blog/2012/05/29/better-decision-tree-graphics-for-rpart-via-party-and-partykit/
#http://blog.nguyenvq.com/blog/2014/01/17/skeleton-to-create-fast-automatic-tree-diagrams-using-r-and-graphviz/
#https://cran.r-project.org/web/packages/DiagrammeR/vignettes/graphviz-mermaid.html
#https://stackoverflow.com/questions/39133058/how-to-use-graphviz-graphs-in-diagrammer-for-r
#https://subscription.packtpub.com/book/big_data_and_business_intelligence/9781789802566/1/ch01lvl1sec21/creating-diagrams-via-the-diagrammer-package
#https://justlegal.be/2019/05/using-flowcharts-to-display-legal-procedures/
#
#
library(DiagrammeR) #⋉
grViz("digraph flowchart {
      # node definitions with substituted label text
      node [fontname = Helvetica, shape = rectangle,fontsize = 10]        
      tab1 [label = '@@1']
      tab2 [label = '@@2']
      tab3 [label = '@@3']
      tab4 [label = '@@4']

      # edge definitions with the node IDs
      tab1 -> tab2 [label='  Discarded duplicated & abnormal records',fontsize = 9];
      tab2 -> {tab3 tab4} 
      }
Only rows with available data on TOP scores

      [1]:  paste0('Original records \\n(n = ', formatC(comb_datasets_a_n, format='f', big.mark=',', digits=0), ';\\n users: ',formatC(comb_datasets_a_users, format='f', big.mark=',', digits=0),')')
      [2]:  paste0('Normalized & standardized \\nrecords \\n(n = ', formatC(comb_datasets_b_n, format='f', big.mark=',', digits=0), ';\\n users:',formatC(comb_datasets_b_users, format='f', big.mark=',', digits=0),')')
      [3]:  paste0('Only users w/ records at baseline \\n(n = ', formatC(comb_datasets_c_n, format='f', big.mark=',', digits=0), ';\\n users:',formatC(comb_datasets_c_users, format='f', big.mark=',', digits=0),')')
      [4]:  paste0('Users w/ Posterior records \\n(n = ', formatC(comb_datasets_d_n, format='f', big.mark=',', digits=0), ';\\n users:',formatC(comb_datasets_d_users, format='f', big.mark=',', digits=0),')')
      ")
```


# Characteristics of population in Agreement 1 (C1)

<br>

We first compared treatments selected in the database to the discarded entries due to duplicated or invalid values.

<br>

```{r tab1_descr_c1_deleted_vs_selected,dpi = 96, message=F, error=T,eval=T, warnings=F}
#Definir la base de datos
library(magrittr)

CONS_C1_df_SEP_2020<-
clean_names(CONS_C1_df) %>% 
    dplyr::filter(!row %in% unlist(CONS_C1_df_dup_JUL_2020$row)) %>% 
#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:  
  #escolaridad 
    dplyr::mutate(escolaridad_rec=ifelse(as.character(escolaridad_ultimo_ano_cursado)=="BASICA COMPLETA"|as.character(escolaridad_ultimo_ano_cursado)=="BASICA INCOMPLETA"|as.character(escolaridad_ultimo_ano_cursado)=="SIN ESTUDIOS","Ed Primaria Completa o Menor",as.character(escolaridad_ultimo_ano_cursado))) %>%
dplyr::mutate(escolaridad_rec=ifelse(escolaridad_rec=="MEDIA COMPLETA"|escolaridad_rec=="MEDIA INCOMPLETA","2-Ed Secundaria Completa o Menor",
    ifelse(escolaridad_rec=="NO SABE O NO SE APLICA",NA,
    ifelse(escolaridad_rec %in% c("TECNICA COMPLETA", "TECNICA INCOMPLETA", "UNIVERSITARIA COMPLETA O MAS", "UNIVERSITARIA INCOMPLETA"), "1-Mayor a Ed Secundaria",ifelse(
      escolaridad_rec=="Ed Primaria Completa o Menor","3-Ed Primaria Completa o Menor",escolaridad_rec))))) %>%
dplyr::mutate(escolaridad_rec=factor(escolaridad_rec,labels=c('1-More than high school','2-Completed high school or less','3-Completed primary school or less')))  %>% 

#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:  
  #frecuencia consumo sus principal 
  
      dplyr::mutate(freq_cons_sus_prin=ifelse(frecuencia_de_consumo_sustancia_principal== "Desconocida",NA,as.character(frecuencia_de_consumo_sustancia_principal))) %>% 

  #:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:  
  #tipo de plan 
      dplyr::mutate(tipo_de_plan_2=dplyr::recode(tipo_de_plan_2,"M-PAI2"= "M-PAI", "M-PR2"="M-PR","PG PAI 2"="PG-PAI", "Otro"="PG-PR", "CALLE"="PG-PR"))%>%

  #:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:  
  #fecha de nacimiento
  dplyr::mutate(fech_nac=lubridate::parse_date_time(stringi::stri_sub(id,-8,-1),"dmY")) %>% 

  #:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:  
  #edad al ingreso
  dplyr::mutate(edad_al_ing=lubridate::time_length(difftime(as.Date(fech_ing), as.Date(fech_nac)),"years")) %>% #AGREGADO EN APR 2020.
  dplyr::mutate(edad_al_ing=replace(edad_al_ing, is.na(edad), NA)) %>%

  #:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:  
  #sus principal  
  dplyr::mutate(sus_principal= dplyr::recode(sustancia_principal,
                                             "Hipnóticos "= "Tranquilizantes e Hipnóticos",
                                             "Sedantes:  diazepam, Valium, clonazepam, Ravotril, alprazolam, adax, barbitúricos, fenobarbital." = "Tranquilizantes e Hipnóticos",
                                             "Anfetaminas"="Estimulante tipo anfetaminas",
                                             "Extasis"="Estimulante tipo anfetaminas",
                                             "Fenilciclidina"="Estimulante tipo anfetaminas",
                                             "Metanfetaminas y otros derivados"="Estimulante tipo anfetaminas",
                                             "Otros Estimulantes"="Estimulante tipo anfetaminas",
                                             "LSD"="Alucinógenos",
                                             "Otros Alucinógenos"="Alucinógenos",
                                             "Crack"="Pasta Base",
                                             "Heroína"="Opioides",
                                             "Metadona"="Opioides",
                                             "Otros Opioides Analgésicos: morfina, codeína, meperidina,  demerol, tramadol, tramal."="Opioides",
                                             "Inhalables: neopren, GHB, óxido nitroso (gas hilarante), \"poppers\", solventes, gasolina, diluyente"="Inhalables",
                                             "Esteroides Anabólicos"="Otros")) %>%
      dplyr::mutate(sus_principal_mod= dplyr::case_when(sus_principal!="Alcohol"&sus_principal!="Cocaína"&sus_principal!="Marihuana"&sus_principal!="Pasta Base"~"Otros",TRUE~as.character(sus_principal)))%>%
  
  #:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:  
  #motivo de egreso
      dplyr::mutate(dias_trat_alta_temprana=ifelse(dias_trat>=90,0,1)) %>%
      dplyr::mutate(dias_trat_alta_temprana=as.factor(dias_trat_alta_temprana)) %>%
      dplyr::mutate(dias_trat_alta_temprana= dplyr::recode(dias_trat_alta_temprana, "1"="Menos de 90 días", "0"="Mayor o igual a 90 días")) %>%
      dplyr::mutate(motivodeegreso_mod= ifelse(dias_trat_alta_temprana=="Menos de 90 días" & motivodeegreso=="Abandono", "Abandono Temprano",as.character(motivodeegreso))) %>% 
      dplyr::mutate(motivodeegreso_mod= ifelse(dias_trat_alta_temprana=="Mayor o igual a 90 días" & motivodeegreso=="Abandono", "Abandono Tardio",as.character(motivodeegreso_mod))) %>% 

  #:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:  
  #dias_trat
      dplyr::mutate(fech_ing_num=as.numeric(as.Date(fech_ing)))%>%
      dplyr::mutate(fech_egres_num=as.numeric(as.Date(fech_egres)))%>%
      dplyr::mutate(fech_egres_num=ifelse(is.na(fech_egres),18213,fech_egres_num))%>% #equivalente a 2019-11-13
      dplyr::mutate(dias_treat_imp_sin_na=fech_egres_num-fech_ing_num)%>%
      
  #:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:  
  #motivodeegreso_mod_imp
      dplyr::mutate(motivodeegreso_mod_imp=ifelse(dias_treat_imp_sin_na<1095 & is.na(fech_egres),"En curso",as.character(motivodeegreso_mod))) %>% 

  #:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:  
  #origen de ingreso
      dplyr::mutate(origen_ingreso=ifelse(as.character(origen_de_ingreso)=="Consulta Espontánea", "Consulta Espontánea",as.character(origen_de_ingreso))) %>%
      dplyr::mutate(origen_ingreso=ifelse(origen_ingreso=="Establecimiento Educacional"|origen_ingreso=="Otros"|origen_ingreso=="Trabajo (empresa o empleador)"|origen_ingreso=="Servicios Sociales u otros (iglesia, Mideplan, ser. comunitarios, etc.)", "Otros",origen_ingreso)) %>%
      dplyr::mutate(origen_ingreso=ifelse(origen_ingreso=="Juzgado con Competencia en Crimen"|origen_ingreso=="Juzgado de Garantía"|origen_ingreso=="Libertad Vigilada"|origen_ingreso=="Juzgado de Familia"|origen_ingreso=="Juzgado de Policía"|origen_ingreso=="Otros (fiscalía)","Sector Justicia",origen_ingreso)) %>%
      dplyr::mutate(origen_ingreso=ifelse(origen_ingreso=="Otros de la Red de Salud General Privado"|origen_ingreso=="Estab. de APS"|origen_ingreso=="Estab. de APS "|origen_ingreso=="Otros de la Red de Salud General Público", "Sector Salud", origen_ingreso)) %>%
      dplyr::mutate(origen_ingreso=ifelse(origen_ingreso=="Otro Centro Tratamiento Drogas"|origen_ingreso=="FONODROGAS"|origen_ingreso=="Previene","Otro Centro Tratamiento Drogas/FONODROGAS/Previene",origen_ingreso)) %>%
          
      dplyr::mutate(origen_ingreso_mod= dplyr::case_when(grepl("Otro Centro Tratamiento",as.character(origen_ingreso))~"Derivación Asistida", TRUE~as.character(origen_ingreso)))%>%  
      dplyr::mutate(origen_ingreso_mod=factor(origen_ingreso_mod,labels=c('Spontaneous','Assisted Referral','Other','Justice Sector','Health Sector')))  %>% 

  #:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:  
  #CIE_10
      dplyr::mutate(across(c(diagnostico_trs_psiquiatrico_cie_10,x2_diagnostico_trs_psiquiatrico_cie_10,x3_diagnostico_trs_psiquiatrico_cie_10),~dplyr::case_when(grepl("En estudio",as.character(.))~0,grepl("Sin trastorno",as.character(.))~0,is.na(.)~0,TRUE~1), .names="dg_{col}"))%>%
      dplyr::mutate(across(c(diagnostico_trs_psiquiatrico_cie_10,x2_diagnostico_trs_psiquiatrico_cie_10,x3_diagnostico_trs_psiquiatrico_cie_10),~dplyr::case_when(grepl("En estudio",as.character(.))~1,grepl("Sin trastorno",as.character(.))~0,is.na(.)~0,TRUE~0), .names="instudy_{col}"))%>%
      dplyr::mutate(instudy_total_cie_10 = base::rowSums(dplyr::select(., instudy_diagnostico_trs_psiquiatrico_cie_10, instudy_x2_diagnostico_trs_psiquiatrico_cie_10, instudy_x3_diagnostico_trs_psiquiatrico_cie_10)))%>%
      dplyr::mutate(dg_total_cie_10 = base::rowSums(dplyr::select(., dg_diagnostico_trs_psiquiatrico_cie_10, dg_x2_diagnostico_trs_psiquiatrico_cie_10, dg_x3_diagnostico_trs_psiquiatrico_cie_10)))%>%
      dplyr::mutate(dg_cie_10_rec=dplyr::case_when(dg_total_cie_10>0 ~2,
                                             instudy_total_cie_10>0 & dg_total_cie_10==0~1,
                                             instudy_total_cie_10>0 & is.na(dg_total_cie_10)~1,
                                             TRUE~0))%>%
      dplyr::mutate(dg_cie_10_rec=as.factor(dg_cie_10_rec))%>%
      dplyr::mutate(dg_cie_10_rec=factor(dg_cie_10_rec,labels=c('Without psychiatric comorbidity','Diagnosis unknown (under study)', 'With psychiatric comorbidity'))) %>% 
      dplyr::mutate(tipo_de_programa_2=dplyr::case_when(grepl("M-", tipo_de_plan_2)~"Women specific",
                                                        grepl("PG-", tipo_de_plan_2)~"General population",
                                                        grepl("LV", tipo_de_plan_2)~"Other")) %>% 
      dplyr::mutate(sexo_2=factor(sexo_2,labels=c('Men','Women'))) %>% 
      dplyr::mutate(edad_al_ing_grupos=dplyr::case_when(
      edad_al_ing>=50~"50+",
          edad_al_ing>=40~"40-49",
          edad_al_ing>=30~"30-39",
          edad_al_ing>=18~"18-29",
          edad_al_ing<18~"<18",
          TRUE~NA_character_)) %>%
      dplyr::mutate(edad_al_ing_grupos=as.factor(edad_al_ing_grupos)) %>%  
    #:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:  
  #Edad Inicio Sus Principal  
   dplyr::mutate(edad_ini_sus_prin_grupos=ifelse(edad_inicio_sustancia_principal>=25,">=25",
                                                ifelse(edad_inicio_sustancia_principal>18,"19-24",
                                                ifelse(edad_inicio_sustancia_principal>15,"16-18",
                                                ifelse(edad_inicio_sustancia_principal>0,"<=15",
                                                NA_character_)))))%>% 
    dplyr::mutate(edad_ini_sus_prin_grupos=as.factor(edad_ini_sus_prin_grupos)) %>%
  #:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:  
  #Cause of discharge
      dplyr::mutate(motivodeegreso_mod_imp=factor(motivodeegreso_mod_imp,labels=c('Late Drop-out',
                                                                                  'Early Drop-out',
                                                                                  'Administrative discharge',
                                                                                  'Therapeutic discharge',
                                                                                  'Referral to another treatment',
                                                                                  'Ongoing treatment'))) %>% 
  #:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:  
  #frequency of consumption
  dplyr::mutate(freq_cons_sus_prin=factor(freq_cons_sus_prin,labels=c("1 day a week or less",
                                                                                  "2 to 3 days a week",
                                                                                  "4 to 6 days a week",
                                                                                  "Less than 1 day a week",
                                                                                  "Did not use",
                                                                                  "Daily"))) %>%     
  #:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:  
  #primary substance
    dplyr::mutate(sus_principal_mod=factor(sus_principal_mod,labels=c("Alcohol",
                                                                                  "Cocaine hydrochloride",
                                                                                  "Marijuana",
                                                                                  "Other",
                                                                                  "Cocaine paste"))) %>%   
  #:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:  
  #marital status
    dplyr::mutate(estado_conyugal_2=ifelse(as.character(estado_conyugal)=="Casado"|as.character(estado_conyugal)=="Conviviente"|as.character(estado_conyugal)=="conviviente civil", "Casado/Conviviente",stringr::str_trim(as.character(estado_conyugal)))) %>%
    dplyr::mutate(estado_conyugal_2=ifelse(estado_conyugal_2=="Separado"|estado_conyugal_2=="Divorciado"|estado_conyugal_2=="Anulado", "Separado/Divorciado",estado_conyugal_2)) %>% 
    dplyr::mutate(estado_conyugal_2=ifelse(estado_conyugal_2=="Nocontesta",NA,estado_conyugal_2)) %>%
    #dplyr::mutate(estado_conyugal=factor(estado_conyugal, labels=c('asd','asda'))) %>%
    dplyr::mutate(estado_conyugal_2=factor(estado_conyugal_2, labels=c('Married/Shared living arrangements','Separated/Divorced','Single','Widower'))) %>%
  
  #:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:  
  #region
   dplyr::mutate(macrozona=as.factor(dplyr::recode(region_del_centro,
                                              "DE ANTOFAGASTA"="Norte",
                                              "DE LA ARAUCANIA"="Sur",
                                              "DE ARICA Y PARINACOTA"="Norte",
                                              "DE ATACAMA"="Norte",
                                              "DE AYSEN DEL GENERAL CARLOS IBA?S DEL CAMPO"="Sur",
                                              "DEL BIO-BIO"="Centro",
                                              "DE COQUIMBO"="Norte",
                                              "DE LOS LAGOS"="Sur",
                                              "DE LOS RIOS"="Sur",
                                              "DE MAGALLANES Y LA ANTARTICA CHILENA"="Sur",
                                              "DEL MAULE"="Centro",
                                              "METROPOLITANA"="Centro",
                                              "DE ?BLE"="Centro",
                                              "DEL LIBERTADOR GENERAL  BERNARDO OHIGGINS"="Centro",
                                              "DE TARAPACA"="Norte",
                                              "DE VALPARAISO"="Centro")))%>%
  dplyr::mutate(macrozona=factor(macrozona, labels=c('Center',
                                                                   'North',
                                                                   'South'))) %>%
 dplyr::mutate(nombre_region=as.factor(dplyr::recode(region_del_centro,
                                              "DE ANTOFAGASTA"="Antofagasta (02)",
                                              "DE LA ARAUCANIA"="Araucanía (09)",
                                              "DE ARICA Y PARINACOTA"="Arica (15)",
                                              "DE ATACAMA"="Atacama (03)",
                                              "DE AYSEN DEL GENERAL CARLOS IBA?S DEL CAMPO"="Aysén (11)",
                                              "DEL BIO-BIO"="Biobío (08)",
                                              "DE COQUIMBO"="Coquimbo (04)",
                                              "DE LOS LAGOS"="Los Lagos (10)",
                                              "DE LOS RIOS"="Los Ríos (14)",
                                              "DE MAGALLANES Y LA ANTARTICA CHILENA"="Magallanes (12)",
                                              "DEL MAULE"="Maule (07)",
                                              "METROPOLITANA"="Metropolitana (13)",
                                              "DE ?BLE"="Ñuble (16)",
                                              "DEL LIBERTADOR GENERAL  BERNARDO OHIGGINS"="O'Higgins (06)",
                                              "DE TARAPACA"="Tarapacá (01)",
                                              "DE VALPARAISO"="Valparaíso (05)")))%>%
  #:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:  
  #type of center (pub/priv)
      dplyr::mutate(tipo_centro=factor(tipo_centro, labels=c('Private','Public'))) %>%
      dplyr::mutate(nombre_region=factor(nombre_region)) %>% 
      dplyr::mutate(macrozona=factor(macrozona)) %>% 

  #:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:  
  #occupational status (inactive…)
      dplyr::mutate(estatus_ocupacional=ifelse(condicion_ocupacional=="Trabajando actualmente","Empleado",
                                               ifelse(condicion_ocupacional=="Buscando trabajo por primera vez"|condicion_ocupacional=="Cesante","Desempleado","Inactivo"))) %>%
      dplyr::mutate(estatus_ocupacional=factor(estatus_ocupacional, labels=c('Unemployed',
                                                                             'Employed',
                                                                             'Inactive'))) %>%
      #Comprende la relación entre una persona económicamente activa y su trabajo o empleo. Sólo se aplica aquellas personas que se encuentran trabajando al momento de ingresar a tratamiento (las que respondieron 1 en la pregunta anterior). Para las personas que no están trabajando (estudiantes, cesante, etc.) esta opción estará bloqueada.
      #data.table(table(CONS_C1_df_dup_ENE_2020_prev3$Categoría.Ocupacional))
      dplyr::mutate(cat_ocupacional=ifelse(condicion_ocupacional!="Trabajando actualmente",NA,as.character(categoria_ocupacional)))%>%
      dplyr::mutate(cat_ocupacional=as.factor(cat_ocupacional)) %>%
  dplyr::mutate(cat_ocupacional=factor(cat_ocupacional, labels=c('Salaried',
                                                                             'Self-employed',
                                                                             'Employer',
                                                                             'Unpaid family labour',
                                                                             'Other',
                                                                             'Volunteer worker'))) %>%

  #:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:  
  #age of onset of drug use
    dplyr::mutate(edad_ini_cons= ifelse(edad_inicio_consumo<=edad_al_ing, edad_inicio_consumo, NA)) %>%
    dplyr::mutate(edad_ini_cons= ifelse(edad_ini_cons<5,NA,edad_ini_cons)) %>%
  
  #:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:  
  #physical diagnose
    dplyr::mutate(dg_fis_anemia= ifelse(grepl("Anemia",diagnostico_trs_fisico),1,0))%>%
    dplyr::mutate(dg_fis_card= ifelse(grepl("Cardiopat",diagnostico_trs_fisico),1,0))%>%
    dplyr::mutate(dg_fis_in_study= ifelse(grepl("En estudio",diagnostico_trs_fisico),1,0))%>%
    dplyr::mutate(dg_fis_enf_som= ifelse(grepl("somáticas",diagnostico_trs_fisico),1,0))%>%
    dplyr::mutate(dg_fis_ets= ifelse(grepl("ETS",diagnostico_trs_fisico),1,0))%>%
    dplyr::mutate(dg_fis_hep_alc= ifelse(grepl("Hepatitis alcohólica",diagnostico_trs_fisico),1,0))%>%
    dplyr::mutate(dg_fis_hep_b= ifelse(grepl("Hepatitis B",diagnostico_trs_fisico),1,0))%>%
    dplyr::mutate(dg_fis_hep_cro= ifelse(grepl("Hepatitis crónica",diagnostico_trs_fisico),1,0))%>%
    dplyr::mutate(dg_fis_inf= ifelse(grepl("Infecciosas relacionadas",diagnostico_trs_fisico),1,0))%>%
    dplyr::mutate(dg_fis_otr_cond_fis_ries_vit= ifelse(grepl("Condiciones de Riesgo Vital",diagnostico_trs_fisico),1,0))%>%
    dplyr::mutate(dg_fis_otr_cond_fis= ifelse(grepl("condiciones Fisicas Limitantes",diagnostico_trs_fisico),1,0))%>%
    dplyr::mutate(dg_fis_pat_buc= ifelse(grepl("Bucal",diagnostico_trs_fisico),1,0))%>%
    dplyr::mutate(dg_fis_pat_ges_intrau= ifelse(grepl("niño intrauterino",diagnostico_trs_fisico),1,0))%>%
    dplyr::mutate(dg_fis_trau_sec= ifelse(grepl("Traumatismos y secuelas",diagnostico_trs_fisico),1,0))%>%
    dplyr::mutate(otros_pr_sm_abu_sex= ifelse(grepl("Abuso Sexual",otros_problemas_de_atencion_de_salud_mental),1,0))%>%
    dplyr::mutate(otros_pr_sm_exp_com_sex= ifelse(grepl("omercial Sexual",otros_problemas_de_atencion_de_salud_mental),1,0))%>%
    dplyr::mutate(otros_pr_sm_otros= ifelse(grepl("Otros",otros_problemas_de_atencion_de_salud_mental),1,0))%>%
    dplyr::mutate(otros_pr_sm_prision= ifelse(grepl("Prisionizaci?",otros_problemas_de_atencion_de_salud_mental),1,0))%>%
    dplyr::mutate(otros_pr_sm_vif= ifelse(grepl("Violencia Intrafamiliar",otros_problemas_de_atencion_de_salud_mental),1,0)) %>% 
    dplyr::mutate(dg_trs_cons_sus_or= dplyr::case_when(grepl("Consumo Perjudicial",diagnostico_trs_consumo_sustancia)~"Hazardous consumption",
                                                    grepl("Dependencia",diagnostico_trs_consumo_sustancia)~"Drug dependence",
                                                    TRUE~NA_character_)) %>%   

    dplyr::select(row, sexo_2, escolaridad_rec, freq_cons_sus_prin, tipo_de_plan_2, tipo_de_programa_2, edad_al_ing_grupos, sus_principal_mod, motivodeegreso_mod_imp, origen_ingreso_mod, dg_cie_10_rec, estado_conyugal_2, edad_ini_cons, cat_ocupacional, estatus_ocupacional, macrozona, nombre_region, tipo_centro,dias_treat_imp_sin_na, dg_fis_anemia, dg_fis_card, dg_fis_in_study, dg_fis_enf_som, dg_fis_ets, dg_fis_hep_alc, dg_fis_hep_b, dg_fis_hep_cro, dg_fis_inf, dg_fis_otr_cond_fis, dg_fis_otr_cond_fis_ries_vit, dg_fis_pat_buc, dg_fis_pat_ges_intrau, dg_fis_trau_sec, otros_pr_sm_abu_sex, otros_pr_sm_exp_com_sex, otros_pr_sm_otros, otros_pr_sm_prision, otros_pr_sm_vif,dg_trs_cons_sus_or,edad_ini_sus_prin_grupos)


label(CONS_C1_df_SEP_2020$sexo_2) <- "Sex"
label(CONS_C1_df_SEP_2020$escolaridad_rec) <- "Educational Attainment"
label(CONS_C1_df_SEP_2020$freq_cons_sus_prin) <- "Frequency of use of primary drug at admission"

label(CONS_C1_df_SEP_2020$tipo_de_plan_2) <- "Treatment Plan"
label(CONS_C1_df_SEP_2020$tipo_de_programa_2) <- "Treatment Program"
label(CONS_C1_df_SEP_2020$edad_al_ing_grupos) <- "Age at Admission"
label(CONS_C1_df_SEP_2020$sus_principal_mod) <- "Primary substance at admission"
label(CONS_C1_df_SEP_2020$motivodeegreso_mod_imp) <- "Motive of discharge"
label(CONS_C1_df_SEP_2020$origen_ingreso_mod) <- "Motive of Admission to Treatment (First Entry)"
label(CONS_C1_df_SEP_2020$dg_cie_10_rec) <- "Psychiatric comorbidity"


label(CONS_C1_df_SEP_2020$estado_conyugal_2) <- "Marital Status"
label(CONS_C1_df_SEP_2020$edad_ini_cons) <- "Age of Onset of Drug Use"
label(CONS_C1_df_SEP_2020$cat_ocupacional) <- "Occupational Category"
label(CONS_C1_df_SEP_2020$estatus_ocupacional) <- "Occupational Status"
label(CONS_C1_df_SEP_2020$macrozona) <- "Macrozones of the Center"
label(CONS_C1_df_SEP_2020$nombre_region) <- "Chilean Region of the Center"
label(CONS_C1_df_SEP_2020$tipo_centro) <- "Type of Center"
label(CONS_C1_df_SEP_2020$dias_treat_imp_sin_na) <- "Days of Treatment (missing dates of discharge were replaced with difference from 2019-11-13)"

label(CONS_C1_df_SEP_2020$dg_fis_anemia) <- "Physical Dg. Anemia"
label(CONS_C1_df_SEP_2020$dg_fis_card) <- "Physical Dg. Heart Disease"
label(CONS_C1_df_SEP_2020$dg_fis_in_study) <- "Physical Dg. Under Study"
label(CONS_C1_df_SEP_2020$dg_fis_enf_som) <- "Physical Dg. Somatic illnesses"
label(CONS_C1_df_SEP_2020$dg_fis_ets) <- "Physical Dg. STDs"
label(CONS_C1_df_SEP_2020$dg_fis_hep_alc) <- "Physical Dg. Alcoholic hepatitis"
label(CONS_C1_df_SEP_2020$dg_fis_hep_b) <- "Physical Dg. Hepatitis B"
label(CONS_C1_df_SEP_2020$dg_fis_hep_cro) <- "Physical Dg. Chronic hepatitis"
label(CONS_C1_df_SEP_2020$dg_fis_inf) <- "Physical Dg. Infectuous diseases"
label(CONS_C1_df_SEP_2020$dg_fis_otr_cond_fis_ries_vit) <- "Physical Dg. Other phsysical conditions"
label(CONS_C1_df_SEP_2020$dg_fis_otr_cond_fis) <- "Physical Dg. Other phsysical conditions"
label(CONS_C1_df_SEP_2020$dg_fis_pat_buc) <- "Physical Dg. Oral-care pathologies"
label(CONS_C1_df_SEP_2020$dg_fis_pat_ges_intrau) <- "Physical Dg. Development or Intrauterine"
label(CONS_C1_df_SEP_2020$dg_fis_trau_sec) <- "Traumatisms and disabling sequelae"

label(CONS_C1_df_SEP_2020$otros_pr_sm_abu_sex) <- "Other mental health problems- Sexual abuse"
label(CONS_C1_df_SEP_2020$otros_pr_sm_exp_com_sex) <- "Other mental health problems- Commercial sexual exploitation"
label(CONS_C1_df_SEP_2020$otros_pr_sm_otros) <- "Other mental health problems- Other"
label(CONS_C1_df_SEP_2020$otros_pr_sm_prision) <- "Other mental health problems- Inprisonment"
label(CONS_C1_df_SEP_2020$otros_pr_sm_vif) <- "Other mental health problems- Domestic violence"

label(CONS_C1_df_SEP_2020$dg_trs_cons_sus_or) <- "Diagnosis of substance use"

label(CONS_C1_df_SEP_2020$edad_ini_sus_prin_grupos) <- "Age of Onset of Drug Use Primary/Main Substance"

#   sexo_2 tipo_de_programa_2 tipo_de_plan_2 escolaridad_ultimo_ano_cursado
# diagnostico_trs_psiquiatrico_cie_10 x2_diagnostico_trs_psiquiatrico_cie_10 x3_diagnostico_trs_psiquiatrico_cie_10 motivodeegreso 

#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_
#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_
#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_
#CONS_C1_df_SEP_2020%>% janitor::tabyl(dg_cie_10_rec)
#CONS_C1_df_dup_JUL_2020%>% janitor::tabyl(tipo_de_programa_2)
#CONS_C1_df_dup_JUL_2020%>% janitor::tabyl(tipo_de_programa_2)

CONS_C1_df_dup_JUL_2020_explore<-
    CONS_C1_df_dup_JUL_2020%>% 
    #dplyr::mutate(treat= ifelse(row %in% unlist(CONS_C1_df_dup_JUL_2020_match_top_sel$row),1,0))%>%
      dplyr::mutate(origen_ingreso_mod= dplyr::case_when(grepl("Otro Centro Tratamiento",as.character(origen_ingreso_mod))~"Derivación Asistida", TRUE~as.character(origen_ingreso_mod)))%>%  
      dplyr::mutate(origen_ingreso_mod=factor(origen_ingreso_mod,labels=c('Spontaneous','Assisted Referral','Other','Justice Sector','Health Sector')))  %>% 
  #:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:  
  #CIE_10  
      dplyr::mutate(across(c(dg_trs_psiq_cie_10_or,x2_dg_trs_psiq_cie_10_or,x3_dg_trs_psiq_cie_10_or,x4_dg_trs_psiq_cie_10_or,x5_dg_trs_psiq_cie_10_or),~dplyr::case_when(grepl("En estudio",as.character(.))~0,grepl("Sin trastorno",as.character(.))~0,is.na(.)~0,TRUE~1), .names="dg_{col}"))%>%
      dplyr::mutate(dg_total_cie_10 = base::rowSums(dplyr::select(., dg_dg_trs_psiq_cie_10_or, dg_x2_dg_trs_psiq_cie_10_or, dg_x3_dg_trs_psiq_cie_10_or, dg_x4_dg_trs_psiq_cie_10_or, dg_x5_dg_trs_psiq_cie_10_or)))%>%  
      dplyr::mutate(across(c(dg_trs_psiq_cie_10_or,x2_dg_trs_psiq_cie_10_or,x3_dg_trs_psiq_cie_10_or,x4_dg_trs_psiq_cie_10_or,x5_dg_trs_psiq_cie_10_or),~dplyr::case_when(grepl("En estudio",as.character(.))~1,grepl("Sin trastorno",as.character(.))~0,is.na(.)~0,TRUE~0), .names="instudy_{col}"))%>%
      dplyr::mutate(instudy_total_cie_10 = base::rowSums(dplyr::select(., instudy_dg_trs_psiq_cie_10_or, instudy_x2_dg_trs_psiq_cie_10_or, instudy_x3_dg_trs_psiq_cie_10_or, instudy_x4_dg_trs_psiq_cie_10_or, instudy_x5_dg_trs_psiq_cie_10_or)))%>%
      dplyr::mutate(dg_cie_10_rec=dplyr::case_when(dg_total_cie_10>0 ~2,
                                             instudy_total_cie_10>0 & dg_total_cie_10==0~1,
                                             instudy_total_cie_10>0 & is.na(dg_total_cie_10)~1,
                                             TRUE~0))%>%
      dplyr::mutate(dg_cie_10_rec=as.factor(dg_cie_10_rec))%>%
      dplyr::mutate(dg_cie_10_rec=factor(dg_cie_10_rec,labels=c('Without psychiatric comorbidity','Diagnosis unknown (under study)', 'With psychiatric comorbidity'))) %>% 
      dplyr::mutate(macrozona=factor(macrozona, labels=c('Center',
                                                                   'North',
                                                                   'South'))) %>%
  #:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:  
  #Edad grupos  
        dplyr::mutate(edad_al_ing_grupos=dplyr::case_when(
      edad_al_ing>=50~"50+",
          edad_al_ing>=40~"40-49",
          edad_al_ing>=30~"30-39",
          edad_al_ing>=18~"18-29",
          edad_al_ing<18~"<18",
          TRUE~NA_character_)) %>%
  dplyr::mutate(edad_al_ing_grupos=as.factor(edad_al_ing_grupos)) %>%
  #:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:  
  #Tipo de programa
          dplyr::mutate(tipo_de_programa_2=dplyr::case_when(grepl("M-", tipo_de_plan_2)~"Women specific",
                                                        grepl("PG-", tipo_de_plan_2)~"General population",
                                                        grepl("LV", tipo_de_plan_2)~"Other")) %>% 
          dplyr::mutate(tipo_de_programa_2=as.factor(tipo_de_programa_2)) %>% 
  #:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:  
  #Sex
      dplyr::mutate(sexo_2=factor(sexo_2,labels=c('Men','Women'))) %>% 
  #:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:  
  #Cause of Discharge
  dplyr::mutate(motivodeegreso_mod_imp=factor(motivodeegreso_mod_imp,labels=c('Late Drop-out',
                                                                                  'Early Drop-out',
                                                                                  'Administrative discharge',
                                                                                  'Therapeutic discharge',
                                                                                  'Referral to another treatment',
                                                                                  'Ongoing treatment',
                                                                              'Death'))) %>% 
  #:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:  
  #frequency of consumption
  dplyr::mutate(freq_cons_sus_prin=factor(freq_cons_sus_prin,labels=c("1 day a week or less",
                                                                                  "2 to 3 days a week",
                                                                                  "4 to 6 days a week",
                                                                                  "Less than 1 day a week",
                                                                                  "Did not use",
                                                                                  "Daily"))) %>%     
  #:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:  
  #primary substance
    dplyr::mutate(sus_principal_mod=factor(sus_principal_mod,labels=c("Alcohol",
                                                                                  "Cocaine hydrochloride",
                                                                                  "Marijuana",
                                                                                  "Other",
                                                                                  "Cocaine paste"))) %>%   
  #:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:  
  #escolaridad rec
    dplyr::mutate(escolaridad_rec=factor(escolaridad_rec,labels=c('1-More than high school','2-Completed high school or less','3-Completed primary school or less')))  %>% 
  #:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:  
  #marital status
      dplyr::mutate(estado_conyugal_2=factor(estado_conyugal_2, labels=c('Married/Shared living arrangements','Separated/Divorced','Single','Widower'))) %>%  
  
  #:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:  
  #type of center (pub/priv)
  dplyr::mutate(tipo_centro=factor(tipo_centro, labels=c('Private','Public'))) %>%

  #:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:  
  #occupational status (inactive…)
  dplyr::mutate(estatus_ocupacional=factor(estatus_ocupacional, labels=c('Unemployed',
                                                                           'Employed',
                                                                           'Inactive'))) %>%
  dplyr::mutate(cat_ocupacional=factor(cat_ocupacional, labels=c('Salaried',
                                                                   'Self-employed',
                                                                   'Employer',
                                                                   'Unpaid family labour',
                                                                   'Other',
                                                                   'Volunteer worker'))) %>%
  #:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:  
  #age of onset of drug use
#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:  
  #physical diagnose

    dplyr::mutate(dg_fis_anemia= ifelse(grepl("Anemia",diagnostico_trs_fisico),1,0))%>%
    dplyr::mutate(dg_fis_card= ifelse(grepl("Cardiopat",diagnostico_trs_fisico),1,0))%>%
    dplyr::mutate(dg_fis_in_study= ifelse(grepl("En estudio",diagnostico_trs_fisico),1,0))%>%
    dplyr::mutate(dg_fis_enf_som= ifelse(grepl("somáticas",diagnostico_trs_fisico),1,0))%>%
    dplyr::mutate(dg_fis_ets= ifelse(grepl("ETS",diagnostico_trs_fisico),1,0))%>%
    dplyr::mutate(dg_fis_hep_alc= ifelse(grepl("Hepatitis alcohólica",diagnostico_trs_fisico),1,0))%>%
    dplyr::mutate(dg_fis_hep_b= ifelse(grepl("Hepatitis B",diagnostico_trs_fisico),1,0))%>%
    dplyr::mutate(dg_fis_hep_cro= ifelse(grepl("Hepatitis crónica",diagnostico_trs_fisico),1,0))%>%
    dplyr::mutate(dg_fis_inf= ifelse(grepl("Infecciosas relacionadas",diagnostico_trs_fisico),1,0))%>%
    dplyr::mutate(dg_fis_otr_cond_fis_ries_vit= ifelse(grepl("Condiciones de Riesgo Vital",diagnostico_trs_fisico),1,0))%>%
    dplyr::mutate(dg_fis_otr_cond_fis= ifelse(grepl("condiciones Fisicas Limitantes",diagnostico_trs_fisico),1,0))%>%
    dplyr::mutate(dg_fis_pat_buc= ifelse(grepl("Bucal",diagnostico_trs_fisico),1,0))%>%
    dplyr::mutate(dg_fis_pat_ges_intrau= ifelse(grepl("niño intrauterino",diagnostico_trs_fisico),1,0))%>%
    dplyr::mutate(dg_fis_trau_sec= ifelse(grepl("Traumatismos y secuelas",diagnostico_trs_fisico),1,0))%>%
    dplyr::mutate(otros_pr_sm_abu_sex= ifelse(grepl("Abuso Sexual",otros_probl_at_sm_or),1,0))%>%
    dplyr::mutate(otros_pr_sm_exp_com_sex= ifelse(grepl("omercial Sexual",otros_probl_at_sm_or),1,0))%>%
    dplyr::mutate(otros_pr_sm_otros= ifelse(grepl("Otros",otros_probl_at_sm_or),1,0))%>%
    dplyr::mutate(otros_pr_sm_prision= ifelse(grepl("Prisionalización",otros_probl_at_sm_or),1,0))%>%
    dplyr::mutate(otros_pr_sm_vif= ifelse(grepl("Violencia Intrafamiliar",otros_probl_at_sm_or),1,0)) %>% 
 
    dplyr::mutate(dg_trs_cons_sus_or= dplyr::case_when(grepl("Consumo Perjudicial",dg_trs_cons_sus_or)~"Hazardous consumption",
                                                   grepl("Dependencia",dg_trs_cons_sus_or)~"Drug dependence",
                                                   TRUE~NA_character_)) %>%   
#CONS_C1_df_dup_JUL_2020_explore%>% janitor::tabyl(sus_principal_mod)

  dplyr::select(row, sexo_2, escolaridad_rec, freq_cons_sus_prin, tipo_de_plan_2, tipo_de_programa_2, edad_al_ing_grupos, sus_principal_mod, motivodeegreso_mod_imp, origen_ingreso_mod, dg_cie_10_rec, estado_conyugal_2, edad_ini_cons, cat_ocupacional, estatus_ocupacional, macrozona, nombre_region, tipo_centro,dias_treat_imp_sin_na, dg_fis_anemia, dg_fis_card, dg_fis_in_study, dg_fis_enf_som, dg_fis_ets, dg_fis_hep_alc, dg_fis_hep_b, dg_fis_hep_cro, dg_fis_inf, dg_fis_otr_cond_fis_ries_vit, dg_fis_otr_cond_fis, dg_fis_pat_buc, dg_fis_pat_ges_intrau, dg_fis_trau_sec, otros_pr_sm_abu_sex, otros_pr_sm_exp_com_sex, otros_pr_sm_otros, otros_pr_sm_prision, otros_pr_sm_vif, dg_trs_cons_sus_or,edad_ini_sus_prin_grupos)
  
 #Frecuencia de consumo de la droga principal en los 30 días previos a la admisión a tratamiento

#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_
#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_
#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_

label(CONS_C1_df_dup_JUL_2020_explore$sexo_2) <- "Sex"
label(CONS_C1_df_dup_JUL_2020_explore$escolaridad_rec) <- "Educational Attainment"
label(CONS_C1_df_dup_JUL_2020_explore$freq_cons_sus_prin) <- "Frequency of use of primary drug at admission"

label(CONS_C1_df_dup_JUL_2020_explore$tipo_de_plan_2) <- "Treatment Plan"
label(CONS_C1_df_dup_JUL_2020_explore$tipo_de_programa_2) <- "Treatment Program"
label(CONS_C1_df_dup_JUL_2020_explore$edad_al_ing_grupos) <- "Age at Admission"
label(CONS_C1_df_dup_JUL_2020_explore$sus_principal_mod) <- "Primary substance at admission"
label(CONS_C1_df_dup_JUL_2020_explore$motivodeegreso_mod_imp) <- "Motive of discharge"
label(CONS_C1_df_dup_JUL_2020_explore$origen_ingreso_mod) <- "Motive of Admission to Treatment (First Entry)"
label(CONS_C1_df_dup_JUL_2020_explore$dg_cie_10_rec) <- "Psychiatric comorbidity"

label(CONS_C1_df_dup_JUL_2020_explore$estado_conyugal_2) <- "Marital Status"
label(CONS_C1_df_dup_JUL_2020_explore$edad_ini_cons) <- "Age of Onset of Drug Use"
label(CONS_C1_df_dup_JUL_2020_explore$cat_ocupacional) <- "Occupational Category"
label(CONS_C1_df_dup_JUL_2020_explore$estatus_ocupacional) <- "Occupational Status"
label(CONS_C1_df_dup_JUL_2020_explore$macrozona) <- "Macrozones of the Center"
label(CONS_C1_df_dup_JUL_2020_explore$nombre_region) <- "Chilean Region of the Center"
label(CONS_C1_df_dup_JUL_2020_explore$tipo_centro) <- "Type of Center"
label(CONS_C1_df_dup_JUL_2020_explore$dias_treat_imp_sin_na) <- "Days of Treatment (missing dates of discharge were replaced with difference from 2019-11-13)"

label(CONS_C1_df_dup_JUL_2020_explore$dg_fis_anemia) <- "Physical Dg. Anemia"
label(CONS_C1_df_dup_JUL_2020_explore$dg_fis_card) <- "Physical Dg. Heart Disease"
label(CONS_C1_df_dup_JUL_2020_explore$dg_fis_in_study) <- "Physical Dg. Under Study"
label(CONS_C1_df_dup_JUL_2020_explore$dg_fis_enf_som) <- "Physical Dg. Somatic illnesses"
label(CONS_C1_df_dup_JUL_2020_explore$dg_fis_ets) <- "Physical Dg. STDs"
label(CONS_C1_df_dup_JUL_2020_explore$dg_fis_hep_alc) <- "Physical Dg. Alcoholic hepatitis"
label(CONS_C1_df_dup_JUL_2020_explore$dg_fis_hep_b) <- "Physical Dg. Hepatitis B"
label(CONS_C1_df_dup_JUL_2020_explore$dg_fis_hep_cro) <- "Physical Dg. Chronic hepatitis"
label(CONS_C1_df_dup_JUL_2020_explore$dg_fis_inf) <- "Physical Dg. Infectuous diseases"
label(CONS_C1_df_dup_JUL_2020_explore$dg_fis_otr_cond_fis_ries_vit) <- "Physical Dg. Other phsysical conditions"
label(CONS_C1_df_dup_JUL_2020_explore$dg_fis_otr_cond_fis) <- "Physical Dg. Other phsysical conditions"
label(CONS_C1_df_dup_JUL_2020_explore$dg_fis_pat_buc) <- "Physical Dg. Oral-care pathologies"
label(CONS_C1_df_dup_JUL_2020_explore$dg_fis_pat_ges_intrau) <- "Physical Dg. Development or Intrauterine"
label(CONS_C1_df_dup_JUL_2020_explore$dg_fis_trau_sec) <- "Traumatisms and disabling sequelae"

label(CONS_C1_df_dup_JUL_2020_explore$otros_pr_sm_abu_sex) <- "Other mental health problems- Sexual abuse"
label(CONS_C1_df_dup_JUL_2020_explore$otros_pr_sm_exp_com_sex) <- "Other mental health problems- Commercial sexual exploitation"
label(CONS_C1_df_dup_JUL_2020_explore$otros_pr_sm_otros) <- "Other mental health problems- Other"
label(CONS_C1_df_dup_JUL_2020_explore$otros_pr_sm_prision) <- "Other mental health problems- Inprisonment"
label(CONS_C1_df_dup_JUL_2020_explore$otros_pr_sm_vif) <- "Other mental health problems- Domestic violence"

label(CONS_C1_df_dup_JUL_2020_explore$dg_trs_cons_sus_or) <- "Diagnosis of substance use"

#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_
#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_
library(compareGroups)

CONS_C1_df_SEP_2020_miss<-rbind(CONS_C1_df_dup_JUL_2020_explore,CONS_C1_df_SEP_2020) %>% 
  dplyr::mutate(selected=ifelse(row %in% unlist(CONS_C1_df_dup_JUL_2020$row),1,0))

knitr::opts_chunk$set(echo = FALSE, warning=FALSE, message=FALSE)

label(CONS_C1_df_SEP_2020_miss$sexo_2) <- "Sex"
label(CONS_C1_df_SEP_2020_miss$escolaridad_rec) <- "Educational Attainment"
label(CONS_C1_df_SEP_2020_miss$freq_cons_sus_prin) <- "Frequency of use of primary drug at admission"

label(CONS_C1_df_SEP_2020_miss$tipo_de_plan_2) <- "Treatment Plan"
label(CONS_C1_df_SEP_2020_miss$tipo_de_programa_2) <- "Treatment Program"
label(CONS_C1_df_SEP_2020_miss$edad_al_ing_grupos) <- "Age at Admission"
label(CONS_C1_df_SEP_2020_miss$sus_principal_mod) <- "Primary substance at admission"
label(CONS_C1_df_SEP_2020_miss$motivodeegreso_mod_imp) <- "Motive of discharge"
label(CONS_C1_df_SEP_2020_miss$origen_ingreso_mod) <- "Motive of Admission to Treatment (First Entry)"
label(CONS_C1_df_SEP_2020_miss$dg_cie_10_rec) <- "Psychiatric comorbidity"

label(CONS_C1_df_SEP_2020_miss$estado_conyugal_2) <- "Marital Status"
label(CONS_C1_df_SEP_2020_miss$edad_ini_cons) <- "Age of Onset of Drug Use"
label(CONS_C1_df_SEP_2020_miss$cat_ocupacional) <- "Occupational Category"
label(CONS_C1_df_SEP_2020_miss$estatus_ocupacional) <- "Occupational Status"
label(CONS_C1_df_SEP_2020_miss$macrozona) <- "Macrozones of the Center"
label(CONS_C1_df_SEP_2020_miss$nombre_region) <- "Chilean Region of the Center"
label(CONS_C1_df_SEP_2020_miss$tipo_centro) <- "Type of Center"
label(CONS_C1_df_SEP_2020_miss$dias_treat_imp_sin_na) <- "Days of Treatment (missing dates of discharge were replaced with difference from 2019-11-13)"

label(CONS_C1_df_SEP_2020_miss$dg_fis_anemia) <- "Physical Dg. Anemia"
label(CONS_C1_df_SEP_2020_miss$dg_fis_card) <- "Physical Dg. Heart Disease"
label(CONS_C1_df_SEP_2020_miss$dg_fis_in_study) <- "Physical Dg. Under Study"
label(CONS_C1_df_SEP_2020_miss$dg_fis_enf_som) <- "Physical Dg. Somatic illnesses"
label(CONS_C1_df_SEP_2020_miss$dg_fis_ets) <- "Physical Dg. STDs"
label(CONS_C1_df_SEP_2020_miss$dg_fis_hep_alc) <- "Physical Dg. Alcoholic hepatitis"
label(CONS_C1_df_SEP_2020_miss$dg_fis_hep_b) <- "Physical Dg. Hepatitis B"
label(CONS_C1_df_SEP_2020_miss$dg_fis_hep_cro) <- "Physical Dg. Chronic hepatitis"
label(CONS_C1_df_SEP_2020_miss$dg_fis_inf) <- "Physical Dg. Infectuous diseases"
label(CONS_C1_df_SEP_2020_miss$dg_fis_otr_cond_fis_ries_vit) <- "Physical Dg. Other phsysical conditions"
label(CONS_C1_df_SEP_2020_miss$dg_fis_otr_cond_fis) <- "Physical Dg. Other phsysical conditions"
label(CONS_C1_df_SEP_2020_miss$dg_fis_pat_buc) <- "Physical Dg. Oral-care pathologies"
label(CONS_C1_df_SEP_2020_miss$dg_fis_pat_ges_intrau) <- "Physical Dg. Development or Intrauterine"
label(CONS_C1_df_SEP_2020_miss$dg_fis_trau_sec) <- "Traumatisms and disabling sequelae"

label(CONS_C1_df_SEP_2020_miss$otros_pr_sm_abu_sex) <- "Other mental health problems- Sexual abuse"
label(CONS_C1_df_SEP_2020_miss$otros_pr_sm_exp_com_sex) <- "Other mental health problems- Commercial sexual exploitation"
label(CONS_C1_df_SEP_2020_miss$otros_pr_sm_otros) <- "Other mental health problems- Other"
label(CONS_C1_df_SEP_2020_miss$otros_pr_sm_prision) <- "Other mental health problems- Inprisonment"
label(CONS_C1_df_SEP_2020_miss$otros_pr_sm_vif) <- "Other mental health problems- Domestic violence"

label(CONS_C1_df_SEP_2020_miss$dg_trs_cons_sus_or) <- "Diagnosis of substance use"
label(CONS_C1_df_SEP_2020_miss$edad_ini_sus_prin_grupos) <- "Age of Onset of Drug Use Primary/Main Substance"

table <- suppressWarnings(compareGroups(selected ~ sexo_2+ escolaridad_rec+ freq_cons_sus_prin+ tipo_de_plan_2+ tipo_de_programa_2+ 
        edad_al_ing_grupos+  sus_principal_mod+  motivodeegreso_mod_imp+  origen_ingreso_mod+  dg_cie_10_rec+  estado_conyugal_2+  edad_ini_cons+ edad_ini_sus_prin_grupos+ cat_ocupacional+  estatus_ocupacional+  macrozona+  nombre_region+  tipo_centro+ dias_treat_imp_sin_na+ dg_fis_anemia+ dg_fis_card+ dg_fis_in_study+ dg_fis_enf_som+ dg_fis_ets+ dg_fis_hep_alc+ dg_fis_hep_b+ dg_fis_hep_cro+ dg_fis_inf+ dg_fis_otr_cond_fis_ries_vit+ dg_fis_otr_cond_fis+ dg_fis_pat_buc+ dg_fis_pat_ges_intrau+ dg_fis_trau_sec+ otros_pr_sm_abu_sex+ otros_pr_sm_exp_com_sex+ otros_pr_sm_otros+ otros_pr_sm_prision+ otros_pr_sm_vif+ dg_trs_cons_sus_or,
                       method= c(sexo_2=3,
                                      escolaridad_rec=3,
                                      freq_cons_sus_prin=3,
                                      tipo_de_plan_2=3,
                                      tipo_de_programa_2=3,
                                      edad_al_ing_grupos=3,
                                      sus_principal_mod=3,
                                      motivodeegreso_mod_imp=3,
                                      origen_ingreso_mod=3,
                                      dg_cie_10_rec=3,
                                      estado_conyugal_2=3,
                                      edad_ini_cons=2,
                                      edad_ini_sus_prin_grupos=3,
                                      cat_ocupacional=3,
                                      estatus_ocupacional=3,
                                      macrozona=3,
                                      nombre_region=3,
                                      tipo_centro=3,
                                      dias_treat_imp_sin_na=2,
                                      dg_fis_anemia= 3,
                                      dg_fis_card= 3,
                                      dg_fis_in_study= 3, 
                                      dg_fis_enf_som= 3, 
                                      dg_fis_ets= 3, 
                                      dg_fis_hep_alc= 3, 
                                      dg_fis_hep_b= 3, 
                                      dg_fis_hep_cro= 3, 
                                      dg_fis_inf= 3, 
                                      dg_fis_otr_cond_fis_ries_vit= 3,
                                      dg_fis_otr_cond_fis= 3,
                                      dg_fis_pat_buc= 3, 
                                      dg_fis_pat_ges_intrau= 3, 
                                      dg_fis_trau_sec= 3, 
                                      otros_pr_sm_abu_sex= 3, 
                                      otros_pr_sm_exp_com_sex= 3, 
                                      otros_pr_sm_otros= 3, 
                                      otros_pr_sm_prision= 3, 
                                      otros_pr_sm_vif=3,
                                      dg_trs_cons_sus_or=3),
                       data = CONS_C1_df_SEP_2020_miss,
                       include.miss = T,
                       var.equal=T
                       ))
 #Possible values are: 1 - forces analysis as "normal-distributed"; 2 - forces analysis as "continuous non-normal"; 3 - forces analysis as "categorical"; and 4 - NA, which performs a Shapiro-Wilks test to decide between normal or non-normal. 

pvals <- suppressWarnings(getResults(table))
#p.adjust(pvals, method = "BH")
restab <- suppressWarnings(createTable(table, show.p.overall = F))
 suppressWarnings(export2md(restab, size=9, first.strip=T, hide.no="no", position="center",
                            col.names=c("Variables","Discarded Entries", "Selected Entries"),
           format="html",caption= "Table 1. Summary descriptives table by groups, between selected rows (=1) and records that did not matched, duplicate treatments and invalid ones (=0)"))%>%
  kableExtra::add_footnote(c("Note. Variables of C1 dataset had to be standardized before comparison;", "Continuous variables are presented as Medians and Percentiles 25 and 75 were shown;", "Categorical variables are presented as number (%)"), notation = "none")%>%
  kableExtra::scroll_box(width = "100%", height = "375px")
```

<br>

As we can see in Table 1, there was a greater proportion of treatments of women and +50 users that were not available for selection. Also, among the non-selected treatments, there was a greater share of alcohol, but a lower rate of cocaine-paste as a primary substance at admission. Additionally, there was a greater proportion of therapeutic discharges and referrals, but a lower proportion of late and early drop-outs. Regarding the motives of admission to treatment, spontaneous motives had a lower percentage in comparison to the selected cases. For psychiatric comorbidity, there was a greater proportion of treatments with psychiatric comorbidity, but a lower proportion had a diagnosis under study. Another variable that was worth mentioning was occupational status, in which the inactive group had greater proportions among the non- selected group. The treatment lengths were greater in the non-selected treatments.

<br>

# Format the database

Person days are conceived as the difference in each user between the minimum date of admission (the first time that each patient was admitted between 2010 and 2019) and the maximum date of discharge (the last time that a patient was discharged from a treatment between 2010 and 2019).

<br>

```{r 1_contar repeticiones hash,eval=T, echo=T, paged.print=TRUE}                                                       
#** Ordena primero por hash key, y después por fecha de ingreso, 
#** desde el mas reciente al más nuevo.
#*dependiendo del signo que se le asigne a fecha de ingreso, 
#*es si será de menor (más antiguo) a mayor (más reciente) (+), o mayor a menor (-)
CONS_C1_df_dup_SEP_2020_prev<-
  CONS_C1_df_dup_JUL_2020 %>% 
    dplyr::arrange(hash_key,desc(fech_ing)) %>% 
#*eliminar a menores de 18?
    #dplyr::filter(edad_al_ing<18) %>% 
#*0.d. Contar cuántas veces se repite cada HASH
    dplyr::group_by(hash_key) %>% 
    dplyr::mutate(dup=row_number()) %>%
#*La ventaja de duplicates_filtered es que considera los perdidos
    dplyr::mutate(duplicates_filtered= n()) %>% 
#*obtener la última fecha en que registra la observación
    dplyr::mutate(startdate= dplyr::last(fech_ing_num), enddate= dplyr::first(fech_egres_num), 
                  person_days=enddate-startdate) %>% 
    dplyr::ungroup()
#+     #dplyr::arrange(hash_key, fech_ing) %>% 

label(CONS_C1_df_dup_SEP_2020_prev$dup) <- "Número de Tratamientos por HASH (posición a medida que aparecen, menor más reciente)/Number of Treatments by User"
label(CONS_C1_df_dup_SEP_2020_prev$duplicates_filtered) <- "Número de Tratamientos por HASH (Total)/Number of Treatments by User (Total)"
label(CONS_C1_df_dup_SEP_2020_prev$startdate) <- "Fecha de Ingreso Primer Tratamiento (x HASH)/Date of Admission to the First Treatment (By User)"
label(CONS_C1_df_dup_SEP_2020_prev$enddate) <-  "Fecha de Egreso del Último Tratamiento (x HASH)/ Date of Discharge of the Last Treatment (By User)"
label(CONS_C1_df_dup_SEP_2020_prev$person_days) <- "Días en los que estado un usuario en el sistema para el estudio/User's Days available in the system for the study"

invisible(
CONS_C1_df_dup_SEP_2020_prev %>% 
  dplyr::filter(duplicates_filtered>4,person_days>100) %>% 
  dplyr::select(hash_key, fech_ing, fech_ing_num, fech_egres_imp, fech_egres_num, person_days, dup, duplicates_filtered)
)

if(CONS_C1_df_dup_SEP_2020_prev %>% 
   dplyr::filter(person_days<0) %>% 
   nrow()>0){stop("There are still some cases with negative days of treatment")}
```

<br>

We selected the **first treatment of each user**, in order to make an individual overview of users and time available in the dataset.

<br>

```{r 2_alt_1_primer_trat_a_la_cabeza,eval=T, echo=T, paged.print=TRUE}                                                       
#*ALTERNATIVA 1= primer tratamiento a la cabeza
CONS_C1_df_dup_SEP_2020_prev2<-
  CONS_C1_df_dup_SEP_2020_prev %>% 
    dplyr::arrange(hash_key,fech_ing) %>% 
    dplyr::group_by(hash_key) %>% 
    dplyr::mutate(a_botar=ifelse(row_number()==1,NA_real_,1)) %>% 
    dplyr::ungroup()
CONS_C1_df_dup_SEP_2020_prev2%>% 
    janitor::tabyl(a_botar) %>% 
  
      knitr::kable(format= "html", format.args= list(decimal.mark= ".", big.mark= ","),
               caption="Table 2. First entries of each user",
               align= c("l",rep('c', 5)), col.names = c("Discarded","n","%", "Valid %"))%>%
  kableExtra::kable_styling(bootstrap_options = c("striped", "hover"),font_size= 8) 
#%>%  kableExtra::add_footnote("Note= Treatments that were ")

label(CONS_C1_df_dup_SEP_2020_prev2$a_botar) <- "Descarta tratamientos que no permitan ver la duración del usuario entre 2010-2019"
```

<br>

Next, we discarded posterior treatments, selecting `r CONS_C1_df_dup_SEP_2020_prev2%>%  dplyr::filter(is.na(a_botar) | a_botar != 1)%>% nrow()%>% formatC(big.mark=",")` records.

<br>

```{r 3_event,eval=T, echo=T, paged.print=TRUE}                                                       
#85048+17764+4853+1449+435+149+45+11+1+1
#En STATA entrega es en total 85,048 entradas
#0 |     67,284 = 
#1 |     17,764 =  
CONS_C1_df_dup_SEP_2020_prev3<-  
CONS_C1_df_dup_SEP_2020_prev2 %>% 
    dplyr::filter(is.na(a_botar)) %>% #nrow() 85,048, QUEDARME SÓLO CON LOS CASOS QUE SON IS.NA
    dplyr::mutate(event=ifelse(duplicates_filtered>1,1,0)) %>% 
      #dplyr::mutate(event=factor(event,labels=c("W/o Readmissions","W/Readmissions"))) %>% 
    dplyr::mutate(person_years=person_days/365.25)#%>% janitor::tabyl(event)
#table(CONS_C1_df_dup_SEP_2020_prev2$duplicates_filtered)
label(CONS_C1_df_dup_SEP_2020_prev3$event) <- "Segundo, Tercero o Tratamiento Posterior (1=Reingreso x HASH) /Posterior Treatment of Each User (1=Readmission)"
#**STSET
#stset person_days, failure(event==1) scale(365.25) id(row)
#stdescribe, weight
#**TOTAL INCIDENCE RATE
#egen sum_0 = total(person_days) if event==0
#egen sum_1 = total(person_days) if event==1
#egen sum_tot = total(person_days)
#codebook sum_0 sum_1 sum_tot
#tab _d if _d==1
#*cumulative incidence rate of readmission
#di %9.1f (r(N)/(sum_tot/365.25)*1000)

#table(CONS_C1_df_dup_SEP_2020_prev3$event)
#table(is.na(CONS_C1_df_dup_SEP_2020_prev3$person_days))

#http://www.columbia.edu/~cjd11/charles_dimaggio/DIRE/resources/R/packages.pdf
```

<br>

The total incidence rate was `r formatC(table(CONS_C1_df_dup_SEP_2020_prev3$event)[2]/(sum(CONS_C1_df_dup_SEP_2020_prev3$person_years))*1000,digits=1,format = "f")` readmissions per 1,000 person-years.

<br>

## Incidence rate of the first readmission by groups

<br>

We recoded the variables of cause of discharge, in order to account for early drop-out and late drop-out. Also we recoded the variables of main type of drug, in order to account for the main substance and comparisons between them: cocaine vs. alcohol, cocaine paste vs. alcohol, and marihuana vs. alcohol.

<br>


```{r tab3_recode_vars,eval=T, echo=T, paged.print=TRUE}                                 
CONS_C1_df_dup_SEP_2020_prev4<-
CONS_C1_df_dup_SEP_2020_prev3 %>% 
  dplyr::mutate(mot_egres_latewdl=dplyr::case_when(grepl("Tard",motivodeegreso_mod_imp)~"1.Late WDRL",
                                                        grepl("Terap",motivodeegreso_mod_imp)~"0.Therapeutic Disch.",TRUE~NA_character_)) %>% 
  dplyr::mutate(mot_egres_latewdl= factor(mot_egres_latewdl)) %>% 
  dplyr::mutate(mot_egres_earlywdl=dplyr::case_when(grepl("Temprano",motivodeegreso_mod_imp)~"1.Early WDRL",
                                                        grepl("Terap",motivodeegreso_mod_imp)~"0.Therapeutic Disch.",TRUE~NA_character_)) %>% 
  dplyr::mutate(mot_egres_earlywdl= as.factor(mot_egres_earlywdl)) %>% 
  dplyr::mutate(droga_rec_coc=dplyr::case_when(grepl("Coca",sus_principal_mod)~"1.Cocaine",
                                                        grepl("Alcohol",sus_principal_mod)~"0.Alcohol",
                                                        TRUE~NA_character_)) %>% 
  dplyr::mutate(droga_rec_coc=as.factor(droga_rec_coc)) %>% 
  dplyr::mutate(droga_rec_pbase=dplyr::case_when(grepl("Pasta",sus_principal_mod)~"1.Paste Base",
                                                        grepl("Alcohol",sus_principal_mod)~"0.Alcohol",
                                                        TRUE~NA_character_)) %>% 
  dplyr::mutate(droga_rec_pbase=as.factor(droga_rec_pbase)) %>% 
  dplyr::mutate(droga_rec_mar=dplyr::case_when(grepl("Mari",sus_principal_mod)~"1.Marijuana",
                                                        grepl("Alcohol",sus_principal_mod)~"0.Alcohol",
                                                        TRUE~NA_character_)) %>% 
  dplyr::mutate(droga_rec_mar=as.factor(droga_rec_mar)) %>% 
  ungroup()
```

<br>

We calculated the incidence-rate ratios of different groups and checked whether there was an association between the exposure and the rate of readmissions.

<br>

```{r tab4_irrs,eval=T, echo=T, paged.print=TRUE}                                 
#https://www.stata.com/features/tables-for-epidemiologists/
#https://www.stata.com/manuals/repitab.pdf
#ir event mot_egres_earlywdl _t
#ir is used with incidence-rate (incidence-density or person-time) data. It calculates point estimates and confidence intervals for the incidence-rate ratio (IRR) and incidence-rate difference (IRD), along with attributable or prevented fractions for the exposed and total population. iri is the immediate form of ir;

#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_
#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_
#table(CONS_C1_df_dup_SEP_2020_prev4$event,as.numeric(CONS_C1_df_dup_SEP_2020_prev4$mot_egres_earlywdl)-1)
 
irrs_early<-irrs(x="mot_egres_earlywdl" ,db="CONS_C1_df_dup_SEP_2020_prev4")
irrs_late<-irrs(x="mot_egres_latewdl" ,db="CONS_C1_df_dup_SEP_2020_prev4")

irrs_coc<-irrs(x="droga_rec_coc" ,db="CONS_C1_df_dup_SEP_2020_prev4")
irrs_pbas<-irrs(x="droga_rec_pbase" ,db="CONS_C1_df_dup_SEP_2020_prev4")
irrs_mar<-irrs(x="droga_rec_mar" ,db="CONS_C1_df_dup_SEP_2020_prev4")
```

<br>

Compared to users with therapeutic discharge as the cause of discharge, the incidence rate of readmission was `r round(as.numeric(irrs_early$estimate[1]),2)` (95% IC `r round(irrs_early$conf.int[1],2)`-`r round(irrs_early$conf.int[2],2)`) times higher for those that drop-out treatment before 3 months in treatment.

<br>

Compared to users with therapeutic discharge as the cause of discharge, the incidence rate of readmission was `r round(as.numeric(irrs_late$estimate[1]),2)` (95% IC `r round(irrs_late$conf.int[1],2)`-`r round(irrs_late$conf.int[2],2)`) times higher for those that dropped-out of treatment before 3 months in treatment.

<br>

Compared to those with alcohol as the main substance at admission, the cumulative incidence rate of readmission was `r round(as.numeric(irrs_coc$estimate[1]),2)` (IC95% `r round(irrs_coc$conf.int[1],2)`-`r round(irrs_coc$conf.int[2],2)`) times higher for those that dropped-out of treatment after 3 months in treatment.

<br>

Compared to those with alcohol as the main substance at admission, the cumulative incidence rate of readmission was `r round(as.numeric(irrs_pbas$estimate[1]),2)` (IC95% `r round(irrs_pbas$conf.int[1],2)`-`r round(irrs_pbas$conf.int[2],2)`) times higher for those using cocaine paste.

<br>

Compared to those with alcohol as the main substance at admission, there were non-significant differences in the cumulative incidence for those using marijuana in comparison to those using alcohol (p = `r round(irrs_mar$p.value,3)`).

<!--- (1.03 [IC95% 0.96- 1.10]). --->
<br>

## Time outside treatment

To calculate the average time outside treatment, we needed to drop cases that only had one treatment and keep those with more than one treatment.

<br>

Then, we had to order the dataset by HASHs and date of admission and date of discharge, and replace the date of discharge if it is greater than the next date of admission.

<br>


### Graphical representation

The following figures shows the Nelson-Aalen for the cumulative hazard of experiencing readmission in the study period.

<br>

```{r fig2_survplot_km_early_widthdrawal, dpi = 96, warning=F,message=F,fig.align='center', fig.cap="Figure 2. Cum. Hazards to Experience Readmission to SUD Treatment, by cause of Discharge", error=T,fig.width=8}
library(survminer)
fit_earlyw<- survfit(Surv(person_days, event==1) ~mot_egres_earlywdl, data=CONS_C1_df_dup_SEP_2020_prev4,
                   type ="fleming-harrington", conf.type = "log-log")
library(tidyverse)
library(lubridate)
library(ggfortify) 
fit_earlyw_na <- fit_earlyw %>% fortify %>% group_by(strata) %>% mutate(CumHaz = cumsum(n.event/n.risk))

#http://rstudio-pubs-static.s3.amazonaws.com/522481_5e55bec9c94044678e680a6d07e96a2e.html
#https://rstudio-pubs-static.s3.amazonaws.com/258589_cd197f86fb5548ac89d7bcffd4bc6afe.html
#http://pcool.dyndns.org:8080/statsbook/?page_id=513
#http://rstudio-pubs-static.s3.amazonaws.com/316989_83cbe556125645b698c9ff6cf88c4c1a.html
#https://cran.r-project.org/web/packages/survminer/readme/README.html
#https://docs.ufpr.br/~jlpadilha/CE077/Aulas/2.TecnicasNaoParametricas.pdf 
#http://www.columbia.edu/~sjm2186/EPIC_R/packages.pdf
ggsurvplot_earlyw<-
  ggsurvplot(fit_earlyw, 
           fun = "cumhaz",
           conf.int = TRUE,
           legend.labs = c("Therapeutic Disch.", "Early WDRL"), 
           risk.table = "abs_pct",
           #ncensor.plot = TRUE,
           ggtheme = theme_classic2(base_size=10),
           risk.table.y.text.col = F,
           risk.table.col="black",
           font.tickslab = c(10),
           risk.table.height = .2,
           risk.table.fontsize = 2.5,
           break.time.by = 365.25,
           pval = F,
           ylim=c(0,10),
           legend = c(0.88, 0.15), 
           legend.title="Cause of Disch.",
           xlab= "Time (in years)", 
           #cumevents=T,
           surv.connect = T,
           censor= F,
           xscale=  "d_y",
           palette = c("skyblue4","orangered4"))
ggsurvplot_earlyw
 # scale_y_continuous(breaks = sort(c(seq(0, 100, 10), 56)))
```

<br>

```{r fig3_survplot_km_late_widthdrawal, dpi = 96, warning=F,message=F,fig.align='center', fig.cap="Figure 3. Cum. Hazards to Experience Readmission to SUD Treatment, by cause of Discharge", error=T,fig.width=8}
library(survminer)
fit_latew<- survfit(Surv(person_days, event==1) ~mot_egres_latewdl, data=CONS_C1_df_dup_SEP_2020_prev4,
                   type ="fleming-harrington", conf.type = "log-log")
library(tidyverse)
library(lubridate)
library(ggfortify) 
fit_latew_na <- fit_latew %>% fortify %>% group_by(strata) %>% mutate(CumHaz = cumsum(n.event/n.risk))

#http://rstudio-pubs-static.s3.amazonaws.com/522481_5e55bec9c94044678e680a6d07e96a2e.html
#https://rstudio-pubs-static.s3.amazonaws.com/258589_cd197f86fb5548ac89d7bcffd4bc6afe.html
#http://pcool.dyndns.org:8080/statsbook/?page_id=513
#http://rstudio-pubs-static.s3.amazonaws.com/316989_83cbe556125645b698c9ff6cf88c4c1a.html
#https://cran.r-project.org/web/packages/survminer/readme/README.html
#https://docs.ufpr.br/~jlpadilha/CE077/Aulas/2.TecnicasNaoParametricas.pdf 
#http://www.columbia.edu/~sjm2186/EPIC_R/packages.pdf
ggsurvplot_latew<-
  ggsurvplot(fit_latew, 
           fun = "cumhaz",
           conf.int = TRUE,
           legend.labs = c("Therapeutic Disch.", "Late WDRL"), 
           risk.table = "abs_pct",
           #ncensor.plot = TRUE,
           ggtheme = theme_classic2(base_size=10),
           risk.table.y.text.col = F,
           risk.table.col="black",
           font.tickslab = c(10),
           risk.table.height = .2,
           risk.table.fontsize = 2.5,
           break.time.by = 365.25,
           pval = F,
           ylim=c(0,10),
           legend = c(0.88, 0.15), 
           legend.title="Cause of Disch.",
           xlab= "Time (in years)", 
           #cumevents=T,
           surv.connect = T,
           censor= F,
           xscale=  "d_y",
           palette = c("skyblue4","orangered4"))
ggsurvplot_latew
 # scale_y_continuous(breaks = sort(c(seq(0, 100, 10), 56)))
```

```{r fig4_survplot_coc, dpi = 96, warning=F,message=F,fig.align='center', fig.cap="Figure 4. Cum. Hazards to Experience Readmission to SUD Treatment, by Primary Substance At Admission", error=T,fig.width=8}
library(survminer)
fit_coc<- survfit(Surv(person_days, event==1) ~droga_rec_coc, data=CONS_C1_df_dup_SEP_2020_prev4,
                   type ="fleming-harrington", conf.type = "log-log")
library(tidyverse)
library(lubridate)
library(ggfortify) 
fit_coc_nelson_aalen <- fit_coc %>% fortify %>% group_by(strata) %>% mutate(CumHaz = cumsum(n.event/n.risk))

#http://rstudio-pubs-static.s3.amazonaws.com/522481_5e55bec9c94044678e680a6d07e96a2e.html
#https://rstudio-pubs-static.s3.amazonaws.com/258589_cd197f86fb5548ac89d7bcffd4bc6afe.html
#http://pcool.dyndns.org:8080/statsbook/?page_id=513
#http://rstudio-pubs-static.s3.amazonaws.com/316989_83cbe556125645b698c9ff6cf88c4c1a.html
#https://cran.r-project.org/web/packages/survminer/readme/README.html
#https://docs.ufpr.br/~jlpadilha/CE077/Aulas/2.TecnicasNaoParametricas.pdf 
#http://www.columbia.edu/~sjm2186/EPIC_R/packages.pdf
ggsurvplot_coc<-
  ggsurvplot(fit_coc, 
           fun = "cumhaz",
           conf.int = TRUE,
           legend.labs = c("Alcohol", "Cocaine"), 
           risk.table = "abs_pct",
           #ncensor.plot = TRUE,
           ggtheme = theme_classic2(base_size=10),
           risk.table.y.text.col = F,
           risk.table.col="black",
           font.tickslab = c(10),
           risk.table.height = .2,
           risk.table.fontsize = 2.5,
           break.time.by = 365.25,
           pval = F,
           ylim=c(0,10),
           legend = c(0.88, 0.15), 
           legend.title="Main Drug\nat Admission",
           xlab= "Time (in years)", 
           #cumevents=T,
           surv.connect = T,
           censor= F,
           xscale=  "d_y",
           palette = c("skyblue4","orangered4"))
 # scale_y_continuous(breaks = sort(c(seq(0, 100, 10), 56)))
ggsurvplot_coc
```

```{r fig5_survplot_km_coc, dpi = 96, warning=F,message=F,fig.align='center', fig.cap="Figure 5. Cum. Hazards to Experience Readmission to SUD Treatment, by Primary Substance At Admission", error=T,fig.width=8}
library(survminer)
fit_pbase<- survfit(Surv(person_days, event==1) ~droga_rec_pbase, data=CONS_C1_df_dup_SEP_2020_prev4,
                   type ="fleming-harrington", conf.type = "log-log")
library(tidyverse)
library(lubridate)
library(ggfortify) 
fit_pbase_nelson_aalen <- fit_pbase %>% fortify %>% group_by(strata) %>% mutate(CumHaz = cumsum(n.event/n.risk))

#http://rstudio-pubs-static.s3.amazonaws.com/522481_5e55bec9c94044678e680a6d07e96a2e.html
#https://rstudio-pubs-static.s3.amazonaws.com/258589_cd197f86fb5548ac89d7bcffd4bc6afe.html
#http://pcool.dyndns.org:8080/statsbook/?page_id=513
#http://rstudio-pubs-static.s3.amazonaws.com/316989_83cbe556125645b698c9ff6cf88c4c1a.html
#https://cran.r-project.org/web/packages/survminer/readme/README.html
#https://docs.ufpr.br/~jlpadilha/CE077/Aulas/2.TecnicasNaoParametricas.pdf 
#http://www.columbia.edu/~sjm2186/EPIC_R/packages.pdf
ggsurvplot_pbase<-
  ggsurvplot(fit_pbase, 
           fun = "cumhaz",
           conf.int = TRUE,
           legend.labs = c("Alcohol", "P.Base"), 
           risk.table = "abs_pct",
           #ncensor.plot = TRUE,
           ggtheme = theme_classic2(base_size=10),
           risk.table.y.text.col = F,
           risk.table.col="black",
           font.tickslab = c(10),
           risk.table.height = .2,
           risk.table.fontsize = 2.5,
           break.time.by = 365.25,
           pval = F,
           ylim=c(0,10),
           legend = c(0.88, 0.15), 
           legend.title="Main Drug\nat Admission",
           xlab= "Time (in years)", 
           #cumevents=T,
           surv.connect = T,
           censor= F,
           xscale=  "d_y",
           palette = c("skyblue4","orangered4"))
 # scale_y_continuous(breaks = sort(c(seq(0, 100, 10), 56)))
ggsurvplot_pbase
```

<br>

```{r fig6_survplot_km_mar, dpi = 96, warning=F,message=F,fig.align='center', fig.cap="Figure 6. Cum. Hazards to Experience Readmission to SUD Treatment, by Primary Substance At Admission", error=T,fig.width=8}
library(survminer)
fit_mar<- survfit(Surv(person_days, event==1) ~droga_rec_mar, data=CONS_C1_df_dup_SEP_2020_prev4,
                   type ="fleming-harrington", conf.type = "log-log")
library(tidyverse)
library(lubridate)
library(ggfortify) 
fit_mar_nelson_aalen <- fit_mar %>% fortify %>% group_by(strata) %>% mutate(CumHaz = cumsum(n.event/n.risk))

#http://rstudio-pubs-static.s3.amazonaws.com/522481_5e55bec9c94044678e680a6d07e96a2e.html
#https://rstudio-pubs-static.s3.amazonaws.com/258589_cd197f86fb5548ac89d7bcffd4bc6afe.html
#http://pcool.dyndns.org:8080/statsbook/?page_id=513
#http://rstudio-pubs-static.s3.amazonaws.com/316989_83cbe556125645b698c9ff6cf88c4c1a.html
#https://cran.r-project.org/web/packages/survminer/readme/README.html
#https://docs.ufpr.br/~jlpadilha/CE077/Aulas/2.TecnicasNaoParametricas.pdf 
#http://www.columbia.edu/~sjm2186/EPIC_R/packages.pdf
ggsurvplot_mar<-
  ggsurvplot(fit_mar, 
           fun = "cumhaz",
           conf.int = TRUE,
           legend.labs = c("Alcohol", "Marijuana"), 
           risk.table = "abs_pct",
           #ncensor.plot = TRUE,
           ggtheme = theme_classic2(base_size=10),
           risk.table.y.text.col = F,
           risk.table.col="black",
           font.tickslab = c(10),
           risk.table.height = .2,
           risk.table.fontsize = 2.5,
           break.time.by = 365.25,
           pval = F,
           ylim=c(0,10),
           legend = c(0.88, 0.15), 
           legend.title="Main Drug\nat Admission",
           xlab= "Time (in years)", 
           #cumevents=T,
           surv.connect = T,
           censor= F,
           xscale=  "d_y",
           palette = c("skyblue4","orangered4"))
 # scale_y_continuous(breaks = sort(c(seq(0, 100, 10), 56)))
ggsurvplot_mar
```


```{r tab4_surv_diff_bet_treat_motivodeegreso,eval=T, echo=T, paged.print=TRUE, eval=F}                                 
  #http://minato.sip21c.org/msb/man/ratedifference.html
library(fmsb)
diff_rate<- ratedifference(table(CONS_C1_df_dup_SEP_2020_prev4$event,as.numeric(CONS_C1_df_dup_SEP_2020_prev4$mot_egres_earlywdl)-1)[2],table(CONS_C1_df_dup_SEP_2020_prev4$event,as.numeric(CONS_C1_df_dup_SEP_2020_prev4$mot_egres_earlywdl)-1)[4],as.numeric(xtabs(person_days ~ mot_egres_earlywdl, data=CONS_C1_df_dup_SEP_2020_prev4)[2]),as.numeric(xtabs(person_days ~ mot_egres_earlywdl, data=CONS_C1_df_dup_SEP_2020_prev4)[1]), CRC=T, conf.level=0.95) 
 
library(survminer)
ggsurvplot(
   fit,                     # survfit object with calculated statistics.
   pval = TRUE,             # show p-value of log-rank test.
   conf.int = TRUE,         # show confidence intervals for 
                            # point estimaes of survival curves.
   conf.int.style = "step",  # customize style of confidence intervals
   xlab = "Time in days",   # customize X axis label.
   break.time.by = 200,     # break X axis in time intervals by 200.
   ggtheme = theme_light(), # customize plot and risk table with a theme.
   risk.table = "abs_pct",  # absolute number and percentage at risk.
  risk.table.y.text.col = T,# colour risk table text annotations.
  risk.table.y.text = FALSE,# show bars instead of names in text annotations
                            # in legend of risk table.
  ncensor.plot = TRUE,      # plot the number of censored subjects at time t
  surv.median.line = "hv",  # add the median survival pointer.
  legend.labs = 
    c("Male", "Female"),    # change legend labels.
  palette = 
    c("#E7B800", "#2E9FDF") # custom color palettes.
)

ggsurvplot(fit2, fun = "event", conf.int = TRUE,
           ggtheme = theme_bw())

#Fitting the survival model
survival_func=survfit(Surv(CONS_C1_df_dup_SEP_2020_prev3$person_years, CONS_C1_df_dup_SEP_2020_prev3$event== 1)~1)

#http://rstudio-pubs-static.s3.amazonaws.com/316989_83cbe556125645b698c9ff6cf88c4c1a.html
#https://thriv.github.io/biodatasci2018/r-survival.html
#http://si.biostat.washington.edu/sites/default/files/modules/SISCR_2018_11_all-2pp_0.pdf
#https://www.researchgate.net/profile/Claudia_Castro-Kuriss/publication/325390160_Analisis_de_Supervivencia_mediante_el_empleo_de_R/links/5b0aba27a6fdcc8c25333860/Analisis-de-Supervivencia-mediante-el-empleo-de-R.pdf?origin=publication_detail
#http://www.sthda.com/english/wiki/survival-analysis-basics

#SURVIVAL= Explores factors that are thought to influence the chance that the event occurs
#Datos censurados= pueden ser por distintas causas:
    #- El paciente no refirió un evento (la readmissión) durante el estudio, y no sabemos si el evento ocurrió después. ESTOS SON LOS QUE TENGO QUE DARLES UN DIFF TREAT HASTA EL DIA DE HOY. SIEMPRE Y CUANDO TENGAN MENOS DE 1095 DIAS PARA PERDIDOS EN FECHA DE EGRESO, Y NO ESTÉN TRUNCADOS A LA DERECHA PORQUE NO SE LES TERMINÓ EL PRIMER TRAT.
    #Esta censura puede ocurrir cuando un usuario abandona un estudio, se pierde el seguimiento o no experimenta el evento una vez finaliza el estudio
    #- Truncado a la derecha: quien se perdió por una razón. Truncado a la derecha
    #Las muestras con censura aleatoria se consideran generalmente censuradas por derecha debido a que se van incorporando progresivamente los tiempos de fallas de distintas unidades
    #Los eventos que no experimentaron el evento en el tiempo de estudio se les censurará hasta el último tiempo de registro
    # Una suposición menos restrictiva que la suposición de independencia entre Ci y Ti, pero que alcanza para que los métodos sean válidos, es “la censura independiente” o “censura no informativa”:la probabilidad de que un individuo sea censurado en el instante t0 no depende de que ese individuo tenga inusualmente alto (o bajo) riesgo de evento.
    #Censoring may arise in the following ways:
    ###a patient has not (yet) experienced the event of interest, such as relapse or death, within the study time period;
    ###a patient is lost to follow-up during the study period;
    ###a patient experiences a different event that makes further follow-up impossible.
    #This type of censoring, named right censoring, is handled in survival analysis.

#– Recurrence rate
survfit_days_new_treat<-survfit(Surv(diff_bet_treat, status) ~ motivodeegreso_mod_imp, 
                                data=CONS_C1_df_dup_JUN_2020%>% 
                                  dplyr::mutate(diff_nas_fech_egres= as.numeric(difftime(lubridate::ymd("2019-11-13"),fech_ing, units = "days")))%>%
                                  #dplyr::filter(is.na(fech_egres_imp))%>% dplyr::select(fech_ing,fech_egres_imp,diff_nas_fech_egres)
                                  dplyr::mutate(perdi_seguimiento=dplyr::case_when(is.na(fech_egres_imp)&diff_nas_fech_egres>=1095~1,TRUE~0))%>% 
                                  dplyr::filter(perdi_seguimiento==0)%>% #NI SIQUIERA TERMINARON EL PIMER EVNTO, Y LO MAS PROBABLE ES QUE NUNCA REGISTRARON FECHA DE TÉRMINO. ESTPS SI QUE SI DEBO SACARLOS.
                                  dplyr::mutate(no_tienen_ni_el_primer_evento=dplyr::case_when(is.na(fech_egres_imp)&diff_nas_fech_egres<1095~1,
                                                                                     TRUE~0))%>% 
                                 # dplyr::filter(no_tienen_ni_el_primer_evento==0)%>%#NO HAN TERMINADO EL TRATAMIENTO. CENSURA SIMPLE TIPO 1, PERO SE DIFERENCIA DE LOS QUE NUNCA LLEGARON SIQUIERA A TENER EL PRIMER EVENTO. POR ESO A ESOS CASOS DEBO SACARLOS. AUNQUE NO ESTOY SEGURO, PORQUE PUEDE QUE ESTOS CASOSO TAMBIÉN FORMEN PARTE ED LA CENSURA AUTOMATICA QUE HACE R.
                                  #LOS QUE TIENEN 
                                  dplyr::mutate(status=dplyr::case_when(!is.na(diff_bet_treat)~1,TRUE~0)), #censurar si no tienen fechas entre trat porque no tienen un siguiente
                                    #mutate(status=dplyr::case_when(!is.na(fech_egres_imp)~1,TRUE~0)), #censurar fechas de egreso ##se supone q este es más puro, no sé
                                type = "kaplan-meier", #The Kaplan-Meier curve is a nonparametric estimator of the survival distribution (i.e. the “estimation” component of the “test/estimation” approach to analysis of time-to-event data)
                                error = "tsiatis", conf.type = "log-log", conf.int = 0.95)
#So we only know that the patient survived AT LEAST 13 months, but we have no other information available about the patient's status.  This type of censoring (also known as "right censoring") makes linear regression an inappropriate way to analyze the data due to censoring bias.

#simple
#survfit_days_new_treat_simple<-survfit(Surv(diff_bet_treat, status) ~ motivodeegreso_mod_imp, 
#                                data=CONS_C1_df_dup_JUN_2020%>% mutate(status=dplyr::case_when(!is.na(diff_bet_treat)~1,TRUE~0))%>% data.frame())

#Utilizando esta información se compara si existe alguna diferencia de las curvas de supervivencia entre los estados 
#In order to determine if there is a statistically significant difference between the survival curves, we perform what is known as a log-rank test, which tests the following hypothesis:
##H0: There is no difference in the survival function between those who were on maintenance chemotherapy and those who weren't on maintenance chemotherapy.
##Ha: There is a difference in the survival function between those who were on maintenance chemotherapy and those who weren't on maintenance chemotherapy.
#También con la orden “survdiff”, podemos realizar un test de hipótesis no paramétrico que nos diga si la diferencia de la probabilidad de supervivencia entre subgrupos es significativa o no. En este caso lo sería, al obtener un p-value < 0,05, experimentando esas diferencias en las zonas Centro y Sur, que sería en donde deberíamos de realizar un estudio más en profundidad.
  invisible(  
  survdiff(Surv(diff_bet_treat, status) ~ motivodeegreso_mod_imp, data=CONS_C1_df_dup_JUN_2020%>% mutate(status=dplyr::case_when(!is.na(diff_bet_treat)~1,TRUE~0)), rho = 0)  
  )
  #Prueba log-rank
  invisible(  
  survdiff(Surv(diff_bet_treat, status) ~ motivodeegreso_mod_imp, data=CONS_C1_df_dup_JUN_2020%>% mutate(status=dplyr::case_when(!is.na(diff_bet_treat)~1,TRUE~0)), rho = 1) 
  )

#survfit_days_new_treat_simple
survfit_days_new_treat_dataframe<-summary(survfit_days_new_treat, times=seq(0, 3500, 100), print.rmean=T,digits=2)
#
data.table(survfit_days_new_treat_dataframe$table,keep.rownames = T)%>%
  knitr::kable(format= "html", format.args= list(decimal.mark= ".", big.mark= ","),
               caption="Table 3. Estimates related to the probability that an entry kept free of a posterior one",
               align= c("l",rep('c', 5)), col.names = c("Cause of Discharge","Records","n.max", "n.start","events","rmean","se(rmean)","median", "95%CI Lower","95%CI Upper"))%>%
  kable_classic(bootstrap_options = c("striped", "hover"),font_size= 8)%>%
        kableExtra::add_footnote(paste0("Note= Treatments that did not finished their first treatment were discarded (n=",CONS_C1_df_dup_JUN_2020%>% 
    dplyr::mutate(diff_nas_fech_egres= as.numeric(difftime(lubridate::ymd("2019-11-13"),fech_ing, units = "days")))%>%dplyr::mutate(perdi_seguimiento=dplyr::case_when(is.na(fech_egres_imp)&diff_nas_fech_egres>=1095~1,TRUE~0))%>%dplyr::filter(perdi_seguimiento==1)%>% nrow()%>% formatC(big.mark=","),"); Excluded cases with no cause of discharge (n=",CONS_C1_df_dup_JUN_2020%>% dplyr::mutate(diff_nas_fech_egres= as.numeric(difftime(lubridate::ymd("2019-11-13"),fech_ing, units = "days")))%>% dplyr::mutate(perdi_seguimiento=dplyr::case_when(is.na(fech_egres_imp)&diff_nas_fech_egres>=1095~1,TRUE~0))%>%  dplyr::filter(perdi_seguimiento==0)%>% dplyr::mutate(status=dplyr::case_when(!is.na(diff_bet_treat)~1,TRUE~0))%>% dplyr::filter(!is.na(diff_bet_treat),is.na(motivodeegreso_mod_imp))%>% nrow() %>% formatC(big.mark=","),")"), notation = "none")%>%
  kableExtra::scroll_box(width= "100%", height = "250x")

#median time to event (the time when half the records have an event).
#Even if median survival has been reached in a group, it might not be possible to calculate complete confidence intervals for those median values,
# just knowing the difference in median survival values doesn't necessarily tell you which is better for prognosis--then you have to specify which prognosis time you care about.
#The restricted mean (rmean) and its standard error se(rmean) are based on a truncated estimator. When the last censoring time is not random this quantity is occasionally of interest.
```

<br>

```{r fig2_survplot_motivoegreso,fig.width = 13, fig.width = 7, dpi = 96, warning=F,message=F,fig.align='center', fig.cap="Figure 2. Recurrence-free interval of a treatment according to cause of discharge of the first treatment", error=T, eval=F}

#El estimador de S es lo que se llama curva de supervivencia (“survival curve”). 
event="no"
if(event=="si"){
plot(mfit2, col=c(1,2,1,2), lty=c(2,2,1,1),
     mark.time=FALSE, lwd=2, xscale=12,
     xlab="Years post diagnosis", ylab="Probability in State")
legend(3000, .6, c("death:female", "death:male", "pcm:female", "pcm:male"),
         col=c(1,2,1,2), lty=c(1,1,2,2), lwd=2, bty='n')
}
plot(survfit_days_new_treat,
         xlab = "Days of difference with a posterior treatment",  conf.int = T,mark.time = F,
     ylab = "Ssurvival probability",
     col=c("yellow4","thistle","cornflowerblue","violetred3","gray20"), lwd=2) # 
legend("topright", c("Late Withdrawal", "Early Withdrawal", "Administrative Discharge", "Therapeutic Discharge","Referral"),
         col=c("yellow4","thistle","cornflowerblue","violetred3","gray20"), lty=c(1,1,1,1), lwd=2, bty='n')
mtext("Note. Users who did not finish their first treatment or did not show recurrence have been censored", side=1,size=.5,cex=.7,outer=F,at=1500,4)
```

<br>

# Descriptives at baseline

Bivariate descriptive analyses were conducted using student’s t, ANOVA, Wilcoxon or Kruskall-Wallis tests (two-tailed) for continuous data and chi-square tests for categorical data stratified with readmission status.
<!--- no es sólo t-test y chi-square --->

<br>

```{r tab2_descr_c1_baseline_vs._readmitted,dpi = 96, message=F, error=T,eval=T, warnings=F}
CONS_C1_df_dup_SEP_2020_prev4_explore<-
    CONS_C1_df_dup_SEP_2020_prev4%>%
    dplyr::ungroup() %>% 
    dplyr::mutate(event=ifelse(duplicates_filtered>1,1,0)) %>% 
    dplyr::mutate(person_years=person_days/365.25)%>% 
    #dplyr::mutate(treat= ifelse(row %in% unlist(CONS_C1_df_dup_JUL_2020_match_top_sel$row),1,0))%>%
      dplyr::mutate(origen_ingreso_mod= dplyr::case_when(grepl("Otro Centro Tratamiento",as.character(origen_ingreso_mod))~"Derivación Asistida", TRUE~as.character(origen_ingreso_mod)))

CONS_C1_df_dup_SEP_2020_prev4_explore$origen_ingreso_mod<-factor(CONS_C1_df_dup_SEP_2020_prev4_explore$origen_ingreso_mod,labels=c('Spontaneous','Assisted Referral','Other','Justice Sector','Health Sector'))

  #:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:  
  #CIE_10 
CONS_C1_df_dup_SEP_2020_prev4_explore<-
CONS_C1_df_dup_SEP_2020_prev4_explore %>% 
      dplyr::mutate(across(c(dg_trs_psiq_cie_10_or,x2_dg_trs_psiq_cie_10_or,x3_dg_trs_psiq_cie_10_or,x4_dg_trs_psiq_cie_10_or,x5_dg_trs_psiq_cie_10_or),~dplyr::case_when(grepl("En estudio",as.character(.))~0,grepl("Sin trastorno",as.character(.))~0,is.na(.)~0,TRUE~1), .names="dg_{col}"))%>%
      dplyr::mutate(dg_total_cie_10 = base::rowSums(dplyr::select(., dg_dg_trs_psiq_cie_10_or, dg_x2_dg_trs_psiq_cie_10_or, dg_x3_dg_trs_psiq_cie_10_or, dg_x4_dg_trs_psiq_cie_10_or, dg_x5_dg_trs_psiq_cie_10_or)))%>%  
      dplyr::mutate(across(c(dg_trs_psiq_cie_10_or,x2_dg_trs_psiq_cie_10_or,x3_dg_trs_psiq_cie_10_or,x4_dg_trs_psiq_cie_10_or,x5_dg_trs_psiq_cie_10_or),~dplyr::case_when(grepl("En estudio",as.character(.))~1,grepl("Sin trastorno",as.character(.))~0,is.na(.)~0,TRUE~0), .names="instudy_{col}"))%>%
      dplyr::mutate(instudy_total_cie_10 = base::rowSums(dplyr::select(., instudy_dg_trs_psiq_cie_10_or, instudy_x2_dg_trs_psiq_cie_10_or, instudy_x3_dg_trs_psiq_cie_10_or, instudy_x4_dg_trs_psiq_cie_10_or, instudy_x5_dg_trs_psiq_cie_10_or)))%>%
      dplyr::mutate(dg_cie_10_rec=dplyr::case_when(dg_total_cie_10>0 ~2,
                                             instudy_total_cie_10>0 & dg_total_cie_10==0~1,
                                             instudy_total_cie_10>0 & is.na(dg_total_cie_10)~1,
                                             TRUE~0))%>%
      dplyr::mutate(dg_cie_10_rec=as.factor(dg_cie_10_rec))

CONS_C1_df_dup_SEP_2020_prev4_explore$dg_cie_10_rec<-factor(CONS_C1_df_dup_SEP_2020_prev4_explore$dg_cie_10_rec,labels=c('Without psychiatric comorbidity','Diagnosis unknown (under study)', 'With psychiatric comorbidity'))

CONS_C1_df_dup_SEP_2020_prev4_explore$macrozona<-factor(CONS_C1_df_dup_SEP_2020_prev4_explore$macrozona, labels=c('Center', 'North', 'South'))
        
  #:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:  
  #Edad grupos
CONS_C1_df_dup_SEP_2020_prev4_explore<-
CONS_C1_df_dup_SEP_2020_prev4_explore %>% 
      dplyr::mutate(edad_al_ing_grupos=dplyr::case_when(
        edad_al_ing>=50~"50+",
        edad_al_ing>=40~"40-49",
        edad_al_ing>=30~"30-39",
        edad_al_ing>=18~"18-29",
        edad_al_ing<18~"<18",
        TRUE~NA_character_)) %>%
  dplyr::mutate(edad_al_ing_grupos=as.factor(edad_al_ing_grupos)) %>%  
  #:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:  
  #Tipo de programa
    dplyr::mutate(tipo_de_programa_2=dplyr::case_when(grepl("M-", tipo_de_plan_2)~"Women specific",
                                                  grepl("PG-", tipo_de_plan_2)~"General population",
                                                  grepl("LV", tipo_de_plan_2)~"Other")) %>% 
    dplyr::mutate(tipo_de_programa_2=as.factor(tipo_de_programa_2))
  #:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:  
  #Sex
CONS_C1_df_dup_SEP_2020_prev4_explore$sexo_2 <- factor(CONS_C1_df_dup_SEP_2020_prev4_explore$sexo_2,
                                                       labels=c('Men','Women'))
  #:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:  
  #Cause of Discharge

CONS_C1_df_dup_SEP_2020_prev4_explore$motivodeegreso_mod_imp <- factor(CONS_C1_df_dup_SEP_2020_prev4_explore$motivodeegreso_mod_imp,labels=c('Late Drop-out',
                                                                                  'Early Drop-out',
                                                                                  'Administrative discharge',
                                                                                  'Therapeutic discharge',
                                                                                  'Referral to another treatment',
                                                                                  'Ongoing treatment'))
  #:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:  
  #frequency of consumption
CONS_C1_df_dup_SEP_2020_prev4_explore$freq_cons_sus_prin <- factor(CONS_C1_df_dup_SEP_2020_prev4_explore$freq_cons_sus_prin,labels=c("1 day a week or more",
                                                                                  "2 to 3 days a week",
                                                                                  "4 to 6 days a week",
                                                                                  "Less than 1 day a week",
                                                                                  "Did not use",
                                                                                  "Daily"))
  #:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:  
  #primary substance
  CONS_C1_df_dup_SEP_2020_prev4_explore$sus_principal_mod <- 
    factor(CONS_C1_df_dup_SEP_2020_prev4_explore$sus_principal_mod, labels=c("Alcohol",
                                                                                  "Cocaine hydrochloride",
                                                                                  "Marijuana",
                                                                                  "Other",
                                                                                  "Cocaine paste"))
  #:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:  
  #escolaridad rec
  CONS_C1_df_dup_SEP_2020_prev4_explore$escolaridad_rec<-
  factor(CONS_C1_df_dup_SEP_2020_prev4_explore$escolaridad_rec,labels=c('1-More than high school','2-Completed high school or less','3-Completed primary school or less'))
  #:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:  
  #marital status
    CONS_C1_df_dup_SEP_2020_prev4_explore$estado_conyugal_2<-
      factor(CONS_C1_df_dup_SEP_2020_prev4_explore$estado_conyugal_2, 
             labels=c('Married/Shared living arrangements','Separated/Divorced','Single','Widower'))
  
  #:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:  
  #type of center (pub/priv)
  CONS_C1_df_dup_SEP_2020_prev4_explore$tipo_centro<-
  factor(CONS_C1_df_dup_SEP_2020_prev4_explore$tipo_centro, labels=c('Private','Public'))

  #:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:  
  #occupational status (inactive…)
  CONS_C1_df_dup_SEP_2020_prev4_explore$estatus_ocupacional<-
  factor(CONS_C1_df_dup_SEP_2020_prev4_explore$estatus_ocupacional, labels=c('Unemployed',
                                                                           'Employed',
                                                                           'Inactive'))
  CONS_C1_df_dup_SEP_2020_prev4_explore$cat_ocupacional<-
  factor(CONS_C1_df_dup_SEP_2020_prev4_explore$cat_ocupacional, labels=c('Salaried',
                                                                   'Self-employed',
                                                                   'Employer',
                                                                   'Unpaid family labour',
                                                                   'Other',
                                                                   'Volunteer worker'))
  #:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:  
  #age of onset of drug use
#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:  
  #physical diagnose
CONS_C1_df_dup_SEP_2020_prev4_explore<-
  CONS_C1_df_dup_SEP_2020_prev4_explore %>% 
    dplyr::mutate(dg_fis_anemia= ifelse(grepl("Anemia",diagnostico_trs_fisico),1,0))%>%
    dplyr::mutate(dg_fis_card= ifelse(grepl("Cardiopat",diagnostico_trs_fisico),1,0))%>%
    dplyr::mutate(dg_fis_in_study= ifelse(grepl("En estudio",diagnostico_trs_fisico),1,0))%>%
    dplyr::mutate(dg_fis_enf_som= ifelse(grepl("somáticas",diagnostico_trs_fisico),1,0))%>%
    dplyr::mutate(dg_fis_ets= ifelse(grepl("ETS",diagnostico_trs_fisico),1,0))%>%
    dplyr::mutate(dg_fis_hep_alc= ifelse(grepl("Hepatitis alcohólica",diagnostico_trs_fisico),1,0))%>%
    dplyr::mutate(dg_fis_hep_b= ifelse(grepl("Hepatitis B",diagnostico_trs_fisico),1,0))%>%
    dplyr::mutate(dg_fis_hep_cro= ifelse(grepl("Hepatitis crónica",diagnostico_trs_fisico),1,0))%>%
    dplyr::mutate(dg_fis_inf= ifelse(grepl("Infecciosas relacionadas",diagnostico_trs_fisico),1,0))%>%
    dplyr::mutate(dg_fis_otr_cond_fis_ries_vit= ifelse(grepl("Condiciones de Riesgo Vital",diagnostico_trs_fisico),1,0))%>%
    dplyr::mutate(dg_fis_otr_cond_fis= ifelse(grepl("condiciones Fisicas Limitantes",diagnostico_trs_fisico),1,0))%>%
    dplyr::mutate(dg_fis_pat_buc= ifelse(grepl("Bucal",diagnostico_trs_fisico),1,0))%>%
    dplyr::mutate(dg_fis_pat_ges_intrau= ifelse(grepl("niño intrauterino",diagnostico_trs_fisico),1,0))%>%
    dplyr::mutate(dg_fis_trau_sec= ifelse(grepl("Traumatismos y secuelas",diagnostico_trs_fisico),1,0))%>%
    dplyr::mutate(otros_pr_sm_abu_sex= ifelse(grepl("Abuso Sexual",otros_probl_at_sm_or),1,0))%>%
    dplyr::mutate(otros_pr_sm_exp_com_sex= ifelse(grepl("omercial Sexual",otros_probl_at_sm_or),1,0))%>%
    dplyr::mutate(otros_pr_sm_otros= ifelse(grepl("Otros",otros_probl_at_sm_or),1,0))%>%
    dplyr::mutate(otros_pr_sm_otros= ifelse(grepl("Prisionalización",otros_probl_at_sm_or),1,otros_pr_sm_otros))%>%
    dplyr::mutate(otros_pr_sm_vif= ifelse(grepl("Violencia Intrafamiliar",otros_probl_at_sm_or),1,0)) %>% 
    dplyr::mutate(dg_trs_cons_sus_or= factor(dplyr::case_when(grepl("Consumo Perjudicial",dg_trs_cons_sus_or)~"Hazardous consumption",grepl("Dependencia",dg_trs_cons_sus_or)~"Drug dependence",TRUE~NA_character_))) %>%   
  
    #:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:  
  #starting substance
  #Segunda Sustancia de Inicio(Sólo más frecuentes)	Second Starting Substance
  #Tercera Sustancia de Inicio(Sólo más frecuentes)	Third Starting Substance
  #Sustancia de Inicio (Sólo más frecuentes)	Starting Substance (Only more frequent)
  dplyr::mutate(sus_ini_mod_pb=dplyr::case_when(grepl("Past",sus_ini_3_mod)~"Paste Base",
                                                grepl("Past",sus_ini_2_mod)~"Paste Base",
                                                grepl("Past",sus_ini_mod)~"Paste Base",
                                                TRUE~NA_character_)) %>%
  dplyr::mutate(sus_ini_mod_oh=dplyr::case_when(grepl("Alcohol",sus_ini_3_mod)~"Alcohol",
                                                grepl("Alcohol",sus_ini_2_mod)~"Alcohol",
                                                grepl("Alcohol",sus_ini_mod)~"Alcohol",
                                                TRUE~NA_character_)) %>% 
  dplyr::mutate(sus_ini_mod_coc=dplyr::case_when(grepl("Coca",sus_ini_3_mod)~"Cocaine hydrochloride",
                                                grepl("Coca",sus_ini_2_mod)~"Cocaine hydrochloride",
                                                grepl("Coca",sus_ini_mod)~"Cocaine hydrochloride",
                                                TRUE~NA_character_)) %>%   
  dplyr::mutate(sus_ini_mod_mar=dplyr::case_when(grepl("Mari",sus_ini_3_mod)~"Marijuana",
                                                grepl("Mari",sus_ini_2_mod)~"Marijuana",
                                                grepl("Mari",sus_ini_mod)~"Marijuana",
                                                TRUE~NA_character_)) %>%   
  dplyr::mutate(sus_ini_mod_otr=dplyr::case_when(grepl("Ot",sus_ini_3_mod)~"Other",
                                                grepl("Ot",sus_ini_2_mod)~"Other",
                                                grepl("Ot",sus_ini_mod)~"Other",
                                                TRUE~NA_character_)) %>%
  dplyr::mutate(sus_ini_mod_mvv=dplyr::case_when(grepl("Other",sus_ini_mod_otr)~"Other",
                                                 grepl("Alcohol",sus_ini_mod_oh)~"Alcohol",
                                                 grepl("Marijuana",sus_ini_mod_mar)~"Marijuana",
                                                 grepl("Cocaine hydrochloride",sus_ini_mod_coc)~"Cocaine hydrochloride",
                                                grepl("Paste Base",sus_ini_mod_pb)~"Paste Base",
                                                TRUE~NA_character_)) %>%
  dplyr::mutate(sus_ini_mod_mvv=factor(sus_ini_mod_mvv,labels=c("Alcohol",
                                                                "Cocaine hydrochloride",
                                                                "Marijuana",
                                                                "Other",
                                                                "Cocaine paste"))) %>%   
  dplyr::mutate(con_quien_vive_rec=factor(con_quien_vive_rec,labels=c("With relatives",
                                                                "With couple and children",
                                                                "Other",
                                                                "Alone",
                                                                "With children only",
                                                                "With couple only"))) %>%  
  dplyr::mutate(hijos_trat_res=ifelse(num_hijos_trat_res_mod>0,1,0)) %>% 
  dplyr::mutate(hijos_trat_res=factor(hijos_trat_res,labels=c("Without children","With children")))


#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_
#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_
library(compareGroups)

knitr::opts_chunk$set(echo = FALSE, warning=FALSE, message=FALSE)

label(CONS_C1_df_dup_SEP_2020_prev4_explore$sexo_2) <- "Sex"
label(CONS_C1_df_dup_SEP_2020_prev4_explore$escolaridad_rec) <- "Educational Attainment"
label(CONS_C1_df_dup_SEP_2020_prev4_explore$freq_cons_sus_prin) <- "Frequency of use of primary drug at admission"
label(CONS_C1_df_dup_SEP_2020_prev4_explore$con_quien_vive_rec) <- 'People that Share Household with the User (Cohabitation Status)'
label(CONS_C1_df_dup_SEP_2020_prev4_explore$hijos_trat_res) <- 'Have Children in Treatment'


label(CONS_C1_df_dup_SEP_2020_prev4_explore$tipo_de_plan_2) <- "Treatment Plan"
label(CONS_C1_df_dup_SEP_2020_prev4_explore$tipo_de_programa_2) <- "Treatment Program"
label(CONS_C1_df_dup_SEP_2020_prev4_explore$edad_al_ing_grupos) <- "Age at Admission"
label(CONS_C1_df_dup_SEP_2020_prev4_explore$sus_principal_mod) <- "Primary substance at admission"
label(CONS_C1_df_dup_SEP_2020_prev4_explore$sus_ini_mod_mvv) <- "Starting Substance (Most vulnerable value)"
label(CONS_C1_df_dup_SEP_2020_prev4_explore$motivodeegreso_mod_imp) <- "Motive of discharge"
label(CONS_C1_df_dup_SEP_2020_prev4_explore$origen_ingreso_mod) <- "Motive of Admission to Treatment (First Entry)"
label(CONS_C1_df_dup_SEP_2020_prev4_explore$dg_cie_10_rec) <- "Psychiatric comorbidity"

label(CONS_C1_df_dup_SEP_2020_prev4_explore$estado_conyugal_2) <- "Marital Status"
label(CONS_C1_df_dup_SEP_2020_prev4_explore$edad_ini_cons) <- "Age of Onset of Drug Use"
label(CONS_C1_df_dup_SEP_2020_prev4_explore$cat_ocupacional) <- "Occupational Category"
label(CONS_C1_df_dup_SEP_2020_prev4_explore$estatus_ocupacional) <- "Occupational Status"
label(CONS_C1_df_dup_SEP_2020_prev4_explore$macrozona) <- "Macrozones of the Center"
label(CONS_C1_df_dup_SEP_2020_prev4_explore$nombre_region) <- "Chilean Region of the Center"
label(CONS_C1_df_dup_SEP_2020_prev4_explore$tipo_centro) <- "Type of Center"
label(CONS_C1_df_dup_SEP_2020_prev4_explore$dias_treat_imp_sin_na) <- "Days of Treatment (missing dates of discharge were replaced with difference from 2019-11-13)"

label(CONS_C1_df_dup_SEP_2020_prev4_explore$dg_fis_anemia) <- "Physical Dg. Anemia"
label(CONS_C1_df_dup_SEP_2020_prev4_explore$dg_fis_card) <- "Physical Dg. Heart Disease"
label(CONS_C1_df_dup_SEP_2020_prev4_explore$dg_fis_in_study) <- "Physical Dg. Under Study"
label(CONS_C1_df_dup_SEP_2020_prev4_explore$dg_fis_enf_som) <- "Physical Dg. Somatic illnesses"
label(CONS_C1_df_dup_SEP_2020_prev4_explore$dg_fis_ets) <- "Physical Dg. STDs"
label(CONS_C1_df_dup_SEP_2020_prev4_explore$dg_fis_hep_alc) <- "Physical Dg. Alcoholic hepatitis"
label(CONS_C1_df_dup_SEP_2020_prev4_explore$dg_fis_hep_b) <- "Physical Dg. Hepatitis B"
label(CONS_C1_df_dup_SEP_2020_prev4_explore$dg_fis_hep_cro) <- "Physical Dg. Chronic hepatitis"
label(CONS_C1_df_dup_SEP_2020_prev4_explore$dg_fis_inf) <- "Physical Dg. Infectuous diseases"
label(CONS_C1_df_dup_SEP_2020_prev4_explore$dg_fis_otr_cond_fis_ries_vit) <- "Physical Dg. Other phsysical conditions"
label(CONS_C1_df_dup_SEP_2020_prev4_explore$dg_fis_otr_cond_fis) <- "Physical Dg. Other phsysical conditions"
label(CONS_C1_df_dup_SEP_2020_prev4_explore$dg_fis_pat_buc) <- "Physical Dg. Oral-care pathologies"
label(CONS_C1_df_dup_SEP_2020_prev4_explore$dg_fis_pat_ges_intrau) <- "Physical Dg. Development or Intrauterine"
label(CONS_C1_df_dup_SEP_2020_prev4_explore$dg_fis_trau_sec) <- "Traumatisms and disabling sequelae"

label(CONS_C1_df_dup_SEP_2020_prev4_explore$otros_pr_sm_abu_sex) <- "Other mental health problems- Sexual abuse"
label(CONS_C1_df_dup_SEP_2020_prev4_explore$otros_pr_sm_exp_com_sex) <- "Other mental health problems- Commercial sexual exploitation"
label(CONS_C1_df_dup_SEP_2020_prev4_explore$otros_pr_sm_otros) <- "Other mental health problems- Other"
label(CONS_C1_df_dup_SEP_2020_prev4_explore$otros_pr_sm_vif) <- "Other mental health problems- Domestic violence"
label(CONS_C1_df_dup_SEP_2020_prev4_explore$edad_ini_sus_prin_grupos) <- "Age of Onset of Drug Use Primary/Main Substance"

label(CONS_C1_df_dup_SEP_2020_prev4_explore$dg_trs_cons_sus_or) <- "Diagnosis of substance use"

table2 <- suppressWarnings(compareGroups(event ~ sexo_2+ con_quien_vive_rec+ hijos_trat_res+ escolaridad_rec+ freq_cons_sus_prin+ tipo_de_plan_2+ tipo_de_programa_2+ edad_al_ing_grupos+  sus_principal_mod+ sus_ini_mod_mvv+ motivodeegreso_mod_imp+  origen_ingreso_mod+  dg_cie_10_rec+  estado_conyugal_2+  edad_ini_cons+  edad_ini_sus_prin_grupos+ cat_ocupacional+  estatus_ocupacional+  macrozona+  nombre_region+  tipo_centro+ dias_treat_imp_sin_na+ dg_fis_anemia+ dg_fis_card+ dg_fis_in_study+ dg_fis_enf_som+ dg_fis_ets+ dg_fis_hep_alc+ dg_fis_hep_b+ dg_fis_hep_cro+ dg_fis_inf+ dg_fis_otr_cond_fis_ries_vit+ dg_fis_otr_cond_fis+ dg_fis_pat_buc+ dg_fis_pat_ges_intrau+ dg_fis_trau_sec+ otros_pr_sm_abu_sex+ otros_pr_sm_exp_com_sex+ otros_pr_sm_otros+ otros_pr_sm_vif+ dg_trs_cons_sus_or, method= c(
                                            sexo_2=3,
                                            escolaridad_rec=3,
                                            freq_cons_sus_prin=3,
                                            hijos_trat_res=3,
                                            tipo_de_plan_2=3,
                                            tipo_de_programa_2=3,
                                            edad_al_ing_grupos=3,
                                            sus_principal_mod=3,
                                            sus_ini_mod_mvv=3,
                                            motivodeegreso_mod_imp=3,
                                            origen_ingreso_mod=3,
                                            dg_cie_10_rec=3,
                                            estado_conyugal_2=3,
                                            edad_ini_cons=2,
                                            edad_ini_sus_prin_grupos=3,
                                            cat_ocupacional=3,
                                            estatus_ocupacional=3,
                                            macrozona=3,
                                            nombre_region=3,
                                            tipo_centro=3,
                                            dias_treat_imp_sin_na=2,
                                            dg_fis_anemia= 3,
                                            dg_fis_card= 3,
                                            dg_fis_in_study= 3, 
                                            dg_fis_enf_som= 3, 
                                            dg_fis_ets= 3, 
                                            dg_fis_hep_alc= 3, 
                                            dg_fis_hep_b= 3, 
                                            dg_fis_hep_cro= 3, 
                                            dg_fis_inf= 3, 
                                            dg_fis_otr_cond_fis_ries_vit= 3,
                                            dg_fis_otr_cond_fis= 3,
                                            dg_fis_pat_buc= 3, 
                                            dg_fis_pat_ges_intrau= 3, 
                                            dg_fis_trau_sec= 3, 
                                            otros_pr_sm_abu_sex= 3, 
                                            otros_pr_sm_exp_com_sex= 3, 
                                            otros_pr_sm_otros= 3, 
                                            otros_pr_sm_vif=3,
                                            dg_trs_cons_sus_or=3),
                       data = CONS_C1_df_dup_SEP_2020_prev4_explore,
                       include.miss = T,
                       var.equal=T
                       )
)
 #Possible values are: 1 - forcvovvves analysis as "normal-distributed"; 2 - forces analysis as "continuous non-normal"; 3 - forces analysis as "categorical"; and 4 - NA, which performs a Shapiro-Wilks test to decide between normal or non-normal. 

pvals2 <- getResults(table2)
#p.adjust(pvals, method = "BH")
restab2 <- createTable(table2, show.p.overall = T)
 export2md(restab2, size=9, first.strip=T, hide.no="no", position="center",
           format="html",caption= "Table 4. Summary descriptives at baseline, between Users with more than one treatment (=1) and Users with only a single treatment (=0) from 2010-2019",col.names=c("Variables","Users w/ only one treatment", "Users w/ more than one treatment", "p-value"))%>%
  kableExtra::add_footnote(c("Note. Variables of C1 dataset had to be standardized before comparison;", "Continuous variables are presented as Medians and Percentiles 25 and 75 were shown;", "Categorical variables are presented as number (%)"), notation = "none")%>%
  kableExtra::scroll_box(width = "100%", height = "375px")
```


# Differences within users with more than one treatment

<br>

We selected the entries of users that had at least 2 treatments (n= `r  CONS_C1_df_dup_JUL_2020%>% dplyr::group_by(hash_key)%>% dplyr::mutate(n_hash=n())%>% dplyr::filter(n_hash>1)%>%  nrow()%>%  formatC(big.mark=",")`; users= `r CONS_C1_df_dup_JUL_2020%>% dplyr::group_by(hash_key)%>% dplyr::mutate(n_hash=n())%>% dplyr::filter(n_hash>1)%>% distinct(hash_key)%>% nrow()%>%  formatC(big.mark=",")`).

<br>

```{r fig8_hist_spaces_treatments2,eval=T, echo=T, paged.print=TRUE, fig.cap="Figure 7. Histogram of Diff Between Treatments", fig.align='center'}
p<-ggplot(CONS_C1_df_dup_JUL_2020,aes(x=diff_bet_treat), alpha=.7)+
  geom_histogram_interactive(bins=120)+
  #   geom_vline(aes(xintercept=30), color="darkred", linetype="dashed")+
  #   geom_vline(aes(xintercept=45), color="darkmagenta", linetype="solid")+
  #   geom_vline(aes(xintercept=60), color="darkblue", linetype="dotted")+
  #sjPlot::theme_sjplot2() +
  theme_bw()+
  #facet_wrap(~motivodeegreso_mod_imp)+
labs(y = "Frequency",x="Diff. Between Treatments")#+
# xlim(c(-1,2000))
tooltip_css <- "background-color:gray;color:white;font-style:italic;padding:10px;border-radius:10px 20px 10px 20px;"
ggiraph(code = {print(p)}, tooltip_extra_css = tooltip_css, tooltip_opacity = .75)
```

<br>

Summarizing by HASHs, the average treatment span between treatments among the readmitted cases (`r CONS_C1_df_dup_JUL_2020%>% dplyr::group_by(hash_key)%>% dplyr::mutate(n_hash=n())%>% dplyr::filter(n_hash>1)%>% distinct(hash_key) %>% nrow() %>%  formatC(big.mark = ",")`) was around `r CONS_C1_df_dup_JUL_2020%>% dplyr::group_by(hash_key)%>% dplyr::mutate(n_hash=n())%>% dplyr::filter(n_hash>1)%>%  dplyr::mutate(span_treat= diff_bet_treat/365.25)%>% dplyr::group_by(hash_key)%>% summarise(avg_span_treat= mean(span_treat,na.rm=T))%>% dplyr::ungroup()%>%  dplyr::summarise(avg_span_treat_tot= mean(avg_span_treat,na.rm=T))%>% as.numeric()%>% round(2)` years.

<br>

```{r fig8_bar_days_diff_bet_treat, eval=T, echo=T, fig.align='center', fig.cap="Figure 8. Average Cum. Differences Between Treatments, depending on the amount of treatments by User", paged.print=TRUE}

CONS_C1_df_dup_JUL_2020 %>% 
  dplyr::group_by(hash_key)%>%
  dplyr::mutate(n_hash=n())%>% 
  dplyr::filter(n_hash>1)%>%
  slice(1) %>% 
  ungroup() %>% 
  dplyr::select(starts_with("diff_bet_treat_")) %>%  #mean_cum_dias_trat_sin_na_1
  gather(option,value) %>%
  dplyr::mutate(option=dplyr::case_when(option=="diff_bet_treat_1"~"01",
                                        option=="diff_bet_treat_2"~"02",
                                        option=="diff_bet_treat_3"~"03",
                                        option=="diff_bet_treat_4"~"04",
                                        option=="diff_bet_treat_5"~"05",
                                        option=="diff_bet_treat_6"~"06",
                                        option=="diff_bet_treat_7"~"07",
                                        option=="diff_bet_treat_8"~"08",
                                        option=="diff_bet_treat_9"~"09",
                                        option=="diff_bet_treat_10"~"10")) %>% 
  ggplot(aes(x = factor(option), y=value,group=option)) +
  stat_summary(fun = mean, geom="bar", alpha=.8)+
  stat_summary(fun = median, geom="point")+
  stat_summary(fun = median,
                fun.min = function(x) quantile(x,.25), 
                fun.max = function(x) quantile(x,.75), 
               geom = "errorbar", width = 0.5)+
  labs(x="Number of Treatment of Each User", y="Difference Between Treatments",caption=paste0("Note. ",CONS_C1_df_dup_JUL_2020 %>% dplyr::group_by(hash_key)%>% dplyr::mutate(n_hash=n())%>%  dplyr::filter(n_hash>1)%>%slice(1) %>% nrow() %>%  formatC(big.mark=",")," users; Dots= Medians, Error bars= Percentiles 25 and 75"))+
  theme_classic2()
```

<br>

A view on the differences between treatments while considering the times each user had been readmitted from 2010-2019 showed that on average, the differences between the first and the second treatment were apparently greater than the rest. However, this difference also had a greater variability.

<br>

```{r fig9_bar_days_in_treatment, eval=T, echo=T, fig.align='center', fig.cap="Figure 9. Average Cum. Treatment Length, depending on the amount of treatments by User", paged.print=TRUE}

CONS_C1_df_dup_JUL_2020 %>% 
  dplyr::group_by(hash_key)%>%
  dplyr::mutate(n_hash=n())%>% 
  dplyr::filter(n_hash>1)%>%
  slice(1) %>% 
  ungroup() %>% 
  dplyr::select(starts_with("mean_cum_dias_trat_sin_na_")) %>%  #mean_cum_dias_trat_sin_na_1
  gather(option,value) %>%
  dplyr::mutate(option=dplyr::case_when(option=="mean_cum_dias_trat_sin_na_1"~"01",
                                        option=="mean_cum_dias_trat_sin_na_2"~"02",
                                        option=="mean_cum_dias_trat_sin_na_3"~"03",
                                        option=="mean_cum_dias_trat_sin_na_4"~"04",
                                        option=="mean_cum_dias_trat_sin_na_5"~"05",
                                        option=="mean_cum_dias_trat_sin_na_6"~"06",
                                        option=="mean_cum_dias_trat_sin_na_7"~"07",
                                        option=="mean_cum_dias_trat_sin_na_8"~"08",
                                        option=="mean_cum_dias_trat_sin_na_9"~"09",
                                        option=="mean_cum_dias_trat_sin_na_10"~"10")) %>% 
  ggplot(aes(x = factor(option), y=value,group= option)) +
      stat_summary(fun = mean, geom="bar",alpha=.8)+
    stat_summary(fun = median, geom="point")+
  stat_summary(fun.y = median,
                   fun.min = function(x) quantile(x,.25), 
               fun.max = function(x) quantile(x,.75), 
               geom = "errorbar", width = 0.5)+
  #geom_bar(stat = "identity")+
    #geom_errorbar() +
  labs(x="Number of Treatment of Each User", y="Avg. Cum. Days in Treatment",caption=paste0("Note. ",CONS_C1_df_dup_JUL_2020 %>% dplyr::group_by(hash_key)%>% dplyr::mutate(n_hash=n())%>%  dplyr::filter(n_hash>1)%>%slice(1) %>% nrow() %>%  formatC(big.mark=",")," users; Dots= Medians, Error bars= Percentiles 25 and 75"))+
  theme_classic2()
```

<br>

The average cumulative days in treatment tended to remain stable, independently of the amount of previous treatments.

<br>

# Consolidating a database for access

We first translated relevant categories, restricted some imputed dates that trespassed the study period (over 2019-11-13), standardized ICD-10 and DSM-IV sum of categories, corrected labels such as owning status of housing conditions, and generated a dummyfied version of every physical diagnostic and other mental health related problems into ones and zeros for each category, as well as the most vulnerable substance of the starting substances (if the user indicated more than one) (`sus_ini_mod_mvv`, "Paste Base">"Cocaine hydrochloride">"Marijuana">"Alcohol">"Other").
 
<br>

```{r c1_std_no_ocupar_BASE_DE_DATOS_ORIGINAL,echo=T, paged.print=TRUE, eval=F}
CONS_C1_df_SEP_2020<-
clean_names(CONS_C1_df) %>% 
    dplyr::filter(!row %in% unlist(CONS_C1_df_dup_JUL_2020$row)) %>% 
#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:  
  #escolaridad 
    dplyr::mutate(escolaridad_rec=ifelse(as.character(escolaridad_ultimo_ano_cursado)=="BASICA COMPLETA"|as.character(escolaridad_ultimo_ano_cursado)=="BASICA INCOMPLETA"|as.character(escolaridad_ultimo_ano_cursado)=="SIN ESTUDIOS","Ed Primaria Completa o Menor",as.character(escolaridad_ultimo_ano_cursado))) %>%
dplyr::mutate(escolaridad_rec=ifelse(escolaridad_rec=="MEDIA COMPLETA"|escolaridad_rec=="MEDIA INCOMPLETA","2-Ed Secundaria Completa o Menor",
    ifelse(escolaridad_rec=="NO SABE O NO SE APLICA",NA,
    ifelse(escolaridad_rec %in% c("TECNICA COMPLETA", "TECNICA INCOMPLETA", "UNIVERSITARIA COMPLETA O MAS", "UNIVERSITARIA INCOMPLETA"), "1-Mayor a Ed Secundaria",ifelse(
      escolaridad_rec=="Ed Primaria Completa o Menor","3-Ed Primaria Completa o Menor",escolaridad_rec))))) %>%
dplyr::mutate(escolaridad_rec=factor(escolaridad_rec,labels=c('1-More than high school','2-Completed high school or less','3-Completed primary school or less')))  %>% 

#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:  
  #frecuencia consumo sus principal 
      dplyr::mutate(freq_cons_sus_prin=ifelse(frecuencia_de_consumo_sustancia_principal== "Desconocida",NA,as.character(frecuencia_de_consumo_sustancia_principal))) %>% 

  #:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:  
  #tipo de plan 
      dplyr::mutate(tipo_de_plan_2=dplyr::recode(tipo_de_plan_2,"M-PAI2"= "M-PAI", "M-PR2"="M-PR","PG PAI 2"="PG-PAI", "Otro"="PG-PR", "CALLE"="PG-PR"))%>%

  #:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:  
  #fecha de nacimiento
  dplyr::mutate(fech_nac=lubridate::parse_date_time(stringi::stri_sub(id,-8,-1),"dmY")) %>% 

  #:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:  
  #edad al ingreso
  dplyr::mutate(edad_al_ing=lubridate::time_length(difftime(as.Date(fech_ing), as.Date(fech_nac)),"years")) %>% #AGREGADO EN APR 2020.
  dplyr::mutate(edad_al_ing=replace(edad_al_ing, is.na(edad), NA)) %>%

  #:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:  
  #Edad Inicio Sus Principal  
   dplyr::mutate(edad_ini_sus_prin_grupos=ifelse(edad_ini_sus_prin>=25,">=25",
                                                ifelse(edad_ini_sus_prin>18,"19-24",
                                                ifelse(edad_ini_sus_prin>15,"16-18",
                                                ifelse(edad_ini_sus_prin>0,"<=15",
                                                NA_character_)))))%>% 
    dplyr::mutate(edad_ini_sus_prin_grupos=as.factor(edad_ini_sus_prin_grupos)) %>%
  #:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:  
  #sus principal  
  dplyr::mutate(sus_principal= dplyr::recode(sustancia_principal,
                                             "Hipnóticos "= "Tranquilizantes e Hipnóticos",
                                             "Sedantes:  diazepam, Valium, clonazepam, Ravotril, alprazolam, adax, barbitúricos, fenobarbital." = "Tranquilizantes e Hipnóticos",
                                             "Anfetaminas"="Estimulante tipo anfetaminas",
                                             "Extasis"="Estimulante tipo anfetaminas",
                                             "Fenilciclidina"="Estimulante tipo anfetaminas",
                                             "Metanfetaminas y otros derivados"="Estimulante tipo anfetaminas",
                                             "Otros Estimulantes"="Estimulante tipo anfetaminas",
                                             "LSD"="Alucinógenos",
                                             "Otros Alucinógenos"="Alucinógenos",
                                             "Crack"="Pasta Base",
                                             "Heroína"="Opioides",
                                             "Metadona"="Opioides",
                                             "Otros Opioides Analgésicos: morfina, codeína, meperidina,  demerol, tramadol, tramal."="Opioides","Inhalables: neopren, GHB, óxido nitroso (gas hilarante), \"poppers\", solventes, gasolina, diluyente"="Inhalables","Esteroides Anabólicos"="Otros")) %>%
      dplyr::mutate(sus_principal_mod= dplyr::case_when(sus_principal!="Alcohol"&sus_principal!="Cocaína"&sus_principal!="Marihuana"&sus_principal!="Pasta Base"~"Otros",TRUE~as.character(sus_principal)))%>%

  #:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:  
  #dias_trat
      dplyr::mutate(fech_ing_num=as.numeric(as.Date(fech_ing)))%>%
      dplyr::mutate(fech_egres_num=as.numeric(as.Date(fech_egres)))%>%
      dplyr::mutate(fech_egres_num=ifelse(is.na(fech_egres),18213,fech_egres_num))%>% #equivalente a 2019-11-13
      dplyr::mutate(dias_treat_imp_sin_na=fech_egres_num-fech_ing_num)%>%
  
  #:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:  
  #dias tratamiento
      dplyr::mutate(dias_trat_alta_temprana=ifelse(dias_trat>=90,0,1)) %>%
      dplyr::mutate(dias_trat_alta_temprana=as.factor(dias_trat_alta_temprana)) %>%
      dplyr::mutate(dias_trat_alta_temprana= dplyr::recode(dias_trat_alta_temprana, "1"="Menos de 90 días", "0"="Mayor o igual a 90 días")) %>%
      dplyr::mutate(motivodeegreso_mod= ifelse(dias_trat_alta_temprana=="Menos de 90 días" & motivodeegreso=="Abandono", "Abandono Temprano",as.character(motivodeegreso))) %>% 
      dplyr::mutate(motivodeegreso_mod= ifelse(dias_trat_alta_temprana=="Mayor o igual a 90 días" & motivodeegreso=="Abandono", "Abandono Tardio",as.character(motivodeegreso_mod))) %>% 
  
  #:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:  
  #motivodeegreso_mod_imp
      dplyr::mutate(motivodeegreso_mod_imp=ifelse(dias_treat_imp_sin_na<1095 & is.na(fech_egres),"En curso",as.character(motivodeegreso_mod))) %>% 

  #:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:  
  #origen de ingreso
      dplyr::mutate(origen_ingreso=ifelse(as.character(origen_de_ingreso)=="Consulta Espontánea", "Consulta Espontánea",as.character(origen_de_ingreso))) %>%
      dplyr::mutate(origen_ingreso=ifelse(origen_ingreso=="Establecimiento Educacional"|origen_ingreso=="Otros"|origen_ingreso=="Trabajo (empresa o empleador)"|origen_ingreso=="Servicios Sociales u otros (iglesia, Mideplan, ser. comunitarios, etc.)", "Otros",origen_ingreso)) %>%
      dplyr::mutate(origen_ingreso=ifelse(origen_ingreso=="Juzgado con Competencia en Crimen"|origen_ingreso=="Juzgado de Garantía"|origen_ingreso=="Libertad Vigilada"|origen_ingreso=="Juzgado de Familia"|origen_ingreso=="Juzgado de Policía"|origen_ingreso=="Otros (fiscalía)","Sector Justicia",origen_ingreso)) %>%
      dplyr::mutate(origen_ingreso=ifelse(origen_ingreso=="Otros de la Red de Salud General Privado"|origen_ingreso=="Estab. de APS"|origen_ingreso=="Estab. de APS "|origen_ingreso=="Otros de la Red de Salud General Público", "Sector Salud", origen_ingreso)) %>%
      dplyr::mutate(origen_ingreso=ifelse(origen_ingreso=="Otro Centro Tratamiento Drogas"|origen_ingreso=="FONODROGAS"|origen_ingreso=="Previene","Otro Centro Tratamiento Drogas/FONODROGAS/Previene",origen_ingreso)) %>%
          
      dplyr::mutate(origen_ingreso_mod= dplyr::case_when(grepl("Otro Centro Tratamiento",as.character(origen_ingreso))~"Derivación Asistida", TRUE~as.character(origen_ingreso)))%>%  
      dplyr::mutate(origen_ingreso_mod=factor(origen_ingreso_mod,labels=c('Spontaneous','Assisted Referral','Other','Justice Sector','Health Sector')))  %>% 

  #:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:  
  #CIE_10
      dplyr::mutate(across(c(diagnostico_trs_psiquiatrico_cie_10,x2_diagnostico_trs_psiquiatrico_cie_10,x3_diagnostico_trs_psiquiatrico_cie_10),~dplyr::case_when(grepl("En estudio",as.character(.))~0,grepl("Sin trastorno",as.character(.))~0,is.na(.)~0,TRUE~1), .names="dg_{col}"))%>%
      dplyr::mutate(across(c(diagnostico_trs_psiquiatrico_cie_10,x2_diagnostico_trs_psiquiatrico_cie_10,x3_diagnostico_trs_psiquiatrico_cie_10),~dplyr::case_when(grepl("En estudio",as.character(.))~1,grepl("Sin trastorno",as.character(.))~0,is.na(.)~0,TRUE~0), .names="instudy_{col}"))%>%
      dplyr::mutate(instudy_total_cie_10 = base::rowSums(dplyr::select(., instudy_diagnostico_trs_psiquiatrico_cie_10, instudy_x2_diagnostico_trs_psiquiatrico_cie_10, instudy_x3_diagnostico_trs_psiquiatrico_cie_10)))%>%
      dplyr::mutate(dg_total_cie_10 = base::rowSums(dplyr::select(., dg_diagnostico_trs_psiquiatrico_cie_10, dg_x2_diagnostico_trs_psiquiatrico_cie_10, dg_x3_diagnostico_trs_psiquiatrico_cie_10)))%>%
      dplyr::mutate(dg_cie_10_rec=dplyr::case_when(dg_total_cie_10>0 ~2,
                                             instudy_total_cie_10>0 & dg_total_cie_10==0~1,
                                             instudy_total_cie_10>0 & is.na(dg_total_cie_10)~1,
                                             TRUE~0))%>%
      dplyr::mutate(dg_cie_10_rec=as.factor(dg_cie_10_rec))%>%
      dplyr::mutate(dg_cie_10_rec=factor(dg_cie_10_rec,labels=c('Without psychiatric comorbidity','Diagnosis unknown (under study)', 'With psychiatric comorbidity'))) %>% 
      dplyr::mutate(tipo_de_programa_2=dplyr::case_when(grepl("M-", tipo_de_plan_2)~"Women specific",
                                                        grepl("PG-", tipo_de_plan_2)~"General population",
                                                        grepl("LV", tipo_de_plan_2)~"Other")) %>% 
      dplyr::mutate(sexo_2=factor(sexo_2,labels=c('Men','Women'))) %>% 
      dplyr::mutate(edad_al_ing_grupos=dplyr::case_when(
      edad_al_ing>=50~"50+",
          edad_al_ing>=40~"40-49",
          edad_al_ing>=30~"30-39",
          edad_al_ing>=18~"18-29",
          edad_al_ing<18~"<18",
          TRUE~NA_character_)) %>%
      dplyr::mutate(edad_al_ing_grupos=as.factor(edad_al_ing_grupos)) %>%  
  #:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:  
  #Edad Inicio Sus Principal  
   dplyr::mutate(edad_ini_sus_prin_grupos=ifelse(edad_inicio_sustancia_principal>=25,">=25",
                                                ifelse(edad_inicio_sustancia_principal>18,"19-24",
                                                ifelse(edad_inicio_sustancia_principal>15,"16-18",
                                                ifelse(edad_inicio_sustancia_principal>0,"<=15",
                                                NA_character_)))))%>% 
    dplyr::mutate(edad_ini_sus_prin_grupos=as.factor(edad_ini_sus_prin_grupos)) %>%
  #:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:  
  #Cause of discharge
      dplyr::mutate(motivodeegreso_mod_imp=factor(motivodeegreso_mod_imp,labels=c('Late Drop-out',
                                                                                  'Early Drop-out',
                                                                                  'Administrative discharge',
                                                                                  'Therapeutic discharge',
                                                                                  'Referral to another treatment',
                                                                                  'Ongoing treatment'))) %>% 
  #:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:  
  #frequency of consumption
  dplyr::mutate(freq_cons_sus_prin=factor(freq_cons_sus_prin,labels=c("1 day a week or more",
                                                                                  "2 to 3 days a week",
                                                                                  "4 to 6 days a week",
                                                                                  "Less than 1 day a week",
                                                                                  "Did not use",
                                                                                  "Daily"))) %>%     
  #:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:  
  #primary substance
    dplyr::mutate(sus_principal_mod=factor(sus_principal_mod,labels=c("Alcohol",
                                                                                  "Cocaine hydrochloride",
                                                                                  "Marijuana",
                                                                                  "Other",
                                                                                  "Cocaine paste"))) %>%   
  #:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:  
  #marital status
    dplyr::mutate(estado_conyugal_2=ifelse(as.character(estado_conyugal)=="Casado"|as.character(estado_conyugal)=="Conviviente"|as.character(estado_conyugal)=="conviviente civil", "Casado/Conviviente",stringr::str_trim(as.character(estado_conyugal)))) %>%
    dplyr::mutate(estado_conyugal_2=ifelse(estado_conyugal_2=="Separado"|estado_conyugal_2=="Divorciado"|estado_conyugal_2=="Anulado", "Separado/Divorciado",estado_conyugal_2)) %>% 
    dplyr::mutate(estado_conyugal_2=ifelse(estado_conyugal_2=="Nocontesta",NA,estado_conyugal_2)) %>%
    #dplyr::mutate(estado_conyugal=factor(estado_conyugal, labels=c('asd','asda'))) %>%
    dplyr::mutate(estado_conyugal_2=factor(estado_conyugal_2, labels=c('Married/Shared living arrangements','Separated/Divorced','Single','Widower'))) %>%
  
  #:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:  
  #region
   dplyr::mutate(macrozona=as.factor(dplyr::recode(region_del_centro,
                                              "DE ANTOFAGASTA"="Norte",
                                              "DE LA ARAUCANIA"="Sur",
                                              "DE ARICA Y PARINACOTA"="Norte",
                                              "DE ATACAMA"="Norte",
                                              "DE AYSEN DEL GENERAL CARLOS IBA?S DEL CAMPO"="Sur",
                                              "DEL BIO-BIO"="Centro",
                                              "DE COQUIMBO"="Norte",
                                              "DE LOS LAGOS"="Sur",
                                              "DE LOS RIOS"="Sur",
                                              "DE MAGALLANES Y LA ANTARTICA CHILENA"="Sur",
                                              "DEL MAULE"="Centro",
                                              "METROPOLITANA"="Centro",
                                              "DE ?BLE"="Centro",
                                              "DEL LIBERTADOR GENERAL  BERNARDO OHIGGINS"="Centro",
                                              "DE TARAPACA"="Norte",
                                              "DE VALPARAISO"="Centro")))%>%
  dplyr::mutate(macrozona=factor(macrozona, labels=c('Center',
                                                                   'North',
                                                                   'South'))) %>%
  dplyr::mutate(nombre_region=as.factor(dplyr::recode(region_del_centro,
                                              "DE ANTOFAGASTA"="Antofagasta (02)",
                                              "DE LA ARAUCANIA"="Araucanía (09)",
                                              "DE ARICA Y PARINACOTA"="Arica (15)",
                                              "DE ATACAMA"="Atacama (03)",
                                              "DE AYSEN DEL GENERAL CARLOS IBA?S DEL CAMPO"="Aysén (11)",
                                              "DEL BIO-BIO"="Biobío (08)",
                                              "DE COQUIMBO"="Coquimbo (04)",
                                              "DE LOS LAGOS"="Los Lagos (10)",
                                              "DE LOS RIOS"="Los Ríos (14)",
                                              "DE MAGALLANES Y LA ANTARTICA CHILENA"="Magallanes (12)",
                                              "DEL MAULE"="Maule (07)",
                                              "METROPOLITANA"="Metropolitana (13)",
                                              "DE ?BLE"="Ñuble (16)",
                                              "DEL LIBERTADOR GENERAL  BERNARDO OHIGGINS"="O'Higgins (06)",
                                              "DE TARAPACA"="Tarapacá (01)",
                                              "DE VALPARAISO"="Valparaíso (05)")))%>%
  #:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:  
  #type of center (pub/priv)
  dplyr::mutate(tipo_centro=factor(tipo_centro, labels=c('Private','Public'))) %>%
  dplyr::mutate(nombre_region=factor(nombre_region)) %>% 
  dplyr::mutate(macrozona=factor(macrozona)) %>% 
  
  #:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:  
  #occupational status (inactive…)
  dplyr::mutate(estatus_ocupacional=ifelse(condicion_ocupacional=="Trabajando actualmente","Empleado",
                                           ifelse(condicion_ocupacional=="Buscando trabajo por primera vez"|condicion_ocupacional=="Cesante","Desempleado","Inactivo"))) %>%
  dplyr::mutate(estatus_ocupacional=factor(estatus_ocupacional, labels=c('Unemployed',
                                                                         'Employed',
                                                                         'Inactive'))) %>%
      #Comprende la relación entre una persona económicamente activa y su trabajo o empleo. Sólo se aplica aquellas personas que se encuentran trabajando al momento de ingresar a tratamiento (las que respondieron 1 en la pregunta anterior). Para las personas que no están trabajando (estudiantes, cesante, etc.) esta opción estará bloqueada.
      #data.table(table(CONS_C1_df_dup_ENE_2020_prev3$Categoría.Ocupacional))
  dplyr::mutate(cat_ocupacional=ifelse(condicion_ocupacional!="Trabajando actualmente",NA,as.character(categoria_ocupacional)))%>%
  dplyr::mutate(cat_ocupacional=as.factor(cat_ocupacional)) %>%
  dplyr::mutate(cat_ocupacional=factor(cat_ocupacional, labels=c('Salaried',
                                                                             'Self-employed',
                                                                             'Employer',
                                                                             'Unpaid family labour',
                                                                             'Other',
                                                                             'Volunteer worker'))) %>%

  #:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:  
  #age of onset of drug use
  dplyr::mutate(edad_ini_cons= ifelse(edad_inicio_consumo<=edad_al_ing, edad_inicio_consumo, NA)) %>%
  dplyr::mutate(edad_ini_cons= ifelse(edad_ini_cons<5,NA,edad_ini_cons)) %>%

  #:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:  
  #physical diagnose
  dplyr::mutate(dg_fis_anemia= ifelse(grepl("Anemia",diagnostico_trs_fisico),1,0))%>%
  dplyr::mutate(dg_fis_card= ifelse(grepl("Cardiopat",diagnostico_trs_fisico),1,0))%>%
  dplyr::mutate(dg_fis_in_study= ifelse(grepl("En estudio",diagnostico_trs_fisico),1,0))%>%
  dplyr::mutate(dg_fis_enf_som= ifelse(grepl("somáticas",diagnostico_trs_fisico),1,0))%>%
  dplyr::mutate(dg_fis_ets= ifelse(grepl("ETS",diagnostico_trs_fisico),1,0))%>%
  dplyr::mutate(dg_fis_hep_alc= ifelse(grepl("Hepatitis alcohólica",diagnostico_trs_fisico),1,0))%>%
  dplyr::mutate(dg_fis_hep_b= ifelse(grepl("Hepatitis B",diagnostico_trs_fisico),1,0))%>%
  dplyr::mutate(dg_fis_hep_cro= ifelse(grepl("Hepatitis crónica",diagnostico_trs_fisico),1,0))%>%
  dplyr::mutate(dg_fis_inf= ifelse(grepl("Infecciosas relacionadas",diagnostico_trs_fisico),1,0))%>%
  dplyr::mutate(dg_fis_otr_cond_fis_ries_vit= ifelse(grepl("Condiciones de Riesgo Vital",diagnostico_trs_fisico),1,0))%>%
  dplyr::mutate(dg_fis_otr_cond_fis= ifelse(grepl("condiciones Fisicas Limitantes",diagnostico_trs_fisico),1,0))%>%
  dplyr::mutate(dg_fis_pat_buc= ifelse(grepl("Bucal",diagnostico_trs_fisico),1,0))%>%
  dplyr::mutate(dg_fis_pat_ges_intrau= ifelse(grepl("niño intrauterino",diagnostico_trs_fisico),1,0))%>%
  dplyr::mutate(dg_fis_trau_sec= ifelse(grepl("Traumatismos y secuelas",diagnostico_trs_fisico),1,0))%>%
  dplyr::mutate(otros_pr_sm_abu_sex= ifelse(grepl("Abuso Sexual",otros_problemas_de_atencion_de_salud_mental),1,0))%>%
  dplyr::mutate(otros_pr_sm_exp_com_sex= ifelse(grepl("omercial Sexual",otros_problemas_de_atencion_de_salud_mental),1,0))%>%
  dplyr::mutate(otros_pr_sm_otros= ifelse(grepl("Otros",otros_problemas_de_atencion_de_salud_mental),1,0))%>%
  dplyr::mutate(otros_pr_sm_prision= ifelse(grepl("Prisionizaci?",otros_problemas_de_atencion_de_salud_mental),1,0))%>%
  dplyr::mutate(otros_pr_sm_vif= ifelse(grepl("Violencia Intrafamiliar",otros_problemas_de_atencion_de_salud_mental),1,0)) %>% 
  dplyr::mutate(dg_trs_cons_sus_or= dplyr::case_when(grepl("Consumo Perjudicial",diagnostico_trs_consumo_sustancia)~"Hazardous consumption",
                                                  grepl("Dependencia",diagnostico_trs_consumo_sustancia)~"Drug dependence",
                                                  TRUE~NA_character_)) 
```

```{r cons1_sep_MODIFICACION_FINAL,echo=T, paged.print=TRUE, eval=T}
#CONS_C1_df_dup_SEP_2020 %>% summarise(mean=mean(dias_treat_imp_sin_na),mdn=median(dias_treat_imp_sin_na),p25=quantile(dias_treat_imp_sin_na,.25),p75=quantile(dias_treat_imp_sin_na,.75))
#   mean   mdn   p25   p75
#  <dbl> <dbl> <dbl> <dbl>
##  215.   164    90   290
CONS_C1_df_dup_JUL_2020 %>% 
  dplyr::arrange(hash_key,fech_ing) %>% 
  dplyr::group_by(hash_key) %>% 
  dplyr::mutate(dup=row_number()) %>%
  #*La ventaja de duplicates_filtered es que considera los perdidos
  dplyr::mutate(duplicates_filtered= n()) %>% 
  #*obtener la última fecha en que registra la observación
  dplyr::ungroup() %>% 
  dplyr::mutate(a_botar=ifelse(dup==1,1,NA_real_)) %>% 
  
  #:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:  
  #date of discharge: correction  (más detalle en change_dates_out_of_study.R)
  dplyr::mutate(fech_egres_imp=dplyr::case_when(fech_egres_imp>"2019-11-13"~as.Date("2019-11-13"),TRUE~fech_egres_imp)) %>%
      #:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:  
      #dias_trat
      dplyr::mutate(fech_ing_num=as.numeric(as.Date(fech_ing)))%>%
      dplyr::mutate(fech_egres_num=as.numeric(as.Date(fech_egres_imp)))%>%
      dplyr::mutate(fech_egres_num=ifelse(is.na(fech_egres_imp),18213,fech_egres_num))%>%
    #equivalente a 2019-11-13
      dplyr::mutate(dias_treat_imp_sin_na=fech_egres_num-fech_ing_num)%>%
      
      #:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:  
      #dias tratamiento
      dplyr::mutate(dias_trat_alta_temprana=ifelse(dias_treat_imp_sin_na>=90,0,1)) %>%
      dplyr::mutate(dias_trat_alta_temprana=as.factor(dias_trat_alta_temprana)) %>%
      dplyr::mutate(dias_trat_alta_temprana= dplyr::recode(dias_trat_alta_temprana, "1"="Menos de 90 días", "0"="Mayor o igual a 90 días")) %>%
      dplyr::mutate(motivodeegreso_mod_imp= ifelse(dias_trat_alta_temprana=="Menos de 90 días" & grepl("Abandono",motivodeegreso_mod_imp), "Abandono Temprano",as.character(motivodeegreso_mod_imp))) %>% 
      dplyr::mutate(motivodeegreso_mod_imp= ifelse(dias_trat_alta_temprana=="Mayor o igual a 90 días" & grepl("Abandono",motivodeegreso_mod_imp), "Abandono Tardio",as.character(motivodeegreso_mod_imp))) %>% 
      
      #:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:  
      #motivodeegreso_mod_imp
      dplyr::mutate(motivodeegreso_mod_imp=ifelse(dias_treat_imp_sin_na<1095 & 
                                                    is.na(fech_egres_imp),"En curso",
                                                  as.character(motivodeegreso_mod_imp))) %>% 
                    
  dplyr::mutate(event=ifelse(duplicates_filtered>1,1,0)) %>% 
  #dplyr::select(hash_key,fech_ing,dup, startdate, enddate,person_days,a_botar,event)
  dplyr::group_by(hash_key) %>% 
  dplyr::mutate(startdate= dplyr::first(fech_ing_num), enddate= dplyr::last(fech_egres_num), 
              person_days=enddate-startdate) %>% 
  dplyr::mutate(person_years=person_days/365.25)%>% 
  dplyr::ungroup() %>% 
  #dplyr::mutate(treat= ifelse(row %in% unlist(CONS_C1_df_dup_JUL_2020_match_top_sel$row),1,0))%>%
  dplyr::mutate(origen_ingreso_mod= dplyr::case_when(grepl("Otro Centro Tratamiento",as.character(origen_ingreso_mod))~"Derivación Asistida", TRUE~as.character(origen_ingreso_mod)))%>%  
  dplyr::mutate(origen_ingreso_mod=factor(origen_ingreso_mod,labels=c('Spontaneous','Assisted Referral','Other','Justice Sector','Health Sector')))  %>% 
  #:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:  
  #CIE_10 - CORREGIDO
  dplyr::mutate(across(c(dg_trs_psiq_cie_10_or,x2_dg_trs_psiq_cie_10_or,x3_dg_trs_psiq_cie_10_or,x4_dg_trs_psiq_cie_10_or,x5_dg_trs_psiq_cie_10_or),~dplyr::case_when(grepl("En estudio",as.character(.))~0,grepl("Sin trastorno",as.character(.))~0,is.na(.)~0,TRUE~1), .names="dg_{col}"))%>%
  dplyr::mutate(dg_total_cie_10 = base::rowSums(dplyr::select(., dg_dg_trs_psiq_cie_10_or, dg_x2_dg_trs_psiq_cie_10_or, dg_x3_dg_trs_psiq_cie_10_or, dg_x4_dg_trs_psiq_cie_10_or, dg_x5_dg_trs_psiq_cie_10_or), na.rm=T))%>%  
  dplyr::mutate(across(c(dg_trs_psiq_cie_10_or,x2_dg_trs_psiq_cie_10_or,x3_dg_trs_psiq_cie_10_or,x4_dg_trs_psiq_cie_10_or,x5_dg_trs_psiq_cie_10_or),~dplyr::case_when(grepl("En estudio",as.character(.))~1,grepl("Sin trastorno",as.character(.))~0,is.na(.)~0,TRUE~0), .names="instudy_{col}"))%>%
  dplyr::mutate(instudy_total_cie_10 = base::rowSums(dplyr::select(., instudy_dg_trs_psiq_cie_10_or, instudy_x2_dg_trs_psiq_cie_10_or, instudy_x3_dg_trs_psiq_cie_10_or, instudy_x4_dg_trs_psiq_cie_10_or, instudy_x5_dg_trs_psiq_cie_10_or), na.rm=T))%>%
  dplyr::mutate(dg_cie_10_rec=dplyr::case_when(dg_total_cie_10>0 ~2,
                                               instudy_total_cie_10>0 & dg_total_cie_10==0~1,
                                               instudy_total_cie_10>0 & is.na(dg_total_cie_10)~1,
                                               TRUE~0))%>%
  dplyr::mutate(dg_cie_10_rec=as.factor(dg_cie_10_rec))%>%
  dplyr::mutate(dg_cie_10_rec=factor(dg_cie_10_rec,labels=c('Without psychiatric comorbidity','Diagnosis unknown (under study)', 'With psychiatric comorbidity'))) %>% 
  #:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:
    #DSM-IV -CORREGIDO
dplyr::mutate(across(c(dg_trs_psiq_dsm_iv_or,x2_dg_trs_psiq_dsm_iv_or,x3_dg_trs_psiq_dsm_iv_or,x4_dg_trs_psiq_dsm_iv_or),~dplyr::case_when(grepl("En estudio",as.character(.))~1,grepl("Sin trastorno",as.character(.))~0,is.na(.)~0,TRUE~0),.names = "{col}_mod1b"))%>%
  dplyr::mutate(total_dsm_iv_en_est = base::rowSums(dplyr::select(.,ends_with("_mod1b"))))%>%  
dplyr::mutate(across(c(dg_trs_psiq_dsm_iv_or,x2_dg_trs_psiq_dsm_iv_or,x3_dg_trs_psiq_dsm_iv_or,x4_dg_trs_psiq_dsm_iv_or),~dplyr::case_when(grepl("En estudio",as.character(.),ignore.case = T)~0,grepl("Sin trastorno",as.character(.),ignore.case = T)~0,is.na(.)~0,TRUE~1),.names = "{col}_mod2b"))%>%
  dplyr::mutate(dg_total_dsm_iv = base::rowSums(dplyr::select(.,ends_with("_mod2b"))))%>%  #total_dsm_iv_dg
  
  dplyr::mutate(dg_dsm_iv_rec=dplyr::case_when(dg_total_dsm_iv>0 ~"With psychiatric comorbidity",
                       is.na(dg_total_dsm_iv) & total_dsm_iv_en_est>0~"Diagnosis unknown (under study)",
                       dg_total_dsm_iv==0 & total_dsm_iv_en_est>0~"Diagnosis unknown (under study)",
                       TRUE~"Without psychiatric comorbidity"))%>%
  dplyr::mutate(dg_dsm_iv_rec=as.factor(dg_dsm_iv_rec)) %>% 
  dplyr::select(-ends_with("_mod1b"),-ends_with("_mod2b"),-total_dsm_iv_en_est)%>%
  #:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:
  #MACROZONA
  dplyr::mutate(macrozona=factor(macrozona, labels=c('Center', 'North', 'South'))) %>%
  #:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:  
  #Edad grupos  
  dplyr::mutate(edad_al_ing_grupos=dplyr::case_when(
    edad_al_ing>=50~"50+",
    edad_al_ing>=40~"40-49",
    edad_al_ing>=30~"30-39",
    edad_al_ing>=18~"18-29",
    edad_al_ing<18~"<18",
    TRUE~NA_character_)) %>%
  dplyr::mutate(edad_al_ing_grupos=as.factor(edad_al_ing_grupos)) %>%  
  #:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:  
  #Tipo de programa
  dplyr::mutate(tipo_de_programa_2=dplyr::case_when(grepl("M-", tipo_de_plan_2)~"Women specific",
                                                    grepl("PG-", tipo_de_plan_2)~"General population",
                                                    grepl("LV", tipo_de_plan_2)~"Other")) %>% 
  dplyr::mutate(tipo_de_programa_2=as.factor(tipo_de_programa_2)) %>% 
  #:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:  
  #Sex
  dplyr::mutate(sexo_2=factor(sexo_2,labels=c('Men','Women'))) %>% 
  #:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:  
  #Cause of Discharge
  dplyr::mutate(motivodeegreso_mod_imp=factor(motivodeegreso_mod_imp,labels=c('Late Drop-out',
                                                                              'Early Drop-out',
                                                                              'Administrative discharge',
                                                                              'Therapeutic discharge',
                                                                              'Referral to another treatment',
                                                                              'Ongoing treatment',
                                                                              'Death'))) %>% 
  #:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:  
  #frequency of consumption
  dplyr::mutate(freq_cons_sus_prin=factor(freq_cons_sus_prin,labels=c("1 day a week or more",
                                                                      "2 to 3 days a week",
                                                                      "4 to 6 days a week",
                                                                      "Less than 1 day a week",
                                                                      "Did not use",
                                                                      "Daily"))) %>%     
  #:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:  
  #primary substance
  dplyr::mutate(sus_principal_mod=factor(sus_principal_mod,labels=c("Alcohol",
                                                                    "Cocaine hydrochloride",
                                                                    "Marijuana",
                                                                    "Other",
                                                                    "Cocaine paste"))) %>%   
  #:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:  
  #starting substance
  #Segunda Sustancia de Inicio(Sólo más frecuentes)	Second Starting Substance
  #Tercera Sustancia de Inicio(Sólo más frecuentes)	Third Starting Substance
  #Sustancia de Inicio (Sólo más frecuentes)	Starting Substance (Only more frequent)
  dplyr::mutate(sus_ini_mod_pb=dplyr::case_when(grepl("Past",sus_ini_3_mod)~"Paste Base",
                                                grepl("Past",sus_ini_2_mod)~"Paste Base",
                                                grepl("Past",sus_ini_mod)~"Paste Base",
                                                TRUE~NA_character_)) %>%
  dplyr::mutate(sus_ini_mod_oh=dplyr::case_when(grepl("Alcohol",sus_ini_3_mod)~"Alcohol",
                                                grepl("Alcohol",sus_ini_2_mod)~"Alcohol",
                                                grepl("Alcohol",sus_ini_mod)~"Alcohol",
                                                TRUE~NA_character_)) %>% 
  dplyr::mutate(sus_ini_mod_coc=dplyr::case_when(grepl("Coca",sus_ini_3_mod)~"Cocaine hydrochloride",
                                                grepl("Coca",sus_ini_2_mod)~"Cocaine hydrochloride",
                                                grepl("Coca",sus_ini_mod)~"Cocaine hydrochloride",
                                                TRUE~NA_character_)) %>%   
  dplyr::mutate(sus_ini_mod_mar=dplyr::case_when(grepl("Mari",sus_ini_3_mod)~"Marijuana",
                                                grepl("Mari",sus_ini_2_mod)~"Marijuana",
                                                grepl("Mari",sus_ini_mod)~"Marijuana",
                                                TRUE~NA_character_)) %>%   
  dplyr::mutate(sus_ini_mod_otr=dplyr::case_when(grepl("Ot",sus_ini_3_mod)~"Other",
                                                grepl("Ot",sus_ini_2_mod)~"Other",
                                                grepl("Ot",sus_ini_mod)~"Other",
                                                TRUE~NA_character_)) %>%
  dplyr::mutate(sus_ini_mod_mvv=dplyr::case_when(grepl("Paste Base",sus_ini_mod_pb)~"Paste Base",
                                                    grepl("Cocaine hydrochloride",sus_ini_mod_coc)~"Cocaine hydrochloride",
                                                    grepl("Marijuana",sus_ini_mod_mar)~"Marijuana",
                                                    grepl("Alcohol",sus_ini_mod_oh)~"Alcohol",
                                                    grepl("Other",sus_ini_mod_otr)~"Other",
                                                    TRUE~NA_character_)) %>%
  dplyr::mutate(sus_ini_mod_mvv=factor(sus_ini_mod_mvv,labels=c("Alcohol",
                                                                "Cocaine hydrochloride",
                                                                "Marijuana",
                                                                "Other",
                                                                "Cocaine paste"))) %>%   
#  "sus_ini_2_mod"                  "sus_ini_3_mod"                  "sus_ini_mod"
  
  #:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:  
  #escolaridad rec
  dplyr::mutate(escolaridad_rec=factor(escolaridad_rec,labels=c('1-More than high school','2-Completed high school or less','3-Completed primary school or less')))  %>% 
  #:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:  
  #marital status
  dplyr::mutate(estado_conyugal_2=factor(estado_conyugal_2, labels=c('Married/Shared living arrangements','Separated/Divorced','Single','Widower'))) %>%  
  
  #:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:  
  #type of center (pub/priv)
  dplyr::mutate(tipo_centro=factor(tipo_centro, labels=c('Private','Public'))) %>%
  
  #:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:  
  #occupational status (inactive…)
  # Due to the collapse in the databases, many occupational status did not coincide with the occupational category in some users. This is why we decided to consider as employed those users that had an occupational category.
  dplyr::mutate(estatus_ocupacional_rec= dplyr::case_when(!is.na(cat_ocupacional)&!is.na(estatus_ocupacional)~"Empleado",
                                                      TRUE~as.character(estatus_ocupacional)))%>% 
  dplyr::mutate(estatus_ocupacional_rec=factor(estatus_ocupacional_rec, labels=c('Unemployed',
                                                                         'Employed',
                                                                         'Inactive'))) %>%
  dplyr::mutate(cat_ocupacional=factor(cat_ocupacional, labels=c('Salaried',
                                                                 'Self-employed',
                                                                 'Employer',
                                                                 'Unpaid family labour',
                                                                 'Other',
                                                                 'Volunteer worker'))) %>%
  #:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:  
  #Had children into Residential Treatment
  #:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:  
  dplyr::mutate(hijos_trat_res=ifelse(num_hijos_trat_res_mod>0,1,0)) %>% 
  dplyr::mutate(hijos_trat_res=factor(hijos_trat_res, labels=c('Did not had children in treatment',
                                                              'Had children in treatments'))) %>% 
  #:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:  
  #Cohabitation Status
  #:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:  
  dplyr::mutate(con_quien_vive_rec=factor(con_quien_vive_rec,labels=c("With relatives",
                                                                      "With couple and children",
                                                                      "Other",
                                                                      "Alone",
                                                                      "With children only",
                                                                      "With couple only"))) %>%    
  #:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:  
  #physical diagnose
  #:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:  
  #
  dplyr::mutate(dg_fis_anemia= ifelse(grepl("Anemia",diagnostico_trs_fisico),1,0))%>%
  dplyr::mutate(dg_fis_card= ifelse(grepl("Cardiopat",diagnostico_trs_fisico),1,0))%>%
  dplyr::mutate(dg_fis_in_study= ifelse(grepl("En estudio",diagnostico_trs_fisico),1,0))%>%
  dplyr::mutate(dg_fis_enf_som= ifelse(grepl("somáticas",diagnostico_trs_fisico),1,0))%>%
  dplyr::mutate(dg_fis_ets= ifelse(grepl("ETS",diagnostico_trs_fisico),1,0))%>%
  dplyr::mutate(dg_fis_hep_alc= ifelse(grepl("Hepatitis alcohólica",diagnostico_trs_fisico),1,0))%>%
  dplyr::mutate(dg_fis_hep_b= ifelse(grepl("Hepatitis B",diagnostico_trs_fisico),1,0))%>%
  dplyr::mutate(dg_fis_hep_cro= ifelse(grepl("Hepatitis crónica",diagnostico_trs_fisico),1,0))%>%
  dplyr::mutate(dg_fis_inf= ifelse(grepl("Infecciosas relacionadas",diagnostico_trs_fisico),1,0))%>%
  dplyr::mutate(dg_fis_otr_cond_fis_ries_vit= ifelse(grepl("Condiciones de Riesgo Vital",diagnostico_trs_fisico),1,0))%>%
  dplyr::mutate(dg_fis_otr_cond_fis= ifelse(grepl("condiciones Fisicas Limitantes",diagnostico_trs_fisico),1,0))%>%
  dplyr::mutate(dg_fis_pat_buc= ifelse(grepl("Bucal",diagnostico_trs_fisico),1,0))%>%
  dplyr::mutate(dg_fis_pat_ges_intrau= ifelse(grepl("niño intrauterino",diagnostico_trs_fisico),1,0))%>%
  dplyr::mutate(dg_fis_trau_sec= ifelse(grepl("Traumatismos y secuelas",diagnostico_trs_fisico),1,0))%>%
  dplyr::mutate(otros_pr_sm_abu_sex= ifelse(grepl("Abuso Sexual",otros_probl_at_sm_or),1,0))%>%
  dplyr::mutate(otros_pr_sm_exp_com_sex= ifelse(grepl("omercial Sexual",otros_probl_at_sm_or),1,0))%>%
  dplyr::mutate(otros_pr_sm_otros= ifelse(grepl("Otros",otros_probl_at_sm_or),1,0))%>%
  dplyr::mutate(otros_pr_sm_otros= ifelse(grepl("Prisionalización",otros_probl_at_sm_or),1,otros_pr_sm_otros))%>%
  dplyr::mutate(otros_pr_sm_vif= ifelse(grepl("Violencia Intrafamiliar",otros_probl_at_sm_or),1,0)) %>% 
  
  dplyr::mutate(dg_trs_cons_sus_or= dplyr::case_when(grepl("Consumo Perjudicial",dg_trs_cons_sus_or)~"Hazardous consumption",grepl("Dependencia",dg_trs_cons_sus_or)~"Drug dependence",TRUE~NA_character_)) %>% 
  dplyr::mutate(dg_trs_cons_sus_or=as.factor(dg_trs_cons_sus_or)) %>% 
  #:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:  
  #route of administration of primary substance
  #:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:    
  dplyr::mutate(via_adm_sus_prin_act= dplyr::case_when(grepl("Intranasal",via_adm_sus_prin_act)~"Intranasal (aspiración de polvo por la nariz)",TRUE~as.character(via_adm_sus_prin_act))) %>%   
      dplyr::mutate(via_adm_sus_prin_act=factor(via_adm_sus_prin_act,labels=c("Smoked or Pulmonary Aspiration",
                                                                        "Intranasal (powder aspiration)",
                                                                        "Injected Intravenously or Intramuscularly",
                                                                        "Oral (drunk or eaten)",
                                                                        "Other"))) %>%   
  #dplyr::rename("cnt_mod_cie_10_or_2"="dg_total_cie_10") %>% 
  dplyr::select(-sus_ini_mod_pb, -sus_ini_mod_oh, -sus_ini_mod_coc, -sus_ini_mod_mar, -sus_ini_mod_otr,
                -dg_dg_trs_psiq_cie_10_or,-dg_x2_dg_trs_psiq_cie_10_or,-dg_x3_dg_trs_psiq_cie_10_or,-dg_x4_dg_trs_psiq_cie_10_or,-dg_x5_dg_trs_psiq_cie_10_or,-instudy_dg_trs_psiq_cie_10_or,-instudy_x2_dg_trs_psiq_cie_10_or,-instudy_x3_dg_trs_psiq_cie_10_or,-instudy_x4_dg_trs_psiq_cie_10_or,-instudy_x5_dg_trs_psiq_cie_10_or,-instudy_total_cie_10) %>% 
  dplyr::mutate_at(vars(starts_with("otros_pr_sm_"),
                                   starts_with("dg_fis_")),~factor(., labels=c("Absence", "Presence")))%>%
  #_#_#_#_#_#_#_#_#_#_#_
#Starting substance (more frequent) (2021-12-16)
  dplyr::mutate(sus_ini_mod=factor(dplyr::case_when(grepl("Pasta Base",sus_ini_mod)~"Cocaine paste",
                                               grepl("Cocaína",sus_ini_mod)~"Cocaine hydrochloride",
                                               grepl("Marihuana",sus_ini_mod)~"Marijuana",
                                               grepl("Alcohol",sus_ini_mod)~"Alcohol",
                                               grepl("Otros",sus_ini_mod)~"Other",
                                               TRUE~NA_character_))) %>%
  
  #_#_#_#_#_#_#_#_#_#_#_
#Corrección número de diagnósticos cie-10 dsm-iv
  #_#_#_#_#_#_#_#_#_#_#_
    dplyr::mutate(cnt_mod_cie_10_or= dplyr::case_when(as.character(cie_10)=="Diagnosticado/a (uno en estudio)"~cnt_mod_cie_10_or-1, is.na(dg_trs_psiq_cie_10_or)~0, TRUE~cnt_mod_cie_10_or)) %>% 
      dplyr::mutate(cnt_mod_dsm_iv_or= dplyr::case_when(as.character(dsm_iv)=="Diagnosticado/a (uno en estudio)"~cnt_mod_dsm_iv_or-1, is.na(dg_trs_psiq_dsm_iv_or)~0, TRUE~cnt_mod_dsm_iv_or)) %>% 
    #_#_#_#_#_#_#_#_#_#_#_
  #sumrows de los diagnósticos, 
#otros_pr_sm_abu_sex, otros_pr_sm_exp_com_sex, otros_pr_sm_otros, otros_pr_sm_vif
      dplyr::mutate(across(c(dg_fis_anemia, dg_fis_card,  dg_fis_enf_som, dg_fis_ets, dg_fis_hep_alc, dg_fis_hep_b, dg_fis_hep_cro, dg_fis_inf, dg_fis_otr_cond_fis_ries_vit, dg_fis_otr_cond_fis, dg_fis_pat_buc, dg_fis_pat_ges_intrau, dg_fis_trau_sec),~as.numeric(.)-1, .names="num_dg_fis_{col}"))%>%
      dplyr::mutate(cnt_diagnostico_trs_fisico= base::rowSums(dplyr::select(., num_dg_fis_dg_fis_anemia,  num_dg_fis_dg_fis_card,  num_dg_fis_dg_fis_enf_som, num_dg_fis_dg_fis_ets, num_dg_fis_dg_fis_hep_alc, num_dg_fis_dg_fis_hep_b, num_dg_fis_dg_fis_hep_cro, num_dg_fis_dg_fis_inf, num_dg_fis_dg_fis_otr_cond_fis_ries_vit, num_dg_fis_dg_fis_otr_cond_fis, num_dg_fis_dg_fis_pat_buc, num_dg_fis_dg_fis_pat_ges_intrau, num_dg_fis_dg_fis_trau_sec)))%>% 
      dplyr::select(-starts_with("num_dg_fis")) %>% 
#_#_#_#_#_#_#_#_#_#_#_
  #compromiso biospicosocial  
#_#_#_#_#_#_#_#_#_#_#_
    dplyr::mutate(compromiso_biopsicosocial=dplyr::case_when(as.character(compromiso_biopsicosocial)=="1-Leve"~'1-Mild',
                                                           as.character(compromiso_biopsicosocial)=="2-Moderado"~'2-Moderate',
                                                           as.character(compromiso_biopsicosocial)=="3-Severo"~'3-Severe',
                                                           TRUE~NA_character_)) %>% 
  dplyr::mutate(compromiso_biopsicosocial=factor(compromiso_biopsicosocial)) %>% 
#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:  
#Corrección Edad Inicio Sus Principal  
dplyr::mutate(edad_ini_sus_prin_grupos=ifelse(edad_ini_sus_prin>=25,">=25",
                                            ifelse(edad_ini_sus_prin>18,"19-24",
                                            ifelse(edad_ini_sus_prin>15,"16-18",
                                            ifelse(edad_ini_sus_prin>0,"<=15",
                                            NA_character_)))))%>% 
dplyr::mutate(edad_ini_sus_prin_grupos=as.factor(edad_ini_sus_prin_grupos)) %>%
#_#_#_#_#_#_#_#_#_#_#_
  #corrección tenencia de la vivienda.
#_#_#_#_#_#_#_#_#_#_#_
  dplyr::mutate(tenencia_de_la_vivienda_mod=dplyr::case_when(as.character(tenencia_de_la_vivienda_mod)=="Ocupación Irregularrregular"~'Ocupación Irregular',
                                                             TRUE~as.character(tenencia_de_la_vivienda_mod))) %>%
  dplyr::mutate(tenencia_de_la_vivienda_mod=factor(tenencia_de_la_vivienda_mod)) %>% 
#_#_#_#_#_#_#_#_#_#_#_
  #Corrección de otros problemas de salud mental
#_#_#_#_#_#_#_#_#_#_#_
      dplyr::mutate(across(c(otros_pr_sm_abu_sex, otros_pr_sm_exp_com_sex, otros_pr_sm_otros, otros_pr_sm_vif),~as.numeric(.)-1, .names="num_dg_otros_pr_{col}"))%>%
     dplyr::mutate(cnt_otros_probl_at_sm_or= base::rowSums(dplyr::select(., num_dg_otros_pr_otros_pr_sm_abu_sex, num_dg_otros_pr_otros_pr_sm_exp_com_sex, num_dg_otros_pr_otros_pr_sm_otros, num_dg_otros_pr_otros_pr_sm_vif))) %>% 
      dplyr::select(-starts_with("num_dg_otros_pr_")) %>% 
#_#_#_#_#_#_#_#_#_#_#_
# 2020-11-15: sacar el último tratamiento acumulado que se replica, para no tener errores con la estimación de los four
  dplyr::mutate(cum_diff_bet_treat_2= dplyr::case_when(!is.na(cum_diff_bet_treat_2) & duplicates_filtered==2~NA_real_,TRUE~cum_diff_bet_treat_2)) %>% 
  dplyr::mutate(cum_diff_bet_treat_3= dplyr::case_when(!is.na(cum_diff_bet_treat_3) & duplicates_filtered==3~NA_real_,TRUE~cum_diff_bet_treat_3)) %>% 
  dplyr::mutate(cum_diff_bet_treat_4= dplyr::case_when(!is.na(cum_diff_bet_treat_4) & duplicates_filtered==4~NA_real_,TRUE~cum_diff_bet_treat_4)) %>% 
  dplyr::mutate(cum_diff_bet_treat_5= dplyr::case_when(!is.na(cum_diff_bet_treat_5) & duplicates_filtered==5~NA_real_,TRUE~cum_diff_bet_treat_5)) %>% 
  dplyr::mutate(cum_diff_bet_treat_6= dplyr::case_when(!is.na(cum_diff_bet_treat_6) & duplicates_filtered==6~NA_real_,TRUE~cum_diff_bet_treat_6)) %>% 
  dplyr::mutate(cum_diff_bet_treat_7= dplyr::case_when(!is.na(cum_diff_bet_treat_7) & duplicates_filtered==7~NA_real_,TRUE~cum_diff_bet_treat_7)) %>% 
  dplyr::mutate(cum_diff_bet_treat_8= dplyr::case_when(!is.na(cum_diff_bet_treat_8) & duplicates_filtered==8~NA_real_,TRUE~cum_diff_bet_treat_8)) %>% 
  dplyr::mutate(cum_diff_bet_treat_9= dplyr::case_when(!is.na(cum_diff_bet_treat_9) & duplicates_filtered==9~NA_real_,TRUE~cum_diff_bet_treat_9)) %>% 
  dplyr::mutate(cum_diff_bet_treat_10= dplyr::case_when(!is.na(cum_diff_bet_treat_10) & duplicates_filtered==10~NA_real_,TRUE~cum_diff_bet_treat_10)) %>% 
  
  assign("CONS_C1_df_dup_SEP_2020",., envir = .GlobalEnv)
```

<br>

# Adding another criteria for classifying occupations

<br>

We repeated the task of collapsing the occupational condition (`condicion_ocupacional`) into an occupational status composed of three categories: Employed, Unemployed and Inactive made on `Duplicatates` process (1st deduplication stage). However, many values of the different rows may be different due to some changes in the stage of collapsing continuous treatments (`Desc4`). For this, we had to replicate these steps in order to track down the value of the largest intermediate treatment to generate an occupational condition following a different criteria.

<br>

```{r lo_q_hice_en_duplicates_oculto, eval=F}
#EL PROBLEMA PRINCIPAL ES QUE HICE MAL LA RECODIFICACION AL PRINCIPIO: EXCLUI A LOS TRABJANDO Y ESTUDIANDO, 

#- Collapse the occupational condition into an occupational status composed of three categories: Employed, Unemployed and Inactive
#Esta variable busca establecer si la persona desarrolló alguna actividad laboral o productiva, es decir, si participó en la producción de un bien o servicio para la venta o para el autoconsumo, por un mínimo de una hora semanal en la semana anterior (lunes a domingo) a la entrevista. Los quehaceres del hogar no son considerados una actividad productiva o ‘razón de ocupación’.
#Si la respuesta es afirmativa se debe seleccionar la opción “Trabajando actualmente” Si la persona No Trabajó, interesa saber si está Desocupada (“busca trabajo por primera vez” o “cesante”) o Inactiva (que corresponde al resto de la opciones, quehaceres del hogar, estudiando, jubilado, etc.) 
#
#Inactivo, desempleado, empleado
#     Buscando trabajo por primera vez |        245        0.21        0.21
#                              Cesante |     43,299       36.67       36.87
#              Estudiando sin trabajar |      1,353        1.15       38.02
#Incapacitado permanente para trabajar |        294        0.25       38.27
#                                   NA |          1        0.00       38.27
#                     No busca Trabajo |      1,250        1.06       39.33
#                           Otra razón |      1,348        1.14       40.47
#   Pensionado o jubilado sin trabajar |      1,872        1.59       42.05
#                 Quehaceres del hogar |      7,683        6.51       48.56
#                             Rentista |         78        0.07       48.63
#                        Sin actividad |      7,449        6.31       54.93
#               Trabajando actualmente |     53,120       44.98       99.92
#              Trabajando y estudiando |         97        0.08      100.00
CONS_C1_df %>% 
dplyr::mutate(estatus_ocupacional=ifelse(Condicion.Ocupacional=="Trabajando actualmente","Empleado",
                                         ifelse(Condicion.Ocupacional=="Buscando trabajo por primera vez"|Condicion.Ocupacional=="Cesante",
                                                "Desempleado","Inactivo"))) %>%
dplyr::mutate(estatus_ocupacional=as.factor(estatus_ocupacional)) %>%
  janitor::tabyl(Condicion.Ocupacional,estatus_ocupacional)
#Comprende la relación entre una persona económicamente activa y su trabajo o empleo. Sólo se aplica aquellas personas que se encuentran trabajando al momento de ingresar a tratamiento (las que respondieron 1 en la pregunta anterior). Para las personas que no están trabajando (estudiantes, cesante, etc.) esta opción estará bloqueada.
#data.table(table(CONS_C1_df_dup_ENE_2020_prev3$Categoría.Ocupacional))
dplyr::mutate(cat_ocupacional=ifelse(Condicion.Ocupacional!="Trabajando actualmente",NA,as.character(`Categoría.Ocupacional`))) %>%
dplyr::mutate(cat_ocupacional=as.factor(cat_ocupacional)) %>%
```

```{r cons2_sep,echo=T, paged.print=TRUE, eval=T}
#Primero es necesario determinar qué tratamiento fue más largo, para volver a recuperar el valor de la `condicion_ocupacional` presente en las primeras bases de datos.

#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:
#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:
#¿cómo determinar qué tratamiento fue el más largo?
CONS_C1_JUN_2020_row_sig_row<-
  CONS_C1_df_dup_JUN_2020%>%
  #dplyr::filter(!is.na(diff_bet_treat))%>% #31,609, no hay NAs en derivación, los que son NA son 0.
  dplyr::mutate(filter_complex= dplyr::case_when(!is.na(diff_bet_treat) & diff_bet_treat<45 & as.character(motivoegreso_derivacion)=="Referral"~1,TRUE~0))%>%
  dplyr::arrange(hash_key)%>%
  dplyr::group_by(hash_key)%>%
  dplyr::mutate(sig_row=lag(row), sig_fech_egres_imp=lag(fech_egres_imp),sig_motivoegres_ref=lag(motivoegreso_derivacion),n_por_hash=n())%>%
  ungroup()%>%
  dplyr::filter(filter_complex==1)%>%
  # dplyr::select(row,hash_key,fech_ing,fech_egres_imp,motivoegreso_derivacion,obs_cambios,diff_bet_treat,sig_row,n_por_hash) %>% View() #0007678b8b35fa0961d1e8110fbf9620 
  dplyr::select(row,sig_row)  

CONS_C1_JUN_2020_cont_treat<-
  CONS_C1_df_dup_JUN_2020%>%
  dplyr::filter(row %in% unlist(c(CONS_C1_JUN_2020_row_sig_row$row,CONS_C1_JUN_2020_row_sig_row$sig_row)))%>%
  dplyr::arrange(hash_key,desc(fech_ing))%>%
  dplyr::mutate(filter_complex_anterior= dplyr::case_when(!is.na(lag(diff_bet_treat)) & lag(diff_bet_treat)<45 & as.character(lag(motivoegreso_derivacion))=="Referral"~1,TRUE~0))%>%
  dplyr::mutate(filter_complex= dplyr::case_when(!is.na(diff_bet_treat) & diff_bet_treat<45 & as.character(motivoegreso_derivacion)=="Referral"~1,TRUE~0))%>%
  dplyr::ungroup() %>% 
  dplyr::group_by(hash_key)%>%
  dplyr::slice_max(dias_trat) %>% 
  dplyr::ungroup() %>% 
  dplyr::select(row,hash_key,dias_trat,cat_ocupacional,estatus_ocupacional) %>% 
  dplyr::mutate(row_larg_treat=row)
#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:
#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:

#Se hace el pareamiento de la base de datos anterior con la actual, y se elije de una fila con los registros colapsados, aquel registro que contiene más días de tratamiento. Para eso me traigo los valores de condición ocupacional de la base de datos original, para cada cada `row`. De ellos, dejo aquel valor de la fila que tenga más días de tratamiento  (considerando que ese fue el criterio de selección para esta variable de acuerdo a la Fig. 5 de Duplicates4). Hubo hasta 7 eventos que se colapsaron en uno.
#Ver qué row corresponde al tratamiento más largo
CONS_C1_df_dup_SEP_2020 %>% 
  #dplyr::mutate(row=as.character(row)) %>%
  dplyr::mutate(row_cont_entries2=row_cont_entries) %>% 
  tidyr::separate(row_cont_entries2,into=paste0("rows",1:7),sep="; ", convert=T) %>% #se supone que tiene 7 distintos
  dplyr::left_join(dplyr::select(CONS_C1,row,Condicion.Ocupacional),by="row")%>% 
  dplyr::rename("condicion_ocupacional_row_all"="Condicion.Ocupacional") %>% 
  dplyr::left_join(dplyr::select(CONS_C1,row,Condicion.Ocupacional),by=c("rows1"="row"))%>% 
  dplyr::rename("condicion_ocupacional_row1"="Condicion.Ocupacional") %>% 
  dplyr::left_join(dplyr::select(CONS_C1,row,Condicion.Ocupacional),by=c("rows2"="row"))%>% 
  dplyr::rename("condicion_ocupacional_row2"="Condicion.Ocupacional") %>% 
  dplyr::left_join(dplyr::select(CONS_C1,row,Condicion.Ocupacional),by=c("rows3"="row"))%>% 
  dplyr::rename("condicion_ocupacional_row3"="Condicion.Ocupacional") %>% 
  dplyr::left_join(dplyr::select(CONS_C1,row,Condicion.Ocupacional),by=c("rows4"="row"))%>% 
  dplyr::rename("condicion_ocupacional_row4"="Condicion.Ocupacional") %>% 
  dplyr::left_join(dplyr::select(CONS_C1,row,Condicion.Ocupacional),by=c("rows5"="row"))%>% 
  dplyr::rename("condicion_ocupacional_row5"="Condicion.Ocupacional") %>% 
  dplyr::left_join(dplyr::select(CONS_C1,row,Condicion.Ocupacional),by=c("rows6"="row"))%>% 
  dplyr::rename("condicion_ocupacional_row6"="Condicion.Ocupacional") %>% 
  dplyr::left_join(dplyr::select(CONS_C1,row,Condicion.Ocupacional),by=c("rows7"="row"))%>% 
  dplyr::rename("condicion_ocupacional_row7"="Condicion.Ocupacional") %>% 
  
  dplyr::left_join(CONS_C1_JUN_2020_cont_treat[,c("row","row_larg_treat")],by="row")%>% 
  dplyr::mutate(condicion_ocupacional_larg_treat=dplyr::case_when(row_larg_treat==rows1~condicion_ocupacional_row1,
                                                                  row_larg_treat==rows2~condicion_ocupacional_row2,
                                                                  row_larg_treat==rows3~condicion_ocupacional_row3,
                                                                  row_larg_treat==rows4~condicion_ocupacional_row4,
                                                                  row_larg_treat==rows5~condicion_ocupacional_row5,
                                                                  row_larg_treat==rows6~condicion_ocupacional_row6,
                                                                  row_larg_treat==rows7~condicion_ocupacional_row7)) %>% 
  dplyr::mutate(condicion_ocupacional_row_all2=ifelse(!is.na(condicion_ocupacional_larg_treat),
                                                     condicion_ocupacional_larg_treat,condicion_ocupacional_row_all)) %>% 
  dplyr::select(-condicion_ocupacional_row1,-condicion_ocupacional_row2,-condicion_ocupacional_row3,-condicion_ocupacional_row4,
                -condicion_ocupacional_row5,-condicion_ocupacional_row6,-condicion_ocupacional_row7,-rows1,-rows2,-rows3,-rows4,
                -rows5,-rows6,-rows7,-row_larg_treat) %>%
  dplyr::mutate(condicion_ocupacional_corr=dplyr::case_when(
    #categorizados como inactive en estatus_ocupacional_rec
    grepl("Buscando trabajo por primera vez",condicion_ocupacional_row_all2)& is.na(cat_ocupacional) & grepl("Inactive",estatus_ocupacional_rec)~"Looking for a job for the first time",
    grepl("Cesante",condicion_ocupacional_row_all2)& is.na(cat_ocupacional) & grepl("Inactive",estatus_ocupacional_rec)~"Unemployed",
    grepl("No busca Trabajo",condicion_ocupacional_row_all2)& is.na(cat_ocupacional) & grepl("Inactive",estatus_ocupacional_rec)~"Not seeking for work",
    grepl("Sin actividad",condicion_ocupacional_row_all2)& is.na(cat_ocupacional) & grepl("Inactive",estatus_ocupacional_rec)~"No activity",
    grepl("Trabajando actualmente",condicion_ocupacional_row_all2)& is.na(cat_ocupacional) & grepl("Inactive",estatus_ocupacional_rec)~"Employed",
    grepl("Trabajando y estudiando",condicion_ocupacional_row_all2)& is.na(cat_ocupacional) & grepl("Inactive",estatus_ocupacional_rec)~"Employed",
  #categorizados como unemployed en estatus_ocupacional_rec
    grepl("Cesante",condicion_ocupacional_row_all2)& is.na(cat_ocupacional) & grepl("Unemployed",estatus_ocupacional_rec)~"Unemployed",
    grepl("Estudiando sin trabajar",condicion_ocupacional_row_all2) & is.na(cat_ocupacional) & grepl("Unemployed",estatus_ocupacional_rec)~"Inactive",
    grepl("Incapacitado permanente para trabajar",condicion_ocupacional_row_all2)& is.na(cat_ocupacional) & grepl("Unemployed",estatus_ocupacional_rec)~"Inactive",
    grepl("Otra razón",condicion_ocupacional_row_all2)& is.na(cat_ocupacional) & grepl("Unemployed",estatus_ocupacional_rec)~"Inactive",
    grepl("Pensionado o jubilado sin trabajar",condicion_ocupacional_row_all2)& is.na(cat_ocupacional) & grepl("Unemployed",estatus_ocupacional_rec)~"Inactive",
    grepl("Quehaceres del hogar",condicion_ocupacional_row_all2)& is.na(cat_ocupacional) & grepl("Unemployed",estatus_ocupacional_rec)~"Inactive",
    grepl("Rentista",condicion_ocupacional_row_all2)& is.na(cat_ocupacional) & grepl("Unemployed",estatus_ocupacional_rec)~"Inactive",  
    grepl("No busca Trabajo",condicion_ocupacional_row_all2)& is.na(cat_ocupacional) & grepl("Unemployed",estatus_ocupacional_rec)~"Not seeking for work",
    grepl("Sin actividad",condicion_ocupacional_row_all2)& is.na(cat_ocupacional) & grepl("Unemployed",estatus_ocupacional_rec)~"No activity",
    grepl("Buscando trabajo por primera vez",condicion_ocupacional_row_all2)& is.na(cat_ocupacional) & grepl("Unemployed",estatus_ocupacional_rec)~"Looking for a job for the first time",
    grepl("Trabajando actualmente",condicion_ocupacional_row_all2)& is.na(cat_ocupacional) & grepl("Unemployed",estatus_ocupacional_rec)~"Employed",
  #categorizados como employed en estatus_ocupacional_rec
  #categorizados como Salaried en cat__ocupacional y employed en estatus_ocupacional_rec
    grepl("Cesante",condicion_ocupacional_row_all2)& grepl("Salaried",cat_ocupacional) & grepl("Employed",estatus_ocupacional_rec)~"Unemployed", #--> debiese no ser cat_ocupacional Salaried
    grepl("Estudiando sin trabajar",condicion_ocupacional_row_all2)& grepl("Salaried",cat_ocupacional) & grepl("Employed",estatus_ocupacional_rec)~"Inactive", #--> debiese no ser cat_ocupacional Salaried
    grepl("Incapacitado permanente para trabajar",condicion_ocupacional_row_all2)& grepl("Salaried",cat_ocupacional) & grepl("Employed",estatus_ocupacional_rec)~"Inactive", #--> debiese no ser cat_ocupacional Salaried  
    grepl("Otra razón",condicion_ocupacional_row_all2)& grepl("Salaried",cat_ocupacional) & grepl("Employed",estatus_ocupacional_rec)~"Inactive", #--> debiese no ser cat_ocupacional Salaried
    grepl("Pensionado o jubilado sin trabajar",condicion_ocupacional_row_all2)& grepl("Salaried",cat_ocupacional) & grepl("Employed",estatus_ocupacional_rec)~"Inactive", #--> debiese no ser cat_ocupacional Salaried
    grepl("Quehaceres del hogar",condicion_ocupacional_row_all2)& grepl("Salaried",cat_ocupacional) & grepl("Employed",estatus_ocupacional_rec)~"Inactive", #--> debiese no ser cat_ocupacional Salaried
    grepl("No busca Trabajo",condicion_ocupacional_row_all2)& grepl("Salaried",cat_ocupacional) & grepl("Employed",estatus_ocupacional_rec)~"Not seeking for work", #--> debiese no ser cat_ocupacional Salaried
    grepl("Sin actividad",condicion_ocupacional_row_all2)& grepl("Salaried",cat_ocupacional) & grepl("Employed",estatus_ocupacional_rec)~"No activity", #--> debiese no ser cat_ocupacional Salaried
  #categorizados como Employer en cat__ocupacional y employed en estatus_ocupacional_rec
    grepl("Buscando trabajo por primera vez",condicion_ocupacional_row_all2)& grepl("Self-employed",cat_ocupacional) & grepl("Employed",estatus_ocupacional_rec)~"Looking for a job for the first time", #--> debiese no ser cat_ocupacional Self-employed
    grepl("Cesante",condicion_ocupacional_row_all2)& grepl("Self-employed",cat_ocupacional) & grepl("Employed",estatus_ocupacional_rec)~"Unemployed", #--> debiese no ser cat_ocupacional Self-employed
    grepl("Estudiando sin trabajar|Incapacitado permanente para trabajar|Otra razón|Pensionado o jubilado sin trabajar|Quehaceres del hogar",condicion_ocupacional_row_all2)& grepl("Self-employed",cat_ocupacional) & grepl("Employed",estatus_ocupacional_rec)~"Inactive", #--> debiese no ser cat_ocupacional Self-employed
    grepl("No busca Trabajo",condicion_ocupacional_row_all2)& grepl("Self-employed",cat_ocupacional) & grepl("Employed",estatus_ocupacional_rec)~"Not seeking for work",
    grepl("Sin actividad",condicion_ocupacional_row_all2)& grepl("Self-employed",cat_ocupacional) & grepl("Employed",estatus_ocupacional_rec)~"No activity",
  #categorizados como Employer en cat__ocupacional y employed en estatus_ocupacional_rec
    grepl("Cesante",condicion_ocupacional_row_all2)& grepl("Employer",cat_ocupacional) & grepl("Employed",estatus_ocupacional_rec)~"Unemployed",
    grepl("Estudiando sin trabajar",condicion_ocupacional_row_all2)& grepl("Employer",cat_ocupacional) & grepl("Employed",estatus_ocupacional_rec)~"Inactive", #--> debiese no ser cat_ocupacional Employer
    grepl("Otra razón",condicion_ocupacional_row_all2)& grepl("Employer",cat_ocupacional) & grepl("Employed",estatus_ocupacional_rec)~"Inactive", #--> debiese no ser cat_ocupacional Employer
    grepl("Quehaceres del hogar",condicion_ocupacional_row_all2)& grepl("Employer",cat_ocupacional) & grepl("Employed",estatus_ocupacional_rec)~"Inactive", #--> debiese no ser cat_ocupacional Employer
    grepl("Sin actividad",condicion_ocupacional_row_all2)& grepl("Employer",cat_ocupacional) & grepl("Employed",estatus_ocupacional_rec)~"No activity",
  #categorizados como Unpaid family labour en cat__ocupacional y employed en estatus_ocupacional_rec
    grepl("Cesante",condicion_ocupacional_row_all2)& grepl("Unpaid family labour",cat_ocupacional) & grepl("Employed",estatus_ocupacional_rec)~"Unemployed",
  #categorizados como Other en cat__ocupacional y employed en estatus_ocupacional_rec
    grepl("Sin actividad",condicion_ocupacional_row_all2)& grepl("Other",cat_ocupacional) & grepl("Employed",estatus_ocupacional_rec)~"No activity",
    grepl("Cesante",condicion_ocupacional_row_all2)& grepl("Other",cat_ocupacional) & grepl("Employed",estatus_ocupacional_rec)~"Unemployed",
    grepl("Quehaceres del hogar",condicion_ocupacional_row_all2)& grepl("Other",cat_ocupacional) & grepl("Employed",estatus_ocupacional_rec)~"Inactive", #--> debiese no ser cat_ocupacional Employer  
  #categorizados como Volunteer worker en cat__ocupacional y employed en estatus_ocupacional_rec
    grepl("Cesante",condicion_ocupacional_row_all2)& grepl("Volunteer worker",cat_ocupacional) & grepl("Employed",estatus_ocupacional_rec)~"Unemployed",
    grepl("No busca Trabajo",condicion_ocupacional_row_all2)& grepl("Volunteer worker",cat_ocupacional) & grepl("Employed",estatus_ocupacional_rec)~"Not seeking for work",
    grepl("Quehaceres del hogar",condicion_ocupacional_row_all2)& grepl("Volunteer worker",cat_ocupacional) & grepl("Employed",estatus_ocupacional_rec)~"Inactive",
    grepl("Sin actividad",condicion_ocupacional_row_all2)& grepl("Volunteer worker",cat_ocupacional) & grepl("Employed",estatus_ocupacional_rec)~"No activity",
  #categorizados como NA en cat__ocupacional y employed en estatus_ocupacional_rec
    grepl("Cesante",condicion_ocupacional_row_all2)& is.na(cat_ocupacional) & grepl("Employed",estatus_ocupacional_rec)~"Unemployed",
    grepl("Estudiando sin trabajar",condicion_ocupacional_row_all2)& is.na(cat_ocupacional) & grepl("Employed",estatus_ocupacional_rec)~"Inactive", #--> debiese no ser cat_ocupacional Employer
    grepl("Pensionado o jubilado sin trabajar",condicion_ocupacional_row_all2)& is.na(cat_ocupacional) & grepl("Employed",estatus_ocupacional_rec)~"Inactive", #--> debiese no ser cat_ocupacional Employer
    grepl("Quehaceres del hogar",condicion_ocupacional_row_all2)& is.na(cat_ocupacional) & grepl("Employed",estatus_ocupacional_rec)~"Inactive", #--> debiese no ser cat_ocupacional Employer
    grepl("Sin actividad",condicion_ocupacional_row_all2)& is.na(cat_ocupacional) & grepl("Employed",estatus_ocupacional_rec)~"No activity",
  TRUE~as.character(estatus_ocupacional_rec))) %>% 
  assign("CONS_C1_df_dup_SEP_2020_joel",., envir=.GlobalEnv)

#generar cat_ocupacional_corr
#:#:#:#:#:#:#:#:#:#:#:
CONS_C1_df_dup_SEP_2020_joel %>% 
    dplyr::mutate(cat_ocupacional_corr=dplyr::case_when(
    grepl("Employed",condicion_ocupacional_corr)~as.character(cat_ocupacional),
    TRUE~NA_character_)) %>% 
  dplyr::select(-condicion_ocupacional_row_all2,-condicion_ocupacional_larg_treat,-condicion_ocupacional_row_all) %>% 
  dplyr::mutate(cat_ocupacional_corr=factor(cat_ocupacional_corr),condicion_ocupacional_corr= factor(condicion_ocupacional_corr))%>% 
assign("CONS_C1_df_dup_SEP_2020",., envir=.GlobalEnv)
#De ahí generar un cat_ocupacional_corr que converse con condicion_ocupacional_row_all2 y con esttus_ocupacional_corr  

#CONS_C1_df_dup_SEP_2020_joel %>%
#    dplyr::filter(condicion_ocupacional_row_all2=="Estudiando sin trabajar",estatus_ocupacional_rec=="Employed",condicion_ocupacional_corr=="Employed") %>% 
#    dplyr::select(condicion_ocupacional_row_all2, cat_ocupacional, estatus_ocupacional_rec, condicion_ocupacional_corr)
  
#NO CALZAN PORQUE PUSE UNA OPCIÖN DE QUE SI HABÏA VACIO EN UNO; LO REEMPLAZARA
#CONS_C1_df_dup_SEP_2020_joel %>%  janitor::tabyl(cat_ocupacional,condicion_ocupacional_larg_treat)    
#CONS_C1_df_dup_SEP_2020_joel %>%  janitor::tabyl(estatus_ocupacional,condicion_ocupacional_larg_treat)
#CONS_C1_df_dup_SEP_2020_joel %>%  janitor::tabyl(condicion_ocupacional_row_all2,cat_ocupacional)  
```

<br>

# Health conditions & readmissions

To describe the incidence rate of SUD treatment readmissions by type of health conditions, we recoded the different variables of interest into pairs of different groups by each variable.

<br>

```{r irrs_health_conditions,eval=T, echo=T, paged.print=TRUE}                                 
CONS_C1_df_dup_SEP_2020_irrs_health<-  
CONS_C1_df_dup_SEP_2020 %>% 
    dplyr::filter(!is.na(a_botar)) %>% #nrow() 85,048, QUEDARME SÓLO CON LOS CASOS QUE SON IS.NA
      #dplyr::mutate(event=factor(event,labels=c("W/o Readmissions","W/Readmissions"))) %>% 
    #%>% janitor::tabyl(event)

       # dg_cie_10_rec cnt_mod_cie_10_or cnt_otros_probl_at_sm_or
      dplyr::mutate(cnt_diagnostico_trs_fisico_irr=dplyr::case_when(cnt_diagnostico_trs_fisico==0 & dg_fis_in_study!="Presence"~0,
                                                                    cnt_diagnostico_trs_fisico>0~1,
                                                                    dg_fis_in_study=="Presence"~NA_real_)) %>% 
      dplyr::mutate(dg_fis_in_study_irr=dplyr::case_when(dg_fis_in_study=="Presence"~1,
                                                         diagnostico_trs_fisico=="Sin trastorno"~0,
                                                         TRUE~NA_real_)) %>% 
      dplyr::mutate(cnt_mod_cie_10_or_irr=dplyr::case_when(cnt_mod_cie_10_or==0 & dg_cie_10_rec!="Diagnosis unknown (under study)"~0,
                                                           cnt_mod_cie_10_or>0~1,
                                                           TRUE~NA_real_)) %>% 
      dplyr::mutate(cnt_mod_cie_10_or_in_study_irr=dplyr::case_when(as.character(dg_cie_10_rec)=="Diagnosis unknown (under study)"~1,
                                                                    as.character(dg_cie_10_rec)=="Without psychiatric comorbidity"~0,
                                                                    TRUE~NA_real_)) %>% 

      dplyr::mutate(cnt_otros_probl_at_sm_or_irr=dplyr::case_when(cnt_otros_probl_at_sm_or==0~0,
                                                                  cnt_otros_probl_at_sm_or>0~1)) %>% 
      dplyr::mutate(dg_trs_cons_sus_or_irr=dplyr::case_when(dg_trs_cons_sus_or=="Drug dependence"~1,
                                                            dg_trs_cons_sus_or=="Hazardous consumption"~0,
                                                            TRUE ~NA_real_)) %>% 
      dplyr::mutate(cnt_diagnostico_trs_fisico_irr=factor(cnt_diagnostico_trs_fisico_irr),
                    dg_fis_in_study_irr=as.factor(dg_fis_in_study_irr),
                    cnt_mod_cie_10_or_irr=as.factor(cnt_mod_cie_10_or_irr),
                    cnt_mod_cie_10_or_in_study_irr= as.factor(cnt_mod_cie_10_or_in_study_irr),
                    cnt_otros_probl_at_sm_or_irr=as.factor(cnt_otros_probl_at_sm_or_irr),
                    dg_trs_cons_sus_or_irr=as.factor(dg_trs_cons_sus_or_irr))


# CONS_C1_df_dup_SEP_2020_irrs_health%>% janitor::tabyl(cnt_diagnostico_trs_fisico_irr)
#label(CONS_C1_df_dup_SEP_2020_prev4_explore$dg_fis_anemia) <- "Physical Dg. Anemia"
#   cnt_mod_cie_10_or cnt_otros_probl_at_sm_or

#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_

irrs_tr_fis<-irrs(x="cnt_diagnostico_trs_fisico_irr" ,db="CONS_C1_df_dup_SEP_2020_irrs_health")
irrs_tr_fis_in_study<-irrs(x="dg_fis_in_study_irr" ,db="CONS_C1_df_dup_SEP_2020_irrs_health")

irrs_cie_10<-irrs(x="cnt_mod_cie_10_or_irr" ,db="CONS_C1_df_dup_SEP_2020_irrs_health")
irrs_cie_10_in_study<-irrs(x="cnt_mod_cie_10_or_in_study_irr" ,db="CONS_C1_df_dup_SEP_2020_irrs_health")

irrs_otros_pr_sm<-irrs(x="cnt_otros_probl_at_sm_or_irr" ,db="CONS_C1_df_dup_SEP_2020_irrs_health")
irrs_dg_trs_cons_sus_or<-irrs(x="dg_trs_cons_sus_or_irr" ,db="CONS_C1_df_dup_SEP_2020_irrs_health")
```

<br>

The incidence rate of readmission was `r round(as.numeric(irrs_tr_fis$estimate[1]),2)` (95% IC `r round(irrs_tr_fis$conf.int[1],2)`-`r round(irrs_tr_fis$conf.int[2],2)`) in users that had at least one physical condition, compared to users that did not have a physical condition at baseline (p = `r sprintf("%1.3f",irrs_tr_fis$p.value)`).

<br>

```{r fig10_survplot_dg_fis, dpi = 96, warning=F,message=F,fig.align='center', fig.cap="Figure 10. Cum. Hazards to Experience Readmission to SUD Treatment, by Presence of Physical Diagnostic at Baseline", error=T,fig.width=8}
library(survminer)
fit_dg_tr_fis<- survfit(Surv(person_days, event==1) ~cnt_diagnostico_trs_fisico_irr, data=CONS_C1_df_dup_SEP_2020_irrs_health,
                   type ="fleming-harrington", conf.type = "log-log")
library(tidyverse)
library(lubridate)
library(ggfortify) 
fit_dg_tr_fis_na <- fit_dg_tr_fis %>% fortify %>% group_by(strata) %>% mutate(CumHaz = cumsum(n.event/n.risk))

#http://rstudio-pubs-static.s3.amazonaws.com/522481_5e55bec9c94044678e680a6d07e96a2e.html
#https://rstudio-pubs-static.s3.amazonaws.com/258589_cd197f86fb5548ac89d7bcffd4bc6afe.html
#http://pcool.dyndns.org:8080/statsbook/?page_id=513
#http://rstudio-pubs-static.s3.amazonaws.com/316989_83cbe556125645b698c9ff6cf88c4c1a.html
#https://cran.r-project.org/web/packages/survminer/readme/README.html
#https://docs.ufpr.br/~jlpadilha/CE077/Aulas/2.TecnicasNaoParametricas.pdf 
#http://www.columbia.edu/~sjm2186/EPIC_R/packages.pdf
ggsurvplot_fit_dg_tr_fis<-
  ggsurvplot(fit_dg_tr_fis, 
           fun = "cumhaz",
           conf.int = TRUE,
           legend.labs = c("No Physical Condition", "Physical Condition"), 
           risk.table = "abs_pct",
           #ncensor.plot = TRUE,
           ggtheme = theme_classic2(base_size=10),
           risk.table.y.text.col = F,
           risk.table.col="black",
           font.tickslab = c(10),
           risk.table.height = .2,
           risk.table.fontsize = 2.5,
           break.time.by = 365.25,
           pval = F,
           ylim=c(0,10),
           legend = c(0.88, 0.15), 
           legend.title="Phys. Cond.",
           xlab= "Time (in years)", 
           #cumevents=T,
           surv.connect = T,
           censor= F,
           xscale=  "d_y",
           palette = c("skyblue4","orangered4"))
ggsurvplot_fit_dg_tr_fis
 # scale_y_continuous(breaks = sort(c(seq(0, 100, 10), 56)))
```

<br>

Compared to users with no physical diagnosis at baseline, users that had a physical condition in study had an incidence rate of readmission of `r round(as.numeric(irrs_tr_fis_in_study$estimate[1]),2)` (95% IC `r round(irrs_tr_fis_in_study$conf.int[1],2)`-`r round(irrs_tr_fis_in_study$conf.int[2],2)`, p = `r sprintf("%1.4f",irrs_tr_fis_in_study$p.value)`).

<br>

<!--- scales::percent(as.numeric(irrs_tr_fis_in_study$estimate[1])-1) --->

```{r fig11_survplot_dg_fis_in_study, dpi = 96, warning=F,message=F,fig.align='center', fig.cap="Figure 11. Cum. Hazards to Experience Readmission to SUD Treatment, by Presence of Physical Condition In Study at Baseline", error=T,fig.width=8}
library(survminer)
fit_dg_tr_fis_in_study<- survfit(Surv(person_days, event==1) ~dg_fis_in_study_irr, data=CONS_C1_df_dup_SEP_2020_irrs_health,
                   type ="fleming-harrington", conf.type = "log-log")
library(tidyverse)
library(lubridate)
library(ggfortify) 
fit_dg_tr_fis_na <- fit_dg_tr_fis_in_study %>% fortify %>% group_by(strata) %>% mutate(CumHaz = cumsum(n.event/n.risk))

#http://rstudio-pubs-static.s3.amazonaws.com/522481_5e55bec9c94044678e680a6d07e96a2e.html
#https://rstudio-pubs-static.s3.amazonaws.com/258589_cd197f86fb5548ac89d7bcffd4bc6afe.html
#http://pcool.dyndns.org:8080/statsbook/?page_id=513
#http://rstudio-pubs-static.s3.amazonaws.com/316989_83cbe556125645b698c9ff6cf88c4c1a.html
#https://cran.r-project.org/web/packages/survminer/readme/README.html
#https://docs.ufpr.br/~jlpadilha/CE077/Aulas/2.TecnicasNaoParametricas.pdf 
#http://www.columbia.edu/~sjm2186/EPIC_R/packages.pdf
ggsurvplot_fit_dg_tr_fis_in_study<-
  ggsurvplot(fit_dg_tr_fis_in_study, 
           fun = "cumhaz",
           conf.int = TRUE,
           legend.labs = c("No Physical Condition", "Physical Condition In Study"), 
           risk.table = "abs_pct",
           #ncensor.plot = TRUE,
           ggtheme = theme_classic2(base_size=10),
           risk.table.y.text.col = F,
           risk.table.col="black",
           font.tickslab = c(10),
           risk.table.height = .2,
           risk.table.fontsize = 2.5,
           break.time.by = 365.25,
           pval = F,
           ylim=c(0,10),
           legend = c(0.88, 0.15), 
           legend.title="Phys. Cond.",
           xlab= "Time (in years)", 
           #cumevents=T,
           surv.connect = T,
           censor= F,
           xscale=  "d_y",
           palette = c("skyblue4","orangered4"))
ggsurvplot_fit_dg_tr_fis_in_study
 # scale_y_continuous(breaks = sort(c(seq(0, 100, 10), 56)))
```

<br>

Compared to users with no psychiatric diagnosis at baseline, users that had a psychiatric condition in study had an incidence rate of readmission of `r round(as.numeric(irrs_cie_10$estimate[1]),2)` (95% IC `r round(irrs_cie_10$conf.int[1],2)`-`r round(irrs_cie_10$conf.int[2],2)`, p = `r sprintf("%1.4f",irrs_cie_10$p.value)`).

<br>

```{r fig12_survplot_km_early_widthdrawal, dpi = 96, warning=F,message=F,fig.align='center', fig.cap="Figure 12. Cum. Hazards to Experience Readmission to SUD Treatment, by Presence of Psychiatric Condition at Baseline", error=T,fig.width=8}
#irrs_cie_10_in_study irrs_otros_pr_sm  irrs_dg_trs_cons_sus_or dg_trs_cons_sus_or_irr cnt_otros_probl_at_sm_or_irr
library(survminer)
fit_dg_tr_cie_10<- survfit(Surv(person_days, event==1) ~cnt_mod_cie_10_or_irr, data=CONS_C1_df_dup_SEP_2020_irrs_health,
                   type ="fleming-harrington", conf.type = "log-log")
library(tidyverse)
library(lubridate)
library(ggfortify) 
fit_dg_tr_cie_10_na <- fit_dg_tr_cie_10 %>% fortify %>% group_by(strata) %>% mutate(CumHaz = cumsum(n.event/n.risk))

#http://rstudio-pubs-static.s3.amazonaws.com/522481_5e55bec9c94044678e680a6d07e96a2e.html
#https://rstudio-pubs-static.s3.amazonaws.com/258589_cd197f86fb5548ac89d7bcffd4bc6afe.html
#http://pcool.dyndns.org:8080/statsbook/?page_id=513
#http://rstudio-pubs-static.s3.amazonaws.com/316989_83cbe556125645b698c9ff6cf88c4c1a.html
#https://cran.r-project.org/web/packages/survminer/readme/README.html
#https://docs.ufpr.br/~jlpadilha/CE077/Aulas/2.TecnicasNaoParametricas.pdf 
#http://www.columbia.edu/~sjm2186/EPIC_R/packages.pdf
ggsurvplot_fit_dg_tr_cie_10<-
  ggsurvplot(fit_dg_tr_cie_10, 
           fun = "cumhaz",
           conf.int = TRUE,
           legend.labs = c("No Psychiatric Condition", "Psychiatric Condition"), 
           risk.table = "abs_pct",
           #ncensor.plot = TRUE,
           ggtheme = theme_classic2(base_size=10),
           risk.table.y.text.col = F,
           risk.table.col="black",
           font.tickslab = c(10),
           risk.table.height = .2,
           risk.table.fontsize = 2.5,
           break.time.by = 365.25,
           pval = F,
           ylim=c(0,10),
           legend = c(0.88, 0.15), 
           legend.title="Psych. Cond.",
           xlab= "Time (in years)", 
           #cumevents=T,
           surv.connect = T,
           censor= F,
           xscale=  "d_y",
           palette = c("skyblue4","orangered4"))
ggsurvplot_fit_dg_tr_cie_10
 # scale_y_continuous(breaks = sort(c(seq(0, 100, 10), 56)))
```

<br>

Compared to users with no psychiatric diagnosis at baseline, users that had a psychiatric condition in study had an incidence rate of readmission of `r round(as.numeric(irrs_cie_10_in_study$estimate[1]),2)` (95% IC `r round(irrs_cie_10_in_study$conf.int[1],2)`-`r round(irrs_cie_10_in_study$conf.int[2],2)`, p = `r sprintf("%1.4f",irrs_cie_10_in_study$p.value)`).

<br>

```{r fig13_survplot_km_early_widthdrawal, dpi = 96, warning=F,message=F,fig.align='center', fig.cap="Figure 13. Cum. Hazards to Experience Readmission to SUD Treatment, by Presence of Physical Diagnostic In Study at Baseline", error=T,fig.width=8}
#irrs_cie_10_in_study irrs_otros_pr_sm  irrs_dg_trs_cons_sus_or dg_trs_cons_sus_or_irr cnt_otros_probl_at_sm_or_irr
library(survminer)
fit_dg_tr_cie_10_in_study<- survfit(Surv(person_days, event==1) ~cnt_mod_cie_10_or_in_study_irr, data=CONS_C1_df_dup_SEP_2020_irrs_health,
                   type ="fleming-harrington", conf.type = "log-log")
library(tidyverse)
library(lubridate)
library(ggfortify) 
fit_dg_tr_fis_na <- fit_dg_tr_fis %>% fortify %>% group_by(strata) %>% mutate(CumHaz = cumsum(n.event/n.risk))

#http://rstudio-pubs-static.s3.amazonaws.com/522481_5e55bec9c94044678e680a6d07e96a2e.html
#https://rstudio-pubs-static.s3.amazonaws.com/258589_cd197f86fb5548ac89d7bcffd4bc6afe.html
#http://pcool.dyndns.org:8080/statsbook/?page_id=513
#http://rstudio-pubs-static.s3.amazonaws.com/316989_83cbe556125645b698c9ff6cf88c4c1a.html
#https://cran.r-project.org/web/packages/survminer/readme/README.html
#https://docs.ufpr.br/~jlpadilha/CE077/Aulas/2.TecnicasNaoParametricas.pdf 
#http://www.columbia.edu/~sjm2186/EPIC_R/packages.pdf
ggsurvplot_fit_dg_tr_cie_10_in_study<-
  ggsurvplot(fit_dg_tr_cie_10_in_study, 
           fun = "cumhaz",
           conf.int = TRUE,
           legend.labs = c("No Psychiatric Diagnostic", "Psychiatric Diagnostic In Study"), 
           risk.table = "abs_pct",
           #ncensor.plot = TRUE,
           ggtheme = theme_classic2(base_size=10),
           risk.table.y.text.col = F,
           risk.table.col="black",
           font.tickslab = c(10),
           risk.table.height = .2,
           risk.table.fontsize = 2.5,
           break.time.by = 365.25,
           pval = F,
           ylim=c(0,10),
           legend = c(0.88, 0.15), 
           legend.title="Cause of Disch.",
           xlab= "Time (in years)", 
           #cumevents=T,
           surv.connect = T,
           censor= F,
           xscale=  "d_y",
           palette = c("skyblue4","orangered4"))
ggsurvplot_fit_dg_tr_cie_10_in_study
 # scale_y_continuous(breaks = sort(c(seq(0, 100, 10), 56)))
```

<br>

Compared to users with no other problems related to mental health conditions worth clinical surveillance, users that had other problems related to mental health conditions had an incidence rate of readmission of `r round(as.numeric(irrs_otros_pr_sm$estimate[1]),2)` (95% IC `r round(irrs_otros_pr_sm$conf.int[1],2)`-`r round(irrs_otros_pr_sm$conf.int[2],2)`, p = `r sprintf("%1.4f",irrs_otros_pr_sm$p.value)`).

<br>

```{r fig14_survplot_otros_pr_at_sm, dpi = 96, warning=F,message=F,fig.align='center', fig.cap="Figure 14. Cum. Hazards to Experience Readmission to SUD Treatment, by Presence of Other Problems Related to Mental Health at Baseline", error=T,fig.width=8}
#irrs_otros_pr_sm  irrs_dg_trs_cons_sus_or dg_trs_cons_sus_or_irr cnt_otros_probl_at_sm_or_irr
library(survminer)
fit_otros_probl_at_sm<- survfit(Surv(person_days, event==1) ~cnt_otros_probl_at_sm_or_irr, data=CONS_C1_df_dup_SEP_2020_irrs_health,
                   type ="fleming-harrington", conf.type = "log-log")
library(tidyverse)
library(lubridate)
library(ggfortify) 
fit_otros_probl_at_sm_na <- fit_otros_probl_at_sm %>% fortify %>% group_by(strata) %>% mutate(CumHaz = cumsum(n.event/n.risk))

#http://rstudio-pubs-static.s3.amazonaws.com/522481_5e55bec9c94044678e680a6d07e96a2e.html
#https://rstudio-pubs-static.s3.amazonaws.com/258589_cd197f86fb5548ac89d7bcffd4bc6afe.html
#http://pcool.dyndns.org:8080/statsbook/?page_id=513
#http://rstudio-pubs-static.s3.amazonaws.com/316989_83cbe556125645b698c9ff6cf88c4c1a.html
#https://cran.r-project.org/web/packages/survminer/readme/README.html
#https://docs.ufpr.br/~jlpadilha/CE077/Aulas/2.TecnicasNaoParametricas.pdf 
#http://www.columbia.edu/~sjm2186/EPIC_R/packages.pdf
ggsurvplot_fit_otros_probl_at_sm<-
  ggsurvplot(fit_otros_probl_at_sm, 
           fun = "cumhaz",
           conf.int = TRUE,
           legend.labs = c("No Other Mental Health Problems", "Other Mental Health Problems"), 
           risk.table = "abs_pct",
           #ncensor.plot = TRUE,
           ggtheme = theme_classic2(base_size=10),
           risk.table.y.text.col = F,
           risk.table.col="black",
           font.tickslab = c(10),
           risk.table.height = .2,
           risk.table.fontsize = 2.5,
           break.time.by = 365.25,
           pval = F,
           ylim=c(0,10),
           legend = c(0.88, 0.15), 
           legend.title="Other Mental Health Pr.",
           xlab= "Time (in years)", 
           #cumevents=T,
           surv.connect = T,
           censor= F,
           xscale=  "d_y",
           palette = c("skyblue4","orangered4"))
ggsurvplot_fit_otros_probl_at_sm
 # scale_y_continuous(breaks = sort(c(seq(0, 100, 10), 56)))
```

<br>

Compared to users with hazardous consumption, users with a drug dependence had an incidence rate of readmission of `r round(as.numeric(irrs_dg_trs_cons_sus_or$estimate[1]),2)` (95% IC `r round(irrs_dg_trs_cons_sus_or$conf.int[1],2)`-`r round(irrs_dg_trs_cons_sus_or$conf.int[2],2)`, p = `r sprintf("%1.4f",irrs_dg_trs_cons_sus_or$p.value)`).

<br>

```{r fig15_survplot_dg_trs_cons_sus, dpi = 96, warning=F,message=F,fig.align='center', fig.cap="Figure 15. Cum. Hazards to Experience Readmission to SUD Treatment, by Substance Use Disorder at Baseline", error=T,fig.width=8}
#dg_trs_cons_sus_or_irr  irrs_dg_trs_cons_sus_or
library(survminer)
fit_dg_trs_cons_sus_or<- survfit(Surv(person_days, event==1) ~dg_trs_cons_sus_or_irr, data=CONS_C1_df_dup_SEP_2020_irrs_health,
                   type ="fleming-harrington", conf.type = "log-log")
library(tidyverse)
library(lubridate)
library(ggfortify) 
fit_dg_trs_cons_sus_or_na <- fit_dg_trs_cons_sus_or %>% fortify %>% group_by(strata) %>% mutate(CumHaz = cumsum(n.event/n.risk))

#http://rstudio-pubs-static.s3.amazonaws.com/522481_5e55bec9c94044678e680a6d07e96a2e.html
#https://rstudio-pubs-static.s3.amazonaws.com/258589_cd197f86fb5548ac89d7bcffd4bc6afe.html
#http://pcool.dyndns.org:8080/statsbook/?page_id=513
#http://rstudio-pubs-static.s3.amazonaws.com/316989_83cbe556125645b698c9ff6cf88c4c1a.html
#https://cran.r-project.org/web/packages/survminer/readme/README.html
#https://docs.ufpr.br/~jlpadilha/CE077/Aulas/2.TecnicasNaoParametricas.pdf 
#http://www.columbia.edu/~sjm2186/EPIC_R/packages.pdf
ggsurvplot_fit_dg_trs_cons_sus_or<-
  ggsurvplot(fit_dg_trs_cons_sus_or, 
           fun = "cumhaz",
           conf.int = TRUE,
           legend.labs = c("Hazardous consumption", "Drug dependence"), 
           risk.table = "abs_pct",
           #ncensor.plot = TRUE,
           ggtheme = theme_classic2(base_size=10),
           risk.table.y.text.col = F,
           risk.table.col="black",
           font.tickslab = c(10),
           risk.table.height = .2,
           risk.table.fontsize = 2.5,
           break.time.by = 365.25,
           pval = F,
           ylim=c(0,10),
           legend = c(0.88, 0.15), 
           legend.title="Substance Use Disorder",
           xlab= "Time (in years)", 
           #cumevents=T,
           surv.connect = T,
           censor= F,
           xscale=  "d_y",
           palette = c("skyblue4","orangered4"))
ggsurvplot_fit_dg_trs_cons_sus_or
 # scale_y_continuous(breaks = sort(c(seq(0, 100, 10), 56)))
```

# Objectives (2021)

## Incidence rate of readmissions, by different characteristics


```{r seq1, warning=FALSE}
invisible("1.    To describe the incidence rate of SUD treatment readmissions, emergency rooms visits, hospitalizations, and death by type of health conditions, among all adult patients with public health insurance admitted to SUD treatment in Chile during 2010-2018")
invisible("https://cran.r-project.org/web/packages/riskCommunicator/vignettes/Vignette_newbieRusers.html#continuous-exposure-example")

cat("Total of rows")
nrow(CONS_C1_df_dup_SEP_2020_irrs_health)
cat("Distinct HASHs")
length(unique(CONS_C1_df_dup_SEP_2020_irrs_health$hash_key))
cat("Distinct HASHs")

invisible("Event: Usuarios con Tratamiento Posterior (1=Reingreso x HASH)")

# table(CONS_C1_df_dup_SEP_2020_irrs_health$tipo_de_programa_2,CONS_C1_df_dup_SEP_2020_irrs_health$tipo_de_plan_2)

tablas_inc<-
rbind(data.frame(biostat3::survRate(Surv(person_years, event==1) ~ edad_grupos, 
                                    data=CONS_C1_df_dup_SEP_2020_irrs_health))%>% dplyr::rename("grupos"=1),
      data.frame(biostat3::survRate(Surv(person_years, event==1) ~ sus_ini_mod_mvv, 
                                    data=CONS_C1_df_dup_SEP_2020_irrs_health))%>% dplyr::rename("grupos"=1),
      data.frame(biostat3::survRate(Surv(person_years, event==1) ~ sus_ini_mod, 
                                    data=CONS_C1_df_dup_SEP_2020_irrs_health))%>% dplyr::rename("grupos"=1),
      data.frame(biostat3::survRate(Surv(person_years, event==1) ~ sus_principal_mod, 
                                    data=CONS_C1_df_dup_SEP_2020_irrs_health))%>% dplyr::rename("grupos"=1),
      data.frame(biostat3::survRate(Surv(person_years, event==1) ~ ifelse(grepl("PR",tipo_de_plan_2),"Residential","Ambulatory"), 
                                    data=CONS_C1_df_dup_SEP_2020_irrs_health))%>% dplyr::rename("grupos"=1),
      data.frame(biostat3::survRate(Surv(person_years, event==1) ~ sexo_2, 
                                    data=CONS_C1_df_dup_SEP_2020_irrs_health))%>% dplyr::rename("grupos"=1),
      data.frame(biostat3::survRate(Surv(person_years, event==1) ~ motivodeegreso_mod_imp, 
                                    data=CONS_C1_df_dup_SEP_2020_irrs_health))%>% dplyr::rename("grupos"=1),
      data.frame(biostat3::survRate(Surv(person_years, event==1) ~ tipo_de_programa_2,
                                    data=CONS_C1_df_dup_SEP_2020_irrs_health))%>% dplyr::rename("grupos"=1))  


  #                    M-PAB M-PAI  M-PR PG-PAB PG-PAI PG-PR
  # General population     0     0     0  32047  35336  9372
  # Women specific        66  4818  3334      0      0     0

#tipo_de_programa_2= 'Tipo de Programa del Registro Más Largo entre Entradas Intermedias/Type of Program of the Largest Entry Among Intermediate Entries'
# motivodeegreso_mod_imp= 'Motivo de Egreso (con abandono temprano y tardío)(Imputados KNN & Lógico) del Último Registro(b)/Cause of Discharge (with late and early withdrawal)(Imputed KNN & Logic) of the Last Entry(b)',
#sus_ini_mod= Sustancia de Inicio (Sólo más frecuentes)/Starting Substance (Only more frequent)
#sus_ini_mod_mvv= "Sustancia de Inicio (Valor más vulnerable)/Starting Substance (Most vulnerable value)",
#edad_grupos= 'Edad agrupada/Age in groups',
#sexo_2= 'Sexo Usuario/Sex of User',

data.table::data.table(tablas_inc, keep.rownames = F)%>% 
  dplyr::mutate(grupos=gsub("Pasta Base","Cocaine paste",grupos)) %>% 
  dplyr::mutate(grupos=gsub("Otros","Other",grupos)) %>% 
  dplyr::mutate(grupos=gsub("Cocaína","Cocaine hydrochloride",grupos)) %>% 
  dplyr::mutate(grupos=gsub("Marihuana","Marijuana",grupos)) %>%  
  dplyr::mutate(rate=round(rate*1000,0),lower=round(lower*1000,0), upper=round(upper*1000,0))%>% 
knitr::kable(format="html",caption= "Table 5. Summary of incidence rates of readmission",
             col.names = c("Grupos","Person-years","Event","Rate","Lower bound", "Upper bound"))%>%
  kableExtra::add_footnote(c("Note. Events per 1,000 person-years; Function used:  https://www.rdocumentation.org/packages/biostat3/versions/0.1.5/topics/survRate"), notation = "none")%>%
  kableExtra::kable_classic() %>% 
  kableExtra::group_rows("Age (in groups)",1,5)%>% 
  kableExtra::group_rows("Starting Substance (most vulnerable)",6,10)%>%
  kableExtra::group_rows("Starting Substance (most frequent)",11,15)%>% 
  kableExtra::group_rows("Substance at admission",16,20)%>%
  kableExtra::group_rows("Treatment Modality",21,22)%>%
  kableExtra::group_rows("Sex",23,24)%>%
  kableExtra::group_rows("Treatment outcome",25,30)%>%
  kableExtra::group_rows("Treatment Program",31,32)%>% 
  kableExtra::scroll_box(width = "100%", height = "600px")
```

<br>

<br>

```{r tr_outcome_readm, warning=FALSE}
library(survminer)
tr_outcome_fit<- survfit(Surv(outcome_to_readmission, event==1) ~ strata(motivodeegreso_mod_imp), 
                      data=CONS_C1_df_dup_SEP_2020_irrs_health%>% 
                            dplyr::mutate(outcome_to_readmission= dplyr::case_when(
                        event==1~ (fech_ing_next_treat-fech_egres_num)/365.25,# & grepl("",comp_status)
                        event==0~ (as.numeric(as.Date("2019-11-13"))-fech_egres_num)/365.25)),
            type      = "kaplan-meier",
            error     = "greenwood",
            conf.type = "log-log") 

tr_outcome_na <- tr_outcome_fit %>% fortify %>% group_by(strata) %>% mutate(CumHaz = cumsum(n.event/n.risk)) 
```

```{r fig5a_survplot_tipo_programa, dpi = 320, warning=F,message=F,fig.align='center', fig.cap="Figure 16. Cum. Hazards to Experience Readmission to SUD Treatment, Stratified by Treatment Outcome", error=T, fig.height=10, fig.width=10}
ggsurvplot_tr_outcome_fit<-
  ggsurvplot(tr_outcome_fit, 
           fun = "cumhaz",
           conf.int = TRUE,
           legend.labs = c("Late drop-out", "Early drop-out", "Administrative discharge", "Therapeutic discharge","Referral to other treatment", "Ongoing treatment"), 
           risk.table = "abs_pct",
           #ncensor.plot = TRUE,
           ggtheme = theme_classic2(base_size=10),
           #ylim=c(0,1),
           legend = c(0.88, 0.25), 
           legend.title="Treatment Outcome",
           xlab= "Time (in years)", 
           cumevents = TRUE,
           surv.connect = T,
           tables.theme = theme_cleantable(),
           censor= F,
           tables.height = 0.15,
           risk.table.y.text.col = F,
           risk.table.col="black",
           font.tickslab = c(10),
           risk.table.height = .15,
           risk.table.fontsize = 2.5,
           fontsize = 2.5, #sirve para el cumevents
           cumevents.y.text.col = F,
           cumevents.col="black",
           cumevents.height = .15,
           break.time.by = 1,
           pval = F,
           #xscale=  "d_y", #scale days to years
           palette = c("#C6A477","#ECD59F","#ABD1DC","#C2CBC5","#5A6794","#1C2135"))
ggsurvplot_tr_outcome_fit
```

<br>

## Cox regression, Proportional hazards of the association between treatment outcomes and readmission

```{r tr_outcome_readm_cox, warning=FALSE}
cox_zph_obj<-
cox.zph(coxph(Surv(outcome_to_readmission,event==1)~factor(motivodeegreso_mod_imp),data=CONS_C1_df_dup_SEP_2020_irrs_health%>%
          dplyr::mutate(outcome_to_readmission= dplyr::case_when(
              event==1~ (fech_ing_next_treat-fech_egres_num)/365.25,# & grepl("",comp_status)
              event==0~ (as.numeric(as.Date("2019-11-13"))-fech_egres_num)/365.25)) %>% 
          dplyr::filter(motivodeegreso_mod_imp!="Ongoing treatment"),method = "breslow"))

coxph(Surv(outcome_to_readmission,event==1)~factor(motivodeegreso_mod_imp),data=CONS_C1_df_dup_SEP_2020_irrs_health%>% 
          dplyr::mutate(outcome_to_readmission= dplyr::case_when(
              event==1~ (fech_ing_next_treat-fech_egres_num)/365.25,# & grepl("",comp_status)
              event==0~ (as.numeric(as.Date("2019-11-13"))-fech_egres_num)/365.25)) %>% 
          dplyr::filter(motivodeegreso_mod_imp!="Ongoing treatment"),method = "breslow") %>% 
  broom::tidy(exp=T, conf.int=T) %>% 
    dplyr::mutate(term=gsub("factor\\(motivodeegreso_mod_imp\\)","",term)) %>% 

  knitr::kable("html", digits=3, caption= "Table 6. Cox Regression") %>% 
  kableExtra::kable_classic() %>% 
  kableExtra::add_footnote(paste0("Note. Grambsch and Therneau PH test: Chi2(",round(cox_zph_obj$table[2,2],2),")=",round(cox_zph_obj$table[2,1],2),", p",
         ifelse(as.numeric(cox_zph_obj$table[2,3])<.001,"<0.001",
         ifelse(as.numeric(cox_zph_obj$table[2,3])<.01,"<0.01",
                ifelse(as.numeric(cox_zph_obj$table[2,3])<.05,"<0.05",paste0("=",round(cox_zph_obj$table[2,3],2)))))), notation="none")
#Common baseline hazard rate λ(t)
#Time invariant regression coefficients β:
#The Null hypothesis of the test is that the residuals are a pattern-less random-walk in time around a zero mean line
```

<br>

## Parametric estimation of the association between treatment outcomes and readmission (raw)

<br>

<div style="border: 1px solid #ddd; padding: 5px; overflow-y: scroll; height:350px; overflow-x: scroll; width:100%">

```{r fit_surv_parametric_simple_model, echo=T, error=T, fig.align="center", warning=FALSE, paged.print=TRUE, eval=T}
#```{r fit_surv_parametric_simple_model,dpi = 320, warning=F,message=F,fig.align='center', error=T}

invisible(" 2. To estimate the risk and the time-to-event of being readmitted to SUD treatment, by SUD treatment outcome (i.e., administrative discharge, early and late drop-outs, therapeutic discharge) among adult patients with public health insurance who were admitted to SUD treatment in Chile during 2010-2018.")
#_#_#_#_#_#_#_#_#_#_#_

n_iter<-10000
tiempo_antes_fits_obj <- Sys.time()

CONS_C1_df_dup_SEP_2020_irrs_health_survreg<-
CONS_C1_df_dup_SEP_2020_irrs_health%>%
          dplyr::mutate(outcome_to_readmission= dplyr::case_when(
              event==1~ (fech_ing_next_treat-fech_egres_num)/365.25,# & grepl("",comp_status)
              event==0~ (as.numeric(as.Date("2019-11-13"))-fech_egres_num)/365.25)) %>% 
  #https://stats.stackexchange.com/questions/176376/invalid-survival-times-for-this-distribution
          dplyr:::mutate(outcome_to_readmission=dplyr::case_when(outcome_to_readmission==0~.0001,T~outcome_to_readmission))%>%           
  dplyr::filter(motivodeegreso_mod_imp!="Ongoing treatment") %>% 
  dplyr::mutate(motivodeegreso_mod_imp= relevel(motivodeegreso_mod_imp, ref = "Therapeutic discharge")) %>% 
  dplyr::mutate(sus_principal_mod= relevel(sus_principal_mod, ref = "Alcohol")) %>% 
  dplyr::mutate(sus_ini_mod= relevel(sus_ini_mod, ref = "Alcohol")) %>% 
  dplyr::mutate(sus_ini_mod_mvv= relevel(sus_ini_mod_mvv, ref = "Alcohol")) %>% 
  dplyr::mutate(edad_grupos= factor(edad_grupos, levels=c("18-24", "25-29", "30-35", "36-45", ">45"),ordered =T))

#survit(Surv(event~outcome_to_readmission)~edad_grupos, data=CONS_C1_df_dup_SEP_2020_irrs_health_survreg)
# sus_principal_mod sus_ini_mod sus_ini_mod_mvv edad_grupos
#coxph(Surv(outcome_to_readmission,event==1)~edad_grupos, data=CONS_C1_df_dup_SEP_2020_irrs_health_survreg)

# library("muhaz")
  kernel_haz_obj<-data.frame()
  haz <- list()
for (i in 1:length(c("Therapeutic discharge", "Late Drop-out", "Early Drop-out", "Administrative discharge", "Referral to another treatment"))) {
  s<-c("Therapeutic discharge", "Late Drop-out", "Early Drop-out", "Administrative discharge", "Referral to another treatment")[i]
  haz[[i]] <- do.call("muhaz", c(list(times=CONS_C1_df_dup_SEP_2020_irrs_health_survreg$outcome_to_readmission, delta=CONS_C1_df_dup_SEP_2020_irrs_health_survreg$event, subset=CONS_C1_df_dup_SEP_2020_irrs_health_survreg$motivodeegreso_mod_imp==s)))
  
   kernel_haz_obj <- rbind(kernel_haz_obj,data.table(time = haz[[i]]$est.grid,
                          est = haz[[i]]$haz.est,
                          dist = "Kernel density",
                          outcome= s))
}

#Specify the formula
fitform_obj <- Surv(outcome_to_readmission, event==1) ~ 1
fitform_objc <- Surv(outcome_to_readmission, event==1) ~ motivodeegreso_mod_imp


  fits_wei_obj <- flexsurvreg(formula=fitform_obj,
                               data = CONS_C1_df_dup_SEP_2020_irrs_health_survreg,
                               dist = "weibull")
  fits_weiph_obj <- flexsurvreg(formula=fitform_obj,
                               data = CONS_C1_df_dup_SEP_2020_irrs_health_survreg,
                               dist = "weibullph")
  fits_llogis_obj <- flexsurvreg(formula=fitform_obj,
                               data = CONS_C1_df_dup_SEP_2020_irrs_health_survreg,
                               dist = "llogis")
  fits_gam_obj <- flexsurvreg(formula=fitform_obj,
                               data = CONS_C1_df_dup_SEP_2020_irrs_health_survreg,
                               dist = "gamma")
#LOS ERRORES OCURREN CUANDO NO HAY COVARIABLES
#In (function (q, shape, rate = 1, scale = 1/rate, lower.tail = TRUE,  ... :   NaNs produced
#gamma no funcionó: NaNs producedNaNs producedNaNs producedNaNs producedNaNs producedNaNs producedNaNs producedNaNs producedNaNs producedNaNs producedNaNs producedNaNs producedNaNs producedNaNs producedNaNs producedNaNs producedNaNs produced
  fits_ggam_obj <- flexsurvreg(formula=fitform_obj,
                               data = CONS_C1_df_dup_SEP_2020_irrs_health_survreg,
                               dist = "gengamma")
  fits_gomp_obj <- flexsurvreg(formula=fitform_obj,
                                data = CONS_C1_df_dup_SEP_2020_irrs_health_survreg,
                                dist = "gompertz")
  fits_logn_obj <- flexsurvreg(formula=fitform_obj,
                                data = CONS_C1_df_dup_SEP_2020_irrs_health_survreg,
                                dist = "lnorm")
  fits_exp_obj <- flexsurvreg(formula=fitform_obj,
                               data = CONS_C1_df_dup_SEP_2020_irrs_health_survreg,
                               dist = "exp")

no_attempts <- 20

    r <- NULL
    attempt <- 0
    while( is.null(r) && attempt <= no_attempts ) {
      attempt <- attempt + 1
      try(
          r <- flexsurvreg(formula=fitform_obj,
                               data = CONS_C1_df_dup_SEP_2020_irrs_health_survreg,
                               dist = "gengamma.orig")
      )
    }
    fits_ggam_orig_obj <- r


    r <- NULL
    attempt <- 0
    while( is.null(r) && attempt <= no_attempts ) {
      attempt <- attempt + 1
      try(
          r <- flexsurvreg(formula=fitform_obj,
                               data = CONS_C1_df_dup_SEP_2020_irrs_health_survreg,
                               dist = "genf.orig")
      )
    }
    fits_genf_orig_obj <- r
    

    r <- NULL
    attempt <- 0
    while( is.null(r) && attempt <= no_attempts ) {
      attempt <- attempt + 1
      try(
        r <-  flexsurvreg(formula=fitform_obj,
                               data = CONS_C1_df_dup_SEP_2020_irrs_health_survreg,
                               dist = "genf")
      )
    }
    fits_genf_obj <- r
  

    r <- NULL
    attempt <- 0
    while( is.null(r) && attempt <= no_attempts ) {
      attempt <- attempt + 1
      try(
        r <- flexsurvspline(formula=fitform_obj,k=1,
                               data = CONS_C1_df_dup_SEP_2020_irrs_health_survreg)
      )
    }
    fits_rp02_obj <- r

    r <- NULL
    attempt <- 0
    while( is.null(r) && attempt <= no_attempts ) {
      attempt <- attempt + 1
      try(
        r <- flexsurvspline(formula=fitform_obj,k=2,
                               data = CONS_C1_df_dup_SEP_2020_irrs_health_survreg)
      )
    }
    fits_rp03_obj <- r

    r <- NULL
    attempt <- 0
    while( is.null(r) && attempt <= no_attempts ) {
      attempt <- attempt + 1
      try(
        r <- flexsurvspline(formula=fitform_obj,k=3,
                               data = CONS_C1_df_dup_SEP_2020_irrs_health_survreg)
      )
    }
    fits_rp04_obj <- r

    r <- NULL
    attempt <- 0
    while( is.null(r) && attempt <= no_attempts ) {
      attempt <- attempt + 1
      try(
        r <- flexsurvspline(formula=fitform_obj,k=4,
                               data = CONS_C1_df_dup_SEP_2020_irrs_health_survreg)
      )
    }
    fits_rp05_obj <- r

km.lc_obj <- survfit(formula= fitform_obj, data = CONS_C1_df_dup_SEP_2020_irrs_health_survreg)


#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_


  fits_wei_objc <- flexsurvreg(formula=fitform_objc,
                               data = CONS_C1_df_dup_SEP_2020_irrs_health_survreg,
                               dist = "weibull")
  fits_weiph_objc <- flexsurvreg(formula=fitform_objc,
                               data = CONS_C1_df_dup_SEP_2020_irrs_health_survreg,
                               dist = "weibullph")
  fits_llogis_objc <- flexsurvreg(formula=fitform_objc,
                               data = CONS_C1_df_dup_SEP_2020_irrs_health_survreg,
                               dist = "llogis")
  fits_gam_objc <- flexsurvreg(formula=fitform_objc,
                               data = CONS_C1_df_dup_SEP_2020_irrs_health_survreg,
                               dist = "gamma")
#LOS ERRORES OCURREN CUANDO NO HAY COVARIABLES
#In (function (q, shape, rate = 1, scale = 1/rate, lower.tail = TRUE,  ... :   NaNs produced
#gamma no funcionó: NaNs producedNaNs producedNaNs producedNaNs producedNaNs producedNaNs producedNaNs producedNaNs producedNaNs producedNaNs producedNaNs producedNaNs producedNaNs producedNaNs producedNaNs producedNaNs producedNaNs produced
  fits_ggam_objc <- flexsurvreg(formula=fitform_objc,
                               data = CONS_C1_df_dup_SEP_2020_irrs_health_survreg,
                               dist = "gengamma")
  fits_gomp_objc <- flexsurvreg(formula=fitform_objc,
                                data = CONS_C1_df_dup_SEP_2020_irrs_health_survreg,
                                dist = "gompertz")
  fits_logn_objc <- flexsurvreg(formula=fitform_objc,
                                data = CONS_C1_df_dup_SEP_2020_irrs_health_survreg,
                                dist = "lnorm")
  fits_exp_objc <- flexsurvreg(formula=fitform_objc,
                               data = CONS_C1_df_dup_SEP_2020_irrs_health_survreg,
                               dist = "exp")

no_attempts <- 20

    r <- NULL
    attempt <- 0
    while( is.null(r) && attempt <= no_attempts ) {
      attempt <- attempt + 1
      try(
          r <- flexsurvreg(formula=fitform_objc,
                               data = CONS_C1_df_dup_SEP_2020_irrs_health_survreg,
                               dist = "gengamma.orig")
      )
    }
    fits_ggam_orig_objc <- r


    r <- NULL
    attempt <- 0
    while( is.null(r) && attempt <= no_attempts ) {
      attempt <- attempt + 1
      try(
          r <- flexsurvreg(formula=fitform_objc,
                               data = CONS_C1_df_dup_SEP_2020_irrs_health_survreg,
                               dist = "genf.orig")
      )
    }
    fits_genf_orig_objc <- r
    

    r <- NULL
    attempt <- 0
    while( is.null(r) && attempt <= no_attempts ) {
      attempt <- attempt + 1
      try(
        r <-  flexsurvreg(formula=fitform_objc,
                               data = CONS_C1_df_dup_SEP_2020_irrs_health_survreg,
                               dist = "genf")
      )
    }
    fits_genf_objc <- r
  

    r <- NULL
    attempt <- 0
    while( is.null(r) && attempt <= no_attempts ) {
      attempt <- attempt + 1
      try(
        r <- flexsurvspline(formula=fitform_objc,k=1,
                               data = CONS_C1_df_dup_SEP_2020_irrs_health_survreg)
      )
    }
    fits_rp02_objc <- r

    r <- NULL
    attempt <- 0
    while( is.null(r) && attempt <= no_attempts ) {
      attempt <- attempt + 1
      try(
        r <- flexsurvspline(formula=fitform_objc,k=2,
                               data = CONS_C1_df_dup_SEP_2020_irrs_health_survreg)
      )
    }
    fits_rp03_objc <- r

    r <- NULL
    attempt <- 0
    while( is.null(r) && attempt <= no_attempts ) {
      attempt <- attempt + 1
      try(
        r <- flexsurvspline(formula=fitform_objc,k=3,
                               data = CONS_C1_df_dup_SEP_2020_irrs_health_survreg)
      )
    }
    fits_rp04_objc <- r

    r <- NULL
    attempt <- 0
    while( is.null(r) && attempt <= no_attempts ) {
      attempt <- attempt + 1
      try(
        r <- flexsurvspline(formula=fitform_objc,k=4,
                               data = CONS_C1_df_dup_SEP_2020_irrs_health_survreg)
      )
    }
    fits_rp05_objc <- r
```

</div>

<br>

```{r fit_obj, eval=T, echo=T, fig.cap="Figure 17. Vissual Assessment of Survival Curves", fig.height=10, fig.width=10, warning=FALSE, paged.print=TRUE, fig.align="center", dpi=320, warnings=F, error=T}

get_distinct_hues <- function(ncolor,s=0.5,v=0.95,seed=2125) {
  golden_ratio_conjugate <- 0.618033988749895
  set.seed(seed)
  h <- runif(1)
  H <- vector("numeric",ncolor)
  for(i in seq_len(ncolor)) {
    h <- (h + golden_ratio_conjugate) %% 1
    H[i] <- h
  }
  hsv(H,s=s,v=v)
}
distinct_hues_obj<-get_distinct_hues(15)


plot(km.lc_obj, col="red", conf.int=F);
  lines(fits_wei_obj, col=distinct_hues_obj[1], ci=F);
  lines(fits_weiph_obj, col=distinct_hues_obj[2], ci=F);
  lines(fits_gomp_obj, col=distinct_hues_obj[3], ci=F);
  lines(fits_llogis_obj, col=distinct_hues_obj[4], ci=F);#A0A36D
  lines(fits_gam_obj, col=distinct_hues_obj[5], ci=F);
  lines(fits_ggam_obj, col=distinct_hues_obj[6], ci=F);
  lines(fits_ggam_orig_obj, col=distinct_hues_obj[7], ci=F);
  lines(fits_logn_obj, col=distinct_hues_obj[8], ci=F);
  lines(fits_exp_obj,col=distinct_hues_obj[9], ci=F);
  lines(fits_genf_obj,col=distinct_hues_obj[10], ci=F);
  lines(fits_genf_orig_obj,col=distinct_hues_obj[11], ci=F);  
  lines(fits_rp02_obj,col=distinct_hues_obj[12], ci=F, lty = 2);
  lines(fits_rp03_obj,col=distinct_hues_obj[13], ci=F, lty = 2);
  lines(fits_rp04_obj,col=distinct_hues_obj[14], ci=F, lty = 2);
  lines(fits_rp05_obj,col=distinct_hues_obj[15], ci=F, lty = 3)
  
legend("bottomleft", legend = c("Kaplan-Meier","Weibull (AFT)", "Weibull (PH)", "Gompertz", "Log-logistic", "Gamma",
                "Generalized gamma", "Generalized gamma (orig)", "Lognormal", "Exponential", "Generalized F","Generalized F (orig)","RP2","RP3","RP4","RP5"), col = 
         c("red",distinct_hues_obj), 
       title = "Distributions", cex = .95, bty = "n", lty=c(rep(1,12),rep(2,4)),lwd=3)# lty = 1:2, 
title(main="From outcome to readmission")
endTime_obj <- Sys.time()

paste0("Time in process: ");endTime_obj - tiempo_antes_fits_obj

#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_
#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_

#For more complicated models, users should specify what covariate values they want summaries for, rather than relying on the default


if(no_mostrar==1){
jpeg(paste0(gsub("/SUD_CL","",getwd()),"/exp_surv_obj_int_only.jpg"), height=30, width= 30, res= 600, units = "in")

plot(km.lc_obj, col="red", conf.int=F);
  lines(fits_wei_obj, col=distinct_hues_obj[1], ci=F);
  lines(fits_weiph_obj, col=distinct_hues_obj[2], ci=F);
  lines(fits_gomp_obj, col=distinct_hues_obj[3], ci=F);
  lines(fits_llogis_obj, col=distinct_hues_obj[4], ci=F);#A0A36D
  lines(fits_gam_obj, col=distinct_hues_obj[5], ci=F);
  lines(fits_ggam_obj, col=distinct_hues_obj[6], ci=F);
  lines(fits_ggam_orig_obj, col=distinct_hues_obj[7], ci=F);
  lines(fits_logn_obj, col=distinct_hues_obj[8], ci=F);
  lines(fits_exp_obj,col=distinct_hues_obj[9], ci=F);
  lines(fits_genf_obj,col=distinct_hues_obj[10], ci=F, lty = 2);
  lines(fits_genf_orig_obj,col=distinct_hues_obj[11], ci=F, lty = 2);  
  lines(fits_rp02_obj,col=distinct_hues_obj[12], ci=F, lty = 2);
  lines(fits_rp03_obj,col=distinct_hues_obj[13], ci=F, lty = 2);
  lines(fits_rp04_obj,col=distinct_hues_obj[14], ci=F, lty = 2);
  lines(fits_rp05_obj,col=distinct_hues_obj[15], ci=F, lty = 3)
  
legend("bottomleft", legend = c("Kaplan-Meier","Weibull (AFT)", "Weibull (PH)", "Gompertz", "Log-logistic", "Gamma","Generalized gamma", "Generalized gamma (orig)", "Lognormal", "Exponential", "Generalized F","Generalized F (orig)","RP2","RP3","RP4","RP5"), col = c("red",distinct_hues_obj), title = "Distributions", cex = .95, bty = "n", lty=c(rep(1,10),rep(2,6),rep(3,4)),lwd=3)# lty = 1:2, 
title(main="From outcome to readmission")
  dev.off()
}
```

<br>

<div style="border: 1px solid #ddd; padding: 5px; overflow-y: scroll; height:300px; overflow-x: scroll; width:100%">

```{r fit_obj2, echo=T, error=T, fig.align="center", warning=FALSE, paged.print=TRUE, eval=T}
fitstats.flexsurvreg = function(x){
  ll = x$loglik
  aic = x$AIC
  k = length(x$coefficients)
  n = sum(x$data$m["(weights)"])
  aicc = aic + ((2 * k) * (k + 1) / (n - k - 1))
  bic = - 2 * ll + (k * log(n))
  data.frame(
   Df = k,
    "n2ll" = -2 * ll,
    AIC = aic,
    AICc = aicc,
    BIC = bic
  )
}

fit_flexsurvreg0_obj<-data.frame()
fitted_flexsurvreg0_obj<-data.frame()

dists_no_covs_obj<-cbind.data.frame(covs=c(rep("fits_",(15)*1)),
              formal=rep(c("Weibull (AFT)", "Weibull (PH)", "Gompertz", "Log-logistic", "Gamma",
                "Generalized gamma", "Generalized gamma (original)", "Lognormal", "Exponential", "Generalized F", "Generalized F(original)", paste0("RP0",2:5)),1*1),
              dist=c("weibull", "weibullph", "llogis", "gamma", "gengamma","gengamma.orig", "gompertz", "lnorm", "exp", "genf","genf.orig",rep("no dist",4)),
              model=paste0(rep(c("wei", "weiph", "gomp", "llogis", "gam","ggam", "ggam_orig", "logn", "exp", "genf","genf_orig", paste0("rp0",2:5)),1*1),"_obj"),
              trans=rep(1, each=15))

for (i in 1:nrow(dists_no_covs_obj)){  #
  
  cat(paste0("#### Flexible Survival Model (w/o covs): ",
               dists_no_covs_obj[i,"formal"], "; transition: ",dists_no_covs_obj[i,"trans"], "\n \n"))  
    
  model<-paste0("fits_",dists_no_covs_obj[i,"model"])
  
  if(!is.null(get(model)[[dists_no_covs_obj[i,"trans"]]])){  
     fitted_flexsurvreg0_obj<- rbind(fitted_flexsurvreg0_obj,cbind.data.frame(dist=rep(dists_no_covs_obj[i,"formal"],), 
                            trans=rep(dists_no_covs_obj[i,"trans"],),
                            data.table::data.table(summary(get(model), 
                                                           #newdata= newdat2a, 
                                                           #newtime=unique(fitted_km$time), 
                                                           type = "survival", 
                                                           tidy=T)))) 
    # Generate fit indices
    fit_flexsurvreg0_obj<-rbind(fit_flexsurvreg0_obj,
       cbind(dist= dists_no_covs_obj[i,"formal"],
             transition=dists_no_covs_obj[i,"trans"],
             fitstats.flexsurvreg(get(model))))
    #the BIC may not be appropriate if none of the candidate models are considered to be close to the ‘true’ model.     
    } else {
    cat(paste0("The model that assumed a ",dists_no_covs_obj[i,"formal"]," distribution for the transition number ",dists_no_covs_obj[i,"trans"]," did not converge \n\n"))
    }
}

#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_
#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_
if(no_mostrar==1){
  fit_flexsurvreg0 %>% 
    dplyr::group_by(transition) %>% 
    summarise(mean(ucl,na.rm=T))
  }
#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_
#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_

fitted_km0_obj<-data.frame()
fitted_km0_obj<-rbind(fitted_km0_obj,data.frame(fortify(km.lc_obj)))

fitted_flexsurvreg_binned_mix0_obj<-
data.frame(fitted_flexsurvreg0_obj)[,c("dist","time","est","lcl","ucl")] %>% 
  dplyr::left_join(fitted_km0_obj, by=c("time")) %>% 
#there are many observations that was not available due to empirical missing data
  dplyr::group_by(dist) %>% 
  tidyr::fill(surv,.direction="updown") %>% 
  tidyr::fill(est,.direction="updown") %>% 
  ungroup()

db_for_apply_rmse0_obj<-
  cbind.data.frame(
      dist=rep(c("Weibull (AFT)", "Weibull (PH)", "Gompertz", "Log-logistic", "Gamma",
                "Generalized gamma", "Generalized gamma (original)", "Lognormal", "Exponential", "Generalized F", "Generalized F (orignial)", paste0("RP0",2:5)),1),
      trans=rep(c(1:1),each=15*1))
   
rmse_comp_fits0_obj<- data.frame()
for(i in 1:nrow(db_for_apply_rmse0_obj)){
  rmse<- Metrics::rmse(subset(fitted_flexsurvreg_binned_mix0_obj, dist==db_for_apply_rmse0_obj[i,"dist"])$est,
              subset(fitted_flexsurvreg_binned_mix0_obj, dist==db_for_apply_rmse0_obj[i,"dist"])$surv)

  rmse_comp_fits0_obj<- rbind(rmse_comp_fits0_obj,cbind(dist=db_for_apply_rmse0_obj[i,"dist"],
                                                  rmse=rmse))
}

rmse_comp_fits0_obj_filter<-
  rmse_comp_fits0_obj %>% 
    dplyr::filter(rmse!="NaN") %>%  
      dplyr::arrange(rmse,dist)%>%
      dplyr::mutate(rmse=round(as.numeric(rmse),4))

#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_
#fit_flexsurvreg0_obj %>% arrange(AIC)
#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_
```

</div>

<br>

```{r fit1_a, eval=T, echo=T, fig.cap="Figure 18. Vissual Assessment of Survival Curves (w/o covars)", warning=FALSE, paged.print=TRUE, fig.align="center", dpi=320, warnings=F, error=T}
#load("C:/Users/CISS Fondecyt/OneDrive/Escritorio/mult_state_ags.RData")

c26 <- c(
  "dodgerblue2", # red
  "green4",
  "#6A3D9A", # purple
  "#FF7F00", # orange
  "gray16", "gold1",
  "skyblue2", "#FB9A99", # lt pink
  "palegreen2",
  "#CAB2D6", # lt purple
  "#FDBF6F", # lt orange
  "gray70", "khaki2",
  "maroon", "orchid1", "deeppink1", "blue1", "steelblue4",
  "darkturquoise", "green1", "yellow4", "yellow3",
  "darkorange4", "brown", "gray40")


fitted_flexsurvreg_binned_mix0_obj_plot<-
fitted_flexsurvreg_binned_mix0_obj %>% 
  dplyr::mutate(abs((est-surv)/surv)) %>% group_by(dist) %>% dplyr::mutate(cumsum_error=cumsum(`abs((est - surv)/surv)`)) %>% 
  dplyr::ungroup() %>% 
  dplyr::mutate(text=paste0("Distribution: ",dist,"<br>survival: ",sprintf("%1.2f",est),"<br>Time (in years): ",round(time/365.25,2), "<br>CIs: ",ifelse(!is.na(lcl),"CIs","no CIs"),"<br>Cumsum(abs((est-surv)/surv))= ",round(cumsum_error,2))) %>% 
  dplyr::mutate(text2=paste0("Distribution: KM","<br>survival: ",sprintf("%1.2f",surv),"<br>Time (in years): ",round(time/365.25,2))) %>%
ggplot()+
    geom_line(aes(time, est, color=dist, label=text),size=1)+
    geom_line(aes(time, surv), color="red",size=1)+
    scale_color_manual(name="Distributions", values = c26[1:15])+
    theme_bw()+
    theme(legend.position="bottom",
          strip.background = element_rect(fill = "white", colour = "white"))+
  scale_x_continuous(breaks = seq(0, 12, 2), labels=seq(0,12,2))+
  labs(y="",x="")+
  theme(legend.position='none')

plotly::ggplotly(fitted_flexsurvreg_binned_mix0_obj_plot, tooltip="text") %>% layout(height = 600, width=800)
```


<br>

```{r fit_surv_parametric_simple_model2, echo=T, error=T, fig.align="center", warning=FALSE, paged.print=TRUE, eval=T}
dt_coefs_simple_surv_obj<-
data.frame(
real_vars=c("motivodeegreso_mod_impEarly Drop-out", "motivodeegreso_mod_impAdministrative discharge", "motivodeegreso_mod_impTherapeutic discharge","motivodeegreso_mod_impLate Drop-out", "motivodeegreso_mod_impReferral to another treatment","mu", "sigma", "Q","P", paste0("gamma",0:5)),
 formal_vars= c("Early Drop-out", "Administrative discharge", "Therapeutic discharge", "Late Drop-out", "Referral to another treatment","_Parameter- mu (Location)", "_Parameter- sigma (Scale)", "_Parameter- Q (1st shape)","_Parameter- P (2nd shape)", "_Parameter- Gamma 1st area","_Parameter- Gamma 2nd area", "_Parameter- Gamma 3rd area", "_Parameter- Gamma 4th area", "_Parameter- Gamma 5th area", "_Parameter- Gamma 6th area"
 )) 


coefs_obj_rp_raw<-
data.table::data.table(round(exp(fits_rp03_obj$res),2)[,1:3],keep.rownames = T) %>% 
   dplyr::left_join(dt_coefs_simple_surv_obj, by=c("rn"="real_vars")) %>% 
  #dplyr::mutate(p.value=ifelse(p.value<.001,"<0.001",as.character(sprintf("%1.3f",p.value)))) %>% 
  dplyr::mutate(conf.low=sprintf("%1.2f",`L95%`),
                conf.high=sprintf("%1.2f",`U95%`),
                statistic=sprintf("%1.2f",est),
                `CI 95%`=paste0(conf.low,", ",conf.high)) %>% 
  dplyr::select(formal_vars, statistic, `CI 95%`) 

coefs_obj_rp_mot<-
data.table::data.table(round(exp(fits_rp03_objc$res),2)[,1:3],keep.rownames = T) %>% 
   dplyr::left_join(dt_coefs_simple_surv_obj, by=c("rn"="real_vars")) %>% 
  #dplyr::mutate(p.value=ifelse(p.value<.001,"<0.001",as.character(sprintf("%1.3f",p.value)))) %>% 
  dplyr::mutate(conf.low=sprintf("%1.2f",`L95%`),
                conf.high=sprintf("%1.2f",`U95%`),
                statistic=sprintf("%1.2f",est),
                `CI 95%`=paste0(conf.low,", ",conf.high)) %>% 
  dplyr::select(formal_vars, statistic, `CI 95%`) 

coefs_obj_genf_raw<-
data.table::data.table(round(exp(fits_genf_obj$res),2)[,1:3],keep.rownames = T) %>% 
   dplyr::left_join(dt_coefs_simple_surv_obj, by=c("rn"="real_vars")) %>% 
  #dplyr::mutate(p.value=ifelse(p.value<.001,"<0.001",as.character(sprintf("%1.3f",p.value)))) %>% 
  dplyr::mutate(conf.low=sprintf("%1.2f",`L95%`),
                conf.high=sprintf("%1.2f",`U95%`),
                statistic=sprintf("%1.2f",est),
                `CI 95%`=paste0(conf.low,", ",conf.high)) %>% 
  dplyr::select(formal_vars, statistic, `CI 95%`) 

coefs_obj_genf_mot<-
data.table::data.table(round(exp(fits_genf_objc$res),2)[,1:3],keep.rownames = T) %>% 
    dplyr::left_join(dt_coefs_simple_surv_obj, by=c("rn"="real_vars")) %>% 
    #dplyr::mutate(p.value=ifelse(p.value<.001,"<0.001",as.character(sprintf("%1.3f",p.value)))) %>% 
    dplyr::mutate(conf.low=sprintf("%1.2f",`L95%`),
                  conf.high=sprintf("%1.2f",`U95%`),
                  statistic=sprintf("%1.2f",est),
                  `CI 95%`=paste0(conf.low,", ",conf.high)) %>% 
    dplyr::select(formal_vars, statistic, `CI 95%`) 

coefs_surv_obj<-
dplyr::full_join(coefs_obj_rp_mot,coefs_obj_genf_mot,by="formal_vars")%>% 
  arrange(desc(formal_vars))


note_fits_genf_objc <-
  paste0("N= ",format(as.numeric(fits_genf_objc$N), big.mark=","),"; Events= ",format(as.numeric(fits_genf_objc$events), big.mark=","),"; Censored= ",format(as.numeric(fits_genf_objc$N - fits_genf_objc$events), big.mark=","),"; Time at risk= ",format(as.numeric(fits_genf_objc$trisk), big.mark=","),"; Df= ",format(as.numeric(fits_genf_objc$npars), big.mark=","), "; AIC= ",format(as.numeric(fits_genf_objc$AIC), big.mark=","))
note_fits_rp03_objc <-
  paste0("N= ",format(as.numeric(fits_rp03_objc$N), big.mark=","),"; Events= ",format(as.numeric(fits_rp03_objc$events), big.mark=","),"; Censored= ",format(as.numeric(fits_rp03_objc$N - fits_rp03_objc$events), big.mark=","),"; Time at risk= ",format(as.numeric(fits_rp03_objc$trisk), big.mark=","),"; Df= ",format(as.numeric(fits_rp03_objc$npars), big.mark=","), "; AIC= ",format(as.numeric(fits_rp03_objc$AIC), big.mark=","))

options(knitr.kable.NA = '')

coefs_surv_obj %>%   
    knitr::kable(format= "html", format.args= list(decimal.mark= ".", big.mark= ","),
               caption=paste0("Table 7. Coefficients of selected parametric distributions"),
               col.names = c("Term",rep(c("Haz","CI 95%"),2)),
               align= c("l",rep('c', 16)))%>%
  kableExtra::kable_classic(bootstrap_options = c("striped", "hover"),font_size=13)%>%
  kableExtra::add_header_above(c(" ", "Royston-Parmar (3 knots)" = 2, "Generalized F" = 2),bold=T) %>% 
  kableExtra::add_footnote(c("Note. From left to right:", paste0("Royston-Parmar: ",note_fits_rp03_objc),
    paste0("Generalized F: ",note_fits_genf_objc)), notation = "none") %>%
  kableExtra::scroll_box(width = "100%", height = "350px")
```

<br>

```{r fit_surv_parametric_simple_model_cumhaz, echo=T, error=T, fig.align="center", warning=FALSE, paged.print=TRUE, eval=T}
# "survival" for survival, to be plotted against Kaplan-Meier estimates from
# plot.survfit.
# "cumhaz" for cumulative hazard, plotted against transformed Kaplan-Meier estimates from plot.survfit.
# "hazard" for hazard, to be plotted against smooth nonparametric estimates from
# muhaz. The nonparametric estimates tend to be unstable, and these plots are
# intended just to roughly indicate the shape of the hazards through time. The
# min.time and max.time options to muhaz may sometimes need to be passed as
# arguments to plot.flexsurvreg to avoid an error here.

cumhaz_rp03<-
data.table::data.table(summary(fits_rp03_objc, 
                               #newdata= newdat2a, 
                               #newtime=unique(fitted_km$time), 
                               type = "cumhaz", 
                               tidy=T,
                               B=1e4))
cumhaz_genf<-
data.table::data.table(summary(fits_genf_objc, 
                               #newdata= newdat2a, 
                               #newtime=unique(fitted_km$time), 
                               type = "cumhaz", 
                               tidy=T,
                               B=1e4))
invisible("Lo ideal es hacerlo con intervalos, pero no se puede")
#ggsurvplot_tr_outcome_fit
naalen_dt<-
  survfit(Surv(outcome_to_readmission, event==1) ~ strata(motivodeegreso_mod_imp), 
        data=CONS_C1_df_dup_SEP_2020_irrs_health_survreg,
        type="fleming-harrington", conf.type="log-log") %>% fortify(fun="cumhaz") %>% 
dplyr::filter(strata!="Ongoing treatment",!is.na(surv)) %>% 
dplyr::mutate(t_group=dplyr::case_when(time<=.26~1,time>.26&time<=1.1~2,time>1.1&time<=3.1~3,time>3.1&time<=5.5~4, T~NA_real_)) %>%   
dplyr::mutate(aprox_t=dplyr::case_when(time<=.26~abs(time-.25),time>.26&time<=1.1~abs(time-1),time>1.1&time<=3.1~abs(time-3),time>3.1&time<=5.5~abs(time-5))) %>% 
  dplyr::mutate(time= sprintf("%1.3f",`time`)) %>% 
  dplyr::group_by(strata,t_group) %>% 
  dplyr::slice_min(aprox_t) %>%
  ungroup() %>% 
  dplyr::mutate(time=factor(as.character(t_group),labels=c("Three months","One year","Three years", "Five years"))) %>% 
  dplyr::mutate(cum_haz=paste0(sprintf("%1.2f",`surv`)," [",sprintf("%1.2f",`upper`),", ",sprintf("%1.2f",`lower`),"]")) %>% 
  dplyr::select(time, strata, cum_haz) %>% 
  tidyr::pivot_wider(names_from = strata, values_from = cum_haz)

genf_dt<-
cumhaz_genf %>% 
  dplyr::mutate(aprox_t=dplyr::case_when(time<=.26~abs(time-.25),time>.26&time<=1.1~abs(time-1),time>1.1&time<=3.1~abs(time-3),time>3.1&time<=5.1~abs(time-5))) %>% 
  dplyr::mutate(time= round(time,7)) %>% 
  dplyr::filter(time %in% c(0.2491444, 0.9993155, 3.0006845, 4.9993155)) %>% 
  dplyr::mutate(time=factor(time,levels=c(0.2491444, 0.9993155, 3.0006845, 4.9993155), labels=c("Three months","One year","Three years", "Five years"))) %>% 
  dplyr::mutate(cum_haz=paste0(sprintf("%1.2f",`est`)," [",sprintf("%1.2f",`lcl`),", ",sprintf("%1.2f",`ucl`),"]")) %>% 
  dplyr::select(time, motivodeegreso_mod_imp, cum_haz) %>% 
  tidyr::pivot_wider(names_from = motivodeegreso_mod_imp, values_from = cum_haz)

rp03_dt<-
cumhaz_rp03 %>% 
  dplyr::mutate(aprox_t=dplyr::case_when(time<=.26~abs(time-.25),time>.26&time<=1.1~abs(time-1),time>1.1&time<=3.1~abs(time-3),time>3.1&time<=5.1~abs(time-5))) %>% 
  dplyr::mutate(time= round(time,7)) %>% 
  dplyr::filter(time %in% c(0.2491444, 0.9993155, 3.0006845, 4.9993155)) %>% 
  dplyr::mutate(time=factor(time,levels=c(0.2491444, 0.9993155, 3.0006845, 4.9993155), labels=c("Three months","One year","Three years", "Five years"))) %>% 
  dplyr::mutate(cum_haz=paste0(sprintf("%1.2f",`est`)," [",sprintf("%1.2f",`lcl`),", ",sprintf("%1.2f",`ucl`),"]")) %>% 
  dplyr::select(time, motivodeegreso_mod_imp, cum_haz) %>% 
  tidyr::pivot_wider(names_from = motivodeegreso_mod_imp, values_from = cum_haz)

rbind.data.frame(naalen_dt,genf_dt,rp03_dt) %>% 
  knitr::kable(format="html", caption= "Table 8. Cumulative Hazards of Readmission by Treatment Outcome") %>% 
  kableExtra::kable_classic() %>% 
  kableExtra::group_rows("Non-parametric estimates (Nelson-Aalen)",1,4) %>% 
  kableExtra::group_rows("Generalized F",5,8) %>% 
  kableExtra::group_rows("Royston-Parmar",9,12) 
```


```{r cumhaz_plot_obj, eval=T, echo=T, fig.cap="Figure 19. Cumulative hazards (w/o covars) (dashed lines, stratified KM estimates)", fig.height=7, fig.width=10, warning=FALSE, paged.print=TRUE, fig.align="center", dpi=320, warnings=F, error=T}
annotate_figure(
ggpubr::ggarrange(
  ggplot()+
    geom_step(data=cumhaz_genf, aes(x=time, y=est, color=motivodeegreso_mod_imp), size=.9)+
    geom_step(data= dplyr::filter(tr_outcome_na,strata!="Ongoing treatment"), aes(x=time, y=CumHaz, color= strata), linetype=2)+
    sjPlot::theme_sjplot()+
    scale_color_manual(name="Treatment\nOutcome", values=c("#C6A477","#ECD59F","#ABD1DC","#C2CBC5","#5A6794","#1C2135"))+
    ylim(0,.5)+
    labs(y="Cumulative hazards",x=NULL, title="Generalized-F model"),
  ggplot()+
    geom_step(data=cumhaz_rp03, aes(x=time, y=est, color=motivodeegreso_mod_imp), size=.9)+
    geom_step(data= dplyr::filter(tr_outcome_na,strata!="Ongoing treatment"), aes(x=time, y=CumHaz, color= strata), linetype=2)+
    sjPlot::theme_sjplot()+
    scale_color_manual(name="Treatment\nOutcome", values=c("#C6A477","#ECD59F","#ABD1DC","#C2CBC5","#5A6794","#1C2135"))+
    ylim(0,.5)+
    labs(y=NULL,x=NULL, title="Royston-Parmar model"),
  common.legend =T, legend="bottom"),bottom = grid::textGrob("Years", gp = grid::gpar(cex = 1))
)
if(no_mostrar==1){
jpeg(paste0(gsub("/SUD_CL","",getwd()),"/exp_surv_obj_cum_haz.jpg"), height=7, width= 10, res= 300, units = "in")

annotate_figure(
ggpubr::ggarrange(
  ggplot()+
    geom_step(data=cumhaz_genf, aes(x=time, y=est, color=motivodeegreso_mod_imp), size=.9)+
    geom_step(data= dplyr::filter(tr_outcome_na,strata!="Ongoing treatment"), aes(x=time, y=CumHaz, color= strata), linetype=2)+
    sjPlot::theme_sjplot()+
    scale_color_manual(name="Treatment\nOutcome", values=c("#C6A477","#ECD59F","#ABD1DC","#C2CBC5","#5A6794","#1C2135"))+
    ylim(0,.5)+
    labs(y="Cumulative hazards",x=NULL, title="Generalized-F model"),
  ggplot()+
    geom_step(data=cumhaz_rp03, aes(x=time, y=est, color=motivodeegreso_mod_imp), size=.9)+
    geom_step(data= dplyr::filter(tr_outcome_na,strata!="Ongoing treatment"), aes(x=time, y=CumHaz, color= strata), linetype=2)+
    sjPlot::theme_sjplot()+
    scale_color_manual(name="Treatment\nOutcome", values=c("#C6A477","#ECD59F","#ABD1DC","#C2CBC5","#5A6794","#1C2135"))+
    ylim(0,.5)+
    labs(y=NULL,x=NULL, title="Royston-Parmar model"),
  common.legend =T, legend="bottom"),bottom = grid::textGrob("Years", gp = grid::gpar(cex = 1))
)
  dev.off()
}
```

<br>

```{r fit_surv_parametric_simple_model_rmst, echo=T, error=T, fig.align="center", warning=FALSE, paged.print=TRUE, eval=T}
rmst_rp03_90<-
data.table::data.table(summary(fits_rp03_objc, 
                               #newdata= newdat2a, 
                               #newtime=unique(fitted_km$time), 
                               type = "rmst", 
                               t=.25,
                               tidy=T,
                               B=1e4))
rmst_genf_90<-
data.table::data.table(summary(fits_genf_objc, 
                               #newdata= newdat2a, 
                               #newtime=unique(fitted_km$time), 
                               type = "rmst", 
                               t=.25,
                               tidy=T,
                               B=1e4))
rmst_rp03_365<-
data.table::data.table(summary(fits_rp03_objc, 
                               #newdata= newdat2a, 
                               #newtime=unique(fitted_km$time), 
                               type = "rmst", 
                               t=1,
                               tidy=T,
                               B=1e4))
rmst_genf_365<-
data.table::data.table(summary(fits_genf_objc, 
                               #newdata= newdat2a, 
                               #newtime=unique(fitted_km$time), 
                               type = "rmst", 
                               t=1,
                               tidy=T,
                               B=1e4))
rmst_rp03_1095<-
data.table::data.table(summary(fits_rp03_objc, 
                               #newdata= newdat2a, 
                               #newtime=unique(fitted_km$time), 
                               type = "rmst", 
                               t=3,
                               tidy=T,
                               B=1e4))
rmst_genf_1095<-
data.table::data.table(summary(fits_genf_objc, 
                               #newdata= newdat2a, 
                               #newtime=unique(fitted_km$time), 
                               type = "rmst", 
                               t=3,
                               tidy=T,
                               B=1e4))

rmst_rp03_1826<-
data.table::data.table(summary(fits_rp03_objc, 
                               #newdata= newdat2a, 
                               #newtime=unique(fitted_km$time), 
                               type = "rmst", 
                               t=5,
                               tidy=T,
                               B=1e4))
rmst_genf_1826<-
data.table::data.table(summary(fits_genf_objc, 
                               #newdata= newdat2a, 
                               #newtime=unique(fitted_km$time), 
                               type = "rmst", 
                               t=5,
                               tidy=T,
                               B=1e4))

# "median" for median survival (alternative to type="quantile" with quantiles=0.5).
# "quantile" for quantiles of the survival time distribution.
# quantiles
rmst_km_90<-
survival:::survmean(tr_outcome_fit,rmean=.25)
rmst_km_365<-
survival:::survmean(tr_outcome_fit,rmean=1)
rmst_km_1095<-
survival:::survmean(tr_outcome_fit,rmean=3)
rmst_km_1826<-
survival:::survmean(tr_outcome_fit,rmean=5)


rmst_km_dt<-
rbind.data.frame(
  rmst_km_90$matrix,
  rmst_km_365$matrix,
  rmst_km_1095$matrix,
  rmst_km_1826$matrix) %>% 
  data.table::data.table(keep.rownames = T) %>% 
  dplyr::rename("Treatment Outcome"="rn") %>% 
  dplyr::mutate(`Treatment Outcome`=gsub("strata\\(motivodeegreso_mod_imp\\)\\=","",`Treatment Outcome`)) %>% 
  dplyr::mutate(`Treatment Outcome`=gsub("[0-9]$","",`Treatment Outcome`)) %>% 
  dplyr::filter(`Treatment Outcome`!="Ongoing treatment") %>% 
  dplyr::mutate(rn=row_number(),
  t_group=dplyr::case_when(rn<=5~1,rn>5&rn<=10~2,rn>10&rn<=15~3,rn>15&rn<=20~4, T~5)) %>%
  dplyr::mutate(time=factor(as.character(t_group),labels=c("Three months","One year","Three years", "Five years"))) %>% 
  dplyr::mutate(ci=`*se(rmean)` * qt(.95/2 + .5, records - 1),
                ucl= `*rmean`+ci, lcl= `*rmean`-ci) %>% 
  dplyr::mutate(model="Non-parametric") %>% 
  dplyr::mutate(est=paste0(sprintf("%3.2f",`*rmean`)," [",sprintf("%3.2f",`lcl`),", ",sprintf("%3.2f",`ucl`),"]")) %>%  dplyr::select(model, time, `Treatment Outcome`,est)%>% 
     tidyr::pivot_wider(names_from = `Treatment Outcome`, values_from = est)

rmst_par_dt<-
rbind.data.frame(rmst_rp03_90,
                 rmst_rp03_365, 
                 rmst_rp03_1095, 
                 rmst_rp03_1826,                  
                 rmst_genf_90, 
                 rmst_genf_365, 
                 rmst_genf_1095, 
                 rmst_genf_1826) %>% 
  cbind.data.frame(model=factor(rep(1:2, each=5*4),labels=c("Royston-Parmar","Generalized F"))) %>% 
  dplyr::rename("Treatment Outcome"="motivodeegreso_mod_imp") %>% 
  dplyr::rename("*rmean"="est") %>% 
  dplyr::mutate(time=factor(as.character(time),labels=c("Three months","One year","Three years", "Five years"))) %>% 
  dplyr::select(model, time, `Treatment Outcome`,`*rmean`, lcl, ucl) %>% 
  dplyr::mutate(est=paste0(sprintf("%3.2f",`*rmean`)," [",sprintf("%3.2f",`lcl`),", ",sprintf("%3.2f",`ucl`),"]")) %>%
  dplyr::select(model, time, `Treatment Outcome`,est)%>% 
     tidyr::pivot_wider(names_from = `Treatment Outcome`, values_from = est)

rbind.data.frame(rmst_km_dt,rmst_par_dt)%>% 
  dplyr::select(-model) %>% 
  knitr::kable(format="html", caption= "Table 9. Restricted mean survival time of the association between treatment outcome and readmission") %>% 
  kableExtra::kable_classic() %>% 
  kableExtra::group_rows("Non-parametric estimates (Nelson-Aalen)",1,4) %>% 
  kableExtra::group_rows("Generalized F",5,8) %>% 
  kableExtra::group_rows("Royston-Parmar",9,12) 
```


```{r fit_surv_parametric_simple_model_quantile, echo=T, error=T, fig.align="center", warning=FALSE, paged.print=TRUE, eval=F}
#https://search.r-project.org/CRAN/refmans/flexsurv/html/summary.flexsurvreg.html
quantile_rp03<-
data.table::data.table(summary(fits_rp03_objc, 
                               #newdata= newdat2a, 
                               #newtime=unique(fitted_km$time), 
                               type = "quantile", 
                               quantiles=c(.025,.25),
                               tidy=T,
                               na.action="na.omit",
                               B=1e4)) %>% 
  dplyr::mutate(est=paste0(sprintf("%1.2f",`*rmean`)," [",sprintf("%1.2f",`lcl`),", ",sprintf("%1.2f",`ucl`),"]")) %>%
  dplyr::select(model, time, `Treatment Outcome`,est)%>% 
     tidyr::pivot_wider(names_from = `Treatment Outcome`, values_from = est)
invisible("Tuve que poner na omit en vez de na pass en los RPs")
quantile_genf<-
data.table::data.table(summary(fits_genf_objc, 
                               #newdata= newdat2a, 
                               #newtime=unique(fitted_km$time), 
                               type = "quantile", 
                               quantiles=c(.025,.25,.5,.75,.975),
                               tidy=T,
                               B=1e4))
quantile_km<-
quantile(tr_outcome_fit, probs = c(.025,.25,.5,.75,.975), conf.int = T)
survival:::quantile.survfit(tr_outcome_fit) 


%>% 
  dplyr::select(-model) %>% 
  knitr::kable(format="html") %>% 
  kableExtra::kable_classic() %>% 
  kableExtra::group_rows("Non-parametric estimates (Nelson-Aalen)",1,4) %>% 
  kableExtra::group_rows("Generalized F",5,8) %>% 
  kableExtra::group_rows("Royston-Parmar",9,12) 

survminer::surv_median(tr_outcome_fit)

```

<br>

## Quantify association between treatment outcomes and readmission and variation by effect modifiers

<br>

<div style="border: 1px solid #ddd; padding: 5px; overflow-y: scroll; height:800px; overflow-x: scroll; width:100%">

```{r fit_surv_parametric_complex_model_gen_fit_indices, echo=T, error=T, fig.align="center", warning=FALSE, paged.print=TRUE, eval=T}
# `r invisible("To quantify the extent to which the association between the treatment outcome (i.e., administrative discharge, drop-outs, therapeutic discharge), and treatment readmissions and other adverse health outcomes varies by sex, age, the type of drug used, and the treatment modality among adult patients with public health insurance admitted to SUD treatment in Chile in the period 2010-2018.")`
# `r invisible("Son interacciones: aunque para ver las interacciones primero, debo ver qué modelo paramétrico se ajusta mejor a los datos; luego, hacer las interacciones por cada uno. Yo creo que debe tomarse como referencia el modelo ~1 y no el modelo que tengo aquí que estratifica. Aunque tampoco lo descarto`
#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_
#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_
fit_flexsurvreg0_obj2<-data.frame()
fitted_flexsurvreg0_obj2<-data.frame()

dists_no_covs_obj2<-cbind.data.frame(covs=c(rep("fits_",(15)*1)),
              formal=rep(c("Weibull (AFT)", "Weibull (PH)", "Gompertz", "Log-logistic", "Gamma",
                "Generalized gamma", "Generalized gamma (original)", "Lognormal", "Exponential", "Generalized F", "Generalized F(original)", paste0("RP0",2:5)),1*1),
              dist=c("weibull", "weibullph", "llogis", "gamma", "gengamma","gengamma.orig", "gompertz", "lnorm", "exp", "genf","genf.orig",rep("no dist",4)),
              model=paste0(rep(c("wei", "weiph", "gomp", "llogis", "gam","ggam", "ggam_orig", "logn", "exp", "genf","genf_orig", paste0("rp0",2:5)),1*1),"_objc"),
              trans=rep(1:1, each=15))

for (i in 1:nrow(dists_no_covs_obj2)){  #
  
  cat(paste0("#### Flexible Survival Model (w/ covs): ",
               dists_no_covs_obj2[i,"formal"], "; transition: ",dists_no_covs_obj2[i,"trans"], "\n \n"))  
    
  model<-paste0("fits_",dists_no_covs_obj2[i,"model"])
  
  if(!is.null(get(model))){  
     fitted_flexsurvreg0_obj2<- rbind(fitted_flexsurvreg0_obj2,cbind.data.frame(dist=rep(dists_no_covs_obj2[i,"formal"],), 
                            data.table::data.table(summary(get(model), 
                                                           #newdata= newdat2a, 
                                                           #newtime=unique(fitted_km$time), 
                                                           type = "cumhaz", 
                                                           B=1e4,
                                                           tidy=T)))) 
    # Generate fit indices
    fit_flexsurvreg0_obj2<-rbind(fit_flexsurvreg0_obj2,
       cbind(dist= dists_no_covs_obj2[i,"formal"],
             fitstats.flexsurvreg(get(model))))
    #the BIC may not be appropriate if none of the candidate models are considered to be close to the ‘true’ model.     
    } else {
    cat(paste0("The model that assumed a ",dists_no_covs_obj2[i,"formal"]," distribution for the transition number ",dists_no_covs_obj2[i,"trans"]," did not converge \n\n"))
    }
}

#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_
#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_
fitted_km0_obj2<-
survfit(Surv(outcome_to_readmission, event==1) ~ strata(motivodeegreso_mod_imp), 
        data=CONS_C1_df_dup_SEP_2020_irrs_health_survreg,
        type="fleming-harrington", conf.type="log-log") %>% fortify(fun="cumhaz") %>% 
dplyr::filter(strata!="Ongoing treatment",!is.na(surv)) %>% 
  dplyr::rename("motivodeegreso_mod_imp"="strata")

fitted_flexsurvreg_binned_mix0_obj2<-
data.frame(fitted_flexsurvreg0_obj2)[,c("dist","motivodeegreso_mod_imp","time","est","lcl","ucl")] %>% 
  dplyr::left_join(fitted_km0_obj2, by=c("motivodeegreso_mod_imp","time")) %>% 
  dplyr::rename("Treatment Outcome"="motivodeegreso_mod_imp") %>% 
#there are many observations that was not available due to empirical missing data
#dplyr::filter(!is.na(surv))
  dplyr::group_by(dist, `Treatment Outcome`) %>% 
  tidyr::fill(surv,.direction="updown") %>% 
  tidyr::fill(est,.direction="updown") %>% 
  ungroup()
```

</div>


<br>

<!---
arrange(fit_flexsurvreg0_obj2, AIC)
	
#Generalized F
--->

 <div style="border: 1px solid #ddd; padding: 5px; overflow-y: scroll; height:800px; overflow-x: scroll; width:100%">
 
```{r fit_obj_complex, eval=T, echo=T, fig.cap="Figure 20. Vissual Assessment of Survival Curves", warning=FALSE, paged.print=TRUE, fig.align="center", dpi=320, warnings=F, error=T}
rank_obj2<-
fitted_flexsurvreg_binned_mix0_obj2 %>% 
    dplyr::group_by(dist,`Treatment Outcome`) %>% 
    tidyr::fill(surv,.direction="down") %>% 
    ungroup() %>% 
    dplyr::mutate(abs((est-surv)/surv)) %>% 
    dplyr::group_by(dist,`Treatment Outcome`) %>% 
    dplyr::mutate(cumsum_error=cumsum(tidyr::replace_na(`abs((est - surv)/surv)`, 0))) %>% 
    dplyr::ungroup() %>%  
    dplyr::filter(time>=3) %>% 
    dplyr::group_by(`Treatment Outcome`) %>% 
    dplyr::slice_min(time) %>% 
    dplyr::mutate(rank = dplyr::dense_rank(cumsum_error)) %>% 
    dplyr::ungroup() %>% 
    dplyr::arrange(`Treatment Outcome`,rank) %>%
    dplyr::select(dist, `Treatment Outcome`,time, lcl, cumsum_error,rank) 
    

fitted_flexsurvreg_binned_mix0_obj2_plot<-
fitted_flexsurvreg_binned_mix0_obj2 %>% 
  dplyr::mutate(abs((est-surv)/surv)) %>% group_by(dist,`Treatment Outcome`) %>% dplyr::mutate(cumsum_error=cumsum(`abs((est - surv)/surv)`)) %>% 
  dplyr::ungroup() %>% 
  dplyr::mutate(text=paste0("Distribution: ",dist,"<br>survival: ",sprintf("%1.2f",est),"<br>Time (in years): ",round(time,2), "<br>CIs: ",ifelse(!is.na(lcl),"CIs","no CIs"),"<br>Cumsum(abs((est-surv)/surv))= ",round(cumsum_error,2), "<br>Outcome: ",`Treatment Outcome`)) %>% 
  dplyr::mutate(text2=paste0("Distribution: KM","<br>survival: ",sprintf("%1.2f",surv),"<br>Time (in years): ",round(time,2))) %>%
ggplot()+
    geom_line(aes(time, est, color=dist),size=1)+
    geom_line(aes(time, surv), color="red",size=1)+
    scale_color_manual(name="Distributions", values = c26[1:15])+
                         #c("black",brewer.pal(n = 9, name = 'Paired')))+
                         #c("#112A60","#085754","#D3A347","#4F3C91","red","#112A60","#085754","#8F630D","#251363")) +
    facet_wrap(.~`Treatment Outcome`,labeller = labeller(trans = levels(fitted_flexsurvreg_binned_mix0_obj2$`Treatment Outcome`)), ncol=3, scales = "free_y")+
    theme_bw()+
    theme(legend.position="bottom",
          strip.background = element_rect(fill = "white", colour = "white"))+
  scale_x_continuous(breaks = seq(0, 12, 2), labels=seq(0,12,2))+
  #ylim(0,1.25)+
  #theme(axis.text.x = element_blank(), 
  #      panel.grid.major = element_blank(), 
  #      panel.grid.minor = element_blank()) +
  labs(y="",x="")+
  theme(legend.position='none')

m_obj <- list(
  l = 80*1.05,
  r = 80,
  b = 80,
  t = 80*1.05,
  pad = 4
)
p1_obj2<-
fitted_flexsurvreg_binned_mix0_obj2_plot$data %>% 
  dplyr::mutate(years=round(time,0)) %>% 
  dplyr::mutate(tr_out=`Treatment Outcome`) %>% 
#   dplyr::left_join(cbind.data.frame(levels(fitted_flexsurvreg_binned_mix0_obj2$`Treatment Outcome`),tr_out=1:length(levels(fitted_flexsurvreg_binned_mix0_obj2$`Treatment Outcome`))), by="tr_out") %>% 
dplyr::group_by(tr_out) %>%
dplyr::group_map(~ plot_ly(data=., x = ~time, y = ~est, color = ~dist, type = "scatter", mode="lines", text=~text) %>% 
            add_trace(y = ~surv, type = 'scatter', mode = 'lines', line = list(color = 'red', width = 1), text=~text2) %>% layout(annotations = list(list(x = 0.5 , y = 1.03, text = unique(.x$`Treatment Outcome`), showarrow = F, xref='paper', yref='paper'))), keep=TRUE) %>%    
subplot(nrows = 3, shareX = T, shareY=T, titleX = F, titleY = F, margin = .05)%>% layout(showlegend = F) %>% 
  #, margin = 0.05) %>% 
  layout(annotations = list(
                list(x = -0.06, y = 0.5, text = "Hazard",
                     font = list(color = "black",size = 15),
                     textangle = 270,
                     showarrow = F, xref='paper', yref='paper', size=48,margin =m_obj)))
#p1_obj2
htmlwidgets::saveWidget(as_widget(p1_obj2), "test_obj23_jun.html")
```

</div>

<br>

File is available in this [link](https://github.com/FONDECYTACC/SUD_health_Chile.github.io/raw/master/test_obj23_jun.html).

<br>

As Generalized F AFT model was found to be the best fitted one, the interpretation about the effect of different independent variables on the survival times was made by using Generalized F AFT model. 

<br>

```{r fit_surv_parametric_complex_model, echo=T, error=T, fig.align="center", warning=FALSE, paged.print=TRUE, eval=T}
sexo_2_fits_genf_obj <- flexsurvreg(formula=Surv(outcome_to_readmission, event==1) ~ motivodeegreso_mod_imp*sexo_2,
                             data = CONS_C1_df_dup_SEP_2020_irrs_health_survreg,
                             dist = "genf")
age_fits_genf_obj_0 <- flexsurvreg(formula=Surv(outcome_to_readmission, event==1) ~ motivodeegreso_mod_imp*edad_grupos,
                           data = CONS_C1_df_dup_SEP_2020_irrs_health_survreg,
                           dist = "genf")
age_fits_genf_obj_a <- flexsurvreg(formula=Surv(outcome_to_readmission, event==1) ~ motivodeegreso_mod_imp*edad_grupos,
                           data = CONS_C1_df_dup_SEP_2020_irrs_health_survreg %>% dplyr::mutate(edad_grupos=factor(edad_grupos, ordered=F)),
                           dist = "genf")
age_fits_genf_obj_b <- flexsurvreg(formula=Surv(outcome_to_readmission, event==1) ~ motivodeegreso_mod_imp*edad_al_ing,
                           data = CONS_C1_df_dup_SEP_2020_irrs_health_survreg,
                           dist = "genf")
age_fits_genf_obj_c <- flexsurvreg(formula=Surv(outcome_to_readmission, event==1) ~ motivodeegreso_mod_imp*edad_al_ing^2,
                           data = CONS_C1_df_dup_SEP_2020_irrs_health_survreg,
                           dist = "genf")
age_fits_genf_obj_d <- flexsurvreg(formula=Surv(outcome_to_readmission, event==1) ~ motivodeegreso_mod_imp*poly(edad_al_ing, 2),
                           data = CONS_C1_df_dup_SEP_2020_irrs_health_survreg,
                           dist = "genf")
#Error in poly(edad_al_ing, 2) : missing values are not allowed in 'poly'
age_fits_genf_obj_e <- flexsurvreg(formula=Surv(outcome_to_readmission, event==1) ~ motivodeegreso_mod_imp*edad_al_ing^3,
                           data = CONS_C1_df_dup_SEP_2020_irrs_health_survreg,
                           dist = "genf")
#Error in terms.formula(formula) : invalid power in formula
age_fits_genf_obj_f <- flexsurvreg(formula=Surv(outcome_to_readmission, event==1) ~ motivodeegreso_mod_imp*log(edad_al_ing),
                           data = CONS_C1_df_dup_SEP_2020_irrs_health_survreg,
                           dist = "genf")

#https://statmodeling.stat.columbia.edu/2009/10/06/coding_ordinal/
#https://stats.stackexchange.com/questions/33413/continuous-dependent-variable-with-ordinal-independent-variable
#https://stackoverflow.com/questions/25735636/interpretation-of-ordered-and-non-ordered-factors-vs-numerical-predictors-in-m/25736023#25736023

tryNA <- function(expr) {
  suppressWarnings(tryCatch(expr = expr,
                            error = function(e) NA,
                            finally = NA))
}
lapply(c("age_fits_genf_obj_0", "age_fits_genf_obj_a", "age_fits_genf_obj_b", "age_fits_genf_obj_c", "age_fits_genf_obj_d", "age_fits_genf_obj_e", "age_fits_genf_obj_f"), function(x) {paste0(x,": ",round(tryNA(get(x)$AIC),2))})

min_bic_culorg_clus <- 100000000
for(i in 1:7){
  skip_to_next <- FALSE
  
  lc_culorg_clus <- c("age_fits_genf_obj_0", "age_fits_genf_obj_a", "age_fits_genf_obj_b", "age_fits_genf_obj_c", "age_fits_genf_obj_d", "age_fits_genf_obj_e", "age_fits_genf_obj_f")[[i]]
  
  tryCatch(get(lc_culorg_clus), error = function(e) {skip_to_next <<- TRUE })
  if(skip_to_next) { next } else {
  if(get(lc_culorg_clus)$AIC < min_bic_culorg_clus){
    min_bic_culorg_clus <- get(lc_culorg_clus)$AIC
    age_fits_genf_obj<-get(lc_culorg_clus)
    }
  }
}   

prim_sub_fits_genf_obj <- flexsurvreg(formula=Surv(outcome_to_readmission, event==1)~motivodeegreso_mod_imp*sus_principal_mod,
                           data = CONS_C1_df_dup_SEP_2020_irrs_health_survreg,
                           dist = "genf")
st_sub_mvv_fits_genf_obj <- flexsurvreg(formula=Surv(outcome_to_readmission, event==1)~motivodeegreso_mod_imp*sus_ini_mod_mvv,
                           data = CONS_C1_df_dup_SEP_2020_irrs_health_survreg,
                           dist = "genf")
st_sub_fits_genf_obj <- flexsurvreg(formula=Surv(outcome_to_readmission, event==1)~motivodeegreso_mod_imp*sus_ini_mod,
                           data = CONS_C1_df_dup_SEP_2020_irrs_health_survreg,
                           dist = "genf")

note_sex_fits_genf_obj <-
    paste0("N= ",format(as.numeric(sexo_2_fits_genf_obj$N), big.mark=","),"; Events= ",format(as.numeric(sexo_2_fits_genf_obj$events), big.mark=","),"; Censored= ",format(as.numeric(sexo_2_fits_genf_obj$N - sexo_2_fits_genf_obj$events), big.mark=","),"; Time at risk= ",format(as.numeric(sexo_2_fits_genf_obj$trisk), big.mark=","),"; Df= ",format(as.numeric(sexo_2_fits_genf_obj$npars), big.mark=","), "; AIC= ",format(as.numeric(sexo_2_fits_genf_obj$AIC), big.mark=","))
note_age_fits_genf_obj <-
    paste0("N= ",format(as.numeric(age_fits_genf_obj$N), big.mark=","),"; Events= ",format(as.numeric(age_fits_genf_obj$events), big.mark=","),"; Censored= ",format(as.numeric(age_fits_genf_obj$N - age_fits_genf_obj$events), big.mark=","),"; Time at risk= ",format(as.numeric(age_fits_genf_obj$trisk), big.mark=","),"; Df= ",format(as.numeric(age_fits_genf_obj$npars), big.mark=","), "; AIC= ",format(as.numeric(age_fits_genf_obj$AIC), big.mark=","))
note_prim_sub_fits_genf_obj <-
    paste0("N= ",format(as.numeric(prim_sub_fits_genf_obj$N), big.mark=","),"; Events= ",format(as.numeric(prim_sub_fits_genf_obj$events), big.mark=","),"; Censored= ",format(as.numeric(prim_sub_fits_genf_obj$N - prim_sub_fits_genf_obj$events), big.mark=","),"; Time at risk= ",format(as.numeric(prim_sub_fits_genf_obj$trisk), big.mark=","),"; Df= ",format(as.numeric(prim_sub_fits_genf_obj$npars), big.mark=","), "; AIC= ",format(as.numeric(prim_sub_fits_genf_obj$AIC), big.mark=","))
note_st_sub_mvv_fits_genf_obj <-
    paste0("N= ",format(as.numeric(st_sub_mvv_fits_genf_obj$N), big.mark=","),"; Events= ",format(as.numeric(st_sub_mvv_fits_genf_obj$events), big.mark=","),"; Censored= ",format(as.numeric(st_sub_mvv_fits_genf_obj$N - st_sub_mvv_fits_genf_obj$events), big.mark=","),"; Time at risk= ",format(as.numeric(st_sub_mvv_fits_genf_obj$trisk), big.mark=","),"; Df= ",format(as.numeric(st_sub_mvv_fits_genf_obj$npars), big.mark=","), "; AIC= ",format(as.numeric(st_sub_mvv_fits_genf_obj$AIC), big.mark=","))
note_st_sub_fits_genf_obj <-
    paste0("N= ",format(as.numeric(st_sub_fits_genf_obj$N), big.mark=","),"; Events= ",format(as.numeric(st_sub_fits_genf_obj$events), big.mark=","),"; Censored= ",format(as.numeric(st_sub_fits_genf_obj$N - st_sub_fits_genf_obj$events), big.mark=","),"; Time at risk= ",format(as.numeric(st_sub_fits_genf_obj$trisk), big.mark=","),"; Df= ",format(as.numeric(st_sub_fits_genf_obj$npars), big.mark=","), "; AIC= ",format(as.numeric(st_sub_fits_genf_obj$AIC), big.mark=","))

invisible("Transformar los nombres de las interacciones para que sean fáciles de visualizar")
dt_coefs_simple_surv_obj_w_int<-
    rbind(
      dt_coefs_simple_surv_obj,
    cbind(real_vars=attr(sexo_2_fits_genf_obj$datameans,"names")[grepl(":",attr(sexo_2_fits_genf_obj$datameans,"names"))],
    formal_vars= gsub("sexo_2","",gsub("motivodeegreso_mod_imp","",gsub(":"," x ",attr(sexo_2_fits_genf_obj$datameans,"names")[grepl(":",attr(sexo_2_fits_genf_obj$datameans,"names"))])))),
    cbind(real_vars=attr(age_fits_genf_obj$datameans,"names")[grepl(":",attr(age_fits_genf_obj$datameans,"names"))],
    formal_vars= gsub("edad_grupos","",gsub("motivodeegreso_mod_imp","",gsub(":"," x ",attr(age_fits_genf_obj$datameans,"names")[grepl(":",attr(age_fits_genf_obj$datameans,"names"))])))),
    
    cbind(real_vars=attr(age_fits_genf_obj$datameans,"names")[grepl(":",attr(age_fits_genf_obj$datameans,"names"))],
    formal_vars= gsub("edad_al_ing","Age at admission",gsub("motivodeegreso_mod_imp","",gsub(":"," x ",attr(age_fits_genf_obj$datameans,"names")[grepl(":",attr(age_fits_genf_obj$datameans,"names"))])))),
    
    cbind(real_vars=attr(prim_sub_fits_genf_obj$datameans,"names")[grepl(":",attr(prim_sub_fits_genf_obj$datameans,"names"))],
    formal_vars= gsub("sus_principal_mod","",gsub("motivodeegreso_mod_imp","",gsub(":"," x ",attr(prim_sub_fits_genf_obj$datameans,"names")[grepl(":",attr(prim_sub_fits_genf_obj$datameans,"names"))])))),
    cbind(real_vars=attr(st_sub_fits_genf_obj$datameans,"names")[grepl(":",attr(st_sub_fits_genf_obj$datameans,"names"))],
    formal_vars= gsub("sus_ini_mod","",gsub("motivodeegreso_mod_imp","",gsub(":"," x ",attr(st_sub_fits_genf_obj$datameans,"names")[grepl(":",attr(st_sub_fits_genf_obj$datameans,"names"))])))),
    cbind(real_vars=attr(st_sub_mvv_fits_genf_obj$datameans,"names")[grepl(":",attr(st_sub_mvv_fits_genf_obj$datameans,"names"))],formal_vars= gsub("sus_ini_mod_mvv","",gsub("motivodeegreso_mod_imp","",gsub(":"," x ",attr(st_sub_mvv_fits_genf_obj$datameans,"names")[grepl(":",attr(st_sub_mvv_fits_genf_obj$datameans,"names"))])))),
  cbind(real_vars="edad_al_ing",formal_vars="Age at admission"),
    cbind(real_vars=paste0("sexo_2",levels(CONS_C1_df_dup_SEP_2020_irrs_health_survreg$sexo_2)), formal_vars=levels(CONS_C1_df_dup_SEP_2020_irrs_health_survreg$sexo_2)),
cbind(real_vars=paste0("edad_grupos",levels(CONS_C1_df_dup_SEP_2020_irrs_health_survreg$edad_grupos)), formal_vars=levels(CONS_C1_df_dup_SEP_2020_irrs_health_survreg$edad_grupos)),
cbind(real_vars=paste0("sus_principal_mod",levels(CONS_C1_df_dup_SEP_2020_irrs_health_survreg$sus_principal_mod)), formal_vars=levels(CONS_C1_df_dup_SEP_2020_irrs_health_survreg$sus_principal_mod)),
cbind(real_vars=paste0("sus_ini_mod",levels(CONS_C1_df_dup_SEP_2020_irrs_health_survreg$sus_ini_mod)), formal_vars=levels(CONS_C1_df_dup_SEP_2020_irrs_health_survreg$sus_ini_mod)),
cbind(real_vars=paste0("sus_ini_mod_mvv",levels(CONS_C1_df_dup_SEP_2020_irrs_health_survreg$sus_ini_mod_mvv)), formal_vars=levels(CONS_C1_df_dup_SEP_2020_irrs_health_survreg$sus_ini_mod_mvv)),
cbind(real_vars=paste0("edad_grupos",c("L", "Q", "C", "^4")), formal_vars=levels(CONS_C1_df_dup_SEP_2020_irrs_health_survreg$edad_grupos)[1:4])) %>% 
  dplyr::mutate(formal_vars=gsub("Pasta Base","Cocaine paste",formal_vars)) %>% 
  dplyr::mutate(formal_vars=gsub("Otros","Other",formal_vars)) %>% 
  dplyr::mutate(formal_vars=gsub("Cocaína","Cocaine hydrochloride",formal_vars)) %>% 
  dplyr::mutate(formal_vars=gsub("Marihuana","Marijuana",formal_vars)) 
    
coefs_obj_genf_int_sex<-
    data.table::data.table(round(exp(sexo_2_fits_genf_obj$res),2)[,1:3],keep.rownames = T) %>% 
    dplyr::left_join(dt_coefs_simple_surv_obj_w_int, by=c("rn"="real_vars")) %>% 
    #dplyr::mutate(p.value=ifelse(p.value<.001,"<0.001",as.character(sprintf("%1.3f",p.value)))) %>% 
    dplyr::mutate(conf.low=sprintf("%1.2f",`L95%`),
                  conf.high=sprintf("%1.2f",`U95%`),
                  statistic=sprintf("%1.2f",est),
                  `CI 95%`=paste0(conf.low,", ",conf.high)) %>% 
    dplyr::select(formal_vars, statistic, `CI 95%`) 

coefs_obj_genf_int_age<-
    data.table::data.table(round(exp(age_fits_genf_obj$res),2)[,1:3],keep.rownames = T) %>% 
    dplyr::left_join(dt_coefs_simple_surv_obj_w_int, by=c("rn"="real_vars")) %>% 
    #dplyr::mutate(p.value=ifelse(p.value<.001,"<0.001",as.character(sprintf("%1.3f",p.value)))) %>% 
    dplyr::mutate(conf.low=sprintf("%1.2f",`L95%`),
                  conf.high=sprintf("%1.2f",`U95%`),
                  statistic=sprintf("%1.2f",est),
                  `CI 95%`=paste0(conf.low,", ",conf.high)) %>% 
    dplyr::select(formal_vars, statistic, `CI 95%`) 

coefs_obj_genf_int_prim_sub<-
    data.table::data.table(round(exp(prim_sub_fits_genf_obj$res),2)[,1:3],keep.rownames = T) %>% 
    dplyr::left_join(dt_coefs_simple_surv_obj_w_int, by=c("rn"="real_vars")) %>% 
    #dplyr::mutate(p.value=ifelse(p.value<.001,"<0.001",as.character(sprintf("%1.3f",p.value)))) %>% 
    dplyr::mutate(conf.low=sprintf("%1.2f",`L95%`),
                  conf.high=sprintf("%1.2f",`U95%`),
                  statistic=sprintf("%1.2f",est),
                  `CI 95%`=paste0(conf.low,", ",conf.high)) %>% 
    dplyr::select(formal_vars, statistic, `CI 95%`) 

coefs_obj_genf_int_st_sub_mvv<-
    data.table::data.table(round(exp(st_sub_mvv_fits_genf_obj$res),2)[,1:3],keep.rownames = T) %>% 
    dplyr::left_join(dt_coefs_simple_surv_obj_w_int, by=c("rn"="real_vars")) %>% 
    #dplyr::mutate(p.value=ifelse(p.value<.001,"<0.001",as.character(sprintf("%1.3f",p.value)))) %>% 
    dplyr::mutate(conf.low=sprintf("%1.2f",`L95%`),
                  conf.high=sprintf("%1.2f",`U95%`),
                  statistic=sprintf("%1.2f",est),
                  `CI 95%`=paste0(conf.low,", ",conf.high)) %>% 
    dplyr::select(formal_vars, statistic, `CI 95%`) 

coefs_obj_genf_st_sub<-
    data.table::data.table(round(exp(st_sub_fits_genf_obj$res),2)[,1:3],keep.rownames = T) %>% 
    dplyr::left_join(dt_coefs_simple_surv_obj_w_int, by=c("rn"="real_vars")) %>% 
    #dplyr::mutate(p.value=ifelse(p.value<.001,"<0.001",as.character(sprintf("%1.3f",p.value)))) %>% 
    dplyr::mutate(conf.low=sprintf("%1.2f",`L95%`),
                  conf.high=sprintf("%1.2f",`U95%`),
                  statistic=sprintf("%1.2f",est),
                  `CI 95%`=paste0(conf.low,", ",conf.high)) %>% 
    dplyr::select(formal_vars, statistic, `CI 95%`) 


rbindlist(list(coefs_obj_genf_int_sex, coefs_obj_genf_int_age, coefs_obj_genf_int_prim_sub, coefs_obj_genf_st_sub,coefs_obj_genf_int_st_sub_mvv), idcol="Model") %>% 
  dplyr::mutate(Model=factor(Model, levels=1:5, labels=c("Sex","Age","Primary Substance at Admission","Starting Substance","Starting Substance (more vulnerable value)"))) %>% 
  #dplyr::select(-Model) %>% 
    knitr::kable(format= "html", format.args= list(decimal.mark= ".", big.mark= ","),
               caption=paste0("Table 10a. Coefficients of more complex models"),
               col.names = c("Term","Model",rep(c("Accelerating Factor (AFT) or Time Ratio (TR)/ Parameter value","CI 95%"),1)),
               align= c("l",rep('c', 16)), escape=F)%>%
  kableExtra::kable_classic(bootstrap_options = c("striped", "hover"),font_size=13)%>% 
  kableExtra::add_footnote(c("Note. From left to right:", paste0("Int w/ Sex: ",note_sex_fits_genf_obj),
    paste0("Int w/ Age: ",note_age_fits_genf_obj),paste0("Int w/ Primary substance at admission: ",note_prim_sub_fits_genf_obj),paste0("Int w/ Starting substance (most frequent): ",note_st_sub_fits_genf_obj),paste0("Int w/ Starting substance (most vulnerable) : ",note_st_sub_mvv_fits_genf_obj), paste0("AFT= $\\\\frac{1}{\\\\hat{HR}}$; $S_2(t)=S_1(\\\\gamma t)$; $\\\\gamma $ <1, exposure harmful survival")), notation = "none",
    escape=FALSE) %>%
  kableExtra::scroll_box(width = "100%", height = "350px")
```

<br>

For example, the probability of the rest of people that are not women with an administrative discharge of not experiencing readmission at time $q$, equals the probability of not experiencing readmission at the 62% of that time (IC 95%: 55%, 71%) of women that had an administrative discharge.

<br>


```{r fit_surv_parametric_complex_model_b, echo=T, error=T, fig.align="center", warning=FALSE, paged.print=TRUE, eval=T}
#knitr::knit_exit()

#2022
#https://github.com/chjackson/flexsurv-dev/issues/67
#flexsurvreg handles uncentered and/or high-variance predictors particularly badly #67

total_fits_genf_obj <- flexsurvreg(formula=Surv(outcome_to_readmission, event==1)~motivodeegreso_mod_imp*sexo_2+ motivodeegreso_mod_imp*edad_al_ing+ motivodeegreso_mod_imp*sus_principal_mod+ motivodeegreso_mod_imp*sus_ini_mod, data = CONS_C1_df_dup_SEP_2020_irrs_health_survreg %>% dplyr::mutate(edad_al_ing=as.numeric(scale(edad_al_ing, scale=F))),dist = "genf")

# total_fits_genf_obj_b <- flexsurvreg(formula=Surv(outcome_to_readmission, event==1)~motivodeegreso_mod_imp*sexo_2+ motivodeegreso_mod_imp*edad_grupos+ motivodeegreso_mod_imp*sus_principal_mod+ motivodeegreso_mod_imp*sus_ini_mod, data = CONS_C1_df_dup_SEP_2020_irrs_health_survreg,dist = "genf")

#alternative parametrization
#https://www.youtube.com/watch?v=mxS8YbA-Zyw
# total_fits_genf_obj_alt_par <- flexsurvreg(formula=Surv(outcome_to_readmission, event==1)~motivodeegreso_mod_imp:sexo_2+ motivodeegreso_mod_imp:edad_al_ing+ motivodeegreso_mod_imp:sus_principal_mod+ motivodeegreso_mod_imp:sus_ini_mod, data = CONS_C1_df_dup_SEP_2020_irrs_health_survreg %>% dplyr::mutate(edad_al_ing=as.numeric(scale(edad_al_ing, scale=F))),dist = "genf")

total_fits_genf_obj_int_caus_adm_prim_subs<-
linearHypothesis(total_fits_genf_obj, c("motivodeegreso_mod_impLate Drop-out:sus_principal_modCocaine hydrochloride", "motivodeegreso_mod_impEarly Drop-out:sus_principal_modCocaine hydrochloride", "motivodeegreso_mod_impAdministrative discharge:sus_principal_modCocaine hydrochloride", "motivodeegreso_mod_impReferral to another treatment:sus_principal_modCocaine hydrochloride", "motivodeegreso_mod_impLate Drop-out:sus_principal_modMarijuana", "motivodeegreso_mod_impEarly Drop-out:sus_principal_modMarijuana", "motivodeegreso_mod_impAdministrative discharge:sus_principal_modMarijuana", "motivodeegreso_mod_impReferral to another treatment:sus_principal_modMarijuana", "motivodeegreso_mod_impLate Drop-out:sus_principal_modOther", "motivodeegreso_mod_impEarly Drop-out:sus_principal_modOther", "motivodeegreso_mod_impAdministrative discharge:sus_principal_modOther", "motivodeegreso_mod_impReferral to another treatment:sus_principal_modOther"))

total_fits_genf_obj_int_caus_adm_init_subs<-
linearHypothesis(total_fits_genf_obj, c("motivodeegreso_mod_impLate Drop-out:sus_ini_modCocaine hydrochloride", "motivodeegreso_mod_impEarly Drop-out:sus_ini_modCocaine hydrochloride", "motivodeegreso_mod_impAdministrative discharge:sus_ini_modCocaine hydrochloride", "motivodeegreso_mod_impReferral to another treatment:sus_ini_modCocaine hydrochloride", "motivodeegreso_mod_impLate Drop-out:sus_ini_modMarijuana", "motivodeegreso_mod_impEarly Drop-out:sus_ini_modMarijuana", "motivodeegreso_mod_impAdministrative discharge:sus_ini_modMarijuana", "motivodeegreso_mod_impReferral to another treatment:sus_ini_modMarijuana", "motivodeegreso_mod_impLate Drop-out:sus_ini_modOther", "motivodeegreso_mod_impEarly Drop-out:sus_ini_modOther", "motivodeegreso_mod_impAdministrative discharge:sus_ini_modOther", "motivodeegreso_mod_impReferral to another treatment:sus_ini_modOther"))

total_fits_genf_obj_int_caus_adm_sex<-
linearHypothesis(total_fits_genf_obj, c("motivodeegreso_mod_impLate Drop-out:sexo_2Women", "motivodeegreso_mod_impEarly Drop-out:sexo_2Women", "motivodeegreso_mod_impAdministrative discharge:sexo_2Women", "motivodeegreso_mod_impReferral to another treatment:sexo_2Women"))

total_fits_genf_obj_int_caus_adm_age<-
linearHypothesis(total_fits_genf_obj, c("motivodeegreso_mod_impLate Drop-out:edad_al_ing", "motivodeegreso_mod_impEarly Drop-out:edad_al_ing", "motivodeegreso_mod_impAdministrative discharge:edad_al_ing", "motivodeegreso_mod_impReferral to another treatment:edad_al_ing"))

note_total_fits_genf_obj <-
    paste0("N= ",format(as.numeric(total_fits_genf_obj$N), big.mark=","),"; Events= ",format(as.numeric(total_fits_genf_obj$events), big.mark=","),"; Censored= ",format(as.numeric(total_fits_genf_obj$N - total_fits_genf_obj$events), big.mark=","),"; Time at risk= ",format(as.numeric(total_fits_genf_obj$trisk), big.mark=","),"; Df= ",format(as.numeric(total_fits_genf_obj$npars), big.mark=","), "; AIC= ",format(as.numeric(total_fits_genf_obj$AIC), big.mark=","))

#formal_vars

coefs_obj_genf_st_sub_total<-
  data.table::data.table(round(exp(total_fits_genf_obj$res),2)[,1:3],keep.rownames = T) %>% 
  dplyr::left_join(dplyr::filter(dt_coefs_simple_surv_obj_w_int, !grepl("edad_al_ing", formal_vars)), by=c("rn"="real_vars")) %>% 
  #dplyr::mutate(p.value=ifelse(p.value<.001,"<0.001",as.character(sprintf("%1.3f",p.value)))) %>% 
  dplyr::mutate(conf.low=sprintf("%1.2f",`L95%`),
                conf.high=sprintf("%1.2f",`U95%`),
                statistic=sprintf("%1.2f",est),
                `CI 95%`=paste0(conf.low,", ",conf.high)) %>% 
  #dplyr::mutate(var=dplyr::case_when(grepl("",rn)))
  dplyr::select(formal_vars, statistic, `CI 95%`) 


if(no_mostrar==1){
  data.table::data.table(round(exp(total_fits_genf_obj$res),2)[,1:3],keep.rownames = T) %>% 
  dplyr::left_join(dplyr::filter(dt_coefs_simple_surv_obj_w_int, !grepl("edad_al_ing", formal_vars)), by=c("rn"="real_vars")) %>% 
    dplyr::left_join(broom::tidy(total_fits_genf_obj)[,c("term","p.value")], by=c("rn"="term")) %>% 
  #dplyr::mutate(p.value=ifelse(p.value<.001,"<0.001",as.character(sprintf("%1.3f",p.value)))) %>% 
  dplyr::mutate(conf.low=sprintf("%1.2f",`L95%`),
                conf.high=sprintf("%1.2f",`U95%`),
                statistic=sprintf("%1.2f",est),
                `CI 95%`=paste0(conf.low,", ",conf.high)) %>% 
  #dplyr::mutate(var=dplyr::case_when(grepl("",rn)))
  dplyr::select(formal_vars, statistic, `CI 95%`) %>% 
    copiar_nombres()
}

coefs_obj_genf_st_sub_total %>% 
  knitr::kable(format= "html", format.args= list(decimal.mark= ".", big.mark= ","),
               caption=paste0("Table 10b. Coefficients of more complex model & controlling for interactions"),
               col.names = c("Term",rep(c("Accelerating Factor (AFT) or Time Ratio (TR)/Parameter value","CI 95%"),1)),
               align= c("l",rep('c', 16)), escape=F)%>%
  kableExtra::kable_classic(bootstrap_options = c("striped", "hover"),font_size=13)%>%
  kableExtra::group_rows("",1,4) %>%
  kableExtra::group_rows("Cause of discharge",5,8) %>% 
  kableExtra::group_rows("Sex",9,9) %>% 
  kableExtra::group_rows("Age",10,10) %>% 
  kableExtra::group_rows("Substance at admission",11,14) %>%
  kableExtra::group_rows("Starting Substance (most frequent)",15,18) %>%
  kableExtra::group_rows("Sex",19,22) %>% 
  kableExtra::group_rows("Age",23,26) %>% 
  kableExtra::group_rows("Substance at admission",27,42) %>%
  kableExtra::group_rows("Starting Substance (most frequent)",43,58) %>% 
  kableExtra::add_footnote(c("Note. From left to right:", 
                             paste0("Model fit: ",note_total_fits_genf_obj), 
                             paste0("AFT= $\\\\frac{1}{\\\\hat{HR}}$; $S_2(t)=S_1(\\\\gamma t)$; $\\\\gamma $ <1, exposure harmful survival")), 
                           notation = "none",
                           escape=FALSE) %>%
  kableExtra::scroll_box(width = "100%", height = "350px")
```

<br>

We made several Wald tests to determine whether the interactions were necessary or not:

- `r paste0("The effect of sex is not the same for each cause of admission Chisq (",total_fits_genf_obj_int_caus_adm_sex$Df[2],")=",round(total_fits_genf_obj_int_caus_adm_sex$Chisq[2],2),", ",dplyr::case_when(total_fits_genf_obj_int_caus_adm_sex$"Pr(>Chisq)"[2]<0.001~"p <0.001",total_fits_genf_obj_int_caus_adm_sex$"Pr(>Chisq)"[2]<0.01~"p <0.01", total_fits_genf_obj_int_caus_adm_sex$"Pr(>Chisq)"[2]<0.05~ "p <0.05", T~ as.character(round(total_fits_genf_obj_int_caus_adm_sex$"Pr(>Chisq)"[2],2))))`

- `r paste0("The effect of age is not the same for each cause of admission Chisq (",total_fits_genf_obj_int_caus_adm_age$Df[2],")=",round(total_fits_genf_obj_int_caus_adm_age$Chisq[2],2),", ",dplyr::case_when(total_fits_genf_obj_int_caus_adm_age$"Pr(>Chisq)"[2]<0.001~"p <0.001",total_fits_genf_obj_int_caus_adm_age$"Pr(>Chisq)"[2]<0.01~"p <0.01", total_fits_genf_obj_int_caus_adm_age$"Pr(>Chisq)"[2]<0.05~ "p <0.05", T~ as.character(round(total_fits_genf_obj_int_caus_adm_age$"Pr(>Chisq)"[2],2))))`

- `r paste0("The effect of the primary substance at admission is not the same for each cause of admission Chisq (",total_fits_genf_obj_int_caus_adm_prim_subs$Df[2],")=",round(total_fits_genf_obj_int_caus_adm_prim_subs$Chisq[2],2),", ",dplyr::case_when(total_fits_genf_obj_int_caus_adm_prim_subs$"Pr(>Chisq)"[2]<0.001~"p <0.001",total_fits_genf_obj_int_caus_adm_prim_subs$"Pr(>Chisq)"[2]<0.01~"p <0.01", total_fits_genf_obj_int_caus_adm_prim_subs$"Pr(>Chisq)"[2]<0.05~ "p <0.05", T~ as.character(round(total_fits_genf_obj_int_caus_adm_prim_subs$"Pr(>Chisq)"[2],2))))`

- `r paste0("The effect of the initial/starting substance is not the same for each cause of admission Chisq (",total_fits_genf_obj_int_caus_adm_init_subs$Df[2],")=",round(total_fits_genf_obj_int_caus_adm_init_subs$Chisq[2],2),", ",dplyr::case_when(total_fits_genf_obj_int_caus_adm_init_subs$"Pr(>Chisq)"[2]<0.001~"p <0.001",total_fits_genf_obj_int_caus_adm_init_subs$"Pr(>Chisq)"[2]<0.01~"p <0.01", total_fits_genf_obj_int_caus_adm_init_subs$"Pr(>Chisq)"[2]<0.05~ "p <0.05", T~ as.character(round(total_fits_genf_obj_int_caus_adm_init_subs$"Pr(>Chisq)"[2],2))))`

<br>

```{r fit_surv_parametric_complex_model_pred, echo=T, error=T, fig.align="center", warning=FALSE, paged.print=TRUE, eval=T}
#sexo_2_fits_genf_obj  age_fits_genf_obj prim_sub_fits_genf_obj  st_sub_fits_genf_obj st_sub_mvv_fits_genf_obj

dt_sum_ob_tr_out_sex_90<-
  rbindlist(summary(sexo_2_fits_genf_obj, type= "rmst", newdata=expand.grid(motivodeegreso_mod_imp=levels(CONS_C1_df_dup_SEP_2020_irrs_health_survreg$motivodeegreso_mod_imp)[1:5], sexo_2=levels(CONS_C1_df_dup_SEP_2020_irrs_health_survreg$sexo_2)), B=1e4, t=.25), idcol="Treatment Outcome") %>% 
    tidyr::separate(`Treatment Outcome`,into=c("Treatment Outcome","Sex"),sep=", ") %>% 
  dplyr::mutate(`Treatment Outcome`=factor(gsub("motivodeegreso_mod_imp\\=","",`Treatment Outcome`))) %>% 
  dplyr::mutate(Sex=factor(gsub("sexo_2\\=","",Sex))) 

# dt_sum_ob_tr_out_age_90<-
#   rbindlist(summary(age_fits_genf_obj, type= "rmst", newdata=expand.grid(motivodeegreso_mod_imp=levels(CONS_C1_df_dup_SEP_2020_irrs_health_survreg$motivodeegreso_mod_imp)[1:5], edad_grupos=levels(CONS_C1_df_dup_SEP_2020_irrs_health_survreg$edad_grupos)), B=1e4, t=.25), idcol="Treatment Outcome") %>% 
#     tidyr::separate(`Treatment Outcome`,into=c("Treatment Outcome","Age"),sep=", ") %>% 
#   dplyr::mutate(`Treatment Outcome`=factor(gsub("motivodeegreso_mod_imp\\=","",`Treatment Outcome`))) %>% 
#   dplyr::mutate(Age=factor(gsub("edad_grupos\\=","",Age))) 

dt_sum_ob_tr_out_age_90<-
  rbindlist(summary(age_fits_genf_obj, type= "rmst", newdata=expand.grid(motivodeegreso_mod_imp=levels(CONS_C1_df_dup_SEP_2020_irrs_health_survreg$motivodeegreso_mod_imp)[1:5], edad_al_ing=quantile(scale(CONS_C1_df_dup_SEP_2020_irrs_health_survreg$edad_al_ing, scale=F),c(.25, .5, .75), na.rm=T)), B=1e4, t=.25), idcol="Treatment Outcome") %>% 
    tidyr::separate(`Treatment Outcome`,into=c("Treatment Outcome","Age"),sep=", ") %>% 
  dplyr::mutate(`Treatment Outcome`=factor(gsub("motivodeegreso_mod_imp\\=","",`Treatment Outcome`))) %>% 
  dplyr::mutate(Age=factor(gsub("edad_al_ing\\=","",Age)))

dt_sum_ob_tr_out_prim_sub_90<-
  rbindlist(summary(prim_sub_fits_genf_obj, type= "rmst", newdata=expand.grid(motivodeegreso_mod_imp=levels(CONS_C1_df_dup_SEP_2020_irrs_health_survreg$motivodeegreso_mod_imp)[1:5], sus_principal_mod=levels(CONS_C1_df_dup_SEP_2020_irrs_health_survreg$sus_principal_mod)), B=1e4, t=.25), idcol="Treatment Outcome") %>% 
    tidyr::separate(`Treatment Outcome`,into=c("Treatment Outcome","Substance at admission"),sep=", ") %>% 
  dplyr::mutate(`Treatment Outcome`=factor(gsub("motivodeegreso_mod_imp\\=","",`Treatment Outcome`))) %>% 
  dplyr::mutate(`Substance at admission` =factor(gsub("sus_principal_mod\\=","",`Substance at admission`))) 

dt_sum_ob_tr_out_st_sub_90<-
  rbindlist(summary(st_sub_fits_genf_obj, type= "rmst", newdata=expand.grid(motivodeegreso_mod_imp=levels(CONS_C1_df_dup_SEP_2020_irrs_health_survreg$motivodeegreso_mod_imp)[1:5], sus_ini_mod=levels(CONS_C1_df_dup_SEP_2020_irrs_health_survreg$sus_ini_mod)), B=1e4, t=.25), idcol="Treatment Outcome") %>% 
    tidyr::separate(`Treatment Outcome`,into=c("Treatment Outcome","Starting Substance (most frequent)"),sep=", ") %>% 
  dplyr::mutate(`Treatment Outcome`=factor(gsub("motivodeegreso_mod_imp\\=","",`Treatment Outcome`))) %>% 
  dplyr::mutate(`Starting Substance (most frequent)`=factor(gsub("sus_ini_mod\\=","",`Starting Substance (most frequent)`))) 

dt_sum_ob_tr_out_st_sub_mvv_90<-
  rbindlist(summary(st_sub_mvv_fits_genf_obj, type= "rmst", newdata=expand.grid(motivodeegreso_mod_imp=levels(CONS_C1_df_dup_SEP_2020_irrs_health_survreg$motivodeegreso_mod_imp)[1:5], sus_ini_mod_mvv=levels(CONS_C1_df_dup_SEP_2020_irrs_health_survreg$sus_ini_mod_mvv)), B=1e4, t=.25), idcol="Treatment Outcome") %>% 
    tidyr::separate(`Treatment Outcome`,into=c("Treatment Outcome","Starting Substance (most vulnerable)"),sep=", ") %>% 
  dplyr::mutate(`Treatment Outcome`=factor(gsub("motivodeegreso_mod_imp\\=","",`Treatment Outcome`))) %>% 
  dplyr::mutate(`Starting Substance (most vulnerable)`=factor(gsub("sus_ini_mod_mvv\\=","",`Starting Substance (most vulnerable)`))) 


dt_sum_ob_tr_out_sex_365<-
  rbindlist(summary(sexo_2_fits_genf_obj, type= "rmst", newdata=expand.grid(motivodeegreso_mod_imp=levels(CONS_C1_df_dup_SEP_2020_irrs_health_survreg$motivodeegreso_mod_imp)[1:5], sexo_2=levels(CONS_C1_df_dup_SEP_2020_irrs_health_survreg$sexo_2)), B=1e4, t=.25), idcol="Treatment Outcome") %>% 
    tidyr::separate(`Treatment Outcome`,into=c("Treatment Outcome","Sex"),sep=", ") %>% 
  dplyr::mutate(`Treatment Outcome`=factor(gsub("motivodeegreso_mod_imp\\=","",`Treatment Outcome`))) %>% 
  dplyr::mutate(Sex=factor(gsub("sexo_2\\=","",Sex))) 

dt_sum_ob_tr_out_age_365<-
  rbindlist(summary(age_fits_genf_obj, type= "rmst", newdata=expand.grid(motivodeegreso_mod_imp=levels(CONS_C1_df_dup_SEP_2020_irrs_health_survreg$motivodeegreso_mod_imp)[1:5], edad_al_ing=quantile(scale(CONS_C1_df_dup_SEP_2020_irrs_health_survreg$edad_al_ing, scale=F),c(.25, .5, .75), na.rm=T)), B=1e4, t=1), idcol="Treatment Outcome") %>% 
    tidyr::separate(`Treatment Outcome`,into=c("Treatment Outcome","Age"),sep=", ") %>% 
  dplyr::mutate(`Treatment Outcome`=factor(gsub("motivodeegreso_mod_imp\\=","",`Treatment Outcome`))) %>% 
  dplyr::mutate(Age=factor(gsub("edad_al_ing\\=","",Age)))

dt_sum_ob_tr_out_prim_sub_365<-
  rbindlist(summary(prim_sub_fits_genf_obj, type= "rmst", newdata=expand.grid(motivodeegreso_mod_imp=levels(CONS_C1_df_dup_SEP_2020_irrs_health_survreg$motivodeegreso_mod_imp)[1:5], sus_principal_mod=levels(CONS_C1_df_dup_SEP_2020_irrs_health_survreg$sus_principal_mod)), B=1e4, t=1), idcol="Treatment Outcome") %>% 
    tidyr::separate(`Treatment Outcome`,into=c("Treatment Outcome","Substance at admission"),sep=", ") %>% 
  dplyr::mutate(`Treatment Outcome`=factor(gsub("motivodeegreso_mod_imp\\=","",`Treatment Outcome`))) %>% 
  dplyr::mutate(`Substance at admission` =factor(gsub("sus_principal_mod\\=","",`Substance at admission`))) 

dt_sum_ob_tr_out_st_sub_365<-
  rbindlist(summary(st_sub_fits_genf_obj, type= "rmst", newdata=expand.grid(motivodeegreso_mod_imp=levels(CONS_C1_df_dup_SEP_2020_irrs_health_survreg$motivodeegreso_mod_imp)[1:5], sus_ini_mod=levels(CONS_C1_df_dup_SEP_2020_irrs_health_survreg$sus_ini_mod)), B=1e4, t=1), idcol="Treatment Outcome") %>% 
    tidyr::separate(`Treatment Outcome`,into=c("Treatment Outcome","Starting Substance (most frequent)"),sep=", ") %>% 
  dplyr::mutate(`Treatment Outcome`=factor(gsub("motivodeegreso_mod_imp\\=","",`Treatment Outcome`))) %>% 
  dplyr::mutate(`Starting Substance (most frequent)`=factor(gsub("sus_ini_mod\\=","",`Starting Substance (most frequent)`))) 

dt_sum_ob_tr_out_st_sub_mvv_365<-
  rbindlist(summary(st_sub_mvv_fits_genf_obj, type= "rmst", newdata=expand.grid(motivodeegreso_mod_imp=levels(CONS_C1_df_dup_SEP_2020_irrs_health_survreg$motivodeegreso_mod_imp)[1:5], sus_ini_mod_mvv=levels(CONS_C1_df_dup_SEP_2020_irrs_health_survreg$sus_ini_mod_mvv)), B=1e4, t=1), idcol="Treatment Outcome") %>% 
    tidyr::separate(`Treatment Outcome`,into=c("Treatment Outcome","Starting Substance (most vulnerable)"),sep=", ") %>% 
  dplyr::mutate(`Treatment Outcome`=factor(gsub("motivodeegreso_mod_imp\\=","",`Treatment Outcome`))) %>% 
  dplyr::mutate(`Starting Substance (most vulnerable)`=factor(gsub("sus_ini_mod_mvv\\=","",`Starting Substance (most vulnerable)`))) 

dt_sum_ob_tr_out_sex_1096<-
  rbindlist(summary(sexo_2_fits_genf_obj, type= "rmst", newdata=expand.grid(motivodeegreso_mod_imp=levels(CONS_C1_df_dup_SEP_2020_irrs_health_survreg$motivodeegreso_mod_imp)[1:5], sexo_2=levels(CONS_C1_df_dup_SEP_2020_irrs_health_survreg$sexo_2)), B=1e4, t=3), idcol="Treatment Outcome") %>% 
    tidyr::separate(`Treatment Outcome`,into=c("Treatment Outcome","Sex"),sep=", ") %>% 
  dplyr::mutate(`Treatment Outcome`=factor(gsub("motivodeegreso_mod_imp\\=","",`Treatment Outcome`))) %>% 
  dplyr::mutate(Sex=factor(gsub("sexo_2\\=","",Sex))) 

dt_sum_ob_tr_out_age_1096<-
  rbindlist(summary(age_fits_genf_obj, type= "rmst", newdata=expand.grid(motivodeegreso_mod_imp=levels(CONS_C1_df_dup_SEP_2020_irrs_health_survreg$motivodeegreso_mod_imp)[1:5], edad_al_ing=quantile(scale(CONS_C1_df_dup_SEP_2020_irrs_health_survreg$edad_al_ing, scale=F),c(.25, .5, .75), na.rm=T)), B=1e4, t=3), idcol="Treatment Outcome") %>% 
    tidyr::separate(`Treatment Outcome`,into=c("Treatment Outcome","Age"),sep=", ") %>% 
  dplyr::mutate(`Treatment Outcome`=factor(gsub("motivodeegreso_mod_imp\\=","",`Treatment Outcome`))) %>% 
  dplyr::mutate(Age=factor(gsub("edad_al_ing\\=","",Age)))

dt_sum_ob_tr_out_prim_sub_1096<-
  rbindlist(summary(prim_sub_fits_genf_obj, type= "rmst", newdata=expand.grid(motivodeegreso_mod_imp=levels(CONS_C1_df_dup_SEP_2020_irrs_health_survreg$motivodeegreso_mod_imp)[1:5], sus_principal_mod=levels(CONS_C1_df_dup_SEP_2020_irrs_health_survreg$sus_principal_mod)), B=1e4, t=3), idcol="Treatment Outcome") %>% 
    tidyr::separate(`Treatment Outcome`,into=c("Treatment Outcome","Substance at admission"),sep=", ") %>% 
  dplyr::mutate(`Treatment Outcome`=factor(gsub("motivodeegreso_mod_imp\\=","",`Treatment Outcome`))) %>% 
  dplyr::mutate(`Substance at admission` =factor(gsub("sus_principal_mod\\=","",`Substance at admission`))) 

dt_sum_ob_tr_out_st_sub_1096<-
  rbindlist(summary(st_sub_fits_genf_obj, type= "rmst", newdata=expand.grid(motivodeegreso_mod_imp=levels(CONS_C1_df_dup_SEP_2020_irrs_health_survreg$motivodeegreso_mod_imp)[1:5], sus_ini_mod=levels(CONS_C1_df_dup_SEP_2020_irrs_health_survreg$sus_ini_mod)), B=1e4, t=3), idcol="Treatment Outcome") %>% 
    tidyr::separate(`Treatment Outcome`,into=c("Treatment Outcome","Starting Substance (most frequent)"),sep=", ") %>% 
  dplyr::mutate(`Treatment Outcome`=factor(gsub("motivodeegreso_mod_imp\\=","",`Treatment Outcome`))) %>% 
  dplyr::mutate(`Starting Substance (most frequent)`=factor(gsub("sus_ini_mod\\=","",`Starting Substance (most frequent)`))) 

dt_sum_ob_tr_out_st_sub_mvv_1096<-
  rbindlist(summary(st_sub_mvv_fits_genf_obj, type= "rmst", newdata=expand.grid(motivodeegreso_mod_imp=levels(CONS_C1_df_dup_SEP_2020_irrs_health_survreg$motivodeegreso_mod_imp)[1:5], sus_ini_mod_mvv=levels(CONS_C1_df_dup_SEP_2020_irrs_health_survreg$sus_ini_mod_mvv)), B=1e4, t=3), idcol="Treatment Outcome") %>% 
    tidyr::separate(`Treatment Outcome`,into=c("Treatment Outcome","Starting Substance (most vulnerable)"),sep=", ") %>% 
  dplyr::mutate(`Treatment Outcome`=factor(gsub("motivodeegreso_mod_imp\\=","",`Treatment Outcome`))) %>% 
  dplyr::mutate(`Starting Substance (most vulnerable)`=factor(gsub("sus_ini_mod_mvv\\=","",`Starting Substance (most vulnerable)`))) 


dt_sum_ob_tr_out_sex_1826<-
  rbindlist(summary(sexo_2_fits_genf_obj, type= "rmst", newdata=expand.grid(motivodeegreso_mod_imp=levels(CONS_C1_df_dup_SEP_2020_irrs_health_survreg$motivodeegreso_mod_imp)[1:5], sexo_2=levels(CONS_C1_df_dup_SEP_2020_irrs_health_survreg$sexo_2)), B=1e4, t=5), idcol="Treatment Outcome") %>% 
    tidyr::separate(`Treatment Outcome`,into=c("Treatment Outcome","Sex"),sep=", ") %>% 
  dplyr::mutate(`Treatment Outcome`=factor(gsub("motivodeegreso_mod_imp\\=","",`Treatment Outcome`))) %>% 
  dplyr::mutate(Sex=factor(gsub("sexo_2\\=","",Sex))) 

dt_sum_ob_tr_out_age_1826<-
  rbindlist(summary(age_fits_genf_obj, type= "rmst", newdata=expand.grid(motivodeegreso_mod_imp=levels(CONS_C1_df_dup_SEP_2020_irrs_health_survreg$motivodeegreso_mod_imp)[1:5], edad_al_ing=quantile(scale(CONS_C1_df_dup_SEP_2020_irrs_health_survreg$edad_al_ing, scale=F),c(.25, .5, .75), na.rm=T)), B=1e4, t=5), idcol="Treatment Outcome") %>% 
    tidyr::separate(`Treatment Outcome`,into=c("Treatment Outcome","Age"),sep=", ") %>% 
  dplyr::mutate(`Treatment Outcome`=factor(gsub("motivodeegreso_mod_imp\\=","",`Treatment Outcome`))) %>% 
  dplyr::mutate(Age=factor(gsub("edad_al_ing\\=","",Age)))

dt_sum_ob_tr_out_prim_sub_1826<-
  rbindlist(summary(prim_sub_fits_genf_obj, type= "rmst", newdata=expand.grid(motivodeegreso_mod_imp=levels(CONS_C1_df_dup_SEP_2020_irrs_health_survreg$motivodeegreso_mod_imp)[1:5], sus_principal_mod=levels(CONS_C1_df_dup_SEP_2020_irrs_health_survreg$sus_principal_mod)), B=1e4, t=5), idcol="Treatment Outcome") %>% 
    tidyr::separate(`Treatment Outcome`,into=c("Treatment Outcome","Substance at admission"),sep=", ") %>% 
  dplyr::mutate(`Treatment Outcome`=factor(gsub("motivodeegreso_mod_imp\\=","",`Treatment Outcome`))) %>% 
  dplyr::mutate(`Substance at admission` =factor(gsub("sus_principal_mod\\=","",`Substance at admission`))) 

dt_sum_ob_tr_out_st_sub_1826<-
  rbindlist(summary(st_sub_fits_genf_obj, type= "rmst", newdata=expand.grid(motivodeegreso_mod_imp=levels(CONS_C1_df_dup_SEP_2020_irrs_health_survreg$motivodeegreso_mod_imp)[1:5], sus_ini_mod=levels(CONS_C1_df_dup_SEP_2020_irrs_health_survreg$sus_ini_mod)), B=1e4, t=5), idcol="Treatment Outcome") %>% 
    tidyr::separate(`Treatment Outcome`,into=c("Treatment Outcome","Starting Substance (most frequent)"),sep=", ") %>% 
  dplyr::mutate(`Treatment Outcome`=factor(gsub("motivodeegreso_mod_imp\\=","",`Treatment Outcome`))) %>% 
  dplyr::mutate(`Starting Substance (most frequent)`=factor(gsub("sus_ini_mod\\=","",`Starting Substance (most frequent)`))) 

dt_sum_ob_tr_out_st_sub_mvv_1826<-
  rbindlist(summary(st_sub_mvv_fits_genf_obj, type= "rmst", newdata=expand.grid(motivodeegreso_mod_imp=levels(CONS_C1_df_dup_SEP_2020_irrs_health_survreg$motivodeegreso_mod_imp)[1:5], sus_ini_mod_mvv=levels(CONS_C1_df_dup_SEP_2020_irrs_health_survreg$sus_ini_mod_mvv)), B=1e4, t=5), idcol="Treatment Outcome") %>% 
    tidyr::separate(`Treatment Outcome`,into=c("Treatment Outcome","Starting Substance (most vulnerable)"),sep=", ") %>% 
  dplyr::mutate(`Treatment Outcome`=factor(gsub("motivodeegreso_mod_imp\\=","",`Treatment Outcome`))) %>% 
  dplyr::mutate(`Starting Substance (most vulnerable)`=factor(gsub("sus_ini_mod_mvv\\=","",`Starting Substance (most vulnerable)`))) 

lab_obj_rmst<-
cbind.data.frame(n_mod=1:20, lab=rep(c("Sex","Age","Primary Substance at admission","Starting substance (Most frequent)","Starting substance (Most vulnerable)"),4))

rbindlist(list(
dt_sum_ob_tr_out_sex_90, dt_sum_ob_tr_out_age_90, dt_sum_ob_tr_out_prim_sub_90, dt_sum_ob_tr_out_st_sub_90, dt_sum_ob_tr_out_st_sub_mvv_90, dt_sum_ob_tr_out_sex_365, dt_sum_ob_tr_out_age_365, dt_sum_ob_tr_out_prim_sub_365, dt_sum_ob_tr_out_st_sub_365, dt_sum_ob_tr_out_st_sub_mvv_365, dt_sum_ob_tr_out_sex_1096, dt_sum_ob_tr_out_age_1096, dt_sum_ob_tr_out_prim_sub_1096, dt_sum_ob_tr_out_st_sub_1096, dt_sum_ob_tr_out_st_sub_mvv_1096, dt_sum_ob_tr_out_sex_1826, dt_sum_ob_tr_out_age_1826, dt_sum_ob_tr_out_prim_sub_1826, dt_sum_ob_tr_out_st_sub_1826, dt_sum_ob_tr_out_st_sub_mvv_1826), idcol=model, use.names=F) %>% 
  dplyr::rename("Category"="Sex","model"="fits_rp05_objc") %>% 
  dplyr::mutate(RMST=paste0(sprintf("%3.2f",`est`)," [",sprintf("%3.2f",`lcl`),", ",sprintf("%3.2f",`ucl`),"]")) %>%
  dplyr::mutate(Category= dplyr::case_when(grepl("-8.540",as.character(Category))~"Q1",grepl("-1.840",as.character(Category))~"Q2",grepl("7.019",as.character(Category))~"Q3",T~as.character(Category))) %>% 
  tidyr::pivot_wider(id_cols=c("model","Category"), names_from = `Treatment Outcome`, values_from = RMST) %>% 
  dplyr::mutate(Category=gsub("Pasta Base","Cocaine paste",Category)) %>% 
  dplyr::mutate(Category=gsub("Otros","Other",Category)) %>% 
  dplyr::mutate(Category=gsub("Cocaína","Cocaine hydrochloride",Category)) %>% 
  dplyr::mutate(Category=gsub("Marihuana","Marijuana",Category)) %>% 
  dplyr::left_join(lab_obj_rmst,by=c("model"="n_mod")) %>% 
  dplyr::select(-model)%>% 
  dplyr::select(lab, everything())%>% 
  dplyr::rename("Variable"="lab") %>% 
  knitr::kable(format="html",caption="Table 11a. Predicted Restricted Mean Survival Time of The Complex models (Interaction) depending on a specific time and value") %>% 
  kableExtra::kable_classic() %>% 
  kableExtra::group_rows("At 90 days",1,20) %>% 
  kableExtra::group_rows("At 1 year",21,40) %>% 
  kableExtra::group_rows("At 3 years",41,60) %>% 
    kableExtra::group_rows("At 5 years",61,80) %>%
  kableExtra::scroll_box(width = "100%", height = "350px")
```

<br>

`r round(as.numeric(CONS_C1_df_dup_SEP_2020_irrs_health_survreg %>% dplyr::mutate(edad_al_ing_sc=as.numeric(scale(edad_al_ing, scale=F))) %>%  dplyr::select(edad_al_ing,edad_al_ing_sc) %>% distinct(edad_al_ing, .keep_all=T) %>% dplyr::arrange(edad_al_ing) %>% dplyr::slice(which.min(abs(edad_al_ing_sc - -1.84))) %>% dplyr::select(edad_al_ing)),2)` years was the median (M-1.84), the first quantile was `r round(as.numeric(CONS_C1_df_dup_SEP_2020_irrs_health_survreg %>% dplyr::mutate(edad_al_ing_sc=as.numeric(scale(edad_al_ing, scale=F))) %>%  dplyr::select(edad_al_ing,edad_al_ing_sc) %>% distinct(edad_al_ing, .keep_all=T) %>% dplyr::arrange(edad_al_ing) %>% dplyr::slice(which.min(abs(edad_al_ing_sc - -8.54))) %>% dplyr::select(edad_al_ing)),2)` (M-8.54) and the third quantile was `r round(as.numeric(CONS_C1_df_dup_SEP_2020_irrs_health_survreg %>% dplyr::mutate(edad_al_ing_sc=as.numeric(scale(edad_al_ing, scale=F))) %>%  dplyr::select(edad_al_ing,edad_al_ing_sc) %>% distinct(edad_al_ing, .keep_all=T) %>% dplyr::arrange(edad_al_ing) %>% dplyr::slice(which.min(abs(edad_al_ing_sc - 7.19))) %>% dplyr::select(edad_al_ing)),2)` years (M+7.019).

<br>

```{r fit_surv_parametric_complex_model_pred_b, echo=T, error=T, fig.align="center", warning=FALSE, paged.print=TRUE, eval=T}
time_before_sim_rmst<-Sys.time()
# Abadi, A., Amanpour, F., Bajdik, C., & Yavari, P. (2012). Breast Cancer Survival Analysis: Applying the Generalized Gamma Distribution under Different Conditions of the Proportional Hazards and Accelerated Failure Time Assumptions. International journal of preventive medicine, 3(9), 644–651.
#
# The relative times are defined for 0 < p < 1 as the ratio of the corresponding quantile functions, RT (p) = t1(p)/t0(p). The interpretation of RT (p) is that the time required for proportion p of individuals in the exposed or treated population to experience the event of interest is RT(p)-fold the time for the same proportion of events to occur in the reference population. Links between quantiles of the gamma and GG facilitats use of software to obtain the percentiles of the GG.
#
# In AFT model, the dependent variable is log of the survival time T.

#https://myweb.uiowa.edu/pbreheny/7210/f15/notes/10-15.pdf
#
#If e ηi = 1/2, that subject effectively ages at twice normal speed If e
#ηi = 2, that subject effectively ages at only half of normal speed

# A positive coefficient means the effect of the covariate is to prolong the survival time while a negative coefficient is to shorten the time to attrition. Relatively, a time ratio greater than 1 implies the effect of the covariate increases the survival time and otherwise decreases (“speeds up”) the time to attrition.

#have longer survival times compared to their counterparts

#Warning: stack imbalance in '-', 92 then 93
rmst_total_fits_genf_obj<-
rbindlist(summary(total_fits_genf_obj, type= "rmst", 
                  newdata=expand.grid(motivodeegreso_mod_imp=levels(CONS_C1_df_dup_SEP_2020_irrs_health_survreg$motivodeegreso_mod_imp)[1:5], sexo_2=levels(CONS_C1_df_dup_SEP_2020_irrs_health_survreg$sexo_2), #edad_grupos=levels(CONS_C1_df_dup_SEP_2020_irrs_health_survreg$edad_grupos),
edad_al_ing=quantile(scale(CONS_C1_df_dup_SEP_2020_irrs_health_survreg$edad_al_ing, scale=F),c(.25, .5, .75), na.rm=T),                                      sus_principal_mod=levels(CONS_C1_df_dup_SEP_2020_irrs_health_survreg$sus_principal_mod), sus_ini_mod=levels(CONS_C1_df_dup_SEP_2020_irrs_health_survreg$sus_ini_mod)), B=1e4, t=c(.25,1,3,5)), 
          idcol="Total") %>% 
  tidyr::separate(Total,into=c("Treatment Outcome","Sex", "Age","Primary Substance","Initial Substance"),sep=", ") %>% 
    dplyr::mutate(Age= dplyr::case_when(grepl("-8.540",as.character(Age))~"Q1",grepl("-1.840",as.character(Age))~"Q2",grepl("7.019",as.character(Age))~"Q3",T~as.character(Age))) %>% #View()
  dplyr::mutate(`Treatment Outcome`=factor(gsub("motivodeegreso_mod_imp\\=","",`Treatment Outcome`))) %>% 
  dplyr::mutate(Sex=factor(gsub("sexo_2\\=","",Sex))) %>% 
  dplyr::mutate(Age=factor(gsub("edad_grupos\\=","",Age))) %>% 
  dplyr::mutate(Age=factor(gsub("edad_al_ing\\=","",Age))) %>% 
  dplyr::mutate(`Primary Substance`=factor(gsub("sus_principal_mod\\=","",`Primary Substance`))) %>% 
  dplyr::mutate(`Initial Substance`=factor(gsub("sus_ini_mod\\=","",`Initial Substance`)))

surv_total_fits_genf_obj<-
rbindlist(summary(total_fits_genf_obj, type= "survival", 
                  newdata=expand.grid(motivodeegreso_mod_imp=levels(CONS_C1_df_dup_SEP_2020_irrs_health_survreg$motivodeegreso_mod_imp)[1:5], sexo_2=levels(CONS_C1_df_dup_SEP_2020_irrs_health_survreg$sexo_2), #edad_grupos=levels(CONS_C1_df_dup_SEP_2020_irrs_health_survreg$edad_grupos),
edad_al_ing=quantile(scale(CONS_C1_df_dup_SEP_2020_irrs_health_survreg$edad_al_ing, scale=F),c(.25, .5, .75), na.rm=T),                                      sus_principal_mod=levels(CONS_C1_df_dup_SEP_2020_irrs_health_survreg$sus_principal_mod), sus_ini_mod=levels(CONS_C1_df_dup_SEP_2020_irrs_health_survreg$sus_ini_mod)), B=1e4, t=c(.25,1,3,5)), 
          idcol="Total") %>% 
  tidyr::separate(Total,into=c("Treatment Outcome","Sex", "Age","Primary Substance","Initial Substance"),sep=", ") %>% 
    dplyr::mutate(Age= dplyr::case_when(grepl("-8.540",as.character(Age))~"Q1",grepl("-1.840",as.character(Age))~"Q2",grepl("7.019",as.character(Age))~"Q3",T~as.character(Age))) %>% #View()
  dplyr::mutate(`Treatment Outcome`=factor(gsub("motivodeegreso_mod_imp\\=","",`Treatment Outcome`))) %>% 
  dplyr::mutate(Sex=factor(gsub("sexo_2\\=","",Sex))) %>% 
  dplyr::mutate(Age=factor(gsub("edad_grupos\\=","",Age))) %>% 
  dplyr::mutate(Age=factor(gsub("edad_al_ing\\=","",Age))) %>% 
  dplyr::mutate(`Primary Substance`=factor(gsub("sus_principal_mod\\=","",`Primary Substance`))) %>% 
  dplyr::mutate(`Initial Substance`=factor(gsub("sus_ini_mod\\=","",`Initial Substance`)))
  
rmst_total_fits_genf_obj %>% 
    dplyr::mutate(RMST=paste0(sprintf("%3.2f",`est`)," [",sprintf("%3.2f",`lcl`),", ",sprintf("%3.2f",`ucl`),"]"))%>%
  tidyr::pivot_wider(id_cols=c("time","Sex","Age","Primary Substance","Initial Substance"), names_from = `Treatment Outcome`, values_from = RMST) %>% 
    dplyr::mutate(time=factor(as.character(time),
                levels=c("0.25","1","3","5"), 
                labels=c("~3 months", "~1 year", "~3 years", "~5 years"))) %>% 
  knitr::kable(format="html",caption="Table 11b. Predicted Restricted Mean Survival Time of The more complex model & controlling for interactions, and depending on a specific time and value") %>% 
  kableExtra::kable_classic(font_size = 11) %>% 
  kableExtra::scroll_box(width = "100%", height = "350px")

time_after_sim_rmst<-Sys.time()

paste0("Time in process: ");time_after_sim_rmst-time_before_sim_rmst

```

<br>

```{r plot_rmst_complex_mod1, echo=T, error=T, fig.cap="Figure 21a. Predicted Interaction. Sex", warning=FALSE, paged.print=TRUE, fig.align="center", dpi=320, eval=T}

rmst_total_fits_genf_obj %>%
    dplyr::mutate(time=factor(as.character(time),
                levels=c("0.25","1","3","5"), 
                labels=c("~3 months", "~1 year", "~3 years", "~5 years"))) %>%   
  dplyr::filter(Age=="Q2", `Initial Substance`=="Alcohol", `Primary Substance`=="Alcohol", time!="~3 months", time!= "~1 year") %>% 
  ggplot(aes(x=`Treatment Outcome`, y=est, color=Sex, fill=Sex))+
  geom_bar(aes(x=`Treatment Outcome`, y=est, color=Sex, fill=Sex), position="dodge", stat="identity", alpha=0.4, width=.85)+
  theme_bw()+
  geom_errorbar(aes(x=`Treatment Outcome`, ymin=lcl, ymax=ucl, color=Sex, fill=Sex), position="dodge", stat="identity", width=0.85,  alpha=0.9, size=1)+
  ylab("Time to event (years)")+
  facet_wrap(~time)+
  #scale_color_manual(name ="Modality",values=c("#0E53A7","#FFB540"), labels= c("Outpatient","Residential"))+
  #scale_fill_manual(name ="Modality",values=c("#0E53A7","#FFB540"), labels= c("Outpatient","Residential"))+
  xlab("Cause of discharge")+
  coord_flip(ylim=c(2,5))+
  labs(caption="Note. For a median age (34 years) with alcohol as the initial/starting and primary substance")

if(no_mostrar==1){
  
surv_total_fits_genf_obj %>%
    dplyr::mutate(time=factor(as.character(time),
                levels=c("0.25","1","3","5"), 
                labels=c("~3 months", "~1 year", "~3 years", "~5 years"))) %>%
      dplyr::filter(Age=="Q2", `Initial Substance`=="Alcohol", `Primary Substance`=="Alcohol", time=="~3 years", `Treatment Outcome`%in% c("Referral to another treatment","Therapeutic discharge")) %>%

  ggplot(aes(x=Sex, y=est, color=`Treatment Outcome`, fill=`Treatment Outcome`))+
  geom_bar(aes(x=Sex, y=est, color=`Treatment Outcome`, fill=`Treatment Outcome`), position="dodge", stat="identity", alpha=0.4, width=.8)+
  theme_bw()+
  geom_errorbar(aes(x=Sex, ymin=lcl, ymax=ucl, color=`Treatment Outcome`, fill=`Treatment Outcome`), position="dodge", stat="identity", width=0.8,  alpha=0.9, size=1)+
  ylab("Survival")+
  xlab("Sex")+
  coord_flip(ylim=c(.6,1))+
    theme(legend.position="bottom")+
  labs(caption="Note. For a median age (34 years) with alcohol as the initial/starting and primary substance. Fixed in 3 years")
}
```

<br>

```{r plot_rmst_complex_mod2, echo=T, error=T, fig.cap="Figure 21b. Predicted Interaction. Age", warning=FALSE, paged.print=TRUE, fig.align="center", dpi=320, eval=T}

rmst_total_fits_genf_obj %>%
    dplyr::mutate(time=factor(as.character(time),
                levels=c("0.25","1","3","5"), 
                labels=c("~3 months", "~1 year", "~3 years", "~5 years"))) %>%   
  dplyr::filter(Sex=="Men", `Initial Substance`=="Alcohol", `Primary Substance`=="Alcohol", time!="~3 months", time!= "~1 year") %>% 
  ggplot(aes(x=`Treatment Outcome`, y=est, color=Age, fill=Age))+
  geom_bar(aes(x=`Treatment Outcome`, y=est, color=Age, fill=Age), position="dodge", stat="identity", alpha=0.4, width=.7)+
  theme_bw()+
  geom_errorbar(aes(x=`Treatment Outcome`, ymin=lcl, ymax=ucl, color=Age, fill=Age), position="dodge", stat="identity", width=0.7,  alpha=0.9, size=1)+
  ylab("Time to event (years)")+
  facet_wrap(~time)+
  #scale_color_manual(name ="Modality",values=c("#0E53A7","#FFB540"), labels= c("Outpatient","Residential"))+
  #scale_fill_manual(name ="Modality",values=c("#0E53A7","#FFB540"), labels= c("Outpatient","Residential"))+
  xlab("Cause of discharge")+
  coord_flip(ylim=c(2,5))+
  theme(legend.position="bottom")+
  labs(caption="Note. For men with alcohol as the initial/starting and primary substance")

if(no_mostrar==1){
  
surv_total_fits_genf_obj %>%
    dplyr::mutate(time=factor(as.character(time),
                levels=c("0.25","1","3","5"), 
                labels=c("~3 months", "~1 year", "~3 years", "~5 years"))) %>%
      dplyr::filter(Sex=="Men", `Initial Substance`=="Alcohol", `Primary Substance`=="Alcohol", time=="~3 years", `Treatment Outcome`%in% c("Referral to another treatment","Therapeutic discharge")) %>%
  ggplot(aes(x=Age, y=est, color=`Treatment Outcome`, fill=`Treatment Outcome`))+
  geom_bar(aes(x=Age, y=est, color=`Treatment Outcome`, fill=`Treatment Outcome`), position="dodge", stat="identity", alpha=0.4, width=.8)+
  theme_bw()+
  geom_errorbar(aes(x=Age, ymin=lcl, ymax=ucl, color=`Treatment Outcome`, fill=`Treatment Outcome`), position="dodge", stat="identity", width=0.8,  alpha=0.9, size=1)+
  ylab("Survival")+
  xlab("Age")+
  coord_flip(ylim=c(.6,1))+
    theme(legend.position="bottom")+
  labs(caption="Note. For men with alcohol as the initial and primary substance. Fixed in 3 years")
}
```

<br>

```{r plot_rmst_complex_mod3, echo=T, error=T, fig.cap="Figure 21c. Predicted Interaction, Substance at admission", warning=FALSE, paged.print=TRUE, fig.align="center", dpi=320, eval=T}
rmst_total_fits_genf_obj %>%
    dplyr::mutate(time=factor(as.character(time),
                levels=c("0.25","1","3","5"), 
                labels=c("~3 months", "~1 year", "~3 years", "~5 years"))) %>%   
  dplyr::filter(Sex=="Men", Age=="Q2", `Initial Substance`=="Alcohol", time!="~3 months", time!= "~1 year") %>% 
  ggplot(aes(x=`Treatment Outcome`, y=est, color=`Primary Substance`, fill=`Primary Substance`))+
  geom_bar(aes(x=`Treatment Outcome`, y=est, color=`Primary Substance`, fill=`Primary Substance`),  stat="identity", alpha=0.7, position = "dodge", width = .9)+
  theme_bw()+
  geom_errorbar(aes(x=`Treatment Outcome`, ymin=lcl, ymax=ucl, color=`Primary Substance`, fill=`Primary Substance`), position="dodge", stat="identity", width=.9,  alpha=0.9, size=1)+
  ylab("Time to event (years)")+
  facet_wrap(~time)+
  #scale_color_manual(name ="Modality",values=c("#0E53A7","#FFB540"), labels= c("Outpatient","Residential"))+
  #scale_fill_manual(name ="Modality",values=c("#0E53A7","#FFB540"), labels= c("Outpatient","Residential"))+
  xlab("Cause of discharge")+
  coord_flip(ylim=c(2,5))+
      theme(legend.position="bottom")+
  labs(caption="Note. For men with a median age (34 years) and alcohol as the initial/starting substance")

if(no_mostrar==1){
  
surv_total_fits_genf_obj %>%
    dplyr::mutate(time=factor(as.character(time),
                levels=c("0.25","1","3","5"), 
                labels=c("~3 months", "~1 year", "~3 years", "~5 years"))) %>%
  dplyr::filter(Sex=="Men", Age=="Q2", `Initial Substance`=="Alcohol", time=="~3 years", `Treatment Outcome`%in% c("Referral to another treatment","Therapeutic discharge")) %>% 
  ggplot(aes(x=`Primary Substance`, y=est, color=`Treatment Outcome`, fill=`Treatment Outcome`))+
  geom_bar(aes(x=`Primary Substance`, y=est, color=`Treatment Outcome`, fill=`Treatment Outcome`), position="dodge", stat="identity", alpha=0.4, width=.8)+
  theme_bw()+
  geom_errorbar(aes(x=`Primary Substance`, ymin=lcl, ymax=ucl, color=`Treatment Outcome`, fill=`Treatment Outcome`), position="dodge", stat="identity", width=0.8,  alpha=0.9, size=1)+
  ylab("Survival")+
  xlab("Primary substance at admission")+
  coord_flip(ylim=c(.6,1))+
    theme(legend.position="bottom")+
  labs(caption="Note. For men with a median age (34 years) and alcohol as the initial substance. Fixed in 3 years")
}
```

<br>

```{r plot_rmst_complex_mod4, echo=T, error=T, fig.cap="Figure 21d. Predicted Interaction, Initial substance", warning=FALSE, paged.print=TRUE, fig.align="center", dpi=320, eval=T}

rmst_total_fits_genf_obj %>%
    dplyr::mutate(time=factor(as.character(time),
                levels=c("0.25","1","3","5"), 
                labels=c("~3 months", "~1 year", "~3 years", "~5 years"))) %>%
  dplyr::filter(Sex=="Men", Age=="Q2", `Primary Substance`=="Alcohol", time!="~3 months", time!= "~1 year") %>% 
  ggplot(aes(x=`Treatment Outcome`, y=est, color=`Initial Substance`, fill=`Initial Substance`))+
  geom_bar(aes(x=`Treatment Outcome`, y=est, color=`Initial Substance`, fill=`Initial Substance`), position="dodge", stat="identity", alpha=0.4, width=.8)+
  theme_bw()+
  geom_errorbar(aes(x=`Treatment Outcome`, ymin=lcl, ymax=ucl, color=`Initial Substance`, fill=`Initial Substance`), position="dodge", stat="identity", width=0.8,  alpha=0.9, size=1)+
  ylab("Time to event (years)")+
  facet_wrap(~time)+#, scales="free_y"
  #scale_color_manual(name ="Modality",values=c("#0E53A7","#FFB540"), labels= c("Outpatient","Residential"))+
  #scale_fill_manual(name ="Modality",values=c("#0E53A7","#FFB540"), labels= c("Outpatient","Residential"))+
  xlab("Cause of discharge")+
  coord_flip(ylim=c(2,5))+
    theme(legend.position="bottom")+
  labs(caption="Note. For men with a median age (34 years) and alcohol as the primary substance at admission")

if(no_mostrar==1){
  
surv_total_fits_genf_obj %>%
    dplyr::mutate(time=factor(as.character(time),
                levels=c("0.25","1","3","5"), 
                labels=c("~3 months", "~1 year", "~3 years", "~5 years"))) %>%
  dplyr::filter(Sex=="Men", Age=="Q2", `Primary Substance`=="Alcohol", time=="~3 years", `Treatment Outcome`%in% c("Referral to another treatment","Therapeutic discharge")) %>% 
  ggplot(aes(x=`Initial Substance`, y=est, color=`Treatment Outcome`, fill=`Treatment Outcome`))+
  geom_bar(aes(x=`Initial Substance`, y=est, color=`Treatment Outcome`, fill=`Treatment Outcome`), position="dodge", stat="identity", alpha=0.4, width=.8)+
  theme_bw()+
  geom_errorbar(aes(x=`Initial Substance`, ymin=lcl, ymax=ucl, color=`Treatment Outcome`, fill=`Treatment Outcome`), position="dodge", stat="identity", width=0.8,  alpha=0.9, size=1)+
  ylab("Survival")+
  xlab("Initial/Starting substance")+
  coord_flip(ylim=c(.6,1))+
    theme(legend.position="bottom")+
  labs(caption="Note. For men with a median age (34 years) and alcohol as the primary substance at admission. Fixed in 3 years")
}
```

<br>

# Labels and export

```{r change labels,echo=T, paged.print=TRUE, eval=T}
#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_  

  metadata(CONS_C1_df_dup_SEP_2020)$name <- "Agreement 1 SENDA"
  metadata(CONS_C1_df_dup_SEP_2020)$description <- "Information About Agreement 1 of SENDA and MINSAL. Contians information about treatments.(*) Intermediate events are collapsed and concatenated in some variables; Criteria to select values from entries that were collapsed into single treatments: Wide format(a),Maximum/Last value(b), Minimum/First value(c), Kept more vulnerable category(d), Same value(e), Largest treatment(f), Favored dgs.-a(g), Sum values(h). In case of 'tipo_de_plan_2','dias_treat_imp_sin_na', 'diff_bet_treat', 'cum_dias_trat_sin_na', 'mean_cum_dias_trat_sin_na' & 'cum_diff_bet_treat', the first variable, 10 variables were generated for each variable and represents each treatment of user, since the first(1) to the last(10)"

#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_  
  
codebook::var_label(CONS_C1_df_dup_SEP_2020) <- list(
row= 'Numerador de los eventos presentes en la Base de Datos (Último registro)/Events in the Dataset (Last Entry)',
row_cont_entries= 'Numerador de los eventos presentes en la Base de Datos(*)/Events in the Dataset(*)',
hash_key= 'Codificación del RUN/Masked Identifier (RUN)',
hash_rut_completo= 'HASH alternativo, en el escenario en que se asuma que el individuo al que se le codificó el RUT presente mayor edad/Alternative HASH-Key',
id= 'Codigo Identificación de SENDA/SENDAs ID',
id_mod= 'ID de SENDA para Presentación en Página Web (enmascara caracteres 5 y 6)/SENDAs ID (mask characters 5 & 6)',
fech_ing= 'Fecha de Ingreso a Tratamiento (Primera Entrada)/Date of Admission to Treatment (First Entry)',
fech_egres_imp= 'Fecha de Egreso (Imputados KNN & Lógico) del Último Registro(b)/Date of Discharge (Imputed KNN & Logic) of the Last Entry(b)',
tipo_de_plan_2= 'Tipo de Plan del Último Registro/Type of Plan of the Last Entry',
tipo_de_plan_2_largest_treat= 'Tipo de Plan del Registro Más Largo entre entradas intermedias(f)/Type of Plan of the Largest Entry Among Intermediate Entries(f)',
tipo_de_plan_2_concat_a= 'Tipo de Plan(*)/Type of Plan(*)', 
tipo_de_programa_2= 'Tipo de Programa del Registro Más Largo entre Entradas Intermedias/Type of Program of the Largest Entry Among Intermediate Entries',
id_centro= 'ID de Centro(b)/Center ID(b)',
nombre_centro= 'Nombre del Centro de Tratamiento(*)/Treatment Center(*)',
id_centro_concat_a= 'ID de Centro(*)/Center ID(*)',
tipo_centro= 'Tipo de Centro del Último Registro/Type of Center of the Last Entry',
servicio_de_salud= 'Servicio de Salud(*)/Health Service(*)',
senda= 'SENDA del Último Registro/SENDA of the Last Entry',
numero_de_hijos_mod= 'Número de Hijos (Valor Max.)/Number of Children (Max. Value)',
num_hijos_trat_res_mod= 'Número de Hijos para Ingreso a Tratamiento Residencial del Último Registro/Number of Children to Residential Treatment of the Last Entry',
tipo_centro_derivacion= 'Tipo de Centro al que el Usuario es Derivado del Último Registro(b)/Type of Center of Derivation of the Last Entry(b)',
motivodeegreso_mod_imp= 'Motivo de Egreso (con abandono temprano y tardío)(Imputados KNN & Lógico) del Último Registro(b)/Cause of Discharge (with late and early withdrawal)(Imputed KNN & Logic) of the Last Entry(b)',
macrozona= "Macrozona del Centro del Último Registro(b)/Macrozones of the Center of the Last Entry(b)",
nombre_region= "Región del Centro del Último Registro(b)/Chilean Region of the Center of the Last Entry(b)",
comuna_residencia_cod= "Comuna de Residencia del Último Registro(b)/Municipality or District of Residence of the Last Entry(b)",
fecha_ingreso_a_convenio_senda= 'Fecha de Ingreso a Convenio SENDA (aún no formateada como fecha) (Primera Entrada)/Date of Admission to SENDA Agreement (First Entry)',
identidad_de_genero= 'Identidad de Género (Último Registro)(b)/Gender Identity (Last Entry)(b)',
edad_al_ing= 'Edad a la Fecha de Ingreso a Tratamiento (numérico continuo) (Primera Entrada)/Age at Admission to Treatment (First Entry)',
origen_ingreso_mod= 'Origen de Ingreso (Primera Entrada)/Motive of Admission to Treatment (First Entry)',
x_se_trata_mujer_emb= 'Mujer Embarazada al Ingreso (d)/Pregnant at Admission (d)',
compromiso_biopsicosocial= 'Compromiso Biopsicosocial(d)/Biopsychosocial Involvement(d)',
dg_global_nec_int_soc_or= 'Diagnóstico Global de Necesidades de Integración Social (Al Ingreso)(d)/Global Diagnosis of Social Integration (At Admission)(d)',
dg_nec_int_soc_cap_hum_or= 'Diagnóstico de Necesidades de Integración Social en Capital Humano (Al Ingreso)(d)/Global Diagnosis of Social Integration in Human Capital (At Admission)(d)',
dg_nec_int_soc_cap_fis_or= 'Diagnóstico de Necesidades de Integración Social en Capital Físico (Al Ingreso)(d)/Global Diagnosis of Social Integration in Physical Capital (At Admission)(d)',
dg_nec_int_soc_cap_soc_or= 'Diagnóstico de Necesidades de Integración Social en Capital Social (Al Ingreso)(d)/Global Diagnosis of Social Integration in Social Capital (At Admission)(d)',
usuario_tribunal_trat_droga= 'Usuario de modalidad Tribunales de Tratamiento de Drogas(d)/User of Drug Treatment Courts Modality(d)',
evaluacindelprocesoteraputico= 'Evaluación del Proceso Terapéutico(d)/Evaluation of the Therapeutic Process(d)',
eva_consumo= 'Evaluación al Egreso Respecto al Patrón de consumo(d)/Evaluation at Discharge regarding to Consumption Pattern(d)',
eva_fam= 'Evaluación al Egreso Respecto a Situación Familiar(d)/Evaluation at Discharge regarding to Family Situation(d)',
eva_relinterp= 'Evaluación al Egreso Respecto a Relaciones Interpersonales(d)/Evaluation at Discharge regarding to Interpersonal Relations(d)',
eva_ocupacion= 'Evaluación al Egreso Respecto a Situación Ocupacional(d)/Evaluation at Discharge regarding to Occupational Status(d)',
eva_sm= 'Evaluación al Egreso Respecto a Salud Mental(d)/Evaluation at Discharge regarding to Mental Health(d)',
eva_fisica= 'Evaluación al Egreso Respecto a Salud Física(d)/Evaluation at Discharge regarding to Physical Health(d)',
eva_transgnorma= 'Evaluación al Egreso Respecto a Trasgresión a la Norma Social(d)/Evaluation at Discharge regarding to Transgression to the Norm(d)',
dg_global_nec_int_soc_or_1= 'Diagnóstico Global de Necesidades de Integración Social (Al Egreso)(d)/Global Diagnosis of Social Integration (At Discharge)(d)',
dg_nec_int_soc_cap_hum_or_1= 'Diagnóstico de Necesidades de Integración Social en Capital Humano (Al Egreso)(d)/Global Diagnosis of Social Integration in Human Capital (At Discharge)(d)',
dg_nec_int_soc_cap_fis_or_1= 'Diagnóstico de Necesidades de Integración Social en Capital Físico (Al Egreso)(d)/Global Diagnosis of Social Integration in Physical Capital (At Discharge)(d)',
dg_nec_int_soc_cap_soc_or_1= 'Diagnóstico de Necesidades de Integración Social en Capital Social (Al Egreso)(d)/Global Diagnosis of Social Integration in Social Capital (At Discharge)(d)',
tiene_menores_de_edad_a_cargo= 'Menores de Edad A Cargo(d)/Minor Dependants(d)',
ha_estado_embarazada_egreso= '¿Ha estado embarazada? (al Egreso)(d)/Have you been Pregnant (at Discharge)(d)',
discapacidad= 'Presenta Discapacidad(d)/Disability(d)',
opcion_discapacidad= 'Origen de Discapacidad(d)/Cause of Disability(d)',
escolaridad= 'Escolaridad: Nivel Eduacional(d)/Educational Attainment(d)',
escolaridad_rec= 'Escolaridad: Nivel Eduacional(d) Normalizado a Progresión de Tratamientos/Educational Attainment(d) & Normalized Following Progression of Treatments',
edad_al_ing_grupos= 'Edad a la Fecha de Ingreso a Tratamiento en Grupos(c)/Age at Admission to Treatment In Groups(c)',
nacionalidad= 'Nacionalidad/Nationality',
sexo_2= 'Sexo Usuario/Sex of User',
embarazo= 'Embarazo al Ingreso(c)/Pregnant at Admission(c)',
fech_nac= 'Fecha de Nacimiento/Date of Birth',
edad_ini_cons= 'Edad de Inicio de Consumo/Age of Onset of Drug Use',
edad_ini_sus_prin=  'Edad de Inicio de Consumo Sustancia Principal/Age of Onset of Drug Use of Primary Substance',
edad_ini_sus_prin_grupos=  'Edad de Inicio de Consumo Sustancia Principal (en Grupos)/Age of Onset of Drug Use of Primary Substance (in Groups)',
estado_conyugal_2= 'Estado Conyugal/Marital Status',
edad_grupos= 'Edad agrupada/Age in groups',
freq_cons_sus_prin= 'Frecuencia de Consumo de la Sustancia Principal (30 días previos a la admisión)(f)/Frequency of Consumption of the Primary or Main Substance (30 days previous to admission)(f)',
via_adm_sus_prin_act= 'Vía de Administración de la Sustancia Principal (Se aplicaron criterios de limpieza)(f)/Route of Administration of the Primary or Main Substance (Tidy)(f)',
etnia_cor= 'Etnia/Ethnic Group',
nacionalidad_2= 'Segunda Nacionalidad/Second Nationality',
etnia_cor_2= 'Etnia (2)/Second Ethnic Group',
sus_ini_2_mod= 'Segunda Sustancia de Inicio(Sólo más frecuentes)/Second Starting Substance',
sus_ini_3_mod= 'Tercera Sustancia de Inicio(Sólo más frecuentes)/Third Starting Substance',
sus_ini_mod= "Sustancia de Inicio (Sólo más frecuentes)/Starting Substance (Only more frequent)",
con_quien_vive= 'Persona con la que vive el Usuario(f)/People that Share Household with the User (Cohabitation Status)(f)',
con_quien_vive_rec= 'Persona con la que vive el Usuario (Recodificada)(f)/People that Share Household with the User (Cohabitation Status)(Recoded)(f)',
estatus_ocupacional= 'Condición Ocupacional(f)/Occupational Status(f)',
estatus_ocupacional_rec= 'Condición Ocupacional, corregido por categoría(f)/Occupational Status, corrected for categories(f)',
cat_ocupacional= 'Categoría Ocupacional(f)/Occupational Category(f)',
sus_principal_mod= 'Sustancia Principal de Consumo (Sólo más frecuentes)(f)/Primary or Main Substance of Consumption at Admission (Only more frequent)(f)',
tipo_de_vivienda_mod= 'Tipo de Vivienda(f)/Type of Housing(f)', 
tenencia_de_la_vivienda_mod= 'Tenencia de la Vivienda(f)/Tenure status of Households(f)',
rubro_trabaja_mod= 'Rubro de Trabajo(f)/Area of Work(f)',
otras_sus1_mod= 'Otras Sustancias (1)(Sólo más frecuentes)(f)/Other Substances (1)(Only more frequent)(f)',
otras_sus2_mod= 'Otras Sustancias (2)(Sólo más frecuentes)(f)/Other Substances (2)(Only more frequent)(f)',
otras_sus3_mod= 'Otras Sustancias (3)(Sólo más frecuentes)(f)/Other Substances (3)(Only more frequent)(f)',
dg_trs_cons_sus_or= 'Diagnósico de Trastorno por Consumo de Sustancias(d)/Diagnosed of Substance Use Disorder(d)',
dg_trs_psiq_dsm_iv_or= 'Diagnóstico de Trastorno Psiquiátrico, Criterios DSM IV(g)/Diagnosis of Psychiatric Disorders, DSM-IV criteria(g)',
dg_trs_psiq_sub_dsm_iv_or= 'Diagnóstico de Trastorno Psiquiátrico, Criterios DSM IV (Subclasificacion)(g)/Diagnosis of Psychiatric Disorders, DSM-IV criteria (sub-classification)(g)',
x2_dg_trs_psiq_dsm_iv_or= 'Diagnóstico de Trastorno Psiquiátrico, Criterios DSM IV (2)(g)/Diagnosis of Psychiatric Disorders, DSM-IV criteria (2)(g)',
x2_dg_trs_psiq_sub_dsm_iv_or= 'Diagnóstico de Trastorno Psiquiátrico, Criterios DSM IV (Subclasificacion) (2)(g)/Diagnosis of Psychiatric Disorders, DSM-IV criteria (sub-classification) (2)(g)',
x3_dg_trs_psiq_dsm_iv_or= 'Diagnóstico de Trastorno Psiquiátrico, Criterios DSM IV (3)(g)/Diagnosis of Psychiatric Disorders, DSM-IV criteria (3)(g)',
x3_dg_trs_psiq_sub_dsm_iv_or= 'Diagnóstico de Trastorno Psiquiátrico, Criterios DSM IV (Subclasificacion) (3)(g)/Diagnosis of Psychiatric Disorders, DSM-IV criteria (sub-classification) (3)(g)',
dg_trs_psiq_cie_10_or= 'Diagnóstico de Trastorno Psiquiátrico, Criterios CIE-10(g)/Diagnosis of Psychiatric Disorders, CIE-10 criteria(g)',
dg_trs_psiq_sub_cie_10_or= 'Diagnóstico de Trastorno Psiquiátrico, Criterios CIE-10 (Subclasificacion)(g)/Diagnosis of Psychiatric Disorders, CIE-10 criteria (subclassification)(g)',
x2_dg_trs_psiq_cie_10_or= 'Diagnóstico de Trastorno Psiquiátrico, Criterios CIE-10 (2)(g)/Diagnosis of Psychiatric Disorders, CIE-10 criteria (2)(g)',
x2_dg_trs_psiq_sub_cie_10_or= 'Diagnóstico de Trastorno Psiquiátrico, Criterios CIE-10 (Subclasificacion) (2)(g)/Diagnosis of Psychiatric Disorders, CIE-10 criteria (subclassification) (2)(g)',
x3_dg_trs_psiq_cie_10_or= 'Diagnóstico de Trastorno Psiquiátrico, Criterios CIE-10 (3)(g)/Diagnosis of Psychiatric Disorders, CIE-10 criteria (3)(g)',
x3_dg_trs_psiq_sub_cie_10_or= 'Diagnóstico de Trastorno Psiquiátrico, Criterios CIE-10 (Subclasificacion) (3)(g)/Diagnosis of Psychiatric Disorders, CIE-10 criteria (subclassification) (3)(g)',
diagnostico_trs_fisico= 'Diagnóstico de Trastorno Físico(g)/Diagnosis of Physical Disorder(g)',
otros_probl_at_sm_or= 'Otros Problemas de Atención Vinculados a Salud Mental(g)/Other problems linked to Mental Health(g)',
x4_dg_trs_psiq_dsm_iv_or= 'Diagnóstico de Trastorno Psiquiátrico, Criterios DSM IV (4)(g)/Diagnosis of Psychiatric Disorders, DSM-IV criteria (4)(g)',
x4_dg_trs_psiq_sub_dsm_iv_or= 'Diagnóstico de Trastorno Psiquiátrico, Criterios DSM IV (Subclasificacion)(4)(g)/Diagnosis of Psychiatric Disorders, DSM-IV criteria (sub-classification)(4)(g)',
x4_dg_trs_psiq_cie_10_or= 'Diagnóstico de Trastorno Psiquiátrico, Criterios CIE-10 (4)(g)/Diagnosis of Psychiatric Disorders, CIE-10 criteria (4)(g)',
x5_dg_trs_psiq_cie_10_or= 'Diagnóstico de Trastorno Psiquiátrico, Criterios CIE-10 (5)(g)/Diagnosis of Psychiatric Disorders, CIE-10 criteria (5)(g)',
x4_dg_trs_psiq_sub_cie_10_or= 'Diagnóstico de Trastorno Psiquiátrico, Criterios CIE-10 (Subclasificacion)(4)(g)/Diagnosis of Psychiatric Disorders, CIE-10 criteria (subclassification)(4)(g)',
ano_bd_first= 'Año de la Base de Datos(c)/Year of the Dataset (Source)(c)',
ano_bd_last= 'Año de la Base de Datos(b)/Year of the Dataset (Source)(b)',
obs= 'Observaciones al Proceso de Limpieza y Estandarización de Casos(e)/Observations to the Process of Data Tidying & Standardization(e)',
obs_concat_a= 'Observaciones al Proceso de Limpieza y Estandarización de Casos(*)/Observations to the Process of Data Tidying & Standardization(*)',
rn_common_treats2= 'Cuenta de Entradas Comunes(b)/Count of Common Entries(b)',
concat_hash_id_treatments='Combination of User & Distint Entries',
at_least_one_cont_entry= "Casos de Usuarios con más de una entrada después de otra/Cases of users with more than one entry after another one",
senda_concat_a= 'SENDA(*)/SENDA(*)',
tipo_centro_concat_a= 'Tipo de Centro(*)/Type of Center(*)',
fech_ing_num= 'Fecha de Ingreso a Tratamiento (Numérico)(c)/Date of Admission to Treatment (Numeric)(c)',
fech_egres_num= 'Fecha de Egreso (Imputados KNN & Lógico)(Numérico)(b)/Date of Discharge (Imputed KNN & Logic)(Numeric)(b) of the Next Treatment',
fech_ing_next_treat= 'Fecha de Ingreso a Tratamiento (Numérico)(c) del Tratamiento Posterior/Date of Admission to Treatment (Numeric)(c)',
diff_bet_treat= 'Días de diferencia con el Tratamiento Posterior/Days of difference between the Next Treatment',
id_centro_sig_trat= "ID del Centro del Tratamiento Posterior/Center ID of the Next Treatment",
tipo_plan_sig_trat= "Tipo de Plan del Tratamiento Posterior/Type of Plan of the Next Treatment",
tipo_programa_sig_trat= "Tipo de Programa del Tratamiento Posterior/Type of Program of the Next Treatment", 
senda_sig_trat= "SENDA del Tratamiento Posterior/SENDA of the Next Treatment",
menor_60_dias_diff= 'Menor a 60 días de diferencia con el Tratamiento Posterior/Menor a 60 days of difference between the Next Treatment',
menor_45_dias_diff= 'Menor a 45 días de diferencia con el Tratamiento Posterior/Less than 45 days of difference between the Next Treatment',
motivoegreso_derivacion= "Motivo de Egreso= Derivación(b)/Cause of Discharge= Derivación(b)",
dias_treat_imp_sin_na= 'Días de Tratamiento (valores perdidos en la fecha de egreso se reemplazaron por la diferencia con 2019-11-13)/Days of Treatment (missing dates of discharge were replaced with difference from 2019-11-13)',
obs_cambios= "Cambios del tratamiento en comparación al Tratamiento Posterior/Changes in treatment compared to the Next Treatment",
obs_cambios_ninguno= "Sin cambios del tratamiento en comparación al Tratamiento Posterior/No changes in treatment compared to the Next Treatment",
obs_cambios_num= "Recuento de cambios del tratamiento en comparación al Tratamiento Posterior/Count of changes in treatment compared to the Next Treatment",
obs_cambios_fac= "Recuento de cambios del tratamiento en comparación al Tratamiento Posterior(factor)/Count of changes in treatment compared to the Next Treatment(factor)",
hash_key_sex_program= 'Usuarios a los que se le ha cambiado el sexo de acuerdo al tipo de plan/Users that changed of sex considering the types of plan',
centro_muj= 'ID de centro que alude a un centro específico para mujeres/Center ID aludes to a women-specific center',
dsm_iv= 'Diagnóstico DSM-IV (1 o más)/Psychiatric Diagnoses (DSM-IV)(one or more)',
cie_10= 'Diagnóstico CIE-10 (1 o más)/Psychiatric Diagnoses (ICD-10)(one or more)',
abandono_temprano= 'Abandono temprano(<3 meses)/ Early Drop-out(<3 months)',
cnt_mod_dsm_iv_or= 'Recuento de Valores en Diagnóstico DSM-IV (Excluye en Estudio si hay más de uno)/Count of Values in Psychiatric Diagnoses (DSM-IV)',
cnt_mod_cie_10_or= 'Recuento de Valores en Diagnóstico CIE-10 (Excluye en Estudio si hay más de uno)/Count of Values in Psychiatric Diagnoses (ICD-10)',
cnt_diagnostico_trs_fisico= 'Recuento de Diagnóstico de Trastorno Físico/Count of Physical Disorder',
cnt_otros_probl_at_sm_or= 'Recuento de Otros Problemas de Atención Vinculados a Salud Mental/Count of Other problems linked to Mental Health',
cum_dias_trat_sin_na= 'Suma acumulada de Días de Tratamiento por Usuario/Cumulative Days of Treatment by User',
mean_cum_dias_trat_sin_na= 'Promedio acumulado de Días de Tratamiento por Usuario/Cumulative Average Days of Treatment by User',
cum_diff_bet_treat= 'Suma acumulada de Diferencia en Días con Tratamiento Siguiente por Usuario/Cumulative sum of Days of difference between the Next Treatment by User',
mean_cum_diff_bet_treat= 'Promedio acumulado de Diferencia en Días entre Tratamientos por Usuario/Cumulative Average Days of Differences Between Treatments By User',
rn_hash= 'Número de Tratamientos por Usuario (menor, tratamiento más antiguo)/Number of Treatments by User (less, older treatment)',
n_hash= 'Número total de Tratamientos por Usuario/Total Number of Treatments by User',

dup= "Número de Tratamientos por HASH (posición a medida que aparecen, menor más antiguo)/Number of Treatments by User",
duplicates_filtered= "Número de Tratamientos por HASH (Total)/Number of Treatments by User (Total)",
startdate= "Fecha de Ingreso Primer Tratamiento (x HASH)/Date of Admission to the First Treatment (By User)",
enddate=  "Fecha de Egreso del Último Tratamiento (x HASH)/Date of Discharge of the Last Treatment (By User)",
person_days= "Días en los que estado un usuario en el sistema para el estudio/User's Days available in the system for the study",
a_botar = "Descarta tratamientos posteriores por usuario(Perdidos= Trat Posteriores)/Discard posterior treatments by each user (Missing= Posterior Treatments)",
event= "Usuarios con Tratamiento Posterior (1=Reingreso x HASH)/Users with Posterior Treatments (1=Readmission)",
person_years= "Años en los que estado un usuario en el sistema para el estudio/User's Years available in the system for the study",

dg_cie_10_rec= 'Diagnóstico CIE-10 (1 o más)(Recodificado)/Psychiatric Diagnoses (ICD-10)(one or more)(Recoded)',
dg_dsm_iv_rec= 'Diagnóstico DSM-IV (1 o más)(Recodificado)/Psychiatric Diagnoses (DSM-IV)(one or more)(Recoded)',
dg_fis_anemia= "Dignóstico Físico, Anemia/Physical Dg. Anemia",
dg_fis_card= "Dignóstico Físico, Enfermedad Cardiaca/Physical Dg. Heart Disease",
dg_fis_in_study= "Dignóstico Físico, En estudio/Physical Dg. Under Study",
dg_fis_enf_som= "Dignóstico Físico, /Physical Dg. Somatic illnesses",
dg_fis_ets= "Dignóstico Físico, ETSs/Physical Dg. STDs",
dg_fis_hep_alc= "Dignóstico Físico, Hepatitis Alcohólica Subaguda/Physical Dg. Alcoholic hepatitis",
dg_fis_hep_b= "Dignóstico Físico, Hepatitis B, C, D/Physical Dg. Hepatitis B, C, D",
dg_fis_hep_cro= "Dignóstico Físico, Hepatitis Crónica/Physical Dg. Chronic hepatitis",
dg_fis_inf= "Dignóstico Físico, Enfermedades Infeccisas Rel. con Consumo/Physical Dg. Infectuous diseases related to SUDs",
dg_fis_otr_cond_fis_ries_vit= "Dignóstico Físico, Otras condiciones de riesgo vital/Physical Dg. Other phsysical conditions of vital risk",
dg_fis_otr_cond_fis= "Dignóstico Físico, Otras condiciones limitantes/Physical Dg. Other phsysical limitations",
dg_fis_pat_buc= "Dignóstico Físico, Patología Bucal/Physical Dg. Oral-care pathologies",
dg_fis_pat_ges_intrau= "Dignóstico Físico, Patología de la gestión y del niño intrauterino/Physical Dg. Development or Intrauterine",
dg_fis_trau_sec= "Dignóstico Físico, Traumatismos y secuelas secundarias/Physical Dg. Traumatisms and disabling sequelae",

otros_pr_sm_abu_sex= "Otros problemas de Atención de Salud Mental, Abuso Sexual/Other mental health problems, Sexual abuse",
otros_pr_sm_exp_com_sex= "Otros problemas de Atención de Salud Mental, Explotación Sexual Comercial/Other mental health problems, Commercial sexual exploitation",
otros_pr_sm_otros= "Otros problemas de Atención de Salud Mental, Otros/Other mental health problems, Other",

otros_pr_sm_vif= "Otros problemas de Atención de Salud Mental, Violencia Intrafamiliar/Other mental health problems, Domestic violence",

sus_ini_mod_mvv= "Sustancia de Inicio (Valor más vulnerable)/Starting Substance (Most vulnerable value)",
hijos_trat_res= "Tiene Hijos en Ingreso a Tratamiento Residencial del Último Registro/Have Children in Residential Treatment of the Last Entry",
dg_total_cie_10= "Conteo de Diagnósticos CIE-10(sólo diagnósticos)/Count of ICD-10 Diagnostics(only diagnoses)",
dg_total_dsm_iv= "Conteo de Diagnósticos DSM-IV(sólo diagnósticos)/Count of DSM-IV Diagnostics(only diagnoses)",

condicion_ocupacional_corr= 'Condición Ocupacional Criterio Corregido(f)/Occupational Status Corrected(f)',
cat_ocupacional_corr= 'Categoría Ocupacional Criterio Corregido(f)/Occupational Category Corrected(f)',
#2022
dias_trat_alta_temprana= 'Si el tratamiento duró 90 días o más (1= <90d)/If the treatment lasted 90 days or more (1= Less than 90d)',

tipo_de_plan_2_1= 'Tipo de Plan del Último Registro/Type of Plan of the Last Entry (1st Treatment)',
tipo_de_plan_2_2= 'Tipo de Plan del Último Registro/Type of Plan of the Last Entry (2nd Treatment)',
tipo_de_plan_2_3= 'Tipo de Plan del Último Registro/Type of Plan of the Last Entry (3rd Treatment)',
tipo_de_plan_2_4= 'Tipo de Plan del Último Registro/Type of Plan of the Last Entry (4th Treatment)',
tipo_de_plan_2_5= 'Tipo de Plan del Último Registro/Type of Plan of the Last Entry (5th Treatment)',
tipo_de_plan_2_6= 'Tipo de Plan del Último Registro/Type of Plan of the Last Entry (6th Treatment)',
tipo_de_plan_2_7= 'Tipo de Plan del Último Registro/Type of Plan of the Last Entry (7th Treatment)',
tipo_de_plan_2_8= 'Tipo de Plan del Último Registro/Type of Plan of the Last Entry (8th Treatment)',
tipo_de_plan_2_9= 'Tipo de Plan del Último Registro/Type of Plan of the Last Entry (9th Treatment)',
tipo_de_plan_2_10= 'Tipo de Plan del Último Registro/Type of Plan of the Last Entry (10th Treatment)',

motivodeegreso_mod_imp_1= 'Cause of Discharge (with late and early withdrawal)(Imputed KNN & Logic) of the Last Entry(b) (1st Treatment)',
motivodeegreso_mod_imp_2= 'Cause of Discharge (with late and early withdrawal)(Imputed KNN & Logic) of the Last Entry(b) (2nd Treatment)', 
motivodeegreso_mod_imp_3= 'Cause of Discharge (with late and early withdrawal)(Imputed KNN & Logic) of the Last Entry(b) (3th Treatment)',
motivodeegreso_mod_imp_4= 'Cause of Discharge (with late and early withdrawal)(Imputed KNN & Logic) of the Last Entry(b) (4th Treatment)',
motivodeegreso_mod_imp_5= 'Cause of Discharge (with late and early withdrawal)(Imputed KNN & Logic) of the Last Entry(b) (5th Treatment)',
motivodeegreso_mod_imp_6= 'Cause of Discharge (with late and early withdrawal)(Imputed KNN & Logic) of the Last Entry(b) (6th Treatment)',
motivodeegreso_mod_imp_7= 'Cause of Discharge (with late and early withdrawal)(Imputed KNN & Logic) of the Last Entry(b) (7th Treatment)',
motivodeegreso_mod_imp_8= 'Cause of Discharge (with late and early withdrawal)(Imputed KNN & Logic) of the Last Entry(b) (8th Treatment)',
motivodeegreso_mod_imp_9= 'Cause of Discharge (with late and early withdrawal)(Imputed KNN & Logic) of the Last Entry(b) (9th Treatment)',
motivodeegreso_mod_imp_10= 'Cause of Discharge (with late and early withdrawal)(Imputed KNN & Logic) of the Last Entry(b) (10th Treatment)',

dias_treat_imp_sin_na_1= "Days of Treatment (1st Treatment)",
dias_treat_imp_sin_na_2= "Days of Treatment (2nd Treatment)",
dias_treat_imp_sin_na_3= "Days of Treatment (3rd Treatment)",
dias_treat_imp_sin_na_4= "Days of Treatment (4th Treatment)",
dias_treat_imp_sin_na_5= "Days of Treatment (5th Treatment)",
dias_treat_imp_sin_na_6= "Days of Treatment (6th Treatment)",
dias_treat_imp_sin_na_7= "Days of Treatment (7th Treatment)",
dias_treat_imp_sin_na_8= "Days of Treatment (8th Treatment)",
dias_treat_imp_sin_na_9= "Days of Treatment (9th Treatment)",
dias_treat_imp_sin_na_10="Days of Treatment (10th Treatment)",

diff_bet_treat_1= "Diff Between Treatments (1st Treatment)",
diff_bet_treat_2= "Diff Between Treatments (2nd Treatment)",
diff_bet_treat_3= "Diff Between Treatments (3rd Treatment)",
diff_bet_treat_4= "Diff Between Treatments (4th Treatment)",
diff_bet_treat_5= "Diff Between Treatments (5th Treatment)",
diff_bet_treat_6= "Diff Between Treatments (6th Treatment)",
diff_bet_treat_7= "Diff Between Treatments (7th Treatment)",
diff_bet_treat_8= "Diff Between Treatments (8th Treatment)",
diff_bet_treat_9= "Diff Between Treatments (9th Treatment)",
diff_bet_treat_10="Diff Between Treatments (10th Treatment)",

cum_dias_trat_sin_na_1= "Cum. Days of Treatment (1st Treatment)",
cum_dias_trat_sin_na_2= "Cum. Days of Treatment (2nd Treatment)",
cum_dias_trat_sin_na_3= "Cum. Days of Treatment (3rd Treatment)",
cum_dias_trat_sin_na_4= "Cum. Days of Treatment (4th Treatment)",
cum_dias_trat_sin_na_5= "Cum. Days of Treatment (5th Treatment)",
cum_dias_trat_sin_na_6= "Cum. Days of Treatment (6th Treatment)",
cum_dias_trat_sin_na_7= "Cum. Days of Treatment (7th Treatment)",
cum_dias_trat_sin_na_8= "Cum. Days of Treatment (8th Treatment)",
cum_dias_trat_sin_na_9= "Cum. Days of Treatment (9th Treatment)",
cum_dias_trat_sin_na_10="Cum. Days of Treatment (10th Treatment)",

mean_cum_dias_trat_sin_na_1= "Avg. Cum. Days of Treatment (1st Treatment)",
mean_cum_dias_trat_sin_na_2= "Avg. Cum. Days of Treatment (2nd Treatment)",
mean_cum_dias_trat_sin_na_3= "Avg. Cum. Days of Treatment (3rd Treatment)",
mean_cum_dias_trat_sin_na_4= "Avg. Cum. Days of Treatment (4th Treatment)",
mean_cum_dias_trat_sin_na_5= "Avg. Cum. Days of Treatment (5th Treatment)",
mean_cum_dias_trat_sin_na_6= "Avg. Cum. Days of Treatment (6th Treatment)",
mean_cum_dias_trat_sin_na_7= "Avg. Cum. Days of Treatment (7th Treatment)",
mean_cum_dias_trat_sin_na_8= "Avg. Cum. Days of Treatment (8th Treatment)",
mean_cum_dias_trat_sin_na_9= "Avg. Cum. Days of Treatment (9th Treatment)",
mean_cum_dias_trat_sin_na_10="Avg. Cum. Days of Treatment (10th Treatment)",

cum_diff_bet_treat_1= "Cum. Diff Between Treatments (1st Treatment)",
cum_diff_bet_treat_2= "Cum. Diff Between Treatments (2nd Treatment)",
cum_diff_bet_treat_3= "Cum. Diff Between Treatments (3rd Treatment)",
cum_diff_bet_treat_4= "Cum. Diff Between Treatments (4th Treatment)",
cum_diff_bet_treat_5= "Cum. Diff Between Treatments (5th Treatment)",
cum_diff_bet_treat_6= "Cum. Diff Between Treatments (6th Treatment)",
cum_diff_bet_treat_7= "Cum. Diff Between Treatments (7th Treatment)",
cum_diff_bet_treat_8= "Cum. Diff Between Treatments (8th Treatment)",
cum_diff_bet_treat_9= "Cum. Diff Between Treatments (9th Treatment)",
cum_diff_bet_treat_10="Cum. Diff Between Treatments (10th Treatment)",

mean_cum_diff_bet_treat_1= "Avg. Cum. Diff Between Treatments (1st Treatment)",
mean_cum_diff_bet_treat_2= "Avg. Cum. Diff Between Treatments (2nd Treatment)",
mean_cum_diff_bet_treat_3= "Avg. Cum. Diff Between Treatments (3rd Treatment)",
mean_cum_diff_bet_treat_4= "Avg. Cum. Diff Between Treatments (4th Treatment)",
mean_cum_diff_bet_treat_5= "Avg. Cum. Diff Between Treatments (5th Treatment)",
mean_cum_diff_bet_treat_6= "Avg. Cum. Diff Between Treatments (6th Treatment)",
mean_cum_diff_bet_treat_7= "Avg. Cum. Diff Between Treatments (7th Treatment)",
mean_cum_diff_bet_treat_8= "Avg. Cum. Diff Between Treatments (8th Treatment)",
mean_cum_diff_bet_treat_9= "Avg. Cum. Diff Between Treatments (9th Treatment)",
mean_cum_diff_bet_treat_10="Avg. Cum. Diff Between Treatments (10th Treatment)"
)

#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_


# CONS_C1_df_dup_SEP_2020%>%
#   dplyr::arrange(hash_key, fech_ing)%>% 
#   rio::export(file = paste0(gsub("SUD_CL/Desc_2021.Rmd","",path),"CONS_C1_df_dup_SEP_2020_2021.dta"))

#2022
time_after_desc<-Sys.time()

paste0("Time in markdown: ");time_after_desc-time_before_desc

CONS_C1_df_dup_SEP_2020%>%
   dplyr::arrange(hash_key, fech_ing)%>% 
   rio::export(file = paste0(path,"/CONS_C1_df_dup_SEP_2020_2021.dta"))

#save.image(paste0(gsub("SUD_CL/Desc_2021.Rmd","",path),"9_2021.RData"))

save.image(paste0(path,"/8_2021.RData"))

#Agregar nuevas variables al codebook
#hacer codebook
#Agregar procesos a strobe
#Poner olr y arriba pondría los otros modelos.
```

```{r label_to_stata, echo=T, paged.print=TRUE}
export_lab_stata<-
  tibble::rownames_to_column(data.frame(Hmisc::label(CONS_C1_df_dup_SEP_2020)))%>% data.frame() %>%
  dplyr::rename("code" = !!names(.[1]), "label" = !!names(.[2]))%>% data.frame()%>%
  dplyr::mutate(first= "cap noi label variable")%>%
  dplyr::mutate(final= paste0(first, " ",code,' "',label,'"'))%>%
  dplyr::select(-code,-label,-first)%>%
  dplyr::rename("*clear all"="final") %>% 
  rbind(paste0('cap noi save "', gsub('/', '\\', path, fixed=T),'\\CONS_C1_df_dup_SEP_2020_2021.dta", replace'))%>%
  rbind('cap noi drop id id_mod nombre_centro consentimiento_informado')%>%
  rbind('*cap noi drop id id_mod nombre_centro')%>%
  rbind(paste0('cap noi save "', gsub('/', '\\', path, fixed=T),'\\CONS_C1_df_dup_SEP_2020_2021_exp.dta", replace'))

rbind(paste0('cap noi use "', gsub('/', '\\', path, fixed=T),'\\CONS_C1_df_dup_SEP_2020_2021.dta", clear'),export_lab_stata) %>% knitr::kable("html") %>% 
    kableExtra::kable_styling(bootstrap_options = c("striped", "hover"),font_size =10) %>% 
  kableExtra::scroll_box(width = "100%", height = "375px")

write.table(rbind(paste0('cap noi use "', gsub('/', '\\', path, fixed=T),'\\CONS_C1_df_dup_SEP_2020_2021.dta", clear'),export_lab_stata), file = paste0(path,"/SUD_CL/_label_var_to_stata.do"), sep = "",row.names = FALSE, quote = FALSE, fileEncoding="UTF-8")
```

<br>

<div style="border: 1px solid #ddd; padding: 5px; overflow-y: scroll; height:350px; overflow-x: scroll; width:100%">

```{stata 2, collectcode=F, include=T, error=T, cleanlog=F}
cap noi do _label_var_to_stata.do
```

</div>

<br>

---

# Session Info

```{r session_info, echo=T, paged.print=TRUE}
sessionInfo()
```

