---
title: "Readmission risk among women in women-only versus mixed gender treatment programs for substance use disorder in Chile (4th step)"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  html_document:
    code_folding: hide  
    toc: true # table of content true
    toc_depth: 5  # upto three depths of headings (specified by #, ## and ###)
    toc_float: true
---

```{css zoom-lib-src, echo = FALSE}
script src = "https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"
```

```{js zoom-jquery, echo = FALSE}
 $(document).ready(function() {
    $('body').prepend('<div class=\"zoomDiv\"><img src=\"\" class=\"zoomImg\"></div>');
    // onClick function for all plots (img's)
    $('img:not(.zoomImg)').click(function() {
      $('.zoomImg').attr('src', $(this).attr('src')).css({width: '100%'});
      $('.zoomDiv').css({opacity: '1', width: 'auto', border: '1px solid white', borderRadius: '5px', position: 'fixed', top: '50%', left: '50%', marginRight: '-50%', transform: 'translate(-50%, -50%)', boxShadow: '0px 0px 50px #888888', zIndex: '50', overflow: 'auto', maxHeight: '100%'});
    });
    // onClick function for zoomImg
    $('img.zoomImg').click(function() {
      $('.zoomDiv').css({opacity: '0', width: '0%'}); 
    });
  });
```

```{=html}
<style type="text/css">
.tablelines table, .tablelines td, .tablelines th {
        border: 1px solid black;
        }
.centrado {
    text-align: center;
}
.table.center {
    margin-left:auto; 
    margin-right:auto;
  }
.table_wrapper{
    display: block;
    overflow-x: auto;
    white-space: nowrap;
}
code.r{
  font-size: 8px;
}
body{ /* Normal  */
      text-align: justify;
  }
.superbigimage{
    overflow-y:scroll;
    white-space: nowrap;
}
.superbigimage img{
    overflow-y: scroll;
    overflow-x: hidden;
}
</style>
```
```{=html}
<style>
div.blue { background-color:#e6f0ff; border-radius: 5px; padding: 20px; text-align: justify;}
</style>
```
```{r prev_setup, include = FALSE, cache=T}
rm(list=ls());gc()
if(!grepl("4.0.2",R.version.string)){stop("Different version (must be 4.0.2)")}
path<-rstudioapi::getSourceEditorContext()$path
#load("E:/Mi unidad/Alvacast/SISTRAT 2019 (github)/mult_state_carla.RData")
if (grepl("CISS Fondecyt",path)==T){
  
    setwd("C:/Users/CISS Fondecyt/Mi unidad/Alvacast/SISTRAT 2019 (github)/SUD_CL/");load("C:/Users/CISS Fondecyt/Mi unidad/Alvacast/SISTRAT 2019 (github)/mult_state_carla_3.RData")
  } else if (grepl("andre",path)==T){
    setwd('C:/Users/andre/Desktop/SUD_CL/');load("E:/Mi unidad/Alvacast/SISTRAT 2019 (github)/mult_state_carla_3.RData")
  } else if (grepl("E:",path)==T){
    setwd("E:/Mi unidad/Alvacast/SISTRAT 2019 (github)/SUD_CL/");load("E:/Mi unidad/Alvacast/SISTRAT 2019 (github)/mult_state_carla_3.RData")
  } else {
    setwd("G:/Mi unidad/Alvacast/SISTRAT 2019 (github)/SUD_CL/");load("G:/Mi unidad/Alvacast/SISTRAT 2019 (github)/mult_state_carla_3.RData")
  }
```

```{r setup, include = FALSE, cache=T}
#Libraries used in the routine. Dont change the order
local({r <- getOption("repos")
       r["CRAN"] <- "http://cran.r-project.org" 
       options(repos=r)
})

#packageVersion("codebook")
#https://github.com/RevolutionAnalytics/checkpoint
#if(!require(checkpoint)){install.packages("checkpoint")}
#if(!require(here)){install.packages("here")}
#checkpoint::checkpoint("2020-02-19",project=here::here(),checkpointLocation=paste0(here::here(),"/dedup"), use.lock=F, use.knitr=T, auto.install.knitr = T,scan.rnw.with.knitr=T, forceInstall=T,scanForPackages = TRUE)
#checkpointArchives(tempdir(), full.names = TRUE)

try(library(boot))
library(matrixStats)
library(knitr)
library(tidyr)
library(stringi)
library(stringr)
library(ggplot2)
library(Hmisc)
library(kableExtra)
library(plotly)
library(janitor)
library(rbokeh)
library(zoo)
library(broom)
library(sqldf)
library(devtools)
library(codebook)
library(data.table)
library(panelr)
library(RColorBrewer)
library(lsmeans)
library(finalfit)
suppressPackageStartupMessages(library(ggiraph))
suppressPackageStartupMessages(library(sf))
library(treemapify)
library(dplyr)
library(tidyverse)
library(epiR)
library(survminer)
library(ggfortify)
library(survMisc)

library(foreign)
library(Hmisc)
library(gridExtra)
library(reshape2)
library(stargazer)
library(tableone)
library(MatchIt)
library(cobalt)
library(eha)
library(igraph)
library(Amelia)
library(DiagrammeR) 
library(mstate)
library(flexsurv)
library(muhaz)
library(Metrics)

library(ggpubr)
library(gridExtra)
library(grid)
#library(mstateutils)
#remotes::install_github("chjackson/flexsurv-dev", upgrade = "never")
#devtools::install_github("stulacy/multistateutils", build_vignettes=TRUE, upgrade = "never")
#devtools::install_github("hputter/mstate", upgrade = "never")
#unlink("C:/Users/CISS Fondecyt/OneDrive/Documentos/R/win-library/4.0/mstate", recursive=T, force=T)

if(!require(radiant.update)){install.packages("radiant.update", repos = "https://radiant-rstats.github.io/minicran/")}
#install.packages( repos = "https://radiant-rstats.github.io/minicran/")
#install.packages("radiant.update", repos = "https://radiant-rstats.github.io/minicran/")

#tryCatch(source("https://raw.githubusercontent.com/radiant-rstats/minicran/gh-pages/update.R"), error = function(e) print("updated package, radiant"))

#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:
#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:
#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:

try_with_time_limit <- function(expr, cpu = Inf, elapsed = Inf)
{
  y <- try({setTimeLimit(cpu, elapsed); expr}, silent = TRUE) 
  if(inherits(y, "try-error")) NULL else y 
}
eval_fork <- function(..., timeout=60){

  #this limit must always be higher than the timeout on the fork!
  setTimeLimit(timeout+5);      

  #dispatch based on method
  ##NOTE!!!!! Due to a bug in mcparallel, we cannot use silent=TRUE for now.
  myfork <- parallel::mcparallel({
    eval(...)
  }, silent=FALSE);

  #wait max n seconds for a result.
  myresult <- parallel::mccollect(myfork, wait=FALSE, timeout=timeout);

  #try to avoid bug/race condition where mccollect returns null without waiting full timeout.
  #see https://github.com/jeroenooms/opencpu/issues/131
  #waits for max another 2 seconds if proc looks dead 
  while(is.null(myresult) && totaltime < timeout && totaltime < 2) {
     Sys.sleep(.1)
     enddtime <- Sys.time();
     totaltime <- as.numeric(enddtime - starttime, units="secs")
     myresult <- parallel::mccollect(myfork, wait = FALSE, timeout = timeout);
  }

  #kill fork after collect has returned
  tools::pskill(myfork$pid, tools::SIGKILL);    
  tools::pskill(-1 * myfork$pid, tools::SIGKILL);  

  #clean up:
  parallel::mccollect(myfork, wait=FALSE);

  #timeout?
  if(is.null(myresult)){
    stop("R call did not return within ", timeout, " seconds. Terminating process.", call.=FALSE);      
  }

  #move this to distinguish between timeout and NULL returns
  myresult <- myresult[[1]];

  #reset timer
  setTimeLimit();     

  #forks don't throw errors themselves
  if(inherits(myresult,"try-error")){
    #stop(myresult, call.=FALSE);
    stop(attr(myresult, "condition"));
  }

  #send the buffered response
  return(myresult);  
}

if(isTRUE(getOption('knitr.in.progress'))==T){
    n_iter=10000
} else {
n_iter=20
}
#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:
#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:

#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:
#GET LOCAL
#dir.create(paste0(getwd(),"/renv_local"))
#Sys.setenv(RENV_PATHS_LOCAL = paste0(getwd(),"/renv_local"))
#install.packages(paste0(getwd(),"/renv_local/gurobi_9.1-0.zip"), repos = NULL, type="source")
#install.packages(paste0("G:/Mi unidad/Alvacast/SISTRAT 2019 (github)/renv_local/gurobi_9.1-0.zip"), repos = NULL, type="source")
#"G:/Mi unidad/Alvacast/SISTRAT 2019 (github)"
#Sys.getenv("R_LIBS_USER")
```

<br>

# Partitioned Survival Analyses


```{r fit2b_4s, eval=T, echo=T, fig.cap="Figure 1. Vissual Assessment of Survival curves, Four-states Model (w/o covars)", fig.height= 17, fig.width= 10, paged.print=TRUE, fig.align="center", dpi=320, error= T, warnings= F}
`%>%`<-magrittr::`%>%`

transition_label_4s<- c(`1`="Transition 1: Admission to Treatment completion",`2`="Transition 2: Admission to Discharge without completion",`3`="Transition 3: Admission to Readmission",`4`="Transition 4: Treatment completion to Readmission", `5`="Transition 5: Discharge without completion to Readmission")

layout(matrix(1:6, nc = 2, byrow = F))
for (i in 1:n_trans2){
plot(km.lc2[[i]], col="red", conf.int=F, xlim=c(0,12));
  lines(fits_wei2[[i]], col="coral4", ci=F);
  lines(fits_weiph2[[i]], col="navyblue", ci=F);
  lines(fits_gomp2[[i]], col="lightpink", ci=F);
  lines(fits_llogis2[[i]], col="gray25", ci=F);##A0A36D
  lines(fits_gam2[[i]], col="darkorchid4", ci=F);##886894
  lines(fits_ggam2[[i]], col="#496A72", ci=F);
  lines(fits_logn2[[i]], col="gray70", ci=F);
  lines(fits_exp2[[i]],col="#A0A36D", ci=F);
  lines(fits_genf2[[i]],col="cadetblue", ci=F)

legend("bottomleft", legend = c("Kaplan-Meier","Weibull (AFT)", "Weibull (PH)", "Gompertz", "Log-logistic", "Gamma",
                "Generalized gamma", "Lognormal", "Exponential", "Generalized F"), col = 
         c("red","coral4","navyblue","lightpink","gray25",#"#B89673",##886894
           "darkorchid4","#496A72","gray70","#A0A36D","cadetblue"), 
       title = "Distributions", cex = .95, bty = "n", lty=1.2,lwd=3)# lty = 1:2, 
title(main=transition_label_4s[[i]])
}

path_jpg_1<-rstudioapi::getSourceEditorContext()$path

if(no_mostrar==1){
  
jpeg(paste0(sub("Proyecto_carla34.Rmd","",path_jpg_1),"pred_surv_4st_int_only.jpg"), height=18, width= 10, res= 320, units = "in")

    layout(matrix(1:6, nc = 2, byrow = F))
    for (i in 1:n_trans2){
    plot(km.lc2[[i]], col="red", conf.int=F, xlim=c(0,12));
      lines(fits_wei2[[i]], col="coral4", ci=F);
      lines(fits_weiph2[[i]], col="navyblue", ci=F);
      lines(fits_gomp2[[i]], col="lightpink", ci=F);
      lines(fits_llogis2[[i]], col="gray25", ci=F);##A0A36D
      lines(fits_gam2[[i]], col="darkorchid4", ci=F);##886894
      lines(fits_ggam2[[i]], col="#496A72", ci=F);
      lines(fits_logn2[[i]], col="gray70", ci=F);
      lines(fits_exp2[[i]],col="#A0A36D", ci=F);
      lines(fits_genf2[[i]],col="cadetblue", ci=F)
    
    legend("bottomleft", legend = c("Kaplan-Meier","Weibull (AFT)", "Weibull (PH)", "Gompertz", "Log-logistic", "Gamma",
                    "Generalized gamma", "Lognormal", "Exponential", "Generalized F"), col = 
             c("red","coral4","navyblue","lightpink","gray25",#"#B89673",##886894
               "darkorchid4","#496A72","gray70","#A0A36D","cadetblue"), 
           title = "Distributions", cex = .95, bty = "n", lty=1.2,lwd=3)# lty = 1:2, 
    title(main=transition_label_4s[[i]])
    }  
      
dev.off()
}
```


```{r fit2b_4s, eval=T, echo=T, fig.cap="Figure 1. Vissual Assessment of Hazards, Four-states Model (w/o covars)", fig.height= 17, fig.width= 10, paged.print=TRUE, fig.align="center", dpi=320, error= T, warnings= F}

haz_plot_4s_int_only<-
haz_4s %>% 
  dplyr::mutate(dist=factor(dist,levels=c("Kernel density",dists_wo_covs_4s$formal))) %>% 
ggplot()+
    geom_line(aes(time, est, color=dist),size=1)+
    #geom_ribbon(aes(ymin=lcl, ymax=ucl), alpha=.5, linetype=0) +
    scale_color_manual(name="Distributions", values = c("black","#f54b96","#00e9b1","#69b763",
"#166000","#b27ff9","#fa863b","#013eab","#a7aa48","#b34b40","darkred"))+
                         #c("black",brewer.pal(n = 9, name = 'Paired')))+
                         #c("#112A60","#085754","#D3A347","#4F3C91","red","#112A60","#085754","#8F630D","#251363")) +
    facet_wrap(.~trans,labeller = labeller(trans = transition_label_4s), ncol=2, scales = "free_y")+
    sjPlot::theme_sjplot2()+
    theme(legend.position="bottom",
          strip.background = element_rect(fill = "white", colour = "white"))+
  scale_x_continuous(breaks = seq(1, 15, 2))+
  #ylim(0,1.25)+
  #theme(axis.text.x = element_blank(), 
  #      panel.grid.major = element_blank(), 
  #      panel.grid.minor = element_blank()) +
  labs(y="Hazard",x="Time (years)")


haz_plot_int<-list()

for (i in 1:(length(transition_label_4s))){
  haz_plot_int[[i]]<-
      haz_4s %>% 
        dplyr::mutate(dist=factor(dist,levels=c("Kernel density",dists_wo_covs_4s$formal))) %>% 
        dplyr::filter(trans==i) %>% 
      ggplot()+
          geom_line(aes(time, est, color=dist),size=1)+
          scale_color_manual(name="Distributions", values = c("red", "coral4","navyblue","lightpink","gray25","darkorchid4","#496A72","gray70","#A0A36D","cadetblue"))+
          sjPlot::theme_sjplot2()+
          theme(legend.position="bottom",
                strip.background = element_rect(fill = "white", colour = "white"))+
        scale_x_continuous(breaks = seq(1, 15, 2))+
          labs(y="",x="")+ theme(legend.position="none")+theme(plot.title = element_text(size = 11, face = "bold"))+
        ggtitle(transition_label_4s[[i]])
}

legend_int_only <-
        haz_4s %>% 
        dplyr::mutate(dist=factor(dist,levels=c("Kernel density",dists_wo_covs_4s$formal))) %>% 
        dplyr::filter(trans==i) %>% 
      ggplot()+
          geom_line(aes(time, est, color=dist),size=1)+
          scale_color_manual(name="Distributions", values = c("red", "coral4","navyblue","lightpink","gray25","darkorchid4","#496A72","gray70","#A0A36D","cadetblue"))+
          sjPlot::theme_sjplot2()+
          theme(legend.position="bottom",
                strip.background = element_rect(fill = "white", colour = "white"))+
        scale_x_continuous(breaks = seq(1, 15, 2))+
    lims(x = c(0,0), y = c(0,0))+
  theme_void()+
  theme(legend.position = c(0.5,0.5),
        legend.key.size = unit(.2, "cm"),
        legend.text = element_text(size =  12),
        legend.title = element_text(size = 14, face = "bold"))+
  guides(colour = guide_legend(ncol = 2,override.aes = list(size=7)))

haz_plot_int[[6]]<-legend_int_only

fig_haz_plot_int<-
ggarrange(
  plotlist=haz_plot_int, ncol=2, nrow=3)

fig_haz_plot_int_lab<-
annotate_figure(fig_haz_plot_int, left = textGrob("Cumulative hazards", rot = 90, vjust = 1, gp = gpar(cex = 1.3)),
                    bottom = textGrob("Years", gp = gpar(cex = 1.3)))
fig_haz_plot_int_lab

if(no_mostrar==1){
jpeg(paste0(sub("Proyecto_carla34.Rmd","",path_jpg_1),"pred_haz_4st_int_only.jpg"), height=15, width= 10, res= 320, units = "in")
fig_haz_plot_int_lab
#PPredicted survival curves for the five transitions of the four-states multistate model
#grid.arrange(haz_plot_4s_int_only,fit_plot_int_4s_only, heights=c(2,1.5))
dev.off()
}
```

<br>

# Transition intensities

```{r haz_df2, eval=T, echo=T, paged.print=TRUE, error=T}
`%>%`<-magrittr::`%>%`
# 3 states -Women-specific
cumhaz_data_a2 <- rbind(data.frame(cox_cumhaz_0_a_we$Haz, #2021-04-23, cambié el modelo NP, porque estaba ws donde debiese estar el general
                                model = "NP Cox"),
                      data.frame(mrcox_a2$Haz,
                                model = "Cox"),
                      data.frame(flexsurv_cumhaz_a2$Haz,
                                model = "Parametric"))

cumhaz_data_a2$trans <- factor(cumhaz_data_a2$trans,
                            levels = seq(1, 3),
                            labels = c("Admission -> Treatment completion",
                                       "Admission -> Readmission",
                                       "Treatment completion -> Readmission"))

# 3 states -General-population
cumhaz_data_b2 <- rbind(data.frame(cox_cumhaz_0_a_gp$Haz,#2021-04-23, cambié el modelo NP, porque estaba ws donde debiese estar el general
                                model = "NP Cox"),
                      data.frame(mrcox_b2$Haz,
                                model = "Cox"),
                      data.frame(flexsurv_cumhaz_b2$Haz,
                                model = "Parametric"))
cumhaz_data_b2$trans <- factor(cumhaz_data_b2$trans,
                            levels = seq(1, 3),
                            labels = c("Admission -> Treatment completion",
                                       "Admission -> Readmission",
                                       "Treatment completion -> Readmission"))

## 4 states -Women specific
cumhaz_data_c2 <- rbind(data.frame(cox_cumhaz_0_c_we$Haz,#2021-04-23, cambié el modelo NP, porque estaba ws donde debiese estar el general
                                model = "NP Cox"),
                      data.frame(mrcox_c2$Haz,
                                model = "Cox"),
                      data.frame(flexsurv_cumhaz_c2$Haz,
                                model = "Parametric"))

cumhaz_data_c2$trans <- factor(cumhaz_data_c2$trans,
                            levels = seq(1, 5),
                            labels = c("Admission -> Treatment completion",
                                       "Admission -> Discharge without completion",
                                       "Admission -> Readmission",
                                       "Treatment completion -> Readmission",
                                       "Discharge without completion -> Readmission"
                                       ))
## 4 states -General population
cumhaz_data_d2 <- rbind(data.frame(cox_cumhaz_0_c_gp$Haz,#2021-04-23, cambié el modelo NP, porque estaba ws donde debiese estar el general
                                model = "NP Cox"),
                      data.frame(mrcox_d2$Haz,
                                model = "Cox"),
                      data.frame(flexsurv_cumhaz_d2$Haz,
                                model = "Parametric"))

cumhaz_data_d2$trans <- factor(cumhaz_data_d2$trans,
                            levels = seq(1, 5),
                            labels = c("Admission -> Treatment completion",
                                       "Admission -> Discharge without completion",
                                       "Admission -> Readmission",
                                       "Treatment completion -> Readmission",
                                       "Discharge without completion -> Readmission"
                                       ))

fig_cox_ab22<-
ggplot()+
  geom_step(data=reshape2::melt(cumhaz_data_a2,id.vars=c("time","trans","model")), aes(time, value, color= model,linetype="dashed"),size=1, alpha=.65) + 
  geom_step(data=reshape2::melt(cumhaz_data_b2,id.vars=c("time","trans","model")), aes(time, value, color= model,linetype="solid"),size=1, alpha=.65) + 
  facet_wrap(trans~., ncol=1, scales = "free_y") + 
  scale_color_manual(name ="Model",values=c("#0E53A7","#200772","#BF8830"),labels= c("Cox","NP Cox","Par"))+
  scale_linetype_manual(name= "Type of Plan",values=c("dashed","solid"), labels=c("Women only      ","Mixed gender      "))+
  scale_x_continuous(breaks=seq(0, 11, by = 1/2))+
  xlab("Years") + 
  ylab("Cumulative hazards") + 
  theme_minimal()+
  theme(legend.position=c(.9,.59),
        legend.background = element_rect(fill="white",
                                  size=0.5, linetype="solid", 
                                  colour ="black"))
fig_cox_cd22<-
ggplot()+
  geom_step(data=reshape2::melt(cumhaz_data_c2,id.vars=c("time","trans","model")), aes(time, value, color= model,linetype="dashed"),size=1, alpha=.65) + 
  geom_step(data=reshape2::melt(cumhaz_data_d2,id.vars=c("time","trans","model")), aes(time, value, color= model,linetype="solid"),size=1, alpha=.65) + 
  facet_wrap(trans~., ncol=1, scales = "free_y") + 
  scale_color_manual(name ="Model",values=c("#0E53A7","#200772","#BF8830"),labels= c("Cox","NP Cox","Par"))+
  scale_linetype_manual(name= "Type of Plan",values=c("dashed","solid"), labels=c("Women only      ","Mixed gender      "))+
  scale_x_continuous(breaks=seq(0, 11, by = 1/2))+
  xlab("Years") + 
  ylab("Cumulative") + 
  theme_minimal()+
  theme(legend.position=c(.9,.6),
        legend.background = element_rect(fill="white",
                                  size=0.5, linetype="solid", 
                                  colour ="black"))
```


```{r cum_haz12a, eval=T, echo=T, paged.print=TRUE, fig.height=15, fig.width=10, fig.cap="Figure 2. Estimate of Cumulative Hazards, Three & Four-States Model", fig.align="center", error=T}

`%>%`<-magrittr::`%>%`

trans_for_three_st<-c("Admission -> Treatment completion","Admission -> Readmission","Treatment completion -> Readmission")
trans_for_four_st<-c("Admission -> Treatment completion","Admission -> Discharge without completion","Admission -> Readmission","Treatment completion -> Readmission","Discharge without completion -> Readmission")
abc_let<-c("A","B","C","D","E")
st_plot<-list()

for (i in 1:(length(trans_for_four_st))){
  st_plot[[i]]<-
ggplot()+
  geom_step(data=reshape2::melt(cumhaz_data_c2,id.vars=c("time","trans","model")) %>% dplyr::filter(model=="Parametric") %>% dplyr::filter(trans==trans_for_four_st[[i]]), aes(time, value, linetype="dashed"),size=1, alpha=.65) + 
  geom_step(data=reshape2::melt(cumhaz_data_d2,id.vars=c("time","trans","model")) %>% dplyr::filter(model=="Parametric") %>% dplyr::filter(trans==trans_for_four_st[[i]]), aes(time, value, linetype="solid"),size=1, alpha=.65) + 
  scale_linetype_manual(name= "Type of Plan",values=c("dashed","solid"), labels=c("Women only","Mixed gender"))+
  scale_x_continuous(breaks=seq(0, 11, by = 1/2))+
  xlab("") + 
  ylab("") + 
  theme_minimal()+
  theme(axis.title = element_blank())+
  theme(legend.position="none",
        legend.background = element_rect(fill="white",
                                  size=0.5, linetype="solid", 
                                  colour ="black"))+
        ggtitle(paste0(abc_let[[i]],") ",trans_for_four_st[[i]]))
}

p3 <- ggplot()+
  geom_step(data=reshape2::melt(cumhaz_data_c2,id.vars=c("time","trans","model")) %>% dplyr::filter(model=="Parametric") %>% dplyr::filter(trans==trans_for_four_st[[4]]), aes(time, value, linetype="dashed"),size=1, alpha=.65) + 
  geom_step(data=reshape2::melt(cumhaz_data_d2,id.vars=c("time","trans","model")) %>% dplyr::filter(model=="Parametric") %>% dplyr::filter(trans==trans_for_four_st[[4]]), aes(time, value, linetype="solid"),size=1, alpha=.65) + 
  scale_linetype_manual(name= "Type of Plan",values=c("dashed","solid"), labels=c("Women only","Mixed gender"))+
  lims(x = c(0,0), y = c(0,0))+
  theme_void()+
  theme(legend.position = c(0.5,0.5),
        legend.key.size = unit(1, "cm"),
        legend.text = element_text(size =  12),
        legend.title = element_text(size = 15, face = "bold"))+
  guides(colour = guide_legend(override.aes = list(size=9)))


st_plot2<-list()
for (i in 1:(length(trans_for_three_st))){
  st_plot2[[i]]<-
ggplot()+
  geom_step(data=reshape2::melt(cumhaz_data_a2,id.vars=c("time","trans","model")) %>% dplyr::filter(model=="Parametric") %>% dplyr::filter(trans==trans_for_three_st[[i]]), aes(time, value, linetype="dashed"),size=1, alpha=.65) + 
  geom_step(data=reshape2::melt(cumhaz_data_b2,id.vars=c("time","trans","model")) %>% dplyr::filter(model=="Parametric") %>% dplyr::filter(trans==trans_for_three_st[[i]]), aes(time, value, linetype="solid"),size=1, alpha=.65) + 
  scale_linetype_manual(name= "Type of Plan",values=c("dashed","solid"), labels=c("Women only","Mixed gender"))+
  scale_x_continuous(breaks=seq(0, 11, by = 1/2))+
  xlab("") + 
  ylab("") + 
  theme_minimal()+
  theme(axis.title = element_blank())+
  theme(legend.position="none",
        legend.background = element_rect(fill="white",
                                  size=0.5, linetype="solid", 
                                  colour ="black"))+
        ggtitle(paste0(abc_let[[i]],") ",trans_for_three_st[[i]]))
}


fig_cox_abcd<-
ggarrange(
#  st_plot[[1]] + theme(legend.position="none")+xlim(0,5)+ylim(0,2)+theme(plot.title = element_text(size = 10, face = "bold")),
#  st_plot[[2]] + theme(legend.position="none")+xlim(0,5)+ylim(0,2)+theme(plot.title = element_text(size = 10, face = "bold")),
#  st_plot[[3]] + theme(legend.position="none")+xlim(0,5)+ylim(0,2)+theme(plot.title = element_text(size = 10, face = "bold")),
  st_plot[[1]] + theme(legend.position="none")+xlim(0,5)+ylim(0,2)+theme(plot.title = element_text(size = 10, face = "bold")),
  st_plot[[2]] + theme(legend.position="none")+xlim(0,5)+ylim(0,2)+theme(plot.title = element_text(size = 10, face = "bold")),
  st_plot[[3]] + theme(legend.position="none")+xlim(0,5)+ylim(0,2)+theme(plot.title = element_text(size = 10, face = "bold")),
  st_plot[[4]] + theme(legend.position="none")+xlim(0,5)+ylim(0,2)+theme(plot.title = element_text(size = 10, face = "bold")),
  st_plot[[5]] + theme(legend.position="none")+xlim(0,5)+ylim(0,2)+theme(plot.title = element_text(size = 10, face = "bold")),
          p3
          )

fig_cox_abcd_three_states<-
ggarrange(
  st_plot2[[1]] + theme(legend.position="none")+xlim(0,5)+ylim(0,1)+theme(plot.title = element_text(size = 10, face = "bold")),
  st_plot2[[2]] + theme(legend.position="none")+xlim(0,5)+ylim(0,1)+theme(plot.title = element_text(size = 10, face = "bold")),
  st_plot2[[3]] + theme(legend.position="none")+xlim(0,5)+ylim(0,1)+theme(plot.title = element_text(size = 10, face = "bold")),
          p3
          )


fig_cox_abcd_lab<-
annotate_figure(fig_cox_abcd, left = textGrob("Cumulative hazards", rot = 90, vjust = 1, gp = gpar(cex = 1.3)),
                    bottom = textGrob("Years", gp = gpar(cex = 1.3)))

fig_cox_abcd_three_states_lab<-
annotate_figure(fig_cox_abcd_three_states, left = textGrob("Cumulative hazards", rot = 90, vjust = 1, gp = gpar(cex = 1.3)),
                    bottom = textGrob("Years", gp = gpar(cex = 1.3)))


fig_cox_abcd_lab

path_jpg<-rstudioapi::getSourceEditorContext()$path
if (grepl("CISS Fondecyt",path_jpg)==T){
    jpg_path<-paste0("C:/Users/CISS Fondecyt/Mi unidad/Alvacast/SISTRAT 2019 (github)/_WO vs MG/")
  } else if (grepl("andre",path_jpg)==T){
    jpg_path<-paste0('C:/Users/andre/Desktop/SUD_CL/')
  } else if (grepl("E:",path_jpg)==T){
    jpg_path<-paste0("E:/Mi unidad/Alvacast/SISTRAT 2019 (github)/_WO vs MG/")
  } else {
    jpg_path<-paste0("G:/Mi unidad/Alvacast/SISTRAT 2019 (github)/_WO vs MG/")
  }


if(no_mostrar==1){
ggsave(paste0(jpg_path,"Fig2_paper_carla.jpg"), fig_cox_abcd_lab, width = 10, height = 11.5, dpi = 600, units= "in")
ggsave(paste0(jpg_path,"Fig2_paper_carla.eps"), fig_cox_abcd_lab, width = 10, height = 11.5, dpi = 600, units= "in")
ggsave(paste0(jpg_path,"Fig2_paper_carla.ps"), fig_cox_abcd_lab, width = 10, height = 11.5, dpi = 600, units= "in")
ggsave(paste0(jpg_path,"Fig2_paper_carla.pdf"), fig_cox_abcd_lab, width = 10, height = 11.5, dpi = 600, units= "in")

ggsave(paste0(jpg_path,"Fig2_alt_paper_carla.jpg"), fig_cox_abcd_three_states_lab, width = 10, height = 11.5, dpi = 600, units= "in")
ggsave(paste0(jpg_path,"Fig2_alt_paper_carla.eps"), fig_cox_abcd_three_states_lab, width = 10, height = 11.5, dpi = 600, units= "in")
ggsave(paste0(jpg_path,"Fig2_alt_paper_carla.ps"), fig_cox_abcd_three_states_lab, width = 10, height = 11.5, dpi = 600, units= "in")
ggsave(paste0(jpg_path,"Fig2_alt_paper_carla.pdf"), fig_cox_abcd_three_states_lab, width = 10, height = 11.5, dpi = 600, units= "in")
}
```

<br>


```{r ph2,eval=T, echo=T, paged.print=TRUE, fig.height=20, fig.width=10, fig.cap="Figure 3. Vissual Assessment of Hazards, Four-states Model (w/o covars)", dpi=320, fig.align="center"}                                 
plots2<- data.frame(title=rep(c("(a) Admission -> Treatment completion","(b) Admission -> Treatment w/o completion","(c) Admission -> Readmission", "(d) Treatment completion -> Readmission","(e) Treatment w/o completion -> Readmission"),1),trans=1:5)

layout(matrix(1:10, nc = 2, byrow = F))
for(i in c(1:5)){
plot(log(survfit(Surv(time,status)~1, data=subset(ms2_CONS_C1_SEP_2020_women_imputed, trans==plots2[i,"trans"] & tipo_de_programa_2==0))$time), 
     log(-log(survfit(Surv(time,status)~1, data=subset(ms2_CONS_C1_SEP_2020_women_imputed, trans==plots2[i,"trans"] & tipo_de_programa_2==0))$surv)), type="l",
     xlab="log(Years)", ylab="", xaxs="i",yaxs="i",
     las=1,cex.lab=1.5, cex.axis=1.5)
lines(log(survfit(Surv(time,status)~1, data=subset(ms2_CONS_C1_SEP_2020_women_imputed, trans==plots2[i,"trans"] & tipo_de_programa_2==1))$time), 
      log(-log(survfit(Surv(time,status)~1, data=subset(ms2_CONS_C1_SEP_2020_women_imputed, trans==plots2[i,"trans"] & tipo_de_programa_2==1))$surv)), lty=2)
legend(0,-4, c("MG", "WO"), bty="n", lty=c(2,1), cex=1.5)
title(main=paste0("LOG CUMULATIVE HAZARD VS LOG TIME PLOT \n",plots2[i,"title"]), cex.main=1.5)
}

for(i in c(1:5)){
plot(survfit(Surv(time,status)~1, data=subset(ms2_CONS_C1_SEP_2020_women_imputed, trans==plots2[i,"trans"] & tipo_de_programa_2==0))$time, 
     -log(survfit(Surv(time,status)~1, data=subset(ms2_CONS_C1_SEP_2020_women_imputed, trans==plots2[i,"trans"] & tipo_de_programa_2==0))$surv), type="l",
     xlab="Years", ylab="", xaxs="i",yaxs="i", 
     las=1,cex.lab=1.5, cex.axis=1.5, col=1)
lines(survfit(Surv(time,status)~1, data=subset(ms2_CONS_C1_SEP_2020_women_imputed, trans==plots2[i,"trans"] & tipo_de_programa_2==1))$time, 
      -log(survfit(Surv(time,status)~1, data=subset(ms2_CONS_C1_SEP_2020_women_imputed, trans==plots2[i,"trans"] & tipo_de_programa_2==1))$surv), lty=2)
legend(7.5,.23, c("MG", "WO"), bty="n", lty=c(2,1), cex=1.5)
title(main=paste0("CUMULATIVE HAZARD PLOT: -LOG(KM SURVIVAL) \n",plots2[i,"title"]), cex.main=1.5)
}



if(no_mostrar==1){
jpeg(paste0(sub("Proyecto_carla34.Rmd","",path_jpg),"ph1.jpg"), height=15, width= 10, res= 320, units = "in")

layout(matrix(1:10, nc = 2, byrow = F))
for(i in c(1:5)){
plot(survfit(Surv(time,status)~1, data=subset(ms2_CONS_C1_SEP_2020_women_imputed, trans==plots2[i,"trans"] & tipo_de_programa_2==0))$time, 
     -log(survfit(Surv(time,status)~1, data=subset(ms2_CONS_C1_SEP_2020_women_imputed, trans==plots2[i,"trans"] & tipo_de_programa_2==0))$surv), type="l",
     xlab="Years", ylab="", xaxs="i",yaxs="i", 
     las=1,cex.lab=1.5, cex.axis=1.5, col=1)
lines(survfit(Surv(time,status)~1, data=subset(ms2_CONS_C1_SEP_2020_women_imputed, trans==plots2[i,"trans"] & tipo_de_programa_2==1))$time, 
      -log(survfit(Surv(time,status)~1, data=subset(ms2_CONS_C1_SEP_2020_women_imputed, trans==plots2[i,"trans"] & tipo_de_programa_2==1))$surv), lty=2)
legend(7.5,.31, c("MG", "WO"), bty="n", lty=c(2,1), cex=1.5)
title(main=paste0("CUMULATIVE HAZARD PLOT: -LOG(KM SURVIVAL) \n",plots2[i,"title"]), cex.main=1.5)
}
for(i in c(1:5)){
plot(log(survfit(Surv(time,status)~1, data=subset(ms2_CONS_C1_SEP_2020_women_imputed, trans==plots2[i,"trans"] & tipo_de_programa_2==0))$time), 
     log(-log(survfit(Surv(time,status)~1, data=subset(ms2_CONS_C1_SEP_2020_women_imputed, trans==plots2[i,"trans"] & tipo_de_programa_2==0))$surv)), type="l",
     xlab="log(Years)", ylab="", xaxs="i",yaxs="i",
     las=1,cex.lab=1.5, cex.axis=1.5)
lines(log(survfit(Surv(time,status)~1, data=subset(ms2_CONS_C1_SEP_2020_women_imputed, trans==plots2[i,"trans"] & tipo_de_programa_2==1))$time), 
      log(-log(survfit(Surv(time,status)~1, data=subset(ms2_CONS_C1_SEP_2020_women_imputed, trans==plots2[i,"trans"] & tipo_de_programa_2==1))$surv)), lty=2)
legend(0,-3, c("MG", "WO"), bty="n", lty=c(2,1), cex=1.5)
title(main=paste0("LOG CUMULATIVE HAZARD VS LOG TIME PLOT \n",plots2[i,"title"]), cex.main=1.5)
}

dev.off()

}

```


```{r coxzph, eval=T, echo=T, paged.print=TRUE, error=T}

coxzph<-data.frame()
for(i in c(1:5)){
  coxzph<-
  rbind(coxzph,cox.zph(coxph(Surv(time,status)~factor(tipo_de_programa_2), data=subset(ms2_CONS_C1_SEP_2020_women_imputed, trans==i)), transform="km", terms=TRUE, singledf=FALSE, global=TRUE)$table)
}

coxzph$p<-round(coxzph$p, 3)

data.table::data.table(coxzph,keep.rownames = T) %>% 
  dplyr::filter(grepl("GLOBAL",rn)) %>% 
  dplyr::mutate(chisq=round(chisq,3)) %>% 
  dplyr::mutate(transition=1:5) %>% 
  dplyr::select(transition, chisq, df, p) %>% 
  knitr::kable(.,format = "html", format.args = list(decimal.mark = ".", big.mark = ","),
       caption = paste0("Table 1. Proportionality (Arrival, ~3 years + RP)"),
       col.names = c("State","Time","Residential","Outpatient"),
               align =rep('c', 101)) %>%
  kableExtra::kable_styling(bootstrap_options = c("striped", "hover"),font_size = 12) %>%
  #kableExtra::add_header_above(c(rep("",1),"Women-specific"=1, "General population"=1)) %>% 
  kableExtra::pack_rows("Starting From 1)Admission", 1, 5) %>%
  kableExtra::pack_rows("Starting From 2)Readmission", 6, 10) %>%
  kableExtra::pack_rows("Starting From 3)2nd Readmission", 11, 15) %>%
  kableExtra::pack_rows("Starting From 4)3rd Readmission", 16, 20) %>%
 # kableExtra::add_footnote("Note. Readmission state will not be considered because is an absorbing state", notation="none") %>% 
  kableExtra::scroll_box(width = "100%", height = "375px")
```

<br>

# Simulate Final State

We estimated the median of stay, percentiles 25, 75 and confidence intervals based on `r n_iter/20` resamples, by simulating a large sample of individuals from the model depending on the type of program they were admitted at baseline.

```{r sim_medians2, eval=T, echo=T, paged.print=TRUE, error=T}
time_before_sim_medians2<-Sys.time()
#Estimates the probability of each final outcome ("absorbing" state), and the mean and quantiles of the time to that outcome for people who experience it, by simulating a large sample of individuals from the model. This can be used for both Markov and semi-Markov models.C
#n_iter=12
fmsm_sel_param_fits_4s_b<-
    fmsm(fits_c_gomp2[[1]],fits_c_gomp2[[2]],fits_c_logn2[[3]],fits_c_ggam2[[4]],fits_c_logn2[[5]], trans=mat_4_states)
#newdat5a_2  newdat5b_2

  set.seed(1234)
simfinal_fmsm2_4st_90d<-
simfinal_fmsm(fmsm_sel_param_fits_4s_b, #Object returned by fmsm, representing a multi-state model formed from transition-specific time-to-event models fitted by flexsurvreg.
              newdata = rbind.data.frame(newdat5a_2[1,],newdat5b_2[1,])[,-"strata"], #Data frame of covariate values, with one column per covariate, and one row per alternative value.
              t= 1/4.0583, #itempo máximo al que simular, de manera que el resumen se toman de la muestra de individuos en los datos simulados quienes están en el estado absorvente a ese tiempo.
              probs = c(0.025,0.25, 0.5, 0.75,0.975), 
              #M=100000, #necesita grandes números
              B=n_iter/20, #Pondría 1,000
              cores=8
              )

  set.seed(1234)
simfinal_fmsm2_4st_1y<-
simfinal_fmsm(fmsm_sel_param_fits_4s_b, #Object returned by fmsm, representing a multi-state model formed from transition-specific time-to-event models fitted by flexsurvreg.
              newdata = rbind.data.frame(newdat5a_2[1,],newdat5b_2[1,])[,-"strata"], #Data frame of covariate values, with one column per covariate, and one row per alternative value.
              t= 1, #itempo máximo al que simular, de manera que el resumen se toman de la muestra de individuos en los datos simulados quienes están en el estado absorvente a ese tiempo.
              probs = c(0.025,0.25, 0.5, 0.75,0.975), 
              #M=100000, #necesita grandes números
              B=n_iter/20, #Pondría 1,000
              cores=8
              )
  set.seed(1234)
  simfinal_fmsm2_4st_3y<-
simfinal_fmsm(fmsm_sel_param_fits_4s_b, #Object returned by fmsm, representing a multi-state model formed from transition-specific time-to-event models fitted by flexsurvreg.
              newdata = rbind.data.frame(newdat5a_2[1,],newdat5b_2[1,])[,-"strata"], #Data frame of covariate values, with one column per covariate, and one row per alternative value.
              t= 3, #itempo máximo al que simular, de manera que el resumen se toman de la muestra de individuos en los datos simulados quienes están en el estado absorvente a ese tiempo.
              probs = c(0.025,0.25, 0.5, 0.75,0.975), 
              #M=100000, #necesita grandes números
              B=n_iter/20, #Pondría 1,000
              cores=8
              )
  set.seed(1234)
simfinal_fmsm2_4st_5y<-
simfinal_fmsm(fmsm_sel_param_fits_4s_b, #Object returned by fmsm, representing a multi-state model formed from transition-specific time-to-event models fitted by flexsurvreg.
              newdata = rbind.data.frame(newdat5a_2[1,],newdat5b_2[1,])[,-"strata"], #Data frame of covariate values, with one column per covariate, and one row per alternative value.
              t= 5, #itempo máximo al que simular, de manera que el resumen se toman de la muestra de individuos en los datos simulados quienes están en el estado absorvente a ese tiempo.
              probs = c(0.025,0.25, 0.5, 0.75,0.975), 
              #M=100000, #necesita grandes números
              B=n_iter/20, #Pondría 1,000
              cores=8
              )
time_after_sim_medians2<-Sys.time()

paste0("Time in process: ");time_after_sim_medians2-time_before_sim_medians2

# probability of each final outcome
# mean and quantiles of the time to that outcome for people who experience it
```


```{r sim_medians_df, eval=T, echo=T, paged.print=TRUE, error=T}
simfinal_fmsm2_4st_df<-
rbind.data.frame(
simfinal_fmsm2_4st_30d%>%dplyr::select("tipo_de_programa_2","quantity","val","lower","upper")%>%mutate(year=.08),
simfinal_fmsm2_4st_90d%>%dplyr::select("tipo_de_programa_2","quantity","val","lower","upper")%>%mutate(year=.25),
simfinal_fmsm2_4st_1y%>%dplyr::select("tipo_de_programa_2","quantity","val","lower","upper")%>%mutate(year=1),
simfinal_fmsm2_4st_3y%>%dplyr::select("tipo_de_programa_2","quantity","val","lower","upper")%>%mutate(year=3),
simfinal_fmsm2_4st_5y%>%dplyr::select("tipo_de_programa_2","quantity","val","lower","upper")%>%mutate(year=5))
```


```{r sim_final_plot2, eval=T, echo=T, paged.print=TRUE, fig.height=8, fig.cap="Figure 4. Time to Readmission for Users who Experience it (Mean and 95%CIs), Four-states model (2nd patient)", fig.align="center", error=T}
simfinal_fmsm2_4st_df %>%
dplyr::mutate(year=factor(year,levels=c(.08,.25, .333, .5, 1, 3, 5), labels=c("30 days", "90 days", "4 months", "6 months", "1 year", "3 years", "5 years"))) %>% 
  dplyr::group_by(year, tipo_de_programa_2) %>% 
  summarise(mean=sum(val[quantity=="mean"],na.rm=T),
            lo=sum(lower[quantity=="2.5%"],na.rm=T),
            up=sum(upper[quantity=="97.5%"],na.rm=T)) %>% 
  ggplot(aes(x=year, y=mean, color=tipo_de_programa_2))+
  geom_bar(aes(x=year, y=mean, color=tipo_de_programa_2, fill=tipo_de_programa_2), position="dodge", stat="identity", alpha=0.4)+
  sjPlot::theme_sjplot2()+
  geom_errorbar(aes(x=year, ymin=lo, ymax=up, color=tipo_de_programa_2), position="dodge", stat="identity", width=0.4,  alpha=0.9, size=1)+
  ylim(0,11)+
  ylab("Time to event")+
  scale_color_manual(name ="Type of program",values=c("#0E53A7","#FFB540"), labels= c("Women-specific","General Population"))+
  scale_fill_manual(name ="Type of program",values=c("#0E53A7","#FFB540"), labels= c("Women-specific","General Population"))+
  xlab("Maximum time of simualted individuals in the absorbing state")



if(no_mostrar==1){
jpeg(paste0(sub("Proyecto_carla34.Rmd","",path_jpg),"ph1.jpg"), height=15, width= 10, res= 320, units = "in")

layout(matrix(1:10, nc = 2, byrow = F))
for(i in c(1:5)){
plot(survfit(Surv(time,status)~1, data=subset(ms2_CONS_C1_SEP_2020_women_imputed, trans==plots2[i,"trans"] & tipo_de_programa_2==0))$time, 
     -log(survfit(Surv(time,status)~1, data=subset(ms2_CONS_C1_SEP_2020_women_imputed, trans==plots2[i,"trans"] & tipo_de_programa_2==0))$surv), type="l",
     xlab="Years", ylab="", xaxs="i",yaxs="i", 
     las=1,cex.lab=1.5, cex.axis=1.5, col=1)
lines(survfit(Surv(time,status)~1, data=subset(ms2_CONS_C1_SEP_2020_women_imputed, trans==plots2[i,"trans"] & tipo_de_programa_2==1))$time, 
      -log(survfit(Surv(time,status)~1, data=subset(ms2_CONS_C1_SEP_2020_women_imputed, trans==plots2[i,"trans"] & tipo_de_programa_2==1))$surv), lty=2)
legend(7.5,.31, c("MG", "WO"), bty="n", lty=c(2,1), cex=1.5)
title(main=paste0("CUMULATIVE HAZARD PLOT: -LOG(KM SURVIVAL) \n",plots2[i,"title"]), cex.main=1.5)
}
for(i in c(1:5)){
plot(log(survfit(Surv(time,status)~1, data=subset(ms2_CONS_C1_SEP_2020_women_imputed, trans==plots2[i,"trans"] & tipo_de_programa_2==0))$time), 
     log(-log(survfit(Surv(time,status)~1, data=subset(ms2_CONS_C1_SEP_2020_women_imputed, trans==plots2[i,"trans"] & tipo_de_programa_2==0))$surv)), type="l",
     xlab="log(Years)", ylab="", xaxs="i",yaxs="i",
     las=1,cex.lab=1.5, cex.axis=1.5)
lines(log(survfit(Surv(time,status)~1, data=subset(ms2_CONS_C1_SEP_2020_women_imputed, trans==plots2[i,"trans"] & tipo_de_programa_2==1))$time), 
      log(-log(survfit(Surv(time,status)~1, data=subset(ms2_CONS_C1_SEP_2020_women_imputed, trans==plots2[i,"trans"] & tipo_de_programa_2==1))$surv)), lty=2)
legend(0,-3, c("MG", "WO"), bty="n", lty=c(2,1), cex=1.5)
title(main=paste0("LOG CUMULATIVE HAZARD VS LOG TIME PLOT \n",plots2[i,"title"]), cex.main=1.5)
}

dev.off()

}
```

<br>


# Session Info

```{r session_info, echo=T, paged.print=TRUE, error=T}
Sys.getenv("R_LIBS_USER")
rstudioapi::getSourceEditorContext()
#save.image("G:/Mi unidad/Alvacast/SISTRAT 2019 (github)/mult_state_carla.RData")

if (grepl("CISS Fondecyt",rstudioapi::getSourceEditorContext()$path)==T){
    save.image("C:/Users/CISS Fondecyt/Mi unidad/Alvacast/SISTRAT 2019 (github)/mult_state_carla_4.RData")
  } else if (grepl("andre",rstudioapi::getSourceEditorContext()$path)==T){
    save.image("C:/Users/andre/Desktop/SUD_CL/mult_state_carla_4.RData")
  } else if (grepl("E:",rstudioapi::getSourceEditorContext()$path)==T){
    save.image("E:/Mi unidad/Alvacast/SISTRAT 2019 (github)/mult_state_carla_4.RData")
  } else {
    save.image("G:/Mi unidad/Alvacast/SISTRAT 2019 (github)/mult_state_carla_4.RData")
  }

sessionInfo()
```
