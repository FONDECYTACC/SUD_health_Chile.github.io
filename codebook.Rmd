---
title: "Codebook For C1 Data"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  html_document:
    toc: true
    toc_depth: 4
    toc_float: true
    code_folding: 'hide'
    self_contained: true
---

```{r setup, include=F}
local({r <- getOption("repos")
       r["CRAN"] <- "http://cran.r-project.org" 
       options(repos=r)
})
knitr::opts_chunk$set(
  warning = TRUE, # show warnings during codebook generation
  message = TRUE, # show messages during codebook generation
  error = TRUE, # do not interrupt codebook generation in case of errors,
                # usually better for debugging
  echo = TRUE  # show R code
)
ggplot2::theme_set(ggplot2::theme_bw())
pander::panderOptions("table.split.table", Inf)
#file:///C:/Users/andre/OneDrive/Escritorio/RUTS/codebook%20tutorial.pdf
#https://cran.r-project.org/web/packages/codebook/vignettes/codebook_tutorial.html
if(!require(codebook)){install.packages("codebook")}
if(!require(future)){install.packages("future")}
if(!require(dplyr)){install.packages("dplyr")}
```

```{r prepare_codebook, include=F}
load("G:/Mi unidad/Alvacast/SISTRAT 2019 (github)/7.RData")

codebook_data <- CONS_C1_df_dup_JUL_2020
# to import an SPSS file from the same folder uncomment and edit the line below
# codebook_data <- rio::import("mydata.sav")
# for Stata
# codebook_data <- rio::import("mydata.dta")
# for CSV
# codebook_data <- rio::import("mydata.csv")

# omit the following lines, if your missing values are already properly labelled
codebook_data <- detect_missing(codebook_data,
    only_labelled = TRUE, # only labelled values are autodetected as
                                   # missing
    negative_values_are_missing = FALSE, # negative values are missing values
    ninety_nine_problems = FALSE,   # 99/999 are missing values, if they
                                   # are more than 5 MAD from the median
    )

# If you are not using formr, the codebook package needs to guess which items
# form a scale. The following line finds item aggregates with names like this:
# scale = scale_1 + scale_2R + scale_3R
# identifying these aggregates allows the codebook function to
# automatically compute reliabilities.
# However, it will not reverse items automatically.
#codebook_data <- detect_scales(codebook_data)
```
<br>

In the following Tables and graphics, there is a summary of the variables and documentation of their characteristics. This high-level summary may permit us find errors on coding, help us to understand missingness and guide us towards an objective, or lead us to more questions. If a variable contains the symbol `(*)`, it means that this variable has a concatenation of values among continuous entries in treatments.

<br>

```{r codebook}
codebook_data%>%
  #dplyr::select(-consentimiento_informado)%>%
codebook()


#fecha_ultimo_tratamiento
#

#Permite exportar los valores de cada variable de tipo factor.
invisible=9
df<- data.frame()
  for (i in names(Filter(is.factor,codebook_data))) { 
        fac<-data.table::data.table(table(codebook_data[i], exclude=NULL))%>% 
            dplyr::mutate(variable=paste0(i),export=paste0(row_number(),".",V1))%>%
            dplyr::select(-V1)%>%
            dplyr::select(variable,export,N)%>%
          dplyr::filter(!grepl("\\.NA",export))
      df_titulo<-data.frame(variable=paste0(i),export=NA, N=999)
      df<- rbind(df,df_titulo,fac)
  }
df<-
  as.data.frame(df)%>%
    dplyr::group_by(variable)%>%
    dplyr::mutate(rn=row_number())%>%
    select(variable,rn,everything())

  guardar_tablas(df, "labels_codebook")
  options(OutDec=',')
  guardar_tablas(df, "labels_codebook_comma")
  
  #1. Copiar datos del libro de códigos
  #2. Pegar en google spreadsheet codebook
  #3. Correr comando eliminar filas
  #4. Correr comando Añadir filas, 
  #5. Añadir columna a la derecha de label
  #6. Separar por "/"
  #7. Fijarse que no se superponga a otra variable
  #8. Añadir Propiedad a la izquierda de Tipos de Datos (Data Type)
  #9. Añadir columna a la derecha de A, y en B1 incorporar la siguiente fórmula: =ArrayFormula(SI(FILA(A1:A)<=COINCIDIR(2,1/(A:A<>""),1),BUSCAR(FILA(A1:A),FILA(A1:A)/SI(A1:A<>"",VERDADERO,FALSO),A1:A),))
  #9. Fijarse que la última variable tenga todas las categorías llenas con Nombre Variable Estandarizado
  #10. Pegar como valor (para no depender de la fórmula, dejar el comentario)
  #11. Eliminar la columna A
  #12. Ver cómo lo hago con labels_codebook, ya sea para pegarlo directamente en la hoja 'para_pegar_cat_factores'
  #13. Tengo que evaluar si la coma y el punto de los decimales era problemático
  #14. En una de esas abrir el archio con google drive para saltarse ese problema
  #15. Pegar después como valores en la columna H
  #16. Después pararse en la columna etiquetas (debiese ser la G), y generar una columna a la derecha
  #17. Agregar la siguiente fórmula =SI(I4="",G4,SI.ERROR(BUSCARV(CONCATENAR(A4,"_",CONTAR.SI($A$4:$A4,A4)-1),para_pegar_cat_factores!F:H,2,0),""))
  #18. 
```