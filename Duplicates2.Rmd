---
title: "Duplicated/ Repeated Cases in SISTRAT C1 (part 2)"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  html_document:
    code_folding: hide  
    toc: true # table of content true
    toc_depth: 5  # upto three depths of headings (specified by #, ## and ###)
    toc_float: true
---

<style type="text/css">
.tablelines table, .tablelines td, .tablelines th {
        border: 1px solid black;
        }
.centrado {
    text-align: center;
}
.table.center {
    margin-left:auto; 
    margin-right:auto;
  }
.table_wrapper{
    display: block;
    overflow-x: auto;
    white-space: nowrap;
}
code.r{
  font-size: 8px;
}
body{ /* Normal  */
      text-align: justify;
  }
.superbigimage{
    overflow-y:scroll;
    white-space: nowrap;
}
.superbigimage img{
    overflow-y: scroll;
    overflow-x: hidden;
}
</style>

```{r setup, include = FALSE, cache=T}
#Libraries used in the routine. Dont change the order
rm(list=ls());gc()
#rm(list=c("")
unlink('SUD_CL/Duplicates2_cache', recursive = TRUE)
load("G:/Mi unidad/Alvacast/SISTRAT 2019 (github)/4.Rdata")
local({r <- getOption("repos")
       r["CRAN"] <- "http://cran.r-project.org" 
       options(repos=r)
})
#https://github.com/RevolutionAnalytics/checkpoint
#if(!require(checkpoint)){install.packages("checkpoint")}
#if(!require(here)){install.packages("here")}
#checkpoint::checkpoint("2020-02-19",project=here::here(),checkpointLocation=paste0(here::here(),"/dedup"), use.lock=F, use.knitr=T, auto.install.knitr = T,scan.rnw.with.knitr=T, forceInstall=T,scanForPackages = TRUE)
#checkpointArchives(tempdir(), full.names = TRUE)

#if(!require(tidyr)){install.packages("tidyr")}
#if(!require(DataExplorer)){install.packages("DataExplorer")}
#if(!require(stringi)){install.packages("stringi")}
#if(!require(stringr)){install.packages("stringr")}
#if(!require(ggplot2)){install.packages("ggplot2")}
#if(!require(Hmisc)){install.packages("Hmisc")}
#if(!require(kableExtra)){install.packages("kableExtra")}
#if(!require(plotly)){install.packages("plotly")}
#if(!require(rbokeh)){install.packages("rbokeh")}
#if(!require(altair)){install.packages("altair")}
#if(!require(zoo)){install.packages("zoo")}
#if(!require(codebook)){install.packages("codebook")}
#if(!require(broom)){install.packages("broom")}
#if(!require(sqldf)){install.packages("sqldf")} 
#if(!require(devtools)){install.packages("devtools")}
#if(!require(Statamarkdown)){install_github("hemken/Statamarkdown")}
#if(!require(data.table)){install.packages("data.table")}
#if(!require(dplyr)){install.packages("dplyr")}
library(knitr)
library(tidyr)
library(stringi)
library(stringr)
library(ggplot2)
library(Hmisc)
library(kableExtra)
library(plotly)
library(rbokeh)
library(altair)
library(zoo)
library(broom)
library(sqldf)
library(devtools)
library(Statamarkdown)
library(codebook)
library(data.table)
library(dplyr)
```

<!--- SÍ O SÍ, HACER LA LIMPIEZA DE LOS SENDA NO, PRINCIPALMENTE DE LOS QUE SE SUPERPONGAN, TAMBIÉN PREGUNTAR A ACC SI LOS CON 0 DÍAS DE TRATAMIENTO SE BORRARÁN O NO; DE AHI EMPEZAR A NORMALIZAR LOS PROGRAMAS Y PLANES DE ACUERDO CON CRITERIOS MAUREEN, PARA NO GENERAR DIFERENCIAS AHI Y PODER DEDUPLICAR TRANQUILO --->

<!--- tipo_centro, convertir en factor 1. Privado, 2. Público; DataExplorer::create_report(CONS_1_4)  --->

## 0. Raw Deduplication

&nbsp;
<br>
For the purpose of this page, we use the terms "rows" and "cases" as equal to refer to the entries of the dataset. In many of the processes made along the deduplication of entries in C1 dataset, we used unstandardized columns or many other data that was in fact duplicated by HASHs, that did not depend on events related to treatment. In order to find and delete duplicated data that does not add information relevant for the purposes of the study, we now may **use these standardized variables as a criteria to achieve the goal of having a unique event per HASH, by reducing its complexity based on irrelevant differences**.
<br>

### 0.a. Different Information Within User, Concerning Personal Information

C

- Sex (sexo) (`r CONS_C1_df_dup_ENE_2020 %>% dplyr::group_by(HASH_KEY) %>% dplyr::mutate(sexo_por_hash=dplyr::n_distinct(sexo)) %>% ungroup() %>% dplyr::filter(sexo_por_hash>1) %>% nrow() %>%  formatC(, format="f", big.mark=",", digits=0)`)
<!--- considerar la identidad de género  --->

```{r pers_info_sex, echo=T, paged.print=TRUE}
CONS_C1_df_dup_ENE_2020_sex <- CONS_C1_df_dup_ENE_2020 %>% group_by(HASH_KEY) %>% dplyr::mutate(sexo_por_hash=n_distinct(sexo)) %>% ungroup() %>% dplyr::filter(sexo_por_hash>1) %>% dplyr::distinct(HASH_KEY)
CONS_C1_df_dup_ENE_2020 %>% 
 dplyr::filter(HASH_KEY %in% as.character(as.vector(unlist(as.data.table(unlist(CONS_C1_df_dup_ENE_2020_sex)))))) %>% # Select HASHs of cited cases
 dplyr::arrange(HASH_KEY) %>% #ordeno por ids 
dplyr::select(row, HASH_KEY, ano_bd, sexo, identidad.de.genero,Edad_al_ing, fech_ing, fech_egres, tipo_de_plan, SENDA)%>%
    knitr::kable(.,format = "html", format.args = list(decimal.mark = ".", big.mark = ","),
               caption="Table 1. HASHs with more than one Sex",
                 align =rep('c', 101))  %>%
   kableExtra::kable_styling(bootstrap_options = c("striped", "hover"),font_size = 8) %>%
  kableExtra::scroll_box(width = "100%", height = "375px")
#_______________________
###PARA HACER LA CONVERSION
#_______________________
#CONS_C1_df_dup_ENE_2020 %>%
#    #dplyr::filter(HASH_KEY %in% as.character(as.vector(unlist(as.data.table(unlist(CONS_C1_df_dup_ENE_2020_sex)))))) %>% 
#    dplyr::mutate(concat_hash_sex=paste0(HASH_KEY,"_",sexo)) %>%
#    dplyr::group_by(concat_hash_sex) %>%
#    dplyr::add_tally() %>% 
#    dplyr::ungroup() %>%  
#    dplyr::select(HASH_KEY,id, id_mod, ano_bd, Edad, fech_nac,ano_nac,n) %>%
#    dplyr::group_by(HASH_KEY) %>% #primero genero la variable
#    dplyr::slice(which.max(n))%>% 
#    #dplyr::filter(HASH_KEY=="00a8e1377935f1639a28faa9c11ee03a")
#    assign("CONS_C1_df_dup_ENE_2020_most_frequent_age_dataset",., envir = .GlobalEnv)
#CONS_C1_df_dup_ENE_2020_prev4 %>%
    #dplyr::filter(HASH_KEY %in% as.character(as.vector(unlist(as.data.table(unlist(CONS_C1_df_dup_ENE_2020_sex)))))) %>% 
#    dplyr::select(HASH_KEY,id,id_mod, ano_bd, Sexo, Edad_al_ing) %>%
#    dplyr::group_by(HASH_KEY) %>% #primero genero la variable
#    dplyr::slice(which.max(ano_bd))%>%
#    assign("CONS_C1_df_dup_ENE_2020_max_age",., envir = .GlobalEnv) 
    #dplyr::filter(HASH_KEY=="00012586ea3036b7a18093c396847a87")
```

- Masked SENDAs ID (id_mod) (`r CONS_C1_df_dup_ENE_2020 %>% group_by(HASH_KEY) %>% dplyr::mutate(id_mod_por_hash=n_distinct(id_mod)) %>% ungroup() %>% dplyr::filter(id_mod_por_hash>1) %>% nrow() %>%  formatC(, format="f", big.mark=",", digits=0)`)
- SENDAs ID (id) (`r CONS_C1_df_dup_ENE_2020 %>% group_by(HASH_KEY) %>% dplyr::mutate(id_por_hash=n_distinct(id)) %>% ungroup() %>% dplyr::filter(id_por_hash>1) %>% nrow() %>%  formatC(, format="f", big.mark=",", digits=0)`)

<!--- considerar la fecha de nacimiento y el sexo--->

```{r pers_info_id, echo=T, paged.print=TRUE}
CONS_C1_df_dup_ENE_2020_ids <- CONS_C1_df_dup_ENE_2020 %>% group_by(HASH_KEY) %>% dplyr::mutate(id_por_hash=n_distinct(id)) %>% ungroup() %>% dplyr::filter(id_por_hash>1) %>% dplyr::distinct(HASH_KEY)
CONS_C1_df_dup_ENE_2020 %>% 
 dplyr::filter(HASH_KEY %in% as.character(as.vector(unlist(as.data.table(unlist(CONS_C1_df_dup_ENE_2020_ids)))))) %>% # Select HASHs of cited cases
 dplyr::arrange(HASH_KEY) %>% #ordeno por ids 
dplyr::select(row, HASH_KEY, ano_bd, id_mod, sexo, fech_nac,Edad_al_ing, fech_ing, fech_egres, tipo_de_plan, SENDA)%>%
    knitr::kable(.,format = "html", format.args = list(decimal.mark = ".", big.mark = ","),
               caption="Table 2. HASHs with more than one ID",
                 align =rep('c', 101))  %>%
   kableExtra::kable_styling(bootstrap_options = c("striped", "hover"),font_size = 8) %>%
  kableExtra::scroll_box(width = "100%", height = "375px")
#_______________________
###PARA HACER LA CONVERSION
#_______________________
#CONS_C1_df_dup_ENE_2020 %>%
#    #dplyr::filter(HASH_KEY %in% as.character(as.vector(unlist(as.data.table(unlist(CONS_C1_df_dup_ENE_2020_ids)))))) %>% 
#    dplyr::mutate(concat_hash_id=paste0(HASH_KEY,"_",id)) %>%
#    dplyr::group_by(concat_hash_id) %>%
#    dplyr::add_tally() %>% 
#    dplyr::ungroup() %>%  
#    dplyr::select(HASH_KEY,id, id_mod, ano_bd, Edad, fech_nac,ano_nac,n) %>%
#    dplyr::group_by(HASH_KEY) %>% #primero genero la variable
#    dplyr::slice(which.max(n))%>% 
#    #dplyr::filter(HASH_KEY=="00a8e1377935f1639a28faa9c11ee03a")
#    assign("CONS_C1_df_dup_ENE_2020_most_frequent_age_dataset",., envir = .GlobalEnv)
#CONS_C1_df_dup_ENE_2020_prev4 %>%
    #dplyr::filter(HASH_KEY %in% as.character(as.vector(unlist(as.data.table(unlist(CONS_C1_df_dup_ENE_2020_ids)))))) %>% 
#    dplyr::select(HASH_KEY,id,id_mod, ano_bd, Sexo, Edad_al_ing) %>%
#    dplyr::group_by(HASH_KEY) %>% #primero genero la variable
#    dplyr::slice(which.max(ano_bd))%>%
#    assign("CONS_C1_df_dup_ENE_2020_max_age",., envir = .GlobalEnv) 
    #dplyr::filter(HASH_KEY=="00012586ea3036b7a18093c396847a87")
```

- Year of Birth (ano_nac) (`r CONS_C1_df_dup_ENE_2020 %>% group_by(HASH_KEY) %>% dplyr::mutate(ano_nac_por_hash=n_distinct(ano_nac)) %>% ungroup() %>% dplyr::filter(ano_nac_por_hash>1) %>% nrow() %>%  formatC(, format="f", big.mark=",", digits=0)`)

```{r pers_info_ano_nac, echo=T, paged.print=TRUE}
CONS_C1_df_dup_ENE_2020_ano_nac <- CONS_C1_df_dup_ENE_2020 %>% group_by(HASH_KEY) %>% dplyr::mutate(ano_nac_por_hash=n_distinct(ano_nac)) %>% ungroup() %>% dplyr::filter(ano_nac_por_hash>1) %>% dplyr::distinct(HASH_KEY)
CONS_C1_df_dup_ENE_2020 %>% 
 dplyr::filter(HASH_KEY %in% as.character(as.vector(unlist(as.data.table(unlist(CONS_C1_df_dup_ENE_2020_ano_nac)))))) %>% # Select HASHs of cited cases
 dplyr::arrange(HASH_KEY) %>% #ordeno por ids 
dplyr::select(row, HASH_KEY, ano_bd, id_mod, sexo, fech_nac,Edad_al_ing, fech_ing, fech_egres, tipo_de_plan, SENDA)%>%
    knitr::kable(.,format = "html", format.args = list(decimal.mark = ".", big.mark = ","),
               caption="Table 3. HASHs with more than one Year of Birth",
                 align =rep('c', 101))  %>%
   kableExtra::kable_styling(bootstrap_options = c("striped", "hover"),font_size = 8) %>%
  kableExtra::scroll_box(width = "100%", height = "375px")
#_______________________
###PARA HACER LA CONVERSION
#_______________________
#CONS_C1_df_dup_ENE_2020 %>%
#    #dplyr::filter(HASH_KEY %in% as.character(as.vector(unlist(as.data.table(unlist(CONS_C1_df_dup_ENE_2020_ano_nac)))))) %>% 
#    dplyr::mutate(concat_hash_id=paste0(HASH_KEY,"_",id)) %>%
#    dplyr::group_by(concat_hash_id) %>%
#    dplyr::add_tally() %>% 
#    dplyr::ungroup() %>%  
#    dplyr::select(HASH_KEY,id, id_mod, ano_bd, Edad, fech_nac,ano_nac,n) %>%
#    dplyr::group_by(HASH_KEY) %>% #primero genero la variable
#    dplyr::slice(which.max(n))%>% 
#    #dplyr::filter(HASH_KEY=="00a8e1377935f1639a28faa9c11ee03a")
#    assign("CONS_C1_df_dup_ENE_2020_most_frequent_age_dataset",., envir = .GlobalEnv)
#CONS_C1_df_dup_ENE_2020_prev4 %>%
    #dplyr::filter(HASH_KEY %in% as.character(as.vector(unlist(as.data.table(unlist(CONS_C1_df_dup_ENE_2020_ano_nac)))))) %>% 
#    dplyr::select(HASH_KEY,id,id_mod, ano_bd, Sexo, Edad_al_ing) %>%
#    dplyr::group_by(HASH_KEY) %>% #primero genero la variable
#    dplyr::slice(which.max(ano_bd))%>%
#    assign("CONS_C1_df_dup_ENE_2020_max_age",., envir = .GlobalEnv) 
    #dplyr::filter(HASH_KEY=="00012586ea3036b7a18093c396847a87")
```

- Nationallity (Nacionalidad) (`r CONS_C1_df_dup_ENE_2020 %>% group_by(HASH_KEY) %>% dplyr::mutate(Nacionalidad_por_hash=n_distinct(Nacionalidad)) %>% ungroup() %>% dplyr::filter(Nacionalidad_por_hash>1) %>% nrow() %>%  formatC(, format="f", big.mark=",", digits=0)`)

```{r pers_info_nationallity, echo=T, paged.print=TRUE}
CONS_C1_df_dup_ENE_2020_nat <- CONS_C1_df_dup_ENE_2020 %>% group_by(HASH_KEY) %>% dplyr::mutate(nat_por_hash=n_distinct(Nacionalidad)) %>% ungroup() %>% dplyr::filter(nat_por_hash>1) %>% dplyr::distinct(HASH_KEY)
CONS_C1_df_dup_ENE_2020 %>% 
 dplyr::filter(HASH_KEY %in% as.character(as.vector(unlist(as.data.table(unlist(CONS_C1_df_dup_ENE_2020_nat)))))) %>% # Select HASHs of cited cases
 dplyr::arrange(HASH_KEY) %>% #ordeno por ids 
dplyr::select(row, HASH_KEY, ano_bd, Nacionalidad, Etnia, sexo, fech_nac,Edad_al_ing, fech_ing, fech_egres, tipo_de_plan, SENDA)%>%
    knitr::kable(.,format = "html", format.args = list(decimal.mark = ".", big.mark = ","),
               caption="Table 4. HASHs with more than one Nationallity",
                 align =rep('c', 101))  %>%
   kableExtra::kable_styling(bootstrap_options = c("striped", "hover"),font_size = 8) %>%
  kableExtra::scroll_box(width = "100%", height = "375px")
#_______________________
###PARA HACER LA CONVERSION
#_______________________
#CONS_C1_df_dup_ENE_2020 %>%
#    #dplyr::filter(HASH_KEY %in% as.character(as.vector(unlist(as.data.table(unlist(CONS_C1_df_dup_ENE_2020_nat)))))) %>% 
#    dplyr::mutate(concat_hash_id=paste0(HASH_KEY,"_",id)) %>%
#    dplyr::group_by(concat_hash_id) %>%
#    dplyr::add_tally() %>% 
#    dplyr::ungroup() %>%  
#    dplyr::select(HASH_KEY,id, id_mod, ano_bd, Edad, fech_nac,ano_nac,n) %>%
#    dplyr::group_by(HASH_KEY) %>% #primero genero la variable
#    dplyr::slice(which.max(n))%>% 
#    #dplyr::filter(HASH_KEY=="00a8e1377935f1639a28faa9c11ee03a")
#    assign("CONS_C1_df_dup_ENE_2020_most_frequent_age_dataset",., envir = .GlobalEnv)
#CONS_C1_df_dup_ENE_2020_prev4 %>%
    #dplyr::filter(HASH_KEY %in% as.character(as.vector(unlist(as.data.table(unlist(CONS_C1_df_dup_ENE_2020_nat)))))) %>% 
#    dplyr::select(HASH_KEY,id,id_mod, ano_bd, Sexo, Edad_al_ing) %>%
#    dplyr::group_by(HASH_KEY) %>% #primero genero la variable
#    dplyr::slice(which.max(ano_bd))%>%
#    assign("CONS_C1_df_dup_ENE_2020_max_age",., envir = .GlobalEnv) 
    #dplyr::filter(HASH_KEY=="00012586ea3036b7a18093c396847a87")
```

- Ethnicity (Etnia) (`r CONS_C1_df_dup_ENE_2020 %>% group_by(HASH_KEY) %>% dplyr::mutate(Etnia_por_hash=n_distinct(Etnia)) %>% ungroup() %>% dplyr::filter(Etnia_por_hash>1) %>% nrow() %>%  formatC(, format="f", big.mark=",", digits=0)`)

```{r pers_info_etnia, echo=T, paged.print=TRUE}
CONS_C1_df_dup_ENE_2020_etnia <- CONS_C1_df_dup_ENE_2020 %>% group_by(HASH_KEY) %>% dplyr::mutate(etnia_por_hash=n_distinct(Etnia)) %>% ungroup() %>% dplyr::filter(etnia_por_hash>1) %>% dplyr::distinct(HASH_KEY)
CONS_C1_df_dup_ENE_2020 %>% 
 dplyr::filter(HASH_KEY %in% as.character(as.vector(unlist(as.data.table(unlist(CONS_C1_df_dup_ENE_2020_etnia)))))) %>% # Select HASHs of cited cases
 dplyr::arrange(HASH_KEY) %>% #ordeno por ids 
dplyr::select(row, HASH_KEY, ano_bd, Nacionalidad, Etnia, sexo, fech_nac,Edad_al_ing, fech_ing, fech_egres, tipo_de_plan, SENDA)%>%
    knitr::kable(.,format = "html", format.args = list(decimal.mark = ".", big.mark = ","),
               caption="Table 5. HASHs with more than one Ethnicity",
                 align =rep('c', 101))  %>%
   kableExtra::kable_styling(bootstrap_options = c("striped", "hover"),font_size = 8) %>%
  kableExtra::scroll_box(width = "100%", height = "375px")
#_______________________
###PARA HACER LA CONVERSION
#_______________________
#CONS_C1_df_dup_ENE_2020 %>%
#    #dplyr::filter(HASH_KEY %in% as.character(as.vector(unlist(as.data.table(unlist(CONS_C1_df_dup_ENE_2020_nat)))))) %>% 
#    dplyr::mutate(concat_hash_id=paste0(HASH_KEY,"_",id)) %>%
#    dplyr::group_by(concat_hash_id) %>%
#    dplyr::add_tally() %>% 
#    dplyr::ungroup() %>%  
#    dplyr::select(HASH_KEY,id, id_mod, ano_bd, Edad, fech_nac,ano_nac,n) %>%
#    dplyr::group_by(HASH_KEY) %>% #primero genero la variable
#    dplyr::slice(which.max(n))%>% 
#    #dplyr::filter(HASH_KEY=="00a8e1377935f1639a28faa9c11ee03a")
#    assign("CONS_C1_df_dup_ENE_2020_most_frequent_age_dataset",., envir = .GlobalEnv)
#CONS_C1_df_dup_ENE_2020_prev4 %>%
    #dplyr::filter(HASH_KEY %in% as.character(as.vector(unlist(as.data.table(unlist(CONS_C1_df_dup_ENE_2020_nat)))))) %>% 
#    dplyr::select(HASH_KEY,id,id_mod, ano_bd, Sexo, Edad_al_ing) %>%
#    dplyr::group_by(HASH_KEY) %>% #primero genero la variable
#    dplyr::slice(which.max(ano_bd))%>%
#    assign("CONS_C1_df_dup_ENE_2020_max_age",., envir = .GlobalEnv) 
    #dplyr::filter(HASH_KEY=="00012586ea3036b7a18093c396847a87")
```

<!--- La fecha de nacimiento puede no haberse corregido del todo porque hay muchos casos en que no tienen una edad distinta, por lo que el programa no  los filtra  --->
- Age of Birth (fech_nac) (`r CONS_C1_df_dup_ENE_2020 %>% group_by(HASH_KEY) %>% dplyr::mutate(fech_nac_por_hash=n_distinct(fech_nac)) %>% ungroup() %>% dplyr::filter(fech_nac_por_hash>1) %>% nrow() %>%  formatC(, format="f", big.mark=",", digits=0)`)

```{r pers_info_fech_nac, echo=T, paged.print=TRUE}
CONS_C1_df_dup_ENE_2020_fech_nac <- CONS_C1_df_dup_ENE_2020 %>% group_by(HASH_KEY) %>% dplyr::mutate(fech_nac_por_hash=n_distinct(fech_nac)) %>% ungroup() %>% dplyr::filter(fech_nac_por_hash>1) %>% dplyr::distinct(HASH_KEY)
CONS_C1_df_dup_ENE_2020 %>% 
 dplyr::filter(HASH_KEY %in% as.character(as.vector(unlist(as.data.table(unlist(CONS_C1_df_dup_ENE_2020_fech_nac)))))) %>% # Select HASHs of cited cases
 dplyr::arrange(HASH_KEY) %>% #ordeno por ids 
dplyr::select(row, HASH_KEY, ano_bd, id_mod, sexo, fech_nac,Edad_al_ing, fech_ing, fech_egres, tipo_de_plan, SENDA)%>%
    knitr::kable(.,format = "html", format.args = list(decimal.mark = ".", big.mark = ","),
               caption="Table 6. HASHs with more than one Date of Birth",
                 align =rep('c', 101))  %>%
   kableExtra::kable_styling(bootstrap_options = c("striped", "hover"),font_size = 8) %>%
  kableExtra::scroll_box(width = "100%", height = "375px")
#_______________________
###PARA HACER LA CONVERSION
#_______________________
#CONS_C1_df_dup_ENE_2020 %>%
#    #dplyr::filter(HASH_KEY %in% as.character(as.vector(unlist(as.data.table(unlist(CONS_C1_df_dup_ENE_2020_nat)))))) %>% 
#    dplyr::mutate(concat_hash_id=paste0(HASH_KEY,"_",id)) %>%
#    dplyr::group_by(concat_hash_id) %>%
#    dplyr::add_tally() %>% 
#    dplyr::ungroup() %>%  
#    dplyr::select(HASH_KEY,id, id_mod, ano_bd, Edad, fech_nac,ano_nac,n) %>%
#    dplyr::group_by(HASH_KEY) %>% #primero genero la variable
#    dplyr::slice(which.max(n))%>% 
#    #dplyr::filter(HASH_KEY=="00a8e1377935f1639a28faa9c11ee03a")
#    assign("CONS_C1_df_dup_ENE_2020_most_frequent_age_dataset",., envir = .GlobalEnv)
#CONS_C1_df_dup_ENE_2020_prev4 %>%
    #dplyr::filter(HASH_KEY %in% as.character(as.vector(unlist(as.data.table(unlist(CONS_C1_df_dup_ENE_2020_nat)))))) %>% 
#    dplyr::select(HASH_KEY,id,id_mod, ano_bd, Sexo, Edad_al_ing) %>%
#    dplyr::group_by(HASH_KEY) %>% #primero genero la variable
#    dplyr::slice(which.max(ano_bd))%>%
#    assign("CONS_C1_df_dup_ENE_2020_max_age",., envir = .GlobalEnv) 
    #dplyr::filter(HASH_KEY=="00012586ea3036b7a18093c396847a87")
```

- Age of Onset of Drug Use (edad_ini_cons) (`r CONS_C1_df_dup_ENE_2020 %>% group_by(HASH_KEY) %>% dplyr::mutate(edad_ini_cons_por_hash=n_distinct(edad_ini_cons)) %>% ungroup() %>% dplyr::filter(edad_ini_cons_por_hash>1) %>% nrow() %>%  formatC(, format="f", big.mark=",", digits=0)`)

```{r pers_info_edad_ini_cons, echo=T, paged.print=TRUE}
CONS_C1_df_dup_ENE_2020_edad_ini_cons <- CONS_C1_df_dup_ENE_2020 %>% group_by(HASH_KEY) %>% dplyr::mutate(edad_ini_cons_por_hash=n_distinct(edad_ini_cons)) %>% ungroup() %>% dplyr::filter(edad_ini_cons_por_hash>1) %>% dplyr::distinct(HASH_KEY)
CONS_C1_df_dup_ENE_2020 %>% 
 dplyr::filter(HASH_KEY %in% as.character(as.vector(unlist(as.data.table(unlist(CONS_C1_df_dup_ENE_2020_edad_ini_cons)))))) %>% # Select HASHs of cited cases
 dplyr::arrange(HASH_KEY) %>% #ordeno por ids 
dplyr::select(row, HASH_KEY, ano_bd, edad_ini_cons, sexo, fech_nac,Edad_al_ing, fech_ing, fech_egres, tipo_de_plan, SENDA)%>%
    knitr::kable(.,format = "html", format.args = list(decimal.mark = ".", big.mark = ","),
               caption="Table 7. HASHs with more than one Age of Onset of Drug Use",
                 align =rep('c', 101))  %>%
   kableExtra::kable_styling(bootstrap_options = c("striped", "hover"),font_size = 8) %>%
  kableExtra::scroll_box(width = "100%", height = "375px")
#_______________________
###PARA HACER LA CONVERSION
#_______________________
#CONS_C1_df_dup_ENE_2020 %>%
#    #dplyr::filter(HASH_KEY %in% as.character(as.vector(unlist(as.data.table(unlist(CONS_C1_df_dup_ENE_2020_nat)))))) %>% 
#    dplyr::mutate(concat_hash_id=paste0(HASH_KEY,"_",id)) %>%
#    dplyr::group_by(concat_hash_id) %>%
#    dplyr::add_tally() %>% 
#    dplyr::ungroup() %>%  
#    dplyr::select(HASH_KEY,id, id_mod, ano_bd, Edad, fech_nac,ano_nac,n) %>%
#    dplyr::group_by(HASH_KEY) %>% #primero genero la variable
#    dplyr::slice(which.max(n))%>% 
#    #dplyr::filter(HASH_KEY=="00a8e1377935f1639a28faa9c11ee03a")
#    assign("CONS_C1_df_dup_ENE_2020_most_frequent_age_dataset",., envir = .GlobalEnv)
#CONS_C1_df_dup_ENE_2020_prev4 %>%
    #dplyr::filter(HASH_KEY %in% as.character(as.vector(unlist(as.data.table(unlist(CONS_C1_df_dup_ENE_2020_nat)))))) %>% 
#    dplyr::select(HASH_KEY,id,id_mod, ano_bd, Sexo, Edad_al_ing) %>%
#    dplyr::group_by(HASH_KEY) %>% #primero genero la variable
#    dplyr::slice(which.max(ano_bd))%>%
#    assign("CONS_C1_df_dup_ENE_2020_max_age",., envir = .GlobalEnv) 
    #dplyr::filter(HASH_KEY=="00012586ea3036b7a18093c396847a87")
```

- Age of Onset of Drug Use Principal Substance (edad_ini_sus_prin) (`r CONS_C1_df_dup_ENE_2020 %>% group_by(HASH_KEY) %>% dplyr::mutate(edad_ini_sus_prin_por_hash=n_distinct(edad_ini_sus_prin)) %>% ungroup() %>% dplyr::filter(edad_ini_sus_prin_por_hash>1) %>% nrow() %>%  formatC(, format="f", big.mark=",", digits=0)`)
<!--- considerar que no sea mayor a la edad de inicio de consumo --->

```{r pers_info_edad_ini_sus_prin, echo=T, paged.print=TRUE}
CONS_C1_df_dup_ENE_2020_edad_ini_sus_prin <- CONS_C1_df_dup_ENE_2020 %>% group_by(HASH_KEY) %>% dplyr::mutate(edad_ini_sus_prin_por_hash=n_distinct(edad_ini_sus_prin)) %>% ungroup() %>% dplyr::filter(edad_ini_sus_prin_por_hash>1) %>% dplyr::distinct(HASH_KEY)
CONS_C1_df_dup_ENE_2020 %>% 
 dplyr::filter(HASH_KEY %in% as.character(as.vector(unlist(as.data.table(unlist(CONS_C1_df_dup_ENE_2020_edad_ini_sus_prin)))))) %>% # Select HASHs of cited cases
 dplyr::arrange(HASH_KEY) %>% #ordeno por ids 
dplyr::select(row, HASH_KEY, ano_bd, edad_ini_cons,edad_ini_cons, sexo, fech_nac,Edad_al_ing, fech_ing, fech_egres, tipo_de_plan, SENDA)%>%
    knitr::kable(.,format = "html", format.args = list(decimal.mark = ".", big.mark = ","),
               caption="Table 8. HASHs with more than one Age of Onset of Drug Use Principal Substance",
                 align =rep('c', 101))  %>%
   kableExtra::kable_styling(bootstrap_options = c("striped", "hover"),font_size = 8) %>%
  kableExtra::scroll_box(width = "100%", height = "375px")
#_______________________
###PARA HACER LA CONVERSION
#_______________________
#CONS_C1_df_dup_ENE_2020 %>%
#    #dplyr::filter(HASH_KEY %in% as.character(as.vector(unlist(as.data.table(unlist(CONS_C1_df_dup_ENE_2020_nat)))))) %>% 
#    dplyr::mutate(concat_hash_id=paste0(HASH_KEY,"_",id)) %>%
#    dplyr::group_by(concat_hash_id) %>%
#    dplyr::add_tally() %>% 
#    dplyr::ungroup() %>%  
#    dplyr::select(HASH_KEY,id, id_mod, ano_bd, Edad, fech_nac,ano_nac,n) %>%
#    dplyr::group_by(HASH_KEY) %>% #primero genero la variable
#    dplyr::slice(which.max(n))%>% 
#    #dplyr::filter(HASH_KEY=="00a8e1377935f1639a28faa9c11ee03a")
#    assign("CONS_C1_df_dup_ENE_2020_most_frequent_age_dataset",., envir = .GlobalEnv)
#CONS_C1_df_dup_ENE_2020_prev4 %>%
    #dplyr::filter(HASH_KEY %in% as.character(as.vector(unlist(as.data.table(unlist(CONS_C1_df_dup_ENE_2020_nat)))))) %>% 
#    dplyr::select(HASH_KEY,id,id_mod, ano_bd, Sexo, Edad_al_ing) %>%
#    dplyr::group_by(HASH_KEY) %>% #primero genero la variable
#    dplyr::slice(which.max(ano_bd))%>%
#    assign("CONS_C1_df_dup_ENE_2020_max_age",., envir = .GlobalEnv) 
    #dplyr::filter(HASH_KEY=="00012586ea3036b7a18093c396847a87")
```

- Starting Substance (sus_ini) (`r CONS_C1_df_dup_ENE_2020 %>% group_by(HASH_KEY) %>% dplyr::mutate(sus_ini_por_hash=n_distinct(sus_ini)) %>% ungroup() %>% dplyr::filter(sus_ini_por_hash>1) %>% nrow() %>%  formatC(, format="f", big.mark=",", digits=0)`)
<!--- considerar que no sea mayor a la edad de inicio de consumo --->

```{r pers_info_sus_ini, echo=T, paged.print=TRUE}
CONS_C1_df_dup_ENE_2020_sus_ini <- CONS_C1_df_dup_ENE_2020 %>% group_by(HASH_KEY) %>% dplyr::mutate(sus_ini_por_hash=n_distinct(sus_ini)) %>% ungroup() %>% dplyr::filter(sus_ini_por_hash>1) %>% dplyr::distinct(HASH_KEY)
CONS_C1_df_dup_ENE_2020 %>% 
 dplyr::filter(HASH_KEY %in% as.character(as.vector(unlist(as.data.table(unlist(CONS_C1_df_dup_ENE_2020_sus_ini)))))) %>% # Select HASHs of cited cases
 dplyr::arrange(HASH_KEY) %>% #ordeno por ids 
dplyr::select(row, HASH_KEY, ano_bd, sus_ini, edad_ini_cons,edad_ini_cons, sexo, fech_nac,Edad_al_ing, fech_ing, fech_egres, tipo_de_plan, SENDA)%>%
    knitr::kable(.,format = "html", format.args = list(decimal.mark = ".", big.mark = ","),
               caption="Table 9. HASHs with more than one Starting Substance",
                 align =rep('c', 101))  %>%
   kableExtra::kable_styling(bootstrap_options = c("striped", "hover"),font_size = 8) %>%
  kableExtra::scroll_box(width = "100%", height = "375px")
#_______________________
###PARA HACER LA CONVERSION
#_______________________
#CONS_C1_df_dup_ENE_2020 %>%
#    #dplyr::filter(HASH_KEY %in% as.character(as.vector(unlist(as.data.table(unlist(CONS_C1_df_dup_ENE_2020_nat)))))) %>% 
#    dplyr::mutate(concat_hash_id=paste0(HASH_KEY,"_",id)) %>%
#    dplyr::group_by(concat_hash_id) %>%
#    dplyr::add_tally() %>% 
#    dplyr::ungroup() %>%  
#    dplyr::select(HASH_KEY,id, id_mod, ano_bd, Edad, fech_nac,ano_nac,n) %>%
#    dplyr::group_by(HASH_KEY) %>% #primero genero la variable
#    dplyr::slice(which.max(n))%>% 
#    #dplyr::filter(HASH_KEY=="00a8e1377935f1639a28faa9c11ee03a")
#    assign("CONS_C1_df_dup_ENE_2020_most_frequent_age_dataset",., envir = .GlobalEnv)
#CONS_C1_df_dup_ENE_2020_prev4 %>%
    #dplyr::filter(HASH_KEY %in% as.character(as.vector(unlist(as.data.table(unlist(CONS_C1_df_dup_ENE_2020_nat)))))) %>% 
#    dplyr::select(HASH_KEY,id,id_mod, ano_bd, Sexo, Edad_al_ing) %>%
#    dplyr::group_by(HASH_KEY) %>% #primero genero la variable
#    dplyr::slice(which.max(ano_bd))%>%
#    assign("CONS_C1_df_dup_ENE_2020_max_age",., envir = .GlobalEnv) 
    #dplyr::filter(HASH_KEY=="00012586ea3036b7a18093c396847a87")
```

&nbsp;
<br>

### 0.b. Deduplication based on standardized columns of interest for the study

First, we selected the following standardized variables as a criteria to identify duplicated treatments per user:

- Masked Identifier (HASH_KEY)
- Date of Admission to Treatment (fech_ing)
- Center ID (ID.centro)
- Main Substance of Consumption (sus_principal)
- Other Substances (1) (otras_sus1)
- Other Substances (2) (otras_sus2)
- Other Substances (3) (otras_sus3)
- Starting Substance (sus_ini)
- Age of Onset of Drug Use (edad_ini_cons)
- Marital Status (estado_conyugal)
- Occupational Status (estatus_ocupacional)
- Occupational Category (cat_ocupacional)
- Age in groups (Edad_grupos)
- Motive of Admission to Treatment (origen_ingreso)
- Education Attainment (escolaridad)
- Route of Administration of the Main Substance (via_adm_sus_prin)
- Frequency of Consumption of the Main Substance (freq_cons_sus_prin)

```{r dedup_manual, echo=T, paged.print=TRUE}
require(data.table)
names_c1_stage3 <- c("HASH_KEY","fech_ing", "ID.centro", "sus_principal", "otras_sus1","otras_sus2","otras_sus3","sus_ini","edad_ini_cons", "estado_conyugal","estatus_ocupacional","cat_ocupacional","Edad_grupos","origen_ingreso", "escolaridad","via_adm_sus_prin", "freq_cons_sus_prin")

require(dplyr)
data.table::data.table(CONS_C1_df_dup_ENE_2020) %>%
  dplyr::arrange(desc(ano_bd),HASH_KEY, desc(fech_ing), desc(fech_egres),dias_trat_inv) %>%
  dplyr::distinct_(.dots = names_c1_stage3, .keep_all = TRUE) %>%
#  dplyr::arrange(HASH_KEY, fech_ing, desc(ano_bd)) %>%
  data.table::as.data.table() %>% #para contar las filas
 # dplyr::select(row) %>%  summarise(mean(row), sd(row)) #, lo mismo que en STATA. Se supone que una row es sensible a cambios distintos.
  assign("CONS_C1_df_dup_FEB_2020_prev1",.,envir = .GlobalEnv)
#Lo mismo que en STATA: Ahora hay 118,072. Una vez que introduje 
#Ahora, 118035
#  dplyr::arrange(HASH_KEY, fech_ing, desc(ano_bd), desc(fech_egres)) %>% criterio anterior
```

<br>

Once exact matches were discarded, we ended having `r nrow(CONS_C1_df_dup_FEB_2020_prev1) %>% formatC(, format="f", big.mark=",", digits=0)` cases.

<br>


```{r dedup_analisis_manual, echo=T, include=F, paged.print=TRUE}
#Tengo que llegar a este número
###117,619
criterios<-c('HASH_KEY', 'id', 'tipo_centro', 'Región.del.Centro', 'dias_trat', 
  'Edad', 'Nacionalidad', 'Etnia', 'Diagnóstico.Trs..Psiquiátrico.DSM.IV', 'Diagnóstico.Trs..Psiquiátrico.SUB.DSM.IV', 
  'X2.Diagnóstico.Trs..Psiquiátrico.DSM.IV', 'X2.Diagnóstico.Trs..Psiquiátrico.SUB.DSM.IV', 
  'X3.Diagnóstico.Trs..Psiquiátrico.DSM.IV', 'X3.Diagnóstico.Trs..Psiquiátrico.SUB.DSM.IV', 
  'Diagnóstico.Trs..Psiquiátrico.CIE.10', 'Diagnóstico.Trs..Psiquiátrico.SUB.CIE.10', 
  'X2.Diagnóstico.Trs..Psiquiátrico.CIE.10', 'X2.Diagnóstico.Trs..Psiquiátrico.SUB.CIE.10', 
  'X3.Diagnóstico.Trs..Psiquiátrico.CIE.10', 'X3.Diagnóstico.Trs..Psiquiátrico.SUB.CIE.10', 'fech_ing', 'fech_egres', 
  'motivodeegreso', 'ID.centro', 'identidad.de.genero', 'sexo', 'embarazo', 'tipo_de_plan', 'tipo_de_programa', 
  'id_mod', 'ano_nac', 'Edad_al_ing', 'edad_ini_cons', 'edad_ini_sus_prin', 'dias_trat_alta_temprana', 
  'motivodeegreso_mod', 'sus_principal', 'otras_sus1', 'otras_sus2', 'otras_sus3', 'sus_ini', 'estado_conyugal', 
  'estatus_ocupacional', 'cat_ocupacional', 'Edad_grupos', 'origen_ingreso', 'escolaridad', 
  'via_adm_sus_prin', 'freq_cons_sus_prin')

CONS_C1_df_dup_FEB_2020_prev1 %>%
  dplyr::group_by(HASH_KEY, fech_ing) %>% #primero genero la variable
  dplyr::mutate(HASH_fech_ing_reps = n(), HASH_fech_ing_apariciones=row_number()) %>%  #number of different variables by HASH.
  dplyr::ungroup() %>% #desagrupo
  dplyr::filter(HASH_fech_ing_reps>1) %>% #names() %>% copiar_nombres() #para rescatar nombres de la base de datos
  dplyr::group_by(HASH_KEY, fech_ing) %>% #primero genero la variable
  dplyr::mutate_at(vars(c('HASH_KEY', 'id', 'tipo_centro', 'Región.del.Centro', 'dias_trat', 
                   'Edad', 'Nacionalidad', 'Etnia', 'Diagnóstico.Trs..Psiquiátrico.DSM.IV', 'Diagnóstico.Trs..Psiquiátrico.SUB.DSM.IV', 
                   'X2.Diagnóstico.Trs..Psiquiátrico.DSM.IV', 'X2.Diagnóstico.Trs..Psiquiátrico.SUB.DSM.IV', 
                   'X3.Diagnóstico.Trs..Psiquiátrico.DSM.IV', 'X3.Diagnóstico.Trs..Psiquiátrico.SUB.DSM.IV', 
                   'Diagnóstico.Trs..Psiquiátrico.CIE.10', 'Diagnóstico.Trs..Psiquiátrico.SUB.CIE.10', 
                   'X2.Diagnóstico.Trs..Psiquiátrico.CIE.10', 'X2.Diagnóstico.Trs..Psiquiátrico.SUB.CIE.10', 
                   'X3.Diagnóstico.Trs..Psiquiátrico.CIE.10', 'X3.Diagnóstico.Trs..Psiquiátrico.SUB.CIE.10', 'fech_ing', 'fech_egres', 
                   'motivodeegreso', 'ID.centro', 'identidad.de.genero', 'sexo', 'embarazo', 'tipo_de_plan', 'tipo_de_programa', 
                   'id_mod', 'ano_nac', 'Edad_al_ing', 'edad_ini_cons', 'edad_ini_sus_prin', 'dias_trat_alta_temprana', 
                   'motivodeegreso_mod', 'sus_principal', 'otras_sus1', 'otras_sus2', 'otras_sus3', 'sus_ini', 'estado_conyugal', 
                   'estatus_ocupacional', 'cat_ocupacional', 'Edad_grupos', 'origen_ingreso', 'escolaridad', 
                   'via_adm_sus_prin', 'freq_cons_sus_prin')), .funs = list(dups_hash_ing = ~n_distinct(.))) %>%
  dplyr::ungroup() %>%
  dplyr::mutate_at(vars(contains('_dups_hash_ing')), .funs = list(~ifelse(.>1,1,0))) %>% #el ptaje no depende de cuantos duplicados tenga
  dplyr::mutate(n_of_diffs_within = rowSums(select(., contains("_dups_hash_ing")))) %>% 
#  janitor::tabyl(n_of_matches) #para ver cómo se distirbuye
#  dplyr::select(-contains("_dups_hash_ing")) %>% 
#  dplyr::select(,contains("_dups_hash_ing")) %>%
  dplyr::select(c(criterios, contains("_dups_hash_ing"), "ano_bd", "SENDA","HASH_fech_ing_reps", "n_of_diffs_within","HASH_fech_ing_apariciones")) %>%
  dplyr::arrange(n_of_diffs_within, HASH_KEY, desc(ano_bd)) %>% as.data.frame() %>% guardar_tablas("_matches_feb_2020")
#write.csv(.,"_matches_feb_2020.csv", row.names = FALSE)
#anyDuplicated returns the index i of the first duplicated entry if there is one, and 0 otherwise.
 #anyDuplicated(CONS_C1_df_dup_FEB_2020_prev1_dt, by=c("HASH_KEY", "fech_ing"))
```

&nbsp;
<br>
The dataset was configured to find duplicated rows in almost every variable, excepting the row number in the whole consolidated dataset and the year of the dataset in which the row was obtained. For the purpose of this page, we will use the terms "rows" and "cases" as equal to refer to the entries of the dataset.

<br>

```{r image-ref-for-in-text, echo=FALSE, fig.align='center', fig.cap='Some cool caption', fig.pos='H', message=FALSE}
knitr::include_graphics("G:/Mi unidad/Alvacast/SISTRAT 2019 (github)/SUD_CL/Figures/Figure_Duplicates.svg")
```

## 2. Overlap Between Dates of Admission & Discharge

&nbsp;
<br>
The dataset was configured to find duplicated rows in almost every variable, excepting the row number in the whole consolidated dataset and the year of the dataset in which the row was obtained. For the purpose of this page, we will use the terms "rows" and "cases" as equal to refer to the entries of the dataset.

<br>

## 3. Probabilistic Matches

&nbsp;

The code used in stata is shown here:

&nbsp;
<br>

```{stata, collectcode=TRUE}
import delimited "G:\Mi unidad\Alvacast\SISTRAT 2019 (github)\SUD_CL\CONS_C1_df_dup_FEB_2020.csv", delimiter(";") clear 

cap gen date_in = mdy(real_fech_ing_mes, real_fech_ing_dia, real_fech_ing_ano)
cap gen date_in = mdy(fech_ing_mes, fech_ing_dia, fech_ing_ano)

generate id_match = _n
cap drop _id
dtalink hash_key 25 -25 idcentro 10 0 date_in 30 -30 5 Edad 7 -7 escolaridad 8 -8 sexo 10 -10 id 10 -10, block(edad) cutoff(70)
drop if missing(_score)
qui save "G:\Mi unidad\Alvacast\SISTRAT 2019 (github)\Stata Duplicates Match\_CONS_C1_df_match70_2020_02_20.dta", replace
```
<br>

```{r  dta_import, include=T, echo=T, eval=T, cache=T}
matches_from_stata_c1_feb <- haven::read_dta("G:/Mi unidad/Alvacast/SISTRAT 2019 (github)/Stata Duplicates Match/_CONS_C1_df_match70_2020_02_20.dta")
matches_from_stata_c1_feb <-matches_from_stata_c1 %>% dplyr::rename(score = 3, matchID = 1, row_id=2) 
matches_from_stata_c1_feb  %>%
  dplyr::arrange(score,matchID,hash_key) %>%
  dplyr::select(score, matchID, hash_key, ano_bd, idcentro, date_in, fech_ing, fech_egres, edad, dias_trat) %>%
  as.data.frame() %>%
    knitr::kable(.,format = "html", format.args = list(decimal.mark = ".", big.mark = ","),
                   caption="Table 14. Preliminary View of Matches from Stata", align =rep('c', 100)) %>%
     kableExtra::kable_styling(bootstrap_options = c("striped", "hover"),font_size = 8) %>%
    kableExtra::scroll_box(width = "100%", height = "350px")
```
<br>

The dataset was configured to find duplicated rows in almost every variable, excepting the row number in the whole consolidated dataset and the year of the dataset in which the row was obtained. For the purpose of this page, we will use the terms "rows" and "cases" as equal to refer to the entries of the dataset.

<br>
