---
title: "Duplicated/ Repeated Cases in SISTRAT C1 (part 2)"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  html_document:
    code_folding: hide  
    toc: true # table of content true
    toc_depth: 5  # upto three depths of headings (specified by #, ## and ###)
    toc_float: true
---

<style type="text/css">
.tablelines table, .tablelines td, .tablelines th {
        border: 1px solid black;
        }
.centrado {
    text-align: center;
}
.table.center {
    margin-left:auto; 
    margin-right:auto;
  }
.table_wrapper{
    display: block;
    overflow-x: auto;
    white-space: nowrap;
}
code.r{
  font-size: 8px;
}
body{ /* Normal  */
      text-align: justify;
  }
.superbigimage{
    overflow-y:scroll;
    white-space: nowrap;
}
.superbigimage img{
    overflow-y: scroll;
    overflow-x: hidden;
}
</style>

```{r setup, include = FALSE, cache=T}
#Libraries used in the routine. Dont change the order
rm(list=ls());gc()
#rm(list=c("")
unlink('SUD_CL/Duplicates2_cache', recursive = TRUE)
load("G:/Mi unidad/Alvacast/SISTRAT 2019 (github)/4.Rdata")
local({r <- getOption("repos")
       r["CRAN"] <- "http://cran.r-project.org" 
       options(repos=r)
})
#packageVersion("codebook")
#https://github.com/RevolutionAnalytics/checkpoint
#if(!require(checkpoint)){install.packages("checkpoint")}
#if(!require(here)){install.packages("here")}
#checkpoint::checkpoint("2020-02-19",project=here::here(),checkpointLocation=paste0(here::here(),"/dedup"), use.lock=F, use.knitr=T, auto.install.knitr = T,scan.rnw.with.knitr=T, forceInstall=T,scanForPackages = TRUE)
#checkpointArchives(tempdir(), full.names = TRUE)

#if(!require(tidyr)){install.packages("tidyr")}
#if(!require(DataExplorer)){install.packages("DataExplorer")}
#if(!require(stringi)){install.packages("stringi")}
#if(!require(stringr)){install.packages("stringr")}
#if(!require(ggplot2)){install.packages("ggplot2")}
#if(!require(Hmisc)){install.packages("Hmisc")}
#if(!require(kableExtra)){install.packages("kableExtra")}
#if(!require(plotly)){install.packages("plotly")}
#if(!require(rbokeh)){install.packages("rbokeh")}
#if(!require(altair)){install.packages("altair")}
#if(!require(zoo)){install.packages("zoo")}
#if(!require(codebook)){install.packages("codebook")}
#if(!require(broom)){install.packages("broom")}
#if(!require(sqldf)){install.packages("sqldf")} 
#if(!require(devtools)){install.packages("devtools")}
#if(!require(Statamarkdown)){install_github("hemken/Statamarkdown")}
#if(!require(data.table)){install.packages("data.table")}
#if(!require(dplyr)){install.packages("dplyr")}
library(knitr)
library(tidyr)
library(stringi)
library(stringr)
library(ggplot2)
library(Hmisc)
library(kableExtra)
library(plotly)
library(janitor)
library(rbokeh)
library(altair)
library(zoo)
library(broom)
library(sqldf)
library(devtools)
library(Statamarkdown)
library(codebook)
library(data.table)
library(dplyr)
```

<!--- SÍ O SÍ, HACER LA LIMPIEZA DE LOS SENDA NO, PRINCIPALMENTE DE LOS QUE SE SUPERPONGAN, TAMBIÉN PREGUNTAR A ACC SI LOS CON 0 DÍAS DE TRATAMIENTO SE BORRARÁN O NO; DE AHI EMPEZAR A NORMALIZAR LOS PROGRAMAS Y PLANES DE ACUERDO CON CRITERIOS MAUREEN, PARA NO GENERAR DIFERENCIAS AHI Y PODER DEDUPLICAR TRANQUILO --->

<!--- tipo_centro, convertir en factor 1. Privado, 2. Público; DataExplorer::create_report(CONS_1_4)  --->

## 0. Raw Deduplication

&nbsp;
<br>
For the purpose of this page, we use the terms "rows" and "cases" as equal to refer to the entries of the dataset. In many of the processes made along the deduplication of entries in C1 dataset, we used unstandardized columns or many other data that was in fact duplicated by HASHs, that did not depend on events related to treatment. In order to find and delete duplicated data that does not add information relevant for the purposes of the study, we now may **use these standardized variables as a criteria to achieve the goal of having a unique event per HASH, by reducing its complexity based on irrelevant differences**.
<br>

### Deduplication based on standardized columns of interest for the study

First, we selected the following standardized variables as a criteria to identify duplicated treatments per user:

- Masked Identifier (HASH_KEY)
- Date of Admission to Treatment (fech_ing)
- Center ID (ID.centro)
- Main Substance of Consumption (sus_principal)
- Other Substances (1) (otras_sus1)
- Other Substances (2) (otras_sus2)
- Other Substances (3) (otras_sus3)
- Starting Substance (sus_ini)
- Age of Onset of Drug Use (edad_ini_cons)
- Marital Status (estado_conyugal)
- Occupational Status (estatus_ocupacional)
- Occupational Category (cat_ocupacional)
- Age in groups (Edad_grupos)
- Motive of Admission to Treatment (origen_ingreso)
- Education Attainment (escolaridad)
- Route of Administration of the Main Substance (via_adm_sus_prin)
- Frequency of Consumption of the Main Substance (freq_cons_sus_prin)

```{r dedup_manual, echo=T, paged.print=TRUE}
require(data.table)
names_c1_stage3 <- c("HASH_KEY","fech_ing", "ID.centro", "sus_principal", "otras_sus1","otras_sus2","otras_sus3","sus_ini","edad_ini_cons", "estado_conyugal","estatus_ocupacional","cat_ocupacional","Edad_grupos","origen_ingreso", "escolaridad","via_adm_sus_prin", "freq_cons_sus_prin")

require(dplyr)
CONS_C1_df_dup_ENE_2020 %>%
  dplyr::arrange(desc(ano_bd),HASH_KEY, desc(fech_ing), desc(fech_egres),dias_trat_inv) %>%
  dplyr::distinct_(.dots = names_c1_stage3, .keep_all = TRUE) %>%
#  dplyr::arrange(HASH_KEY, fech_ing, desc(ano_bd)) %>%
 # dplyr::select(row) %>%  summarise(mean(row), sd(row)) #, lo mismo que en STATA. Se supone que una row es sensible a cambios distintos.
  assign("CONS_C1_df_dup_FEB_2020_prev1",.,envir = .GlobalEnv)
#Lo mismo que en STATA: Ahora hay 118,072. Una vez que introduje 
#Ahora, 118035
#  dplyr::arrange(HASH_KEY, fech_ing, desc(ano_bd), desc(fech_egres)) %>% criterio anterior
```

<br>

Once exact matches were discarded, we ended having `r nrow(CONS_C1_df_dup_FEB_2020_prev1) %>% formatC(, format="f", big.mark=",", digits=0)` cases.

<br>

An analysis based on the following criteria, ended with an index of how many differences within cases with the same HASH and date of admission, and in which variables can be tolerable to have differences. For example, if two or more cases share the same date of admission and hash, but most of the variables are different, it is possible to think that information may be lost if one of them is deleted. In another example, if two or more cases share the same date of admission and hash, but the only differences are observed in the days of treatment, one may think that only the case with more treatment days must be preserved.

- HASH_KEY=	Masked Identifier (RUT)
- Región.del.Centro=	Chilean Region of the Center
- dias_trat=	Days of Treatment
- Edad=	Year (Discrete Number)
- fech_ing=	Date of Admission to Treatment
- fech_egres=	Date of Discharge from Treatment
- ID.centro	Center ID
- id_mod=	SENDAs ID (mask characters 5 & 6)
- ano_nac=	Year of Birth (numeric)
- Edad_al_ing=	Age at Admission to Treatment
- edad_ini_cons=	Age of Onset of Drug Use
- edad_ini_sus_prin= Age of Onset of Drug Use Principal Substance
- tipo_centro= Type of Center
- Nacionalidad= Nationallity
- Etnia= Ethnicity
- Diagnóstico.Trs..Psiquiátrico.DSM.IV= Diagnosis of Psychiatric Disorders, DSM-IV criteria
- Diagnóstico.Trs..Psiquiátrico.SUB.DSM.IV= Diagnosis of Psychiatric Disorders, DSM-IV criteria (sub-classification)
- X2.Diagnóstico.Trs..Psiquiátrico.DSM.IV= Diagnosis of Psychiatric Disorders, DSM-IV criteria (2)
- X2.Diagnóstico.Trs..Psiquiátrico.SUB.DSM.IV= Diagnosis of Psychiatric Disorders, DSM-IV criteria (sub-classification) (2)
- X3.Diagnóstico.Trs..Psiquiátrico.DSM.IV= Diagnosis of Psychiatric Disorders, DSM-IV criteria (3)
- X3.Diagnóstico.Trs..Psiquiátrico.SUB.DSM.IV= Diagnosis of Psychiatric Disorders, DSM-IV criteria (sub-classification) (3)
- Diagnóstico.Trs..Psiquiátrico.CIE.10= Diagnosis of Psychiatric Disorders, CIE-10 criteria
- Diagnóstico.Trs..Psiquiátrico.SUB.CIE.10= Diagnosis of Psychiatric Disorders, CIE-10 criteria (subclassification)
- X2.Diagnóstico.Trs..Psiquiátrico.CIE.10= Diagnosis of Psychiatric Disorders, CIE-10 criteria (2)
- X2.Diagnóstico.Trs..Psiquiátrico.SUB.CIE.10= Diagnosis of Psychiatric Disorders, CIE-10 criteria (subclassification) (2)
- X3.Diagnóstico.Trs..Psiquiátrico.CIE.10= Diagnosis of Psychiatric Disorders, CIE-10 criteria (3)
- X3.Diagnóstico.Trs..Psiquiátrico.SUB.CIE.10= Diagnosis of Psychiatric Disorders, CIE-10 criteria (subclassification) (3)
- motivodeegreso= Cause of Discharge
- identidad.de.genero= Gender Identity
- sexo= Sex of User
- embarazo= Pregnant
- tipo_de_plan= Type of Plan
- tipo_de_programa= Type of Program
- dias_trat_alta_temprana= Less than 90 days in treatment
- motivodeegreso_mod= Cause of Discharge (with late and early withdrawal)
- sus_principal= Main Substance of Consumption
- otras_sus1= Other Substances (1)
- otras_sus2= Other Substances (2)
- otras_sus3= Other Substances (3)
- sus_ini= Starting Substance
- estado_conyugal= Marital Status
- estatus_ocupacional= Occupational Status
- cat_ocupacional= Occupational Category
- Edad_grupos= Age in groups
- origen_ingreso= Motive of Admission to Treatment
- escolaridad= Educational Attainment
- via_adm_sus_prin= Route of Administration of the Main Substance
- freq_cons_sus_prin= Frequency of Consumption of the Main Substance

```{r dedup_analisis_manual, echo=T, paged.print=TRUE}
criterios_show<-c('HASH_KEY', 'tipo_centro', 'Región.del.Centro', 'dias_trat', 
  'Edad', 'Nacionalidad', 'Etnia', 'Diagnóstico.Trs..Psiquiátrico.DSM.IV', 'Diagnóstico.Trs..Psiquiátrico.SUB.DSM.IV', 
  'X2.Diagnóstico.Trs..Psiquiátrico.DSM.IV', 'X2.Diagnóstico.Trs..Psiquiátrico.SUB.DSM.IV', 
  'X3.Diagnóstico.Trs..Psiquiátrico.DSM.IV', 'X3.Diagnóstico.Trs..Psiquiátrico.SUB.DSM.IV', 
  'Diagnóstico.Trs..Psiquiátrico.CIE.10', 'Diagnóstico.Trs..Psiquiátrico.SUB.CIE.10', 
  'X2.Diagnóstico.Trs..Psiquiátrico.CIE.10', 'X2.Diagnóstico.Trs..Psiquiátrico.SUB.CIE.10', 
  'X3.Diagnóstico.Trs..Psiquiátrico.CIE.10', 'X3.Diagnóstico.Trs..Psiquiátrico.SUB.CIE.10', 'fech_ing', 'fech_egres', 
  'motivodeegreso', 'ID.centro', 'identidad.de.genero', 'sexo', 'embarazo', 'tipo_de_plan', 'tipo_de_programa', 
  'id_mod', 'ano_nac', 'Edad_al_ing', 'edad_ini_cons', 'edad_ini_sus_prin', 'dias_trat_alta_temprana', 
  'motivodeegreso_mod', 'sus_principal', 'otras_sus1', 'otras_sus2', 'otras_sus3', 'sus_ini', 'estado_conyugal', 
  'estatus_ocupacional', 'cat_ocupacional', 'Edad_grupos', 'origen_ingreso', 'escolaridad', 
  'via_adm_sus_prin', 'freq_cons_sus_prin')

CONS_C1_df_dup_FEB_2020_prev1 %>%
  dplyr::group_by(HASH_KEY, fech_ing) %>% #primero genero la variable
  dplyr::mutate(HASH_fech_ing_reps = n(), HASH_fech_ing_apariciones=row_number()) %>%  #number of different variables by HASH.
  dplyr::ungroup() %>% #desagrupo
  dplyr::filter(HASH_fech_ing_reps>1) %>% #names() %>% copiar_nombres() #para rescatar nombres de la base de datos
  dplyr::group_by(HASH_KEY, fech_ing) %>% #primero genero la variable
  dplyr::mutate_at(vars(c('HASH_KEY', 'id', 'tipo_centro', 'Región.del.Centro', 'dias_trat', 
                   'Edad', 'Nacionalidad', 'Etnia', 'Diagnóstico.Trs..Psiquiátrico.DSM.IV', 'Diagnóstico.Trs..Psiquiátrico.SUB.DSM.IV', 
                   'X2.Diagnóstico.Trs..Psiquiátrico.DSM.IV', 'X2.Diagnóstico.Trs..Psiquiátrico.SUB.DSM.IV', 
                   'X3.Diagnóstico.Trs..Psiquiátrico.DSM.IV', 'X3.Diagnóstico.Trs..Psiquiátrico.SUB.DSM.IV', 
                   'Diagnóstico.Trs..Psiquiátrico.CIE.10', 'Diagnóstico.Trs..Psiquiátrico.SUB.CIE.10', 
                   'X2.Diagnóstico.Trs..Psiquiátrico.CIE.10', 'X2.Diagnóstico.Trs..Psiquiátrico.SUB.CIE.10', 
                   'X3.Diagnóstico.Trs..Psiquiátrico.CIE.10', 'X3.Diagnóstico.Trs..Psiquiátrico.SUB.CIE.10', 'fech_ing', 'fech_egres', 
                   'motivodeegreso', 'ID.centro', 'identidad.de.genero', 'sexo', 'embarazo', 'tipo_de_plan', 'tipo_de_programa', 
                   'id_mod', 'ano_nac', 'Edad_al_ing', 'edad_ini_cons', 'edad_ini_sus_prin', 'dias_trat_alta_temprana', 
                   'motivodeegreso_mod', 'sus_principal', 'otras_sus1', 'otras_sus2', 'otras_sus3', 'sus_ini', 'estado_conyugal', 
                   'estatus_ocupacional', 'cat_ocupacional', 'Edad_grupos', 'origen_ingreso', 'escolaridad', 
                   'via_adm_sus_prin', 'freq_cons_sus_prin')), .funs = funs(`dups_hash_ing`=ifelse(n_distinct(.)>1,as.character(.),""))) %>% #el ptaje no depende de 
#cuantos duplicados tenga
    dplyr::mutate_at(vars(c('HASH_KEY', 'id', 'tipo_centro', 'Región.del.Centro', 'dias_trat', 
                   'Edad', 'Nacionalidad', 'Etnia', 'Diagnóstico.Trs..Psiquiátrico.DSM.IV', 'Diagnóstico.Trs..Psiquiátrico.SUB.DSM.IV', 
                   'X2.Diagnóstico.Trs..Psiquiátrico.DSM.IV', 'X2.Diagnóstico.Trs..Psiquiátrico.SUB.DSM.IV', 
                   'X3.Diagnóstico.Trs..Psiquiátrico.DSM.IV', 'X3.Diagnóstico.Trs..Psiquiátrico.SUB.DSM.IV', 
                   'Diagnóstico.Trs..Psiquiátrico.CIE.10', 'Diagnóstico.Trs..Psiquiátrico.SUB.CIE.10', 
                   'X2.Diagnóstico.Trs..Psiquiátrico.CIE.10', 'X2.Diagnóstico.Trs..Psiquiátrico.SUB.CIE.10', 
                   'X3.Diagnóstico.Trs..Psiquiátrico.CIE.10', 'X3.Diagnóstico.Trs..Psiquiátrico.SUB.CIE.10', 'fech_ing', 'fech_egres', 
                   'motivodeegreso', 'ID.centro', 'identidad.de.genero', 'sexo', 'embarazo', 'tipo_de_plan', 'tipo_de_programa', 
                   'id_mod', 'ano_nac', 'Edad_al_ing', 'edad_ini_cons', 'edad_ini_sus_prin', 'dias_trat_alta_temprana', 
                   'motivodeegreso_mod', 'sus_principal', 'otras_sus1', 'otras_sus2', 'otras_sus3', 'sus_ini', 'estado_conyugal', 
                   'estatus_ocupacional', 'cat_ocupacional', 'Edad_grupos', 'origen_ingreso', 'escolaridad', 
                   'via_adm_sus_prin', 'freq_cons_sus_prin')), .funs = list(dups_hash_ing2 = ~n_distinct(.))) %>%
    dplyr::ungroup() %>%
    dplyr::mutate_at(vars(contains('_dups_hash_ing2')), .funs = list(~ifelse(.>1,1,0))) %>% #el ptaje no depende de cuantos duplicados tenga
    dplyr::mutate(n_of_diffs_within = rowSums(select(., contains("_dups_hash_ing2")))) %>% 
#   janitor::tabyl(n_of_matches) #para ver cómo se distirbuye
#   dplyr::select(-contains("_dups_hash_ing")) %>% 
#   dplyr::select(,contains("_dups_hash_ing")) %>%
    dplyr::select("row", "ano_bd","HASH_fech_ing_reps","HASH_fech_ing_apariciones","n_of_diffs_within","id_mod", c(criterios_show, ends_with("_dups_hash_ing"), "SENDA")) %>%
  dplyr::arrange(n_of_diffs_within, HASH_KEY, desc(ano_bd)) %>% as.data.frame() %>%  knitr::kable(.,format = "html", format.args = list(decimal.mark = ".", big.mark = ","),
               caption="Table 1. Cases with the same date of admission and HASH, for visual analysis",
                 align =rep('c', 101))  %>%
   kableExtra::kable_styling(bootstrap_options = c("striped", "hover"),font_size = 8) %>%
  kableExtra::add_footnote( c("Note. HASH_fech_ing_reps= Times that HASH and Date of Admission is repeated;", "HASH_fech_ing_apariciones= Ordered number of registries with the same HASH and Date of Admission;", "n_of_diffs_within= Sum of the differences in each selected variable (0 if there is a difference, 1 if not) within cases that share the same HASH and Date of Admission, of a total of 49 selected variables"), notation = "none") %>%
  kableExtra::scroll_box(width = "100%", height = "375px")
```

&nbsp;

The process applied is shown in Figure 1. We must recognize that the election of the word "consider" is not arbitrary, principally because this stage required a more careful analysis of each case. So, more than the application of strict partial rules, we applied these criteria as the combination of the whole.

<br>

```{r image-decision_tree_duplicated_entries, echo=FALSE, fig.align='center', fig.pos='H', fig.cap= "Figure 1. Decision Tree for the Discard of Duplicated Cases", message=FALSE}
knitr::include_graphics("G:/Mi unidad/Alvacast/SISTRAT 2019 (github)/SUD_CL/Figures/Duplicated_entries_decision_tree.svg")
```

```{r dedup_analisis_manual_export, echo=T, include=F, paged.print=TRUE}
#Tengo que llegar a este número
###117,619
criterios<-c('HASH_KEY', 'id', 'tipo_centro', 'Región.del.Centro', 'dias_trat', 
  'Edad', 'Nacionalidad', 'Etnia', 'Diagnóstico.Trs..Psiquiátrico.DSM.IV', 'Diagnóstico.Trs..Psiquiátrico.SUB.DSM.IV', 
  'X2.Diagnóstico.Trs..Psiquiátrico.DSM.IV', 'X2.Diagnóstico.Trs..Psiquiátrico.SUB.DSM.IV', 
  'X3.Diagnóstico.Trs..Psiquiátrico.DSM.IV', 'X3.Diagnóstico.Trs..Psiquiátrico.SUB.DSM.IV', 
  'Diagnóstico.Trs..Psiquiátrico.CIE.10', 'Diagnóstico.Trs..Psiquiátrico.SUB.CIE.10', 
  'X2.Diagnóstico.Trs..Psiquiátrico.CIE.10', 'X2.Diagnóstico.Trs..Psiquiátrico.SUB.CIE.10', 
  'X3.Diagnóstico.Trs..Psiquiátrico.CIE.10', 'X3.Diagnóstico.Trs..Psiquiátrico.SUB.CIE.10', 'fech_ing', 'fech_egres', 
  'motivodeegreso', 'ID.centro', 'identidad.de.genero', 'sexo', 'embarazo', 'tipo_de_plan', 'tipo_de_programa', 
  'id_mod', 'ano_nac', 'Edad_al_ing', 'edad_ini_cons', 'edad_ini_sus_prin', 'dias_trat_alta_temprana', 
  'motivodeegreso_mod', 'sus_principal', 'otras_sus1', 'otras_sus2', 'otras_sus3', 'sus_ini', 'estado_conyugal', 
  'estatus_ocupacional', 'cat_ocupacional', 'Edad_grupos', 'origen_ingreso', 'escolaridad', 
  'via_adm_sus_prin', 'freq_cons_sus_prin')

CONS_C1_df_dup_FEB_2020_prev1 %>%
  dplyr::group_by(HASH_KEY, fech_ing) %>% #primero genero la variable
  dplyr::mutate(HASH_fech_ing_reps = n(), HASH_fech_ing_apariciones=row_number()) %>%  #number of different variables by HASH.
  dplyr::ungroup() %>% #desagrupo
  dplyr::filter(HASH_fech_ing_reps>1) %>% #names() %>% copiar_nombres() #para rescatar nombres de la base de datos
  dplyr::group_by(HASH_KEY, fech_ing) %>% #primero genero la variable
   dplyr::mutate_at(vars(c('HASH_KEY', 'id', 'tipo_centro', 'Región.del.Centro', 'dias_trat', 
                   'Edad', 'Nacionalidad', 'Etnia', 'Diagnóstico.Trs..Psiquiátrico.DSM.IV', 'Diagnóstico.Trs..Psiquiátrico.SUB.DSM.IV', 
                   'X2.Diagnóstico.Trs..Psiquiátrico.DSM.IV', 'X2.Diagnóstico.Trs..Psiquiátrico.SUB.DSM.IV', 
                   'X3.Diagnóstico.Trs..Psiquiátrico.DSM.IV', 'X3.Diagnóstico.Trs..Psiquiátrico.SUB.DSM.IV', 
                   'Diagnóstico.Trs..Psiquiátrico.CIE.10', 'Diagnóstico.Trs..Psiquiátrico.SUB.CIE.10', 
                   'X2.Diagnóstico.Trs..Psiquiátrico.CIE.10', 'X2.Diagnóstico.Trs..Psiquiátrico.SUB.CIE.10', 
                   'X3.Diagnóstico.Trs..Psiquiátrico.CIE.10', 'X3.Diagnóstico.Trs..Psiquiátrico.SUB.CIE.10', 'fech_ing', 'fech_egres', 
                   'motivodeegreso', 'ID.centro', 'identidad.de.genero', 'sexo', 'embarazo', 'tipo_de_plan', 'tipo_de_programa', 
                   'id_mod', 'ano_nac', 'Edad_al_ing', 'edad_ini_cons', 'edad_ini_sus_prin', 'dias_trat_alta_temprana', 
                   'motivodeegreso_mod', 'sus_principal', 'otras_sus1', 'otras_sus2', 'otras_sus3', 'sus_ini', 'estado_conyugal', 
                   'estatus_ocupacional', 'cat_ocupacional', 'Edad_grupos', 'origen_ingreso', 'escolaridad', 
                   'via_adm_sus_prin', 'freq_cons_sus_prin')), .funs = funs(`dups_hash_ing`=ifelse(n_distinct(.)>1,as.character(.),""))) %>%
  dplyr::mutate_at(vars(c('HASH_KEY', 'id', 'tipo_centro', 'Región.del.Centro', 'dias_trat', 
                   'Edad', 'Nacionalidad', 'Etnia', 'Diagnóstico.Trs..Psiquiátrico.DSM.IV', 'Diagnóstico.Trs..Psiquiátrico.SUB.DSM.IV', 
                   'X2.Diagnóstico.Trs..Psiquiátrico.DSM.IV', 'X2.Diagnóstico.Trs..Psiquiátrico.SUB.DSM.IV', 
                   'X3.Diagnóstico.Trs..Psiquiátrico.DSM.IV', 'X3.Diagnóstico.Trs..Psiquiátrico.SUB.DSM.IV', 
                   'Diagnóstico.Trs..Psiquiátrico.CIE.10', 'Diagnóstico.Trs..Psiquiátrico.SUB.CIE.10', 
                   'X2.Diagnóstico.Trs..Psiquiátrico.CIE.10', 'X2.Diagnóstico.Trs..Psiquiátrico.SUB.CIE.10', 
                   'X3.Diagnóstico.Trs..Psiquiátrico.CIE.10', 'X3.Diagnóstico.Trs..Psiquiátrico.SUB.CIE.10', 'fech_ing', 'fech_egres', 
                   'motivodeegreso', 'ID.centro', 'identidad.de.genero', 'sexo', 'embarazo', 'tipo_de_plan', 'tipo_de_programa', 
                   'id_mod', 'ano_nac', 'Edad_al_ing', 'edad_ini_cons', 'edad_ini_sus_prin', 'dias_trat_alta_temprana', 
                   'motivodeegreso_mod', 'sus_principal', 'otras_sus1', 'otras_sus2', 'otras_sus3', 'sus_ini', 'estado_conyugal', 
                   'estatus_ocupacional', 'cat_ocupacional', 'Edad_grupos', 'origen_ingreso', 'escolaridad', 
                   'via_adm_sus_prin', 'freq_cons_sus_prin')), .funs = list(dups_hash_ing2 = ~n_distinct(.))) %>%
  ##DE 49 VARIABLES, CUENTA LAS QUE HAY MAS DE UN VALOR DISTINTO ENRE EL GRUPO  
  dplyr::ungroup() %>%
    dplyr::mutate_at(vars(contains('_dups_hash_ing2')), .funs = list(~ifelse(.>1,1,0))) %>% #el ptaje no depende de cuantos duplicados tenga
    dplyr::mutate(n_of_diffs_within = rowSums(select(., contains("_dups_hash_ing2")))) %>% 
#  janitor::tabyl(n_of_matches) #para ver cómo se distirbuye
#  dplyr::select(-contains("_dups_hash_ing")) %>% 
#  dplyr::select(,contains("_dups_hash_ing")) %>%
  dplyr::select("row", "ano_bd","HASH_fech_ing_reps","HASH_fech_ing_apariciones","n_of_diffs_within", c(criterios, ends_with("_dups_hash_ing"), "SENDA")) %>%
  dplyr::arrange(n_of_diffs_within, HASH_KEY, desc(ano_bd)) %>% as.data.frame() %>% guardar_tablas("_matches_feb_2020")
#anyDuplicated returns the index i of the first duplicated entry if there is one, and 0 otherwise.
 #anyDuplicated(CONS_C1_df_dup_FEB_2020_prev1_dt, by=c("HASH_KEY", "fech_ing"))
```

<br>

Of the `r length(criterios)` variables, we seen that many cases had different sexes, others are registries mostly from 2010 to 2015. Additionally, some diagnostics did not appear previously in the last registry. Other programs specific for women are changed in the next case for the general population. In general, we keeped most recent cases, excepting for a few rows, such as "4118", that came from the same year of the row "4842" and share almost the same information but underestimated the frequency of consumption of the principal substance. Another case is row "38147", that share almost every characteristic with row "38755", excepting that this row lacked the occupational status and underestimated the frequency of consumption of the principal substance. Same with row "9875", that shared almost every variable with row "7161", but had less information about diagnostics related to mental health, despite they had distinct information regarding to drug use (other substances 2 and 3).

<br>

```{r filter_cases_duplicated, echo=T, include=T, paged.print=TRUE}
dup_rows_by_obs_an <-c('44441', '59632', '4118', '83870', '33668', '38147', '13748', '24327', '7161', '6547', '37013', '96781', '57407', '15363', '63133', '196', '93528', '30670', '58550', '72253', '54650', '25716', '70547', '8320', '22332', '25251', '79519', '59842', '30734', '1105', '53959', '37294', '24936', '49352', '61282', '28687', '13729', '59555', '21165', '28500', '61274', '74897', '22331', '36731', '80950', '54760', '48977', '15410', '14641', '71758', '15744', '15526', '9099', '29791', '22330', '61287', '60502', '59556', '4739', '46724', '30276', '21166', '41795', '60507', '54776', '21574', '18237', '22228', '23061', '74444', '72556', '39592', '450', '54383', '35913', '30644', '23062', '3874', '3957', '72933', '8590', '13236', '30717', '54745', '31417', '23949', '24776', '9433', '45379', '53402', '71735', '37885', '21664', '14645', '25817', '9092', '31514', '2682', '37166', '57409', '38288', '18774', '6331', '67013', '34282', '77761', '2038', '84270', '22347', '41793', '30178', '22307', '57171', '27222', '25562', '39361', '3702', '28830', '14291', '137746', '20396', '4530', '53672', '42633', '29792', '15480', '55412', '57056', '89084', '59799', '57052', '6943', '61275', '14280', '17704', '45685', '9006', '35723', '23583', '83762', '4490', '57391', '7328', '15237', '14664', '77874', '12979', '36160', '62447', '121921', '3854', '66842', '15235', '46461', '74484', '15412', '5497', '25123', '47029', '45781', '6332', '13945', '52207', '45018', '44514', '2665', '52774', '8159', '37243', '13482', '31500', '26528', '549', '39944', '15386', '70295', '45306', '30352', '15688', '4735', '3191', '61079', '42627', '40610', '12495', '62097', '46463', '22612', '44794', '25013', '2284', '32219', '61281', '64011', '9318', '135017', '16319', '23355', '20118', '18281', '41599', '63035', '5493', '23280', '7698', '21397', '8352', '31750', '58055', '25429', '22249', '18952', '4984', '40210', '27202', '31341', '35645', '57410', '68566', '77886', '15416', '13309', '20154', '37926', '7250', '34556', '76210', '30713', '322', '20041', '18232', '14457', '1866', '59271', '25117', '31743', '26552', '58187', '28481', '18099', '16185', '1798', '23372', '57885', '46333', '6508', '16275', '27262', '17379', '10900', '14656', '7581', '11641', '39151', '78898', '24269', '5072', '21080', '63034', '20479', '15278', '70927', '7604', '6799', '34933', '14814', '340', '26721', '31621', '23299', '462', '12510', '7160', '46351', '5074', '12839', '4713', '6864', '4976', '37220', '23362', '11969', '37722', '35729', '441', '16189', '5536', '24449', '77163', '46455', '8767', '36167', '30552', '14616', '13956', '30568', '31424', '29523', '20704', '132268', '6346', '14051', '12484', '25164', '13276', '1618', '18713', '10495', '18468', '13128', '12838', '7182', '2523', '9719', '18651', '23586', '74757', '6334', '5571', '26424', '6794', '4801', '35841', '35831', '29608', '41005', '18712', '18649', '18934', '18170', '27956', '37271', '29885', '6202', '32299', '16172', '3865', '2319', '11163', '27214', '11552', '29380', '28514', '11365', '1794', '429', '61631', '12540', '21363', '23326', '38864', '11300', '14040', '9473', '36039', '27721', '63525', '43722', '19448', '18950', '8403', '22188', '3862', '2629', '15904', '15256', '8765', '23581', '16082', '74024', '14096', '75750', '1789', '27712', '25180', '21231', '17566', '72221', '31361', '16212', '8334', '17664', '11117', '31628', '31558', '23842', '16836', '27226', '16326', '57544', '30563', '54953', '22028', '11465', '7623', '27964', '23588', '31266', '16173', '11837', '6867', '4641', '15768', '23437', '16807', '11807', '3974', '14057', '12517', '8752', '8013', '23300', '12516', '8153', '5031', '582')
###igual creo que si uno quisiese automatizar el proceso, sólo necesitaría sacar el primero de cada fila con slice row number grouped by hash fech ing y no se complica más.
CONS_C1_df_dup_FEB_2020_prev1 %>%
  dplyr::filter(!row %in% dup_rows_by_obs_an) %>%
  clean_names() %>%
  assign("CONS_C1_df_dup_FEB_2020_prev2",.,envir = .GlobalEnv)
#117,619
```

<br>

Once done the manual discard of duplicated cases, we ended having `r nrow(CONS_C1_df_dup_FEB_2020_prev2) %>% formatC(, format="f", big.mark=",", digits=0)` cases.

<br>

### Deduplication from the Overlap Between Dates of Admission & Discharge

&nbsp;
<br>
Once discarded duplicated cases, we searched for cases in which dates ranges were overlapped with other treatments for the same user (HASH).This required to temporarily replace those cases that did not have a date of dischage, with the date of retrieval of the datasets, that is "2019-11-13". 

<br>

```{r  overlap1,echo=T, paged.print=TRUE}
CONS_C1_df_dup_intervals_FEB_2020<- CONS_C1_df_dup_FEB_2020_prev2 %>%
  #as.numeric(as.Date("2019-11-13")) #18213
  dplyr::mutate(fech_ing_num2=as.numeric(as.Date(fech_ing))) %>%
  dplyr::mutate(fech_egres_num2=as.numeric(as.Date(fech_egres))) %>%
  dplyr::mutate(fech_egres_num2=ifelse(is.na(fech_egres),18213,fech_egres_num2)) %>% #equivalente a 2019-11-13
  dplyr::rename("hash_key_2"="hash_key", "row2"="row") %>%
  dplyr::select(row2,hash_key_2, ano_bd,fech_ing, fech_ing_num2,fech_egres,fech_egres_num2,edad, dias_trat,id_centro, motivodeegreso, senda) %>% 
  #dplyr::filter(motivodeegreso!="Derivación") %>%
  data.table::as.data.table()
require(sqldf)
require(gridExtra)
  overlap_dates_C1_FEB_2020 <- janitor::clean_names(sqldf("SELECT *
                 FROM CONS_C1_df_dup_intervals_FEB_2020 AS x  
                 INNER JOIN CONS_C1_df_dup_intervals_FEB_2020 AS y 
                 ON x.hash_key_2 == y.hash_key_2 AND 
                 x.fech_ing_num2 < y.fech_egres_num2 AND x.fech_egres_num2 > y.fech_ing_num2 AND x.row2 != y.row2"))  
  #busca mismo hash, distinto row,pero fecha de ingreso menor o igual a la fecha de egreso del otro, y fecha de egreso mayor o igual a la fecha de ingreso del otro. lo del row ES PARA DESCARTAR CASOS QUE SE SUPERPONEN CONSIGMO MISMO.
overlap_dates_C1_FEB_2020 %>%
  dplyr::mutate(fech_ing=stringi::stri_sub(as.character.Date(fech_ing),1,10)) %>%
  dplyr::mutate(fech_egres=stringi::stri_sub(as.character.Date(fech_egres),1,10)) %>%
  dplyr::mutate(fech_ing_2=stringi::stri_sub(as.character.Date(fech_ing_2),1,10)) %>%
  dplyr::mutate(fech_egres_2=stringi::stri_sub(as.character.Date(fech_egres_2),1,10)) %>%
  dplyr::rename("row_1"="row2","hash_key_1"="hash_key_2", "ano_bd_1"="ano_bd","fech_ing_1"="fech_ing","fech_ing_num_1"="fech_ing_num2",
                "fech_egres_1"="fech_egres","fech_egres_num_1"="fech_egres_num2", "edad_1"="edad","dias_trat_1"="dias_trat","id_centro_1"="id_centro",
                "motivodeegreso_1"="motivodeegreso", "senda_1"="senda", "row_2"="row2_2", "hash_key_2"="hash_key_2_2", "fech_ing_num_2"="fech_ing_num2_2",
                "fech_egres_num_2"="fech_egres_num2_2") %>%
  #dplyr::select(row2, hash_key_2,row2_2,hash_key_2_2, everything()) %>%
  assign("CONS_C1_df_dup_FEB_2020_overlaps",.,envir = .GlobalEnv)

#EL DE LA IZQUIERDA TIENDE A SER MÁS ANTIGUO QUE EL DE LA DERECHA, CONSTE
CONS_C1_df_dup_FEB_2020_overlaps %>%
  dplyr::mutate(prod_row=as.numeric(row_1)*as.numeric(row_2), sum_row=as.numeric(row_1)+as.numeric(row_2), filter_row=paste0(prod_row,"_",sum_row)) %>%
  dplyr::mutate(caso_2_mas_reciente=ifelse(as.numeric(fech_ing_num_2)>as.numeric(fech_ing_num_1),1,0)) %>% #ver si el dato de la izq es más aniguo
  dplyr::arrange(desc(caso_2_mas_reciente)) %>%
  dplyr::filter(!duplicated(filter_row)) %>% #dejé sólo los casos que son más recientes. Se supone q no perdí casos, sino que saqué los duplicados
  dplyr::mutate(mismo_id_centro=ifelse(id_centro_1==id_centro_2,1,0)) %>%
  dplyr::mutate(bd_2_mas_reciente=ifelse(ano_bd_2>ano_bd_1,1,0)) %>% #es el dato de la derecha de una base de datos mas reciente.
  dplyr::mutate(senda= ifelse(senda_1=="Si" & senda_2=="Si","Si Ambos",
                        ifelse(senda_1=="No" & senda_2=="No","No Ambos",
                              ifelse(senda_1=="No" & senda_2=="Si","Si 2",
                                     ifelse(senda_1=="Si" & senda_2=="No","No 2",NA))))) %>%
  dplyr::mutate(Derivacion= ifelse(motivodeegreso_1=="Derivación",1,0)) %>%
  dplyr::mutate(days_overlapped=fech_egres_num_1-fech_ing_num_2) %>% # para que hayan dias positivos. Se supone que la fecha de egreso es más reciente que la fecha de ingreso del evento que superpone.
  dplyr::mutate(mas_dias_trat=ifelse(dias_trat_2>dias_trat_1,1,0)) %>% #más días tratado en 2
  dplyr::select(-caso_2_mas_reciente, -filter_row,-prod_row,-sum_row,-hash_key_2) %>%
    assign("CONS_C1_df_dup_FEB_2020_overlaps_COMP",.,envir = .GlobalEnv)
####
CONS_C1_df_dup_FEB_2020_overlaps_COMP %>%
  dplyr::mutate(fech_egres_num_imp=lead(fech_ing_num_2)) %>%
  knitr::kable(.,format = "html", format.args = list(decimal.mark = ".", big.mark = ","),
               caption="Table 2. Cases with overlapped treatment ranges",
                 align =rep('c', 101))  %>%
  kableExtra::kable_styling(bootstrap_options = c("striped", "hover"),font_size = 8) %>%
  kableExtra::add_footnote( c("Note.Each row represents an overlap. Variables ending with '_1' are the first case, and variables ending with '_2' correspond to the second case;", "mismo_id_centro= If both cases share the same Center ID", "bd_2_mas_reciente= Year of the yearly dataset is more recent in the second case;", "senda= If both cases are financed by SENDA;", "Derivación= If the cause of discharge is the referral from another center (1= Referral);","days_overlapped= Difference between the date of admission of the earlier treatment, and the date of discharge of the latter treatment","mas_dias_trat= Earlier treatment has more days of treatment"), notation = "none") %>%
  kableExtra::scroll_box(width = "100%", height = "375px")

#FOR COMPARISON
#panelr::long_panel(CONS_C1_df_dup_FEB_2020_overlaps, prefix = "_", label_location = "end", begin = 1, end = 2) %>% 
#  #dplyr::select(-hash_key_2) %>%
#  dplyr::rename("overlap_id"="id") %>%
#  guardar_tablas("_overlaps_feb_2020")
```


We identified `r CONS_C1_df_dup_FEB_2020_overlaps_COMP %>%  nrow() %>% formatC(, format="f", big.mark=",", digits=0)` overlappings, some of the users appearing more than one time (n= `r CONS_C1_df_dup_FEB_2020_overlaps_COMP %>%group_by(hash_key_1) %>% dplyr::filter(!is.na(fech_egres_2),!is.na(fech_egres_1)) %>% dplyr::mutate(mas_de_un_row=n_distinct(row_1)) %>% ungroup() %>% filter(mas_de_un_row>1) %>% nrow()`). For those cases with less or equal to 30 days of treatment, we substracted the days overlapped between the date of discharge of the first treatment and the date of admission of the next treatment. 


Must note that between the cases that have overlapped treatment days in different centers, these are the cases that repeat most:

- 109	"COSAM Concepcion"	to 117	"Comunidad Terapeutica Villamavida"
- 328	"COSAM Alenmoguen "	to 	502	"Centro de Responsabilidad de Salud Mental del Complejo Asistencial Dr.Victor Rios Ruiz"
- 502	"Centro de Responsabilidad de Salud Mental del Complejo Asistencial Dr.Victor Rios Ruiz"	to 	123	"COSAM Newen"
- 123	"COSAM Newen"		to 117	"Comunidad Terapeutica Villamavida"
- 161	"Centro Comunitario de Salud Mental Familiar (COSAM Pudahuel)"	to 147	"Comunidad Terapeutica Manresa"
- 502	"Centro de Responsabilidad de Salud Mental del Complejo Asistencial Dr.Victor Rios Ruiz"	to 328	"COSAM Alenmoguen "
- 166	"COSAM Enrique Paris"	to 171	"Hospital de Dia Iquique" 

It might be possible that treatments that are not qualified as financed by SENDA might be effectivelly financed by SENDA. However, also the SENDA's professional stated that Senda only checked information of the treatments that are recognized as financed by SENDA. 

Four alternatives were delimited in order to resolve overlapped dates:
- Impute treated days, and replacing the date of discharge
- Keep the earliest treatment
- Discard the earliest treatment
- Substract days to the date of discharge of the last treatment

<!--- eso requiere cambiar los días de tratamiento, el motivodeegreso mod, el de late withdrawal y todo, dias_trat, etc --->
<!--- ¿y qué pasa con los casos que tienen más de un HASH overlapiado??, `r CONS_C1_df_dup_FEB_2020_overlaps_COMP %>%group_by(hash_key_1) %>% dplyr::mutate(mas_de_un_row=n_distinct(row_1)) %>% ungroup() %>% filter(mas_de_un_row>1) %>% nrow()` #137, 2 y #38 +2 --->
<!--- qué pasa con los casos que tenian la fecha perdida de egreso por mucho tiempo y por tanto estoy perdiendo casos intermedios? `r CONS_C1_df_dup_FEB_2020_overlaps_COMP %>% dplyr::filter(is.na(fech_egres_1)) %>% nrow()`.#19. AQUÍ HAY 2 PROBLEMAS.--->

**DEBO ESCRIBIR LO QUE HAY EN LOS COMENTARIOS AQUÍ!!!!**

<br>

Of the overlapping variables dates, `r CONS_C1_df_dup_FEB_2020_overlaps_COMP %>% dplyr::filter(is.na(fech_egres_1)) %>% nrow()` cases had missing values in the date of discharge, generating confusion when it comes to analyse the trajectories of a user from 2010 to 2019. In Table 12, we may find the different treatments available for users that have at least one treatment with a missing date of discharge. **These cases were sent to SENDA's professional previously, and filtered and resended on February 24**. Meanwhile, two possible alternatives would be to fill the date of discharge with the date of admission of the next treatment, or to impute those missing data based on other cases. However, this imputation must avoid overlapping with the following date.


```{r  overlap2,echo=T, paged.print=TRUE, warning=F}
fech_egres_na_overlap<- CONS_C1_df_dup_FEB_2020_overlaps_COMP %>% dplyr::filter(is.na(fech_egres_1)) %>% distinct(hash_key_1)
#son 14 hashs con datos perdidos en la fecha de egreso
#probablemente los otros casos perdidos correspondan a personas que sólo tenían un evento no más.
CONS_C1_df_dup_FEB_2020_prev2 %>%
  dplyr::filter(hash_key %in% as.character(as.vector(unlist(as.data.table(unlist(fech_egres_na_overlap)))))) %>% # select hashs of wrongly assigned ages
  dplyr::arrange(hash_key, desc(fech_ing)) %>% 
  dplyr::group_by(hash_key) %>% 
  dplyr::mutate(fech_egres_imp = dplyr::lag(fech_ing, n = 1, default = NA), fech_egres_imp=ifelse(is.na(fech_egres),as.character(fech_egres_imp),as.character(fech_egres))) %>%
  dplyr::mutate(dias_trat_imp= as.numeric(as.Date(fech_egres_imp))-as.numeric(as.Date(fech_ing))) %>%
  dplyr::mutate(dias_trat_alta_temprana_imp=ifelse(dias_trat_imp>=90,0,1)) %>%
  dplyr::mutate(dias_trat_alta_temprana_imp=as.factor(dias_trat_alta_temprana_imp)) %>%
  dplyr::mutate(dias_trat_alta_temprana_imp= dplyr::recode(dias_trat_alta_temprana_imp, "1"="Menos de 90 días", "0"="Mayor o igual a 90 días")) %>%
  dplyr::mutate(motivodeegreso_mod_imp= ifelse(dias_trat_alta_temprana_imp=="Menos de 90 días" & motivodeegreso=="Abandono", "Abandono Temprano",as.character(motivodeegreso))) %>% ## CONSTE QUE ESTO NO VA A FUNCIONAR
  dplyr::mutate(motivodeegreso_mod_imp= ifelse(dias_trat_alta_temprana_imp=="Mayor o igual a 90 días" & motivodeegreso=="Abandono", "Abandono Tardio",as.character(motivodeegreso_mod_imp))) %>% 
  dplyr::mutate(motivodeegreso_mod_imp=as.factor(motivodeegreso_mod_imp)) %>%
  dplyr::select(row,hash_key, ano_bd, fech_ing, fech_egres, fech_egres_imp,dias_trat_alta_temprana_imp, dias_trat, dias_trat_imp,motivodeegreso_mod_imp,motivodeegreso, senda, id_centro, motivodeegreso_mod, tipo_de_plan_2) %>% #print()
  knitr::kable(.,format = "html", format.args = list(decimal.mark = ".", big.mark = ","),
               caption="Table 3. Cases with missing values in the date of discharge",
                 align =rep('c', 101))  %>%
   kableExtra::kable_styling(bootstrap_options = c("striped", "hover"),font_size = 8) %>%
  kableExtra::scroll_box(width = "100%", height = "375px")
#si tiene un caso más, significa que con ese caso se detectó el overlap.
#001022ffb28057b24dd76900bbf1e3de   no hay problemas. sólo tiene 1 caso más
#0d7fe0ff18f5b16868a68ca5ee5d4b87   no hay problemas. sólo tiene 1 caso más
#137e8525aa3f79235fa8ad90913fdcbe   no hay problemas, sólo tiene 1 caso más después del que tiene perdida la fecha
#144b8d70d7ea1b9ea70d2ef7543520b2   no hay problemas, sólo tiene 1 caso más después del que tiene perdida la fecha
#1baff032eb17af74d98d63542c87423a   no hay problemas, sólo tiene 1 caso más después del que tiene perdida la fecha
#1d53b9a82ab4fbc0e6cfa109d664eb51   complicado
#2a9e74353a3177ed278508f91265e4b4   debiese quedar con fecha 2010-04-29
#3e23f3c3cbedb2aa1003e6a9d03eb070   podría ser el 2011-04-12 en el primer caso.
#57b4de7542dfab3c29b6705cb392ff8a   2012-02-16
#9803638c4b8ca2a0920ea15bcc024da5

#CREO QUE PODRÍA ORDENAR TODOS LOS DATOS POR FECHA DE INGRESO, Y OCUPAR LEAD Y LAG PARA REEMPLAZAR Y CHAO. AUTOMATIZAR EL PROCESO
```

```{r change labels,echo=F, paged.print=TRUE}
  metadata(CONS_C1_df_dup_FEB_2020_prev2)$name <- "Agreement 1 SENDA"
  metadata(CONS_C1_df_dup_FEB_2020_prev2)$description <- "Information About Agreement 1 of SENDA and MINSAL"
  
codebook::var_label(CONS_C1_df_dup_FEB_2020_prev2) <- list(row = 'Numerador de los eventos presentes en la Base de Datos/Events in the Dataset',
table = 'Origen de los Datos (de los archivos por año)/Source of Data (of files per year)',
hash_key = 'Codificación del RUT/Masked Identifier (RUT)',
ano_bd = 'Año de la Base de Datos/Year of the Dataset (Source)',
id = 'Codigo Identificación de SENDA/SENDAs ID',
nombre_centro = 'Nombre del Centro de Tratamiento/Treatment Center',
tipo_centro = 'Tipo de Centro/Type of Center',
region_del_centro = 'Región del Centro/Chilean Region of the Center',
servicio_de_salud = 'Servicio de Salud/Health Service',
tipo_de_programa = '(original, Recodificado en tipo_de_programa_2)/',
tipo_de_plan = '(original, Recodificado en tipo_de_plan_2)/',
senda = 'SENDA/SENDA',
dias_trat = 'Días de Tratamiento/Days of Treatment',
nmesesentratamiento = 'Número de Meses en Tratamiento/Number of Months in Treatment',
dias_en_senda = 'Días en SENDA/Days in SENDA',
n_meses_en_senda = 'Número de Meses en SENDA/Number of Months in SENDA',
sexo = '(original, Recodificado en sexo_2)/',
edad = 'Edad (número entero)/Year (Discrete Number)',
nombre_usuario = 'Nombre del Usuario (OCULTO y no accesible)/Name of the User (Not Accessible)',
comuna_residencia = 'Comuna de Residencia/Municipality of Residence',
origen_de_ingreso = '(original, Recodificado en origen_ingreso)/',
pais_nacimiento = 'País de Nacimiento/Country of Birth',
nacionalidad = 'Nacionalidad/Nationallity',
etnia = 'Etnia/Ethnicity',
estado_conyugal = '(original, Recodificado en estado_conyugal_2)/',
numero_de_hijos = 'Número de Hijos/Number of Children',
numero_de_hijos_ingreso_tratamiento_residencial = 'Número de Hijos para Ingreso a Tratamiento Residencial/Number of Children to Residential Treatment',
parentesco_con_el_jefe_de_hogar = '(Sólo presenta valores perdidos)/',
numero_de_tratamientos_anteriores = 'Número de Tratamientos Anteriores/Number of Previous Treatments',
fecha_ultimo_tratamiento = 'Fecha del Último Tratamiento (aún no formateada como fecha)/Date of the Last Treatment',
sustancia_de_inicio = '(original, Recodificado en sus_ini)/',
edad_inicio_consumo = '(original, Recodificado en edad_ini_cons)/', 
x_se_trata_de_una_mujer_embarazada = 'Mujer Embarazada al Ingreso/Pregnant at Admission',
escolaridad_ultimo_ano_cursado = '(original, Recodificado en escolaridad)/', 
condicion_ocupacional = '(original, Recodificado en estatus_ocupacional)/', 
categoria_ocupacional = '(original, Recodificado en cat_ocupacional)/',
rubro_trabaja = 'Rubro de Trabajo/Area of Work',
con_quien_vive = 'Persona con la que vive el Usuario/People that Share Household with the User',
tipo_de_vivienda = 'Tipo de Vivienda/Type of Housing',
tenencia_de_la_vivienda = 'Tenencia de la Vivienda/Tenure status of Households',
sustancia_principal = '(original, Recodificado en sus_principal)/',
otras_sustancias_nº1 = '(original, Recodificado en otras_sus1)/',
otras_sustancias_nº2 = '(original, Recodificado en otras_sus2)/',
otras_sustancias_nº3 = '(original, Recodificado en otras_sus3)/',
frecuencia_de_consumo_sustancia_principal = '(original, Recodificado en freq_cons_sus_prin)/',
edad_inicio_sustancia_principal = '(original, Recodificado en edad_ini_sus_prin)/',
via_administracion_sustancia_principal = '(original, Recodificado en via_adm_sus_prin)/',
diagnostico_trs_consumo_sustancia = 'Diagnósico de Trastorno por Consumo de Sustancias/Diagnosed of Substance Use Disorder',
diagnostico_trs_psiquiatrico_dsm_iv = 'Diagnóstico de Trastorno Psiquiátrico, Criterios DSM IV/Diagnosis of Psychiatric Disorders, DSM-IV criteria',
diagnostico_trs_psiquiatrico_sub_dsm_iv = 'Diagnóstico de Trastorno Psiquiátrico, Criterios DSM IV (Subclasificacion)/Diagnosis of Psychiatric Disorders, DSM-IV criteria (sub-classification)',
x2_diagnostico_trs_psiquiatrico_dsm_iv = 'Diagnóstico de Trastorno Psiquiátrico, Criterios DSM IV (2)/Diagnosis of Psychiatric Disorders, DSM-IV criteria (2)',
x2_diagnostico_trs_psiquiatrico_sub_dsm_iv = 'Diagnóstico de Trastorno Psiquiátrico, Criterios DSM IV (Subclasificacion) (2)/Diagnosis of Psychiatric Disorders, DSM-IV criteria (sub-classification) (2)',
x3_diagnostico_trs_psiquiatrico_dsm_iv = 'Diagnóstico de Trastorno Psiquiátrico, Criterios DSM IV (3)/Diagnosis of Psychiatric Disorders, DSM-IV criteria (3)',
x3_diagnostico_trs_psiquiatrico_sub_dsm_iv = 'Diagnóstico de Trastorno Psiquiátrico, Criterios DSM IV (Subclasificacion) (3)/Diagnosis of Psychiatric Disorders, DSM-IV criteria (sub-classification) (3)',
diagnostico_trs_psiquiatrico_cie_10 = 'Diagnóstico de Trastorno Psiquiátrico, Criterios CIE-10/Diagnosis of Psychiatric Disorders, CIE-10 criteria',
diagnostico_trs_psiquiatrico_sub_cie_10 = 'Diagnóstico de Trastorno Psiquiátrico, Criterios CIE-10 (Subclasificacion)/Diagnosis of Psychiatric Disorders, CIE-10 criteria (subclassification)',
x2_diagnostico_trs_psiquiatrico_cie_10 = 'Diagnóstico de Trastorno Psiquiátrico, Criterios CIE-10 (2)/Diagnosis of Psychiatric Disorders, CIE-10 criteria (2)',
x2_diagnostico_trs_psiquiatrico_sub_cie_10 = 'Diagnóstico de Trastorno Psiquiátrico, Criterios CIE-10 (Subclasificacion) (2)/Diagnosis of Psychiatric Disorders, CIE-10 criteria (subclassification) (2)',
x3_diagnostico_trs_psiquiatrico_cie_10 = 'Diagnóstico de Trastorno Psiquiátrico, Criterios CIE-10 (3)/Diagnosis of Psychiatric Disorders, CIE-10 criteria (3)',
x3_diagnostico_trs_psiquiatrico_sub_cie_10 = 'Diagnóstico de Trastorno Psiquiátrico, Criterios CIE-10 (Subclasificacion) (3)/Diagnosis of Psychiatric Disorders, CIE-10 criteria (subclassification) (3)',
diagnostico_trs_fisico = 'Diagnóstico de Trastorno Físico/Diagnosis of Physical Disorder',
otros_problemas_de_atencion_de_salud_mental = 'Otros Problemas de Atención Vinculados a Salud Mental/Other problems linked to Mental Health',
compromiso_biopsicosocial = 'Compromiso Biopsicosocial/Biopsychosocial Involvement',
diagnostico_global_de_necesidades_de_integracion_social = 'Diagnóstico Global de Necesidades de Integración Social/Global Diagnosis of Social Integration',
diagnostico_de_necesidades_de_integrac_io_n_social_en_capital_humano = 'Diagnóstico de Necesidades de Integración Social en Capital Humano/Global Diagnosis of Social Integration in Human Capital',
diagnostico_de_necesidades_de_integrac_io_n_social_en_capital_fisico = 'Diagnóstico de Necesidades de Integración Social en Capital Físico/Global Diagnosis of Social Integration in Physical Capital',
diagnostico_de_necesidades_de_integrac_io_n_social_en_capital_social = 'Diagnóstico de Necesidades de Integración Social en Capital Social/Global Diagnosis of Social Integration in Social Capital',
fech_ing = 'Fecha de Ingreso a Tratamiento/Date of Admission to Treatment',
fecha_ingreso_a_convenio_senda = 'Fecha de Ingreso a Convenio SENDA (aún no formateada como fecha)/Date of Admission to SENDA Agreement',
usuario_de_tribunales_tratamiento_drogas = 'Usuario de modalidad Tribunales de Tratamiento de Drogas/User of Drug Treatment Courts Modality',
consentimiento_informado = 'Consentimiento Informado/Informed Consent',
fech_egres = 'Fecha de Egreso de Tratamiento/Date of Discharge from Treatment',
motivodeegreso = 'Motivo de Egreso/Cause of Discharge',
tipo_centro_derivacion = 'Tipo de Centro al que el Usuario es Derivado/Type of Center of Derivation',
evaluacindelprocesoteraputico = 'Evaluación del Proceso Terapéutico/Evaluation of the Therapeutic Process',
eva_consumo = 'Evaluación al Egreso Respecto al Patrón de consumo/Evaluation at Discharge regarding to Consumption Pattern',
eva_fam = 'Evaluación al Egreso Respecto a Situación Familiar/Evaluation at Discharge regarding to Family Situation',
eva_relinterp = 'Evaluación al Egreso Respecto a Relaciones Interpersonales/Evaluation at Discharge regarding to Interpersonal Relations',
eva_ocupacion = 'Evaluación al Egreso Respecto a Situación Ocupacional/Evaluation at Discharge regarding to Occupational Status',
eva_sm = 'Evaluación al Egreso Respecto a Salud Mental/Evaluation at Discharge regarding to Mental Health',
eva_fisica = 'Evaluación al Egreso Respecto a Salud Física/Evaluation at Discharge regarding to Physical Health',
eva_transgnorma = 'Evaluación al Egreso Respecto a Trasgresión a la Norma Social/Evaluation at Discharge regarding to Transgression to the Norm',
diagnostico_trastorno_psiquiatrico_cie_10_al_egreso = '(Sólo presenta valores perdidos)/',
diagnostico_global_de_necesidades_de_integracion_social_1 = 'Diagnóstico Global de Necesidades de Integración Social (1)/Global Diagnosis of Social Integration (1)',
diagnostico_de_necesidades_de_integrac_io_n_social_en_capital_humano_1 = 'Diagnóstico de Necesidades de Integración Social en Capital Humano (1)/Global Diagnosis of Social Integration in Human Capital (1)',
diagnostico_de_necesidades_de_integrac_io_n_social_en_capital_fisico_1 = 'Diagnóstico de Necesidades de Integración Social en Capital Físico (1)/Global Diagnosis of Social Integration in Physical Capital (1)',
diagnostico_de_necesidades_de_integrac_io_n_social_en_capital_social_1 = 'Diagnóstico de Necesidades de Integración Social en Capital Social (1)/Global Diagnosis of Social Integration in Social Capital (1)',
tiene_menores_de_edad_a_cargo = 'Menores de Edad A Cargo/Minor Dependants',
motivo_de_egreso_alta_administrativa = 'Motivo de Egreso Alta Administrativa/Cause of Administrative Discharge',
consorcio = 'Sociedades de Tratamiento, Servicios de Salud, Fundaciones, entre otras entidades encargadas de los centros/Consortium',
id_centro = 'ID de Centro/Center ID',
ha_estado_embarazada_egreso = '¿Ha estado embarazada? (al Egreso)/Have you been Pregnant (at Discharge)',
identidad_de_genero = 'Identidad de Género/Gender Identity',
discapacidad = 'Presenta Discapacidad/Disability',
hash_rut_completo = 'HASH alternativo, en el escenario en que se asuma que el individuo al que se le codificó el RUT presente mayor edad/Alternative HASH-Key',
opcion_discapacidad = 'Origen de Discapacidad/Cause of Disability',
sexo_2 = 'Sexo Usuario/Sex of User',
embarazo = 'Embarazo/Pregnant',
tipo_de_plan_2 = 'Tipo de Plan/Type of Plan',
tipo_de_programa_2 = 'Tipo de Programa de Tratamiento/Type of Program',
fech_egres_sin_fmt = 'Fecha de Egreso de Tratamiento (Sin Formato de Fecha)/Date of Discharge',
id_mod = 'ID de SENDA para Presentación en Página Web (enmascara caracteres 5 y 6)/SENDAs ID (mask characters 5 & 6)',
ano_nac = 'Año de Nacimiento (numérico)/Year of Birth (numeric)',
fech_ing_ano = 'Año de Ingreso (numérico)/Year of Admission (numeric)',
fech_ing_mes = 'Mes de Ingreso (numérico)/Month of Admission (numeric)',
fech_ing_dia = 'Día de Ingreso (numérico)/Day of Admission (numeric)',
concat = 'ID de SENDA y HASH Concatenado (permite discriminar más de un HASH en un mismo ID)/Combination of SENDAs ID & HASH',
dias_trat_inv = 'Días de Tratamiento Invertidos (fecha más reciente, menor valor numérico)/Treatment Days (Reversed)',
fech_nac = 'Fecha de Nacimiento/Date of Birth',
edad_al_ing = 'Edad a la Fecha de Ingreso a Tratamiento (numérico continuo)/Age at Admission to Treatment',
edad_ini_cons= 'Edad de Inicio de Consumo/ Age of Onset of Drug Use',
edad_ini_sus_prin =  'Edad de Inicio de Consumo Sustancia Principal/ Age of Onset of Drug Use Principal Substance',
dias_trat_alta_temprana = 'Días de tratamiento (<90)/ Less than 90 days in treatment',
motivodeegreso_mod = 'Motivo de Egreso (con abandono temprano y tardío)/Cause of Discharge (with late and early withdrawal)',
sus_principal = 'Sustancia Principal de Consumo/Main Substance of Consumption',
otras_sus1= 'Otras Sustancias (1)/Other Substances (1)',
otras_sus2= 'Otras Sustancias (2)/Other Substances (2)',
otras_sus3= 'Otras Sustancias (3)/Other Substances (3)',
sus_ini= 'Sustancia de Inicio/Starting Substance',
estado_conyugal_2='Estado Conyugal/Marital Status',
estatus_ocupacional= 'Condición Ocupacional/Occupational Status',
cat_ocupacional= 'Categoría Ocupacional/Occupational Category',
edad_grupos	= 'Edad agrupada/Age in groups',
origen_ingreso= 'Origen de Ingreso/Motive of Admission to Treatment',
escolaridad= 'Escolaridad: Nivel Eduacional/Educational Attainment',
freq_cons_sus_prin = 'Frecuencia de Consumo de la Sustancia Principal/Frequency of Consumption of the Main Substance',
via_adm_sus_prin = 'Vía de Administración de la Sustancia Principal/Route of Administration of the Main Substance')
#PARA EXPORTAR LABELS A EXCEL
#data.table::data.table(table(CONS_C1_df_dup_FEB_2020_prev2$identidad.de.genero, exclude=NULL)) %>% mutate(export=paste0(row_number(),".",V1)) %>% select(-V1) %>% select(export,N)%>% copiar_nombres()
```


## 1. Probabilistic Matches

&nbsp;

The code used in stata is shown here:

&nbsp;
<br>

```{r generate data in csv, echo=F, paged.print=TRUE}
#write.csv2(CONS_C1_df_dup_FEB_2020_prev2, file ="G:/Mi unidad/Alvacast/SISTRAT 2019 (github)/SUD_CL/CONS_C1_df_dup_FEB_2020.csv")
#write.csv(.,"_matches_feb_2020.csv", row.names = FALSE)
#_#_#_#_#_#_#_#_#
#_#_#_#_#_#_#_#_#PARA CAMBIAR LOS NOMBRES DE LAS COLUMNas##_#_#_#_#_#_#_#_
##COMPARAR##
#copiar_nombres(data.frame(original = colnames(CONS_C1_df_dup_FEB_2020_prev2), clean_names = colnames(clean_names(CONS_C1_df_dup_FEB_2020_prev2))))
#_#_#_#_#_#_#_#_#
#_#_#_#_#_#_#_#_#
CONS_C1_df_dup_FEB_2020_prev2 %>%
  dplyr::arrange(hash_key, desc(fech_ing)) %>% 
  dplyr::group_by(hash_key) %>% 
  dplyr::mutate(fech_egres_imp = dplyr::lag(fech_ing, n = 1, default = NA)) %>%
  dplyr::ungroup() %>%
  dplyr::mutate(fech_egres_imp=ifelse(is.na(fech_egres),as.character(fech_egres_imp),as.character(fech_egres))) %>%
  dplyr::mutate(dias_trat_imp= as.numeric(as.Date(fech_egres_imp))-as.numeric(as.Date(fech_ing))) %>%
  dplyr::mutate(dias_trat_alta_temprana_imp=ifelse(dias_trat_imp>=90,0,1)) %>%
  dplyr::mutate(dias_trat_alta_temprana_imp=as.factor(dias_trat_alta_temprana_imp)) %>%
  dplyr::mutate(dias_trat_alta_temprana_imp= dplyr::recode(dias_trat_alta_temprana_imp, "1"="Menos de 90 días", "0"="Mayor o igual a 90 días")) %>%
  dplyr::mutate(motivodeegreso_mod_imp= ifelse(dias_trat_alta_temprana_imp=="Menos de 90 días" & motivodeegreso=="Abandono", "Abandono Temprano",as.character(motivodeegreso))) %>% ## CONSTE QUE ESTO NO VA A FUNCIONAR
  dplyr::mutate(motivodeegreso_mod_imp= ifelse(dias_trat_alta_temprana_imp=="Mayor o igual a 90 días" & motivodeegreso=="Abandono", "Abandono Tardio",as.character(motivodeegreso_mod_imp))) %>% 
  dplyr::mutate(motivodeegreso_mod_imp=as.factor(motivodeegreso_mod_imp)) %>%
  rio::export(file = "CONS_C1_df_dup_FEB_2020.dta")
#####to_export_labels
tibble::rownames_to_column(data.frame(Hmisc::label(CONS_C1_df_dup_FEB_2020_prev2))) %>% data.frame() %>%
  dplyr::rename("code" = !!names(.[1]), "label" = !!names(.[2])) %>% data.frame() %>% 
  dplyr::filter(label!="") %>%
  bind_rows(data.frame("code"=c("fech_egres_imp", 
                                "dias_trat_imp",
                                "dias_trat_alta_temprana_imp",
                                "motivodeegreso_mod_imp"), "label"=c("Date of Discharge (Imputed)", 
                                                                     "Days of Treatment (Imputed)",
                                                                     "Days of Treatment for Early Withdrawal (Imputed)",
                                                                     "Cause of Discharge w/ Early or Late Withdrawal (Imputed)"))) %>% 
  assign("labels_CONS_C1_df_dup_FEB_2020_prev2",., envir = .GlobalEnv) %>% 
  write.csv2("__labels_to_stata.csv")
```

```{stata, collectcode=TRUE}
import delimited "G:\Mi unidad\Alvacast\SISTRAT 2019 (github)\SUD_CL\CONS_C1_df_dup_FEB_2020.csv", delimiter(";") clear 

cap gen date_in = mdy(real_fech_ing_mes, real_fech_ing_dia, real_fech_ing_ano)
cap gen date_in = mdy(fech_ing_mes, fech_ing_dia, fech_ing_ano)

generate id_match = _n
cap drop _id
dtalink hash_key 25 -25 idcentro 10 0 date_in 30 -30 5 Edad 7 -7 escolaridad 8 -8 sexo 10 -10 id 10 -10, block(edad) cutoff(70)
drop if missing(_score)
cap qui save "G:\Mi unidad\Alvacast\SISTRAT 2019 (github)\Stata Duplicates Match\_CONS_C1_df_match70_2020_02_20.dta"
cap qui save "G:\Mi unidad\Alvacast\SISTRAT 2019 (github)\Stata Duplicates Match\_CONS_C1_df_match70_2020_02_20.dta", replace
```
<br>

```{r  dta_import, include=T, echo=T, eval=F, cache=T}
matches_from_stata_c1_feb <- haven::read_dta("G:/Mi unidad/Alvacast/SISTRAT 2019 (github)/Stata Duplicates Match/_CONS_C1_df_match70_2020_02_20.dta")
matches_from_stata_c1_feb <-matches_from_stata_c1 %>% dplyr::rename(score = 3, matchID = 1, row_id=2) 
matches_from_stata_c1_feb  %>%
  dplyr::arrange(score,matchID,hash_key) %>%
  dplyr::select(score, matchID, hash_key, ano_bd, idcentro, date_in, fech_ing, fech_egres, edad, dias_trat) %>%
  as.data.frame() %>%
    knitr::kable(.,format = "html", format.args = list(decimal.mark = ".", big.mark = ","),
                   caption="Table 6. Preliminary View of Matches from Stata", align =rep('c', 100)) %>%
     kableExtra::kable_styling(bootstrap_options = c("striped", "hover"),font_size = 8) %>%
    kableExtra::scroll_box(width = "100%", height = "350px")
```
<br>


<br>

## 2. Data Editing / Deductive Imputation

There are `r CONS_C1_df_dup_FEB_2020_prev1 %>% dplyr::filter(sus_principal=="Cocaína", via_adm_sus_prin!="Intranasal  ( aspiración de polvo por la nariz)") %>% nrow() %>% formatC(, format="f", big.mark=",", digits=0)` cases that does not snort Cocaine.

<br>

```{r  coca_no_aspiracion, include=T, echo=T, eval=T, cache=T}
CONS_C1_df_dup_FEB_2020_prev1 %>% dplyr::filter(sus_principal=="Cocaína", via_adm_sus_prin!="Intranasal  ( aspiración de polvo por la nariz)") %>% nrow()
```

<br>

There are `r CONS_C1_df_dup_FEB_2020_prev1 %>% dplyr::filter(sus_principal=="Cocaína", via_adm_sus_prin!="Intranasal  ( aspiración de polvo por la nariz)") %>% nrow() %>% formatC(, format="f", big.mark=",", digits=0)` cases that does not snort Cocaine.

<br>

We must replace alcohol route of administration of principal substance to make it exclusivelly oral.

<br>

```{r  recods, include=T, echo=T, eval=T, cache=T}
CONS_C1_df_dup_FEB_2020_prev1 %>% dplyr::filter(escolaridad=="Mayor a Ed Secundaria", Edad<21) %>% nrow()
CONS_C1_df_dup_FEB_2020_prev1 %>% dplyr::filter(sus_principal=="Inhalables") %>% dplyr::group_by(via_adm_sus_prin) %>% summarise(n=n())
CONS_C1_df_dup_FEB_2020_prev1 %>% dplyr::filter(sus_principal=="Alcohol") %>% dplyr::group_by(via_adm_sus_prin) %>% summarise(n=n())
```


There are some cases that does not have a primary diagnostic, but have a secondary or tertiary

Programa Específico Mujeres	MASA1**031978, ver si es hombre o mujer de verdad

## 3. Different Information Within User, Concerning Personal Information

We may see that many users have more than one disctinct personal information. In fact, these inconsistencies within users (incluiding those related to the date of birth) may impact in their SENDA's ID, making it difficult to detect changes along users in the datasets. Fortunately, we have the encripted code of the national identity number, which can replace SENDAs ID.

- Sex (sexo) (`r CONS_C1_df_dup_FEB_2020_prev2 %>% dplyr::group_by(hash_key) %>% dplyr::mutate(sexo_por_hash=dplyr::n_distinct(sexo)) %>% ungroup() %>% dplyr::filter(sexo_por_hash>1) %>% nrow() %>%  formatC(, format="f", big.mark=",", digits=0)`)
<!--- considerar la identidad de género. Esto puede haber afectado la imputación de casos para tipo_de_plan y tipo_de_programa  --->

```{r pers_info_sex, eval=F,echo=T, paged.print=TRUE}
CONS_C1_df_dup_FEB_2020_prev2_sex <- CONS_C1_df_dup_FEB_2020_prev2 %>% group_by(hash_key) %>% dplyr::mutate(sexo_por_hash=n_distinct(sexo)) %>% ungroup() %>% dplyr::filter(sexo_por_hash>1) %>% dplyr::distinct(hash_key)
CONS_C1_df_dup_FEB_2020_prev2 %>% 
 dplyr::filter(hash_key %in% as.character(as.vector(unlist(as.data.table(unlist(CONS_C1_df_dup_FEB_2020_prev2_sex)))))) %>% # Select HASHs of cited cases
 dplyr::arrange(hash_key) %>% #ordeno por ids 
  dplyr::select(row, hash_key, ano_bd, sexo, identidad.de.genero,Edad_al_ing, fech_ing, fech_egres, tipo_de_plan, SENDA)%>%
    knitr::kable(.,format = "html", format.args = list(decimal.mark = ".", big.mark = ","),
               caption="Table 7. HASHs with more than one Sex",
                 align =rep('c', 101))  %>%
   kableExtra::kable_styling(bootstrap_options = c("striped", "hover"),font_size = 8) %>%
  kableExtra::scroll_box(width = "100%", height = "375px")
#_______________________
###PARA HACER LA CONVERSION
#_______________________
#CONS_C1_df_dup_FEB_2020_prev2 %>%
#    #dplyr::filter(hash_key %in% as.character(as.vector(unlist(as.data.table(unlist(CONS_C1_df_dup_FEB_2020_prev2_sex)))))) %>% 
#    dplyr::mutate(concat_hash_sex=paste0(hash_key,"_",sexo)) %>%
#    dplyr::group_by(concat_hash_sex) %>%
#    dplyr::add_tally() %>% 
#    dplyr::ungroup() %>%  
#    dplyr::select(hash_key,id, id_mod, ano_bd, Edad, fech_nac,ano_nac,n) %>%
#    dplyr::group_by(hash_key) %>% #primero genero la variable
#    dplyr::slice(which.max(n))%>% 
#    #dplyr::filter(hash_key=="00a8e1377935f1639a28faa9c11ee03a")
#    assign("CONS_C1_df_dup_FEB_2020_prev2_most_frequent_age_dataset",., envir = .GlobalEnv)
#CONS_C1_df_dup_FEB_2020_prev2_prev4 %>%
    #dplyr::filter(hash_key %in% as.character(as.vector(unlist(as.data.table(unlist(CONS_C1_df_dup_FEB_2020_prev2_sex)))))) %>% 
#    dplyr::select(hash_key,id,id_mod, ano_bd, Sexo, Edad_al_ing) %>%
#    dplyr::group_by(hash_key) %>% #primero genero la variable
#    dplyr::slice(which.max(ano_bd))%>%
#    assign("CONS_C1_df_dup_FEB_2020_prev2_max_age",., envir = .GlobalEnv) 
    #dplyr::filter(hash_key=="00012586ea3036b7a18093c396847a87")
```

- Masked SENDAs ID (id_mod) (`r CONS_C1_df_dup_FEB_2020_prev2 %>% group_by(hash_key) %>% dplyr::mutate(id_mod_por_hash=n_distinct(id_mod)) %>% ungroup() %>% dplyr::filter(id_mod_por_hash>1) %>% nrow() %>%  formatC(, format="f", big.mark=",", digits=0)`)
- SENDAs ID (id) (`r CONS_C1_df_dup_FEB_2020_prev2 %>% group_by(hash_key) %>% dplyr::mutate(id_por_hash=n_distinct(id)) %>% ungroup() %>% dplyr::filter(id_por_hash>1) %>% nrow() %>%  formatC(, format="f", big.mark=",", digits=0)`)

<!---# considerar la fecha de nacimiento y el sexo--->

```{r pers_info_id, eval=F,echo=T, paged.print=TRUE}
CONS_C1_df_dup_FEB_2020_prev2_ids <- CONS_C1_df_dup_FEB_2020_prev2 %>% group_by(hash_key) %>% dplyr::mutate(id_por_hash=n_distinct(id)) %>% ungroup() %>% dplyr::filter(id_por_hash>1) %>% dplyr::distinct(hash_key)
CONS_C1_df_dup_FEB_2020_prev2 %>% 
 dplyr::filter(hash_key %in% as.character(as.vector(unlist(as.data.table(unlist(CONS_C1_df_dup_FEB_2020_prev2_ids)))))) %>% # Select HASHs of cited cases
 dplyr::arrange(hash_key) %>% #ordeno por ids 
dplyr::select(row, hash_key, ano_bd, id_mod, sexo, fech_nac,Edad_al_ing, fech_ing, fech_egres, tipo_de_plan, SENDA)%>%
    knitr::kable(.,format = "html", format.args = list(decimal.mark = ".", big.mark = ","),
               caption="Table 8. HASHs with more than one ID",
                 align =rep('c', 101))  %>%
   kableExtra::kable_styling(bootstrap_options = c("striped", "hover"),font_size = 8) %>%
  kableExtra::scroll_box(width = "100%", height = "375px")
#_______________________
###PARA HACER LA CONVERSION
#_______________________
#CONS_C1_df_dup_FEB_2020_prev2 %>%
#    #dplyr::filter(hash_key %in% as.character(as.vector(unlist(as.data.table(unlist(CONS_C1_df_dup_FEB_2020_prev2_ids)))))) %>% 
#    dplyr::mutate(concat_hash_id=paste0(hash_key,"_",id)) %>%
#    dplyr::group_by(concat_hash_id) %>%
#    dplyr::add_tally() %>% 
#    dplyr::ungroup() %>%  
#    dplyr::select(hash_key,id, id_mod, ano_bd, Edad, fech_nac,ano_nac,n) %>%
#    dplyr::group_by(hash_key) %>% #primero genero la variable
#    dplyr::slice(which.max(n))%>% 
#    #dplyr::filter(hash_key=="00a8e1377935f1639a28faa9c11ee03a")
#    assign("CONS_C1_df_dup_FEB_2020_prev2_most_frequent_age_dataset",., envir = .GlobalEnv)
#CONS_C1_df_dup_FEB_2020_prev2_prev4 %>%
    #dplyr::filter(hash_key %in% as.character(as.vector(unlist(as.data.table(unlist(CONS_C1_df_dup_FEB_2020_prev2_ids)))))) %>% 
#    dplyr::select(hash_key,id,id_mod, ano_bd, Sexo, Edad_al_ing) %>%
#    dplyr::group_by(hash_key) %>% #primero genero la variable
#    dplyr::slice(which.max(ano_bd))%>%
#    assign("CONS_C1_df_dup_FEB_2020_prev2_max_age",., envir = .GlobalEnv) 
    #dplyr::filter(hash_key=="00012586ea3036b7a18093c396847a87")
```
<!--- La fecha de nacimiento puede no haberse corregido del todo porque hay muchos casos en que no tienen una edad distinta, por lo que el programa no  los filtra  --->
- Date of Birth (fech_nac) (`r CONS_C1_df_dup_FEB_2020_prev2 %>% group_by(hash_key) %>% dplyr::mutate(fech_nac_por_hash=n_distinct(fech_nac)) %>% ungroup() %>% dplyr::filter(fech_nac_por_hash>1) %>% nrow() %>%  formatC(, format="f", big.mark=",", digits=0)`)

```{r pers_info_fech_nac,eval=F, echo=T, paged.print=TRUE}
CONS_C1_df_dup_FEB_2020_prev2_fech_nac <- CONS_C1_df_dup_FEB_2020_prev2 %>% group_by(hash_key) %>% dplyr::mutate(fech_nac_por_hash=n_distinct(fech_nac)) %>% ungroup() %>% dplyr::filter(fech_nac_por_hash>1) %>% dplyr::distinct(hash_key)
CONS_C1_df_dup_FEB_2020_prev2 %>% 
 dplyr::filter(hash_key %in% as.character(as.vector(unlist(as.data.table(unlist(CONS_C1_df_dup_FEB_2020_prev2_fech_nac)))))) %>% # Select HASHs of cited cases
 dplyr::arrange(hash_key) %>% #ordeno por ids 
dplyr::select(row, hash_key, ano_bd, id_mod, sexo, fech_nac,Edad_al_ing, fech_ing, fech_egres, tipo_de_plan, SENDA)%>%
    knitr::kable(.,format = "html", format.args = list(decimal.mark = ".", big.mark = ","),
               caption="Table 9. HASHs with more than one Date of Birth",
                 align =rep('c', 101))  %>%
   kableExtra::kable_styling(bootstrap_options = c("striped", "hover"),font_size = 8) %>%
  kableExtra::scroll_box(width = "100%", height = "375px")
#_______________________
###PARA HACER LA CONVERSION
#_______________________
#CONS_C1_df_dup_FEB_2020_prev2 %>%
#    #dplyr::filter(hash_key %in% as.character(as.vector(unlist(as.data.table(unlist(CONS_C1_df_dup_FEB_2020_prev2_fech_nac)))))) %>% 
#    dplyr::mutate(concat_hash_id=paste0(hash_key,"_",id)) %>%
#    dplyr::group_by(concat_hash_id) %>%
#    dplyr::add_tally() %>% 
#    dplyr::ungroup() %>%  
#    dplyr::select(hash_key,id, id_mod, ano_bd, Edad, fech_nac,fech_nac,n) %>%
#    dplyr::group_by(hash_key) %>% #primero genero la variable
#    dplyr::slice(which.max(n))%>% 
#    #dplyr::filter(hash_key=="00a8e1377935f1639a28faa9c11ee03a")
#    assign("CONS_C1_df_dup_FEB_2020_prev2_most_frequent_age_dataset",., envir = .GlobalEnv)
#CONS_C1_df_dup_FEB_2020_prev2_prev4 %>%
    #dplyr::filter(hash_key %in% as.character(as.vector(unlist(as.data.table(unlist(CONS_C1_df_dup_FEB_2020_prev2_fech_nac)))))) %>% 
#    dplyr::select(hash_key,id,id_mod, ano_bd, Sexo, Edad_al_ing) %>%
#    dplyr::group_by(hash_key) %>% #primero genero la variable
#    dplyr::slice(which.max(ano_bd))%>%
#    assign("CONS_C1_df_dup_FEB_2020_prev2_max_age",., envir = .GlobalEnv) 
    #dplyr::filter(hash_key=="00012586ea3036b7a18093c396847a87")
```

- Year of Birth (ano_nac) (`r CONS_C1_df_dup_FEB_2020_prev2 %>% group_by(hash_key) %>% dplyr::mutate(ano_nac_por_hash=n_distinct(ano_nac)) %>% ungroup() %>% dplyr::filter(ano_nac_por_hash>1) %>% nrow() %>%  formatC(, format="f", big.mark=",", digits=0)`)

```{r pers_info_ano_nac,eval=F, echo=T, paged.print=TRUE}
CONS_C1_df_dup_FEB_2020_prev2_ano_nac <- CONS_C1_df_dup_FEB_2020_prev2 %>% group_by(hash_key) %>% dplyr::mutate(ano_nac_por_hash=n_distinct(ano_nac)) %>% ungroup() %>% dplyr::filter(ano_nac_por_hash>1) %>% dplyr::distinct(hash_key)
CONS_C1_df_dup_FEB_2020_prev2 %>% 
 dplyr::filter(hash_key %in% as.character(as.vector(unlist(as.data.table(unlist(CONS_C1_df_dup_FEB_2020_prev2_ano_nac)))))) %>% # Select HASHs of cited cases
 dplyr::arrange(hash_key) %>% #ordeno por ids 
dplyr::select(row, hash_key, ano_bd, id_mod, sexo, fech_nac,Edad_al_ing, fech_ing, fech_egres, tipo_de_plan, SENDA)%>%
    knitr::kable(.,format = "html", format.args = list(decimal.mark = ".", big.mark = ","),
               caption="Table 10. HASHs with more than one Year of Birth",
                 align =rep('c', 101))  %>%
   kableExtra::kable_styling(bootstrap_options = c("striped", "hover"),font_size = 8) %>%
  kableExtra::scroll_box(width = "100%", height = "375px")
#_______________________
###PARA HACER LA CONVERSION
#_______________________
#CONS_C1_df_dup_FEB_2020_prev2 %>%
#    #dplyr::filter(hash_key %in% as.character(as.vector(unlist(as.data.table(unlist(CONS_C1_df_dup_FEB_2020_prev2_ano_nac)))))) %>% 
#    dplyr::mutate(concat_hash_id=paste0(hash_key,"_",id)) %>%
#    dplyr::group_by(concat_hash_id) %>%
#    dplyr::add_tally() %>% 
#    dplyr::ungroup() %>%  
#    dplyr::select(hash_key,id, id_mod, ano_bd, Edad, fech_nac,ano_nac,n) %>%
#    dplyr::group_by(hash_key) %>% #primero genero la variable
#    dplyr::slice(which.max(n))%>% 
#    #dplyr::filter(hash_key=="00a8e1377935f1639a28faa9c11ee03a")
#    assign("CONS_C1_df_dup_FEB_2020_prev2_most_frequent_age_dataset",., envir = .GlobalEnv)
#CONS_C1_df_dup_FEB_2020_prev2_prev4 %>%
    #dplyr::filter(hash_key %in% as.character(as.vector(unlist(as.data.table(unlist(CONS_C1_df_dup_FEB_2020_prev2_ano_nac)))))) %>% 
#    dplyr::select(hash_key,id,id_mod, ano_bd, Sexo, Edad_al_ing) %>%
#    dplyr::group_by(hash_key) %>% #primero genero la variable
#    dplyr::slice(which.max(ano_bd))%>%
#    assign("CONS_C1_df_dup_FEB_2020_prev2_max_age",., envir = .GlobalEnv) 
    #dplyr::filter(hash_key=="00012586ea3036b7a18093c396847a87")
```

- Nationallity (nacionalidad) (`r CONS_C1_df_dup_FEB_2020_prev2 %>% group_by(hash_key) %>% dplyr::mutate(nacionalidad_por_hash=n_distinct(nacionalidad)) %>% ungroup() %>% dplyr::filter(nacionalidad_por_hash>1) %>% nrow() %>%  formatC(, format="f", big.mark=",", digits=0)`)

```{r pers_info_nationallity, eval=F,echo=T, paged.print=TRUE}
CONS_C1_df_dup_FEB_2020_prev2_nat <- CONS_C1_df_dup_FEB_2020_prev2 %>% group_by(hash_key) %>% dplyr::mutate(nat_por_hash=n_distinct(nacionalidad)) %>% ungroup() %>% dplyr::filter(nat_por_hash>1) %>% dplyr::distinct(hash_key)
CONS_C1_df_dup_FEB_2020_prev2 %>% 
 dplyr::filter(hash_key %in% as.character(as.vector(unlist(as.data.table(unlist(CONS_C1_df_dup_FEB_2020_prev2_nat)))))) %>% # Select HASHs of cited cases
 dplyr::arrange(hash_key) %>% #ordeno por ids 
dplyr::select(row, hash_key, ano_bd, nacionalidad, etnia, sexo, fech_nac,Edad_al_ing, fech_ing, fech_egres, tipo_de_plan, SENDA)%>%
    knitr::kable(.,format = "html", format.args = list(decimal.mark = ".", big.mark = ","),
               caption="Table 11. HASHs with more than one Nationallity",
                 align =rep('c', 101))  %>%
   kableExtra::kable_styling(bootstrap_options = c("striped", "hover"),font_size = 8) %>%
  kableExtra::scroll_box(width = "100%", height = "375px")
#_______________________
###PARA HACER LA CONVERSION
#_______________________
#CONS_C1_df_dup_FEB_2020_prev2 %>%
#    #dplyr::filter(hash_key %in% as.character(as.vector(unlist(as.data.table(unlist(CONS_C1_df_dup_FEB_2020_prev2_nat)))))) %>% 
#    dplyr::mutate(concat_hash_id=paste0(hash_key,"_",id)) %>%
#    dplyr::group_by(concat_hash_id) %>%
#    dplyr::add_tally() %>% 
#    dplyr::ungroup() %>%  
#    dplyr::select(hash_key,id, id_mod, ano_bd, Edad, fech_nac,ano_nac,n) %>%
#    dplyr::group_by(hash_key) %>% #primero genero la variable
#    dplyr::slice(which.max(n))%>% 
#    #dplyr::filter(hash_key=="00a8e1377935f1639a28faa9c11ee03a")
#    assign("CONS_C1_df_dup_FEB_2020_prev2_most_frequent_age_dataset",., envir = .GlobalEnv)
#CONS_C1_df_dup_FEB_2020_prev2_prev4 %>%
    #dplyr::filter(hash_key %in% as.character(as.vector(unlist(as.data.table(unlist(CONS_C1_df_dup_FEB_2020_prev2_nat)))))) %>% 
#    dplyr::select(hash_key,id,id_mod, ano_bd, Sexo, Edad_al_ing) %>%
#    dplyr::group_by(hash_key) %>% #primero genero la variable
#    dplyr::slice(which.max(ano_bd))%>%
#    assign("CONS_C1_df_dup_FEB_2020_prev2_max_age",., envir = .GlobalEnv) 
    #dplyr::filter(hash_key=="00012586ea3036b7a18093c396847a87")
```

- Ethnicity (etnia) (`r CONS_C1_df_dup_FEB_2020_prev2 %>% group_by(hash_key) %>% dplyr::mutate(etnia_por_hash=n_distinct(etnia)) %>% ungroup() %>% dplyr::filter(etnia_por_hash>1) %>% nrow() %>%  formatC(, format="f", big.mark=",", digits=0)`)

```{r pers_info_etnia, eval=F,echo=T, paged.print=TRUE}
CONS_C1_df_dup_FEB_2020_prev2_etnia <- CONS_C1_df_dup_FEB_2020_prev2 %>% group_by(hash_key) %>% dplyr::mutate(etnia_por_hash=n_distinct(etnia)) %>% ungroup() %>% dplyr::filter(etnia_por_hash>1) %>% dplyr::distinct(hash_key)
CONS_C1_df_dup_FEB_2020_prev2 %>% 
 dplyr::filter(hash_key %in% as.character(as.vector(unlist(as.data.table(unlist(CONS_C1_df_dup_FEB_2020_prev2_etnia)))))) %>% # Select HASHs of cited cases
 dplyr::arrange(hash_key) %>% #ordeno por ids 
dplyr::select(row, hash_key, ano_bd, nacionalidad, etnia, sexo, fech_nac,Edad_al_ing, fech_ing, fech_egres, tipo_de_plan, SENDA)%>%
    knitr::kable(.,format = "html", format.args = list(decimal.mark = ".", big.mark = ","),
               caption="Table 12. HASHs with more than one Ethnicity",
                 align =rep('c', 101))  %>%
   kableExtra::kable_styling(bootstrap_options = c("striped", "hover"),font_size = 8) %>%
  kableExtra::scroll_box(width = "100%", height = "375px")
#_______________________
###PARA HACER LA CONVERSION
#_______________________
#CONS_C1_df_dup_FEB_2020_prev2 %>%
#    #dplyr::filter(hash_key %in% as.character(as.vector(unlist(as.data.table(unlist(CONS_C1_df_dup_FEB_2020_prev2_nat)))))) %>% 
#    dplyr::mutate(concat_hash_id=paste0(hash_key,"_",id)) %>%
#    dplyr::group_by(concat_hash_id) %>%x
#    dplyr::add_tally() %>% 
#    dplyr::ungroup() %>%  
#    dplyr::select(hash_key,id, id_mod, ano_bd, Edad, fech_nac,ano_nac,n) %>%
#    dplyr::group_by(hash_key) %>% #primero genero la variable
#    dplyr::slice(which.max(n))%>% 
#    #dplyr::filter(hash_key=="00a8e1377935f1639a28faa9c11ee03a")
#    assign("CONS_C1_df_dup_FEB_2020_prev2_most_frequent_age_dataset",., envir = .GlobalEnv)
#CONS_C1_df_dup_FEB_2020_prev2_prev4 %>%
    #dplyr::filter(hash_key %in% as.character(as.vector(unlist(as.data.table(unlist(CONS_C1_df_dup_FEB_2020_prev2_nat)))))) %>% 
#    dplyr::select(hash_key,id,id_mod, ano_bd, Sexo, Edad_al_ing) %>%
#    dplyr::group_by(hash_key) %>% #primero genero la variable
#    dplyr::slice(which.max(ano_bd))%>%
#    assign("CONS_C1_df_dup_FEB_2020_prev2_max_age",., envir = .GlobalEnv) 
    #dplyr::filter(hash_key=="00012586ea3036b7a18093c396847a87")
```

- Age of Onset of Drug Use (edad_ini_cons) (`r CONS_C1_df_dup_FEB_2020_prev2 %>% group_by(hash_key) %>% dplyr::mutate(edad_ini_cons_por_hash=n_distinct(edad_ini_cons)) %>% ungroup() %>% dplyr::filter(edad_ini_cons_por_hash>1) %>% nrow() %>%  formatC(, format="f", big.mark=",", digits=0)`)

```{r pers_info_edad_ini_cons,eval=F, echo=T, paged.print=TRUE}
CONS_C1_df_dup_FEB_2020_prev2_edad_ini_cons <- CONS_C1_df_dup_FEB_2020_prev2 %>% group_by(hash_key) %>% dplyr::mutate(edad_ini_cons_por_hash=n_distinct(edad_ini_cons)) %>% ungroup() %>% dplyr::filter(edad_ini_cons_por_hash>1) %>% dplyr::distinct(hash_key)
CONS_C1_df_dup_FEB_2020_prev2 %>% 
 dplyr::filter(hash_key %in% as.character(as.vector(unlist(as.data.table(unlist(CONS_C1_df_dup_FEB_2020_prev2_edad_ini_cons)))))) %>% # Select HASHs of cited cases
 dplyr::arrange(hash_key) %>% #ordeno por ids 
dplyr::select(row, hash_key, ano_bd, edad_ini_cons, sexo, fech_nac,Edad_al_ing, fech_ing, fech_egres, tipo_de_plan, SENDA)%>%
    knitr::kable(.,format = "html", format.args = list(decimal.mark = ".", big.mark = ","),
               caption="Table 13. HASHs with more than one Age of Onset of Drug Use",
                 align =rep('c', 101))  %>%
   kableExtra::kable_styling(bootstrap_options = c("striped", "hover"),font_size = 8) %>%
  kableExtra::scroll_box(width = "100%", height = "375px")
#_______________________
###PARA HACER LA CONVERSION
#_______________________
#CONS_C1_df_dup_FEB_2020_prev2 %>%
#    #dplyr::filter(hash_key %in% as.character(as.vector(unlist(as.data.table(unlist(CONS_C1_df_dup_FEB_2020_prev2_nat)))))) %>% 
#    dplyr::mutate(concat_hash_id=paste0(hash_key,"_",id)) %>%
#    dplyr::group_by(concat_hash_id) %>%
#    dplyr::add_tally() %>% 
#    dplyr::ungroup() %>%  
#    dplyr::select(hash_key,id, id_mod, ano_bd, Edad, fech_nac,ano_nac,n) %>%
#    dplyr::group_by(hash_key) %>% #primero genero la variable
#    dplyr::slice(which.max(n))%>% 
#    #dplyr::filter(hash_key=="00a8e1377935f1639a28faa9c11ee03a")
#    assign("CONS_C1_df_dup_FEB_2020_prev2_most_frequent_age_dataset",., envir = .GlobalEnv)
#CONS_C1_df_dup_FEB_2020_prev2_prev4 %>%
    #dplyr::filter(hash_key %in% as.character(as.vector(unlist(as.data.table(unlist(CONS_C1_df_dup_FEB_2020_prev2_nat)))))) %>% 
#    dplyr::select(hash_key,id,id_mod, ano_bd, Sexo, Edad_al_ing) %>%
#    dplyr::group_by(hash_key) %>% #primero genero la variable
#    dplyr::slice(which.max(ano_bd))%>%
#    assign("CONS_C1_df_dup_FEB_2020_prev2_max_age",., envir = .GlobalEnv) 
    #dplyr::filter(hash_key=="00012586ea3036b7a18093c396847a87")
```

- Age of Onset of Drug Use Principal Substance (edad_ini_sus_prin) (`r CONS_C1_df_dup_FEB_2020_prev2 %>% group_by(hash_key) %>% dplyr::mutate(edad_ini_sus_prin_por_hash=n_distinct(edad_ini_sus_prin)) %>% ungroup() %>% dplyr::filter(edad_ini_sus_prin_por_hash>1) %>% nrow() %>%  formatC(, format="f", big.mark=",", digits=0)`)
<!--- #considerar que no sea mayor a la edad de inicio de consumo --->

```{r pers_info_edad_ini_sus_prin,eval=F, echo=T, paged.print=TRUE}
CONS_C1_df_dup_FEB_2020_prev2_edad_ini_sus_prin <- CONS_C1_df_dup_FEB_2020_prev2 %>% group_by(hash_key) %>% dplyr::mutate(edad_ini_sus_prin_por_hash=n_distinct(edad_ini_sus_prin)) %>% ungroup() %>% dplyr::filter(edad_ini_sus_prin_por_hash>1) %>% dplyr::distinct(hash_key)
CONS_C1_df_dup_FEB_2020_prev2 %>% 
 dplyr::filter(hash_key %in% as.character(as.vector(unlist(as.data.table(unlist(CONS_C1_df_dup_FEB_2020_prev2_edad_ini_sus_prin)))))) %>% # Select HASHs of cited cases
 dplyr::arrange(hash_key) %>% #ordeno por ids 
dplyr::select(row, hash_key, ano_bd, edad_ini_cons,edad_ini_cons, sexo, fech_nac,Edad_al_ing, fech_ing, fech_egres, tipo_de_plan, SENDA)%>%
    knitr::kable(.,format = "html", format.args = list(decimal.mark = ".", big.mark = ","),
               caption="Table 14. HASHs with more than one Age of Onset of Drug Use Principal Substance",
                 align =rep('c', 101))  %>%
   kableExtra::kable_styling(bootstrap_options = c("striped", "hover"),font_size = 8) %>%
  kableExtra::scroll_box(width = "100%", height = "375px")
#_______________________
###PARA HACER LA CONVERSION
#_______________________
#CONS_C1_df_dup_FEB_2020_prev2 %>%
#    #dplyr::filter(hash_key %in% as.character(as.vector(unlist(as.data.table(unlist(CONS_C1_df_dup_FEB_2020_prev2_nat)))))) %>% 
#    dplyr::mutate(concat_hash_id=paste0(hash_key,"_",id)) %>%
#    dplyr::group_by(concat_hash_id) %>%
#    dplyr::add_tally() %>% 
#    dplyr::ungroup() %>%  
#    dplyr::select(hash_key,id, id_mod, ano_bd, Edad, fech_nac,ano_nac,n) %>%
#    dplyr::group_by(hash_key) %>% #primero genero la variable
#    dplyr::slice(which.max(n))%>% 
#    #dplyr::filter(hash_key=="00a8e1377935f1639a28faa9c11ee03a")
#    assign("CONS_C1_df_dup_FEB_2020_prev2_most_frequent_age_dataset",., envir = .GlobalEnv)
#CONS_C1_df_dup_FEB_2020_prev2_prev4 %>%
    #dplyr::filter(hash_key %in% as.character(as.vector(unlist(as.data.table(unlist(CONS_C1_df_dup_FEB_2020_prev2_nat)))))) %>% 
#    dplyr::select(hash_key,id,id_mod, ano_bd, Sexo, Edad_al_ing) %>%
#    dplyr::group_by(hash_key) %>% #primero genero la variable
#    dplyr::slice(which.max(ano_bd))%>%
#    assign("CONS_C1_df_dup_FEB_2020_prev2_max_age",., envir = .GlobalEnv) 
    #dplyr::filter(hash_key=="00012586ea3036b7a18093c396847a87")
```

- Starting Substance (sus_ini) (`r CONS_C1_df_dup_FEB_2020_prev2 %>% group_by(hash_key) %>% dplyr::mutate(sus_ini_por_hash=n_distinct(sus_ini)) %>% ungroup() %>% dplyr::filter(sus_ini_por_hash>1) %>% nrow() %>%  formatC(, format="f", big.mark=",", digits=0)`)
<!---# considerar que no sea mayor a la edad de inicio de consumo --->

```{r pers_info_sus_ini, eval=F, echo=T, paged.print=TRUE}
CONS_C1_df_dup_FEB_2020_prev2_sus_ini <- CONS_C1_df_dup_FEB_2020_prev2 %>% group_by(hash_key) %>% dplyr::mutate(sus_ini_por_hash=n_distinct(sus_ini)) %>% ungroup() %>% dplyr::filter(sus_ini_por_hash>1) %>% dplyr::distinct(hash_key)
CONS_C1_df_dup_FEB_2020_prev2 %>% 
 dplyr::filter(hash_key %in% as.character(as.vector(unlist(as.data.table(unlist(CONS_C1_df_dup_FEB_2020_prev2_sus_ini)))))) %>% # Select HASHs of cited cases
 dplyr::arrange(hash_key) %>% #ordeno por ids 
dplyr::select(row, hash_key, ano_bd, sus_ini, edad_ini_cons,edad_ini_cons, sexo, fech_nac,Edad_al_ing, fech_ing, fech_egres, tipo_de_plan, SENDA)%>%
    knitr::kable(.,format = "html", format.args = list(decimal.mark = ".", big.mark = ","),
               caption="Table 15. HASHs with more than one Starting Substance",
                 align =rep('c', 101))  %>%
   kableExtra::kable_styling(bootstrap_options = c("striped", "hover"),font_size = 8) %>%
  kableExtra::scroll_box(width = "100%", height = "375px")
#_______________________
###PARA HACER LA CONVERSION
#_______________________
#CONS_C1_df_dup_FEB_2020_prev2 %>%
#    #dplyr::filter(hash_key %in% as.character(as.vector(unlist(as.data.table(unlist(CONS_C1_df_dup_FEB_2020_prev2_nat)))))) %>% 
#    dplyr::mutate(concat_hash_id=paste0(hash_key,"_",id)) %>%
#    dplyr::group_by(concat_hash_id) %>%
#    dplyr::add_tally() %>% 
#    dplyr::ungroup() %>%  
#    dplyr::select(hash_key,id, id_mod, ano_bd, Edad, fech_nac,ano_nac,n) %>%
#    dplyr::group_by(hash_key) %>% #primero genero la variable
#    dplyr::slice(which.max(n))%>% 
#    #dplyr::filter(hash_key=="00a8e1377935f1639a28faa9c11ee03a")
#    assign("CONS_C1_df_dup_FEB_2020_prev2_most_frequent_age_dataset",., envir = .GlobalEnv)
#CONS_C1_df_dup_FEB_2020_prev2_prev4 %>%
    #dplyr::filter(hash_key %in% as.character(as.vector(unlist(as.data.table(unlist(CONS_C1_df_dup_FEB_2020_prev2_nat)))))) %>% 
#    dplyr::select(hash_key,id,id_mod, ano_bd, Sexo, Edad_al_ing) %>%
#    dplyr::group_by(hash_key) %>% #primero genero la variable
#    dplyr::slice(which.max(ano_bd))%>%
#    assign("CONS_C1_df_dup_FEB_2020_prev2_max_age",., envir = .GlobalEnv) 
    #dplyr::filter(hash_key=="00012586ea3036b7a18093c396847a87")
```

&nbsp;
<br>


