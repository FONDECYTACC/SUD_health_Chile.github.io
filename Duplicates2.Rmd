---
title: "Duplicated/ Repeated Cases in SISTRAT C1 (part 2)"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  html_document:
    code_folding: hide  
    toc: true # table of content true
    toc_depth: 5  # upto three depths of headings (specified by #, ## and ###)
    toc_float: true
---

<style type="text/css">
.tablelines table, .tablelines td, .tablelines th {
        border: 1px solid black;
        }
.centrado {
    text-align: center;
}
.table.center {
    margin-left:auto; 
    margin-right:auto;
  }
.table_wrapper{
    display: block;
    overflow-x: auto;
    white-space: nowrap;
}
code.r{
  font-size: 8px;
}
body{ /* Normal  */
      text-align: justify;
  }
.superbigimage{
    overflow-y:scroll;
    white-space: nowrap;
}
.superbigimage img{
    overflow-y: scroll;
    overflow-x: hidden;
}
</style>

```{r setup, include = FALSE, cache=T}
#Libraries used in the routine. Dont change the order
rm(list=ls());gc()
#rm(list=c("")
unlink('SUD_CL/Duplicates2_cache', recursive = TRUE)
load("G:/Mi unidad/Alvacast/SISTRAT 2019 (github)/4.Rdata")
local({r <- getOption("repos")
       r["CRAN"] <- "http://cran.r-project.org" 
       options(repos=r)
})
#packageVersion("codebook")
#https://github.com/RevolutionAnalytics/checkpoint
#if(!require(checkpoint)){install.packages("checkpoint")}
#if(!require(here)){install.packages("here")}
#checkpoint::checkpoint("2020-02-19",project=here::here(),checkpointLocation=paste0(here::here(),"/dedup"), use.lock=F, use.knitr=T, auto.install.knitr = T,scan.rnw.with.knitr=T, forceInstall=T,scanForPackages = TRUE)
#checkpointArchives(tempdir(), full.names = TRUE)

#if(!require(tidyr)){install.packages("tidyr")}
#if(!require(DataExplorer)){install.packages("DataExplorer")}
#if(!require(stringi)){install.packages("stringi")}
#if(!require(stringr)){install.packages("stringr")}
#if(!require(ggplot2)){install.packages("ggplot2")}
#if(!require(Hmisc)){install.packages("Hmisc")}
#if(!require(kableExtra)){install.packages("kableExtra")}
#if(!require(plotly)){install.packages("plotly")}
#if(!require(rbokeh)){install.packages("rbokeh")}
#if(!require(altair)){install.packages("altair")}
#if(!require(zoo)){install.packages("zoo")}
#if(!require(codebook)){install.packages("codebook")}
#if(!require(broom)){install.packages("broom")}
#if(!require(sqldf)){install.packages("sqldf")} 
#if(!require(devtools)){install.packages("devtools")}
#if(!require(Statamarkdown)){install_github("hemken/Statamarkdown")}
#if(!require(data.table)){install.packages("data.table")}
#if(!require(dplyr)){install.packages("dplyr")}
library(knitr)
library(tidyr)
library(stringi)
library(stringr)
library(ggplot2)
library(Hmisc)
library(kableExtra)
library(plotly)
library(rbokeh)
library(altair)
library(zoo)
library(broom)
library(sqldf)
library(devtools)
library(Statamarkdown)
library(codebook)
library(data.table)
library(dplyr)
```

<!--- SÍ O SÍ, HACER LA LIMPIEZA DE LOS SENDA NO, PRINCIPALMENTE DE LOS QUE SE SUPERPONGAN, TAMBIÉN PREGUNTAR A ACC SI LOS CON 0 DÍAS DE TRATAMIENTO SE BORRARÁN O NO; DE AHI EMPEZAR A NORMALIZAR LOS PROGRAMAS Y PLANES DE ACUERDO CON CRITERIOS MAUREEN, PARA NO GENERAR DIFERENCIAS AHI Y PODER DEDUPLICAR TRANQUILO --->

<!--- tipo_centro, convertir en factor 1. Privado, 2. Público; DataExplorer::create_report(CONS_1_4)  --->

## 0. Raw Deduplication

&nbsp;
<br>
For the purpose of this page, we use the terms "rows" and "cases" as equal to refer to the entries of the dataset. In many of the processes made along the deduplication of entries in C1 dataset, we used unstandardized columns or many other data that was in fact duplicated by HASHs, that did not depend on events related to treatment. In order to find and delete duplicated data that does not add information relevant for the purposes of the study, we now may **use these standardized variables as a criteria to achieve the goal of having a unique event per HASH, by reducing its complexity based on irrelevant differences**.
<br>

### 0.a. Deduplication based on standardized columns of interest for the study

First, we selected the following standardized variables as a criteria to identify duplicated treatments per user:

- Masked Identifier (HASH_KEY)
- Date of Admission to Treatment (fech_ing)
- Center ID (ID.centro)
- Main Substance of Consumption (sus_principal)
- Other Substances (1) (otras_sus1)
- Other Substances (2) (otras_sus2)
- Other Substances (3) (otras_sus3)
- Starting Substance (sus_ini)
- Age of Onset of Drug Use (edad_ini_cons)
- Marital Status (estado_conyugal)
- Occupational Status (estatus_ocupacional)
- Occupational Category (cat_ocupacional)
- Age in groups (Edad_grupos)
- Motive of Admission to Treatment (origen_ingreso)
- Education Attainment (escolaridad)
- Route of Administration of the Main Substance (via_adm_sus_prin)
- Frequency of Consumption of the Main Substance (freq_cons_sus_prin)

```{r dedup_manual, echo=T, paged.print=TRUE}
require(data.table)
names_c1_stage3 <- c("HASH_KEY","fech_ing", "ID.centro", "sus_principal", "otras_sus1","otras_sus2","otras_sus3","sus_ini","edad_ini_cons", "estado_conyugal","estatus_ocupacional","cat_ocupacional","Edad_grupos","origen_ingreso", "escolaridad","via_adm_sus_prin", "freq_cons_sus_prin")

require(dplyr)
CONS_C1_df_dup_ENE_2020 %>%
  dplyr::arrange(desc(ano_bd),HASH_KEY, desc(fech_ing), desc(fech_egres),dias_trat_inv) %>%
  dplyr::distinct_(.dots = names_c1_stage3, .keep_all = TRUE) %>%
#  dplyr::arrange(HASH_KEY, fech_ing, desc(ano_bd)) %>%
 # dplyr::select(row) %>%  summarise(mean(row), sd(row)) #, lo mismo que en STATA. Se supone que una row es sensible a cambios distintos.
  assign("CONS_C1_df_dup_FEB_2020_prev1",.,envir = .GlobalEnv)
#Lo mismo que en STATA: Ahora hay 118,072. Una vez que introduje 
#Ahora, 118035
#  dplyr::arrange(HASH_KEY, fech_ing, desc(ano_bd), desc(fech_egres)) %>% criterio anterior
```

<br>

Once exact matches were discarded, we ended having `r nrow(CONS_C1_df_dup_FEB_2020_prev1) %>% formatC(, format="f", big.mark=",", digits=0)` cases.

<br>

An analysis based on the following criteria, ended with an index of how many differences within cases with the same HASH and date of admission, and in which variables can be tolerable to have differences. For example, if two or more cases share the same date of admission and hash, but most of the variables are different, it is possible to think that information may be lost if one of them is deleted. In another example, if two or more cases share the same date of admission and hash, but the only differences are observed in the days of treatment, one may think that only the case with more treatment days must be preserved.

- HASH_KEY=	Masked Identifier (RUT)
- Región.del.Centro=	Chilean Region of the Center
- dias_trat=	Days of Treatment
- Edad=	Year (Discrete Number)
- fech_ing=	Date of Admission to Treatment
- fech_egres=	Date of Discharge from Treatment
- ID.centro	Center ID
- id_mod=	SENDAs ID (mask characters 5 & 6)
- ano_nac=	Year of Birth (numeric)
- Edad_al_ing=	Age at Admission to Treatment
- edad_ini_cons=	Age of Onset of Drug Use
- edad_ini_sus_prin= Age of Onset of Drug Use Principal Substance
- tipo_centro= Type of Center
- Nacionalidad= Nationallity
- Etnia= Ethnicity
- Diagnóstico.Trs..Psiquiátrico.DSM.IV= Diagnosis of Psychiatric Disorders, DSM-IV criteria
- Diagnóstico.Trs..Psiquiátrico.SUB.DSM.IV= Diagnosis of Psychiatric Disorders, DSM-IV criteria (sub-classification)
- X2.Diagnóstico.Trs..Psiquiátrico.DSM.IV= Diagnosis of Psychiatric Disorders, DSM-IV criteria (2)
- X2.Diagnóstico.Trs..Psiquiátrico.SUB.DSM.IV= Diagnosis of Psychiatric Disorders, DSM-IV criteria (sub-classification) (2)
- X3.Diagnóstico.Trs..Psiquiátrico.DSM.IV= Diagnosis of Psychiatric Disorders, DSM-IV criteria (3)
- X3.Diagnóstico.Trs..Psiquiátrico.SUB.DSM.IV= Diagnosis of Psychiatric Disorders, DSM-IV criteria (sub-classification) (3)
- Diagnóstico.Trs..Psiquiátrico.CIE.10= Diagnosis of Psychiatric Disorders, CIE-10 criteria
- Diagnóstico.Trs..Psiquiátrico.SUB.CIE.10= Diagnosis of Psychiatric Disorders, CIE-10 criteria (subclassification)
- X2.Diagnóstico.Trs..Psiquiátrico.CIE.10= Diagnosis of Psychiatric Disorders, CIE-10 criteria (2)
- X2.Diagnóstico.Trs..Psiquiátrico.SUB.CIE.10= Diagnosis of Psychiatric Disorders, CIE-10 criteria (subclassification) (2)
- X3.Diagnóstico.Trs..Psiquiátrico.CIE.10= Diagnosis of Psychiatric Disorders, CIE-10 criteria (3)
- X3.Diagnóstico.Trs..Psiquiátrico.SUB.CIE.10= Diagnosis of Psychiatric Disorders, CIE-10 criteria (subclassification) (3)
- motivodeegreso= Cause of Discharge
- identidad.de.genero= Gender Identity
- sexo= Sex of User
- embarazo= Pregnant
- tipo_de_plan= Type of Plan
- tipo_de_programa= Type of Program
- dias_trat_alta_temprana= Less than 90 days in treatment
- motivodeegreso_mod= Cause of Discharge (with late and early withdrawal)
- sus_principal= Main Substance of Consumption
- otras_sus1= Other Substances (1)
- otras_sus2= Other Substances (2)
- otras_sus3= Other Substances (3)
- sus_ini= Starting Substance
- estado_conyugal= Marital Status
- estatus_ocupacional= Occupational Status
- cat_ocupacional= Occupational Category
- Edad_grupos= Age in groups
- origen_ingreso= Motive of Admission to Treatment
- escolaridad= Educational Attainment
- via_adm_sus_prin= Route of Administration of the Main Substance
- freq_cons_sus_prin= Frequency of Consumption of the Main Substance

```{r dedup_analisis_manual, echo=T, paged.print=TRUE}
criterios_show<-c('HASH_KEY', 'tipo_centro', 'Región.del.Centro', 'dias_trat', 
  'Edad', 'Nacionalidad', 'Etnia', 'Diagnóstico.Trs..Psiquiátrico.DSM.IV', 'Diagnóstico.Trs..Psiquiátrico.SUB.DSM.IV', 
  'X2.Diagnóstico.Trs..Psiquiátrico.DSM.IV', 'X2.Diagnóstico.Trs..Psiquiátrico.SUB.DSM.IV', 
  'X3.Diagnóstico.Trs..Psiquiátrico.DSM.IV', 'X3.Diagnóstico.Trs..Psiquiátrico.SUB.DSM.IV', 
  'Diagnóstico.Trs..Psiquiátrico.CIE.10', 'Diagnóstico.Trs..Psiquiátrico.SUB.CIE.10', 
  'X2.Diagnóstico.Trs..Psiquiátrico.CIE.10', 'X2.Diagnóstico.Trs..Psiquiátrico.SUB.CIE.10', 
  'X3.Diagnóstico.Trs..Psiquiátrico.CIE.10', 'X3.Diagnóstico.Trs..Psiquiátrico.SUB.CIE.10', 'fech_ing', 'fech_egres', 
  'motivodeegreso', 'ID.centro', 'identidad.de.genero', 'sexo', 'embarazo', 'tipo_de_plan', 'tipo_de_programa', 
  'id_mod', 'ano_nac', 'Edad_al_ing', 'edad_ini_cons', 'edad_ini_sus_prin', 'dias_trat_alta_temprana', 
  'motivodeegreso_mod', 'sus_principal', 'otras_sus1', 'otras_sus2', 'otras_sus3', 'sus_ini', 'estado_conyugal', 
  'estatus_ocupacional', 'cat_ocupacional', 'Edad_grupos', 'origen_ingreso', 'escolaridad', 
  'via_adm_sus_prin', 'freq_cons_sus_prin')

CONS_C1_df_dup_FEB_2020_prev1 %>%
  dplyr::group_by(HASH_KEY, fech_ing) %>% #primero genero la variable
  dplyr::mutate(HASH_fech_ing_reps = n(), HASH_fech_ing_apariciones=row_number()) %>%  #number of different variables by HASH.
  dplyr::ungroup() %>% #desagrupo
  dplyr::filter(HASH_fech_ing_reps>1) %>% #names() %>% copiar_nombres() #para rescatar nombres de la base de datos
  dplyr::group_by(HASH_KEY, fech_ing) %>% #primero genero la variable
  dplyr::mutate_at(vars(c('HASH_KEY', 'id', 'tipo_centro', 'Región.del.Centro', 'dias_trat', 
                   'Edad', 'Nacionalidad', 'Etnia', 'Diagnóstico.Trs..Psiquiátrico.DSM.IV', 'Diagnóstico.Trs..Psiquiátrico.SUB.DSM.IV', 
                   'X2.Diagnóstico.Trs..Psiquiátrico.DSM.IV', 'X2.Diagnóstico.Trs..Psiquiátrico.SUB.DSM.IV', 
                   'X3.Diagnóstico.Trs..Psiquiátrico.DSM.IV', 'X3.Diagnóstico.Trs..Psiquiátrico.SUB.DSM.IV', 
                   'Diagnóstico.Trs..Psiquiátrico.CIE.10', 'Diagnóstico.Trs..Psiquiátrico.SUB.CIE.10', 
                   'X2.Diagnóstico.Trs..Psiquiátrico.CIE.10', 'X2.Diagnóstico.Trs..Psiquiátrico.SUB.CIE.10', 
                   'X3.Diagnóstico.Trs..Psiquiátrico.CIE.10', 'X3.Diagnóstico.Trs..Psiquiátrico.SUB.CIE.10', 'fech_ing', 'fech_egres', 
                   'motivodeegreso', 'ID.centro', 'identidad.de.genero', 'sexo', 'embarazo', 'tipo_de_plan', 'tipo_de_programa', 
                   'id_mod', 'ano_nac', 'Edad_al_ing', 'edad_ini_cons', 'edad_ini_sus_prin', 'dias_trat_alta_temprana', 
                   'motivodeegreso_mod', 'sus_principal', 'otras_sus1', 'otras_sus2', 'otras_sus3', 'sus_ini', 'estado_conyugal', 
                   'estatus_ocupacional', 'cat_ocupacional', 'Edad_grupos', 'origen_ingreso', 'escolaridad', 
                   'via_adm_sus_prin', 'freq_cons_sus_prin')), .funs = list(dups_hash_ing = ~n_distinct(.))) %>%
  dplyr::ungroup() %>%
  dplyr::mutate_at(vars(contains('_dups_hash_ing')), .funs = list(~ifelse(.>1,1,0))) %>% #el ptaje no depende de cuantos duplicados tenga
  dplyr::mutate(n_of_diffs_within = rowSums(select(., contains("_dups_hash_ing")))) %>% 
#  janitor::tabyl(n_of_matches) #para ver cómo se distirbuye
#  dplyr::select(-contains("_dups_hash_ing")) %>% 
#  dplyr::select(,contains("_dups_hash_ing")) %>%
  dplyr::select("row", "ano_bd","HASH_fech_ing_reps","HASH_fech_ing_apariciones","n_of_diffs_within","id_mod", c(criterios_show, contains("_dups_hash_ing"), "SENDA")) %>%
  dplyr::arrange(n_of_diffs_within, HASH_KEY, desc(ano_bd)) %>% as.data.frame() %>%  knitr::kable(.,format = "html", format.args = list(decimal.mark = ".", big.mark = ","),
               caption="Table 1. Cases with the same date of admission and HASH, for visual analysis",
                 align =rep('c', 101))  %>%
   kableExtra::kable_styling(bootstrap_options = c("striped", "hover"),font_size = 8) %>%
  kableExtra::add_footnote( c("Note. HASH_fech_ing_reps= Times that HASH and Date of Admission is repeated;", "HASH_fech_ing_apariciones= Ordered number of registries with the same HASH and Date of Admission;", "n_of_diffs_within= Sum of the differences in each selected variable (0 if there is a difference, 1 if not) within cases that share the same HASH and Date of Admission, of a total of 49 selected variables"), notation = "none") %>%
  kableExtra::scroll_box(width = "100%", height = "375px")
```

&nbsp;

The process applied is shown in Figure 1.

<br>

```{r image-decision_tree_duplicated_entries, echo=FALSE, fig.align='center', fig.pos='H', fig.cap= "Figure 1. Decision Tree for the Discard of Duplicated Cases", message=FALSE}
knitr::include_graphics("G:/Mi unidad/Alvacast/SISTRAT 2019 (github)/SUD_CL/Figures/Duplicated_entries_decision_tree.svg")
```

```{r dedup_analisis_manual_export, echo=T, include=F, paged.print=TRUE}
#Tengo que llegar a este número
###117,619
criterios<-c('HASH_KEY', 'id', 'tipo_centro', 'Región.del.Centro', 'dias_trat', 
  'Edad', 'Nacionalidad', 'Etnia', 'Diagnóstico.Trs..Psiquiátrico.DSM.IV', 'Diagnóstico.Trs..Psiquiátrico.SUB.DSM.IV', 
  'X2.Diagnóstico.Trs..Psiquiátrico.DSM.IV', 'X2.Diagnóstico.Trs..Psiquiátrico.SUB.DSM.IV', 
  'X3.Diagnóstico.Trs..Psiquiátrico.DSM.IV', 'X3.Diagnóstico.Trs..Psiquiátrico.SUB.DSM.IV', 
  'Diagnóstico.Trs..Psiquiátrico.CIE.10', 'Diagnóstico.Trs..Psiquiátrico.SUB.CIE.10', 
  'X2.Diagnóstico.Trs..Psiquiátrico.CIE.10', 'X2.Diagnóstico.Trs..Psiquiátrico.SUB.CIE.10', 
  'X3.Diagnóstico.Trs..Psiquiátrico.CIE.10', 'X3.Diagnóstico.Trs..Psiquiátrico.SUB.CIE.10', 'fech_ing', 'fech_egres', 
  'motivodeegreso', 'ID.centro', 'identidad.de.genero', 'sexo', 'embarazo', 'tipo_de_plan', 'tipo_de_programa', 
  'id_mod', 'ano_nac', 'Edad_al_ing', 'edad_ini_cons', 'edad_ini_sus_prin', 'dias_trat_alta_temprana', 
  'motivodeegreso_mod', 'sus_principal', 'otras_sus1', 'otras_sus2', 'otras_sus3', 'sus_ini', 'estado_conyugal', 
  'estatus_ocupacional', 'cat_ocupacional', 'Edad_grupos', 'origen_ingreso', 'escolaridad', 
  'via_adm_sus_prin', 'freq_cons_sus_prin')

CONS_C1_df_dup_FEB_2020_prev1 %>%
  dplyr::group_by(HASH_KEY, fech_ing) %>% #primero genero la variable
  dplyr::mutate(HASH_fech_ing_reps = n(), HASH_fech_ing_apariciones=row_number()) %>%  #number of different variables by HASH.
  dplyr::ungroup() %>% #desagrupo
  dplyr::filter(HASH_fech_ing_reps>1) %>% #names() %>% copiar_nombres() #para rescatar nombres de la base de datos
  dplyr::group_by(HASH_KEY, fech_ing) %>% #primero genero la variable
  dplyr::mutate_at(vars(c('HASH_KEY', 'id', 'tipo_centro', 'Región.del.Centro', 'dias_trat', 
                   'Edad', 'Nacionalidad', 'Etnia', 'Diagnóstico.Trs..Psiquiátrico.DSM.IV', 'Diagnóstico.Trs..Psiquiátrico.SUB.DSM.IV', 
                   'X2.Diagnóstico.Trs..Psiquiátrico.DSM.IV', 'X2.Diagnóstico.Trs..Psiquiátrico.SUB.DSM.IV', 
                   'X3.Diagnóstico.Trs..Psiquiátrico.DSM.IV', 'X3.Diagnóstico.Trs..Psiquiátrico.SUB.DSM.IV', 
                   'Diagnóstico.Trs..Psiquiátrico.CIE.10', 'Diagnóstico.Trs..Psiquiátrico.SUB.CIE.10', 
                   'X2.Diagnóstico.Trs..Psiquiátrico.CIE.10', 'X2.Diagnóstico.Trs..Psiquiátrico.SUB.CIE.10', 
                   'X3.Diagnóstico.Trs..Psiquiátrico.CIE.10', 'X3.Diagnóstico.Trs..Psiquiátrico.SUB.CIE.10', 'fech_ing', 'fech_egres', 
                   'motivodeegreso', 'ID.centro', 'identidad.de.genero', 'sexo', 'embarazo', 'tipo_de_plan', 'tipo_de_programa', 
                   'id_mod', 'ano_nac', 'Edad_al_ing', 'edad_ini_cons', 'edad_ini_sus_prin', 'dias_trat_alta_temprana', 
                   'motivodeegreso_mod', 'sus_principal', 'otras_sus1', 'otras_sus2', 'otras_sus3', 'sus_ini', 'estado_conyugal', 
                   'estatus_ocupacional', 'cat_ocupacional', 'Edad_grupos', 'origen_ingreso', 'escolaridad', 
                   'via_adm_sus_prin', 'freq_cons_sus_prin')), .funs = list(dups_hash_ing = ~n_distinct(.))) %>%
  dplyr::ungroup() %>%
  dplyr::mutate_at(vars(contains('_dups_hash_ing')), .funs = list(~ifelse(.>1,1,0))) %>% #el ptaje no depende de cuantos duplicados tenga
  dplyr::mutate(n_of_diffs_within = rowSums(select(., contains("_dups_hash_ing")))) %>% 
#  janitor::tabyl(n_of_matches) #para ver cómo se distirbuye
#  dplyr::select(-contains("_dups_hash_ing")) %>% 
#  dplyr::select(,contains("_dups_hash_ing")) %>%
  dplyr::select("row", "ano_bd","HASH_fech_ing_reps","HASH_fech_ing_apariciones","n_of_diffs_within", c(criterios, contains("_dups_hash_ing"), "SENDA")) %>%
  dplyr::arrange(n_of_diffs_within, HASH_KEY, desc(ano_bd)) %>% as.data.frame() %>% guardar_tablas("_matches_feb_2020")

#write.csv(.,"_matches_feb_2020.csv", row.names = FALSE)
#anyDuplicated returns the index i of the first duplicated entry if there is one, and 0 otherwise.
 #anyDuplicated(CONS_C1_df_dup_FEB_2020_prev1_dt, by=c("HASH_KEY", "fech_ing"))
```

<br>

We seen that many cases had different sexes, others are registries mostly from 2010 to 2015. Additionally, some diagnostics did not appear previously in the last registry. Other programs specific for women are changed in the next case for the general population.

<br>


CONS_C1_df_dup_FEB_2020_prev1
```{r filter_cases_duplicated, echo=T, include=T, paged.print=TRUE}
dup_rows_by_obs_an <-c('44441', '59632', '4118', '83870', '33668', '38147', '13748', '24327', '7161', '6547', '37013', '96781', '57407', '15363', '63133', '196', '93528', '30670', '58550', '72253', '54650', '25716', '70547', '8320', '22332', '25251', '79519', '59842', '30734', '1105', '53959', '37294', '24936', '49352', '61282', '28687', '13729', '59555', '21165', '28500', '61274', '74897', '22331', '36731', '80950', '54760', '48977', '15410', '14641', '71758', '15744', '15526', '9099', '29791', '22330', '61287', '60502', '59556', '4739', '46724', '30276', '21166', '41795', '60507', '54776', '21574', '18237', '22228', '23061', '74444', '72556', '39592', '450', '54383', '35913', '30644', '23062', '3874', '3957', '72933', '8590', '13236', '30717', '54745', '31417', '23949', '24776', '9433', '45379', '53402', '71735', '37885', '21664', '14645', '25817', '9092', '31514', '2682', '37166', '57409', '38288', '18774', '6331', '67013', '34282', '77761', '2038', '84270', '22347', '41793', '30178', '22307', '57171', '27222', '25562', '39361', '3702', '28830', '14291', '137746', '20396', '4530', '53672', '42633', '29792', '15480', '55412', '57056', '89084', '59799', '57052', '6943', '61275', '14280', '17704', '45685', '9006', '35723', '23583', '83762', '4490', '57391', '7328', '15237', '14664', '77874', '12979', '36160', '62447', '121921', '3854', '66842', '15235', '46461', '74484', '15412', '5497', '25123', '47029', '45781', '6332', '13945', '52207', '45018', '44514', '2665', '52774', '8159', '37243', '13482', '31500', '26528', '549', '39944', '15386', '70295', '45306', '30352', '15688', '4735', '3191', '61079', '42627', '40610', '12495', '62097', '46463', '22612', '44794', '25013', '2284', '32219', '61281', '64011', '9318', '135017', '16319', '23355', '20118', '18281', '41599', '63035', '5493', '23280', '7698', '21397', '8352', '31750', '58055', '25429', '22249', '18952', '4984', '40210', '27202', '31341', '35645', '57410', '68566', '77886', '15416', '13309', '20154', '37926', '7250', '34556', '76210', '30713', '322', '20041', '18232', '14457', '1866', '59271', '25117', '31743', '26552', '58187', '28481', '18099', '16185', '1798', '23372', '57885', '46333', '6508', '16275', '27262', '17379', '10900', '14656', '7581', '11641', '39151', '78898', '24269', '5072', '21080', '63034', '20479', '15278', '70927', '7604', '6799', '34933', '14814', '340', '26721', '31621', '23299', '462', '12510', '7160', '46351', '5074', '12839', '4713', '6864', '4976', '37220', '23362', '11969', '37722', '35729', '441', '16189', '5536', '24449', '77163', '46455', '8767', '36167', '30552', '14616', '13956', '30568', '31424', '29523', '20704', '132268', '6346', '14051', '12484', '25164', '13276', '1618', '18713', '10495', '18468', '13128', '12838', '7182', '2523', '9719', '18651', '23586', '74757', '6334', '5571', '26424', '6794', '4801', '35841', '35831', '29608', '41005', '18712', '18649', '18934', '18170', '27956', '37271', '29885', '6202', '32299', '16172', '3865', '2319', '11163', '27214', '11552', '29380', '28514', '11365', '1794', '429', '61631', '12540', '21363', '23326', '38864', '11300', '14040', '9473', '36039', '27721', '63525', '43722', '19448', '18950', '8403', '22188', '3862', '2629', '15904', '15256', '8765', '23581', '16082', '74024', '14096', '75750', '1789', '27712', '25180', '21231', '17566', '72221', '31361', '16212', '8334', '17664', '11117', '31628', '31558', '23842', '16836', '27226', '16326', '57544', '30563', '54953', '22028', '11465', '7623', '27964', '23588', '31266', '16173', '11837', '6867', '4641', '15768', '23437', '16807', '11807', '3974', '14057', '12517', '8752', '8013', '23300', '12516', '8153', '5031', '582')
###igual creo que si uno quisiese automatizar el proceso, sólo necesitaría sacar el primero de cada fila con slice row number grouped by hash fech ing y no se complica más.
CONS_C1_df_dup_FEB_2020_prev1 %>%
  dplyr::filter(!row %in% dup_rows_by_obs_an) %>%
  assign("CONS_C1_df_dup_FEB_2020_prev2",.,envir = .GlobalEnv)
#117,619
```

### 0.b. Different Information Within User, Concerning Personal Information

We may see that many users have more than one disctinct personal information. In fact, these inconsistencies within users (incluiding those related to the date of birth) may impact in their SENDA's ID, making it difficult to detect changes along users in the datasets. Fortunately, we have the encripted code of the national identity number, which can replace SENDAs ID.

- Sex (sexo) (`r CONS_C1_df_dup_FEB_2020_prev2 %>% dplyr::group_by(HASH_KEY) %>% dplyr::mutate(sexo_por_hash=dplyr::n_distinct(sexo)) %>% ungroup() %>% dplyr::filter(sexo_por_hash>1) %>% nrow() %>%  formatC(, format="f", big.mark=",", digits=0)`)
<!--- considerar la identidad de género. Esto puede haber afectado la imputación de casos para tipo_ed_plan y tipo_de_programa  --->

```{r pers_info_sex, echo=T, paged.print=TRUE}
CONS_C1_df_dup_FEB_2020_prev2_sex <- CONS_C1_df_dup_FEB_2020_prev2 %>% group_by(HASH_KEY) %>% dplyr::mutate(sexo_por_hash=n_distinct(sexo)) %>% ungroup() %>% dplyr::filter(sexo_por_hash>1) %>% dplyr::distinct(HASH_KEY)
CONS_C1_df_dup_FEB_2020_prev2 %>% 
 dplyr::filter(HASH_KEY %in% as.character(as.vector(unlist(as.data.table(unlist(CONS_C1_df_dup_FEB_2020_prev2_sex)))))) %>% # Select HASHs of cited cases
 dplyr::arrange(HASH_KEY) %>% #ordeno por ids 
  dplyr::select(row, HASH_KEY, ano_bd, sexo, identidad.de.genero,Edad_al_ing, fech_ing, fech_egres, tipo_de_plan, SENDA)%>%
    knitr::kable(.,format = "html", format.args = list(decimal.mark = ".", big.mark = ","),
               caption="Table 2. HASHs with more than one Sex",
                 align =rep('c', 101))  %>%
   kableExtra::kable_styling(bootstrap_options = c("striped", "hover"),font_size = 8) %>%
  kableExtra::scroll_box(width = "100%", height = "375px")
#_______________________
###PARA HACER LA CONVERSION
#_______________________
#CONS_C1_df_dup_FEB_2020_prev2 %>%
#    #dplyr::filter(HASH_KEY %in% as.character(as.vector(unlist(as.data.table(unlist(CONS_C1_df_dup_FEB_2020_prev2_sex)))))) %>% 
#    dplyr::mutate(concat_hash_sex=paste0(HASH_KEY,"_",sexo)) %>%
#    dplyr::group_by(concat_hash_sex) %>%
#    dplyr::add_tally() %>% 
#    dplyr::ungroup() %>%  
#    dplyr::select(HASH_KEY,id, id_mod, ano_bd, Edad, fech_nac,ano_nac,n) %>%
#    dplyr::group_by(HASH_KEY) %>% #primero genero la variable
#    dplyr::slice(which.max(n))%>% 
#    #dplyr::filter(HASH_KEY=="00a8e1377935f1639a28faa9c11ee03a")
#    assign("CONS_C1_df_dup_FEB_2020_prev2_most_frequent_age_dataset",., envir = .GlobalEnv)
#CONS_C1_df_dup_FEB_2020_prev2_prev4 %>%
    #dplyr::filter(HASH_KEY %in% as.character(as.vector(unlist(as.data.table(unlist(CONS_C1_df_dup_FEB_2020_prev2_sex)))))) %>% 
#    dplyr::select(HASH_KEY,id,id_mod, ano_bd, Sexo, Edad_al_ing) %>%
#    dplyr::group_by(HASH_KEY) %>% #primero genero la variable
#    dplyr::slice(which.max(ano_bd))%>%
#    assign("CONS_C1_df_dup_FEB_2020_prev2_max_age",., envir = .GlobalEnv) 
    #dplyr::filter(HASH_KEY=="00012586ea3036b7a18093c396847a87")
```

- Masked SENDAs ID (id_mod) (`r CONS_C1_df_dup_FEB_2020_prev2 %>% group_by(HASH_KEY) %>% dplyr::mutate(id_mod_por_hash=n_distinct(id_mod)) %>% ungroup() %>% dplyr::filter(id_mod_por_hash>1) %>% nrow() %>%  formatC(, format="f", big.mark=",", digits=0)`)
- SENDAs ID (id) (`r CONS_C1_df_dup_FEB_2020_prev2 %>% group_by(HASH_KEY) %>% dplyr::mutate(id_por_hash=n_distinct(id)) %>% ungroup() %>% dplyr::filter(id_por_hash>1) %>% nrow() %>%  formatC(, format="f", big.mark=",", digits=0)`)

<!--- considerar la fecha de nacimiento y el sexo--->

```{r pers_info_id, echo=T, paged.print=TRUE}
CONS_C1_df_dup_FEB_2020_prev2_ids <- CONS_C1_df_dup_FEB_2020_prev2 %>% group_by(HASH_KEY) %>% dplyr::mutate(id_por_hash=n_distinct(id)) %>% ungroup() %>% dplyr::filter(id_por_hash>1) %>% dplyr::distinct(HASH_KEY)
CONS_C1_df_dup_FEB_2020_prev2 %>% 
 dplyr::filter(HASH_KEY %in% as.character(as.vector(unlist(as.data.table(unlist(CONS_C1_df_dup_FEB_2020_prev2_ids)))))) %>% # Select HASHs of cited cases
 dplyr::arrange(HASH_KEY) %>% #ordeno por ids 
dplyr::select(row, HASH_KEY, ano_bd, id_mod, sexo, fech_nac,Edad_al_ing, fech_ing, fech_egres, tipo_de_plan, SENDA)%>%
    knitr::kable(.,format = "html", format.args = list(decimal.mark = ".", big.mark = ","),
               caption="Table 3. HASHs with more than one ID",
                 align =rep('c', 101))  %>%
   kableExtra::kable_styling(bootstrap_options = c("striped", "hover"),font_size = 8) %>%
  kableExtra::scroll_box(width = "100%", height = "375px")
#_______________________
###PARA HACER LA CONVERSION
#_______________________
#CONS_C1_df_dup_FEB_2020_prev2 %>%
#    #dplyr::filter(HASH_KEY %in% as.character(as.vector(unlist(as.data.table(unlist(CONS_C1_df_dup_FEB_2020_prev2_ids)))))) %>% 
#    dplyr::mutate(concat_hash_id=paste0(HASH_KEY,"_",id)) %>%
#    dplyr::group_by(concat_hash_id) %>%
#    dplyr::add_tally() %>% 
#    dplyr::ungroup() %>%  
#    dplyr::select(HASH_KEY,id, id_mod, ano_bd, Edad, fech_nac,ano_nac,n) %>%
#    dplyr::group_by(HASH_KEY) %>% #primero genero la variable
#    dplyr::slice(which.max(n))%>% 
#    #dplyr::filter(HASH_KEY=="00a8e1377935f1639a28faa9c11ee03a")
#    assign("CONS_C1_df_dup_FEB_2020_prev2_most_frequent_age_dataset",., envir = .GlobalEnv)
#CONS_C1_df_dup_FEB_2020_prev2_prev4 %>%
    #dplyr::filter(HASH_KEY %in% as.character(as.vector(unlist(as.data.table(unlist(CONS_C1_df_dup_FEB_2020_prev2_ids)))))) %>% 
#    dplyr::select(HASH_KEY,id,id_mod, ano_bd, Sexo, Edad_al_ing) %>%
#    dplyr::group_by(HASH_KEY) %>% #primero genero la variable
#    dplyr::slice(which.max(ano_bd))%>%
#    assign("CONS_C1_df_dup_FEB_2020_prev2_max_age",., envir = .GlobalEnv) 
    #dplyr::filter(HASH_KEY=="00012586ea3036b7a18093c396847a87")
```
<!--- La fecha de nacimiento puede no haberse corregido del todo porque hay muchos casos en que no tienen una edad distinta, por lo que el programa no  los filtra  --->
- Date of Birth (fech_nac) (`r CONS_C1_df_dup_FEB_2020_prev2 %>% group_by(HASH_KEY) %>% dplyr::mutate(fech_nac_por_hash=n_distinct(fech_nac)) %>% ungroup() %>% dplyr::filter(fech_nac_por_hash>1) %>% nrow() %>%  formatC(, format="f", big.mark=",", digits=0)`)

```{r pers_info_fech_nac, echo=T, paged.print=TRUE}
CONS_C1_df_dup_FEB_2020_prev2_fech_nac <- CONS_C1_df_dup_FEB_2020_prev2 %>% group_by(HASH_KEY) %>% dplyr::mutate(fech_nac_por_hash=n_distinct(fech_nac)) %>% ungroup() %>% dplyr::filter(fech_nac_por_hash>1) %>% dplyr::distinct(HASH_KEY)
CONS_C1_df_dup_FEB_2020_prev2 %>% 
 dplyr::filter(HASH_KEY %in% as.character(as.vector(unlist(as.data.table(unlist(CONS_C1_df_dup_FEB_2020_prev2_fech_nac)))))) %>% # Select HASHs of cited cases
 dplyr::arrange(HASH_KEY) %>% #ordeno por ids 
dplyr::select(row, HASH_KEY, ano_bd, id_mod, sexo, fech_nac,Edad_al_ing, fech_ing, fech_egres, tipo_de_plan, SENDA)%>%
    knitr::kable(.,format = "html", format.args = list(decimal.mark = ".", big.mark = ","),
               caption="Table 4. HASHs with more than one Date of Birth",
                 align =rep('c', 101))  %>%
   kableExtra::kable_styling(bootstrap_options = c("striped", "hover"),font_size = 8) %>%
  kableExtra::scroll_box(width = "100%", height = "375px")
#_______________________
###PARA HACER LA CONVERSION
#_______________________
#CONS_C1_df_dup_FEB_2020_prev2 %>%
#    #dplyr::filter(HASH_KEY %in% as.character(as.vector(unlist(as.data.table(unlist(CONS_C1_df_dup_FEB_2020_prev2_fech_nac)))))) %>% 
#    dplyr::mutate(concat_hash_id=paste0(HASH_KEY,"_",id)) %>%
#    dplyr::group_by(concat_hash_id) %>%
#    dplyr::add_tally() %>% 
#    dplyr::ungroup() %>%  
#    dplyr::select(HASH_KEY,id, id_mod, ano_bd, Edad, fech_nac,fech_nac,n) %>%
#    dplyr::group_by(HASH_KEY) %>% #primero genero la variable
#    dplyr::slice(which.max(n))%>% 
#    #dplyr::filter(HASH_KEY=="00a8e1377935f1639a28faa9c11ee03a")
#    assign("CONS_C1_df_dup_FEB_2020_prev2_most_frequent_age_dataset",., envir = .GlobalEnv)
#CONS_C1_df_dup_FEB_2020_prev2_prev4 %>%
    #dplyr::filter(HASH_KEY %in% as.character(as.vector(unlist(as.data.table(unlist(CONS_C1_df_dup_FEB_2020_prev2_fech_nac)))))) %>% 
#    dplyr::select(HASH_KEY,id,id_mod, ano_bd, Sexo, Edad_al_ing) %>%
#    dplyr::group_by(HASH_KEY) %>% #primero genero la variable
#    dplyr::slice(which.max(ano_bd))%>%
#    assign("CONS_C1_df_dup_FEB_2020_prev2_max_age",., envir = .GlobalEnv) 
    #dplyr::filter(HASH_KEY=="00012586ea3036b7a18093c396847a87")
```

- Year of Birth (ano_nac) (`r CONS_C1_df_dup_FEB_2020_prev2 %>% group_by(HASH_KEY) %>% dplyr::mutate(ano_nac_por_hash=n_distinct(ano_nac)) %>% ungroup() %>% dplyr::filter(ano_nac_por_hash>1) %>% nrow() %>%  formatC(, format="f", big.mark=",", digits=0)`)

```{r pers_info_ano_nac, echo=T, paged.print=TRUE}
CONS_C1_df_dup_FEB_2020_prev2_ano_nac <- CONS_C1_df_dup_FEB_2020_prev2 %>% group_by(HASH_KEY) %>% dplyr::mutate(ano_nac_por_hash=n_distinct(ano_nac)) %>% ungroup() %>% dplyr::filter(ano_nac_por_hash>1) %>% dplyr::distinct(HASH_KEY)
CONS_C1_df_dup_FEB_2020_prev2 %>% 
 dplyr::filter(HASH_KEY %in% as.character(as.vector(unlist(as.data.table(unlist(CONS_C1_df_dup_FEB_2020_prev2_ano_nac)))))) %>% # Select HASHs of cited cases
 dplyr::arrange(HASH_KEY) %>% #ordeno por ids 
dplyr::select(row, HASH_KEY, ano_bd, id_mod, sexo, fech_nac,Edad_al_ing, fech_ing, fech_egres, tipo_de_plan, SENDA)%>%
    knitr::kable(.,format = "html", format.args = list(decimal.mark = ".", big.mark = ","),
               caption="Table 5. HASHs with more than one Year of Birth",
                 align =rep('c', 101))  %>%
   kableExtra::kable_styling(bootstrap_options = c("striped", "hover"),font_size = 8) %>%
  kableExtra::scroll_box(width = "100%", height = "375px")
#_______________________
###PARA HACER LA CONVERSION
#_______________________
#CONS_C1_df_dup_FEB_2020_prev2 %>%
#    #dplyr::filter(HASH_KEY %in% as.character(as.vector(unlist(as.data.table(unlist(CONS_C1_df_dup_FEB_2020_prev2_ano_nac)))))) %>% 
#    dplyr::mutate(concat_hash_id=paste0(HASH_KEY,"_",id)) %>%
#    dplyr::group_by(concat_hash_id) %>%
#    dplyr::add_tally() %>% 
#    dplyr::ungroup() %>%  
#    dplyr::select(HASH_KEY,id, id_mod, ano_bd, Edad, fech_nac,ano_nac,n) %>%
#    dplyr::group_by(HASH_KEY) %>% #primero genero la variable
#    dplyr::slice(which.max(n))%>% 
#    #dplyr::filter(HASH_KEY=="00a8e1377935f1639a28faa9c11ee03a")
#    assign("CONS_C1_df_dup_FEB_2020_prev2_most_frequent_age_dataset",., envir = .GlobalEnv)
#CONS_C1_df_dup_FEB_2020_prev2_prev4 %>%
    #dplyr::filter(HASH_KEY %in% as.character(as.vector(unlist(as.data.table(unlist(CONS_C1_df_dup_FEB_2020_prev2_ano_nac)))))) %>% 
#    dplyr::select(HASH_KEY,id,id_mod, ano_bd, Sexo, Edad_al_ing) %>%
#    dplyr::group_by(HASH_KEY) %>% #primero genero la variable
#    dplyr::slice(which.max(ano_bd))%>%
#    assign("CONS_C1_df_dup_FEB_2020_prev2_max_age",., envir = .GlobalEnv) 
    #dplyr::filter(HASH_KEY=="00012586ea3036b7a18093c396847a87")
```

- Nationallity (Nacionalidad) (`r CONS_C1_df_dup_FEB_2020_prev2 %>% group_by(HASH_KEY) %>% dplyr::mutate(Nacionalidad_por_hash=n_distinct(Nacionalidad)) %>% ungroup() %>% dplyr::filter(Nacionalidad_por_hash>1) %>% nrow() %>%  formatC(, format="f", big.mark=",", digits=0)`)

```{r pers_info_nationallity, echo=T, paged.print=TRUE}
CONS_C1_df_dup_FEB_2020_prev2_nat <- CONS_C1_df_dup_FEB_2020_prev2 %>% group_by(HASH_KEY) %>% dplyr::mutate(nat_por_hash=n_distinct(Nacionalidad)) %>% ungroup() %>% dplyr::filter(nat_por_hash>1) %>% dplyr::distinct(HASH_KEY)
CONS_C1_df_dup_FEB_2020_prev2 %>% 
 dplyr::filter(HASH_KEY %in% as.character(as.vector(unlist(as.data.table(unlist(CONS_C1_df_dup_FEB_2020_prev2_nat)))))) %>% # Select HASHs of cited cases
 dplyr::arrange(HASH_KEY) %>% #ordeno por ids 
dplyr::select(row, HASH_KEY, ano_bd, Nacionalidad, Etnia, sexo, fech_nac,Edad_al_ing, fech_ing, fech_egres, tipo_de_plan, SENDA)%>%
    knitr::kable(.,format = "html", format.args = list(decimal.mark = ".", big.mark = ","),
               caption="Table 6. HASHs with more than one Nationallity",
                 align =rep('c', 101))  %>%
   kableExtra::kable_styling(bootstrap_options = c("striped", "hover"),font_size = 8) %>%
  kableExtra::scroll_box(width = "100%", height = "375px")
#_______________________
###PARA HACER LA CONVERSION
#_______________________
#CONS_C1_df_dup_FEB_2020_prev2 %>%
#    #dplyr::filter(HASH_KEY %in% as.character(as.vector(unlist(as.data.table(unlist(CONS_C1_df_dup_FEB_2020_prev2_nat)))))) %>% 
#    dplyr::mutate(concat_hash_id=paste0(HASH_KEY,"_",id)) %>%
#    dplyr::group_by(concat_hash_id) %>%
#    dplyr::add_tally() %>% 
#    dplyr::ungroup() %>%  
#    dplyr::select(HASH_KEY,id, id_mod, ano_bd, Edad, fech_nac,ano_nac,n) %>%
#    dplyr::group_by(HASH_KEY) %>% #primero genero la variable
#    dplyr::slice(which.max(n))%>% 
#    #dplyr::filter(HASH_KEY=="00a8e1377935f1639a28faa9c11ee03a")
#    assign("CONS_C1_df_dup_FEB_2020_prev2_most_frequent_age_dataset",., envir = .GlobalEnv)
#CONS_C1_df_dup_FEB_2020_prev2_prev4 %>%
    #dplyr::filter(HASH_KEY %in% as.character(as.vector(unlist(as.data.table(unlist(CONS_C1_df_dup_FEB_2020_prev2_nat)))))) %>% 
#    dplyr::select(HASH_KEY,id,id_mod, ano_bd, Sexo, Edad_al_ing) %>%
#    dplyr::group_by(HASH_KEY) %>% #primero genero la variable
#    dplyr::slice(which.max(ano_bd))%>%
#    assign("CONS_C1_df_dup_FEB_2020_prev2_max_age",., envir = .GlobalEnv) 
    #dplyr::filter(HASH_KEY=="00012586ea3036b7a18093c396847a87")
```

- Ethnicity (Etnia) (`r CONS_C1_df_dup_FEB_2020_prev2 %>% group_by(HASH_KEY) %>% dplyr::mutate(Etnia_por_hash=n_distinct(Etnia)) %>% ungroup() %>% dplyr::filter(Etnia_por_hash>1) %>% nrow() %>%  formatC(, format="f", big.mark=",", digits=0)`)

```{r pers_info_etnia, echo=T, paged.print=TRUE}
CONS_C1_df_dup_FEB_2020_prev2_etnia <- CONS_C1_df_dup_FEB_2020_prev2 %>% group_by(HASH_KEY) %>% dplyr::mutate(etnia_por_hash=n_distinct(Etnia)) %>% ungroup() %>% dplyr::filter(etnia_por_hash>1) %>% dplyr::distinct(HASH_KEY)
CONS_C1_df_dup_FEB_2020_prev2 %>% 
 dplyr::filter(HASH_KEY %in% as.character(as.vector(unlist(as.data.table(unlist(CONS_C1_df_dup_FEB_2020_prev2_etnia)))))) %>% # Select HASHs of cited cases
 dplyr::arrange(HASH_KEY) %>% #ordeno por ids 
dplyr::select(row, HASH_KEY, ano_bd, Nacionalidad, Etnia, sexo, fech_nac,Edad_al_ing, fech_ing, fech_egres, tipo_de_plan, SENDA)%>%
    knitr::kable(.,format = "html", format.args = list(decimal.mark = ".", big.mark = ","),
               caption="Table 7. HASHs with more than one Ethnicity",
                 align =rep('c', 101))  %>%
   kableExtra::kable_styling(bootstrap_options = c("striped", "hover"),font_size = 8) %>%
  kableExtra::scroll_box(width = "100%", height = "375px")
#_______________________
###PARA HACER LA CONVERSION
#_______________________
#CONS_C1_df_dup_FEB_2020_prev2 %>%
#    #dplyr::filter(HASH_KEY %in% as.character(as.vector(unlist(as.data.table(unlist(CONS_C1_df_dup_FEB_2020_prev2_nat)))))) %>% 
#    dplyr::mutate(concat_hash_id=paste0(HASH_KEY,"_",id)) %>%
#    dplyr::group_by(concat_hash_id) %>%
#    dplyr::add_tally() %>% 
#    dplyr::ungroup() %>%  
#    dplyr::select(HASH_KEY,id, id_mod, ano_bd, Edad, fech_nac,ano_nac,n) %>%
#    dplyr::group_by(HASH_KEY) %>% #primero genero la variable
#    dplyr::slice(which.max(n))%>% 
#    #dplyr::filter(HASH_KEY=="00a8e1377935f1639a28faa9c11ee03a")
#    assign("CONS_C1_df_dup_FEB_2020_prev2_most_frequent_age_dataset",., envir = .GlobalEnv)
#CONS_C1_df_dup_FEB_2020_prev2_prev4 %>%
    #dplyr::filter(HASH_KEY %in% as.character(as.vector(unlist(as.data.table(unlist(CONS_C1_df_dup_FEB_2020_prev2_nat)))))) %>% 
#    dplyr::select(HASH_KEY,id,id_mod, ano_bd, Sexo, Edad_al_ing) %>%
#    dplyr::group_by(HASH_KEY) %>% #primero genero la variable
#    dplyr::slice(which.max(ano_bd))%>%
#    assign("CONS_C1_df_dup_FEB_2020_prev2_max_age",., envir = .GlobalEnv) 
    #dplyr::filter(HASH_KEY=="00012586ea3036b7a18093c396847a87")
```

- Age of Onset of Drug Use (edad_ini_cons) (`r CONS_C1_df_dup_FEB_2020_prev2 %>% group_by(HASH_KEY) %>% dplyr::mutate(edad_ini_cons_por_hash=n_distinct(edad_ini_cons)) %>% ungroup() %>% dplyr::filter(edad_ini_cons_por_hash>1) %>% nrow() %>%  formatC(, format="f", big.mark=",", digits=0)`)

```{r pers_info_edad_ini_cons, echo=T, paged.print=TRUE}
CONS_C1_df_dup_FEB_2020_prev2_edad_ini_cons <- CONS_C1_df_dup_FEB_2020_prev2 %>% group_by(HASH_KEY) %>% dplyr::mutate(edad_ini_cons_por_hash=n_distinct(edad_ini_cons)) %>% ungroup() %>% dplyr::filter(edad_ini_cons_por_hash>1) %>% dplyr::distinct(HASH_KEY)
CONS_C1_df_dup_FEB_2020_prev2 %>% 
 dplyr::filter(HASH_KEY %in% as.character(as.vector(unlist(as.data.table(unlist(CONS_C1_df_dup_FEB_2020_prev2_edad_ini_cons)))))) %>% # Select HASHs of cited cases
 dplyr::arrange(HASH_KEY) %>% #ordeno por ids 
dplyr::select(row, HASH_KEY, ano_bd, edad_ini_cons, sexo, fech_nac,Edad_al_ing, fech_ing, fech_egres, tipo_de_plan, SENDA)%>%
    knitr::kable(.,format = "html", format.args = list(decimal.mark = ".", big.mark = ","),
               caption="Table 8. HASHs with more than one Age of Onset of Drug Use",
                 align =rep('c', 101))  %>%
   kableExtra::kable_styling(bootstrap_options = c("striped", "hover"),font_size = 8) %>%
  kableExtra::scroll_box(width = "100%", height = "375px")
#_______________________
###PARA HACER LA CONVERSION
#_______________________
#CONS_C1_df_dup_FEB_2020_prev2 %>%
#    #dplyr::filter(HASH_KEY %in% as.character(as.vector(unlist(as.data.table(unlist(CONS_C1_df_dup_FEB_2020_prev2_nat)))))) %>% 
#    dplyr::mutate(concat_hash_id=paste0(HASH_KEY,"_",id)) %>%
#    dplyr::group_by(concat_hash_id) %>%
#    dplyr::add_tally() %>% 
#    dplyr::ungroup() %>%  
#    dplyr::select(HASH_KEY,id, id_mod, ano_bd, Edad, fech_nac,ano_nac,n) %>%
#    dplyr::group_by(HASH_KEY) %>% #primero genero la variable
#    dplyr::slice(which.max(n))%>% 
#    #dplyr::filter(HASH_KEY=="00a8e1377935f1639a28faa9c11ee03a")
#    assign("CONS_C1_df_dup_FEB_2020_prev2_most_frequent_age_dataset",., envir = .GlobalEnv)
#CONS_C1_df_dup_FEB_2020_prev2_prev4 %>%
    #dplyr::filter(HASH_KEY %in% as.character(as.vector(unlist(as.data.table(unlist(CONS_C1_df_dup_FEB_2020_prev2_nat)))))) %>% 
#    dplyr::select(HASH_KEY,id,id_mod, ano_bd, Sexo, Edad_al_ing) %>%
#    dplyr::group_by(HASH_KEY) %>% #primero genero la variable
#    dplyr::slice(which.max(ano_bd))%>%
#    assign("CONS_C1_df_dup_FEB_2020_prev2_max_age",., envir = .GlobalEnv) 
    #dplyr::filter(HASH_KEY=="00012586ea3036b7a18093c396847a87")
```

- Age of Onset of Drug Use Principal Substance (edad_ini_sus_prin) (`r CONS_C1_df_dup_FEB_2020_prev2 %>% group_by(HASH_KEY) %>% dplyr::mutate(edad_ini_sus_prin_por_hash=n_distinct(edad_ini_sus_prin)) %>% ungroup() %>% dplyr::filter(edad_ini_sus_prin_por_hash>1) %>% nrow() %>%  formatC(, format="f", big.mark=",", digits=0)`)
<!--- considerar que no sea mayor a la edad de inicio de consumo --->

```{r pers_info_edad_ini_sus_prin, echo=T, paged.print=TRUE}
CONS_C1_df_dup_FEB_2020_prev2_edad_ini_sus_prin <- CONS_C1_df_dup_FEB_2020_prev2 %>% group_by(HASH_KEY) %>% dplyr::mutate(edad_ini_sus_prin_por_hash=n_distinct(edad_ini_sus_prin)) %>% ungroup() %>% dplyr::filter(edad_ini_sus_prin_por_hash>1) %>% dplyr::distinct(HASH_KEY)
CONS_C1_df_dup_FEB_2020_prev2 %>% 
 dplyr::filter(HASH_KEY %in% as.character(as.vector(unlist(as.data.table(unlist(CONS_C1_df_dup_FEB_2020_prev2_edad_ini_sus_prin)))))) %>% # Select HASHs of cited cases
 dplyr::arrange(HASH_KEY) %>% #ordeno por ids 
dplyr::select(row, HASH_KEY, ano_bd, edad_ini_cons,edad_ini_cons, sexo, fech_nac,Edad_al_ing, fech_ing, fech_egres, tipo_de_plan, SENDA)%>%
    knitr::kable(.,format = "html", format.args = list(decimal.mark = ".", big.mark = ","),
               caption="Table 9. HASHs with more than one Age of Onset of Drug Use Principal Substance",
                 align =rep('c', 101))  %>%
   kableExtra::kable_styling(bootstrap_options = c("striped", "hover"),font_size = 8) %>%
  kableExtra::scroll_box(width = "100%", height = "375px")
#_______________________
###PARA HACER LA CONVERSION
#_______________________
#CONS_C1_df_dup_FEB_2020_prev2 %>%
#    #dplyr::filter(HASH_KEY %in% as.character(as.vector(unlist(as.data.table(unlist(CONS_C1_df_dup_FEB_2020_prev2_nat)))))) %>% 
#    dplyr::mutate(concat_hash_id=paste0(HASH_KEY,"_",id)) %>%
#    dplyr::group_by(concat_hash_id) %>%
#    dplyr::add_tally() %>% 
#    dplyr::ungroup() %>%  
#    dplyr::select(HASH_KEY,id, id_mod, ano_bd, Edad, fech_nac,ano_nac,n) %>%
#    dplyr::group_by(HASH_KEY) %>% #primero genero la variable
#    dplyr::slice(which.max(n))%>% 
#    #dplyr::filter(HASH_KEY=="00a8e1377935f1639a28faa9c11ee03a")
#    assign("CONS_C1_df_dup_FEB_2020_prev2_most_frequent_age_dataset",., envir = .GlobalEnv)
#CONS_C1_df_dup_FEB_2020_prev2_prev4 %>%
    #dplyr::filter(HASH_KEY %in% as.character(as.vector(unlist(as.data.table(unlist(CONS_C1_df_dup_FEB_2020_prev2_nat)))))) %>% 
#    dplyr::select(HASH_KEY,id,id_mod, ano_bd, Sexo, Edad_al_ing) %>%
#    dplyr::group_by(HASH_KEY) %>% #primero genero la variable
#    dplyr::slice(which.max(ano_bd))%>%
#    assign("CONS_C1_df_dup_FEB_2020_prev2_max_age",., envir = .GlobalEnv) 
    #dplyr::filter(HASH_KEY=="00012586ea3036b7a18093c396847a87")
```

- Starting Substance (sus_ini) (`r CONS_C1_df_dup_FEB_2020_prev2 %>% group_by(HASH_KEY) %>% dplyr::mutate(sus_ini_por_hash=n_distinct(sus_ini)) %>% ungroup() %>% dplyr::filter(sus_ini_por_hash>1) %>% nrow() %>%  formatC(, format="f", big.mark=",", digits=0)`)
<!--- considerar que no sea mayor a la edad de inicio de consumo --->

```{r pers_info_sus_ini, echo=T, paged.print=TRUE}
CONS_C1_df_dup_FEB_2020_prev2_sus_ini <- CONS_C1_df_dup_FEB_2020_prev2 %>% group_by(HASH_KEY) %>% dplyr::mutate(sus_ini_por_hash=n_distinct(sus_ini)) %>% ungroup() %>% dplyr::filter(sus_ini_por_hash>1) %>% dplyr::distinct(HASH_KEY)
CONS_C1_df_dup_FEB_2020_prev2 %>% 
 dplyr::filter(HASH_KEY %in% as.character(as.vector(unlist(as.data.table(unlist(CONS_C1_df_dup_FEB_2020_prev2_sus_ini)))))) %>% # Select HASHs of cited cases
 dplyr::arrange(HASH_KEY) %>% #ordeno por ids 
dplyr::select(row, HASH_KEY, ano_bd, sus_ini, edad_ini_cons,edad_ini_cons, sexo, fech_nac,Edad_al_ing, fech_ing, fech_egres, tipo_de_plan, SENDA)%>%
    knitr::kable(.,format = "html", format.args = list(decimal.mark = ".", big.mark = ","),
               caption="Table 10. HASHs with more than one Starting Substance",
                 align =rep('c', 101))  %>%
   kableExtra::kable_styling(bootstrap_options = c("striped", "hover"),font_size = 8) %>%
  kableExtra::scroll_box(width = "100%", height = "375px")
#_______________________
###PARA HACER LA CONVERSION
#_______________________
#CONS_C1_df_dup_FEB_2020_prev2 %>%
#    #dplyr::filter(HASH_KEY %in% as.character(as.vector(unlist(as.data.table(unlist(CONS_C1_df_dup_FEB_2020_prev2_nat)))))) %>% 
#    dplyr::mutate(concat_hash_id=paste0(HASH_KEY,"_",id)) %>%
#    dplyr::group_by(concat_hash_id) %>%
#    dplyr::add_tally() %>% 
#    dplyr::ungroup() %>%  
#    dplyr::select(HASH_KEY,id, id_mod, ano_bd, Edad, fech_nac,ano_nac,n) %>%
#    dplyr::group_by(HASH_KEY) %>% #primero genero la variable
#    dplyr::slice(which.max(n))%>% 
#    #dplyr::filter(HASH_KEY=="00a8e1377935f1639a28faa9c11ee03a")
#    assign("CONS_C1_df_dup_FEB_2020_prev2_most_frequent_age_dataset",., envir = .GlobalEnv)
#CONS_C1_df_dup_FEB_2020_prev2_prev4 %>%
    #dplyr::filter(HASH_KEY %in% as.character(as.vector(unlist(as.data.table(unlist(CONS_C1_df_dup_FEB_2020_prev2_nat)))))) %>% 
#    dplyr::select(HASH_KEY,id,id_mod, ano_bd, Sexo, Edad_al_ing) %>%
#    dplyr::group_by(HASH_KEY) %>% #primero genero la variable
#    dplyr::slice(which.max(ano_bd))%>%
#    assign("CONS_C1_df_dup_FEB_2020_prev2_max_age",., envir = .GlobalEnv) 
    #dplyr::filter(HASH_KEY=="00012586ea3036b7a18093c396847a87")
```

&nbsp;
<br>

## 2. Overlap Between Dates of Admission & Discharge

&nbsp;
<br>
Once discarded duplicated cases, we searched for cases in which dates ranges were overlapped with other treatments for the same user (HASH).This required to temporarily replace  those cases that did not have a date of dischage, with the date of retrieval of the datasets, that is "2019-11-13". 

<br>

```{r  overlap1,echo=T, paged.print=TRUE}
CONS_C1_df_dup_intervals_FEB_2020<- CONS_C1_df_dup_FEB_2020_prev2 %>%
  #as.numeric(as.Date("2019-11-13")) #18213
  dplyr::mutate(fech_ing_num2=as.numeric(as.Date(fech_ing))) %>%
  dplyr::mutate(fech_egres_num2=as.numeric(as.Date(fech_egres))) %>%
  dplyr::mutate(fech_egres_num2=ifelse(is.na(fech_egres),18213,fech_egres_num2)) %>%
  dplyr::rename("HASH_KEY_2"="HASH_KEY", "row2"="row") %>%
  dplyr::select(row2,HASH_KEY_2, ano_bd,fech_ing, fech_ing_num2,fech_egres,fech_egres_num2,Edad, dias_trat,ID.centro, motivodeegreso, SENDA) %>% 
  #dplyr::filter(motivodeegreso!="Derivación") %>%
  data.table::as.data.table()
require(sqldf)
require(gridExtra)
  overlap_dates_C1_FEB_2020 <- janitor::clean_names(sqldf("SELECT *
                 FROM CONS_C1_df_dup_intervals_FEB_2020 AS x  
                 INNER JOIN CONS_C1_df_dup_intervals_FEB_2020 AS y 
                 ON x.HASH_KEY_2 == y.HASH_KEY_2 AND 
                 x.fech_ing_num2 < y.fech_egres_num2 AND x.fech_egres_num2 > y.fech_ing_num2 AND x.row2 != y.row2"))  
  #busca mismo hash, distinto row,pero fecha de ingreso menor o igual a la fecha de egreso del otro, y fecha de egreso mayor o igual a la fecha de ingreso del otro. lo del row ES PARA DESCARTAR CASOS QUE SE SUPERPONEN CONSIGMO MISMO.
overlap_dates_C1_FEB_2020 %>%
  dplyr::mutate(fech_ing=stringi::stri_sub(as.character.Date(fech_ing),1,10)) %>%
  dplyr::mutate(fech_egres=stringi::stri_sub(as.character.Date(fech_egres),1,10)) %>%
  dplyr::mutate(fech_ing_2=stringi::stri_sub(as.character.Date(fech_ing_2),1,10)) %>%
  dplyr::mutate(fech_egres_2=stringi::stri_sub(as.character.Date(fech_egres_2),1,10)) %>%
  dplyr::rename("row_1"="row2","hash_key_1"="hash_key_2", "ano_bd_1"="ano_bd","fech_ing_1"="fech_ing","fech_ing_num_1"="fech_ing_num2",
                "fech_egres_1"="fech_egres","fech_egres_num_1"="fech_egres_num2", "edad_1"="edad","dias_trat_1"="dias_trat","id_centro_1"="id_centro",
                "motivodeegreso_1"="motivodeegreso", "senda_1"="senda", "row_2"="row2_2", "hash_key_2"="hash_key_2_2", "fech_ing_num_2"="fech_ing_num2_2",
                "fech_egres_num_2"="fech_egres_num2_2") %>%
  #dplyr::select(row2, hash_key_2,row2_2,hash_key_2_2, everything()) %>%
  assign("CONS_C1_df_dup_FEB_2020_overlaps",.,envir = .GlobalEnv)

#EL DE LA IZQUIERDA TIENDE A SER MÁS ANTIGUO QUE EL DE LA DERECHA, CONSTE
CONS_C1_df_dup_FEB_2020_overlaps %>%
  dplyr::mutate(prod_row=as.numeric(row_1)*as.numeric(row_2), sum_row=as.numeric(row_1)+as.numeric(row_2), filter_row=paste0(prod_row,"_",sum_row)) %>%
  dplyr::mutate(caso_2_mas_reciente=ifelse(as.numeric(fech_ing_num_2)>as.numeric(fech_ing_num_1),1,0)) %>% #ver si el dato de la izq es más aniguo
  dplyr::arrange(desc(caso_2_mas_reciente)) %>%
  dplyr::filter(!duplicated(filter_row)) %>% #dejé sólo los casos que son más recientes. Se supone q no perdí casos, sino que saqué los duplicados
  dplyr::mutate(bd_2_mas_reciente=ifelse(ano_bd_2>ano_bd_1,1,0)) %>% #es el dato de la derecha de una base de datos mas reciente.
  dplyr::mutate(senda= ifelse(senda_1=="Si" & senda_2=="Si","Si Ambos",
                        ifelse(senda_1=="No" & senda_2=="No","No Ambos",
                              ifelse(senda_1=="No" & senda_2=="Si","Si 2",
                                     ifelse(senda_1=="Si" & senda_2=="No","No 2",NA))))) %>%
  dplyr::mutate(Derivacion= ifelse(motivodeegreso_1=="Derivación",1,0)) %>%
  dplyr::mutate(days_overlapped=fech_egres_num_1-fech_ing_num_2) %>% # para que hayan dias positivos. Se supone que la fecha de egreso es más reciente que la fecha de ingreso del evento que superpone.
  dplyr::mutate(mas_dias_trat=ifelse(dias_trat_2>dias_trat_1,1,0)) %>%
  dplyr::select(-caso_2_mas_reciente, -filter_row,-prod_row,-sum_row,-hash_key_2) %>%
    assign("CONS_C1_df_dup_FEB_2020_overlaps_COMP",.,envir = .GlobalEnv)
CONS_C1_df_dup_FEB_2020_overlaps_COMP %>%
  knitr::kable(.,format = "html", format.args = list(decimal.mark = ".", big.mark = ","),
               caption="Table 11. Cases with overlapped treatment ranges",
                 align =rep('c', 101))  %>%
   kableExtra::kable_styling(bootstrap_options = c("striped", "hover"),font_size = 8) %>%
  kableExtra::scroll_box(width = "100%", height = "375px")

#FOR COMPARISON
#panelr::long_panel(CONS_C1_df_dup_FEB_2020_overlaps, prefix = "_", label_location = "end", begin = 1, end = 2) %>% 
#  #dplyr::select(-hash_key_2) %>%
#  dplyr::rename("overlap_id"="id") %>%
#  guardar_tablas("_overlaps_feb_2020")
```


We identified `r CONS_C1_df_dup_FEB_2020_overlaps_COMP %>%  nrow() %>% formatC(, format="f", big.mark=",", digits=0)` overlappings. We substracted the days overlapped between the date of discharge of the first treatment and the date of admission of the second treatment. 
<!--- eso requiere cambiar los días de tratamiento, el motivodeegreso mod, el de late withdrawal y todo, dias_trat, etc --->
<!--- ¿y qué pasa con los casos que tienen más de un HASH overlapiado??, `r CONS_C1_df_dup_FEB_2020_overlaps_COMP %>%group_by(hash_key_1) %>% dplyr::mutate(mas_de_un_row=n_distinct(row_1)) %>% ungroup() %>% filter(mas_de_un_row>1) %>% nrow()` --->
<!--- qué pasa con los casos que tenian la fecha perdida de egreso por mucho tiempo y por tanto estoy perdiendo casos intermedios? `r CONS_C1_df_dup_FEB_2020_overlaps_COMP %>% dplyr::filter(is.na(fech_egres_1)) %>% nrow()`. AQUÍ HAY 2 PROBLEMAS.--->

**DEBO ESCRIBIR LO QUE HAY EN LOS COMENTARIOS AQUÍ!!!!**

```{r  overlap2,echo=T, paged.print=TRUE}
fech_egres_na_overlap<- CONS_C1_df_dup_FEB_2020_overlaps_COMP %>% dplyr::filter(is.na(fech_egres_1)) %>% distinct(hash_key_1)
#son 14 hashs con datos perdidos en la fecha de egreso
#probablemente los otros casos perdidos correspondan a personas que sólo tenían un evento no más.

CONS_C1_df_dup_FEB_2020_prev2 %>%
  dplyr::filter(HASH_KEY %in% as.character(as.vector(unlist(as.data.table(unlist(fech_egres_na_overlap)))))) %>% # select hashs of wrongly assigned ages
  dplyr::arrange(HASH_KEY) %>% 
  dplyr::select(HASH_KEY, ano_bd, fech_ing, fech_egres, dias_trat, SENDA) %>% print()
#si tiene un caso más, significa que con ese caso se detectó el overlap.
#001022ffb28057b24dd76900bbf1e3de   no hay problemas. sólo tiene 1 caso más
#0d7fe0ff18f5b16868a68ca5ee5d4b87   no hay problemas. sólo tiene 1 caso más
#137e8525aa3f79235fa8ad90913fdcbe   no hay problemas, sólo tiene 1 caso más después del que tiene perdida la fecha
#144b8d70d7ea1b9ea70d2ef7543520b2   no hay problemas, sólo tiene 1 caso más después del que tiene perdida la fecha
#1baff032eb17af74d98d63542c87423a   no hay problemas, sólo tiene 1 caso más después del que tiene perdida la fecha
#1d53b9a82ab4fbc0e6cfa109d664eb51   complicado
#2a9e74353a3177ed278508f91265e4b4   debiese quedar con fecha 2010-04-29
#3e23f3c3cbedb2aa1003e6a9d03eb070   podría ser el 2011-04-12 en el primer caso.
#57b4de7542dfab3c29b6705cb392ff8a   2012-02-16


#CREO QUE PODRÍA ORDENAR TODOS LOS DATOS POR FECHA DE INGRESO, Y OCUPAR LEAD Y LAG PARA REEMPLAZAR Y CHAO. AUTOMATIZAR EL PROCESO
```


## 3. Probabilistic Matches

&nbsp;

The code used in stata is shown here:

&nbsp;
<br>

```{stata, collectcode=TRUE}
import delimited "G:\Mi unidad\Alvacast\SISTRAT 2019 (github)\SUD_CL\CONS_C1_df_dup_FEB_2020.csv", delimiter(";") clear 

cap gen date_in = mdy(real_fech_ing_mes, real_fech_ing_dia, real_fech_ing_ano)
cap gen date_in = mdy(fech_ing_mes, fech_ing_dia, fech_ing_ano)

generate id_match = _n
cap drop _id
dtalink hash_key 25 -25 idcentro 10 0 date_in 30 -30 5 Edad 7 -7 escolaridad 8 -8 sexo 10 -10 id 10 -10, block(edad) cutoff(70)
drop if missing(_score)
cap qui save "G:\Mi unidad\Alvacast\SISTRAT 2019 (github)\Stata Duplicates Match\_CONS_C1_df_match70_2020_02_20.dta"
cap qui save "G:\Mi unidad\Alvacast\SISTRAT 2019 (github)\Stata Duplicates Match\_CONS_C1_df_match70_2020_02_20.dta", replace
```
<br>

```{r  dta_import, include=T, echo=T, eval=T, cache=T}
matches_from_stata_c1_feb <- haven::read_dta("G:/Mi unidad/Alvacast/SISTRAT 2019 (github)/Stata Duplicates Match/_CONS_C1_df_match70_2020_02_20.dta")
matches_from_stata_c1_feb <-matches_from_stata_c1 %>% dplyr::rename(score = 3, matchID = 1, row_id=2) 
matches_from_stata_c1_feb  %>%
  dplyr::arrange(score,matchID,hash_key) %>%
  dplyr::select(score, matchID, hash_key, ano_bd, idcentro, date_in, fech_ing, fech_egres, edad, dias_trat) %>%
  as.data.frame() %>%
    knitr::kable(.,format = "html", format.args = list(decimal.mark = ".", big.mark = ","),
                   caption="Table 11. Preliminary View of Matches from Stata", align =rep('c', 100)) %>%
     kableExtra::kable_styling(bootstrap_options = c("striped", "hover"),font_size = 8) %>%
    kableExtra::scroll_box(width = "100%", height = "350px")
```
<br>

The dataset was configured to find duplicated rows in almost every variable, excepting the row number in the whole consolidated dataset and the year of the dataset in which the row was obtained. For the purpose of this page, we will use the terms "rows" and "cases" as equal to refer to the entries of the dataset.

<br>

There are `r CONS_C1_df_dup_FEB_2020_prev1 %>% dplyr::filter(sus_principal=="Cocaína", via_adm_sus_prin!="Intranasal  ( aspiración de polvo por la nariz)") %>% nrow() %>% formatC(, format="f", big.mark=",", digits=0)` cases that does not snort Cocaine.

<br>

```{r  coca_no_aspiracion, include=T, echo=T, eval=T, cache=T}
CONS_C1_df_dup_FEB_2020_prev1 %>% dplyr::filter(sus_principal=="Cocaína", via_adm_sus_prin!="Intranasal  ( aspiración de polvo por la nariz)") %>% nrow()
```

<br>

There are `r CONS_C1_df_dup_FEB_2020_prev1 %>% dplyr::filter(sus_principal=="Cocaína", via_adm_sus_prin!="Intranasal  ( aspiración de polvo por la nariz)") %>% nrow() %>% formatC(, format="f", big.mark=",", digits=0)` cases that does not snort Cocaine.

<br>

We must replace alcohol route of administration of principal substance to make it exclusivelly oral.

<br>

```{r  recods, include=T, echo=T, eval=T, cache=T}
CONS_C1_df_dup_FEB_2020_prev1 %>% dplyr::filter(escolaridad=="Mayor a Ed Secundaria", Edad<21) %>% nrow()
CONS_C1_df_dup_FEB_2020_prev1 %>% dplyr::filter(sus_principal=="Inhalables") %>% dplyr::group_by(via_adm_sus_prin) %>% summarise(n=n())
CONS_C1_df_dup_FEB_2020_prev1 %>% dplyr::filter(sus_principal=="Alcohol") %>% dplyr::group_by(via_adm_sus_prin) %>% summarise(n=n())
```


There are some cases that does not have a primary diagnostic, but have a secondary or tertiary

Programa Específico Mujeres	MASA1**031978, ver si es hombre o mujer de verdad


