---
title: "Readmission risk among women in women-only versus mixed gender treatment programs for substance use disorder in Chile (3rd step)"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  html_document:
    code_folding: hide  
    toc: true # table of content true
    toc_depth: 5  # upto three depths of headings (specified by #, ## and ###)
    toc_float: true
---

```{css zoom-lib-src, echo = FALSE}
script src = "https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"
```

```{js zoom-jquery, echo = FALSE}
 $(document).ready(function() {
    $('body').prepend('<div class=\"zoomDiv\"><img src=\"\" class=\"zoomImg\"></div>');
    // onClick function for all plots (img's)
    $('img:not(.zoomImg)').click(function() {
      $('.zoomImg').attr('src', $(this).attr('src')).css({width: '100%'});
      $('.zoomDiv').css({opacity: '1', width: 'auto', border: '1px solid white', borderRadius: '5px', position: 'fixed', top: '50%', left: '50%', marginRight: '-50%', transform: 'translate(-50%, -50%)', boxShadow: '0px 0px 50px #888888', zIndex: '50', overflow: 'auto', maxHeight: '100%'});
    });
    // onClick function for zoomImg
    $('img.zoomImg').click(function() {
      $('.zoomDiv').css({opacity: '0', width: '0%'}); 
    });
  });
```

```{=html}
<style type="text/css">
.tablelines table, .tablelines td, .tablelines th {
        border: 1px solid black;
        }
.centrado {
    text-align: center;
}
.table.center {
    margin-left:auto; 
    margin-right:auto;
  }
.table_wrapper{
    display: block;
    overflow-x: auto;
    white-space: nowrap;
}
code.r{
  font-size: 8px;
}
body{ /* Normal  */
      text-align: justify;
  }
.superbigimage{
    overflow-y:scroll;
    white-space: nowrap;
}
.superbigimage img{
    overflow-y: scroll;
    overflow-x: hidden;
}
</style>
```
```{=html}
<style>
div.blue { background-color:#e6f0ff; border-radius: 5px; padding: 20px; text-align: justify;}
</style>
```
```{r prev_setup, include = FALSE, cache=T}
rm(list=ls());gc()
path<-rstudioapi::getSourceEditorContext()$path
#load("E:/Mi unidad/Alvacast/SISTRAT 2019 (github)/mult_state_carla.RData")
if (grepl("CISS Fondecyt",path)==T){
    setwd("C:/Users/CISS Fondecyt/OneDrive/Escritorio/SUD_CL/");load("G:/Mi unidad/Alvacast/SISTRAT 2019 (github)/mult_state_carla_2.RData")
  } else if (grepl("andre",path)==T){
    setwd('C:/Users/andre/Desktop/SUD_CL/');load("E:/Mi unidad/Alvacast/SISTRAT 2019 (github)/mult_state_carla_2.RData")
  } else if (grepl("E:",path)==T){
    setwd("E:/Mi unidad/Alvacast/SISTRAT 2019 (github)/SUD_CL/");load("E:/Mi unidad/Alvacast/SISTRAT 2019 (github)/mult_state_carla_2.RData")
  } else {
    setwd("G:/Mi unidad/Alvacast/SISTRAT 2019 (github)/SUD_CL/");load("G:/Mi unidad/Alvacast/SISTRAT 2019 (github)/mult_state_carla_2.RData")
  }
```

```{r setup, include = FALSE, cache=T}
#Libraries used in the routine. Dont change the order
local({r <- getOption("repos")
       r["CRAN"] <- "http://cran.r-project.org" 
       options(repos=r)
})
copiar_nombres <- function(x,row.names=FALSE,col.names=TRUE,dec=",",...) {
  if(class(ungroup(x))[1]=="tbl_df"){
        if(options()$OutDec=="."){
            options(OutDec = dec)
            write.table(format(data.frame(x)),"clipboard",sep="\t",row.names=FALSE,col.names=col.names,...)
            options(OutDec = ".")
          return(x)
        } else {
            options(OutDec = ",")
            write.table(format(data.frame(x)),"clipboard",sep="\t",row.names=FALSE,col.names=col.names,...)
            options(OutDec = ",")
          return(x)    
        }
  } else {
        if(options()$OutDec=="."){
            options(OutDec = dec)
            write.table(format(x),"clipboard",sep="\t",row.names=FALSE,col.names=col.names,...)
            options(OutDec = ".")
          return(x)
        } else {
            options(OutDec = ",")
            write.table(format(x),"clipboard",sep="\t",row.names=FALSE,col.names=col.names,...)
            options(OutDec = ",")
          return(x)       
  }
 }
}  
#packageVersion("codebook")
#https://github.com/RevolutionAnalytics/checkpoint
#if(!require(checkpoint)){install.packages("checkpoint")}
#if(!require(here)){install.packages("here")}
#checkpoint::checkpoint("2020-02-19",project=here::here(),checkpointLocation=paste0(here::here(),"/dedup"), use.lock=F, use.knitr=T, auto.install.knitr = T,scan.rnw.with.knitr=T, forceInstall=T,scanForPackages = TRUE)
#checkpointArchives(tempdir(), full.names = TRUE)

#if(!require(tidyr)){install.packages("tidyr")}
#if(!require(DataExplorer)){install.packages("DataExplorer")}
#if(!require(stringi)){install.packages("stringi")}
#if(!require(stringr)){install.packages("stringr")}
#if(!require(ggplot2)){install.packages("ggplot2")}
#if(!require(Hmisc)){install.packages("Hmisc")}
#if(!require(kableExtra)){install.packages("kableExtra")}
#if(!require(plotly)){install.packages("plotly")}
#if(!require(rbokeh)){install.packages("rbokeh")}
#if(!require(altair)){install.packages("altair")}
#if(!require(zoo)){install.packages("zoo")}
#if(!require(codebook)){install.packages("codebook")}
#if(!require(broom)){install.packages("broom")}
#if(!require(sqldf)){install.packages("sqldf")} 
#if(!require(devtools)){install.packages("devtools")}
#if(!require(Statamarkdown)){install_github("hemken/Statamarkdown")}
#if(!require(data.table)){install.packages("data.table")}
#if(!require(dplyr)){install.packages("dplyr")}

#if(!require(boot)){install.packages("boot")}
#if(!require(plyr)){install.packages("plyr")}
#if(!require(matrixStats)){install.packages("matrixStats")}
#if(!require(radiant)){install.packages("radiant", repos = "https://radiant-rstats.github.io/minicran/")}

try(library(boot))
library(matrixStats)
library(knitr)
library(tidyr)
library(stringi)
library(stringr)
library(ggplot2)
library(Hmisc)
library(kableExtra)
library(plotly)
library(janitor)
library(rbokeh)
library(zoo)
library(broom)
library(sqldf)
library(devtools)
library(codebook)
library(data.table)
library(panelr)
library(RColorBrewer)
library(lsmeans)
library(finalfit)
suppressPackageStartupMessages(library(ggiraph))
suppressPackageStartupMessages(library(sf))
library(treemapify)
library(dplyr)
library(tidyverse)
library(epiR)
library(survminer)
library(ggfortify)
library(survMisc)

library(foreign)
library(Hmisc)
library(gridExtra)
library(reshape2)
library(stargazer)
library(tableone)
library(MatchIt)
library(cobalt)
library(eha)
library(igraph)
library(Amelia)
library(DiagrammeR) 
library(mstate)
library(flexsurv)
library(muhaz)
library(Metrics)
#library(mstateutils)
#remotes::install_github("chjackson/flexsurv-dev", upgrade = "never")
#devtools::install_github("stulacy/multistateutils", build_vignettes=TRUE, upgrade = "never")
#devtools::install_github("hputter/mstate", upgrade = "never")
#unlink("C:/Users/CISS Fondecyt/OneDrive/Documentos/R/win-library/4.0/mstate", recursive=T, force=T)

if(!require(radiant.update)){install.packages("radiant.update", repos = "https://radiant-rstats.github.io/minicran/")}
#install.packages( repos = "https://radiant-rstats.github.io/minicran/")
#install.packages("radiant.update", repos = "https://radiant-rstats.github.io/minicran/")

#tryCatch(source("https://raw.githubusercontent.com/radiant-rstats/minicran/gh-pages/update.R"), error = function(e) print("updated package, radiant"))

#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:
#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:
#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:

try_with_time_limit <- function(expr, cpu = Inf, elapsed = Inf)
{
  y <- try({setTimeLimit(cpu, elapsed); expr}, silent = TRUE) 
  if(inherits(y, "try-error")) NULL else y 
}
eval_fork <- function(..., timeout=60){

  #this limit must always be higher than the timeout on the fork!
  setTimeLimit(timeout+5);      

  #dispatch based on method
  ##NOTE!!!!! Due to a bug in mcparallel, we cannot use silent=TRUE for now.
  myfork <- parallel::mcparallel({
    eval(...)
  }, silent=FALSE);

  #wait max n seconds for a result.
  myresult <- parallel::mccollect(myfork, wait=FALSE, timeout=timeout);

  #try to avoid bug/race condition where mccollect returns null without waiting full timeout.
  #see https://github.com/jeroenooms/opencpu/issues/131
  #waits for max another 2 seconds if proc looks dead 
  while(is.null(myresult) && totaltime < timeout && totaltime < 2) {
     Sys.sleep(.1)
     enddtime <- Sys.time();
     totaltime <- as.numeric(enddtime - starttime, units="secs")
     myresult <- parallel::mccollect(myfork, wait = FALSE, timeout = timeout);
  }

  #kill fork after collect has returned
  tools::pskill(myfork$pid, tools::SIGKILL);    
  tools::pskill(-1 * myfork$pid, tools::SIGKILL);  

  #clean up:
  parallel::mccollect(myfork, wait=FALSE);

  #timeout?
  if(is.null(myresult)){
    stop("R call did not return within ", timeout, " seconds. Terminating process.", call.=FALSE);      
  }

  #move this to distinguish between timeout and NULL returns
  myresult <- myresult[[1]];

  #reset timer
  setTimeLimit();     

  #forks don't throw errors themselves
  if(inherits(myresult,"try-error")){
    #stop(myresult, call.=FALSE);
    stop(attr(myresult, "condition"));
  }

  #send the buffered response
  return(myresult);  
}

if(isTRUE(getOption('knitr.in.progress'))==T){
    n_iter=10000
} else {
n_iter=20
}
#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:
#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:

#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:
#GET LOCAL
#dir.create(paste0(getwd(),"/renv_local"))
#Sys.setenv(RENV_PATHS_LOCAL = paste0(getwd(),"/renv_local"))
#install.packages(paste0(getwd(),"/renv_local/gurobi_9.1-0.zip"), repos = NULL, type="source")
#install.packages(paste0("G:/Mi unidad/Alvacast/SISTRAT 2019 (github)/renv_local/gurobi_9.1-0.zip"), repos = NULL, type="source")
#"G:/Mi unidad/Alvacast/SISTRAT 2019 (github)"
#Sys.getenv("R_LIBS_USER")
```


# Cumulative Transition Hazards of Joint Models


```{r haz_df, eval=T, echo=T, paged.print=TRUE, error=T}
`%>%`<-magrittr::`%>%`
# 3 states -General population
cumhaz_data_a <- rbind(data.frame(cox_cumhaz_0_a_gp$Haz,
                                model = "NP Cox"),
                      data.frame(mrcox_a$Haz,
                                model = "Cox"),
                      data.frame(flexsurv_cumhaz_a$Haz,
                                model = "Parametric"))

cumhaz_data_a$trans <- factor(cumhaz_data_a$trans,
                            levels = seq(1, 3),
                            labels = c("Adm -> Ther.Disch",
                                       "Adm -> Readm",
                                       "Ther.Disch -> Readm"))

# 3 states -Women specific
cumhaz_data_b <- rbind(data.frame(cox_cumhaz_0_a_we$Haz,
                                model = "NP Cox"),
                      data.frame(mrcox_b$Haz,
                                model = "Cox"),
                      data.frame(flexsurv_cumhaz_b$Haz,
                                model = "Parametric"))
cumhaz_data_b$trans <- factor(cumhaz_data_b$trans,
                            levels = seq(1, 3),
                            labels = c("Adm -> Ther.Disch",
                                       "Adm -> Readm",
                                       "Ther.Disch -> Readm"))

## 4 states -General population
cumhaz_data_c <- rbind(data.frame(cox_cumhaz_0_c_gp$Haz,
                                model = "NP Cox"),
                      data.frame(mrcox_c$Haz,
                                model = "Cox"),
                      data.frame(flexsurv_cumhaz_c$Haz,
                                model = "Parametric"))

cumhaz_data_c$trans <- factor(cumhaz_data_c$trans,
                            levels = seq(1, 5),
                            labels = c("Adm -> Ther.Disch",
                                       "Adm -> Disch.w/oClin.Adv.",
                                       "Adm -> Readm",
                                       "Ther.Disch -> Readm",
                                       "Disch.w/oClin.Adv.-> Readm"
                                       ))
## 4 states -Women specific
cumhaz_data_d <- rbind(data.frame(cox_cumhaz_0_c_we$Haz,
                                model = "NP Cox"),
                      data.frame(mrcox_d$Haz,
                                model = "Cox"),
                      data.frame(flexsurv_cumhaz_d$Haz,
                                model = "Parametric"))

cumhaz_data_d$trans <- factor(cumhaz_data_d$trans,
                            levels = seq(1, 5),
                            labels = c("Adm -> Ther.Disch",
                                       "Adm -> Disch.w/oClin.Adv.",
                                       "Adm -> Readm",
                                       "Ther.Disch -> Readm",
                                       "Disch.w/oClin.Adv.-> Readm"
                                       ))

fig_cox_ab<-
cumhaz_data_a %>%  
  dplyr::left_join(cumhaz_data_b, by=c("time","trans","model"), suffix=c(".gp",".ws")) %>% 
  reshape2::melt(id.vars=c("time","trans","model")) %>% 
ggplot(aes(time, value, color= model, linetype =variable))+
  geom_step(size=1, alpha=.65) + 
  facet_wrap(trans~., ncol=1, scales="free_y") + 
  scale_color_manual(name ="Model",values=c("#0A0D46","#9C8F1A","#653C08"),labels= c("Cox","NP Cox","Par"))+
  scale_linetype_manual(name= "Type of Plan",values=c(4,1), labels=c("General Population","Women-specific"))+
  scale_x_continuous(breaks=seq(0, 11, by = 1/2))+
  xlab("Years") + 
  ylab("Cumulative hazards") + 
  theme_minimal()+
  theme(legend.position=c(.9,.585),
        legend.background = element_rect(fill="white",
                                  size=0.5, linetype="solid", 
                                  colour ="black"))
fig_cox_cd<-
cumhaz_data_c %>%  
    dplyr::left_join(cumhaz_data_d, by=c("time","trans","model"), suffix=c(".gp",".ws")) %>% 
  reshape2::melt(id.vars=c("time","trans","model")) %>% 
ggplot(aes(time, value, color= model, linetype =variable))+
  geom_step(size=1, alpha=.65) + 
  facet_wrap(trans~., ncol=1, scales="free_y") + 
  scale_color_manual(name ="Model",values=c("#0A0D46","#9C8F1A","#653C08"),labels= c("Cox","NP Cox","Par"))+
  scale_linetype_manual(name= "Type of Plan",values=c(4,1), labels=c("General Population","Women-specific"))+
  scale_x_continuous(breaks=seq(0, 11, by = 1/2))+
  xlab("Years") + 
  ylab("Cumulative") + 
  theme_minimal()+
  theme(legend.position=c(.9,.585),
        legend.background = element_rect(fill="white",
                                  size=0.5, linetype="solid", 
                                  colour ="black"))
```
```{r cum_haz1, eval=T, echo=T, paged.print=TRUE, fig.height=15, fig.width=10, fig.cap="Figure 1a. Estimate of Cumulative Hazards, Three States Model", fig.align="center", error=T}
fig_cox_ab + theme(legend.position=c(.9,.585))+ ylim(0,1)
```

```{r cum_haz2, eval=T, echo=T, paged.print=TRUE, fig.height=15, fig.width=10, fig.cap="Figure 1b. Estimate of Cumulative Hazards, Four States Model", fig.align="center", error=T}
fig_cox_cd+ theme(legend.position=c(.9,.585))+ ylim(0,2)
```

<br>

# Transition Probabilities

```{r dfs1,eval=T, echo=T, paged.print=TRUE, error=T}

#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_
#This functionality is implemented in pmatrix.simfs, 
#but the tcovs argument actually has no impact on the transition probabilities, as evidenced below.
#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_
pmatrix_t_a_lo<-
do.call('rbind', lapply(seq(0, 11, by = 1/12), function(t) {
    attr(get(paste0("pmatrix_t_a_",t)),"lower")
    }))

pmatrix_t_b_lo<-
do.call('rbind', lapply(seq(0, 11, by = 1/12), function(t) {
    attr(get(paste0("pmatrix_t_b_",t)),"lower")
    }))

pmatrix_4s_t_a_lo<-
do.call('rbind', lapply(seq(0, 11, by = 1/12), function(t) {
    attr(get(paste0("pmatrix_4s_t_a_",t)),"lower")
    }))

pmatrix_4s_t_b_lo<-
do.call('rbind', lapply(seq(0, 11, by = 1/12), function(t) {
    attr(get(paste0("pmatrix_4s_t_b_",t)),"lower")
    }))

pmatrix_t_a_up<-
do.call('rbind', lapply(seq(0, 11, by = 1/12), function(t) {
    attr(get(paste0("pmatrix_t_a_",t)),"upper")
    }))

pmatrix_t_b_up<-
do.call('rbind', lapply(seq(0, 11, by = 1/12), function(t) {
    attr(get(paste0("pmatrix_t_b_",t)),"upper")
    }))

pmatrix_4s_t_a_up<-
do.call('rbind', lapply(seq(0, 11, by = 1/12), function(t) {
    attr(get(paste0("pmatrix_4s_t_a_",t)),"upper")
    }))

pmatrix_4s_t_b_up<-
do.call('rbind', lapply(seq(0, 11, by = 1/12), function(t) {
    attr(get(paste0("pmatrix_4s_t_b_",t)),"upper")
    }))
#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_
#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_

pmatrix_t_a_df_final<-
cbind.data.frame(t=rep(seq(0, 11, by = 1/12),each=dim(mat_3_states)[2]),
  trans=rep(1:dim(mat_3_states)[2]),
                  pmatrix_t_a,pmatrix_t_a_lo,pmatrix_t_a_up) %>% 
  data.frame() %>% 
  dplyr::rename("Trans_1"="X1","Trans_2"="X2","Trans_3"="X3",
                "Trans_1_lo"="X1.1","Trans_2_lo"="X2.1","Trans_3_lo"="X3.1",
                "Trans_1_up"="X1.2","Trans_2_up"="X2.2","Trans_3_up"="X3.2") %>% 
  dplyr::mutate(Trans_1_cis=paste0(sprintf("%1.2f",Trans_1)," [",
                                   sprintf("%1.2f",Trans_1_lo),"-",
                                   sprintf("%1.2f",Trans_1_up),"]")) %>% 
  dplyr::mutate(Trans_2_cis=paste0(sprintf("%1.2f",Trans_2)," [",
                                   sprintf("%1.2f",Trans_2_lo),"-",
                                   sprintf("%1.2f",Trans_2_up),"]")) %>% 
  dplyr::mutate(Trans_3_cis=paste0(sprintf("%1.2f",Trans_3)," [",
                                   sprintf("%1.2f",Trans_3_lo),"-",
                                   sprintf("%1.2f",Trans_3_up),"]"))

pmatrix_t_b_df_final<-
cbind.data.frame(t=rep(seq(0, 11, by = 1/12),each=dim(mat_3_states)[2]),
  trans=rep(1:dim(mat_3_states)[2]),
                  pmatrix_t_b,pmatrix_t_b_lo,pmatrix_t_b_up) %>% 
    data.frame() %>% 
  dplyr::rename("Trans_1"="X1","Trans_2"="X2","Trans_3"="X3",
                "Trans_1_lo"="X1.1","Trans_2_lo"="X2.1","Trans_3_lo"="X3.1",
                "Trans_1_up"="X1.2","Trans_2_up"="X2.2","Trans_3_up"="X3.2") %>% 
  dplyr::mutate(Trans_1_cis=paste0(sprintf("%1.2f",Trans_1)," [",
                                   sprintf("%1.2f",Trans_1_lo),"-",
                                   sprintf("%1.2f",Trans_1_up),"]")) %>% 
  dplyr::mutate(Trans_2_cis=paste0(sprintf("%1.2f",Trans_2)," [",
                                   sprintf("%1.2f",Trans_2_lo),"-",
                                   sprintf("%1.2f",Trans_2_up),"]")) %>% 
  dplyr::mutate(Trans_3_cis=paste0(sprintf("%1.2f",Trans_3)," [",
                                   sprintf("%1.2f",Trans_3_lo),"-",
                                   sprintf("%1.2f",Trans_3_up),"]"))

pmatrix_4s_t_a_df_final<-
cbind.data.frame(t=rep(seq(0, 11, by = 1/12),each=dim(mat_4_states)[2]),
  trans=rep(1:dim(mat_4_states)[2]),
                  pmatrix_4s_t_a,pmatrix_4s_t_a_lo,pmatrix_4s_t_a_up) %>% 
    data.frame() %>% 
  dplyr::rename("Trans_1"="X1","Trans_2"="X2","Trans_3"="X3","Trans_4"="X4",
                "Trans_1_lo"="X1.1","Trans_2_lo"="X2.1","Trans_3_lo"="X3.1","Trans_4_lo"="X4.1",
                "Trans_1_up"="X1.2","Trans_2_up"="X2.2","Trans_3_up"="X3.2","Trans_4_up"="X4.2") %>% 
  dplyr::mutate(Trans_1_cis=paste0(sprintf("%1.2f",Trans_1)," [",
                                   sprintf("%1.2f",Trans_1_lo),"-",
                                   sprintf("%1.2f",Trans_1_up),"]")) %>% 
  dplyr::mutate(Trans_2_cis=paste0(sprintf("%1.2f",Trans_2)," [",
                                   sprintf("%1.2f",Trans_2_lo),"-",
                                   sprintf("%1.2f",Trans_2_up),"]")) %>% 
  dplyr::mutate(Trans_3_cis=paste0(sprintf("%1.2f",Trans_3)," [",
                                   sprintf("%1.2f",Trans_3_lo),"-",
                                   sprintf("%1.2f",Trans_3_up),"]")) %>% 
  dplyr::mutate(Trans_4_cis=paste0(sprintf("%1.2f",Trans_4)," [",
                                   sprintf("%1.2f",Trans_4_lo),"-",
                                   sprintf("%1.2f",Trans_4_up),"]"))

pmatrix_4s_t_b_df_final<-
cbind.data.frame(t=rep(seq(0, 11, by = 1/12),each=dim(mat_4_states)[2]),
  trans=rep(1:dim(mat_4_states)[2]),
                  pmatrix_4s_t_b,pmatrix_4s_t_b_lo,pmatrix_4s_t_b_up) %>% 
    data.frame() %>% 
  dplyr::rename("Trans_1"="X1","Trans_2"="X2","Trans_3"="X3","Trans_4"="X4",
                "Trans_1_lo"="X1.1","Trans_2_lo"="X2.1","Trans_3_lo"="X3.1","Trans_4_lo"="X4.1",
                "Trans_1_up"="X1.2","Trans_2_up"="X2.2","Trans_3_up"="X3.2","Trans_4_up"="X4.2") %>% 
  dplyr::mutate(Trans_1_cis=paste0(sprintf("%1.2f",Trans_1)," [",
                                   sprintf("%1.2f",Trans_1_lo),"-",
                                   sprintf("%1.2f",Trans_1_up),"]")) %>% 
  dplyr::mutate(Trans_2_cis=paste0(sprintf("%1.2f",Trans_2)," [",
                                   sprintf("%1.2f",Trans_2_lo),"-",
                                   sprintf("%1.2f",Trans_2_up),"]")) %>% 
  dplyr::mutate(Trans_3_cis=paste0(sprintf("%1.2f",Trans_3)," [",
                                   sprintf("%1.2f",Trans_3_lo),"-",
                                   sprintf("%1.2f",Trans_3_up),"]")) %>% 
  dplyr::mutate(Trans_4_cis=paste0(sprintf("%1.2f",Trans_4)," [",
                                   sprintf("%1.2f",Trans_4_lo),"-",
                                   sprintf("%1.2f",Trans_4_up),"]"))

```

```{r probtrans_semimark_ci951_mssample_cox2.1a, eval=T, echo=T, paged.print=TRUE, error=T}
set.seed(1234)
pmatrix_cox_a_0<-
mstate::mssample(msf0$Haz, trans = mat_3_states, clock = "reset", M = n_iter/2, tvec = seq(0, 11, by = 1/12),do.trace=500)
set.seed(1234)
pmatrix_cox_b_0<-
mstate::mssample(msf1$Haz, trans = mat_3_states, clock = "reset", M = n_iter/2, tvec = seq(0, 11, by = 1/12),do.trace=500)
```
```{r probtrans_semimark_ci951_mssample_cox2.1b, eval=T, echo=T, paged.print=TRUE, error=T}
set.seed(1234)
pmatrix_cox_a_4s_0<-
mstate::mssample(msf0_4s$Haz, trans = mat_4_states, clock = "reset", M = n_iter/2, tvec = seq(0, 11, by = 1/12),do.trace=500)
set.seed(1234)
pmatrix_cox_b_4s_0<-
mstate::mssample(msf1_4s$Haz, trans = mat_4_states, clock = "reset", M = n_iter/2, tvec = seq(0, 11, by = 1/12),do.trace=500)

#pmatrix_cox_a
#pmatrix_cox_b
#pmatrix_cox_c
#pmatrix_cox_d
```
```{r probtrans_semimark_ci951_mssample_flexsurv, eval=T, echo=T, paged.print=TRUE}
#flexsurv_cumhaz_c$Haz
set.seed(1234)
pmatrix_flexsurv_a<-
mstate::mssample(flexsurv_cumhaz_a$Haz, trans = mat_3_states, clock = "reset", M = n_iter/2, tvec = seq(0, 11, by = 1/12),do.trace=500)
set.seed(1234)
pmatrix_flexsurv_b<-
mstate::mssample(flexsurv_cumhaz_b$Haz, trans = mat_3_states, clock = "reset", M = n_iter/2, tvec = seq(0, 11, by = 1/12),do.trace=500)
```
```{r probtrans_semimark_ci951_mssample_flexsurv_2, eval=T, echo=T, paged.print=TRUE, error=T}
#pstate1–pstate3 are close to the first rows of the matrices returned by pmatrix.fs
set.seed(1234)
pmatrix_flexsurv_c<-
mstate::mssample(flexsurv_cumhaz_c$Haz, trans = mat_4_states, clock = "reset", M = n_iter/2, tvec = seq(0, 11, by = 1/12),do.trace=500)
set.seed(1234)
pmatrix_flexsurv_d<-
mstate::mssample(flexsurv_cumhaz_d$Haz, trans = mat_4_states, clock = "reset", M = n_iter/2, tvec = seq(0, 11, by = 1/12),do.trace=500)
```

<br>

We simulated the trajectories from Semi-markov models by y generating the time to the next transition until the individual reaches an absorbing state or a specified censoring time

<br>

```{r mssample_plot, eval=T, echo=T, paged.print=TRUE, fig.height=15, fig.width=10, fig.cap="Figure 2a. Estimate of State Occupancies at Baseline, Three-states model", fig.align="center", error=T}
invisible(c("For semi-Markov models, mstate provides the function mssample to produce both simulated trajectories and transition probability matrices from semi-Markov models, given the estimated piecewise-constant cumulative hazards (Fiocco et al. 2008), produced by msfit or msfit.flexsurvreg, though this is generally less efficient than pmatrix.simfs. In this example, 1000 samples from mssample give estimates of transition probabilities that are accurate to within around 0.02. However with pmatrix.simfs, greater precision is achieved by simulating 100 times as many trajectories in a shorter time"))

#pmatrix_t_a_df_final pmatrix_t_b_df_final pmatrix_4s_t_a_df_final pmatrix_4s_t_b_df_final
fig_ab_pmatrix<-
pmatrix_cox_a %>%  
  dplyr::left_join(pmatrix_cox_b, by="time", suffix=c("",".wcovs_cox.gp")) %>% 
  dplyr::left_join(pmatrix_cox_a_0, by="time", suffix=c("",".wo_covs.ws")) %>% 
  dplyr::left_join(pmatrix_cox_b_0, by="time", suffix=c("",".wo_covs.gp")) %>% 
  #pstate1–pstate3 are close to the first rows of the matrices returned by pmatrix.fs
  dplyr::left_join(pmatrix_flexsurv_a, by="time", suffix=c("",".wcovs_par.ws")) %>% 
  dplyr::left_join(pmatrix_flexsurv_b, by="time", suffix=c("",".wcovs_par.gp")) %>% 
  dplyr::left_join(pmatrix_t_a_df_final[which(pmatrix_t_a_df_final$trans==1),c("t","Trans_1","Trans_2","Trans_3")], by=c("time"="t"))%>% 
  dplyr::rename("pstate1.wcovs_2par.ws"="Trans_1","pstate2.wcovs_2par.ws"="Trans_2", "pstate3.wcovs_2par.ws"="Trans_3") %>% 
  dplyr::left_join(pmatrix_t_b_df_final[which(pmatrix_t_b_df_final$trans==1),c("t","Trans_1","Trans_2","Trans_3")], by=c("time"="t"))%>%
  dplyr::rename("pstate1.wcovs_2par.gp"="Trans_1","pstate2.wcovs_2par.gp"="Trans_2", "pstate3.wcovs_2par.gp"="Trans_3") %>% 
  dplyr::rename("pstate1.wcovs_cox.ws"="pstate1","pstate2.wcovs_cox.ws"="pstate2", "pstate3.wcovs_cox.ws"="pstate3") %>% 
  reshape2::melt(id.vars="time") %>% #janitor::tabyl(variable)
  #tidyr::separate(variable, into=c("state","covs","program")) %>% 
  dplyr::mutate(state= dplyr::case_when(grepl("pstate1",variable)~"1)Admission",
                                        grepl("pstate2",variable)~"2)Therapeutic Discharge",
                                        grepl("pstate3",variable)~"3)Readmission",
                                        T~NA_character_)) %>%
  dplyr::mutate(covs= dplyr::case_when(grepl("wo_covs",variable)~"NP Cox",
                                       grepl("wcovs_2par",variable)~"Parametric (flexsurv)",
                                       grepl("wcovs_par",variable)~"Parametric (mssample)",
                                       grepl("wcovs_cox",variable)~"Cox",#debe ir después,  menos restrictivo
                                        T~NA_character_)) %>%
  dplyr::mutate(type_of_program= dplyr::case_when(grepl("ws",variable)~"Women-specific",
                                               grepl("gp",variable)~"General Population",
                                               T~NA_character_)) %>% 
ggplot(aes(time, value, color= covs, linetype =type_of_program))+
  geom_step(size=1, alpha=.65) + 
  facet_wrap(state~., ncol=1, scales="free_y") + #type_of_program
  scale_color_manual(name ="Model",values=c("#747118","#0F4940","#743D18","#33114E"),labels= c("Cox","NP Cox","Par (flexsurv)", "Par (mssample)"))+
 # scale_linetype_manual(name ="Type of program",values=c(1,4), labels= c("General Population","Women-specific"))+
  #scale_linetype_manual(name= "Covariates",values=c(1,4), labels=c("w/covs","w/o covs"))+
  scale_x_continuous(breaks=seq(0, 11,.5))+
  xlab("Years") + 
  ylab("State occupancy probabilities") + 
  theme_minimal()+
  theme(legend.position=c(.9,.9),
        legend.background = element_rect(fill="white",
                                  size=0.5, linetype="solid", 
                                  colour ="black"))

fig_ab_pmatrix
```

```{r mssample_plot2, eval=T, echo=T, paged.print=TRUE, fig.height=15, fig.width=10, fig.cap="Figure 2b. Estimate of State Occupancies at Baseline, Four-states model", fig.align="center", error=T}

#pmatrix_t_a_df_final pmatrix_t_b_df_final pmatrix_4s_t_a_df_final pmatrix_4s_t_b_df_final
fig_cd_pmatrix<-
pmatrix_cox_c %>%  
  dplyr::left_join(pmatrix_cox_d, by="time", suffix=c("",".wcovs_cox.gp")) %>% 
  dplyr::left_join(pmatrix_cox_a_4s_0, by="time", suffix=c("",".wo_covs.ws")) %>% 
  dplyr::left_join(pmatrix_cox_b_4s_0, by="time", suffix=c("",".wo_covs.gp")) %>% 
  #pstate1–pstate3 are close to the first rows of the matrices returned by pmatrix.fs
  dplyr::left_join(pmatrix_flexsurv_c, by="time", suffix=c("",".wcovs_par.ws")) %>% 
  dplyr::left_join(pmatrix_flexsurv_d, by="time", suffix=c("",".wcovs_par.gp")) %>% 
  dplyr::left_join(pmatrix_4s_t_a_df_final[which(pmatrix_4s_t_a_df_final$trans==1),c("t","Trans_1","Trans_2","Trans_3","Trans_4")], by=c("time"="t"))%>% 
  dplyr::rename("pstate1.wcovs_2par.ws"="Trans_1","pstate2.wcovs_2par.ws"="Trans_2", "pstate3.wcovs_2par.ws"="Trans_3",
                "pstate4.wcovs_2par.ws"="Trans_4") %>% 
  dplyr::left_join(pmatrix_4s_t_b_df_final[which(pmatrix_4s_t_b_df_final$trans==1),c("t","Trans_1","Trans_2","Trans_3","Trans_4")], by=c("time"="t"))%>%
  dplyr::rename("pstate1.wcovs_2par.gp"="Trans_1","pstate2.wcovs_2par.gp"="Trans_2", "pstate3.wcovs_2par.gp"="Trans_3",
                "pstate4.wcovs_2par.gp"="Trans_4") %>% 
  dplyr::rename("pstate1.wcovs_cox.ws"="pstate1","pstate2.wcovs_cox.ws"="pstate2", "pstate3.wcovs_cox.ws"="pstate3",
                "pstate4.wcovs_cox.ws"="pstate4") %>% 
  reshape2::melt(id.vars="time") %>% #janitor::tabyl(variable)
  #tidyr::separate(variable, into=c("state","covs","program")) %>% 
  dplyr::mutate(state= dplyr::case_when(grepl("pstate1",variable)~"1)Admission",
                                        grepl("pstate2",variable)~"2)Therapeutic Discharge",
                                        grepl("pstate3",variable)~"3)Discharge without medical advice",
                                        grepl("pstate4",variable)~"4)Readmission",
                                        T~NA_character_)) %>%
  dplyr::mutate(covs= dplyr::case_when(grepl("wo_covs",variable)~"NP Cox",
                                       grepl("wcovs_2par",variable)~"Parametric (flexsurv)",
                                       grepl("wcovs_par",variable)~"Parametric (mssample)",
                                       grepl("wcovs_cox",variable)~"Cox",#debe ir después,  menos restrictivo
                                        T~NA_character_)) %>%
  dplyr::mutate(type_of_program= dplyr::case_when(grepl("ws",variable)~"Women-specific",
                                               grepl("gp",variable)~"General Population",
                                               T~NA_character_)) %>% 
ggplot(aes(time, value, color= covs, linetype =type_of_program))+
  geom_step(size=1, alpha=.65) + 
  facet_wrap(state~., ncol=1, scales="free_y") + #type_of_program
  scale_color_manual(name ="Model",values=c("#747118","#0F4940","#743D18","#33114E"),labels= c("Cox","NP Cox","Par (flexsurv)", "Par (mssample)"))+
  scale_linetype_manual(name ="Type of program",values=c(1,4), labels= c("General Population","Women-specific"))+
  #scale_linetype_manual(name= "Covariates",values=c(1,4), labels=c("w/covs","w/o covs"))+
  scale_x_continuous(breaks=seq(0, 11,.5))+
  scale_y_continuous(labels = scales::percent_format(accuracy = 2))+
  xlab("Years") + 
  ylab("State occupancy probabilities") + 
  theme_minimal()+
  theme(legend.position=c(.9,.9),
        legend.background = element_rect(fill="white",
                                  size=0.5, linetype="solid", 
                                  colour ="black"))

fig_cd_pmatrix
#_#_#_#_#_#_#_#_#_#_#__#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_
#_#_#_#_#_#_#_#_#_#_#__#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_
#Transition probability matrix from a fully-parametric, semi-Markov multi-state model
#_#_#_#_#_#_#_#_#_#_#__#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_
```

## Transition probabilities of parametric models by treatment arm

```{r flexsurv_t_arm_3s_plot, eval=T, echo=T, paged.print=TRUE, fig.height=15, fig.width=10, fig.cap="Figure 3a. Estimate of State Occupancies (w/ confidence intervals), Three-states model", fig.align="center", error=T}

pmatrix_t_a_df_final_mod<-
data.table::data.table(pmatrix_t_a_df_final)[,-c("Trans_1_cis","Trans_2_cis","Trans_3_cis")]%>% 
    dplyr::rename("Trans_1.lo"="Trans_1_lo", "Trans_2.lo"="Trans_2_lo",
                  "Trans_3.lo"="Trans_3_lo", "Trans_1.up"="Trans_1_up",
                  "Trans_2.up"="Trans_2_up", "Trans_3.up"="Trans_3_up") %>% 
  melt(id.vars=c("t","trans")) %>% 
  dplyr::rename("trans_from"="trans") %>% 
  dplyr::mutate(variable=dplyr::case_when(!grepl("up|lo",variable)~paste0(variable,".est"),
                                          T~as.character(variable))) %>% 
  tidyr::separate(variable, c("trans_to", "cis"), "\\.") %>% #View()
  dplyr::mutate(cis=ifelse(cis=="est","estimate",cis)) %>% 
  dplyr::ungroup() %>% 
  #dplyr::group_by(t, trans_from, trans_to, cis) %>% summarise(n=n())%>% dplyr::filter(n>1)
  tidyr::pivot_wider(names_from="cis", values_from="value") %>% 
  dplyr::mutate(trans_to=factor(str_sub(trans_to, start= -1)),trans_from=factor(trans_from))

pmatrix_t_b_df_final_mod<-
data.table::data.table(pmatrix_t_b_df_final)[,-c("Trans_1_cis","Trans_2_cis","Trans_3_cis")]%>% 
    dplyr::rename("Trans_1.lo"="Trans_1_lo", "Trans_2.lo"="Trans_2_lo",
                  "Trans_3.lo"="Trans_3_lo", "Trans_1.up"="Trans_1_up",
                  "Trans_2.up"="Trans_2_up", "Trans_3.up"="Trans_3_up") %>% 
  melt(id.vars=c("t","trans")) %>% 
  dplyr::rename("trans_from"="trans") %>% 
  dplyr::mutate(variable=dplyr::case_when(!grepl("up|lo",variable)~paste0(variable,".est"),
                                          T~as.character(variable))) %>% 
  tidyr::separate(variable, c("trans_to", "cis"), "\\.") %>% #View()
  dplyr::mutate(cis=ifelse(cis=="est","estimate",cis)) %>% 
  dplyr::ungroup() %>% 
  #dplyr::group_by(t, trans_from, trans_to, cis) %>% summarise(n=n())%>% dplyr::filter(n>1)
  tidyr::pivot_wider(names_from="cis", values_from="value") %>% 
  dplyr::mutate(trans_to=factor(str_sub(trans_to, start= -1)),trans_from=factor(trans_from))

rbind.data.frame(
cbind.data.frame(pmatrix_t_a_df_final_mod,program="Women-specific"),
cbind.data.frame(pmatrix_t_b_df_final_mod,program="General population")) %>% 
  dplyr::mutate(combi=paste0(trans_from,"-",trans_to)) %>% 
  dplyr::filter(!combi %in% c("2-1","3-1","3-2","3-3")) %>% 
  dplyr::mutate(trans_from=dplyr::case_when(trans_from==1~"1)Admission",
                                            trans_from==2~"2)Therapeutic\nDischarge",
                                            trans_from==3~"3)Readmission")) %>% 
  dplyr::mutate(trans_to=dplyr::case_when(trans_to==1~"to\n1)Admission",
                                            trans_to==2~"to\n2)Therapeutic\nDischarge",
                                            trans_to==3~"to\n3)Readmission")) %>% 
  ggplot(aes(x=t, y=estimate, fill=program, color=program))+
  geom_step(size=1)+
  geom_ribbon(aes(ymin=lo, ymax=up),alpha=.3)+
  facet_wrap(.~trans_from+trans_to, ncol=3, scales="free_y") + 
  scale_fill_manual(name ="Type of program",values=c("#0D56A6","#FF9A00"), labels= c("General Population","Women-specific"))+
  scale_color_manual(name ="Type of program",values=c("#0D56A6","#FF9A00"), labels= c("General Population","Women-specific"))+
  scale_x_continuous(breaks=seq(0, 11))+
  scale_y_continuous(labels = scales::percent_format(accuracy = 2), limits=c(0,1))+
  xlab("Years") + 
  ylab("State occupancy probabilities") + 
  theme_minimal()+
  theme(legend.position=c(.9,.2),
        legend.background = element_rect(fill="white",
                                  size=0.5, linetype="solid", 
                                  colour ="black"))
```


```{r flexsurv_t_arm_4s_plot, eval=T, echo=T, paged.print=TRUE, fig.height=15, fig.width=10, fig.cap="Figure 3b. Estimate of State Occupancies (w/ confidence intervals), Four-states model", fig.align="center", error=T}

pmatrix_4s_t_a_df_final_mod<-
data.table::data.table(pmatrix_4s_t_a_df_final)[,-c("Trans_1_cis","Trans_2_cis","Trans_3_cis", "Trans_4_cis")]%>% 
    dplyr::rename("Trans_1.lo"="Trans_1_lo", "Trans_2.lo"="Trans_2_lo",
                  "Trans_3.lo"="Trans_3_lo", "Trans_4.lo"="Trans_4_lo", "Trans_1.up"="Trans_1_up",
                  "Trans_2.up"="Trans_2_up", "Trans_3.up"="Trans_3_up","Trans_4.up"="Trans_4_up") %>% 
  melt(id.vars=c("t","trans")) %>% 
  dplyr::rename("trans_from"="trans") %>% 
  dplyr::mutate(variable=dplyr::case_when(!grepl("up|lo",variable)~paste0(variable,".est"),
                                          T~as.character(variable))) %>% 
  tidyr::separate(variable, c("trans_to", "cis"), "\\.") %>% #View()
  dplyr::mutate(cis=ifelse(cis=="est","estimate",cis)) %>% 
  dplyr::ungroup() %>% 
  #dplyr::group_by(t, trans_from, trans_to, cis) %>% summarise(n=n())%>% dplyr::filter(n>1)
  tidyr::pivot_wider(names_from="cis", values_from="value") %>% 
  dplyr::mutate(trans_to=factor(str_sub(trans_to, start= -1)),trans_from=factor(trans_from))

pmatrix_4s_t_b_df_final_mod<-
data.table::data.table(pmatrix_4s_t_b_df_final)[,-c("Trans_1_cis","Trans_2_cis","Trans_3_cis", "Trans_4_cis")]%>% 
    dplyr::rename("Trans_1.lo"="Trans_1_lo", "Trans_2.lo"="Trans_2_lo",
                  "Trans_3.lo"="Trans_3_lo", "Trans_4.lo"="Trans_4_lo", "Trans_1.up"="Trans_1_up",
                  "Trans_2.up"="Trans_2_up", "Trans_3.up"="Trans_3_up","Trans_4.up"="Trans_4_up") %>% 
  melt(id.vars=c("t","trans")) %>% 
  dplyr::rename("trans_from"="trans") %>% 
  dplyr::mutate(variable=dplyr::case_when(!grepl("up|lo",variable)~paste0(variable,".est"),
                                          T~as.character(variable))) %>% 
  tidyr::separate(variable, c("trans_to", "cis"), "\\.") %>% #View()
  dplyr::mutate(cis=ifelse(cis=="est","estimate",cis)) %>% 
  dplyr::ungroup() %>% 
  #dplyr::group_by(t, trans_from, trans_to, cis) %>% summarise(n=n())%>% dplyr::filter(n>1)
  tidyr::pivot_wider(names_from="cis", values_from="value") %>% 
  dplyr::mutate(trans_to=factor(str_sub(trans_to, start= -1)),trans_from=factor(trans_from))

rbind.data.frame(
cbind.data.frame(pmatrix_4s_t_a_df_final_mod,program="Women-specific"),
cbind.data.frame(pmatrix_4s_t_b_df_final_mod,program="General population")) %>% 
  dplyr::mutate(combi=paste0(trans_from,"-",trans_to)) %>% 
  dplyr::filter(!combi %in% c("2-1","3-1","2-3","3-2","3-1","3-2","4-1","4-2","4-3","4-4")) %>% 
    dplyr::mutate(trans_from=dplyr::case_when(trans_from==1~"1)Admission",
                                            trans_from==2~"2)Therapeutic\nDischarge",
                                            trans_from==3~"3)Discharge Without\nMedical Advice",
                                            trans_from==4~"4)Readmission")) %>% 
  dplyr::mutate(trans_to=dplyr::case_when(trans_to==1~"to\n1)Admission",
                                            trans_to==2~"to\n2)Therapeutic\nDischarge",
                                            trans_to==3~"to\n3)Discharge Without\nMedical Advice",
                                            trans_to==4~"to\n4)Readmission")) %>% 
  ggplot(aes(x=t, y=estimate, fill=program, color=program))+
  geom_step(size=1)+
  geom_ribbon(aes(ymin=lo, ymax=up),alpha=.3)+
  facet_wrap(.~trans_from+trans_to, ncol=3, scales="free_y") + 
  scale_fill_manual(name ="Type of program",values=c("#0D56A6","#FF9A00"), labels= c("General Population","Women-specific"))+
  scale_color_manual(name ="Type of program",values=c("#0D56A6","#FF9A00"), labels= c("General Population","Women-specific"))+
  scale_x_continuous(breaks=seq(0, 11))+
  scale_y_continuous(labels = scales::percent_format(accuracy = 2), limits=c(0,1))+
  xlab("Years") + 
  ylab("State occupancy probabilities") + 
  theme_minimal()+
  theme(legend.position=c(.9,.2),
        legend.background = element_rect(fill="white",
                                  size=0.5, linetype="solid", 
                                  colour ="black"))
```

<br>

# Length of Stay

```{r dfs2,eval=T, echo=T, paged.print=TRUE, error=T}
tolos_t_a_str2_df<-
do.call('rbind', lapply(seq(0, 11, by = 1/12), function(t) {
    cbind.data.frame(t=t,state=1:dim(mat_3_states)[2],get(paste0("tolos_t_a_str2_",t)))
    }))
tolos_t_b_str2_df<-
do.call('rbind', lapply(seq(0, 11, by = 1/12), function(t) {
    cbind.data.frame(t=t,state=1:dim(mat_3_states)[2],get(paste0("tolos_t_b_str2_",t)))
    }))
tolos_4s_t_a_str2_df<-
do.call('rbind', lapply(seq(0, 11, by = 1/12), function(t) {
    cbind.data.frame(t=t,state=1:dim(mat_4_states)[2],get(paste0("tolos_4s_t_a_str2_",t)))
    }))
tolos_4s_t_b_str2_df<-
do.call('rbind', lapply(seq(0, 11, by = 1/12), function(t) {
    cbind.data.frame(t=t,state=1:dim(mat_4_states)[2],get(paste0("tolos_4s_t_b_str2_",t)))
    }))
tolos_4s_t_a_str3_df<-
do.call('rbind', lapply(seq(0, 11, by = 1/12), function(t) {
    cbind.data.frame(t=t,state=1:dim(mat_4_states)[2],get(paste0("tolos_4s_t_a_str3_",t)))
    }))
tolos_4s_t_b_str3_df<-
do.call('rbind', lapply(seq(0, 11, by = 1/12), function(t) {
    cbind.data.frame(t=t,state=1:dim(mat_4_states)[2],get(paste0("tolos_4s_t_b_str3_",t)))
    }))


tolos_t_a_df2<-
do.call('rbind', lapply(seq(0, 11, by = 1/12), function(t) {
    cbind.data.frame(t= t, state=1:dim(mat_3_states)[2],get(paste0("tolos_t_a_",t)))
    }))
tolos_t_b_df2<-
do.call('rbind', lapply(seq(0, 11, by = 1/12), function(t) {
    cbind.data.frame(t= t, state=1:dim(mat_3_states)[2],get(paste0("tolos_t_b_",t)))
    }))
tolos_4s_t_a_df2<-
do.call('rbind', lapply(seq(0, 11, by = 1/12), function(t) {
    cbind.data.frame(t= t, state=1:dim(mat_4_states)[2],get(paste0("tolos_4s_t_a_",t)))
    }))
tolos_4s_t_b_df2<-
do.call('rbind', lapply(seq(0, 11, by = 1/12), function(t) {
    cbind.data.frame(t= t, state=1:dim(mat_4_states)[2],get(paste0("tolos_4s_t_b_",t)))
    }))
```


```{r flexsurv_t_arm_3s_plot1, eval=T, echo=T, paged.print=TRUE, fig.height=10, fig.cap="Figure 4a. Estimate of Length of Stay (w/ confidence intervals), Three-states model", fig.align="center", error=T}
rbind.data.frame(
cbind.data.frame(tolos_t_a_df2,program="Women-specific"),
cbind.data.frame(tolos_t_b_df2,program="General Population")
) %>% 
        dplyr::mutate(state=dplyr::case_when(state==1~"to\n1)Admission",
                                      state==2~"to\n2)Therapeutic\nDischarge",
                                      state==3~"to\n3)Readmission"))%>%
  ggplot(aes(x=t, y=est, color=program, fill=program))+
    geom_step(size=1)+
  geom_ribbon(aes(ymin=L, ymax=U),alpha=.3)+
  facet_wrap(.~state, ncol=3, scales="free_y") + 
  scale_fill_manual(name ="Type of program",values=c("#0D56A6","#FF9A00"), labels= c("General Population","Women-specific"))+
  scale_color_manual(name ="Type of program",values=c("#0D56A6","#FF9A00"), labels= c("General Population","Women-specific"))+
  scale_x_continuous(breaks=seq(0, 11))+
 #scale_y_continuous(labels = scales::percent_format(accuracy = 2), limits=c(0,1))+
  xlab("Years") + 
  #ylab("State occupancy probabilities") + 
  theme_minimal()+
  theme(legend.position=c(.9,.1),
        legend.background = element_rect(fill="white",
                                  size=0.5, linetype="solid", 
                                  colour ="black"))
  
```


```{r flexsurv_t_arm_3s_plot2, eval=T, echo=T, paged.print=TRUE, fig.height=10, fig.cap="Figure 4b. Estimate of Length of Stay (w/ confidence intervals), Three-states model (start from Therapeutic\nDischarge)", fig.align="center", error=T}
rbind.data.frame(
cbind.data.frame(tolos_t_a_str2_df,program="Women-specific", start=2),
cbind.data.frame(tolos_t_b_str2_df,program="General Population", start=2)
) %>% 
      dplyr::mutate(state=dplyr::case_when(state==1~"to\n1)Admission",
                                      state==2~"to\n2)Therapeutic\nDischarge",
                                      state==3~"to\n3)Readmission"))%>%
  dplyr::filter(state!="to\n1)Admission") %>% 
  ggplot(aes(x=t, y=est, color=program, fill=program))+
    geom_step(size=1)+
  geom_ribbon(aes(ymin=L, ymax=U),alpha=.3)+
  facet_wrap(.~state, ncol=3, scales="free_y") + 
  scale_fill_manual(name ="Type of program",values=c("#0D56A6","#FF9A00"), labels= c("General Population","Women-specific"))+
  scale_color_manual(name ="Type of program",values=c("#0D56A6","#FF9A00"), labels= c("General Population","Women-specific"))+
  scale_x_continuous(breaks=seq(0, 11))+
 #scale_y_continuous(labels = scales::percent_format(accuracy = 2), limits=c(0,1))+
  xlab("Years") + 
  #ylab("State occupancy probabilities") + 
  theme_minimal()+
  theme(legend.position=c(.9,.1),
        legend.background = element_rect(fill="white",
                                  size=0.5, linetype="solid", 
                                  colour ="black"))
  
```

```{r flexsurv_t_arm_4s_plot1, eval=T, echo=T, paged.print=TRUE, fig.height=15, fig.width=10, fig.cap="Figure 5a. Estimate of Length of Stay (w/ confidence intervals), Four-states model", fig.align="center", error=T}
rbind.data.frame(
cbind.data.frame(tolos_4s_t_a_df2,program="Women-specific"),
cbind.data.frame(tolos_4s_t_b_df2,program="General Population")
)%>% 
    dplyr::mutate(state=dplyr::case_when(state==1~"to\n1)Admission",
                                      state==2~"to\n2)Therapeutic\nDischarge",
                                      state==3~"to\n3)Discharge Without\nMedical Advice",
                                      T~"to\n4)Readmission"))%>%
  ggplot(aes(x=t, y=est, color=program, fill=program))+
    geom_step(size=1)+
  geom_ribbon(aes(ymin=L, ymax=U),alpha=.3)+
  facet_wrap(.~state, ncol=2, scales="free_y") + 
  scale_fill_manual(name ="Type of program",values=c("#0D56A6","#FF9A00"), labels= c("General Population","Women-specific"))+
  scale_color_manual(name ="Type of program",values=c("#0D56A6","#FF9A00"), labels= c("General Population","Women-specific"))+
  scale_x_continuous(breaks=seq(0, 11))+
 #scale_y_continuous(labels = scales::percent_format(accuracy = 2), limits=c(0,1))+
  xlab("Years") + 
  #ylab("State occupancy probabilities") + 
  theme_minimal()+
  theme(legend.position=c(.9,.1),
        legend.background = element_rect(fill="white",
                                  size=0.5, linetype="solid", 
                                  colour ="black"))
```


```{r flexsurv_t_arm_4s_plot2, eval=T, echo=T, paged.print=TRUE, fig.height=15, fig.width=10, fig.cap="Figure 5b. Estimate of Length of Stay (w/ confidence intervals), Four-states model", fig.align="center", error=T}
rbind.data.frame(
cbind.data.frame(tolos_4s_t_a_str2_df,program="Women-specific", start=2),
cbind.data.frame(tolos_4s_t_b_str2_df,program="General Population", start=2),
cbind.data.frame(tolos_4s_t_a_str3_df,program="Women-specific", start=3),
cbind.data.frame(tolos_4s_t_b_str3_df,program="General Population", start=3))%>% 
  dplyr::mutate(comb=dplyr::case_when(start==2 & state==1~"a",
                                      start==2 & state==3~"a",
                                      start==3 & state==1~"a",
                                      start==3 & state==2~"a",
                                      T~NA_character_)) %>% 
  dplyr::mutate(start=dplyr::case_when(start==2~"2)Therapeutic\nDischarge",start==3~"3)Discharge Without\nMedical Advice",T~NA_character_))%>%
  dplyr::mutate(state=dplyr::case_when(state==1~"to\n1)Admission",
                                      state==2~"to\n2)Therapeutic\nDischarge",
                                      state==3~"to\n3)Discharge Without\nMedical Advice",
                                      T~"to\n4)Readmission"))%>%
  dplyr::filter(is.na(comb)) %>% 
  #dplyr::filter(est==0) %>% 
  ggplot(aes(x=t, y=est, color=program, fill=program))+
    geom_step(size=1)+
  geom_ribbon(aes(ymin=L, ymax=U),alpha=.3)+
  facet_wrap(start~state, ncol=2, nrow=2, scales="free_y") + 
  scale_fill_manual(name ="Type of program",values=c("#0D56A6","#FF9A00"), labels= c("General Population","Women-specific"))+
  scale_color_manual(name ="Type of program",values=c("#0D56A6","#FF9A00"), labels= c("General Population","Women-specific"))+
  scale_x_continuous(breaks=seq(0, 11))+
 #scale_y_continuous(labels = scales::percent_format(accuracy = 2), limits=c(0,1))+
  xlab("Years") + 
  #ylab("State occupancy probabilities") + 
  theme_minimal()+
  theme(legend.position=c(.9,.1),
        legend.background = element_rect(fill="white",
                                  size=0.5, linetype="solid", 
                                  colour ="black"))
```

<br>

# Cumulative Transition Hazards of Joint Models

Cumulative baseline hazard can be estimated non-parametrically through a Breslow estimator. Must take note that we are assuming a Markov process in these transitions.

<br>

```{r mstate_hazards_cis,eval=F, echo=T, paged.print=TRUE, error=T}
#extended Markov renewal model
#http://www.math.leidenuniv.nl/scripties/MasterXinruLi.pdf
#MUCHAS FUNCIONES
#describir al paciente simulado
# especificar el tiempo para la probabilidad

#The focus of this thesis is to address the violation of the Markov or Markov renewal
#assumption in applications of multi-state models. Two statistical methods were
#proposed. The first method was to include transition times as extra covariates

#The function msboot() samples randomly with replacement subjects from the
#original data set and can be used to estimate any vector-valued statistic in a
#multi-state model. It can be combined together with mssample() to implement
#the Algorithm 4.3.2. Here below it is shown how to obtain prediction probabilities
#and confident interval for patient B (tumor size >5 cm, positive lymph node status, mastectomy plus radiotherapy, no perioperative #chemotherapy, no adjuvant
#chemotherapy, age≤ 50 years) at t = 6 years post-surgery by using the functions
#predict(), mssample() , and msboot():
tmat <- trans.illdeath()#specify the transition matrix
M=100# simulation number
tvec=6 #time point
history<-list(state=1,time=0,tstates=c(0,0,0)) #specify the patient's history
theta<-function(data){
  dat<-data[,-c(1:3,6,9:15)]
  fit<-coxph(Surv(time,status)~.-trans+strata(trans), dat)
  Haz<-haz(fit,newdata)
  bt<-summary(fit)$coef[,1]["Tstart"]
  beta.state<-matrix(0,3,3)
  beta.state[1,2]<-bt
  res<-mssample(Haz,trans=tmat,clock="reset",
  history=history,beta.state=beta.state,tvec=tvec,M=M)
  c(as.matrix(res[,-1]))
}
res<-msboot(theta,bc.long,B=500,id="id") #generate bootstrap samples
predB<-predict(fit,newdata,t=0,bt="Tstart")
estimate<-prob.predict(t=6,predB$probs)
LCI<-apply(res,1,function(x)quantile(x,probs=0.025))
UCI<-apply(res,1,function(x)quantile(x,probs=0.975))
print(CI<-cbind(LCI,estimate,UCI),digits=2)


# bootstrap ampling by msboot
re <- msboot (theta, bc.long , B=500, id ="id")
# confidence intervals for prediction
LCI <- apply (res , 1 , function(x) quantile(x,probs=.025))
UCI <- apply (res, 1 , function(x) quantile(x,probs=.975))
CI <- cbind (LCI , UCI )

invisible(c("LMAJ"))

```

<br>

# Simulate Final State

We estimated the probability to end in the readmission state, median of stay, percentiles 25, 75 and confidence intervals based on `r n_iter/20` resamples, by simulating a large sample of individuals from the model depending on the type of program they were admitted at baseline.

```{r sim_medians, eval=T, echo=T, paged.print=TRUE, error=T}
time_before_sim_medians_10y<-Sys.time()
#Estimates the probability of each final outcome ("absorbing" state), and the mean and quantiles of the time to that outcome for people who experience it, by simulating a large sample of individuals from the model. This can be used for both Markov and semi-Markov models.
#n_iter=12
fmsm_sel_param_fits_4s_b<-
    fmsm(fits_c_gomp2[[1]],fits_c_gomp2[[2]],fits_c_logn2[[3]],fits_c_ggam2[[4]],fits_c_logn2[[5]], trans=mat_4_states)

fmsm_sel_param_fits_b<-
    fmsm(fits_c_gomp[[1]],fits_c_genf[[2]],fits_c_ggam[[3]], trans=mat_3_states)

  set.seed(1234)
simfinal_fmsm_3_st_10y<-
simfinal_fmsm(fmsm_sel_param_fits_b, #Object returned by fmsm, representing a multi-state model formed from transition-specific time-to-event models fitted by flexsurvreg.
              newdata = rbind.data.frame(newdat3a[1,],newdat3b[1,])[,-"strata"], #Data frame of covariate values, with one column per covariate, and one row per alternative value.
              t= 10, #itempo máximo al que simular, de manera que el resumen se toman de la muestra de individuos en los datos simulados quienes están en el estado absorvente a ese tiempo.
              probs = c(0.025,0.25, 0.5, 0.75,0.975), 
              M=10000000, #necesita grandes números
              B=n_iter/20, #Pondría 1,000
              cores=8
              )
  set.seed(1234)
simfinal_fmsm_3_st_.3y<-
simfinal_fmsm(fmsm_sel_param_fits_b, #Object returned by fmsm, representing a multi-state model formed from transition-specific time-to-event models fitted by flexsurvreg.
              newdata = rbind.data.frame(newdat3a[1,],newdat3b[1,])[,-"strata"], #Data frame of covariate values, with one column per covariate, and one row per alternative value.
              t= .3, #itempo máximo al que simular, de manera que el resumen se toman de la muestra de individuos en los datos simulados quienes están en el estado absorvente a ese tiempo.
              probs = c(0.025,0.25, 0.5, 0.75,0.975), 
              #M=100000, #necesita grandes números
              B=n_iter/20, #Pondría 1,000
              cores=8
              ) 
  set.seed(1234)
simfinal_fmsm_3_st_1y<-
simfinal_fmsm(fmsm_sel_param_fits_b, #Object returned by fmsm, representing a multi-state model formed from transition-specific time-to-event models fitted by flexsurvreg.
              newdata = rbind.data.frame(newdat3a[1,],newdat3b[1,])[,-"strata"], #Data frame of covariate values, with one column per covariate, and one row per alternative value.
              t= 1, #itempo máximo al que simular, de manera que el resumen se toman de la muestra de individuos en los datos simulados quienes están en el estado absorvente a ese tiempo.
              probs = c(0.025,0.25, 0.5, 0.75,0.975), 
              #M=100000, #necesita grandes números
              B=n_iter/20, #Pondría 1,000
              cores=8
              )  
  set.seed(1234)
simfinal_fmsm_3_st_3y<-
simfinal_fmsm(fmsm_sel_param_fits_b, #Object returned by fmsm, representing a multi-state model formed from transition-specific time-to-event models fitted by flexsurvreg.
              newdata = rbind.data.frame(newdat3a[1,],newdat3b[1,])[,-"strata"], #Data frame of covariate values, with one column per covariate, and one row per alternative value.
              t= 3, #itempo máximo al que simular, de manera que el resumen se toman de la muestra de individuos en los datos simulados quienes están en el estado absorvente a ese tiempo.
              probs = c(0.025,0.25, 0.5, 0.75,0.975), 
              #M=100000, #necesita grandes números
              B=n_iter/20, #Pondría 1,000
              cores=8
              )  



  set.seed(1234)
simfinal_fmsm_4_st_10y<-
simfinal_fmsm(fmsm_sel_param_fits_4s_b, #Object returned by fmsm, representing a multi-state model formed from transition-specific time-to-event models fitted by flexsurvreg.
              newdata = rbind.data.frame(newdat5a[1,],newdat5b[1,])[,-"strata"], #Data frame of covariate values, with one column per covariate, and one row per alternative value.
              t= 10, #itempo máximo al que simular, de manera que el resumen se toman de la muestra de individuos en los datos simulados quienes están en el estado absorvente a ese tiempo.
              probs = c(0.025,0.25, 0.5, 0.75,0.975), 
              #M=100000, #necesita grandes números
              B=n_iter/20, #Pondría 1,000
              cores=8
              )
  set.seed(1234)
simfinal_fmsm_4_st_.3y<-
simfinal_fmsm(fmsm_sel_param_fits_4s_b, #Object returned by fmsm, representing a multi-state model formed from transition-specific time-to-event models fitted by flexsurvreg.
              newdata = rbind.data.frame(newdat5a[1,],newdat5b[1,])[,-"strata"], #Data frame of covariate values, with one column per covariate, and one row per alternative value.
              t= .3, #itempo máximo al que simular, de manera que el resumen se toman de la muestra de individuos en los datos simulados quienes están en el estado absorvente a ese tiempo.
              probs = c(0.025,0.25, 0.5, 0.75,0.975), 
              #M=100000, #necesita grandes números
              B=n_iter/20, #Pondría 1,000
              cores=8
              )
  set.seed(1234)
simfinal_fmsm_4_st_1y<-
simfinal_fmsm(fmsm_sel_param_fits_4s_b, #Object returned by fmsm, representing a multi-state model formed from transition-specific time-to-event models fitted by flexsurvreg.
              newdata = rbind.data.frame(newdat5a[1,],newdat5b[1,])[,-"strata"], #Data frame of covariate values, with one column per covariate, and one row per alternative value.
              t= 1, #itempo máximo al que simular, de manera que el resumen se toman de la muestra de individuos en los datos simulados quienes están en el estado absorvente a ese tiempo.
              probs = c(0.025,0.25, 0.5, 0.75,0.975), 
              #M=100000, #necesita grandes números
              B=n_iter/20, #Pondría 1,000
              cores=8
              )
simfinal_fmsm_4_st_3y<-
simfinal_fmsm(fmsm_sel_param_fits_4s_b, #Object returned by fmsm, representing a multi-state model formed from transition-specific time-to-event models fitted by flexsurvreg.
              newdata = rbind.data.frame(newdat5a[1,],newdat5b[1,])[,-"strata"], #Data frame of covariate values, with one column per covariate, and one row per alternative value.
              t= 3, #itempo máximo al que simular, de manera que el resumen se toman de la muestra de individuos en los datos simulados quienes están en el estado absorvente a ese tiempo.
              probs = c(0.025,0.25, 0.5, 0.75,0.975), 
              #M=100000, #necesita grandes números
              B=n_iter/20, #Pondría 1,000
              cores=8
              )
time_after_sim_medians_10y<-Sys.time()

paste0("Time in process: ");time_after_sim_medians_10y-time_before_sim_medians_10y

# probability of each final outcome
# mean and quantiles of the time to that outcome for people who experience it
```
```{r sim_medians_df, eval=T, echo=T, paged.print=TRUE, error=T}
simfinal_fmsm_3_st_df<-        
rbind.data.frame(
simfinal_fmsm_3_st_.3y%>%dplyr::select("tipo_de_programa_2","quantity","val","lower","upper")%>%mutate(year=.3),
simfinal_fmsm_3_st_1y%>%dplyr::select("tipo_de_programa_2","quantity","val","lower","upper")%>%mutate(year=1),
simfinal_fmsm_3_st_3y%>%dplyr::select("tipo_de_programa_2","quantity","val","lower","upper")%>%mutate(year=3),
simfinal_fmsm_3_st_10y%>%dplyr::select("tipo_de_programa_2","quantity","val","lower","upper")%>%mutate(year=10))

simfinal_fmsm_4_st_df<-
rbind.data.frame(
simfinal_fmsm_4_st_.3y%>%dplyr::select("tipo_de_programa_2","quantity","val","lower","upper")%>%mutate(year=.3),
simfinal_fmsm_4_st_1y%>%dplyr::select("tipo_de_programa_2","quantity","val","lower","upper")%>%mutate(year=1),
simfinal_fmsm_4_st_3y%>%dplyr::select("tipo_de_programa_2","quantity","val","lower","upper")%>%mutate(year=3),
simfinal_fmsm_4_st_10y%>%dplyr::select("tipo_de_programa_2","quantity","val","lower","upper")%>%mutate(year=10))
```

```{r sim_final_plot1, eval=T, echo=T, paged.print=TRUE, fig.height=10, fig.cap="Figure 6a. Time to Readmission for Users who Experience it (Mean and 95%CIs), Three-states model", fig.align="center", error=T}
#time to that outcome for people who experience
#itempo máximo al que simular, de manera que el resumen se toman de la muestra de individuos en los datos simulados quienes están en el estado absorvente a ese tiempo.
simfinal_fmsm_3_st_df %>%
  dplyr::mutate(year=factor(year,levels=c(.3, 1, 3, 10))) %>% 
  dplyr::group_by(year, tipo_de_programa_2) %>% 
  summarise(mean=sum(val[quantity=="mean"],na.rm=T),
            lo=sum(lower[quantity=="2.5%"],na.rm=T),
            up=sum(upper[quantity=="97.5%"],na.rm=T)) %>% 
  ggplot(aes(x=year, y=mean, color=tipo_de_programa_2))+
  geom_bar(aes(x=year, y=mean, color=tipo_de_programa_2, fill=tipo_de_programa_2), position="dodge", stat="identity", alpha=0.4)+
  sjPlot::theme_sjplot2()+
  geom_errorbar(aes(x=year, ymin=lo, ymax=up, color=tipo_de_programa_2), position="dodge", stat="identity", width=0.4,  alpha=0.9, size=1.3)+
  ylim(0,11)+
  ylab("Time to event")+
  scale_color_manual(name ="Type of program",values=c("#FF6400","#00A383"), labels= c("Women-specific","General Population"))+
  scale_fill_manual(name ="Type of program",values=c("#FF6400","#00A383"), labels= c("Women-specific","General Population"))+
    xlab("Maximum time of simualted individuals in the absorbing state (in years)")
```

```{r sim_final_plot2, eval=T, echo=T, paged.print=TRUE, fig.height=10, fig.cap="Figure 6b. Time to Readmission for Users who Experience it (Mean and 95%CIs), Four-states model", fig.align="center", error=T}
simfinal_fmsm_4_st_df %>%
  dplyr::mutate(year=factor(year,levels=c(.3, 1, 3, 10))) %>% 
  dplyr::group_by(year, tipo_de_programa_2) %>% 
  summarise(mean=sum(val[quantity=="mean"],na.rm=T),
            lo=sum(lower[quantity=="2.5%"],na.rm=T),
            up=sum(upper[quantity=="97.5%"],na.rm=T)) %>% 
  ggplot(aes(x=year, y=mean, color=tipo_de_programa_2))+
  geom_bar(aes(x=year, y=mean, color=tipo_de_programa_2, fill=tipo_de_programa_2), position="dodge", stat="identity", alpha=0.4)+
  sjPlot::theme_sjplot2()+
  geom_errorbar(aes(x=year, ymin=lo, ymax=up, color=tipo_de_programa_2), position="dodge", stat="identity", width=0.4,  alpha=0.9, size=1)+
  ylim(0,11)+
  ylab("Time to event")+
  scale_color_manual(name ="Type of program",values=c("#FF6400","#00A383"), labels= c("Women-specific","General Population"))+
  scale_fill_manual(name ="Type of program",values=c("#FF6400","#00A383"), labels= c("Women-specific","General Population"))+
  xlab("Maximum time of simualted individuals in the absorbing state (in years)")
```

<br>


```{r LMAJ, eval=T, echo=T, paged.print=TRUE, fig.height=15, fig.width=10, fig.cap="Figure 1b. Estimate of Cumulative Hazards, Four States Model", fig.align="center", error=T}
#https://www.rdocumentation.org/packages/mstate/versions/0.3.1/topics/xsect
#https://rdrr.io/cran/mstate/man/LMAJ.html
#This function implements the landmark Aalen-Johansen method of Putter & Spitoni (2016) for non-parametric estimation of transition probabilities in non-Markov models.

LMAJ_ms_CONS_C1_SEP_2020_women_imputed_exp<-ms_CONS_C1_SEP_2020_women_imputed_exp
LMAJ_ms2_CONS_C1_SEP_2020_women_imputed_exp<-ms2_CONS_C1_SEP_2020_women_imputed_exp

LMAJ_ms_CONS_C1_SEP_2020_women_imputed_exp$id<-LMAJ_ms_CONS_C1_SEP_2020_women_imputed_exp$row
LMAJ_ms2_CONS_C1_SEP_2020_women_imputed_exp$id<-LMAJ_ms2_CONS_C1_SEP_2020_women_imputed_exp$row

sub_3s_gp <- subset(LMAJ_ms_CONS_C1_SEP_2020_women_imputed_exp, tipo_de_programa_2==0)
sub_3s_ws <- subset(LMAJ_ms_CONS_C1_SEP_2020_women_imputed_exp, tipo_de_programa_2==1)

LMAJ_3s_gp<-LMAJ(LMAJ_ms_CONS_C1_SEP_2020_women_imputed_exp, 5, 2)
LMAJ_3s_ws<-LMAJ(LMAJ_ms_CONS_C1_SEP_2020_women_imputed_exp, 5, 2)#, method = "greenwood"
#msdata=	An "msdata" object, as for instance prepared by link{msprep}
#s= The prediction time point s from which transition probabilities are to be obtained
#from=	 Either a single state or a set of states in the state space 1,...,S
#method= The method for calculating variances, as in probtrans  c("aalen", "greenwood")

if(no_mostrar==1){
          msdata=LMAJ_ms_CONS_C1_SEP_2020_women_imputed_exp
          #aprendí que el msdata debe tener como título id, no row como lo puse aquí
          msdata$id<-msdata$row
          s=5
          from=2
          method="aalen"
                
      LMAJ <- function(msdata, s, from, method=c("aalen", "greenwood")){
        tmat <- attr(msdata, "trans")
        if (is.null(tmat)) stop("msdata object should have a \"trans\" attribute")
        K <- nrow(tmat)
        if (any(is.na(match(from, 1:K)))) stop("from should be subset of 1:K with K number of states")
        xss <- xsect(msdata, s)
        infrom <- xss$id[xss$state %in% from]
        msdatas <- cutLMms(msdata, LM=s)
        msdatasfrom <- msdatas[msdatas$id %in% infrom, ]
        c0 <- coxph(Surv(Tstart, Tstop, status) ~ strata(trans), data=msdatasfrom)
        msf0 <- msfit(c0, trans=tmat)
        pt0 <- probtrans(msf0, predt=s, method=method)[from]
        #sólo funciona cuando tiro s=1, pero da ese error:
        #Warning message:
        #In max(stackvarhaz$time[stackvarhaz$time <= predt]) :
        #ningun argumento finito para max; retornando -Inf
        if (length(from) == 1)
          #si parte en 1, entonces ve la probabilidad de transición a la base
          return(pt0[[1]])
        else {
          xsss <- xss[xss$state %in% from, ]
          xsss$state <- factor(xsss$state, levels=from)
          tbl <- table(xsss$state)
          p <- tbl / sum(tbl)
          varp <- (diag(p) - p %*% t(p)) / sum(tbl)
          # Relying on fact that all items from list have exactly the same size and structure
          # and that the sum of p equals 1; sorry for the double for-loop
          res <- tmp1 <- tmp2 <- 0
          for (j in 1:length(from)) {
            ptj <- pt0[[j]]
            res <- res + p[j] * ptj[, 1 + (1:K)]
            tmp2 <- tmp2 + p[j] * (1 - p[j]) * (ptj[, K+1 + (1:K)])^2
            for (k in 1:length(from)) {
              ptk <- pt0[[k]]
              tmp1 <- tmp1 + varp[j,k] * ptj[, 1 + (1:K)] * ptk[, 1 + (1:K)]
            }
          }
          ses <- sqrt(tmp1 + tmp2)
          # take ptj as template and insert estimates and SE's
          pt <- ptj
          pt[, 1 + (1:K)] <- res
          pt[, K+1 + (1:K)] <- ses
          return(pt)
          }
        }
}
```


# Session Info

```{r session_info, echo=T, paged.print=TRUE}
Sys.getenv("R_LIBS_USER")
rstudioapi::getSourceEditorContext()
#save.image("G:/Mi unidad/Alvacast/SISTRAT 2019 (github)/mult_state_carla.RData")

if (grepl("CISS Fondecyt",rstudioapi::getSourceEditorContext()$path)==T){
    save.image("C:/Users/CISS Fondecyt/OneDrive/Escritorio/SUD_CL/mult_state_carla_3.RData")
  } else if (grepl("andre",rstudioapi::getSourceEditorContext()$path)==T){
    save.image("C:/Users/andre/Desktop/SUD_CL/mult_state_carla_3.RData")
  } else if (grepl("E:",rstudioapi::getSourceEditorContext()$path)==T){
    save.image("E:/Mi unidad/Alvacast/SISTRAT 2019 (github)/mult_state_carla_3.RData")
  } else {
    save.image("G:/Mi unidad/Alvacast/SISTRAT 2019 (github)/mult_state_carla_3.RData")
  }

sessionInfo()
```
