---
title: "Ambulatory or residential? a multi-state analysis of treatments for substance use disorders (Step 5)"
date: "`r withr::with_locale(new = c('LC_TIME' = 'C'), code =format(Sys.time(),'%B %d, %Y'))`"
output:
  html_document:
    code_folding: hide  
    toc: true # table of content true
    toc_depth: 5  # upto three depths of headings (specified by #, ## and ###)
    toc_float: true
---


```{css zoom-lib-src, echo = FALSE}
script src = "https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"
```

```{js zoom-jquery, echo = FALSE}
 $(document).ready(function() {
    $('body').prepend('<div class=\"zoomDiv\"><img src=\"\" class=\"zoomImg\"></div>');
    // onClick function for all plots (img's)
    $('img:not(.zoomImg)').click(function() {
      $('.zoomImg').attr('src', $(this).attr('src')).css({width: '100%'});
      $('.zoomDiv').css({opacity: '1', width: 'auto', border: '1px solid white', borderRadius: '5px', position: 'fixed', top: '50%', left: '50%', marginRight: '-50%', transform: 'translate(-50%, -50%)', boxShadow: '0px 0px 50px #888888', zIndex: '50', overflow: 'auto', maxHeight: '100%'});
    });
    // onClick function for zoomImg
    $('img.zoomImg').click(function() {
      $('.zoomDiv').css({opacity: '0', width: '0%'}); 
    });
  });
```

```{=html}
<style type="text/css">
.tablelines table, .tablelines td, .tablelines th {
        border: 1px solid black;
        }
.centrado {
    text-align: center;
}
.table.center {
    margin-left:auto; 
    margin-right:auto;
  }
.table_wrapper{
    display: block;
    overflow-x: auto;
    white-space: nowrap;
}
code.r{
  font-size: 8px;
}
body{ /* Normal  */
      text-align: justify;
  }
.superbigimage{
    overflow-y:scroll;
    white-space: nowrap;
}
.superbigimage img{
    overflow-y: scroll;
    overflow-x: hidden;
}
</style>
```
```{=html}
<style>
div.blue { background-color:#e6f0ff; border-radius: 5px; padding: 20px; text-align: justify;}
</style>
```
```{r prev_setup, include = FALSE, cache=T}
rm(list=ls());gc()
if(!grepl("4.0.2",R.version.string)){stop("Different version (must be 4.0.2)")}
path<-rstudioapi::getSourceEditorContext()$path

if (grepl("CISS Fondecyt",path)==T){
  setwd("C:/Users/CISS Fondecyt/Mi unidad/Alvacast/SISTRAT 2019 (github)/SUD_CL/");load("C:/Users/CISS Fondecyt/Mi unidad/Alvacast/SISTRAT 2019 (github)/mult_state_3_apr22.RData")
} else if (grepl("andre",path)==T){
  setwd('C:/Users/andre/Desktop/SUD_CL/');load("E:/Mi unidad/Alvacast/SISTRAT 2019 (github)/mult_state_3_apr22.RData")
} else if (grepl("E:",path)==T){
  setwd("E:/Mi unidad/Alvacast/SISTRAT 2019 (github)/SUD_CL/");load("E:/Mi unidad/Alvacast/SISTRAT 2019 (github)/mult_state_3_apr22.RData")
} else {
  setwd("G:/Mi unidad/Alvacast/SISTRAT 2019 (github)/SUD_CL/");load("G:/Mi unidad/Alvacast/SISTRAT 2019 (github)/mult_state_3_apr22.RData")
}
```

```{r setup, include = FALSE, cache=T}
#Libraries used in the routine. Dont change the order
local({r <- getOption("repos")
       r["CRAN"] <- "https://cran.dcc.uchile.cl/" 
       options(repos=r)
})
pacman::p_unlock(lib.loc = .libPaths()) #para no tener problemas reinstalando paquetes

copiar_nombres <- function(x,row.names=FALSE,col.names=TRUE,dec=",",...) {
  if(class(ungroup(x))[1]=="tbl_df"){
        if(options()$OutDec=="."){
            options(OutDec = dec)
            write.table(format(data.frame(x)),"clipboard",sep="\t",row.names=FALSE,col.names=col.names,...)
            options(OutDec = ".")
          return(x)
        } else {
            options(OutDec = ",")
            write.table(format(data.frame(x)),"clipboard",sep="\t",row.names=FALSE,col.names=col.names,...)
            options(OutDec = ",")
          return(x)    
        }
  } else {
        if(options()$OutDec=="."){
            options(OutDec = dec)
            write.table(format(x),"clipboard",sep="\t",row.names=FALSE,col.names=col.names,...)
            options(OutDec = ".")
          return(x)
        } else {
            options(OutDec = ",")
            write.table(format(x),"clipboard",sep="\t",row.names=FALSE,col.names=col.names,...)
            options(OutDec = ",")
          return(x)       
  }
 }
}  

library(knitr)
library(stringi)
library(stringr)
library(ggplot2)
library(Hmisc)
library(kableExtra)
library(plotly)
library(janitor)
library(rbokeh)
library(broom)
library(sqldf)
library(devtools)
library(data.table)
library(RColorBrewer)
suppressPackageStartupMessages(library(ggiraph))
suppressPackageStartupMessages(library(sf))
library(tidyverse)
library(epiR)
library(survminer)
library(ggfortify)
library(survMisc)

library(foreign)
library(gridExtra)
library(reshape2)
library(igraph)

#library(WeightedCluster)
library(cluster)
library(parcats)#- necesito y no lo tiene 2022-05-24
library(easyalluvial)
library(timereg)#- necesito y no lo tiene

library(htmltools)
library(rsvg)#- necesito y no lo tiene
library(DiagrammeR)
library(DiagrammeRsvg)#- necesito y no lo tiene
library(EValue)#- necesito y no lo tiene
library(coxphw)#- necesito y no lo tiene
library(data.tree)

#pacman::p_load(parcats, timereg, rsvg, DiagrammeRsvg, EValue, coxphw, install=T)
#install.packages("EValue", dependencies=F) - I ended install it w/o dependencies

#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:
#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:


try_with_time_limit <- function(expr, cpu = Inf, elapsed = Inf)
{
  y <- try({setTimeLimit(cpu, elapsed); expr}, silent = TRUE) 
  if(inherits(y, "try-error")) NULL else y 
}
eval_fork <- function(..., timeout=60){

  #this limit must always be higher than the timeout on the fork!
  setTimeLimit(timeout+5);      

  #dispatch based on method
  ##NOTE!!!!! Due to a bug in mcparallel, we cannot use silent=TRUE for now.
  myfork <- parallel::mcparallel({
    eval(...)
  }, silent=FALSE);

  #wait max n seconds for a result.
  myresult <- parallel::mccollect(myfork, wait=FALSE, timeout=timeout);

  #try to avoid bug/race condition where mccollect returns null without waiting full timeout.
  #see https://github.com/jeroenooms/opencpu/issues/131
  #waits for max another 2 seconds if proc looks dead 
  while(is.null(myresult) && totaltime < timeout && totaltime < 2) {
     Sys.sleep(.1)
     enddtime <- Sys.time();
     totaltime <- as.numeric(enddtime - starttime, units="secs")
     myresult <- parallel::mccollect(myfork, wait = FALSE, timeout = timeout);
  }

  #kill fork after collect has returned
  tools::pskill(myfork$pid, tools::SIGKILL);    
  tools::pskill(-1 * myfork$pid, tools::SIGKILL);  

  #clean up:
  parallel::mccollect(myfork, wait=FALSE);

  #timeout?
  if(is.null(myresult)){
    stop("R call did not return within ", timeout, " seconds. Terminating process.", call.=FALSE);      
  }

  #move this to distinguish between timeout and NULL returns
  myresult <- myresult[[1]];

  #reset timer
  setTimeLimit();     

  #forks don't throw errors themselves
  if(inherits(myresult,"try-error")){
    #stop(myresult, call.=FALSE);
    stop(attr(myresult, "condition"));
  }

  #send the buffered response
  return(myresult);  
}

#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:
#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:

knitr::knit_hooks$set(time_it = local({
  now <- NULL
  function(before, options) {
    if (before) {
      # record the current time before each chunk
      now <<- Sys.time()
    } else {
      # calculate the time difference after a chunk
      res <- ifelse(difftime(Sys.time(), now)>(60^2),difftime(Sys.time(), now)/(60^2),difftime(Sys.time(), now)/(60^1))
      # return a character string to show the time
      warning(ifelse(difftime(Sys.time(), now)>(60^2),paste("Time for this code chunk to run:", round(res,1), "hours"),paste("Time for this code chunk to run:", round(res,1), "minutes")))
    }
  }
}))

knitr::opts_chunk$set(time_it = TRUE)
#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:
#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:

if(.Platform$OS.type == "windows") withAutoprint({
  memory.size()
  memory.size(TRUE)
  memory.limit()
})
memory.limit(size=56000)
```

<br>


We set the data in different formats. We stratified the data depending on paient's baseline treatment completion status.

<br>

```{r set-database, include=T,warning=F, message=F, results="hide"}
#https://stackoverflow.com/questions/21964078/how-to-eliminate-na-nan-inf-in-foreign-function-call-arg-7-running-predict-w
#https://www.statology.org/error-in-do_onenmeth-na-nan-inf-in-foreign-function-call/

dt_ms_d_match_surv<-dplyr::mutate(ms_d_match_surv,id=as.numeric(id)) %>% 
  data.table()
#see example
#DT::datatable(subset(dt_ms_d_match_surv2, id %in% c(52,32,20521,21869), c("id","time", "trans","tipo_de_plan_res_1","TD_1", "TD_2", "TD_3","DWCA_1", "DWCA_2", "DWCA_3")))

dt_ms_d_match_surv_oct_2022_a<-dplyr::mutate(ms_d_match_surv_oct_2022,id=as.numeric(id))%>% 
  dplyr::mutate(cond= dplyr::case_when(trans==1 & status==1~"1", trans==2 & status==1~"2", T~ NA_character_)) %>% 
  dplyr::group_by(id) %>% 
  dplyr::mutate(cond=suppressWarnings(max(as.character(cond),na.rm=T)))%>% 
  dplyr::ungroup()%>% 
  dplyr::filter(cond=="1",!trans %in% c(1,2))%>% 
  dplyr::mutate(trans_cor= dplyr::case_when(trans==7~ 3, trans==5~ 2, T~ 1))%>% 
  data.table() 
if(no_mostrar==1){
rio::export(dt_ms_d_match_surv_oct_2022_a, "oct_2022_a.dta")
}

dt_ms_d_match_surv_oct_2022_b<-dplyr::mutate(ms_d_match_surv_oct_2022,id=as.numeric(id))%>% 
  dplyr::mutate(cond= dplyr::case_when(trans==1 & status==1~"1", trans==2 & status==1~"2", T~ NA_character_)) %>% 
  dplyr::group_by(id) %>% 
  dplyr::mutate(cond=suppressWarnings(max(as.character(cond),na.rm=T)))%>% 
  dplyr::ungroup()%>% 
  dplyr::filter(cond=="2",!trans %in% c(1,2))%>% 
  dplyr::mutate(trans_cor= dplyr::case_when(trans==8~ 3, trans==6~ 2, T~ 1))%>% 
  data.table() 
if(no_mostrar==1){
rio::export(dt_ms_d_match_surv_oct_2022_b, "oct_2022_b.dta")
}
```

```{r 0a, include=T, results="hide", eval=F}
dt_ms_d_match_surv$TD_1<-factor(dt_ms_d_match_surv$TD_1)
dt_ms_d_match_surv$tipo_de_plan_res_1<-factor(dt_ms_d_match_surv$tipo_de_plan_res_1)

if(no_mostrar==1){
rio::export(dt_ms_d_match_surv2,
paste0(sub("/SUD_CL","",getwd()),"/_mult_state_ags/five_st_msprep_apr22_long.dta"))
CONS_C1_df_dup_SEP_2020_match_miss_after_imp_conservados %>% rio::export(paste0(sub("/SUD_CL","",getwd()),"/_mult_state_ags/five_st_msprep_apr22_long_tot.dta"))
invisible("Para g-estimation")
CONS_C1_df_dup_SEP_2020_match_miss_after_imp_conservados %>% rio::export(paste0(sub("/SUD_CL","",getwd()),"/_mult_state_ags/five_st_msprep_apr22_long_tot.dta"))
}

invisible("Classic way to report results: similar to the previous report")

coxphw_pwp_int<-
  coxphw(Surv(time, status) ~ tipo_de_plan_res_1:strata(trans)+ TD_1+  
           cluster(id), data = dt_ms_d_match_surv[dt_ms_d_match_surv$trans %in% 1:3,],template="AHR",  robust=T)
#Takes 15 min aprox
#No convergence attained in 200 iterations when tipo_de_plan_res_1:strata(trans):strata(TD_1)+  
#No convergence attained in 200 iterations when tipo_de_plan_res_1:strata(trans):TD_1+  

coxphw_pwp_int2<-
  coxphw(Surv(time, status) ~ tipo_de_plan_res_1:strata(trans):TD_1+ arrival+  
           cluster(id), data = dt_ms_d_match_surv[dt_ms_d_match_surv$trans %in% 1:3,c("id","cid","trans","time","status","tipo_de_plan_res_1","TD_1", "arrival")],template="AHR",  robust=T)
#No convergence attained in 200 iterations when tipo_de_plan_res_1:strata(trans):TD_1+ #arrival+  cluster(id)+ cluster(cid)
#No convergence attained in 200 iterations when tipo_de_plan_res_1:strata(trans):TD_1+ arrival+  cluster(id)+ cluster(cid)
# tipo_de_plan_res_1:strata(trans):TD_1+ arrival+  cluster(id) __> converges

summary(coxphw_pwp_int2)

fit1est <-try( predict(coxphw_pwp_int2, type = "slice.time", x = "yrs", z = "TD_1", newx = seq(from = 90, to = 1827, by = 90)))
#Error in `contrasts<-`(`*tmp*`, value = contr.funs[1 + isOF[nn]]) : 
  #contrasts can be applied only to factors with 2 or more levels
fit1est <-try( predict(coxphw_pwp_int2, type = "slice.time", x = "yrs", z = "tipo_de_plan_res_1", newx = seq(from = 90, to = 1827, by = 90)))

plot(predict(coxphw_pwp_int2, type = "shape", newx = c(0,1), refx = 0, x = "tipo_de_plan_res_1",
             verbose = FALSE))
#Error in `contrasts<-`(`*tmp*`, value = contr.funs[1 + isOF[nn]]) :  contrasts can be applied only to factors with 2 or more levels

plot(predict(coxphw_pwp_int, type = "slice.x", x = "TD_1", z = "tipo_de_plan_res_1",
             newx = c(0,1), verbose = FALSE), main = "interaction of trt with x")

cols = colnames(dt_ms_d_match_surv[dt_ms_d_match_surv$trans %in% 1:3,])
for (col in cols){
  if(is.factor(dt_ms_d_match_surv[dt_ms_d_match_surv$trans %in% 1:3,][[col]])){
    cat(col, ' has ', length(levels(dt_ms_d_match_surv[dt_ms_d_match_surv$trans %in% 1:3,][[col]])), '\n')
  }
}

bpdtvc<-Surv(time, status) ~ tipo_de_plan_res_1:trans:TD_1+ cluster(id)#arrival+  
           #+ cluster(cid)
fit<-splineCox(bpdtvc, dt_ms_d_match_surv[dt_ms_d_match_surv$trans %in% 1:3,c("id","cid","trans","time","status","tipo_de_plan_res_1","TD_1", "arrival")], control=list(df=5))

coxr_fit<-
coxr(Surv(time, status) ~ tipo_de_plan_res_1:trans:TD_1+ cluster(id), data=dt_ms_d_match_surv[dt_ms_d_match_surv$trans %in% 1:3,c("id","cid","trans","time","status","tipo_de_plan_res_1","TD_1", "arrival")] )

#Toma como 4 min
```

```{r 0-9s, include=T,warning=F, message=F}

dt_ms_d_match_surv_oct_2022_a$arr_trans<- dlookr::get_transform(dt_ms_d_match_surv_oct_2022_a$arrival, "Yeo-Johnson")
dt_ms_d_match_surv_oct_2022_b$arr_trans<- dlookr::get_transform(dt_ms_d_match_surv_oct_2022_b$arrival, "Yeo-Johnson")
```

<br>

## Sequential glimpse

### 5 states

```{r alluvial, echo=T, error=T, fig.align = "center", paged.print=TRUE, fig.height=9, error=T, dpi=500, fig.cap="Figure 3. Sankey Plot of Transitions by Treatment Setting"}
library(easyalluvial)
library(parcats)
p_alluvial<-
  d_match_surv_msprep[,c(1,3:6)] %>% 
    mutate_at(vars(starts_with("tipo_de_plan_res_")), funs(ifelse(is.na(.),2,.))) %>% 
    mutate_at(vars(starts_with("tipo_de_plan_res_")), funs(factor(.,labels=c("ambulatory","residential","censored"),levels=c(0,1,2)))) %>% #$fct_rev(
      alluvial_wide(
                   id = "id", 
                  bin=2,
                   bin_labels = c("ambulatory", "residential"),
                  order_levels= c("ambulatory", "residential","censored"),
                   fill_by = 'first_variable',
                    NA_label = "censored",
                   col_vector_flow=c("red","grey60"),#"#cF291D",
                    #palette_qualitative() %>% palette_filter(greys = F), #,#,"#ffe6d5","#bf6f6f","#eec1ad","#d29985","#cF291D","#b50717","#a43232","","gray",
                  col_vector_value=c("#bf6f6f","#eec1ad","#d29985") ,
                  auto_rotate_xlabs = T,
                  stratum_label_size = 3,
                   colorful_fill_variable_stratum = F)+
  theme_void()

p_alluvial
# parcats::parcats(p_alluvial, marginal_histograms = F, data=  d_match_surv_msprep[,c(1,3:6)] %>% 
#   mutate_at(vars(starts_with("tipo_de_plan_res_")), funs(ifelse(is.na(.),2,.))) %>% 
#   mutate_at(vars(starts_with("tipo_de_plan_res_")), funs(factor(.,labels=c("ambulatory","residential","censored"),levels=c(0,1,2)))), 
#                  labelfont = list(size = 12, color = "black"),
#                width = 840, height = 672)#, height=1600,width=1600) 672  480
```

<br>

```{r long_alluv-9s, echo=T, error=T, paged.print=TRUE, fig.align = "center", fig.cap="Figure 4. Sankey Plot of Transitions by Treatment Setting", fig.width=12, fig.height=8, eval=T}

alluvial_long(data.frame(dt_ms_d_match_surv %>% dplyr::mutate(tipo_de_plan_res=factor(tipo_de_plan_res, labels=c("ambulatory", "residential")))), 
              key=from,
              id= id, 
              value= tipo_de_plan_res, 
              fill_by="first_variable",
              NA_label = "censored", 
              complete=F,
              bin=2, 
              stratum_label_size=2,
              stratum_width=1/4,
              bin_labels = c("ambulatory", "residential"),
              col_vector_flow=c("red","yellow"),
              col_vector_value=c("#bf6f6f","#eec1ad","gray60") )+
  theme_void()
```

```{r alluvial3, echo=T, error=T, fig.align = "center", paged.print=TRUE, fig.height=9, error=T, dpi=500, fig.cap="Figure 5. Sankey Plot of Transitions by Treatment Setting", eval=F}
library(ggrepel)
library(ggalluvial)

plot_flow_alluvial<-
ggplot(data.frame(dt_ms_d_match_surv %>% dplyr::mutate(tipo_de_plan_res=factor(tipo_de_plan_res, labels=c("ambulatory", "residential"))) ), #requiere long %>% dplyr::filter(trans==1)
       aes(x = from, stratum = tipo_de_plan_res, alluvium = id,
            fill = tipo_de_plan_res)) +
  ggalluvial::geom_lode() + 
  geom_flow(curve_type = "cubic") +
  geom_stratum(alpha = 0) +
  theme_void()+
  scale_fill_manual(name="Treatment\nSetting", values=c('lightblue','gray70'))

set.seed(42)
plot_flow_alluvial2<-
  plot_flow_alluvial+
  geom_text_repel(stat = "flow",
            aes(label = scales::percent(after_stat(prop),accuracy = 1)),#hjust = (after_stat(flow) == "to"),
            size = 3,
            box.padding = unit(0.75, "lines"),
            show.legend=F,
            arrow = arrow(length = unit(0.005, "npc")))
plot_flow_alluvial2

ggsave(paste0(path,"/_mult_state_ags/Fig_plan_alt.jpg"), 
       plot_flow_alluvial2, width = 9, height = 11, dpi = 600, units= "in")

#C:\Users\CISS Fondecyt\Mi unidad\Alvacast\Matching\graphs
```

```{r alluvial32, echo=T, error=T, paged.print=TRUE}

tab_1st_tr<-
 d_match_surv_msprep[,c(1,3:6)] %>% 
    mutate_at(vars(starts_with("tipo_de_plan_res_")), funs(ifelse(is.na(.),2,.))) %>% 
    mutate_at(vars(starts_with("tipo_de_plan_res_")), funs(factor(.,labels=c("ambulatory","residential","censored"),levels=c(0,1,2)))) %>% 
    #dplyr::filter(tipo_de_plan_res_3!="censored") %>% 
    dplyr::count(tipo_de_plan_res_1,tipo_de_plan_res_2) %>% 
    dplyr::filter(case_when(.[[1]] =="censored" & .[[2]] =="censored" ~ n< 0, #When y == "", x > 3
                   T ~ n>0)) %>% 
    #dplyr::filter(.[1]!="censored" & .[2]!="censored") %>% 
    dplyr::group_by(.[1]) %>% 
    dplyr::mutate(prop=scales::percent(n/sum(n), accuracy=1)) %>% 
    dplyr::ungroup() %>% 
    dplyr::mutate(show=paste0(format(n, big.mark=","), " (",prop,")"))

tab_2nd_tr<-
 d_match_surv_msprep[,c(1,3:6)] %>% 
    mutate_at(vars(starts_with("tipo_de_plan_res_")), funs(ifelse(is.na(.),2,.))) %>% 
    mutate_at(vars(starts_with("tipo_de_plan_res_")), funs(factor(.,labels=c("ambulatory","residential","censored"),levels=c(0,1,2)))) %>% 
    #dplyr::filter(tipo_de_plan_res_3!="censored") %>% 
    dplyr::count(tipo_de_plan_res_2,tipo_de_plan_res_3) %>% 
    dplyr::filter(case_when(.[[1]] =="censored" & .[[2]] =="censored" ~ n< 0, #When y == "", x > 3
                   T ~ n>0)) %>% 
    dplyr::group_by(.[1]) %>% 
    dplyr::mutate(prop=scales::percent(n/sum(n), accuracy=1)) %>% 
    dplyr::ungroup() %>% 
    dplyr::mutate(show=paste0(format(n, big.mark=","), " (",prop,")")) 

tab_3rd_tr<-
  d_match_surv_msprep[,c(1,3:6)] %>% 
    mutate_at(vars(starts_with("tipo_de_plan_res_")), funs(ifelse(is.na(.),2,.))) %>% 
    mutate_at(vars(starts_with("tipo_de_plan_res_")), funs(factor(.,labels=c("ambulatory","residential","censored"),levels=c(0,1,2)))) %>% 
    dplyr::count(tipo_de_plan_res_3,tipo_de_plan_res_4) %>% 
    dplyr::filter(case_when(.[[1]] =="censored" & .[[2]] =="censored" ~ n< 0, #When y == "", x > 3
                   T ~ n>0)) %>% 
    #dplyr::filter(.[1]!="censored"&.[2]!="censored") %>% 
    dplyr::group_by(.[1]) %>% 
    dplyr::mutate(prop=scales::percent(n/sum(n), accuracy=1)) %>% 
    dplyr::ungroup()  %>% 
    dplyr::mutate(show=paste0(format(n, big.mark=","), " (",prop,")"))

combinacion_concatenacion_eventos<-
d_match_surv_msprep[,c(1,3:6)] %>% 
  tidyr::unite("4_ev", tipo_de_plan_res_1:tipo_de_plan_res_4, remove = FALSE) %>% 
  dplyr::group_by(`4_ev`) %>% 
  dplyr::summarise(n=n())


cat("Third row of the graphics")

comb_conc_ev2<-
combinacion_concatenacion_eventos %>% 
    tidyr::separate(`4_ev`,into=c("first","second","third", "fourth"), sep="_") %>% 
    tidyr::unite("2_ev", first:second, remove = FALSE) %>% 
    dplyr::group_by(`2_ev`) %>%
    dplyr::summarise(n=sum(n)) %>% 
    tidyr::separate(`2_ev`,into=c("first","second"), sep="_") %>% 
    dplyr::group_by(`first`) %>% 
    dplyr::mutate(perc=scales::percent(n/sum(n), accuracy=1)) %>% 
    dplyr::ungroup() %>% 
    dplyr::filter(second!="NA")

cat("Fourth row of the graphics")

comb_conc_ev3<-
combinacion_concatenacion_eventos %>% 
    tidyr::separate(`4_ev`,into=c("first","second","third", "fourth"), sep="_") %>% 
    tidyr::unite("3_ev", first:third, remove = FALSE) %>% 
    dplyr::group_by(`3_ev`) %>%
    dplyr::summarise(n=sum(n)) %>% 
    tidyr::separate(`3_ev`,into=c("first","second","third"), sep="_") %>% 
    tidyr::unite("2_ev", first:second, remove = FALSE) %>%
    dplyr::group_by(`2_ev`) %>% 
    dplyr::mutate(perc=scales::percent(n/sum(n), accuracy=1)) %>% 
    dplyr::ungroup() %>% 
    dplyr::filter(third!="NA")

cat("Last row of the graphics")

comb_conc_ev4<-
combinacion_concatenacion_eventos %>% 
    tidyr::separate(`4_ev`,into=c("first","second","third", "fourth"), sep="_") %>% 
    tidyr::unite("3_ev", first:third, remove = FALSE) %>% 
    dplyr::group_by(`3_ev`) %>% 
    dplyr::mutate(perc=scales::percent(n/sum(n), accuracy=1)) %>% 
    dplyr::ungroup() %>% 
    dplyr::filter(fourth!="NA")



cbind.fill <- function(...) {
    transpoted <- lapply(list(...),t)
    transpoted_dataframe <- lapply(transpoted, as.data.table, keep.rownames=T)
    return (data.frame(t(plyr::rbind.fill(transpoted_dataframe))))                                               
} 

options(knitr.kable.NA = '')
cbind.fill(comb_conc_ev2,comb_conc_ev3,comb_conc_ev4) %>% 
  slice(-1) %>% 
  #dplyr::select(-1) %>% 
      knitr::kable(.,format = "html", format.args = list(decimal.mark = ".", big.mark = ","),
       caption = paste0("Table. Setting of readmissions and percentages by the previous one"),
       col.names = c("First\nevent","Second\nevent", "n", "%", "Concatenated\nevents", "First\nevent", "Second\nevent", "Third\nevent", "n", "%", "Concatenated\nevents","First\nevent", "Second\nevent","Third\nevent", "Fourth\nevent","n","%"),
               align =c('l',rep('c', 101)), escape=T) %>%
  kableExtra::kable_classic(bootstrap_options = c("striped", "hover"),font_size = 12) %>%
  kableExtra::add_header_above(c("Second"=5, "Third"=6, "Fouth"=7)) %>% 
  kableExtra::add_footnote("Note. 0/1 denotes Ambulatory and Residential Treatment, respectively; % denotes the percentage of the previous event", notation="none") %>% 
  kableExtra::scroll_box(width = "100%", height = "375px")
```
 
```{r alluvial322, echo=T, error=T, paged.print=TRUE}
combinacion_concatenacion_eventos2<-
d_match_surv_msprep[,c(1,3,19:21)] %>% 
  tidyr::unite("4_ev", tipo_de_plan_res_1:TD_3, remove = FALSE) %>% 
  dplyr::group_by(`4_ev`) %>% 
  dplyr::summarise(n=n())

cat("Third row of the graphics")

comb2_conc_ev2<-
combinacion_concatenacion_eventos2 %>% 
    tidyr::separate(`4_ev`,into=c("first","second","third", "fourth"), sep="_") %>% 
    tidyr::unite("2_ev", first:second, remove = FALSE) %>% 
    dplyr::group_by(`2_ev`) %>%
    dplyr::summarise(n=sum(n)) %>% 
    tidyr::separate(`2_ev`,into=c("first","second"), sep="_") %>% 
    dplyr::group_by(`first`) %>% 
    dplyr::mutate(perc=scales::percent(n/sum(n))) %>% 
    dplyr::ungroup() %>% 
    dplyr::filter(second!="NA")

cat("Fourth row of the graphics")

comb2_conc_ev3<-
combinacion_concatenacion_eventos2 %>% 
    tidyr::separate(`4_ev`,into=c("first","second","third", "fourth"), sep="_") %>% 
    tidyr::unite("3_ev", first:third, remove = FALSE) %>% 
    dplyr::group_by(`3_ev`) %>%
    dplyr::summarise(n=sum(n)) %>% 
    tidyr::separate(`3_ev`,into=c("first","second","third"), sep="_") %>% 
    tidyr::unite("2_ev", first:second, remove = FALSE) %>%
    #dplyr::group_by(`2_ev`) %>% 
    dplyr::group_by(first) %>% 
    dplyr::mutate(perc=scales::percent(n/sum(n))) %>% 
    dplyr::ungroup() %>% 
    dplyr::filter(third!="NA")

cat("Last row of the graphics")

comb2_conc_ev4<-
combinacion_concatenacion_eventos2 %>% 
    tidyr::separate(`4_ev`,into=c("first","second","third", "fourth"), sep="_") %>% 
    tidyr::unite("3_ev", first:third, remove = FALSE) %>% 
    dplyr::group_by(first) %>% 
    dplyr::mutate(perc=scales::percent(n/sum(n))) %>% 
    dplyr::ungroup() %>% 
    dplyr::filter(fourth!="NA")


options(knitr.kable.NA = '')
cbind.fill(comb2_conc_ev2,comb2_conc_ev3,comb2_conc_ev4) %>% 
  slice(-1) %>% 
  #dplyr::select(-1) %>% 
      knitr::kable(.,format = "html", format.args = list(decimal.mark = ".", big.mark = ","),
       caption = paste0("Table. Treatment completion status counts and percentages by the previous one"),
       col.names = c("Base Tr.\nSetting","Second\nevent", "n", "%", "Concatenated\nevents", "Base Tr.\nSetting", "Second\nevent", "Third\nevent", "n", "%", "Concatenated\nevents","Base Tr.\nSetting", "Second\nevent","Third\nevent", "Fourth\nevent","n","%"),
               align =c('l',rep('c', 101)), escape=T) %>%
  kableExtra::kable_classic(bootstrap_options = c("striped", "hover"),font_size = 12) %>%
  kableExtra::add_header_above(c("Second (First tr. completion status)"=5, "Third (2nd tr. completion status)"=6, "Fouth (3rd tr. completion status)"=7)) %>% 
  kableExtra::add_footnote("Note. 0/1 denotes Not-completion and Treatment Completion, respectively; % denotes the percentage of the total", notation="none") %>% 
  kableExtra::scroll_box(width = "100%", height = "375px")
``` 
 
 
```{r alluvial4, echo=T, error=T, paged.print=TRUE, error=T, fig.align = "center", fig.cap="Figure 6. Tree diagram of counts and total proportions of Type of Plan from the first to the fourth treatment"}
library(data.tree)

tree_str<-
    plyr::rbind.fill(cbind(step=1,comb_conc_ev2),cbind(step=2,comb_conc_ev3),cbind(step=3,comb_conc_ev4)) %>% dplyr::select(step, first, second, third, fourth, `3_ev`, n, perc) %>% arrange(step,desc(first), second, third, fourth) %>% dplyr::mutate(label=paste0(formatC(n,big.mark=",")," (", perc,")")) %>% 
  dplyr::mutate(`3_ev`=dplyr::case_when(step==1~paste0(first,"_",second),step==2~paste0(first,"_",second,"_",third),T~paste0(`3_ev`,"_",fourth)))


#scales::percent(358/2078,accuracy = 1)ä
 traveller <- Node$new("Admission")
route1 <- traveller$AddChild(paste0("1st  tr., Residential: ",format(dim(d_match_surv_msprep)[1]/2,big.mark=","),"(50%)"))
route0 <- traveller$AddChild(paste0("1st  tr., Ambulatory: ",format(dim(d_match_surv_msprep)[1]/2,big.mark=","),"(50%)"))

#step 1
route10 <-route1$AddChild(paste0("2nd  tr., Ambulatory: ",subset(tree_str,subset=`3_ev`=="1_0",select="label")))
route11 <-route1$AddChild(paste0("2nd  tr., Residential: ",subset(tree_str,subset=`3_ev`=="1_1",select="label")))
route00 <- route0$AddChild(paste0("2nd  tr., Ambulatory: ",subset(tree_str,subset=`3_ev`=="0_0",select="label")))
route01 <- route0$AddChild(paste0("2nd  tr., Residential: ",subset(tree_str,subset=`3_ev`=="0_1",select="label")))

#step 2
route100<-route10$AddChild(paste0("3rd  tr., Ambulatory: ",subset(tree_str,subset=`3_ev`=="1_0_0",select="label")))
route101<-route10$AddChild(paste0("3rd  tr., Residential: ",subset(tree_str,subset=`3_ev`=="1_0_1",select="label")))
route110<-route11$AddChild(paste0("3rd  tr., Ambulatory: ",subset(tree_str,subset=`3_ev`=="1_1_0",select="label")))
route111<-route11$AddChild(paste0("3rd  tr., Residential: ",subset(tree_str,subset=`3_ev`=="1_1_1",select="label")))
route000<-route00$AddChild(paste0("3rd  tr., Ambulatory: ",subset(tree_str,subset=`3_ev`=="0_0_0",select="label")))
route001<-route00$AddChild(paste0("3rd  tr., Residential: ",subset(tree_str,subset=`3_ev`=="0_0_1",select="label")))
route010<-route01$AddChild(paste0("3rd  tr., Ambulatory: ",subset(tree_str,subset=`3_ev`=="0_1_0",select="label")))
route011<-route01$AddChild(paste0("3rd  tr., Residential: ",subset(tree_str,subset=`3_ev`=="0_1_1",select="label")))

#step 3
route100$AddChild(paste0("4th  tr., Ambulatory: ",subset(tree_str,subset=`3_ev`=="1_0_0_0",select="label")))
route100$AddChild(paste0("4th  tr., Residential: ",subset(tree_str,subset=`3_ev`=="1_0_0_1",select="label")))
route101$AddChild(paste0("4th  tr., Ambulatory: ",subset(tree_str,subset=`3_ev`=="1_0_1_0",select="label")))
route101$AddChild(paste0("4th  tr., Residential: ",subset(tree_str,subset=`3_ev`=="1_0_1_1",select="label")))
route110$AddChild(paste0("4th  tr., Ambulatory: ",subset(tree_str,subset=`3_ev`=="1_1_0_0",select="label")))
route110$AddChild(paste0("4th  tr., Residential: ",subset(tree_str,subset=`3_ev`=="1_1_0_1",select="label")))
route111$AddChild(paste0("4th  tr., Ambulatory: ",subset(tree_str,subset=`3_ev`=="1_1_1_0",select="label")))
route111$AddChild(paste0("4th  tr., Residential: ",subset(tree_str,subset=`3_ev`=="1_1_1_1",select="label")))

route000$AddChild(paste0("4th  tr., Ambulatory: ",subset(tree_str,subset=`3_ev`=="0_0_0_0",select="label")))
route000$AddChild(paste0("4th  tr., Residential: ",subset(tree_str,subset=`3_ev`=="0_0_0_1",select="label")))
route001$AddChild(paste0("4th  tr., Ambulatory: ",subset(tree_str,subset=`3_ev`=="0_0_1_0",select="label")))
route001$AddChild(paste0("4th  tr., Residential: ",subset(tree_str,subset=`3_ev`=="0_0_1_1",select="label")))
route010$AddChild(paste0("4th  tr., Ambulatory: ",subset(tree_str,subset=`3_ev`=="0_1_0_0",select="label")))
route010$AddChild(paste0("4th  tr., Residential: ",subset(tree_str,subset=`3_ev`=="0_1_0_1",select="label")))
route011$AddChild(paste0("4th  tr., Ambulatory: ",subset(tree_str,subset=`3_ev`=="0_1_1_0",select="label")))
route011$AddChild(paste0("4th  tr., Residential: ",subset(tree_str,subset=`3_ev`=="0_1_1_1",select="label")))

SetGraphStyle(traveller, rankdir = "LR")
plot(traveller)

library(rsvg)
library(DiagrammeRsvg)
plot(traveller) %>%
    export_svg %>% charToRaw %>% rsvg_pdf(paste0(path,"/_mult_state_ags/_flowchart_transition_22.pdf"))
plot(traveller) %>%
    export_svg %>% charToRaw %>% rsvg_png(paste0(path,"/_mult_state_ags/_flowchart_transition_22.png"))
```


### 9 states

**Incidence rates**:

```{r irrs_oct_2022_1,eval=T, echo=T, paged.print=TRUE}
#https://mail.google.com/mail/u/0/?tab=rm&ogbl#search/%22event%22+%22jos%C3%A9%22/FMfcgzGkXwLJKPwsCJJNSWTlgGlPQqKk
#info with jose

comp_status_readmission_setting_oct2022_1 <-
  irrs(x="tipo_de_plan_res_1", 
                              y="TD_status",# 2021-04-06, 
                              z="TD_time", 
                              db="d_match_surv_msprep_oct_2022")

bind_rows(
biostat3::survRate(Surv(TD_time, TD_status) ~ tipo_de_plan_res_1, data=d_match_surv_msprep_oct_2022),
cbind(1,data.table(biostat3::survRate(Surv(TD_time, TD_status) ~ 1, data=d_match_surv_msprep_oct_2022), keep.rownames = T))
)%>% 
  dplyr::select(-V1, -rn) %>% 
  dplyr::mutate_at(4:6,~.*1e4) %>% 
  dplyr::mutate(tipo_de_plan_res_1= dplyr::case_when(tipo_de_plan_res_1==0~ "Ambulatory",tipo_de_plan_res_1==1~ "Residential", T~ "Total")) %>% 
  knitr::kable( col.names= c("Setting", "tstop", "event", "rate (per 10,000)", "lower", "upper"))%>%
  kableExtra::kable_classic()
```


```{r irrs_oct_2022_2,eval=T, echo=T, paged.print=TRUE}
#https://mail.google.com/mail/u/0/?tab=rm&ogbl#search/%22event%22+%22jos%C3%A9%22/FMfcgzGkXwLJKPwsCJJNSWTlgGlPQqKk
#info with jose

comp_status_readmission_setting_oct2022_2 <-
  irrs(x="tipo_de_plan_res_1", 
                              y="DWCA_status",# 2021-04-06, 
                              z="DWCA_time", 
                              db="d_match_surv_msprep_oct_2022")

bind_rows(
biostat3::survRate(Surv(DWCA_time, DWCA_status) ~ tipo_de_plan_res_1, data=d_match_surv_msprep_oct_2022),
cbind(1,data.table(biostat3::survRate(Surv(DWCA_time, DWCA_status) ~ 1, data=d_match_surv_msprep_oct_2022), keep.rownames = T))
)%>% 
  dplyr::select(-V1, -rn) %>% 
  dplyr::mutate_at(4:6,~.*1e4) %>% 
  dplyr::mutate(tipo_de_plan_res_1= dplyr::case_when(tipo_de_plan_res_1==0~ "Ambulatory",tipo_de_plan_res_1==1~ "Residential", T~ "Total")) %>% 
  knitr::kable( col.names= c("Setting", "tstop", "event", "rate (per 10,000)", "lower", "upper"))%>%
  kableExtra::kable_classic()
```


```{r irrs_oct_2022_3,eval=T, echo=T, paged.print=TRUE}
#https://mail.google.com/mail/u/0/?tab=rm&ogbl#search/%22event%22+%22jos%C3%A9%22/FMfcgzGkXwLJKPwsCJJNSWTlgGlPQqKk
#info with jose

comp_status_readmission_setting_oct2022_3 <-
  irrs(x="tipo_de_plan_res_1", 
                              y="Readmission_status",# 2021-04-06, 
                              z="Readmission_time", 
                              db="d_match_surv_msprep_oct_2022")

bind_rows(
biostat3::survRate(Surv(Readmission_time, Readmission_status) ~ tipo_de_plan_res_1, data=d_match_surv_msprep_oct_2022),
cbind(1,data.table(biostat3::survRate(Surv(Readmission_time, Readmission_status) ~ 1, data=d_match_surv_msprep_oct_2022), keep.rownames = T))
)%>% 
  dplyr::select(-V1, -rn) %>% 
  dplyr::mutate_at(4:6,~.*1e4) %>% 
  dplyr::mutate(tipo_de_plan_res_1= dplyr::case_when(tipo_de_plan_res_1==0~ "Ambulatory",tipo_de_plan_res_1==1~ "Residential", T~ "Total")) %>% 
  knitr::kable( col.names= c("Setting", "tstop", "event", "rate (per 10,000)", "lower", "upper"))%>%
  kableExtra::kable_classic()
```

<br>



```{r alluvial3-9s, echo=T, error=T, fig.align = "center", paged.print=TRUE, fig.height=11, fig.width = 9, error=T, dpi=600, fig.cap="Figure 5. Sankey Plot of Transitions by Treatment Setting (9 states)", eval=T}
library(ggrepel)
library(ggalluvial)

combinacion_concatenacion_eventos_oct_2022<-
d_match_surv_msprep_oct_2022[,c("tipo_de_plan_res_1", "TD_status", "DWCA_status", "Readmission_status", "Readmissionb_status", "Readmission2_status", "Readmission2b_status", "Readmission3_status", "Readmission3b_status")] %>% 
  dplyr::mutate(TD_status= dplyr::case_when(DWCA_status==1~2, TD_status==0 & DWCA_status==0~ NA_real_, T~ TD_status)) %>% 
  dplyr::mutate(Readmission_status= dplyr::case_when(Readmissionb_status==1 & Readmission_status==0~ 1, Readmissionb_status==0 & Readmission_status==0~ NA_real_, T~ Readmission_status)) %>% 
  dplyr::mutate(Readmission2_status= dplyr::case_when(Readmission2b_status==1 & Readmission2_status==0~ 1, Readmission2b_status==0 & Readmission2_status==0~ NA_real_, T~ Readmission2_status)) %>% 
  dplyr::mutate(Readmission3_status= dplyr::case_when(Readmission3b_status==1 & Readmission3_status==0~ 1, Readmission3b_status==0 & Readmission3_status==0~ NA_real_, T~ Readmission3_status)) %>% 
  dplyr::select(-DWCA_status, -Readmissionb_status, -Readmission2b_status, - Readmission3b_status)%>% 
  tidyr::unite("5_ev", tipo_de_plan_res_1:Readmission3_status , remove = FALSE) %>% 
  dplyr::group_by(`5_ev`) %>% 
  dplyr::summarise(n=n())


set.seed(42)
plot_alluvial_9s<-
combinacion_concatenacion_eventos_oct_2022 %>% 
    tidyr::separate(`5_ev`,into=c("first","second","third", "fourth", "fifth"), sep="_") %>% 
  #is_alluvia_form(as.data.frame(.), axes = 1:5, silent = TRUE) %>% 
  dplyr::mutate(first=dplyr::case_when(first==0~ "Ambulatory", first==1~ "Residential", T~"Censored"), second=dplyr::case_when(second==2~ "Complete\ntr.", second==1~ "Non-Complete\ntr.", T~"Cens.")) %>% 
    dplyr::mutate(third= dplyr::case_when(third==1~"Readmission",T~"Cens.")) %>%
  dplyr::mutate(fourth= dplyr::case_when(fourth==1~"2nd\nReadm",T~"Cens."))%>%
  dplyr::mutate(fifth= dplyr::case_when(fifth==1~ "3rd Readm",T~"Cens.")) %>%
  ggplot(aes(y= n, axis1= first, axis2= second, axis3= third, axis4= fourth, axis5= fifth))+
    scale_x_discrete(limits = c("first","second", "third", "fourth", "fifth"), expand = c(.2, .05)) +
  xlab("State") +
  geom_alluvium(aes(fill = first)) +
  geom_stratum(alpha=.65, size=0, width = .7)+
  geom_text(stat = "stratum", aes(label = after_stat(stratum))) +
  theme_void()+
 theme(#legend.position="right",
   legend.position=c(1.03,.5),
       legend.justification="right", 
       legend.box.spacing = unit(0, "pt"),# The spacing between the plotting area and the legend box (unit)
        legend.margin = margin(0, 0, 0, 0, "cm"),
        #legend.margin = margin(0.2, 0.2, 0.2, 0.2, "cm"),
        legend.box.margin=margin(0,0,0,0)) +
   scale_fill_manual(name="Treatment\nSetting", values=c('lightblue','gray70'))+
  theme(plot.margin = margin(0,1.0,0,-1.1, "cm"))
  # geom_text_repel(stat = "flow",
  #           aes(label = scales::percent(after_stat(prop),accuracy = 1)),#hjust = 
  #           size = 4,
  #           box.padding = unit(0.75, "lines"),
  #           show.legend=F,
  #           arrow = arrow(length = unit(0.005, "npc")))
plot_alluvial_9s

ggsave(paste0(path,"/_mult_state_ags/Fig_plan_alt_9s.jpg"), 
       plot_alluvial_9s, width = 9, height = 11, dpi = 600, units= "in")

#C:\Users\CISS Fondecyt\Mi unidad\Alvacast\Matching\graphs
```
 
```{r alluvial4-9s, echo=T, error=T, paged.print=TRUE, error=T, fig.align = "center", fig.cap="Figure 6. Tree diagram of counts and total proportions of Type of Plan from the first to the fourth treatment"}
library(data.tree)

cat("Fifth row of the graphics")

comb_conc_ev2_oct_2022<-
combinacion_concatenacion_eventos_oct_2022 %>% 
    tidyr::separate(`5_ev`,into=c("first","second","third", "fourth", "fifth"), sep="_") %>% 
    tidyr::unite("2_ev", first:second, remove = FALSE) %>% 
    dplyr::group_by(`2_ev`) %>%
    dplyr::summarise(n=sum(n)) %>% 
    tidyr::separate(`2_ev`,into=c("first","second"), sep="_") %>% 
    dplyr::group_by(`first`) %>% 
    dplyr::mutate(perc=scales::percent(n/sum(n), accuracy=1)) %>% 
    dplyr::ungroup() %>% 
    dplyr::filter(second!="NA")

cat("Fourth row of the graphics")

comb_conc_ev3_oct_2022<-
combinacion_concatenacion_eventos_oct_2022 %>% 
    tidyr::separate(`5_ev`,into=c("first","second","third", "fourth", "fifth"), sep="_") %>% 
    tidyr::unite("3_ev", first:third, remove = FALSE) %>% 
    dplyr::group_by(`3_ev`) %>%
    dplyr::summarise(n=sum(n)) %>% 
    tidyr::separate(`3_ev`,into=c("first","second","third"), sep="_") %>% 
    tidyr::unite("2_ev", first:second, remove = FALSE) %>%
    dplyr::group_by(`2_ev`) %>% 
    dplyr::mutate(perc=scales::percent(n/sum(n), accuracy=1)) %>% 
    dplyr::ungroup() %>% 
    dplyr::filter(third!="NA")%>% 
      dplyr::group_by(first) %>% 
    dplyr::mutate(letters= row_number()) %>% 
    dplyr::ungroup() %>% 
  dplyr::arrange(letters, second, third)
#0-2/1-2 =4046 era menos que 4051 (1st readmission)
#0-1/1-1= 1518 es mayor a 1517

cat("Fifth row of the graphics")

comb_conc_ev4_oct_2022<-
combinacion_concatenacion_eventos_oct_2022 %>% 
    tidyr::separate(`5_ev`,into=c("first","second","third", "fourth", "fifth"), sep="_") %>% 
    tidyr::unite("4_ev", first:fourth, remove = FALSE) %>% 
    dplyr::group_by(`4_ev`) %>%
    dplyr::summarise(n=sum(n)) %>% 
    tidyr::separate(`4_ev`,into=c("first","second","third","fourth"), sep="_") %>% 
    tidyr::unite("3_ev", first:third, remove = FALSE) %>%
    dplyr::group_by(`3_ev`) %>% 
    dplyr::mutate(perc=scales::percent(n/sum(n), accuracy=1)) %>% 
    dplyr::ungroup() %>% 
    dplyr::filter(fourth!="NA")%>% 
      dplyr::group_by(first) %>% 
    dplyr::mutate(letters= row_number()) %>% 
    dplyr::ungroup() %>% 
  dplyr::arrange(letters, second, third, fourth)
#0-2 1305 Readmission2 TNC

# cbind.data.frame(comb_conc_ev4_oct_2022, letters=rep(1:4,2)) %>% 
#     dplyr::arrange(letters, second, third, fourth)
# *-2-1-1 31+96+73+247 = 447 TC to 2nd readm
# *-1-1-1 180+267+393+465 = 1305 TNC to 2nd readm

cat("Last row of the graphics")

comb_conc_ev5_oct_2022<-
combinacion_concatenacion_eventos_oct_2022 %>% 
    tidyr::separate(`5_ev`,into=c("first","second","third", "fourth", "fifth"), sep="_") %>% 
    tidyr::unite("5_ev", first:fifth, remove = FALSE) %>% 
    dplyr::group_by(`5_ev`) %>%
    dplyr::summarise(n=sum(n)) %>% 
    tidyr::separate(`5_ev`,into=c("first","second","third","fourth", "fifth"), sep="_") %>% 
    tidyr::unite("4_ev", first:fourth, remove = FALSE) %>%
    dplyr::group_by(`4_ev`) %>% 
    dplyr::mutate(perc=scales::percent(n/sum(n), accuracy=1)) %>% 
    dplyr::ungroup() %>% 
    dplyr::filter(fifth!="NA")%>% 
      dplyr::group_by(first) %>% 
    dplyr::mutate(letters= row_number()) %>% 
    dplyr::ungroup() %>% 
  dplyr::arrange(letters, second, third, fourth, fifth)


tree_str_oct_2022<-
    plyr::rbind.fill(cbind(step=1,comb_conc_ev2_oct_2022),cbind(step=2,comb_conc_ev3_oct_2022),cbind(step=3,comb_conc_ev4_oct_2022),cbind(step=4,comb_conc_ev5_oct_2022))

tree_str_oct_2022<-
tree_str_oct_2022%>% dplyr::select(step, first, second, third, fourth, fifth, `4_ev`, n, perc) %>% arrange(step,desc(first), second, third, fourth, fifth) 


tree_str_oct_2022<-
tree_str_oct_2022%>% dplyr::mutate(label=paste0(formatC(n,big.mark=",")," (", perc,")"))%>% dplyr::mutate(`4_ev`=dplyr::case_when(step==1~ paste0(first,"_",second), step==2~paste0(first,"_",second,"_",third), step==3~paste0(first,"_",second,"_",third,"_",fourth), T~paste0(`4_ev`,"_",fourth)))
 
invisible(" I could make that the tree resemble to the stata graphic")

#scales::percent(358/2078,accuracy = 1)ä
 traveller_oct_2022 <- Node$new("Admission")
route_oct_2022_1 <- traveller_oct_2022$AddChild(paste0("1st treatment\nResidential:\n ",format(dim(d_match_surv_msprep_oct_2022)[1]/2,big.mark=","),"(50%)"))
route_oct_2022_0 <- traveller_oct_2022$AddChild(paste0("1st treatment\nAmbulatory:\n ",format(dim(d_match_surv_msprep_oct_2022)[1]/2,big.mark=","),"(50%)"))

#plot(traveller_oct_2022)
#rm(list=ls(pattern="^route_oct_2022_"))

#step 1
route_oct_2022_11 <-route_oct_2022_1$AddChild(paste0("1st  treatment\nCompletion:\n ",subset(tree_str_oct_2022,subset=`4_ev`=="1_1",select="label")))
route_oct_2022_12 <-route_oct_2022_1$AddChild(paste0("1st  treatment\nNon-Completion:\n ",subset(tree_str_oct_2022,subset=`4_ev`=="1_2",select="label")))
route_oct_2022_01 <-route_oct_2022_0$AddChild(paste0("1st  treatment\nCompletion:\n ",subset(tree_str_oct_2022,subset=`4_ev`=="0_1",select="label")))
route_oct_2022_02 <-route_oct_2022_0$AddChild(paste0("1st  treatment\nNon-Completion:\n ",subset(tree_str_oct_2022,subset=`4_ev`=="0_2",select="label")))

#step 2
route_oct_2022_111<-route_oct_2022_11$AddChild(paste0("1st Readmission:\n ",subset(tree_str_oct_2022,subset=`4_ev`=="1_1_1",select="label")))
route_oct_2022_121<-route_oct_2022_12$AddChild(paste0("1st Readmission:\n ",subset(tree_str_oct_2022,subset=`4_ev`=="1_2_1",select="label")))
route_oct_2022_011<-route_oct_2022_01$AddChild(paste0("1st Readmission:\n ",subset(tree_str_oct_2022,subset=`4_ev`=="0_1_1",select="label")))
route_oct_2022_021<-route_oct_2022_02$AddChild(paste0("1st Readmission:\n ",subset(tree_str_oct_2022,subset=`4_ev`=="0_2_1",select="label")))

#step 3
route_oct_2022_1111<-route_oct_2022_111$AddChild(paste0("2nd Readmission:\n ",subset(tree_str_oct_2022,subset=`4_ev`=="1_1_1_1",select="label")))
route_oct_2022_1211<-route_oct_2022_121$AddChild(paste0("2nd Readmission:\n ",subset(tree_str_oct_2022,subset=`4_ev`=="1_2_1_1",select="label")))
route_oct_2022_0111<-route_oct_2022_011$AddChild(paste0("2nd Readmission:\n ",subset(tree_str_oct_2022,subset=`4_ev`=="0_1_1_1",select="label")))
route_oct_2022_0211<-route_oct_2022_021$AddChild(paste0("2nd Readmission:\n ",subset(tree_str_oct_2022,subset=`4_ev`=="0_2_1_1",select="label")))

#step 3
route_oct_2022_11111<-route_oct_2022_1111$AddChild(paste0("3rd Readmission:\n ",subset(tree_str_oct_2022,subset=`4_ev`=="1_1_1_1_1",select="label")))
route_oct_2022_12111<-route_oct_2022_1211$AddChild(paste0("3rd Readmission:\n ",subset(tree_str_oct_2022,subset=`4_ev`=="1_2_1_1_1",select="label")))
route_oct_2022_01111<-route_oct_2022_0111$AddChild(paste0("3rd Readmission:\n ",subset(tree_str_oct_2022,subset=`4_ev`=="0_1_1_1_1",select="label")))
route_oct_2022_02111<-route_oct_2022_0211$AddChild(paste0("3rd Readmission:\n ",subset(tree_str_oct_2022,subset=`4_ev`=="0_2_1_1_1",select="label")))


invisible("Im not sure if these are readmissions, i think theyt are, but why there are more than one casefor the 3rd step")


SetGraphStyle(traveller_oct_2022, rankdir = "LR")
plot(traveller_oct_2022)

library(rsvg)
library(DiagrammeRsvg)
plot(traveller_oct_2022) %>%
    export_svg %>% charToRaw %>% rsvg_pdf(paste0(path,"/_mult_state_ags/_flowchart_transition_22oct.pdf"))
plot(traveller_oct_2022) %>%
    export_svg %>% charToRaw %>% rsvg_png(paste0(path,"/_mult_state_ags/_flowchart_transition_22oct.png"))
```

<br>

# Session Info

```{r session_info, echo=T, error=T, paged.print=TRUE}
Sys.getenv("R_LIBS_USER")

if (grepl("CISS Fondecyt",rstudioapi::getSourceEditorContext()$path)==T){
    save.image("C:/Users/CISS Fondecyt/Mi unidad/Alvacast/SISTRAT 2019 (github)/mult_state_5_apr22.RData")
  } else if (grepl("andre",rstudioapi::getSourceEditorContext()$path)==T){
    save.image("C:/Users/andre/Desktop/SUD_CL/mult_state_5_apr22.RData")
  } else if (grepl("E:",rstudioapi::getSourceEditorContext()$path)==T){
    save.image("E:/Mi unidad/Alvacast/SISTRAT 2019 (github)/mult_state_5_apr22.RData")
  } else if (grepl("G:",rstudioapi::getSourceEditorContext()$path)==T){
    save.image("G:/Mi unidad/Alvacast/SISTRAT 2019 (github)/mult_state_5_apr22.RData")
  } else {
    save.image("~/mult_state_5_apr22.RData")
    path.expand("~/mult_state_5_apr22.RData")
  }

sessionInfo()
sesion_info <- devtools::session_info()
dplyr::select(
  tibble::as_tibble(sesion_info$packages),
  c(package, loadedversion, source)
) %>% 
  DT::datatable(filter = 'top', colnames = c('Row number' =1,'Variable' = 2, 'Percentage'= 3),
              caption = htmltools::tags$caption(
        style = 'caption-side: top; text-align: left;',
        '', htmltools::em('Packages')),
      options=list(
initComplete = htmlwidgets::JS(
      "function(settings, json) {",
      "$(this.api().tables().body()).css({'font-size': '80%'});",
      "}")))
```
