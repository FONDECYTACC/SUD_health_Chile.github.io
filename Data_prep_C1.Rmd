---
title: "Data Preparation and Standardization"
description: | 
  Scientific and technical writing about DB standarization, native to the web
Date: "`r format(Sys.time(), '%d %B, %Y')`"
output: 
  html_document:
     css: styles.css
     self_contained: no
     code_folding: hide  
---


```{r setup, include = FALSE}

load(paste0(getwd(),"/1.RData"))

#Libraries used in the routine. Dont change the order
if(!require(tidyr)){install.packages("tidyr")}
if(!require(data.table)){install.packages("data.table")}
if(!require(DataExplorer)){install.packages("DataExplorer")}
if(!require(stringi)){install.packages("stringi")}
if(!require(stringr)){install.packages("stringr")}
if(!require(ggplot2)){install.packages("ggplot2")}
if(!require(dplyr)){install.packages("dplyr")}
if(!require(Hmisc)){install.packages("Hmisc")}
if(!require(kableExtra)){install.packages("kableExtra")}
if(!require(plotly)){install.packages("plotly")}
if(!require(rbokeh)){install.packages("rbokeh")}
if(!require(altair)){install.packages("altair")}
if(!require(zoo)){install.packages("zoo")}
#if(!require(texreg)){install.packages("texreg")}
#if(!require(stargazer)){install.packages("stargazer")}
#if(!require(tab)){install.packages("tab")}
#remotes::install_github("leifeld/texreg",force = TRUE)
if(!require(broom)){install.packages("broom")} 
```

<style type="text/css">
.tablelines table, .tablelines td, .tablelines th {
        border: 1px solid black;
        }
.centrado {
    text-align: center;
}
.table.center {
    margin-left:auto; 
    margin-right:auto;
  }
.table_wrapper{
    display: block;
    overflow-x: auto;
    white-space: nowrap;
}
code.r{
  font-size: 8px;
}
body{ /* Normal  */
      text-align: justify;
  }
</style>


<!---

[//]: # (This is <span style="color: red">written in red</span>.)

[//]: # (Hey! Hover the cursor over me and guess what?! :) {: .purple})

[//]: # (I am in <span style="font-family:Papyrus; font-size:4em;">that!</span>)

[//]: #(#687886)

-->

This page will be used to comment and understand the steps, advances and douts about the process of data preparations and standardization of the SISTRAT C1 (Convenio 1) which can be translated to Agreement on Collaboration, Technical Assistance and Transfer of Resources to General Population ("Convenio de Colaboración Técnica y de Transferencia de Recursos para Programa de Población General"). Must note that it does not include Adolescent criminal offenders (C2).


To see the TOP or Profile of Treatment Results ("Perfil de Resultados de Tratamiento") data preparation, [go to this webpage](Data_prep_TOP).

<br>

## Building dataset

Define working directories which contains different text files that will be merged, correspondent to the years of the C1 Sistrat.

```markdown
dir_c1 <-toString(paste0(getwd(),"/Encriptado c1/Personas tratadas c1/"))
dir_top <-toString(paste0(getwd(),"/encriptados TOP/"))
#In my case,
dir_c1 <-toString(paste0("G:/Mi unidad/Alvacast/SISTRAT 2019 (github)","/Encriptado c1/Personas tratadas c1/"))
dir_top <-toString(paste0("G:/Mi unidad/Alvacast/SISTRAT 2019 (github)","/encriptados TOP/"))
```

Define files in the Directory folder, as long as they have the excel extension and they do not start with ~  (represent a working temporary file in excel)

```markdown
SISTRAT_c1<-list.files(path=toString(dir_c1), all.files=T, pattern="^[2].*\\s*txt$")
```

SISTRAT_c1 is composed by the following files:
* 2010tab-Resultado-20191113 (1).txt
* 2011tab -Resultado-20191113.txt 
* 2012tab-Resultado-20191113.txt 
* 2013tab-Resultado-20191113.txt
* 2014tab-Resultado-20191113.txt
* 2015tab-Resultado-20191113.txt
* 2016tab-Resultado-20191113.txt
* 2017tab-Resultado-20191113.txt
* 2018tab-Resultado-20191113.txt
* 2019_EneOcttab-Resultado-20191113.txt



Function to **read tab delimited text files**, with UTF-8 encoding and, based on the first 7 letters of its name, assign them an object name.

```markdown
read_excel_mult <- function(dir, filename) {
  assign(paste0(substr(filename, 1, 7)),read.delim(paste0(dir, filename),
        na.strings="null", header = T, fileEncoding="UTF-8"),envir = .GlobalEnv)
  }
```

 <br>
 
#### Import datasets

To import the datasets, we apply the previous function to every dataset
```markdown
for (x in SISTRAT_c1) {
  read_excel_mult(as.character(dir_c1), x)
}
```


 <br>
 
#### Normalize datasets

Normalize datasets by defining a common name for hash key's ("HASH_KEY") and assign them an standardized name.

```markdown
tab_10_18_mod <- function(x,y) {  get(x) %>% dplyr::rename("HASH_KEY" = !!names(.[91])) %>%
    as.data.frame() %>% 
    assign(paste0(y, as.character(x)),.,envir = .GlobalEnv)
}
for (i in paste0(c(2010:2018),"tab")) {tab_10_18_mod(i,y="c1_")}

`2019_En` %>% dplyr::rename("HASH_KEY" = !!names(.[92])) %>%
  as.data.frame() %>% 
  assign(paste0("c1_", "2019tab"),.,envir = .GlobalEnv)
```


 <br>
 
#### Append the datasets

Once normalized column names. Bind every year's datasets by their rows.
```markdown
CONS_C1=rbindlist(mget(paste0("c1_",c(2010:2019),"tab")), idcol="TABLE", fill=T)
CONS_C1 <- CONS_C1 %>% dplyr::mutate(row=1:nrow(CONS_C1)) %>% dplyr::select(row,everything())
```

***
***
***
***

 <br>
 
## Define and format variable names

Redefine variable names, create a column named _ano_bd_ with the year. Also, it reorder the variables to get the identifiers as the first columns.

#### Rename Variables

```markdown
CONS_C1 %>% 
  dplyr::rename(id=`Codigo.Identificación`) %>%
  dplyr::rename(fech_ing=`Fecha.Ingreso.a.Tratamiento`) %>%
  dplyr::rename(fech_egres=`Fecha.Egreso.de.Tratamiento`) %>%
  dplyr::rename(dias_trat=`Dias.en.Tratamiento`) %>%
  dplyr::rename(eva_consumo=`Evaluación.al.Egreso.Respecto.al.Patrón.de.consumo`) %>%
  dplyr::rename(eva_fam=`Evaluación.al.Egreso.Respecto.a.Situación.Familiar`) %>%
  dplyr::rename(eva_sm=`Evaluación.al.Egreso.Respecto.Salud.Mental`) %>%
  dplyr::rename(eva_fisica=`Evaluación.al.Egreso.Respecto.Salud.Física`) %>%
  dplyr::rename(eva_transgnorma=`Evaluación.al.Egreso.Respecto.Trasgresión.a.la.Norma.Social`) %>% 
  dplyr::rename(eva_relinterp=`Evaluación.al.Egreso.Respecto.Relaciones.Interpersonales`) %>%
  dplyr::rename(eva_ocupacion=`Evaluación.al.Egreso.Respecto.a.Situación.Ocupacional`) %>%
  dplyr::rename(evaluacindelprocesoteraputico=`Evaluación.del.Proceso.Terapéutico`) %>%
  dplyr::rename(nmesesentratamiento=`N.Meses.en.Tratamiento`) %>%
  dplyr::rename(motivodeegreso=`Motivo.de.Egreso`) %>%
  dplyr::rename(tipo_centro=`Tipo.Centro`) %>%
  dplyr::mutate(ano_bd=as.numeric(substr(TABLE,4,7))) %>%
  select(row, TABLE, HASH_KEY,ano_bd, everything()) %>%
  dplyr::arrange(id) %>%
  assign("CONS_C1_df",.,envir = .GlobalEnv)
```

Relevant variables are converted into factors.

```markdown
CONS_C1_df %>%
  dplyr::mutate(motivodeegreso=as.factor(motivodeegreso)) %>%
  dplyr::mutate(evaluacindelprocesoteraputico=as.factor(evaluacindelprocesoteraputico)) %>%
  dplyr::mutate(eva_consumo=as.factor(eva_consumo)) %>%
  dplyr::mutate(eva_fam=as.factor(eva_fam)) %>%  
  dplyr::mutate(eva_relinterp=as.factor(eva_relinterp)) %>%  
  dplyr::mutate(eva_ocupacion=as.factor(eva_ocupacion)) %>%
  dplyr::mutate(eva_sm=as.factor(eva_sm)) %>%  
  dplyr::mutate(eva_fisica=as.factor(eva_fisica)) %>%
  dplyr::mutate(eva_transgnorma=as.factor(eva_transgnorma)) %>%  
  dplyr::mutate(sexo=as.factor(Sexo)) %>%
  dplyr::mutate(embarazo=as.factor(`X.Se.trata.de.una.mujer.embarazada.`)) %>%
  dplyr::mutate(tipo_de_plan=as.factor(`Tipo.de.Plan`)) %>%  
  dplyr::mutate(tipo_de_programa=as.factor(`Tipo.de.Programa`)) %>%  
  assign("CONS_C1_df",.,envir = .GlobalEnv)	
```

<br>

#### Standardize Dates

<br>

##### Dates of admission and discharge

<br>

Most of the dates were not formatted equally. When standardized,some cases failed to transform dates, specifically in dates of discharge, which contained 87 cases, while only one case was problematic in admission dates. 

```markdown
CONS_C1_df %>%
  dplyr::mutate(fech_ing= ifelse(row=="14504", "10/01/2011",fech_ing))  %>%
  dplyr::mutate(fech_ing= lubridate::parse_date_time(fech_ing, c("%d/%m/%Y"),exact=T))
  dplyr::mutate(fech_egres_sin_fmt= fech_egres) %>% #this variable remains if necessary
  dplyr::mutate(fech_egres= ifelse(row=="36308", "02/04/2013",
                            ifelse(row=="14083", "03/05/2011",
                            ifelse(row=="6349", "01/07/2010",
                            ifelse(row=="42741", "02/08/2013",
                            ifelse(row=="8608","01/02/2011",
                            ifelse(row=="11709","01/02/2011",
                            ifelse(row=="40486","03/07/2013",
                            ifelse(row=="42521","09/07/2013",
                            ifelse(row=="5757", "04/10/2010",
                            ifelse(row=="39507", "02/07/2013",
                            ifelse(row=="3195", "04/10/2010",
                            ifelse(row=="37845", "01/07/2013",
                            ifelse(row=="40180", "07/08/2013",
                            ifelse(row=="28008", "27/11/2012",
                            ifelse(row=="35971", "01/03/2013",
                            ifelse(row=="5172", "03/05/2011",
                            ifelse(row=="10415", "03/05/2011",
                            ifelse(row=="16385", "30/08/2011",
                            ifelse(row=="39932", "02/08/2013",
                            ifelse(row=="16983", "06/09/2011",
                            ifelse(row=="37004", "02/08/2013",fech_egres)))))))))))))))))))))) %>%
  dplyr::mutate(fech_egres= lubridate::parse_date_time(stringr::str_trim(fech_egres), 
                                                       orders = c("%d/%m/%Y", "%d/%m/%y","%d%m%Y"),exact=T)) %>%
  dplyr::arrange(desc(ano_bd)) %>% 
  assign("CONS_C1_df",.,envir = .GlobalEnv)
```

For discharge dates, many cases had different formats. Those had to be transformed once the first formats were traduced (e.g. 30-12-2019 is interpteted first as "%d/%m/%Y" format. If it is not traduced, it interprets in "DD/MM/YY" format (or "%d/%m/%y"). We can see in Table 1 in non-formatted date of discharge (_fech_egres_sin_fmt_), how was traduced into an plausible discharge date (_fech_egres_). One criteria is that possibly in many cases, the second and or third 0 would correspond to a month character. On the contrary, "7082013" or "9072013" would be "2013-8-70" and "2013-7-90", respectively.


```{r echo=F, paged.print=TRUE}
CONS_C1_df %>%
  dplyr::filter(row %in% c(14504,36308,14083,6349, 42741,8608,11709,
                           40486,42521,5757,39507,3195,37845, 
                           40180,28008,35971,5172,10415,16385,
                           39932,16983,37004)) %>%
  dplyr::select(row, HASH_KEY, id_mod, fech_ing,fech_egres, fech_egres_sin_fmt,dias_trat) %>%
 knitr::kable(.,format = "html", format.args = list(decimal.mark = ".", big.mark = ","),
               caption="Table 1. Problematic cases of dates which required a manual change",
              col.names = c("Case","HASH", "ID", "Date of Admission", "Date of Discharge","Date of Discharge (No Format)","Days in Treatment"),
                 align =rep('c', 4))  %>%
  kable_styling(bootstrap_options = c("striped", "hover"),font_size = 10) %>%
  scroll_box(width = "100%", height = "450px")
#dplyr::filter(is.na(fech_egres)) %>%
```

<br>
As we can see in Table 2, some non-formatted date of discharge (_fech_egres_sin_fmt_), had insufficient information to traduce into valid dates.

```{r echo=F, paged.print=TRUE}
    CONS_C1_df %>%
      dplyr::filter(row %in% c(194, 8239, 9042, 9043, 9353, 12005, 12006, 12227,2603)) %>%
      dplyr::select(ano_bd, row,fech_egres,fech_egres_sin_fmt) %>%
      dplyr::rename("Year"=ano_bd, "case"=row, "DischargeDate"=fech_egres,
                    "DischargeDate-NoFmt"=fech_egres_sin_fmt) %>%
 knitr::kable(.,format = "html", format.args = list(decimal.mark = ".", big.mark = ","),
               caption="Table 2. Non-interpretable discharge dates",
                 align =rep('c', 4))  %>%
  kable_styling(bootstrap_options = c("striped", "hover"),font_size = 10) %>%
  scroll_box(width = "100%", height = "250px")
```

 <br>

**UPDATE: 2019-12-11**, had to format this date because it was bad labellled.
    `CONS_C1_df[CONS_C1_df$row=="5757","fech_egres"] <- "2010-10-04 UTC`

 <br>
***
***


## Data Cleaning Steps provided by SENDA's professional

This rules were provided by SENDA's professionals, in order to select adequate data for the analysis.

<br>

#### 1. Exclude not SENDA treatments

In first place, we should discard treatments not provided by SENDA. NULL values correspond to a single HASH key ("72c54d822de128e52f10511f3eb2d19f", in datasets from 2010 and 2011) that does not have a plan and program either.

```{r echo=F, paged.print=TRUE}
  data.frame(table(CONS_C1_df$SENDA,exclude=NULL),
             `%`=paste0(round(prop.table(table(CONS_C1_df$SENDA,exclude=NULL)),3)*100,"%")) %>%
  as.data.frame(.) %>%
 knitr::kable(.,format = "html", format.args = list(decimal.mark = ".", big.mark = ","), col.names = c("SENDA", "Frequency", "%"),
               caption="Table 3. Treatment Admissions",
                 align =rep('c', 3))  %>%
  kable_styling(bootstrap_options = c("striped", "hover"),font_size = 10) %>%
  add_footnote(c("No= Admission under another agreement" ,"Si= Admission under SENDA agreement"), notation = "none")
```
<br>
As we can see in Table 3, around 4.8% of cases had a treatment that could be not part of SENDA's agreements. The case that did not take part of the SENDA categories eas admitted to a SENDA agreement in 2009/12/10 and was admitted in 2009/12/14. 
<br>
<br>


#### 2. Explore the type of plan 

<br>

It is necessary to explore if there is any case that may have a treatment under a probation/parole ("libertad vigilada") plan.**It is necessary to consider the  3 null values in type of plans, equivalent to 2 HASHs.**

```{r echo=F, paged.print=TRUE}
  CONS_C1_df %>%
    dplyr::group_by(SENDA,tipo_de_plan) %>%
    dplyr::summarise(count = n() ) %>%
    dplyr::mutate(perc = paste0(round(100 * count/sum(count), 0), "%")) %>%    
    data.table::data.table() %>% 
    reshape::melt( id.vars = c(1:2)) %>% 
    reshape::cast(.,tipo_de_plan~SENDA+variable) %>% 
    dplyr::rename("Type of Plan" = tipo_de_plan, "No SENDA(n)" = No_count, "No SENDA(%)" = No_perc,
                  "Yes SENDA(n)"= Si_count, "Yes SENDA(%)"=Si_perc, "NA (n)"=NA_count, "NA (%)"=NA_perc) %>%
    as.data.frame() %>% 
 knitr::kable(.,format = "html", format.args = list(decimal.mark = ".", big.mark = ","),
               caption="Table 4. Treatment Plans",
                 align =rep('c', 7))  %>%
  kable_styling(bootstrap_options = c("striped", "hover"),font_size = 10) %>%
  add_footnote( c("PR= Residential Program" ,"PAB= Basic Outpatient Program", "PAI= Intensive Outpatient Treatment", "PAI LV=     Probation/Parole", "PAI= Intensive Outpatient Treatment"), notation = "none")

```

Table 4 shows that there is only 1 case in the probation/parole plan.
<br>
<br>

#### 3. Changes in programs

Change fixed residential, flexible residential and residential programmes into a general population residential program (PG PR). Additionally, flexible residential program cannot be under a probation/parole program.

Must note that there are ***some plans that have a number 2*** but they do not contain more than 0% of the total of the datasets. Also there are some plans related to the Treatment of People Living on the Streets Programs (Programa de Tratamiento de Personas en Situación de Calle). ***For the moment, we are not sure what is the fixed and flexible residential programmes***.

```{r echo=F, paged.print=TRUE}
  table(CONS_C1_df$tipo_de_programa, CONS_C1_df$tipo_de_plan, exclude= NULL)  %>% 
  as.data.frame() %>%
        reshape::melt( id.vars = c("Var1", "Var2")) %>%
      reshape::cast(.,Var1~Var2+variable) %>% 
 knitr::kable(.,format = "html", format.args = list(decimal.mark = ".", big.mark = ","),
               caption="Table 5. Contingency Tables of Programs by Plans", col.names= c("Type of Program", "CALLE",
"M-PAB","M-PAI","M-PAI2","M-PR","M-PR2","Otro","PAI LV","PG-PAB","PG-PAI","PG-PR","PG PAI 2","NA"),
                 align =rep('c', 14))  %>%
  kable_styling(bootstrap_options = c("striped", "hover"),font_size = 10)
```

<br>

#### 4. Plans within Alcohol Program

If there is a plan within the alcohol program, the plan must be modificated into the general population plan.
<br>

Every of the `r CONS_C1_df %>% dplyr::filter(tipo_de_programa=="Programa Alcohol") %>% dplyr::group_by(tipo_de_plan) %>% dplyr::summarise(n())` cases in the alcohol program are in the general population plan.

<br>

#### 5. Another Plan

If there is any plan correspondent to Another ("Otro"), it changes into a general population program.
<br>

There are `r CONS_C1_df %>% dplyr::filter(tipo_de_plan=="Otro") %>% dplyr::summarise(n())` cases with treatments categorized as Another ("Otro") plan.

<br>

#### 6.Plan & Programs by Sex

Women should be in the M-PAI in they actually are cathegorized in the general population program.
<br>

As can be seen in Table 6, around 58% of women are in the general population programmes.**Should be removed or changed?**

```{r echo=F, paged.print=TRUE, warning=FALSE}
CONS_C1_df %>%
    dplyr::count(tipo_de_plan, Sexo) %>% 
    dplyr::group_by(Sexo) %>% 
    mutate(prop = paste0(round(100 * prop.table(n)),"%")) %>%
    data.table::data.table() %>% 
    reshape::melt(id.vars = c(1:2)) %>% 
    reshape::cast(.,tipo_de_plan~Sexo+variable) %>% 
    dplyr::mutate(Hombre_n=as.numeric(Hombre_n),Mujer_n=as.numeric(Mujer_n)) %>%
    as.data.frame() %>%
    dplyr::rename("Type of Plan" = tipo_de_plan, "Men (n)" = Hombre_n, "Men (%)" = Hombre_prop,
                  "Women (n)"= Mujer_n, "Women (%)"=Mujer_prop) %>%
    as.data.frame() %>%
    knitr::kable(.,format = "html", format.args = list(decimal.mark = ".", big.mark = ","),
                   caption="Table 6. Plan by Sex", col.names= c("Plan", " Men (n)", "Men (%)","Women (n)","Women (%)"), 
                 align =rep('c', 5))  %>%
    kable_styling(bootstrap_options = c("striped", "hover"),font_size = 10) %>%
    add_footnote( c("PR= Residential Program" ,"PAB= Basic Outpatient Program", "PAI= Intensive Outpatient Treatment", "PAI LV=     Probation/Parole", "PAI= Intensive Outpatient Treatment"), notation = "none")

```

There are still a few doubts about these criteria:
- **Why there are men and women with female gender identity that are in the general population?, (Basic outpatient , intensive outpatient , Residential and Outpatient 2?**
- **Should the 2 men and 12 women in M-PAI but with masculine gender identity be in general population (PG PAI)?**
- **If in M-PR there is a women with masculine gender identity, should not be in the general population (PG_PR)?**

<br>

#### 7.Plan & Programs by Sex

Only plans "M-PAI", "M-PR", "PG-PAB", "PG-PAI" and "PG-PR" must be preserved. **Considering Table 4, what happens with M-PAB (basic outpatient for women), "Calle", "PG PAI 2", "M-PAI2", "M-PR2", "PAI LV" or another ("Otro")? (See Table 4)**

<br>

#### 8.Age of consumption begin

Treat as missing data the age of consumption begin if it is less than 5 years.

##### Figure 1. Histogram of Age of Consumption Begin

```{r bunch_o_figs, fig.height=4, fig.width=8, fig.align='center'}
  par(mfrow = c(1,2)) 
  hist(CONS_C1_df$Edad.Inicio.Consumo, main="Distribution of Age\nof Consumption Begin", 
       xlab="Age", ylab="Freq", breaks=30, xlim=c(0,80))
  hist(CONS_C1_df$Edad.Inicio.Consumo, main="Distribution of Age\nof Consumption Begin (zoom)", 
       xlab="Age", ylab="Freq", breaks=30, xlim=c(0,10), ylim=c(0,20000))
```

<br>
&nbsp;

There are around `r CONS_C1_df %>% dplyr::filter(Edad.Inicio.Consumo<5) %>% dplyr::summarise(n())` cases with less than 5 years in the consumption begin.

&nbsp;

<br>

#### 9.Delete duplicated cases (same date of admission and ID)

In this case, we included the HASH-KEY as another and more robust criteria to filter duplicate cases.

```{r echo=F, paged.print=TRUE}
    data.frame(table(with(CONS_C1_df, ifelse(duplicated(CONS_C1_df[c('fech_ing','HASH_KEY')]),  "Repeated", "Unique"))),
             `%`=paste0(round(prop.table(  table(with(CONS_C1_df, 
            ifelse(duplicated(CONS_C1_df[c('fech_ing','HASH_KEY')]), "Repeated", "Unique")))),3)*100,"%")) %>%
    knitr::kable(.,format = "html", format.args = list(decimal.mark = ".", big.mark = ","),
                   caption="Table 7. Repeated cases /Multiple Entrances", col.names= c(" ", " Frequencies", "Percentage"), 
                 align =rep('c', 3))  %>%
    kable_styling(bootstrap_options = c("striped", "hover"),font_size = 10)
```

&nbsp;

As seen in Table 7, there are more than a quarter of cases that may be replicating across the different datasets. 

<br>
&nbsp;


#### 10.Actual Age

Consider as missing age if it is less than 18 years and greater than 90.

<br>
&nbsp;

##### Figure 2. Histogram of Actual Age

```{r bunch_o_figs2, fig.height=4, fig.width=8, fig.align='center'}
    par(mfrow = c(1,3)) 
    hist(CONS_C1_df$Edad, main="Distrbution of Age", 
         xlab="Age", ylab="Freq", breaks=60)
    hist(CONS_C1_df$Edad, main="Distrbution of Age (zoom -)", 
         xlab="Age", ylab="Freq", breaks=60, xlim=c(0,20), ylim=c(0,2000))
    hist(CONS_C1_df$Edad, main="Distrbution of Age (zoom +)", 
         xlab="Age", ylab="Freq", breaks=60, xlim=c(100,120), ylim=c(0,100)) 
    ```


<br>
&nbsp;

```markdown
    CONS_C1_df %>%
      dplyr::filter(Edad<18) %>%
      dplyr::summarise(n())

    CONS_C1_df %>%
      dplyr::filter(Edad>90) %>%
      dplyr::summarise(n())
```


There are `r CONS_C1_df %>% dplyr::filter(Edad<18) %>% dplyr::summarise(n()) ` cases with less than 18 years, `r CONS_C1_df %>% dplyr::filter(Edad>90) %>% dplyr::summarise(n()) ` cases with more than 90 years.

&nbsp;
<br>

#### 11. Days In Treatment

Consider as missing if cases has more than 1095 days. Do the same for months in treatment.
&nbsp;
<br>

##### Figure 3. Histogram of Days In Treatment

```{r bunch_o_figs3, fig.height=4, fig.width=8, fig.align='center'}
    par(mfrow = c(1,2)) 
    hist(CONS_C1_df$dias_trat, main="Distribution of\nDays in Treatment", 
         xlab="Days", ylab="Freq",xlim=c(-100,4100), breaks=60)
    hist(CONS_C1_df$dias_trat, main="Distribution of\nDays in Treatment (zoom +)", 
         xlab="Days", ylab="Freq", breaks=60, xlim=c(1000,4100), ylim=c(0,2000)) 

        #values out of boundaries
``` 


As seen in Figure 3, there are `r CONS_C1_df %>% dplyr::filter(dias_trat>1095) %>% dplyr::summarise(n())` cases with more than 1095 days in treatment. On the other hand, there are `r CONS_C1_df %>% dplyr::filter(dias_trat<=0) %>% dplyr::summarise(n())` cases with negative or no days of treatment. **Should be removed?** 

&nbsp;
<br>

#### 12. Pregnancy and Sex

Pregnant men should be considered as missing values. 
As seen in Table 8, 4 cases of men also reported pregnancy.

```{r echo=F, paged.print=TRUE, warning=FALSE}
CONS_C1_df %>%
    dplyr::count(embarazo, Sexo) %>% 
    dplyr::group_by(Sexo) %>% 
    mutate(prop = paste0(round(100 * prop.table(n)),"%")) %>%
    data.table::data.table() %>% 
    reshape::melt(id.vars = c(1:2)) %>% 
    reshape::cast(.,embarazo~Sexo+variable) %>% 
    data.table::as.data.table() %>%
    knitr::kable(.,format = "html", format.args = list(decimal.mark = ".", big.mark = ","),
                   caption="Table 8. Pregnancy by Sex", col.names= c("Pregnancy", " Man (n)", "Man (%)","Women (n)","Women (%)"), 
                 align =rep('c', 5))  %>%
    kable_styling(bootstrap_options = c("striped", "hover"),font_size = 10) %>%
    add_footnote( c("Si= Pregnant", "No= Not Pregnant"), notation = "none")

```

<br>

#### 13. Type of plan and Sex

See plans M-PR and M-PAI . Check if there are men. Keep if they are, but they identify as women. **This should also be checked reversly?

As seen in table 9, must note that many cases do not answer this question, or what could be more plausible, this question could not be present in previous datasets. This is why we may exclude NA's (missing values) for the following analysis.


```{r echo=F, paged.print=TRUE, warning=FALSE}
CONS_C1_df %>%
    dplyr::count(identidad.de.genero, Sexo) %>% 
    dplyr::group_by(Sexo) %>% 
    dplyr::mutate(prop = paste0(round(100 * prop.table(n)),"%")) %>%
    data.table::data.table() %>% 
    reshape::melt(id.vars = c(1:2)) %>% 
    reshape::cast(.,identidad.de.genero~Sexo+variable) %>%
    knitr::kable(.,format = "html", format.args = list(decimal.mark = ".", big.mark = ","),
                   caption="Table 9. Sex by Gender Identity", col.names= c("Gender \n Identity", " Man (n)", "Man (%)","Women (n)","Women (%)"), 
                 align =rep('c', 5))  %>%
    kable_styling(bootstrap_options = c("striped", "hover"),font_size = 10) %>%
  add_footnote( c("Femenino= Feminine" ,"Masculino= Masculine"), notation = "none")

```
<br>
&nbsp;

In Table 10, can be seen that there are 2 men with a masculine gender identity that are suscribed to M-PAI plan. However, **what happens with the  women with masculine gender identity in M-PAI plan?**

```{r echo=F, paged.print=TRUE, message=FALSE, warning=F}
    CONS_C1_df %>%
      dplyr::group_by(as.factor(identidad.de.genero),as.factor(Sexo), as.factor(tipo_de_plan)) %>%
      dplyr::filter(!is.na(as.factor(identidad.de.genero))) %>%
      dplyr::summarise(count = n() ) %>%
      dplyr::mutate(perc = paste0(round(100 * count/sum(count), 0), "%")) %>%    
      dplyr::rename(tipo_plan = `as.factor(tipo_de_plan)`, sexo = `as.factor(Sexo)`, id_gen=`as.factor(identidad.de.genero)`) %>%
      data.table() %>%
      reshape::melt( id.vars = c(1:3)) %>% 
      #reshape::cast(.,as.factor(tipo_de_plan)~variable+as.factor(Sexo)) %>%
      reshape::cast(.,tipo_plan~sexo+id_gen+variable) %>%
      dplyr::rename("Plan"= `tipo_plan`, "Fem.-Men(n)" = `Hombre_Femenino_count`, "Masc.-Men(n)" = `Hombre_Masculino_count`,
                    "Fem.-Women(n)"=`Mujer_Femenino_count`,"Masc.-Women(n)"=`Mujer_Masculino_count`,
                    "Fem.-Men(%)"=`Hombre_Femenino_perc`, "Masc.-Men(%)"=`Hombre_Masculino_perc`,
                     "Fem.-Women(%)"= `Mujer_Femenino_perc`,"Masc.-Women(%)"=`Mujer_Masculino_perc`) %>% 
    knitr::kable(.,format = "html", format.args = list(decimal.mark = ".", big.mark = ","),
                   caption="Table 10. Type of Plan by Gender Identity and Sex ", 
                 align =rep('c', 9))  %>%
    kable_styling(bootstrap_options = c("striped", "hover"),font_size = 10) %>%
  add_footnote( c("PR= Residential Program" ,"PAB= Basic Outpatient Program", "PAI= Intensive Outpatient Treatment", "PAI LV=     Probation/Parole", "PAI= Intensive Outpatient Treatment"), notation = "none")
```


<br>

#### 14.Days of treatment

Consider as missing days if theres values 0 and negatives.

<br>

As shown in Figure 3, there are `r CONS_C1_df %>% dplyr::filter(dias_trat<1) %>% dplyr::summarise(n())` values 0 or negative.

```{r dias trat, echo=T, paged.print=TRUE}
    CONS_C1_df %>%
    dplyr::filter(dias_trat<1) %>%
      dplyr::select(-id,-TABLE,-14,-16,-17,-26,-27,-28,-29,-35,-36,-37,-88,-93,-94,-96,-101) %>%
      dplyr::select(row, ano_bd, HASH_KEY, hash_rut_completo, id_mod, dias_trat,fech_ing, fech_egres,tipo_de_plan, tipo_de_programa, 
                    ID.centro,motivodeegreso, everything()) %>%
      head() %>%
 knitr::kable(.,format = "html", format.args = list(decimal.mark = ".", big.mark = ","),
               caption="Table 11. Cases with lower dates of treatment",
                 align =rep('c', 101))  %>%
  kable_styling(bootstrap_options = c("striped", "hover"),font_size = 8) %>%
  scroll_box(width = "100%", height = "350px")
```


<br>

#### 15.Age of Consumption Begin and Actual Age

Consider the age of consumption begin as missing data if it is greater than the actual age.
<br>

In `r CONS_C1_df %>% dplyr::mutate(edad_inicio_cons= ifelse(Edad.Inicio.Consumo>Edad, 1, 0)) %>% dplyr::filter(edad_inicio_cons==1) %>% nrow()` cases the age of consumption begin is greater than the actual age.

<br>

```{r inicio consumo, echo=T, paged.print=TRUE, warning=FALSE}
CONS_C1_df %>% dplyr::mutate(edad_inicio_cons= ifelse(Edad.Inicio.Consumo>Edad, 1, 0)) %>% dplyr::filter(edad_inicio_cons==1) %>%
  dplyr::select(row, HASH_KEY, ano_bd, id_mod, Edad.Inicio.Consumo,Edad) %>% 
  head(50) %>%
 knitr::kable(.,format = "html", format.args = list(decimal.mark = ".", big.mark = ","),
               caption="Table 12. Cases with age of consumption begin greater than the actual age",
                 align =rep('c', 101))  %>%
  kable_styling(bootstrap_options = c("striped", "hover"),font_size = 8) %>%
  scroll_box(width = "100%", height = "350px")
```

<br>

Around `r CONS_C1_df %>% dplyr::mutate(edad_inicio_cons= ifelse(Edad.Inicio.Consumo>Edad, 1, 0)) %>% dplyr::filter(edad_inicio_cons==1) %>% dplyr::filter(Edad<18) %>% nrow()` cases could change once dates are resolved with less than 18 years.

---
---

###  See [here](Duplicates.html) for duplicates treatment.
<hr />
