---
title: "Matching Process"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  html_document:
    code_folding: hide  
    toc: true # table of content true
    toc_depth: 5  # upto three depths of headings (specified by #, ## and ###)
    toc_float: true
---

<style type="text/css">
.tablelines table, .tablelines td, .tablelines th {
        border: 1px solid black;
        }
.centrado {
    text-align: center;
}
.table.center {
    margin-left:auto; 
    margin-right:auto;
  }
.table_wrapper{
    display: block;
    overflow-x: auto;
    white-space: nowrap;
}
code.r{
  font-size: 8px;
}
body{ /* Normal  */
      text-align: justify;
  }
.superbigimage{
    overflow-y:scroll;
    white-space: nowrap;
}
.superbigimage img{
    overflow-y: scroll;
    overflow-x: hidden;
}
</style>

<style>
div.blue { background-color:#e6f0ff; border-radius: 5px; padding: 20px; text-align: justify;}
</style>

```{r prev_setup, include = FALSE, cache=T}
rm(list=ls());gc()
load("G:/Mi unidad/Alvacast/SISTRAT 2019 (github)/9.Rdata")
rm(list=setdiff(ls(), c("CONS_C1_df_dup_SEP_2020_match","CONS_C1_df_dup_SEP_2020","CONS_C1")))

if(isTRUE(getOption('knitr.in.progress'))==T){
    nn_size= 1:5 # size= 1:5
    nn_seq=seq(0, 1, .5)
    nn_K= 10
} else {
  input <- readline('Â¿Are you gonna run the results seriously? (Si/No): ')
  if(input=="Si"){
    nn_size= 1:5 # size= 1:5
    nn_seq=seq(0, 1, .5)
    nn_K= 10
  } else {
    nn_size= 1 # size= 1:5
    nn_seq=1
    nn_K= 1
  }
}
```

```{r setup, include = FALSE, cache=T}
#Libraries used in the routine. Dont change the order
local({r <- getOption("repos")
       r["CRAN"] <- "http://cran.r-project.org" 
       options(repos=r)
})
copiar_nombres <- function(x,row.names=FALSE,col.names=TRUE,dec=",",...) {
  if(class(ungroup(x))[1]=="tbl_df"){
        if(options()$OutDec=="."){
            options(OutDec = dec)
            write.table(format(data.frame(x)),"clipboard",sep="\t",row.names=FALSE,col.names=col.names,...)
            options(OutDec = ".")
          return(x)
        } else {
            options(OutDec = ",")
            write.table(format(data.frame(x)),"clipboard",sep="\t",row.names=FALSE,col.names=col.names,...)
            options(OutDec = ",")
          return(x)    
        }
  } else {
        if(options()$OutDec=="."){
            options(OutDec = dec)
            write.table(format(x),"clipboard",sep="\t",row.names=FALSE,col.names=col.names,...)
            options(OutDec = ".")
          return(x)
        } else {
            options(OutDec = ",")
            write.table(format(x),"clipboard",sep="\t",row.names=FALSE,col.names=col.names,...)
            options(OutDec = ",")
          return(x)       
  }
 }
}  
#packageVersion("codebook")
#https://github.com/RevolutionAnalytics/checkpoint
#if(!require(checkpoint)){install.packages("checkpoint")}
#if(!require(here)){install.packages("here")}
#checkpoint::checkpoint("2020-02-19",project=here::here(),checkpointLocation=paste0(here::here(),"/dedup"), use.lock=F, use.knitr=T, auto.install.knitr = T,scan.rnw.with.knitr=T, forceInstall=T,scanForPackages = TRUE)
#checkpointArchives(tempdir(), full.names = TRUE)

#if(!require(tidyr)){install.packages("tidyr")}
#if(!require(DataExplorer)){install.packages("DataExplorer")}
#if(!require(stringi)){install.packages("stringi")}
#if(!require(stringr)){install.packages("stringr")}
#if(!require(ggplot2)){install.packages("ggplot2")}
#if(!require(Hmisc)){install.packages("Hmisc")}
#if(!require(kableExtra)){install.packages("kableExtra")}
#if(!require(plotly)){install.packages("plotly")}
#if(!require(rbokeh)){install.packages("rbokeh")}
#if(!require(altair)){install.packages("altair")}
#if(!require(zoo)){install.packages("zoo")}
#if(!require(codebook)){install.packages("codebook")}
#if(!require(broom)){install.packages("broom")}
#if(!require(sqldf)){install.packages("sqldf")} 
#if(!require(devtools)){install.packages("devtools")}
#if(!require(Statamarkdown)){install_github("hemken/Statamarkdown")}
#if(!require(data.table)){install.packages("data.table")}
#if(!require(dplyr)){install.packages("dplyr")}

#if(!require(boot)){install.packages("boot")}
#if(!require(plyr)){install.packages("plyr")}
#if(!require(matrixStats)){install.packages("matrixStats")}
#if(!require(radiant)){install.packages("radiant", repos = "https://radiant-rstats.github.io/minicran/")}

try(library(boot))
library(matrixStats)
library(knitr)
library(tidyr)
library(stringi)
library(stringr)
library(ggplot2)
library(Hmisc)
library(kableExtra)
library(plotly)
library(janitor)
library(rbokeh)
library(altair)
library(zoo)
library(broom)
library(sqldf)
library(devtools)
library(Statamarkdown)
library(codebook)
library(data.table)
library(dplyr)
library(panelr)
library(RColorBrewer)
library(choroplethr)
library(choroplethrMaps)
library(choroplethrAdmin1)
library(lsmeans)
library(finalfit)
library(chilemapas)
suppressPackageStartupMessages(library(ggiraph))
suppressPackageStartupMessages(library(sf))
library(treemapify)
library(dplyr)
library(choroplethr)
library(choroplethrMaps)
library(choroplethrAdmin1)
library(tidyverse)
library(epiR)
library(survminer)
library(rateratio.test)  
library(ggfortify)
library(survMisc)


library(designmatch)
library(glpkAPI) #
library(foreign)
library(Hmisc)
library(gridExtra)
library(exactRankTests)
library(ggplot2)
library(reshape2)
library(stargazer)
library(Rglpk)
library(tableone)
library(MatchIt)
library(sensitivity2x2xk)
library(sensitivityfull)
library(cobalt)

#devtools::install_github('ChristopherLucas/MatchingFrontier')

if(!require(radiant.update)){install.packages("radiant.update", repos = "https://radiant-rstats.github.io/minicran/")}
#install.packages( repos = "https://radiant-rstats.github.io/minicran/")
#install.packages("radiant.update", repos = "https://radiant-rstats.github.io/minicran/")

#tryCatch(source("https://raw.githubusercontent.com/radiant-rstats/minicran/gh-pages/update.R"), error = function(e) print("updated package, radiant"))

#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:
#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:
#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:
#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:
#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:

tot_sin_motivo_egreso <-
CONS_C1_df_dup_SEP_2020 %>% 
  dplyr::mutate(diff_bet_treat_not_na=ifelse(!is.na(diff_bet_treat),1,0)) %>% 
  dplyr::mutate(mot_egres_en_curso=ifelse(as.character(motivodeegreso_mod_imp)=="Ongoing treatment",1,0)) %>% 
  dplyr::mutate(diff_bet_treat_not_na2=ifelse(!is.na(diff_bet_treat),1,0)) %>% 
  dplyr::filter(diff_bet_treat_not_na==1,is.na(mot_egres_en_curso)) %>% 
  dplyr::select(row,hash_key, fech_ing, fech_egres_imp, diff_bet_treat)

invisible(
CONS_C1 %>% 
    dplyr::filter(row %in% unlist(tot_sin_motivo_egreso[,"row"])) %>% 
    dplyr::select(HASH_KEY,Motivo.de.Egreso)
)
  
sel_treat_tabyl <-
CONS_C1_df_dup_SEP_2020 %>% dplyr::filter(as.character(motivodeegreso_mod_imp)!="Ongoing treatment"|is.na(motivodeegreso_mod_imp)) %>% 
  dplyr::mutate(diff_bet_treat_not_na=ifelse(!is.na(diff_bet_treat),1,0)) %>% 
  janitor::tabyl(diff_bet_treat_not_na)

sel_treat_more_one_treat<-
CONS_C1_df_dup_SEP_2020 %>% dplyr::filter(as.character(motivodeegreso_mod_imp)!="Ongoing treatment"|is.na(motivodeegreso_mod_imp)) %>% tabyl(dup) %>% summarise(more_one_treat=sum(n[dup>1]))

#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:
#GET LOCAL
#dir.create(paste0(getwd(),"/renv_local"))
#Sys.setenv(RENV_PATHS_LOCAL = paste0(getwd(),"/renv_local"))
#install.packages(paste0(getwd(),"/renv_local/gurobi_9.1-0.zip"), repos = NULL, type="source")
#install.packages(paste0("G:/Mi unidad/Alvacast/SISTRAT 2019 (github)/renv_local/gurobi_9.1-0.zip"), repos = NULL, type="source")
library(gurobi)
#"G:/Mi unidad/Alvacast/SISTRAT 2019 (github)"
#Sys.getenv("R_LIBS_USER")
```

# Model

```{r model,eval=T, echo=T, paged.print=TRUE, fig.cap="Figure 1. Directed Acyclic Graph"}                                 
library(DiagrammeR) 
# Nodes
 #node [shape = box]
 # S [label = 'Matched\n(S=1)',fontsize=7]
 # C [label = 'Not censored\n(C=0)',fontsize=7]
gr1<-
DiagrammeR::grViz("
digraph causal {

# Nodes
  node [shape = plaintext]
  a [label = 'Residential\nPrograms\n(X)',fontsize=10]
  b [label = 'Unobserved\nConfounders\n(U)',fontsize=10]
  c [label = 'Early\nDrop-out\n(Y)',fontsize=10]
  d [label = 'Observed\nConfounders\n(Z)',fontsize=10]

# Edges
  edge [color = black,
        arrowhead = vee]
  rankdir = TB;
  
  b -> c 
  b -> a 
  a -> c  

  d -> c [minlen=1]
  d -> a [minlen=1]
  
 # a -> S #[minlen=1]
 # Z -> S #[minlen=1]
  
#  a -> C #[minlen=3]
#  Z -> C #[minlen=3]
  { rank = same; b; a; c }
# { rank = same; S; C }
  { rankdir = LR; a; d }

# Graph
  graph [overlap = true]
}")
#  {rank=same ; A -> B -> C -> D};
#       {rank=same ;           F -> E[dir=back]};
#https://www.ncbi.nlm.nih.gov/pmc/articles/PMC3733703/
#Cohort matching on a variable associated with both outcome and censoring
#Cohort matching on a confounder. We let A denote an exposure, Y denote an outcome, and C denote a confounder and matching variable. The variable S indicates whether an individual in the source population is selected for the matched study (1: selected, 0: not selected). See Section 2-7 for details.
#https://www.ncbi.nlm.nih.gov/pmc/articles/PMC7064555/
DiagrammeR::grViz("
digraph causal {

  # Nodes
  node [shape = plaintext]
  a [label = 'Residential\nPrograms\n(X)',fontsize=10]
  b [label = 'Unobserved\nConfounders\n(U)',fontsize=10]
  c [label = 'Early\nDrop-out\n(Y)',fontsize=10]
  d [label = 'Observed\nConfounders\n(Z)',fontsize=10]

  # Edges
  edge [color = black,
        arrowhead = vee]
  rankdir = TB
  a -> c [minlen=3]
  d -> a [minlen=3]
  d -> c [minlen=9]
  
  b -> a [minlen=1]
  b -> c
  
{ rank = same; c; d }
#{ rank = same; b; d }
  rankdir = TB
{ rank = same; d; c } #Ver si lo saco, creo que da problemas
  
  # Graph
  graph [overlap = true]
}")#LR
```

# Balance

We selected the cases that had completed treatments, leaving `r as.numeric(sum(sel_treat_tabyl$n))%>%  formatC(big.mark=",")` observations. Must take note that we did not excluded those that did not have a status of a finished treatment (n= `r `tot_sin_motivo_egreso %>% nrow() %>% formatC(big.mark=",")`), or had more than one finished treatment previous to the selected (n= `r sel_treat_more_one_treat %>%  as.numeric() %>% formatC(big.mark=",")`).

<br>

We selected the following variables of interest:

- "Starting Substance" (`sus_ini_mvv`)
- "Marital Status" (`estado_conyugal_2`)
- "Educational Attainment" (`escolaridad_rec`)
- "Occupational Status" (`condicion_ocupacional_corr`)
- "Age of Onset of Drug Use" (`edad_ini_cons`)
- "Frequency of use of primary drug" (`freq_cons_sus_prin`)
- "Motive of Admission to Treatment" (`origen_ingreso_mod`)
- "Psychiatric comorbidity" (`dg_cie_10_rec`)
- "Chilean Region of the Center" (`nombre_region`)
- "Type of Center (Public)" (`tipo_centro_pub`)
- "Early Dropout" (`abandono_temprano_rec`) (Y)
- "Residential Type of Plan" (`tipo_de_plan_res`) (Z)
- "Evaluation of the Therapeutic Process (Min. Achievement)" (*) (`evaluacindelprocesoteraputico_min`)
- "No. of Previous Treatments" (`prev_treat`)
- "Sex" (`sexo_2`)
- "Age at Admission to Treatment" (`edad_al_ing`)
- "Date of Admission to Treatment" (`fech_ing_num`)

<br>

We generated a correlation plot to get an overview of heterogeneous correlations between the different variables.

<br>

```{r hetcor, echo=T, cache= T, paged.print=TRUE,eval=T, error=T, dpi=320, fig.align="left",fig.cap="Figure 1. Heterogeneous Correlation Matrix of Variables of Interest", eval= T}

require(polycor)
#Corresponde a la apreciaciÃ³n clÃ­nica que hace el equipo o profesional tratante, la persona en tratamiento y su familia, del nivel alcanzado de logro de los objetivos terapÃ©uticos planteados al inicio del proceso y descritos en el plan de tratamiento personalizado. Los criterios incluyen la evaluaciÃ³n del estado clÃ­nico y psicosocial al momento del egreso y una apreciaciÃ³n pronostica del equipo tratante.

match.on_tot <- c("row", "hash_key","sus_ini_mod_mvv","estado_conyugal_2","escolaridad_rec","condicion_ocupacional_corr","edad_ini_cons","freq_cons_sus_prin","origen_ingreso_mod","dg_cie_10_rec","nombre_region","tipo_centro_pub","abandono_temprano_rec","tipo_de_plan_res","evaluacindelprocesoteraputico_min","prev_treat","sexo_2","edad_al_ing","fech_ing_num")

#CONS_C1_df_dup_SEP_2020 %>% janitor::tabyl(evaluacindelprocesoteraputico)

CONS_C1_df_dup_SEP_2020_match<-
  CONS_C1_df_dup_SEP_2020 %>% 
#:#:#:#:#:#:#:#:
  #sacar tratamientos truncados
  dplyr::filter(as.character(motivodeegreso_mod_imp)!="Ongoing treatment"|is.na(motivodeegreso_mod_imp)) %>% 
#:#:#:#:#:#:#:#:
  #dplyr::mutate(tipo_de_plan_ambulatorio=ifelse(grepl("-PA",as.character(tipo_de_plan_2)),TRUE,FALSE)) %>% 
  dplyr::mutate(tipo_de_plan_res=if_else(as.character(tipo_de_plan_2) %in% c("M-PR","PG-PR"),TRUE,FALSE,NA)) %>% 
  dplyr::mutate(abandono_temprano_rec=ifelse(as.character(abandono_temprano)=="Menos de 90 dÃ­as",TRUE,FALSE)) %>% 
  dplyr::mutate(evaluacindelprocesoteraputico_min=ifelse(as.character(evaluacindelprocesoteraputico)=="3-Logro Minimo",TRUE,FALSE)) %>% 
  dplyr::mutate(tipo_centro_pub=if_else(as.character(tipo_centro)=="Public",TRUE,FALSE,NA)) %>% 
  dplyr::mutate(prev_treat=factor(dplyr::case_when(dup>=3~"2 or more",
                                                   TRUE~as.character(dup-1)))) %>% 
  dplyr::select_(.dots = match.on_tot) %>% 
  data.table::data.table()

#CONS_C1_df_dup_SEP_2020_match %>% janitor::tabyl(prev_treat)
#CONS_C1_df_dup_SEP_2020 %>% janitor::tabyl(motivodeegreso_mod_imp)

#monthly_dataset_comp_wise_dt<-monthly_dataset_comp_wise%>% dplyr::select_if(is.numeric)%>% dplyr::select(-stringency_ind_oxf,-owid_gbd_year)%>% dplyr::select(-ends_with("mth")) %>% data.frame()

#Computes a heterogenous correlation matrix, consisting of Pearson product-moment correlations between numeric variables, polyserial correlations between numeric and ordinal variables, and polychoric correlations between 
tiempo_antes_hetcor<-Sys.time()
hetcor_mat<-hetcor(CONS_C1_df_dup_SEP_2020_match[,-c("hash_key","row")], ML = T, std.err =T, use="pairwise.complete.obs", bins=3, pd=TRUE)
tiempo_despues_hetcor<-Sys.time()
tiempo_hetcor<-tiempo_despues_hetcor-tiempo_antes_hetcor
#umx_hetcor_mat<-umx::umxHetCor(CONS_C1_df_dup_SEP_2020_match[,-c("hash_key","row")], ML = T, use = c("pairwise.complete.obs"), treatAllAsFactor = FALSE, verbose = F)

#ttr(umx_hetcor_mat,"dimnames")[[2]][1]<-"Starting Substance"
#attr(umx_hetcor_mat,"dimnames")[[2]][2]<-"Marital Status"
#attr(umx_hetcor_mat,"dimnames")[[2]][3]<-"Educational Attainment"
#attr(umx_hetcor_mat,"dimnames")[[2]][4]<-"Occupational Status"
#attr(umx_hetcor_mat,"dimnames")[[2]][5]<-"Age of Onset of Drug Use"
#attr(umx_hetcor_mat,"dimnames")[[2]][6]<-"Frequency of use of primary drug"
#attr(umx_hetcor_mat,"dimnames")[[2]][7]<-"Motive of Admission to Treatment"
#attr(umx_hetcor_mat,"dimnames")[[2]][8]<-"Psychiatric comorbidity"
#attr(umx_hetcor_mat,"dimnames")[[2]][9]<-"Chilean Region of the Center"
#attr(umx_hetcor_mat,"dimnames")[[2]][10]<-"Type of Center (Public)"
#attr(umx_hetcor_mat,"dimnames")[[2]][11]<-"Early Dropout"
#attr(umx_hetcor_mat,"dimnames")[[2]][12]<-"Residential Type of Plan"
#attr(umx_hetcor_mat,"dimnames")[[2]][13]<-"Evaluation of the Therapeutic Process (Min. Achievement)"
#attr(umx_hetcor_mat,"dimnames")[[2]][14]<-"No. of Previous Treatments"
#attr(umx_hetcor_mat,"dimnames")[[2]][15]<-"Sex"
#attr(umx_hetcor_mat,"dimnames")[[2]][16]<-"Age at Admission"

#attr(umx_hetcor_mat,"dimnames")[[1]][1]<-"Starting Substance"
#attr(umx_hetcor_mat,"dimnames")[[1]][2]<-"Marital Status"
#attr(umx_hetcor_mat,"dimnames")[[1]][3]<-"Educational Attainment"
#attr(umx_hetcor_mat,"dimnames")[[1]][4]<-"Occupational Status"
#attr(umx_hetcor_mat,"dimnames")[[1]][5]<-"Age of Onset of Drug Use"
#attr(umx_hetcor_mat,"dimnames")[[1]][6]<-"Frequency of use of primary drug"
#attr(umx_hetcor_mat,"dimnames")[[1]][7]<-"Motive of Admission to Treatment"
#attr(umx_hetcor_mat,"dimnames")[[1]][8]<-"Psychiatric comorbidity"
#attr(umx_hetcor_mat,"dimnames")[[1]][9]<-"Chilean Region of the Center"
#attr(umx_hetcor_mat,"dimnames")[[1]][10]<-"Type of Center (Public)"
#attr(umx_hetcor_mat,"dimnames")[[1]][11]<-"Early Dropout"
#attr(umx_hetcor_mat,"dimnames")[[1]][12]<-"Residential Type of Plan"
#attr(umx_hetcor_mat,"dimnames")[[1]][13]<-"Evaluation of the Therapeutic Process (Min. Achievement)"
#attr(umx_hetcor_mat,"dimnames")[[1]][14]<-"No. of Previous Treatments"
#attr(umx_hetcor_mat,"dimnames")[[1]][15]<-"Sex"
#attr(umx_hetcor_mat,"dimnames")[[1]][16]<-"Age at Admission"

attr(hetcor_mat$correlations,"dimnames")[[2]][1]<-"Starting Substance"
attr(hetcor_mat$correlations,"dimnames")[[2]][2]<-"Marital Status"
attr(hetcor_mat$correlations,"dimnames")[[2]][3]<-"Educational Attainment"
attr(hetcor_mat$correlations,"dimnames")[[2]][4]<-"Occupational Status"
attr(hetcor_mat$correlations,"dimnames")[[2]][5]<-"Age of Onset of Drug Use"
attr(hetcor_mat$correlations,"dimnames")[[2]][6]<-"Frequency of use of primary drug"
attr(hetcor_mat$correlations,"dimnames")[[2]][7]<-"Motive of Admission to Treatment"
attr(hetcor_mat$correlations,"dimnames")[[2]][8]<-"Psychiatric comorbidity"
attr(hetcor_mat$correlations,"dimnames")[[2]][9]<-"Chilean Region of the Center"
attr(hetcor_mat$correlations,"dimnames")[[2]][10]<-"Type of Center (Public)"
attr(hetcor_mat$correlations,"dimnames")[[2]][11]<-"Early Dropout"
attr(hetcor_mat$correlations,"dimnames")[[2]][12]<-"Residential Type of Plan"
attr(hetcor_mat$correlations,"dimnames")[[2]][13]<-"Evaluation of the Therapeutic Process (Min. Achievement)"
attr(hetcor_mat$correlations,"dimnames")[[2]][14]<-"No. of Previous Treatments"
attr(hetcor_mat$correlations,"dimnames")[[2]][15]<-"Sex"
attr(hetcor_mat$correlations,"dimnames")[[2]][16]<-"Age at Admission"
attr(hetcor_mat$correlations,"dimnames")[[2]][17]<-"Date of Admission"

attr(hetcor_mat$correlations,"dimnames")[[1]][1]<-"Starting Substance"
attr(hetcor_mat$correlations,"dimnames")[[1]][2]<-"Marital Status"
attr(hetcor_mat$correlations,"dimnames")[[1]][3]<-"Educational Attainment"
attr(hetcor_mat$correlations,"dimnames")[[1]][4]<-"Occupational Status"
attr(hetcor_mat$correlations,"dimnames")[[1]][5]<-"Age of Onset of Drug Use"
attr(hetcor_mat$correlations,"dimnames")[[1]][6]<-"Frequency of use of primary drug"
attr(hetcor_mat$correlations,"dimnames")[[1]][7]<-"Motive of Admission to Treatment"
attr(hetcor_mat$correlations,"dimnames")[[1]][8]<-"Psychiatric comorbidity"
attr(hetcor_mat$correlations,"dimnames")[[1]][9]<-"Chilean Region of the Center"
attr(hetcor_mat$correlations,"dimnames")[[1]][10]<-"Type of Center (Public)"
attr(hetcor_mat$correlations,"dimnames")[[1]][11]<-"Early Dropout"
attr(hetcor_mat$correlations,"dimnames")[[1]][12]<-"Residential Type of Plan"
attr(hetcor_mat$correlations,"dimnames")[[1]][13]<-"Evaluation of the Therapeutic Process (Min. Achievement)"
attr(hetcor_mat$correlations,"dimnames")[[1]][14]<-"No. of Previous Treatments"
attr(hetcor_mat$correlations,"dimnames")[[1]][15]<-"Sex"
attr(hetcor_mat$correlations,"dimnames")[[1]][16]<-"Age at Admission"
attr(hetcor_mat$correlations,"dimnames")[[1]][17]<-"Date of Admission"

attr(hetcor_mat$tests,"dimnames")[[2]][1]<-"Starting Substance"
attr(hetcor_mat$tests,"dimnames")[[2]][2]<-"Marital Status"
attr(hetcor_mat$tests,"dimnames")[[2]][3]<-"Educational Attainment"
attr(hetcor_mat$tests,"dimnames")[[2]][4]<-"Occupational Status"
attr(hetcor_mat$tests,"dimnames")[[2]][5]<-"Age of Onset of Drug Use"
attr(hetcor_mat$tests,"dimnames")[[2]][6]<-"Frequency of use of primary drug"
attr(hetcor_mat$tests,"dimnames")[[2]][7]<-"Motive of Admission to Treatment"
attr(hetcor_mat$tests,"dimnames")[[2]][8]<-"Psychiatric comorbidity"
attr(hetcor_mat$tests,"dimnames")[[2]][9]<-"Chilean Region of the Center"
attr(hetcor_mat$tests,"dimnames")[[2]][10]<-"Type of Center (Public)"
attr(hetcor_mat$tests,"dimnames")[[2]][11]<-"Early Dropout"
attr(hetcor_mat$tests,"dimnames")[[2]][12]<-"Residential Type of Plan"
attr(hetcor_mat$tests,"dimnames")[[2]][13]<-"Evaluation of the Therapeutic Process (Min. Achievement)"
attr(hetcor_mat$tests,"dimnames")[[2]][14]<-"No. of Previous Treatments"
attr(hetcor_mat$tests,"dimnames")[[2]][15]<-"Sex"
attr(hetcor_mat$tests,"dimnames")[[2]][16]<-"Age at Admission"
attr(hetcor_mat$tests,"dimnames")[[2]][17]<-"Date of Admission"

attr(hetcor_mat$tests,"dimnames")[[1]][1]<-"Starting Substance"
attr(hetcor_mat$tests,"dimnames")[[1]][2]<-"Marital Status"
attr(hetcor_mat$tests,"dimnames")[[1]][3]<-"Educational Attainment"
attr(hetcor_mat$tests,"dimnames")[[1]][4]<-"Occupational Status"
attr(hetcor_mat$tests,"dimnames")[[1]][5]<-"Age of Onset of Drug Use"
attr(hetcor_mat$tests,"dimnames")[[1]][6]<-"Frequency of use of primary drug"
attr(hetcor_mat$tests,"dimnames")[[1]][7]<-"Motive of Admission to Treatment"
attr(hetcor_mat$tests,"dimnames")[[1]][8]<-"Psychiatric comorbidity"
attr(hetcor_mat$tests,"dimnames")[[1]][9]<-"Chilean Region of the Center"
attr(hetcor_mat$tests,"dimnames")[[1]][10]<-"Type of Center (Public)"
attr(hetcor_mat$tests,"dimnames")[[1]][11]<-"Early Dropout"
attr(hetcor_mat$tests,"dimnames")[[1]][12]<-"Residential Type of Plan"
attr(hetcor_mat$tests,"dimnames")[[1]][13]<-"Evaluation of the Therapeutic Process (Min. Achievement)"
attr(hetcor_mat$tests,"dimnames")[[1]][14]<-"No. of Previous Treatments"
attr(hetcor_mat$tests,"dimnames")[[1]][15]<-"Sex"
attr(hetcor_mat$tests,"dimnames")[[1]][16]<-"Age at Admission"
attr(hetcor_mat$tests,"dimnames")[[1]][17]<-"Date of Admission"

hetcor_mat$tests[is.na(hetcor_mat$tests)]<-1

ggcorrplot<-
ggcorrplot::ggcorrplot(hetcor_mat$correlations,
           ggtheme = ggplot2::theme_void,
           insig = "blank",
           pch=1,
           pch.cex=3,
           tl.srt = 45, 
           #pch="ns",
            p.mat = hetcor_mat$tests, #  replacement has 144 rows, data has 169
            #type = "lower",
           colors = c("#6D9EC1", "white", "#E46726"), 
           tl.cex=8,
           lab=F)+
  #scale_x_discrete(labels = var_lbls_p345, drop = F) +
  #scale_y_discrete(labels = var_lbls_p345, drop = F) +
  theme(axis.text.x = element_blank())+
  #theme(axis.text.y = element_text(size=7.5,color ="black", hjust = 1))+
  theme(axis.text.y = element_blank())+
  theme(legend.position="bottom")

#umx_ggcorrplot<-
#ggcorrplot::ggcorrplot(umx_hetcor_mat,
#           ggtheme = ggplot2::theme_void,
#           insig = "blank",
#           #pch=1,
#           pch.cex=3,
#           tl.srt = 45, 
#           pch="ns",
#          p.mat = hetcor_mat$tests, #  replacement has 144 rows, data has 169
#            #type = "lower",
#           colors = c("#6D9EC1", "white", "#E46726"), 
#           tl.cex=8,
#           lab=F)+
#  #scale_x_discrete(labels = var_lbls_p345, drop = F) +
#  #scale_y_discrete(labels = var_lbls_p345, drop = F) +
#  theme(axis.text.x = element_blank())+
#  #theme(axis.text.y = element_text(size=7.5,color ="black", hjust = 1))+
#  theme(axis.text.y = element_blank())+
#  theme(legend.position="bottom")

ggplotly(ggcorrplot, height = 800, width=800)%>% 
  layout(xaxis= list(showticklabels = FALSE)) %>% 
 layout(annotations = 
 list(x = .1, y = -0.031, text = "", 
      showarrow = F, xref='paper', yref='paper', 
      #xanchor='center', yanchor='auto', xshift=0, yshift=-0,
      font=list(size=11, color="darkblue"))
 )
```

<br>

## Imputation

<br>

We generated a plot to see all the missing values in the sample.

<br>

```{r miss_plot_perc_var, warning=F,message=F,fig.align='center', fig.cap="Figure 2. Bar plot of Porcentaje of Missing Values per Variables", error=F}
#<div style="border: 1px solid #ddd; padding: 5px; overflow-y: scroll; height:400px; overflow-x: scroll; width:100%">

missing.values<-
CONS_C1_df_dup_SEP_2020_match %>%
  rowwise %>%
  dplyr::mutate_at(.vars = vars(sus_ini_mod_mvv:fech_ing_num),
                   .funs = ~ifelse(is.na(.), 1, 0)) %>% 
  dplyr::ungroup() %>% 
  dplyr::summarise_at(vars(sus_ini_mod_mvv:fech_ing_num),~sum(.))

plot_miss<-
missing.values %>%
  melt() %>% 
  dplyr::mutate(perc= value/sum(sel_treat_tabyl[,2])) %>% 
  dplyr::mutate(label_text= paste0("Variable= ",variable,"<br>n= ",value,"<br>",scales::percent(round(perc,3)))) %>%
  dplyr::mutate(perc=perc*100) %>% 
  ggplot() +
  geom_bar(aes(x=factor(variable), y=perc,label= label_text), stat = 'identity') +
  sjPlot::theme_sjplot()+
#  scale_y_continuous(limits=c(0,1), labels=percent)+
  theme(axis.text.x = element_text(angle = 90, hjust = 1, size=9))+
  labs(x=NULL, y="% of Missing Values", caption=paste0("Nota. Porcentaje de perdidos del total (",sum(sel_treat_tabyl[,2]),")"))
  ggplotly(plot_miss, tooltip = c("label_text"))%>% layout(xaxis= list(showticklabels = T), height = 600, width=800) %>%   layout(yaxis = list(tickformat='%',  range = c(0, 7)))
  #</div>
```

<br>

From the figure above, we could see that the starting substance (`sus_ini_mvv`) and the onset of drug use (`edad_ini_cons`) had around 6% of missing data. These values should be imputed. We first focused on the age of onset of drug use.

<br>

```{r mice1_miss_values_and_gen_imputations, warning=F,message=F,fig.align='center', fig.cap="Figure 3. Bar plot of Porcentaje of Missing Values per Variables", error=F}

attr(CONS_C1_df_dup_SEP_2020_match$sus_ini_mod_mvv,"label")<-"Starting Substance"
attr(CONS_C1_df_dup_SEP_2020_match$estado_conyugal_2,"label")<-"Marital Status"
attr(CONS_C1_df_dup_SEP_2020_match$escolaridad_rec,"label")<-"Educational Attainment"
attr(CONS_C1_df_dup_SEP_2020_match$condicion_ocupacional_corr,"label")<-"Occupational Status"
attr(CONS_C1_df_dup_SEP_2020_match$edad_ini_cons,"label")<-"Age of Onset of Drug Use"
attr(CONS_C1_df_dup_SEP_2020_match$freq_cons_sus_prin,"label")<-"Frequency of use of primary drug"
attr(CONS_C1_df_dup_SEP_2020_match$origen_ingreso_mod,"label")<-"Motive of Admission to Treatment"
attr(CONS_C1_df_dup_SEP_2020_match$dg_cie_10_rec,"label")<-"Psychiatric comorbidity"
attr(CONS_C1_df_dup_SEP_2020_match$nombre_region,"label")<-"Chilean Region of the Center"
attr(CONS_C1_df_dup_SEP_2020_match$tipo_centro_pub,"label")<-"Type of Center (Public)"
attr(CONS_C1_df_dup_SEP_2020_match$abandono_temprano_rec,"label")<-"Early Dropout"
attr(CONS_C1_df_dup_SEP_2020_match$tipo_de_plan_res,"label")<-"Residential Type of Plan"
attr(CONS_C1_df_dup_SEP_2020_match$evaluacindelprocesoteraputico_min,"label")<-"Evaluation of the Therapeutic Process (Min. Achievement)"
attr(CONS_C1_df_dup_SEP_2020_match$prev_treat,"label")<-"No. of Previous Treatments"
attr(CONS_C1_df_dup_SEP_2020_match$sexo_2,"label")<-"Sex"
attr(CONS_C1_df_dup_SEP_2020_match$edad_al_ing,"label")<-"Age at Admission"
attr(CONS_C1_df_dup_SEP_2020_match$fech_ing_num,"label")<-"Date of Admission to Treatment (Numeric)"

#origen_ingreso #dg_global_nec_int_soc_or_1 "DiagnÃ³stico global de necesidades de integraciÃ³n social" #evaluacindelprocesoteraputico "EvaluaciÃ³n del proceso terapÃ©utico" #escolaridad_rec "macrozona"

#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:
#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:

#CONS_C1_df_dup_SEP_2020 %>% janitor::tabyl(evaluacindelprocesoteraputico) 
#CONS_C1_df_dup_SEP_2020 %>% janitor::tabyl(evaluacindelprocesoteraputico) 
#CONS_C1_df_dup_SEP_2020 %>% janitor::tabyl(nombre_region)
#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:
#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:#:

library(Amelia)
CONS_C1_df_dup_SEP_2020_match<-
CONS_C1_df_dup_SEP_2020_match %>% 
    dplyr::group_by(hash_key) %>% 
    dplyr::mutate(rn=row_number()) %>% 
    dplyr::ungroup() %>% 
    data.table::data.table()

dataset_match_miss_sus_prin<-  
  CONS_C1_df_dup_SEP_2020 %>% 
    dplyr::filter(row %in% unlist(CONS_C1_df_dup_SEP_2020_match$row)) %>% 
      dplyr::select(row, edad_ini_sus_prin,via_adm_sus_prin_act,compromiso_biopsicosocial)
  
  #HACER BASE ESPECIAL QUE CONTENGA UNA VARIABLE DE EDAD DE INICIO DE CONSUMO DE SUSTANCIA PRINCIPAL PARA EQUIPARAR
  CONS_C1_df_dup_SEP_2020_match_miss<-
    CONS_C1_df_dup_SEP_2020_match %>%
    dplyr::left_join(dataset_match_miss_sus_prin,by="row") %>% 
    dplyr::mutate(condicion_ocupacional_corr=factor(condicion_ocupacional_corr))
  
amelia_fit <- amelia(CONS_C1_df_dup_SEP_2020_match_miss, 
                     m=30, parallel = "multicore", #noms = "row",
                     idvars=c("row"),#"hash_key","rn"
                     noms= c("sus_ini_mod_mvv", "estado_conyugal_2", "escolaridad_rec", "condicion_ocupacional_corr","via_adm_sus_prin_act", "freq_cons_sus_prin", "origen_ingreso_mod",  "nombre_region", "sexo_2"),
                     ords= c("dg_cie_10_rec", "prev_treat","compromiso_biopsicosocial"),
                     cs = "hash_key", ts = "rn")

#amelia_fit$imputations$imp1
#CONS_C1_df_dup_SEP_2020_match[!complete.cases(CONS_C1_df_dup_SEP_2020_match[,..match.on_tot])]

compare.density(amelia_fit,var="edad_ini_cons")
```

<br>

Based on the figure above, the age of onset of drug use was similar between the imputed values and the observed. However, there were two logical conditions to fulfill in order to replace adequately these values in the database: the age of onset must not be greater than the age of onset of drug use in the primary substance at admission, and may not be greater than the age of admission to treatment. We selected the minimum value of age of onset of drug use among the imputed, because one user could not have more than one age of onset of drug use.

<br>

```{r mice2_age_onset_drug_use, warning=F,message=F,fig.align='center', fig.cap="Figure 4. Bar plot of Percentage of Incorrect Imputed Values per Imputation Sample", error=F}
#On this graph, a y = x line indicates the line of perfect agreement; that is, if the imputation model was a perfect predictor of the true value, all the imputations would fall on this line
no_mostrar=0
if(no_mostrar==1){
  res <- { 
    setTimeLimit(nn_K*500)
    ovr_imp_edad_ini_cons<-overimpute(amelia_fit, var = "edad_ini_cons")
  }
}
#Hay poca relaciÃ³n en las imputaciones.

# Ver si alguno de los usuarios con valores perdidos tiene de todas formas datos en esta variable.
edad_ini_sus_prin_for_imp<-
CONS_C1_df_dup_SEP_2020 %>% 
    dplyr::filter( hash_key %in% unlist(unique(CONS_C1_df_dup_SEP_2020_match[which(!complete.cases(CONS_C1_df_dup_SEP_2020_match$edad_ini_cons)),"hash_key"]))) %>%
    dplyr::filter(!is.na(edad_ini_sus_prin)) %>% 
    dplyr::group_by(hash_key) %>% 
    dplyr::summarise(min_edad_ini_sus_prin=min(edad_ini_sus_prin, na.rm=T), edad_al_ing_min=min(edad_al_ing,na.rm=T))

cumplimiento_errores<-data.frame()
for (i in paste0("imp",1:30)){
  rn_cum_err<-data.frame(amelia_fit$imputations[i]) %>% 
    dplyr::rename(hash_key = 2) %>% 
    dplyr::rename(edad_ini_cons = 7) %>% 
    dplyr::mutate(hash_key=as.character(hash_key)) %>% 
    dplyr::left_join(edad_ini_sus_prin_for_imp, by="hash_key") %>% 
    dplyr::filter(edad_al_ing_min<edad_ini_cons|edad_ini_cons>min_edad_ini_sus_prin) %>% # edad de inicio de consumo no debe ser mayor a la menor edad a la ingreso de cada usuario, y la mÃ­nima edad de inicio de consumo de sustancia principal es menor a la edad de inicio de consumo
    nrow()
  rn_cum_err<-cbind(i,rn_cum_err)
 cumplimiento_errores<- rbind(cumplimiento_errores,rn_cum_err)
}
colnames(cumplimiento_errores)<- c("imp","no_errors_age_of_onset_drug_use")

paste0("Number of users that had different age of onset of drug use before replacement: ",CONS_C1_df_dup_SEP_2020_match %>% 
    dplyr::group_by(hash_key) %>% 
    dplyr::mutate(n_dis=n_distinct(edad_ini_cons)) %>% 
    dplyr::ungroup() %>% 
    dplyr::filter(n_dis>1) %>% 
      nrow())

n_miss_edad_ini_cons<-nrow(CONS_C1_df_dup_SEP_2020_match[which(!complete.cases(CONS_C1_df_dup_SEP_2020_match$edad_ini_cons)),"hash_key"])
plot_imps<-
cumplimiento_errores %>%
  dplyr::mutate(no_errors_age_of_onset_drug_use=as.numeric(no_errors_age_of_onset_drug_use)) %>% 
  dplyr::mutate(imp=factor(imp, levels =paste0("imp",1:30))) %>% 
  dplyr::mutate(perc= no_errors_age_of_onset_drug_use/n_miss_edad_ini_cons) %>% 
  dplyr::mutate(label_text= paste0("Variable= ",imp,"<br>n= ",no_errors_age_of_onset_drug_use,"<br>",scales::percent(round(perc,2)))) %>%
  dplyr::mutate(perc=perc*100) %>% 
  ggplot() +
  geom_bar(aes(x=imp, y=perc,label= label_text), stat = 'identity') +
  sjPlot::theme_sjplot()+
#  scale_y_continuous(limits=c(0,1), labels=percent)+
  theme(axis.text.x = element_text(angle = 90, hjust = 1, size=9))+
  labs(x=NULL, y="% of Values With Logical Discrepancies")+
  theme(aspect.ratio = 2/1)
  ggplotly(plot_imps, tooltip = c("label_text"))%>% layout(xaxis= list(showticklabels = T)) %>%   layout(yaxis = list(tickformat='%',  range = c(0, 40)), height = 600, width=800) 

edad_ini_cons_imputed<-
  cbind.data.frame(amelia_fit$imputations$imp1$row,
       amelia_fit$imputations$imp1$edad_ini_cons,
       amelia_fit$imputations$imp2$edad_ini_cons,
       amelia_fit$imputations$imp3$edad_ini_cons,
       amelia_fit$imputations$imp4$edad_ini_cons,
       amelia_fit$imputations$imp5$edad_ini_cons,
       amelia_fit$imputations$imp6$edad_ini_cons,
       amelia_fit$imputations$imp7$edad_ini_cons,
       amelia_fit$imputations$imp8$edad_ini_cons,
       amelia_fit$imputations$imp9$edad_ini_cons,
       amelia_fit$imputations$imp10$edad_ini_cons,
       amelia_fit$imputations$imp11$edad_ini_cons,
       amelia_fit$imputations$imp12$edad_ini_cons,
       amelia_fit$imputations$imp13$edad_ini_cons,
       amelia_fit$imputations$imp14$edad_ini_cons,
       amelia_fit$imputations$imp15$edad_ini_cons,
       amelia_fit$imputations$imp16$edad_ini_cons,
       amelia_fit$imputations$imp17$edad_ini_cons,
       amelia_fit$imputations$imp18$edad_ini_cons,
       amelia_fit$imputations$imp19$edad_ini_cons,
       amelia_fit$imputations$imp20$edad_ini_cons,
       amelia_fit$imputations$imp21$edad_ini_cons,
       amelia_fit$imputations$imp22$edad_ini_cons,
       amelia_fit$imputations$imp23$edad_ini_cons,
       amelia_fit$imputations$imp24$edad_ini_cons,
       amelia_fit$imputations$imp25$edad_ini_cons,
       amelia_fit$imputations$imp26$edad_ini_cons,
       amelia_fit$imputations$imp27$edad_ini_cons,
       amelia_fit$imputations$imp28$edad_ini_cons,
       amelia_fit$imputations$imp29$edad_ini_cons,
       amelia_fit$imputations$imp30$edad_ini_cons
       ) 

edad_ini_cons_imputed<-cbind(data.table(edad_ini_cons_imputed[,1],data.table(edad_ini_cons_imputed[,2:31])[, AVG := rowMeans(.SD, na.rm=T)]))%>% 
  janitor::clean_names() %>%
 dplyr::mutate(Min = dplyr::select(., amelia_fit_imputations_imp1_edad_ini_cons:amelia_fit_imputations_imp30_edad_ini_cons) %>% purrr::reduce(pmin))
  

# Reemplazo los valores perdidos:
CONS_C1_df_dup_SEP_2020_match_miss1<-
CONS_C1_df_dup_SEP_2020_match_miss %>% 
  dplyr::left_join(edad_ini_cons_imputed,by=c("row"="v1")) %>% 
  dplyr::group_by(hash_key) %>% 
  dplyr::mutate(min_edad_al_ing=min(edad_al_ing,na.rm=T),min_edad_al_ing=ifelse(is.infinite(min_edad_al_ing), NA, min_edad_al_ing)) %>% 
  dplyr::ungroup() %>% 
  dplyr::mutate(edad_ini_cons=dplyr::case_when(is.na(edad_ini_cons) & as.numeric(avg)<edad_ini_sus_prin & as.numeric(avg)<min_edad_al_ing~as.numeric(avg),is.na(edad_ini_cons) & as.numeric(Min)<edad_ini_sus_prin & as.numeric(Min)<min_edad_al_ing~as.numeric(Min),
  is.na(edad_ini_cons) & is.na(edad_ini_sus_prin) & avg<as.numeric(min_edad_al_ing)~as.numeric(avg),is.na(edad_ini_cons) & is.na(edad_ini_sus_prin) & Min<as.numeric(min_edad_al_ing)~as.numeric(Min),
                                               TRUE~as.numeric(edad_ini_cons)))

#is.na(edad_ini_cons) & is.na(edad_ini_sus_prin) & is.na(min_edad_al_ing)~as.numeric(avg),
#table(is.na(CONS_C1_df_dup_SEP_2020_match_miss1$edad_ini_cons))
paste0("Number of rows with values that did not fulfilled the conditions: ",CONS_C1_df_dup_SEP_2020_match_miss1 %>% 
    dplyr::filter(is.na(edad_ini_cons)) %>% 
    dplyr::select(hash_key, edad_ini_cons, min_edad_al_ing,edad_ini_sus_prin,min_edad_al_ing, avg, Min) %>% nrow())

CONS_C1_df_dup_SEP_2020_match_miss1<-
CONS_C1_df_dup_SEP_2020_match_miss1 %>% 
    dplyr::group_by(hash_key) %>% 
    dplyr::mutate(n_dis=n_distinct(edad_ini_cons)) %>% 
    dplyr::ungroup() %>% 
    dplyr::group_by(hash_key) %>% 
  dplyr::mutate(min_edad_ini_cons=min(edad_ini_cons,na.rm=T), edad_ini_cons= dplyr::case_when(n_dis>1 & !is.na(min_edad_ini_cons)~min_edad_ini_cons,TRUE~edad_ini_cons))

paste0("Number of users that had different age of onset of drug use after replacement: ",CONS_C1_df_dup_SEP_2020_match_miss1 %>% 
    dplyr::group_by(hash_key) %>% 
    dplyr::mutate(n_dis=n_distinct(edad_ini_cons)) %>% 
    dplyr::ungroup() %>% 
    dplyr::filter(n_dis>1) %>% 
      nrow())
```

<br>

There were `r as.numeric(table(is.na(CONS_C1_df_dup_SEP_2020_match_miss1$edad_ini_cons)))[2]` cases of imputed ages of onset of drug use that did not fulfilled the conditions necessary to replace the missing values with the imputed ones. We also looked over the 

<br>

```{r mice2_age_at_admission, warning=F,message=F, error=T, eval=F}
#On this graph, a y = x line indicates the line of perfect agreement; that is, if the imputation model was a perfect predictor of the true value, all the imputations would fall on this line
no_mostrar=0
if(no_mostrar==1){
  res <- { 
    setTimeLimit(nn_K*500)
    ovr_imp_edad_ini_cons<-overimpute(amelia_fit, var = "edad_al_ing")
  }
}
#Hay poca relaciÃ³n en las imputaciones.
#table(is.na(CONS_C1_df_dup_SEP_2020_match_not_miss$edad_al_ing),exclude=NULL)

edad_al_ing_imputed<-
  cbind.data.frame(amelia_fit$imputations$imp1$row,
       amelia_fit$imputations$imp1$edad_al_ing,
       amelia_fit$imputations$imp2$edad_al_ing,
       amelia_fit$imputations$imp3$edad_al_ing,
       amelia_fit$imputations$imp4$edad_al_ing,
       amelia_fit$imputations$imp5$edad_al_ing,
       amelia_fit$imputations$imp6$edad_al_ing,
       amelia_fit$imputations$imp7$edad_al_ing,
       amelia_fit$imputations$imp8$edad_al_ing,
       amelia_fit$imputations$imp9$edad_al_ing,
       amelia_fit$imputations$imp10$edad_al_ing,
       amelia_fit$imputations$imp11$edad_al_ing,
       amelia_fit$imputations$imp12$edad_al_ing,
       amelia_fit$imputations$imp13$edad_al_ing,
       amelia_fit$imputations$imp14$edad_al_ing,
       amelia_fit$imputations$imp15$edad_al_ing,
       amelia_fit$imputations$imp16$edad_al_ing,
       amelia_fit$imputations$imp17$edad_al_ing,
       amelia_fit$imputations$imp18$edad_al_ing,
       amelia_fit$imputations$imp19$edad_al_ing,
       amelia_fit$imputations$imp20$edad_al_ing,
       amelia_fit$imputations$imp21$edad_al_ing,
       amelia_fit$imputations$imp22$edad_al_ing,
       amelia_fit$imputations$imp23$edad_al_ing,
       amelia_fit$imputations$imp24$edad_al_ing,
       amelia_fit$imputations$imp25$edad_al_ing,
       amelia_fit$imputations$imp26$edad_al_ing,
       amelia_fit$imputations$imp27$edad_al_ing,
       amelia_fit$imputations$imp28$edad_al_ing,
       amelia_fit$imputations$imp29$edad_al_ing,
       amelia_fit$imputations$imp30$edad_al_ing
       ) 

edad_al_ing_imputed<-cbind(data.table(edad_al_ing_imputed[,1],data.table(edad_al_ing_imputed[,2:31])[, AVG_edad_ing := rowMeans(.SD, na.rm=T)]))%>% 
  janitor::clean_names() %>%
 mutate(Min_edad_ing = dplyr::select(., amelia_fit_imputations_imp1_edad_al_ing:amelia_fit_imputations_imp30_edad_al_ing) %>% purrr::reduce(pmin))
  

# Reemplazo los valores perdidos:
CONS_C1_df_dup_SEP_2020_match_miss12<-
CONS_C1_df_dup_SEP_2020_match_miss1 %>% 
  dplyr::left_join(edad_al_ing_imputed,by=c("row"="v1")) %>% 
  dplyr::group_by(hash_key) %>% 
  dplyr::mutate(min_edad_ini_cons=min(edad_ini_cons,na.rm=T),min_edad_ini_cons=ifelse(is.infinite(min_edad_ini_cons), NA, min_edad_ini_cons)) %>% 
  dplyr::ungroup() %>% 
  dplyr::mutate(edad_al_ing=dplyr::case_when(is.na(edad_al_ing) & as.numeric(avg_edad_ing)>=min_edad_ini_cons & as.numeric(avg_edad_ing)>=edad_ini_sus_prin~as.numeric(avg_edad_ing),is.na(edad_al_ing) & as.numeric(Min_edad_ing)>=edad_ini_sus_prin & as.numeric(Min_edad_ing)>=edad_ini_sus_prin~as.numeric(Min_edad_ing),is.na(edad_al_ing) & is.na(edad_ini_sus_prin) & avg_edad_ing>=as.numeric(min_edad_ini_cons)~as.numeric(avg_edad_ing),is.na(edad_al_ing) & is.na(edad_ini_sus_prin) & Min_edad_ing>=as.numeric(min_edad_ini_cons)~as.numeric(Min_edad_ing),TRUE~as.numeric(edad_al_ing)))

no_mostrar=0
if(no_mostrar==1){
  try(
  CONS_C1_df_dup_SEP_2020_match_miss1 %>% 
      dplyr::left_join(edad_al_ing_imputed,by=c("row"="v1")) %>% 
      dplyr::group_by(hash_key) %>% 
      dplyr::mutate(min_edad_ini_cons=min(edad_ini_cons,na.rm=T),min_edad_ini_cons=ifelse(is.infinite(min_edad_ini_cons), NA, min_edad_ini_cons)) %>% 
      dplyr::ungroup() %>% 
      dplyr::filter(is.na(edad_al_ing)) %>% 
      dplyr::select(hash_key, rn, edad_al_ing, avg_edad_ing, Min_edad_ing,min_edad_ini_cons,edad_ini_sus_prin)
  )
}
#table(is.na(CONS_C1_df_dup_SEP_2020_match_miss12$edad_al_ing))
```

<br>

 We selected the most vulnerable value among the candidates of imputations of the starting substance (First, Cocaine paste, Cocaine hydrochloride or snort cocaine, Marijuana, Alcohol, and Other).

<br>

```{r mice3_starting_substance,eval=T, echo=T, paged.print=TRUE}
# Ver distintos valores propuestos para sustancia de inciio
sus_ini_mod_mvv_imputed<-
 cbind.data.frame(amelia_fit$imputations$imp1$row,
       amelia_fit$imputations$imp1$sus_ini_mod_mvv,
       amelia_fit$imputations$imp2$sus_ini_mod_mvv,
       amelia_fit$imputations$imp3$sus_ini_mod_mvv,
       amelia_fit$imputations$imp4$sus_ini_mod_mvv,
       amelia_fit$imputations$imp5$sus_ini_mod_mvv,
       amelia_fit$imputations$imp6$sus_ini_mod_mvv,
       amelia_fit$imputations$imp7$sus_ini_mod_mvv,
       amelia_fit$imputations$imp8$sus_ini_mod_mvv,
       amelia_fit$imputations$imp9$sus_ini_mod_mvv,
       amelia_fit$imputations$imp10$sus_ini_mod_mvv,
       amelia_fit$imputations$imp11$sus_ini_mod_mvv,
       amelia_fit$imputations$imp12$sus_ini_mod_mvv,
       amelia_fit$imputations$imp13$sus_ini_mod_mvv,
       amelia_fit$imputations$imp14$sus_ini_mod_mvv,
       amelia_fit$imputations$imp15$sus_ini_mod_mvv,
       amelia_fit$imputations$imp16$sus_ini_mod_mvv,
       amelia_fit$imputations$imp17$sus_ini_mod_mvv,
       amelia_fit$imputations$imp18$sus_ini_mod_mvv,
       amelia_fit$imputations$imp19$sus_ini_mod_mvv,
       amelia_fit$imputations$imp20$sus_ini_mod_mvv,
       amelia_fit$imputations$imp21$sus_ini_mod_mvv,
       amelia_fit$imputations$imp22$sus_ini_mod_mvv,
       amelia_fit$imputations$imp23$sus_ini_mod_mvv,
       amelia_fit$imputations$imp24$sus_ini_mod_mvv,
       amelia_fit$imputations$imp25$sus_ini_mod_mvv,
       amelia_fit$imputations$imp26$sus_ini_mod_mvv,
       amelia_fit$imputations$imp27$sus_ini_mod_mvv,
       amelia_fit$imputations$imp28$sus_ini_mod_mvv,
       amelia_fit$imputations$imp29$sus_ini_mod_mvv,
       amelia_fit$imputations$imp30$sus_ini_mod_mvv
       ) 

sus_ini_mod_mvv_imputed<-
sus_ini_mod_mvv_imputed %>% 
  data.frame() %>% 
dplyr::mutate(across(c(amelia_fit.imputations.imp1.sus_ini_mod_mvv:amelia_fit.imputations.imp30.sus_ini_mod_mvv),~dplyr::case_when(grepl("Marijuana",as.character(.))~1,TRUE~0), .names="mar_{col}"))%>%
dplyr::mutate(across(c(amelia_fit.imputations.imp1.sus_ini_mod_mvv:amelia_fit.imputations.imp30.sus_ini_mod_mvv),~dplyr::case_when(grepl("Alcohol",as.character(.))~1,TRUE~0), .names="oh_{col}"))%>%
dplyr::mutate(across(c(amelia_fit.imputations.imp1.sus_ini_mod_mvv:amelia_fit.imputations.imp30.sus_ini_mod_mvv),~dplyr::case_when(grepl("Cocaine paste",as.character(.))~1,TRUE~0), .names="pb_{col}"))%>%
  dplyr::mutate(across(c(amelia_fit.imputations.imp1.sus_ini_mod_mvv:amelia_fit.imputations.imp30.sus_ini_mod_mvv),~dplyr::case_when(grepl("Cocaine hydrochloride",as.character(.))~1,TRUE~0), .names="coc_{col}"))%>%
  dplyr::mutate(across(c(amelia_fit.imputations.imp1.sus_ini_mod_mvv:amelia_fit.imputations.imp30.sus_ini_mod_mvv),~dplyr::case_when(grepl("Other",as.character(.))~1,TRUE~0), .names="otr_{col}"))%>%
        dplyr::mutate(sus_ini_mod_mvv_mar = base::rowSums(dplyr::select(., starts_with("mar_"))))%>%
  dplyr::mutate(sus_ini_mod_mvv_oh = base::rowSums(dplyr::select(., starts_with("oh_"))))%>%
  dplyr::mutate(sus_ini_mod_mvv_pb = base::rowSums(dplyr::select(., starts_with("pb_"))))%>%
  dplyr::mutate(sus_ini_mod_mvv_coc = base::rowSums(dplyr::select(., starts_with("coc_"))))%>%
  dplyr::mutate(sus_ini_mod_mvv_otr = base::rowSums(dplyr::select(., starts_with("otr_")))) %>% 
  #dplyr::summarise(min_mar=max(sus_ini_mod_mvv_mar[sus_ini_mod_mvv_mar<30]),min_oh=max(sus_ini_mod_mvv_oh[sus_ini_mod_mvv_oh<30]),min_pb=max(sus_ini_mod_mvv_pb[sus_ini_mod_mvv_pb<30]),min_coc=max(sus_ini_mod_mvv_coc[sus_ini_mod_mvv_coc<30]),min_otr=max(sus_ini_mod_mvv_otr[sus_ini_mod_mvv_otr<30]))
  dplyr::mutate(sus_ini_mod_mvv_tot=dplyr::case_when(sus_ini_mod_mvv_mar>0~1,TRUE~0)) %>% 
  dplyr::mutate(sus_ini_mod_mvv_tot=dplyr::case_when(sus_ini_mod_mvv_oh>0~sus_ini_mod_mvv_tot+1,TRUE~sus_ini_mod_mvv_tot)) %>% 
  dplyr::mutate(sus_ini_mod_mvv_tot=dplyr::case_when(sus_ini_mod_mvv_pb>0~sus_ini_mod_mvv_tot+1,TRUE~sus_ini_mod_mvv_tot)) %>% 
  dplyr::mutate(sus_ini_mod_mvv_tot=dplyr::case_when(sus_ini_mod_mvv_coc>0~sus_ini_mod_mvv_tot+1,TRUE~sus_ini_mod_mvv_tot)) %>% 
  dplyr::mutate(sus_ini_mod_mvv_tot=dplyr::case_when(sus_ini_mod_mvv_otr>0~sus_ini_mod_mvv_tot+1,TRUE~sus_ini_mod_mvv_tot)) %>% 
  dplyr::mutate(sus_ini_mod_mvv_to_imputation=dplyr::case_when(sus_ini_mod_mvv_tot==1 & sus_ini_mod_mvv_pb>0~"Cocaine paste",
                                                               sus_ini_mod_mvv_tot==1 & sus_ini_mod_mvv_coc>0~"Cocaine hydrochloride",
                                                               sus_ini_mod_mvv_tot==1 & sus_ini_mod_mvv_mar>0~"Marijuana",
                                                               sus_ini_mod_mvv_tot==1 & sus_ini_mod_mvv_oh>0~"Alcohol",
                                                               sus_ini_mod_mvv_tot==1 & sus_ini_mod_mvv_otr>0~"Other",
                                                                
                                                               sus_ini_mod_mvv_tot>1 & sus_ini_mod_mvv_pb>0~"Cocaine paste",
                                                               sus_ini_mod_mvv_tot>1 & sus_ini_mod_mvv_coc>0~"Cocaine hydrochloride",
                                                                sus_ini_mod_mvv_tot>1 & sus_ini_mod_mvv_mar>0~"Marijuana",
                                                                sus_ini_mod_mvv_tot>1 & sus_ini_mod_mvv_oh>0~"Alcohol",
                                                                sus_ini_mod_mvv_tot>1 & sus_ini_mod_mvv_otr>0~"Other")) %>% 
  janitor::clean_names()

sus_ini_mod_mvv_imputed<-
dplyr::select(sus_ini_mod_mvv_imputed,amelia_fit_imputations_imp1_row,sus_ini_mod_mvv_to_imputation)

#:#:#::#:#:#:#:#:#::#:#:#:#:#:#::#:#:#:#:#:#::#:#:#:#:#:#::#:#:#:#:#:#::#:#:#:#:#:#::#:#:#:#:#:#::#:#:#:

CONS_C1_df_dup_SEP_2020_match_miss2<-
CONS_C1_df_dup_SEP_2020_match_miss1 %>% 
   dplyr::left_join(sus_ini_mod_mvv_imputed, by=c("row"="amelia_fit_imputations_imp1_row")) %>% 
    dplyr::mutate(sus_ini_mod_mvv=factor(dplyr::case_when(is.na(sus_ini_mod_mvv)~as.character(sus_ini_mod_mvv_to_imputation),
                                 TRUE~as.character(sus_ini_mod_mvv)))) %>% 
  data.table()
 
#_#_#_#_#_#_#__#_##_#_#_#_#_#_#_#_#_#_#_#_#__#_##_#_#_#_#_##_#_#_#_#_#_#__#_##_#_#_#_#_#_#_#_#_#_#_#_#__#_##_#_#_#_#_#
#_#_#_#_#_#_#__#_##_#_#_#_#_#_#_#_#_#_#_#_#__#_##_#_#_#_#_##_#_#_#_#_#_#__#_##_#_#_#_#_#_#_#_#_#_#_#_#__#_##_#_#_#_#_#
```

<br>

Another variable that is worth imputing is the Frequency of use of primary drug at admission. We selected the imputed values with the value with the most frequent drug use. 

<br>

```{r mice4_frequency_drug_use,eval=T, echo=T, paged.print=TRUE}
# Ver distintos valores propuestos para sustancia de inciio
freq_cons_sus_prin_imputed<-
 cbind.data.frame(amelia_fit$imputations$imp1$row,
       amelia_fit$imputations$imp1$freq_cons_sus_prin,
       amelia_fit$imputations$imp2$freq_cons_sus_prin,
       amelia_fit$imputations$imp3$freq_cons_sus_prin,
       amelia_fit$imputations$imp4$freq_cons_sus_prin,
       amelia_fit$imputations$imp5$freq_cons_sus_prin,
       amelia_fit$imputations$imp6$freq_cons_sus_prin,
       amelia_fit$imputations$imp7$freq_cons_sus_prin,
       amelia_fit$imputations$imp8$freq_cons_sus_prin,
       amelia_fit$imputations$imp9$freq_cons_sus_prin,
       amelia_fit$imputations$imp10$freq_cons_sus_prin,
       amelia_fit$imputations$imp11$freq_cons_sus_prin,
       amelia_fit$imputations$imp12$freq_cons_sus_prin,
       amelia_fit$imputations$imp13$freq_cons_sus_prin,
       amelia_fit$imputations$imp14$freq_cons_sus_prin,
       amelia_fit$imputations$imp15$freq_cons_sus_prin,
       amelia_fit$imputations$imp16$freq_cons_sus_prin,
       amelia_fit$imputations$imp17$freq_cons_sus_prin,
       amelia_fit$imputations$imp18$freq_cons_sus_prin,
       amelia_fit$imputations$imp19$freq_cons_sus_prin,
       amelia_fit$imputations$imp20$freq_cons_sus_prin,
       amelia_fit$imputations$imp21$freq_cons_sus_prin,
       amelia_fit$imputations$imp22$freq_cons_sus_prin,
       amelia_fit$imputations$imp23$freq_cons_sus_prin,
       amelia_fit$imputations$imp24$freq_cons_sus_prin,
       amelia_fit$imputations$imp25$freq_cons_sus_prin,
       amelia_fit$imputations$imp26$freq_cons_sus_prin,
       amelia_fit$imputations$imp27$freq_cons_sus_prin,
       amelia_fit$imputations$imp28$freq_cons_sus_prin,
       amelia_fit$imputations$imp29$freq_cons_sus_prin,
       amelia_fit$imputations$imp30$freq_cons_sus_prin
       ) 

freq_cons_sus_prin_imputed<-
freq_cons_sus_prin_imputed %>% 
  data.frame() %>% 
dplyr::mutate(across(c(amelia_fit.imputations.imp1.freq_cons_sus_prin:amelia_fit.imputations.imp30.freq_cons_sus_prin),~dplyr::case_when(grepl("1 day a week or more",as.character(.))~1,TRUE~0), .names="1_day_{col}"))%>%
dplyr::mutate(across(c(amelia_fit.imputations.imp1.freq_cons_sus_prin:amelia_fit.imputations.imp30.freq_cons_sus_prin),~dplyr::case_when(grepl("2 to 3 days a week",as.character(.))~1,TRUE~0), .names="2_3_{col}"))%>%
dplyr::mutate(across(c(amelia_fit.imputations.imp1.freq_cons_sus_prin:amelia_fit.imputations.imp30.freq_cons_sus_prin),~dplyr::case_when(grepl("4 to 6 days a week",as.character(.))~1,TRUE~0), .names="4_6_{col}"))%>%
  dplyr::mutate(across(c(amelia_fit.imputations.imp1.freq_cons_sus_prin:amelia_fit.imputations.imp30.freq_cons_sus_prin),~dplyr::case_when(grepl("Less than 1 day a week",as.character(.))~1,TRUE~0), .names="less_1_{col}"))%>%
  dplyr::mutate(across(c(amelia_fit.imputations.imp1.freq_cons_sus_prin:amelia_fit.imputations.imp30.freq_cons_sus_prin),~dplyr::case_when(grepl("Did not use",as.character(.))~1,TRUE~0), .names="did_not_{col}"))%>%
    dplyr::mutate(across(c(amelia_fit.imputations.imp1.freq_cons_sus_prin:amelia_fit.imputations.imp30.freq_cons_sus_prin),~dplyr::case_when(grepl("Daily",as.character(.))~1,TRUE~0), .names="daily_{col}"))%>%
  dplyr::mutate(freq_cons_sus_prin_daily = base::rowSums(dplyr::select(., starts_with("daily_")))) %>% 
  dplyr::mutate(freq_cons_sus_prin_4_6 = base::rowSums(dplyr::select(., starts_with("4_6_"))))%>%
  dplyr::mutate(freq_cons_sus_prin_2_3 = base::rowSums(dplyr::select(., starts_with("2_3_"))))%>%
  dplyr::mutate(freq_cons_sus_prin_1_day = base::rowSums(dplyr::select(., starts_with("1_day_"))))%>%
  dplyr::mutate(freq_cons_sus_prin_less_1 = base::rowSums(dplyr::select(., starts_with("less_1_"))))%>%
  dplyr::mutate(freq_cons_sus_prin_did_not = base::rowSums(dplyr::select(., starts_with("did_not_")))) %>% 
  #dplyr::summarise(min_mar=max(sus_ini_mod_mvv_mar[sus_ini_mod_mvv_mar<30]),min_oh=max(sus_ini_mod_mvv_oh[sus_ini_mod_mvv_oh<30]),min_pb=max(sus_ini_mod_mvv_pb[sus_ini_mod_mvv_pb<30]),min_coc=max(sus_ini_mod_mvv_coc[sus_ini_mod_mvv_coc<30]),min_otr=max(sus_ini_mod_mvv_otr[sus_ini_mod_mvv_otr<30]))
  dplyr::mutate(freq_cons_sus_prin_tot=dplyr::case_when(freq_cons_sus_prin_1_day>0~1,TRUE~0)) %>% 
  dplyr::mutate(freq_cons_sus_prin_tot=dplyr::case_when(freq_cons_sus_prin_2_3>0~freq_cons_sus_prin_tot+1,TRUE~freq_cons_sus_prin_tot)) %>% 
  dplyr::mutate(freq_cons_sus_prin_tot=dplyr::case_when(freq_cons_sus_prin_4_6>0~freq_cons_sus_prin_tot+1,TRUE~freq_cons_sus_prin_tot)) %>% 
  dplyr::mutate(freq_cons_sus_prin_tot=dplyr::case_when(freq_cons_sus_prin_less_1>0~freq_cons_sus_prin_tot+1,TRUE~freq_cons_sus_prin_tot)) %>% 
  dplyr::mutate(freq_cons_sus_prin_tot=dplyr::case_when(freq_cons_sus_prin_did_not>0~freq_cons_sus_prin_tot+1,TRUE~freq_cons_sus_prin_tot)) %>% 
  dplyr::mutate(freq_cons_sus_prin_tot=dplyr::case_when(freq_cons_sus_prin_daily>0~freq_cons_sus_prin_tot+1,TRUE~freq_cons_sus_prin_tot)) %>% 
  #hierarchy
  dplyr::mutate(freq_cons_sus_prin_to_imputation=
                  dplyr::case_when(freq_cons_sus_prin_tot==1 & freq_cons_sus_prin_daily>0~"Daily",
                                     freq_cons_sus_prin_tot==1 & freq_cons_sus_prin_4_6>0~"4 to 6 days a week",
                                     freq_cons_sus_prin_tot==1 & freq_cons_sus_prin_2_3>0~"2 to 3 days a week",
                                     freq_cons_sus_prin_tot==1 & freq_cons_sus_prin_1_day>0~"1 day a week or more",
                                     freq_cons_sus_prin_tot==1 & freq_cons_sus_prin_less_1>0~"Less than 1 day a week",
                                     freq_cons_sus_prin_tot==1 & freq_cons_sus_prin_did_not>0~"Did not use",
                                                                
                                     freq_cons_sus_prin_tot>1 & freq_cons_sus_prin_daily>0~"Daily",
                                     freq_cons_sus_prin_tot>1 & freq_cons_sus_prin_4_6>0~"4 to 6 days a week",
                                     freq_cons_sus_prin_tot>1 & freq_cons_sus_prin_2_3>0~"2 to 3 days a week",
                                     freq_cons_sus_prin_tot>1 & freq_cons_sus_prin_1_day>0~"1 day a week or more",
                                     freq_cons_sus_prin_tot>1 & freq_cons_sus_prin_less_1>0~"Less than 1 day a week",
                                     freq_cons_sus_prin_tot>1 & freq_cons_sus_prin_did_not>0~"Did not use"
                                   )) %>% 
  janitor::clean_names()

freq_cons_sus_prin_imputed<-
dplyr::select(freq_cons_sus_prin_imputed,amelia_fit_imputations_imp1_row,freq_cons_sus_prin_to_imputation)


#:#:#::#:#:#:#:#:#::#:#:#:#:#:#::#:#:#:#:#:#::#:#:#:#:#:#::#:#:#:#:#:#::#:#:#:#:#:#::#:#:#:#:#:#::#:#:#:

CONS_C1_df_dup_SEP_2020_match_miss3<-
CONS_C1_df_dup_SEP_2020_match_miss2 %>% 
   dplyr::left_join(freq_cons_sus_prin_imputed, by=c("row"="amelia_fit_imputations_imp1_row")) %>% 
    dplyr::mutate(freq_cons_sus_prin=factor(dplyr::case_when(is.na(freq_cons_sus_prin)~as.character(freq_cons_sus_prin_to_imputation), TRUE~as.character(freq_cons_sus_prin)))) %>% 
  data.table()
```

<br>

Another variable that is worth imputing is the Educational Attainment. We were particularly cautious to impute attainments that would follow a progression from primary school to more than high school.

<br>

```{r mice5_educational_att,eval=T, echo=T, paged.print=TRUE}
# Ver distintos valores propuestos para sustancia de inciio
escolaridad_rec_imputed<-
 cbind.data.frame(amelia_fit$imputations$imp1$row,
                  amelia_fit$imputations$imp1$hash_key,
                  amelia_fit$imputations$imp1$fech_ing_num,
                  amelia_fit$imputations$imp1$escolaridad_rec,
                  amelia_fit$imputations$imp2$escolaridad_rec,
                  amelia_fit$imputations$imp3$escolaridad_rec,
                  amelia_fit$imputations$imp4$escolaridad_rec,
                  amelia_fit$imputations$imp5$escolaridad_rec,
                  amelia_fit$imputations$imp6$escolaridad_rec,
                  amelia_fit$imputations$imp7$escolaridad_rec,
                  amelia_fit$imputations$imp8$escolaridad_rec,
                  amelia_fit$imputations$imp9$escolaridad_rec,
                  amelia_fit$imputations$imp10$escolaridad_rec,
                  amelia_fit$imputations$imp11$escolaridad_rec,
                  amelia_fit$imputations$imp12$escolaridad_rec,
                  amelia_fit$imputations$imp13$escolaridad_rec,
                  amelia_fit$imputations$imp14$escolaridad_rec,
                  amelia_fit$imputations$imp15$escolaridad_rec,
                  amelia_fit$imputations$imp16$escolaridad_rec,
                  amelia_fit$imputations$imp17$escolaridad_rec,
                  amelia_fit$imputations$imp18$escolaridad_rec,
                  amelia_fit$imputations$imp19$escolaridad_rec,
                  amelia_fit$imputations$imp20$escolaridad_rec,
                  amelia_fit$imputations$imp21$escolaridad_rec,
                  amelia_fit$imputations$imp22$escolaridad_rec,
                  amelia_fit$imputations$imp23$escolaridad_rec,
                  amelia_fit$imputations$imp24$escolaridad_rec,
                  amelia_fit$imputations$imp25$escolaridad_rec,
                  amelia_fit$imputations$imp26$escolaridad_rec,
                  amelia_fit$imputations$imp27$escolaridad_rec,
                  amelia_fit$imputations$imp28$escolaridad_rec,
                  amelia_fit$imputations$imp29$escolaridad_rec,
                  amelia_fit$imputations$imp30$escolaridad_rec,
                  amelia_fit$imputations$imp30$rn
               ) 

escolaridad_rec_imputed<-
escolaridad_rec_imputed %>% 
  data.frame() %>% 
dplyr::mutate(across(c(amelia_fit.imputations.imp1.escolaridad_rec:amelia_fit.imputations.imp30.escolaridad_rec),~dplyr::case_when(grepl("3-Completed primary school or less",as.character(.))~1,TRUE~0), .names="3_primary_{col}"))%>%
dplyr::mutate(across(c(amelia_fit.imputations.imp1.escolaridad_rec:amelia_fit.imputations.imp30.escolaridad_rec),~dplyr::case_when(grepl("2-Completed high school or less",as.character(.))~1,TRUE~0), .names="2_high_{col}"))%>%
dplyr::mutate(across(c(amelia_fit.imputations.imp1.escolaridad_rec:amelia_fit.imputations.imp30.escolaridad_rec),~dplyr::case_when(grepl("1-More than high school",as.character(.))~1,TRUE~0), .names="1_more_high_{col}"))%>%

  dplyr::mutate(escolaridad_rec_3_primary = base::rowSums(dplyr::select(., contains("3_primary_")))) %>% 
  dplyr::mutate(escolaridad_rec_2_high = base::rowSums(dplyr::select(., contains("2_high_"))))%>%
  dplyr::mutate(escolaridad_rec_1_more_high = base::rowSums(dplyr::select(., contains("1_more_high_"))))%>%
  
  dplyr::left_join(cbind.data.frame(CONS_C1_df_dup_SEP_2020_match$row, CONS_C1_df_dup_SEP_2020_match$escolaridad_rec),by=c("amelia_fit.imputations.imp1.row"="CONS_C1_df_dup_SEP_2020_match$row")) %>%
  dplyr::rename("escolaridad_rec_original"="CONS_C1_df_dup_SEP_2020_match$escolaridad_rec") %>%
  dplyr::mutate(escolaridad_rec_original=as.numeric(substr(escolaridad_rec_original, 1, 1))) %>%
  dplyr::arrange(amelia_fit.imputations.imp1.hash_key,amelia_fit.imputations.imp30.rn) %>% 
  dplyr::group_by(amelia_fit.imputations.imp1.hash_key) %>%  
  dplyr::mutate(siguiente_escolaridad_rec_original=lead(escolaridad_rec_original), 
                subsig_escolaridad_rec_original=lead(escolaridad_rec_original,n =2), 
                rn=max(amelia_fit.imputations.imp30.rn),
                n_na_esc_or=is.na(escolaridad_rec_original),
                sum_n_na_esc_or=sum(n_na_esc_or,na.rm=T),
                max_sum_n_na_esc_or=max(n_na_esc_or,na.rm=T)
                ) %>% 
#dplyr::select(amelia_fit.imputations.imp1.hash_key,amelia_fit.imputations.imp30.rn,
#              siguiente_escolaridad_rec_original,escolaridad_rec_original,amelia_fit.imputations.imp1.fech_ing_num)%>% View()
  dplyr::ungroup() %>% 
#dplyr::summarise(min_mar=max(sus_ini_mod_mvv_mar[sus_ini_mod_mvv_mar<30]),min_oh=max(sus_ini_mod_mvv_oh[sus_ini_mod_mvv_oh<30]),min_pb=max(sus_ini_mod_mvv_pb[sus_ini_mod_mvv_pb<30]),min_coc=max(sus_ini_mod_mvv_coc[sus_ini_mod_mvv_coc<30]),min_otr=max(sus_ini_mod_mvv_otr[sus_ini_mod_mvv_otr<30]))
  dplyr::mutate(escolaridad_rec_tot=dplyr::case_when(escolaridad_rec_3_primary>0~1,TRUE~0)) %>% 
  dplyr::mutate(escolaridad_rec_tot=dplyr::case_when(escolaridad_rec_2_high>0~escolaridad_rec_tot+1,TRUE~escolaridad_rec_tot)) %>% 
  dplyr::mutate(escolaridad_rec_tot=dplyr::case_when(escolaridad_rec_1_more_high>0~escolaridad_rec_tot+1,TRUE~escolaridad_rec_tot)) %>% 
  #hierarchy
  dplyr::mutate(escolaridad_rec_to_imputation=
# 1A) TIENE MÃS DE UN TRAT POR USUARIO (RN) Y HAY MAS DE UN VALOR DE IMPUTACION PARA ESCOLARIDAD
#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_
  dplyr::case_when(
    escolaridad_rec_tot>1 &
    max_sum_n_na_esc_or==1 &
    escolaridad_rec_3_primary>0 &
    rn>1 & !is.na(siguiente_escolaridad_rec_original) &
    siguiente_escolaridad_rec_original<=3 ~"3-Completed primary school or less",
    
    escolaridad_rec_tot>1 & 
    max_sum_n_na_esc_or==1 &
    escolaridad_rec_2_high>0 & 
    rn>1 & !is.na(siguiente_escolaridad_rec_original) &
    siguiente_escolaridad_rec_original<=2 ~"2-Completed high school or less",
    
    escolaridad_rec_tot>1 & #hay mÃ¡s de un valor de imputaciÃ³n para escolaridad
    max_sum_n_na_esc_or==1 & #no hay mÃ¡s de un valor de escolaridad a imputar
    escolaridad_rec_1_more_high >0 & #el valor que tiene en este caso es mÃ¡s de high school
    rn>1 & !is.na(siguiente_escolaridad_rec_original) & #tiene mÃ¡s de un trat por usuario y no hay siguiente escolaridad perdida
    siguiente_escolaridad_rec_original==1~"1-More than high school", #si ya tenÃ­a mÃ¡s de universitario, debÃ­a tener el mismo valor en el siguiente,
    # 1A2) SI HAY UN PERDIDO EN EL SIGUIENTE TRATAMIENTO, PERO EL SUBSIGUIENTE SÃ TIENE UN VALOR
    #_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_
    escolaridad_rec_tot>1 &
    max_sum_n_na_esc_or==1 &
    escolaridad_rec_3_primary>0 &
    rn>1 & is.na(siguiente_escolaridad_rec_original) &
    subsig_escolaridad_rec_original<=3 ~"3-Completed primary school or less",
    
    escolaridad_rec_tot>1 & 
    max_sum_n_na_esc_or==1 &
    escolaridad_rec_2_high>0 & 
    rn>1 & is.na(siguiente_escolaridad_rec_original) &
    subsig_escolaridad_rec_original<=2 ~"2-Completed high school or less",
    
    escolaridad_rec_tot>1 & #hay mÃ¡s de un valor de imputaciÃ³n para escolaridad
    max_sum_n_na_esc_or==1 & #no hay mÃ¡s de un valor de escolaridad a imputar
    escolaridad_rec_1_more_high >0 & #el valor que tiene en este caso es mÃ¡s de high school
    rn>1 & is.na(siguiente_escolaridad_rec_original) &
    subsig_escolaridad_rec_original==1~"1-More than high school", #si ya tenÃ­a mÃ¡s de universitario, debÃ­a tener el mismo valor en el siguiente,
    # 1A3) SI HAY UN PERDIDO EN EL SIGUIENTE TRATAMIENTO, PERO EL SUBSIGUIENTE NO TIENE UN VALOR (QUIZAS PORQUE NO EXISTE INCLUSO)
    #_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_
    escolaridad_rec_tot>1 &
    max_sum_n_na_esc_or==1 &
    escolaridad_rec_3_primary>0 &
    rn>1 & is.na(siguiente_escolaridad_rec_original) &
    is.na(subsig_escolaridad_rec_original) ~"3-Completed primary school or less",
    
    escolaridad_rec_tot>1 & 
    max_sum_n_na_esc_or==1 &
    escolaridad_rec_2_high>0 & 
    rn>1 & is.na(siguiente_escolaridad_rec_original) &
    is.na(subsig_escolaridad_rec_original) ~"2-Completed high school or less",
    
    escolaridad_rec_tot>1 & #hay mÃ¡s de un valor de imputaciÃ³n para escolaridad
    max_sum_n_na_esc_or==1 & #no hay mÃ¡s de un valor de escolaridad a imputar
    escolaridad_rec_1_more_high >0 & #el valor que tiene en este caso es mÃ¡s de high school
    rn>1 & is.na(siguiente_escolaridad_rec_original) &
    is.na(subsig_escolaridad_rec_original)~"1-More than high school", #si ya tenÃ­a mÃ¡s de universitario, debÃ­a tener el mismo valor en el siguiente,
    
    # 1B) TIENE MÃS DE UN TRAT POR USUARIO (RN) Y NO HAY MAS DE UN VALOR DE IMPUTACION PARA ESCOLARIDAD
    #_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_
    
    escolaridad_rec_tot==1 &
    max_sum_n_na_esc_or==1 &
    escolaridad_rec_3_primary>0 &
    rn>1 & !is.na(siguiente_escolaridad_rec_original) &
    siguiente_escolaridad_rec_original<=3 ~"3-Completed primary school or less",
    
    escolaridad_rec_tot==1 & 
    max_sum_n_na_esc_or==1 &
    escolaridad_rec_2_high>0 & 
    rn>1 & !is.na(siguiente_escolaridad_rec_original) &
    siguiente_escolaridad_rec_original<=2 ~"2-Completed high school or less",
    
    escolaridad_rec_tot==1 & #no hay mÃ¡s de un valor de imputaciÃ³n para escolaridad
    max_sum_n_na_esc_or==1 & #no hay mÃ¡s de un valor de escolaridad a imputar
    escolaridad_rec_1_more_high>0 & #el valor que tiene en este caso es mÃ¡s de high school
    rn>1 & !is.na(siguiente_escolaridad_rec_original) & #tiene mÃ¡s de un trat por usuario y no hay siguiente escolaridad perdida
    siguiente_escolaridad_rec_original==1~"1-More than high school", #si ya tenÃ­a mÃ¡s de universitario, debÃ­a tener el mismo valor en el siguiente,
    
    # 2A) TIENE SOLO UN TRAT POR USUARIO (RN) Y HAY MAS DE UN VALOR DE IMPUTACION PARA ESCOLARIDAD
    #_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_
    escolaridad_rec_tot>1 &
    max_sum_n_na_esc_or==1 &
    escolaridad_rec_3_primary>0 &
    rn==1 ~"3-Completed primary school or less",
    
    escolaridad_rec_tot>1 & 
    max_sum_n_na_esc_or==1 &
    escolaridad_rec_2_high>0 & 
    rn==1 ~"2-Completed high school or less",
    
    escolaridad_rec_tot>1 & #hay mÃ¡s de un valor de imputaciÃ³n para escolaridad
    max_sum_n_na_esc_or==1 & #no hay mÃ¡s de un valor de escolaridad a imputar
    escolaridad_rec_1_more_high>0 & #el valor que tiene en este caso es mÃ¡s de high school
    rn==1 ~"1-More than high school", #si ya tenÃ­a mÃ¡s de universitario, debÃ­a tener el mismo valor en el siguiente,
    
    # 2B) TIENE SOLO UN TRAT POR USUARIO (RN) Y NO HAY MAS DE UN VALOR DE IMPUTACION PARA ESCOLARIDAD
    #_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_
    
    escolaridad_rec_tot==1 &
    max_sum_n_na_esc_or==1 &
    escolaridad_rec_3_primary>0 &
    rn==1 ~"3-Completed primary school or less",
    
    escolaridad_rec_tot==1 & 
    max_sum_n_na_esc_or==1 &
    escolaridad_rec_2_high>0 & 
    rn==1 ~"2-Completed high school or less",
    
    escolaridad_rec_tot==1 & #no hay mÃ¡s de un valor de imputaciÃ³n para escolaridad
    max_sum_n_na_esc_or==1 & #no hay mÃ¡s de un valor de escolaridad a imputar
    escolaridad_rec_1_more_high>0 & #el valor que tiene en este caso es mÃ¡s de high school
    rn==1 ~"1-More than high school" 
  )) %>% 
janitor::clean_names()

escolaridad_rec_imputed<-
dplyr::select(escolaridad_rec_imputed,amelia_fit_imputations_imp1_row,escolaridad_rec_to_imputation)

#:#:#::#:#:#:#:#:#::#:#:#:#:#:#::#:#:#:#:#:#::#:#:#:#:#:#::#:#:#:#:#:#::#:#:#:#:#:#::#:#:#:#:#:#::#:#:#:
#:#:#::#:#:#:#:#:#::#:#:#:#:#:#::#:#:#:#:#:#::#:#:#:#:#:#::#:#:#:#:#:#::#:#:#:#:#:#::#:#:#:#:#:#::#:#:#:
CONS_C1_df_dup_SEP_2020_match_miss4<-
CONS_C1_df_dup_SEP_2020_match_miss3 %>% 
   dplyr::left_join(escolaridad_rec_imputed, by=c("row"="amelia_fit_imputations_imp1_row")) %>% 
    dplyr::mutate(no_info_on_esc=dplyr::case_when(is.na(escolaridad_rec)~1,TRUE~0)) %>% 
    dplyr::mutate(escolaridad_rec=factor(dplyr::case_when(is.na(escolaridad_rec)~as.character(escolaridad_rec_to_imputation), TRUE~as.character(escolaridad_rec)))) %>% 
    dplyr::arrange(hash_key,rn) %>% 
  dplyr::group_by(hash_key) %>% 
  dplyr::mutate(escolaridad_rec_num=as.numeric(substr(escolaridad_rec, 1, 1)),
                sig_escolaridad_rec_num=lead(escolaridad_rec_num),
                ant_escolaridad_rec_num=lag(escolaridad_rec_num)) %>% 
  dplyr::mutate(escolaridad_rec=factor(dplyr::case_when(#si el anterior es menos vulnerable que el presente, NA
  escolaridad_rec_num>ant_escolaridad_rec_num~NA_character_, TRUE~as.character(escolaridad_rec)))) %>% 
  dplyr::mutate(escolaridad_rec=factor(dplyr::case_when(# si es mÃ¡s vulnerable que el presente, es NA 
  escolaridad_rec_num<sig_escolaridad_rec_num~NA_character_, TRUE~as.character(escolaridad_rec)))) %>% 
  dplyr::ungroup() %>% 
  data.table()

#:#:#::#:#:#:#:#:#::#:#:#:#:#:#::#:#:#:#:#:#::#:#:#:#:#:#::#:#:#:#:#:#::#:#:#:#:#:#::#:#:#:#:#:#::#:#:#:
#:#:#::#:#:#:#:#:#::#:#:#:#:#:#::#:#:#:#:#:#::#:#:#:#:#:#::#:#:#:#:#:#::#:#:#:#:#:#::#:#:#:#:#:#::#:#:#:
paste0("Check inconsistencies with posterior educational attainments (0= No inconsistencies): ",CONS_C1_df_dup_SEP_2020_match_miss4 %>% 
  dplyr::arrange(hash_key,rn) %>% 
  dplyr::group_by(hash_key) %>% 
  dplyr::mutate(escolaridad_rec_num=as.numeric(substr(escolaridad_rec, 1, 1)),
                sig_escolaridad_rec_num=lead(escolaridad_rec_num),
                ant_escolaridad_rec_num=lag(escolaridad_rec_num)) %>% 
  dplyr::ungroup() %>% 
  dplyr::filter(escolaridad_rec_num>ant_escolaridad_rec_num) %>% 
  dplyr::select(hash_key,rn,fech_ing_num, escolaridad_rec, escolaridad_rec_num, sig_escolaridad_rec_num,ant_escolaridad_rec_num,no_info_on_esc) %>% 
  nrow())

paste0("Problematic rows of users with inconsistent educational attainment that were declared as missing: ",CONS_C1_df_dup_SEP_2020_match_miss4 %>%
  dplyr::filter(hash_key %in% c("14b66a29bfc79b06c9e9a8c198259b07",
                                "16dc6c5edd96af2171127c760e8480ab",
                                "18b1f9646a2cd6bebd962637cff0a21a",
                                "296c5b02088d8d42eaa25b69e3c5bdc1",
                                "309a5876b3bd6c1eb7a326d31acc2895",
                                "35f69f3fd0dda5eab952983dd39618e2",
                                "374745c85601976177fe614a7370e475",
                                "3d722d03aaa88c6ad4c039c860c1b837",
                                "428f31fc7b7f6da87f0e8590f6e147b7",
                                "4b27553c38e707a6fda01855b784cf66",
                                "520337f7e5e3ae2e27b6e4711d4744aa",
                                "56d93af7846b383ae60019c2980ab73e",
                                "5db98f93254e218ec89689241de2f61b",
                                "6c1593d4035a5ca371148c8a19ccb30b",
                                "7cb913f6fd959aace18df3fa0fa7079e",
                                "98d6644d995ea2c8777a683160728004",
                                "9e06871d982546d078729e6154d285ba",
                                "affb5fe42db45203a63e13c54ba7551b",
                                "b715d04a584dbdd450fd6f2ea68291fc",
                                "e099bd5828923c95a1ed2878a09c1118",
                                "ed31e09b0adeefb57fa54c2295b3b7f2",
                                "f273b4cdc0cf4f046811c208162571ae",
                                "f7c1eaee409f6b1b70f64e565a616942"
  )) %>% 
  #dplyr::select(hash_key,dup, escolaridad_rec) %>% 
  dplyr::select(hash_key,rn,fech_ing_num,escolaridad_rec,escolaridad_rec_num,sig_escolaridad_rec_num,ant_escolaridad_rec_num) %>%nrow())
```

<br>

We ended having `r as.numeric(table(CONS_C1_df_dup_SEP_2020_match_miss4$escolaridad_rec,exclude=NULL)[4])` missing values in educational attainment, because these values did not fulfilled the requirements of progression of the educational attainment (eg., a user could not respond to have completed secondary school, but then answer that he had completed primary school only).

<br>

Additionally, we replaced missing values of the marital status. Since different marital status were not particularly more vulnerable between each other, we selected the most frequent imputed value among the different imputed databases.

<br>

```{r mice5_marital_status,eval=T, echo=T, paged.print=TRUE}
# Ver distintos valores propuestos para estado conyugal
estado_conyugal_2_imputed<-
 cbind.data.frame(amelia_fit$imputations$imp1$row,
       amelia_fit$imputations$imp1$estado_conyugal_2,
       amelia_fit$imputations$imp2$estado_conyugal_2,
       amelia_fit$imputations$imp3$estado_conyugal_2,
       amelia_fit$imputations$imp4$estado_conyugal_2,
       amelia_fit$imputations$imp5$estado_conyugal_2,
       amelia_fit$imputations$imp6$estado_conyugal_2,
       amelia_fit$imputations$imp7$estado_conyugal_2,
       amelia_fit$imputations$imp8$estado_conyugal_2,
       amelia_fit$imputations$imp9$estado_conyugal_2,
       amelia_fit$imputations$imp10$estado_conyugal_2,
       amelia_fit$imputations$imp11$estado_conyugal_2,
       amelia_fit$imputations$imp12$estado_conyugal_2,
       amelia_fit$imputations$imp13$estado_conyugal_2,
       amelia_fit$imputations$imp14$estado_conyugal_2,
       amelia_fit$imputations$imp15$estado_conyugal_2,
       amelia_fit$imputations$imp16$estado_conyugal_2,
       amelia_fit$imputations$imp17$estado_conyugal_2,
       amelia_fit$imputations$imp18$estado_conyugal_2,
       amelia_fit$imputations$imp19$estado_conyugal_2,
       amelia_fit$imputations$imp20$estado_conyugal_2,
       amelia_fit$imputations$imp21$estado_conyugal_2,
       amelia_fit$imputations$imp22$estado_conyugal_2,
       amelia_fit$imputations$imp23$estado_conyugal_2,
       amelia_fit$imputations$imp24$estado_conyugal_2,
       amelia_fit$imputations$imp25$estado_conyugal_2,
       amelia_fit$imputations$imp26$estado_conyugal_2,
       amelia_fit$imputations$imp27$estado_conyugal_2,
       amelia_fit$imputations$imp28$estado_conyugal_2,
       amelia_fit$imputations$imp29$estado_conyugal_2,
       amelia_fit$imputations$imp30$estado_conyugal_2
       ) 

estado_conyugal_2_imputed<-
estado_conyugal_2_imputed %>% 
  data.frame() %>% 
dplyr::mutate(across(c(amelia_fit.imputations.imp1.estado_conyugal_2:amelia_fit.imputations.imp30.estado_conyugal_2),~dplyr::case_when(grepl("Married/Shared living arrangements",as.character(.))~1,TRUE~0), .names="married_{col}"))%>%
dplyr::mutate(across(c(amelia_fit.imputations.imp1.estado_conyugal_2:amelia_fit.imputations.imp30.estado_conyugal_2),~dplyr::case_when(grepl("Separated/Divorced",as.character(.))~1,TRUE~0), .names="sep_div_{col}"))%>%
dplyr::mutate(across(c(amelia_fit.imputations.imp1.estado_conyugal_2:amelia_fit.imputations.imp30.estado_conyugal_2),~dplyr::case_when(grepl("Single",as.character(.))~1,TRUE~0), .names="singl_{col}"))%>%
  dplyr::mutate(across(c(amelia_fit.imputations.imp1.estado_conyugal_2:amelia_fit.imputations.imp30.estado_conyugal_2),~dplyr::case_when(grepl("Widower",as.character(.))~1,TRUE~0), .names="widow_{col}"))%>%
 
  dplyr::mutate(estado_conyugal_2_married = base::rowSums(dplyr::select(., starts_with("married_"))))%>%
  dplyr::mutate(estado_conyugal_2_sep_div = base::rowSums(dplyr::select(., starts_with("sep_div_"))))%>%
  dplyr::mutate(estado_conyugal_2_singl = base::rowSums(dplyr::select(., starts_with("singl_"))))%>%
  dplyr::mutate(estado_conyugal_2_wid = base::rowSums(dplyr::select(., starts_with("widow_"))))%>%
  #dplyr::summarise(min_mar=max(sus_ini_mod_mvv_mar[sus_ini_mod_mvv_mar<30]),min_oh=max(sus_ini_mod_mvv_oh[sus_ini_mod_mvv_oh<30]),min_pb=max(sus_ini_mod_mvv_pb[sus_ini_mod_mvv_pb<30]),min_coc=max(sus_ini_mod_mvv_coc[sus_ini_mod_mvv_coc<30]),min_otr=max(sus_ini_mod_mvv_otr[sus_ini_mod_mvv_otr<30]))
  dplyr::mutate(estado_conyugal_2_tot=dplyr::case_when(estado_conyugal_2_married>0~1,TRUE~0)) %>% 
  dplyr::mutate(estado_conyugal_2_tot=dplyr::case_when(estado_conyugal_2_sep_div>0~estado_conyugal_2_tot+1,TRUE~estado_conyugal_2_tot)) %>% 
  dplyr::mutate(estado_conyugal_2_tot=dplyr::case_when(estado_conyugal_2_singl>0~estado_conyugal_2_tot+1,TRUE~estado_conyugal_2_tot)) %>% 
  dplyr::mutate(estado_conyugal_2_tot=dplyr::case_when(estado_conyugal_2_wid>0~estado_conyugal_2_tot+1,TRUE~estado_conyugal_2_tot)) %>% 
  janitor::clean_names()
  
estado_conyugal_2_imputed_cat_est_cony<-  
    estado_conyugal_2_imputed %>%
        tidyr::pivot_longer(c(estado_conyugal_2_married, estado_conyugal_2_sep_div, estado_conyugal_2_singl, estado_conyugal_2_wid), names_to = "cat_est_conyugal", values_to = "count") %>%
        dplyr::group_by(amelia_fit_imputations_imp1_row) %>% 
        dplyr::mutate(estado_conyugal_2_imputed_max=max(count,na.rm=T)) %>% 
        dplyr::ungroup() %>% 
        dplyr::filter(estado_conyugal_2_imputed_max==count) %>% 
        dplyr::select(amelia_fit_imputations_imp1_row,cat_est_conyugal,count) %>% 
        dplyr::group_by(amelia_fit_imputations_imp1_row) %>% 
        dplyr::mutate(n_row=n()) %>% 
        dplyr::ungroup() %>% 
        dplyr::mutate(cat_est_conyugal=dplyr::case_when(n_row>1~NA_character_,
                                                        TRUE~cat_est_conyugal)) %>% 
        dplyr::distinct(amelia_fit_imputations_imp1_row,.keep_all = T)
  
estado_conyugal_2_imputed<-
  estado_conyugal_2_imputed %>% 
    dplyr::left_join(estado_conyugal_2_imputed_cat_est_cony, by="amelia_fit_imputations_imp1_row") %>%
    dplyr::mutate(cat_est_conyugal=dplyr::case_when(cat_est_conyugal=="estado_conyugal_2_married"~"Married/Shared living arrangements",cat_est_conyugal=="estado_conyugal_2_sep_div"~"Separated/Divorced",cat_est_conyugal=="estado_conyugal_2_singl"~"Single",cat_est_conyugal=="estado_conyugal_2_wid"~"Widower"
    ))%>% 
  janitor::clean_names()

#:#:#::#:#:#:#:#:#::#:#:#:#:#:#::#:#:#:#:#:#::#:#:#:#:#:#::#:#:#:#:#:#::#:#:#:#:#:#::#:#:#:#:#:#::#:#:#:

CONS_C1_df_dup_SEP_2020_match_miss5<-
CONS_C1_df_dup_SEP_2020_match_miss4 %>% 
   dplyr::left_join(dplyr::select(estado_conyugal_2_imputed,amelia_fit_imputations_imp1_row,cat_est_conyugal), by=c("row"="amelia_fit_imputations_imp1_row")) %>% 
    dplyr::mutate(estado_conyugal_2=factor(dplyr::case_when(is.na(estado_conyugal_2)~as.character(cat_est_conyugal),TRUE~as.character(estado_conyugal_2)))) %>% 
  data.table()
```


<br>

We could not resolve Marital status in  `r as.numeric(table(!is.na(CONS_C1_df_dup_SEP_2020_match_miss5$estado_conyugal_2))[1])` cases due to ties in the most frequent values. We looked over possible imputations to region of the center and type of the center (public or private).

<br>

```{r mice6_region,eval=T, echo=T, paged.print=TRUE}
# Ver distintos valores propuestos para estado conyugal
#evaluacindelprocesoteraputico_min nombre_region tipo_centro_pub

#no hay informaciÃ³n. debemos imputar
no_mostrar=0
if (no_mostrar==1){
tipo_centro_nombre_region_nas_nombre_region<-
CONS_C1_df_dup_SEP_2020 %>% 
    #dplyr::filter(row %in% unlist(unique(CONS_C1_df_dup_SEP_2020_match[,"row"]))) %>% 
    dplyr::filter(is.na(nombre_region)) %>% 
    janitor::tabyl(tipo_centro, nombre_region) 
}

nombre_region_imputed<-
 cbind.data.frame(amelia_fit$imputations$imp1$row,
       amelia_fit$imputations$imp1$nombre_region,
       amelia_fit$imputations$imp2$nombre_region,
       amelia_fit$imputations$imp3$nombre_region,
       amelia_fit$imputations$imp4$nombre_region,
       amelia_fit$imputations$imp5$nombre_region,
       amelia_fit$imputations$imp6$nombre_region,
       amelia_fit$imputations$imp7$nombre_region,
       amelia_fit$imputations$imp8$nombre_region,
       amelia_fit$imputations$imp9$nombre_region,
       amelia_fit$imputations$imp10$nombre_region,
       amelia_fit$imputations$imp11$nombre_region,
       amelia_fit$imputations$imp12$nombre_region,
       amelia_fit$imputations$imp13$nombre_region,
       amelia_fit$imputations$imp14$nombre_region,
       amelia_fit$imputations$imp15$nombre_region,
       amelia_fit$imputations$imp16$nombre_region,
       amelia_fit$imputations$imp17$nombre_region,
       amelia_fit$imputations$imp18$nombre_region,
       amelia_fit$imputations$imp19$nombre_region,
       amelia_fit$imputations$imp20$nombre_region,
       amelia_fit$imputations$imp21$nombre_region,
       amelia_fit$imputations$imp22$nombre_region,
       amelia_fit$imputations$imp23$nombre_region,
       amelia_fit$imputations$imp24$nombre_region,
       amelia_fit$imputations$imp25$nombre_region,
       amelia_fit$imputations$imp26$nombre_region,
       amelia_fit$imputations$imp27$nombre_region,
       amelia_fit$imputations$imp28$nombre_region,
       amelia_fit$imputations$imp29$nombre_region,
       amelia_fit$imputations$imp30$nombre_region
       ) 
nombre_region_imputed<-
nombre_region_imputed %>% 
  data.frame() %>% 
dplyr::mutate(across(c(amelia_fit.imputations.imp1.nombre_region:amelia_fit.imputations.imp30.nombre_region),~dplyr::case_when(grepl("Antofagasta",as.character(.))~1,TRUE~0), .names="reg_02_{col}"))%>%
dplyr::mutate(across(c(amelia_fit.imputations.imp1.nombre_region:amelia_fit.imputations.imp30.nombre_region),~dplyr::case_when(grepl("Araucan",as.character(.))~1,TRUE~0), .names="reg_09_{col}"))%>%
dplyr::mutate(across(c(amelia_fit.imputations.imp1.nombre_region:amelia_fit.imputations.imp30.nombre_region),~dplyr::case_when(grepl("Arica",as.character(.))~1,TRUE~0), .names="reg_15_{col}"))%>%
dplyr::mutate(across(c(amelia_fit.imputations.imp1.nombre_region:amelia_fit.imputations.imp30.nombre_region),~dplyr::case_when(grepl("Atacama",as.character(.))~1,TRUE~0), .names="reg_03_{col}"))%>%
dplyr::mutate(across(c(amelia_fit.imputations.imp1.nombre_region:amelia_fit.imputations.imp30.nombre_region),~dplyr::case_when(grepl("Ays",as.character(.))~1,TRUE~0), .names="reg_11_{col}"))%>%
dplyr::mutate(across(c(amelia_fit.imputations.imp1.nombre_region:amelia_fit.imputations.imp30.nombre_region),~dplyr::case_when(grepl("Biob",as.character(.))~1,TRUE~0), .names="reg_08_{col}"))%>%
dplyr::mutate(across(c(amelia_fit.imputations.imp1.nombre_region:amelia_fit.imputations.imp30.nombre_region),~dplyr::case_when(grepl("Coquimbo",as.character(.))~1,TRUE~0), .names="reg_04_{col}"))%>%
dplyr::mutate(across(c(amelia_fit.imputations.imp1.nombre_region:amelia_fit.imputations.imp30.nombre_region),~dplyr::case_when(grepl("Los Lagos",as.character(.))~1,TRUE~0), .names="reg_10_{col}"))%>%
dplyr::mutate(across(c(amelia_fit.imputations.imp1.nombre_region:amelia_fit.imputations.imp30.nombre_region),~dplyr::case_when(grepl("Los R",as.character(.))~1,TRUE~0), .names="reg_14_{col}"))%>%
dplyr::mutate(across(c(amelia_fit.imputations.imp1.nombre_region:amelia_fit.imputations.imp30.nombre_region),~dplyr::case_when(grepl("Magallanes",as.character(.))~1,TRUE~0), .names="reg_12_{col}"))%>%
dplyr::mutate(across(c(amelia_fit.imputations.imp1.nombre_region:amelia_fit.imputations.imp30.nombre_region),~dplyr::case_when(grepl("Maule",as.character(.))~1,TRUE~0), .names="reg_07_{col}"))%>%
dplyr::mutate(across(c(amelia_fit.imputations.imp1.nombre_region:amelia_fit.imputations.imp30.nombre_region),~dplyr::case_when(grepl("Metropolitana",as.character(.))~1,TRUE~0), .names="reg_13_{col}"))%>%
dplyr::mutate(across(c(amelia_fit.imputations.imp1.nombre_region:amelia_fit.imputations.imp30.nombre_region),~dplyr::case_when(grepl("uble",as.character(.))~1,TRUE~0), .names="reg_16_{col}"))%>%
dplyr::mutate(across(c(amelia_fit.imputations.imp1.nombre_region:amelia_fit.imputations.imp30.nombre_region),~dplyr::case_when(grepl("Higgins",as.character(.))~1,TRUE~0), .names="reg_06_{col}"))%>%
dplyr::mutate(across(c(amelia_fit.imputations.imp1.nombre_region:amelia_fit.imputations.imp30.nombre_region),~dplyr::case_when(grepl("Tarapac",as.character(.))~1,TRUE~0), .names="reg_01_{col}"))%>%
dplyr::mutate(across(c(amelia_fit.imputations.imp1.nombre_region:amelia_fit.imputations.imp30.nombre_region),~dplyr::case_when(grepl("Valpara",as.character(.))~1,TRUE~0), .names="reg_05_{col}"))%>%
  
 
  dplyr::mutate(nombre_region_02 = base::rowSums(dplyr::select(., starts_with("reg_02_"))))%>%
  dplyr::mutate(nombre_region_09 = base::rowSums(dplyr::select(., starts_with("reg_09_"))))%>%
  dplyr::mutate(nombre_region_15 = base::rowSums(dplyr::select(., starts_with("reg_15_"))))%>%
  dplyr::mutate(nombre_region_03 = base::rowSums(dplyr::select(., starts_with("reg_03_"))))%>%
  dplyr::mutate(nombre_region_11 = base::rowSums(dplyr::select(., starts_with("reg_11_"))))%>%
  dplyr::mutate(nombre_region_08 = base::rowSums(dplyr::select(., starts_with("reg_08_"))))%>%
  dplyr::mutate(nombre_region_04 = base::rowSums(dplyr::select(., starts_with("reg_04_"))))%>%
  dplyr::mutate(nombre_region_10 = base::rowSums(dplyr::select(., starts_with("reg_10_"))))%>%
  dplyr::mutate(nombre_region_14 = base::rowSums(dplyr::select(., starts_with("reg_14_"))))%>%
  dplyr::mutate(nombre_region_12 = base::rowSums(dplyr::select(., starts_with("reg_12_"))))%>%
  dplyr::mutate(nombre_region_07 = base::rowSums(dplyr::select(., starts_with("reg_07_"))))%>%
  dplyr::mutate(nombre_region_13 = base::rowSums(dplyr::select(., starts_with("reg_13_"))))%>%
  dplyr::mutate(nombre_region_16 = base::rowSums(dplyr::select(., starts_with("reg_16_"))))%>%
  dplyr::mutate(nombre_region_06 = base::rowSums(dplyr::select(., starts_with("reg_06_"))))%>%
  dplyr::mutate(nombre_region_01 = base::rowSums(dplyr::select(., starts_with("reg_01_"))))%>%
  dplyr::mutate(nombre_region_05 = base::rowSums(dplyr::select(., starts_with("reg_05_"))))%>%
  #dplyr::summarise(min_mar=max(sus_ini_mod_mvv_mar[sus_ini_mod_mvv_mar<30]),min_oh=max(sus_ini_mod_mvv_oh[sus_ini_mod_mvv_oh<30]),min_pb=max(sus_ini_mod_mvv_pb[sus_ini_mod_mvv_pb<30]),min_coc=max(sus_ini_mod_mvv_coc[sus_ini_mod_mvv_coc<30]),min_otr=max(sus_ini_mod_mvv_otr[sus_ini_mod_mvv_otr<30]))
  dplyr::mutate(nombre_region_tot=dplyr::case_when(nombre_region_02>0~1,TRUE~0)) %>% 
  dplyr::mutate(nombre_region_tot=dplyr::case_when(nombre_region_09>0~nombre_region_tot+1,TRUE~nombre_region_tot)) %>% 
  dplyr::mutate(nombre_region_tot=dplyr::case_when(nombre_region_15>0~nombre_region_tot+1,TRUE~nombre_region_tot)) %>% 
  dplyr::mutate(nombre_region_tot=dplyr::case_when(nombre_region_03>0~nombre_region_tot+1,TRUE~nombre_region_tot)) %>%
  dplyr::mutate(nombre_region_tot=dplyr::case_when(nombre_region_11>0~nombre_region_tot+1,TRUE~nombre_region_tot)) %>% 
  dplyr::mutate(nombre_region_tot=dplyr::case_when(nombre_region_08>0~nombre_region_tot+1,TRUE~nombre_region_tot)) %>% 
  dplyr::mutate(nombre_region_tot=dplyr::case_when(nombre_region_04>0~nombre_region_tot+1,TRUE~nombre_region_tot)) %>% 
  dplyr::mutate(nombre_region_tot=dplyr::case_when(nombre_region_10>0~nombre_region_tot+1,TRUE~nombre_region_tot)) %>% 
  dplyr::mutate(nombre_region_tot=dplyr::case_when(nombre_region_14>0~nombre_region_tot+1,TRUE~nombre_region_tot)) %>% 
  dplyr::mutate(nombre_region_tot=dplyr::case_when(nombre_region_12>0~nombre_region_tot+1,TRUE~nombre_region_tot)) %>% 
  dplyr::mutate(nombre_region_tot=dplyr::case_when(nombre_region_07>0~nombre_region_tot+1,TRUE~nombre_region_tot)) %>% 
  dplyr::mutate(nombre_region_tot=dplyr::case_when(nombre_region_13>0~nombre_region_tot+1,TRUE~nombre_region_tot)) %>% 
  dplyr::mutate(nombre_region_tot=dplyr::case_when(nombre_region_16>0~nombre_region_tot+1,TRUE~nombre_region_tot)) %>% 
  dplyr::mutate(nombre_region_tot=dplyr::case_when(nombre_region_06>0~nombre_region_tot+1,TRUE~nombre_region_tot)) %>% 
  dplyr::mutate(nombre_region_tot=dplyr::case_when(nombre_region_01>0~nombre_region_tot+1,TRUE~nombre_region_tot)) %>% 
  dplyr::mutate(nombre_region_tot=dplyr::case_when(nombre_region_05>0~nombre_region_tot+1,TRUE~nombre_region_tot)) %>% 
  janitor::clean_names()
  
nombre_region_imputed_cat_reg<-  
    nombre_region_imputed %>%
        tidyr::pivot_longer(c(nombre_region_01, nombre_region_02, nombre_region_03, nombre_region_04, nombre_region_05, nombre_region_06, nombre_region_07, nombre_region_08, nombre_region_09, nombre_region_10, nombre_region_11, nombre_region_12, nombre_region_13, nombre_region_14, nombre_region_15), names_to = "cat_nombre_region", values_to = "count") %>%
        dplyr::group_by(amelia_fit_imputations_imp1_row) %>% 
        dplyr::mutate(nombre_region_imputed_max=max(count,na.rm=T)) %>% 
        dplyr::ungroup() %>% 
        dplyr::filter(nombre_region_imputed_max==count) %>% 
        dplyr::select(amelia_fit_imputations_imp1_row,cat_nombre_region,count) %>% 
        dplyr::group_by(amelia_fit_imputations_imp1_row) %>% 
        dplyr::mutate(n_row=n()) %>% 
        dplyr::ungroup() %>% 
        dplyr::mutate(cat_nombre_region=dplyr::case_when(n_row>1~NA_character_,
                                                        TRUE~cat_nombre_region)) %>% 
        dplyr::distinct(amelia_fit_imputations_imp1_row,.keep_all = T)
  
nombre_region_imputed<-
  nombre_region_imputed %>% 
    dplyr::left_join(nombre_region_imputed_cat_reg, by="amelia_fit_imputations_imp1_row") %>%
    dplyr::mutate(cat_nombre_region=dplyr::case_when(cat_nombre_region=="nombre_region_01"~"TarapacÃ¡ (01)",cat_nombre_region=="nombre_region_02"~"Antofagasta (02)",cat_nombre_region=="nombre_region_03"~"Atacama (03)",cat_nombre_region=="nombre_region_04"~"Coquimbo (04)",cat_nombre_region=="nombre_region_05"~"ValparaÃ­so (05)",cat_nombre_region=="nombre_region_06"~"O'Higgins (06)",cat_nombre_region=="nombre_region_07"~"Maule (07)",cat_nombre_region=="nombre_region_08"~"BiobÃ­o (08)",cat_nombre_region=="nombre_region_09"~"AraucanÃ­a (09)",cat_nombre_region=="nombre_region_10"~"Los Lagos (10)",cat_nombre_region=="nombre_region_11"~"AysÃ©n (11)",cat_nombre_region=="nombre_region_12"~"Magallanes (12)",cat_nombre_region=="nombre_region_13"~"Metropolitana (13)",
                                                 cat_nombre_region=="nombre_region_14"~"Los RÃ­os (14)",cat_nombre_region=="nombre_region_15"~"Arica (15)",cat_nombre_region=="nombre_region_16"~"Ãuble (16)",
    ))%>% 
  janitor::clean_names()

#_#_#_#_#_#_#_#_#_#_#_#_
#_#_#_#_#_#_#_#_#_#_#_#_
tipo_centro_pub_imputed<-
 cbind.data.frame(amelia_fit$imputations$imp1$row,
       amelia_fit$imputations$imp1$tipo_centro_pub,
       amelia_fit$imputations$imp2$tipo_centro_pub,
       amelia_fit$imputations$imp3$tipo_centro_pub,
       amelia_fit$imputations$imp4$tipo_centro_pub,
       amelia_fit$imputations$imp5$tipo_centro_pub,
       amelia_fit$imputations$imp6$tipo_centro_pub,
       amelia_fit$imputations$imp7$tipo_centro_pub,
       amelia_fit$imputations$imp8$tipo_centro_pub,
       amelia_fit$imputations$imp9$tipo_centro_pub,
       amelia_fit$imputations$imp10$tipo_centro_pub,
       amelia_fit$imputations$imp11$tipo_centro_pub,
       amelia_fit$imputations$imp12$tipo_centro_pub,
       amelia_fit$imputations$imp13$tipo_centro_pub,
       amelia_fit$imputations$imp14$tipo_centro_pub,
       amelia_fit$imputations$imp15$tipo_centro_pub,
       amelia_fit$imputations$imp16$tipo_centro_pub,
       amelia_fit$imputations$imp17$tipo_centro_pub,
       amelia_fit$imputations$imp18$tipo_centro_pub,
       amelia_fit$imputations$imp19$tipo_centro_pub,
       amelia_fit$imputations$imp20$tipo_centro_pub,
       amelia_fit$imputations$imp21$tipo_centro_pub,
       amelia_fit$imputations$imp22$tipo_centro_pub,
       amelia_fit$imputations$imp23$tipo_centro_pub,
       amelia_fit$imputations$imp24$tipo_centro_pub,
       amelia_fit$imputations$imp25$tipo_centro_pub,
       amelia_fit$imputations$imp26$tipo_centro_pub,
       amelia_fit$imputations$imp27$tipo_centro_pub,
       amelia_fit$imputations$imp28$tipo_centro_pub,
       amelia_fit$imputations$imp29$tipo_centro_pub,
       amelia_fit$imputations$imp30$tipo_centro_pub
       ) 

tipo_centro_pub_imputed<-
  tipo_centro_pub_imputed %>% 
  dplyr::mutate(tipo_centro_pub = base::rowSums(dplyr::select(., ends_with("tipo_centro_pub"))))%>%
  dplyr::mutate(tipo_centro_pub_to_imputation= dplyr::case_when(tipo_centro_pub>15~1,
                                                  tipo_centro_pub==15~NA_real_,
                                                  TRUE~0)) %>% 
  janitor::clean_names()

#:#:#::#:#:#:#:#:#::#:#:#:#:#:#::#:#:#:#:#:#::#:#:#:#:#:#::#:#:#:#:#:#::#:#:#:#:#:#::#:#:#:#:#:#::#:#:#:

CONS_C1_df_dup_SEP_2020_match_miss6<-
CONS_C1_df_dup_SEP_2020_match_miss5 %>% 
   dplyr::left_join(dplyr::select(nombre_region_imputed,amelia_fit_imputations_imp1_row,cat_nombre_region), by=c("row"="amelia_fit_imputations_imp1_row")) %>% 
    dplyr::mutate(nombre_region=factor(dplyr::case_when(is.na(nombre_region)~as.character(cat_nombre_region),TRUE~as.character(nombre_region)))) %>% 
  dplyr::left_join(dplyr::select(tipo_centro_pub_imputed,amelia_fit_imputations_imp1_row,tipo_centro_pub_to_imputation), by=c("row"="amelia_fit_imputations_imp1_row")) %>% 
  dplyr::mutate(tipo_centro_pub=factor(dplyr::case_when(is.na(tipo_centro_pub)~as.logical(tipo_centro_pub_to_imputation),TRUE~as.logical(tipo_centro_pub)))) %>%
  data.table()
#CONS_C1_df_dup_SEP_2020_match_miss6
#table(is.na(CONS_C1_df_dup_SEP_2020_match_miss6$tipo_centro_pub))
#table(is.na(CONS_C1_df_dup_SEP_2020_match_miss6$nombre_region))
```

<br>

There were impossible to impute region of the center in `r as.numeric(table(is.na(CONS_C1_df_dup_SEP_2020_match_miss6$nombre_region)))[2]` cases due to ties in the different imputed values.

<br>

## Sample Characteristics

We checked the characteristics of the sample depending on type of treatment (Residential or Ambulatory).

<br>

```{r bal0,eval=T, echo=T, paged.print=TRUE}                                 
#prop.table(table(CONS_C1_df_dup_SEP_2020_match$abandono_temprano_rec,CONS_C1_df_dup_SEP_2020_match$tipo_de_plan_res),2)
match.on.sel<-c("sus_ini_mod_mvv","estado_conyugal_2","escolaridad_rec","condicion_ocupacional_corr","edad_ini_cons","freq_cons_sus_prin","origen_ingreso_mod","dg_cie_10_rec","nombre_region", "prev_treat","sexo_2","edad_al_ing","fech_ing_num")

match.on_tot <- c("row", "hash_key","sus_ini_mod_mvv","estado_conyugal_2","escolaridad_rec","condicion_ocupacional_corr","edad_ini_cons","freq_cons_sus_prin","origen_ingreso_mod","dg_cie_10_rec","nombre_region","abandono_temprano_rec","tipo_de_plan_res","evaluacindelprocesoteraputico_min","prev_treat","sexo_2","edad_al_ing","fech_ing_num")

catVars<-
c("sus_ini_mod_mvv","estado_conyugal_2","escolaridad_rec","condicion_ocupacional_corr","freq_cons_sus_prin","origen_ingreso_mod","dg_cie_10_rec","nombre_region","tipo_de_plan_res","prev_treat","sexo_2")

#aÃ±ado los imputados
CONS_C1_df_dup_SEP_2020_match_not_miss<-
CONS_C1_df_dup_SEP_2020_match %>% 
  dplyr::select(-sus_ini_mod_mvv,-estado_conyugal_2,-escolaridad_rec,-freq_cons_sus_prin,-edad_ini_cons,-nombre_region,-tipo_centro_pub) %>% 
  dplyr::left_join(dplyr::select(CONS_C1_df_dup_SEP_2020_match_miss6,
                                 row,
                                 sus_ini_mod_mvv,
                                 estado_conyugal_2,
                                 escolaridad_rec,
                                 freq_cons_sus_prin,
                                 nombre_region,
                                 edad_ini_cons),by="row") %>% 
  dplyr::arrange(tipo_de_plan_res,hash_key,rn) %>% 
  dplyr::mutate(condicion_ocupacional_corr=factor(condicion_ocupacional_corr))
CONS_C1_df_dup_SEP_2020_match_not_miss2<-
  CONS_C1_df_dup_SEP_2020_match_not_miss[complete.cases(CONS_C1_df_dup_SEP_2020_match_not_miss[,..match.on_tot]),..match.on_tot] 
```

<br>

Considering that some missing values were not possible to impute, we started having `nrow(CONS_C1_df_dup_SEP_2020_match_not_miss) %>%  formatC(big.mark=",")` cases (users=`r length(unique(CONS_C1_df_dup_SEP_2020_match_not_miss$hash_key))%>%  formatC(big.mark=",")`), and ended having `nrow(CONS_C1_df_dup_SEP_2020_match_not_miss2) %>%  formatC(big.mark=",")` complete cases (`r length(unique(CONS_C1_df_dup_SEP_2020_match_not_miss2$hash_key))%>%  formatC(big.mark=",")`).  

<br>

```{r bal1,eval=T, echo=T, paged.print=TRUE}                                 
kableone <- function(x, ...) {
  capture.output(x <- print(x,...))
  knitr::kable(x,format= "html", format.args= list(decimal.mark= ".", big.mark= ","))
}
#table(is.na(CONS_C1_df_dup_SEP_2020_match_not_miss$edad_ini_cons))

#length(unique(CONS_C1_df_dup_SEP_2020_match$fech_ing_num))
#:#:#:#:#: DISMINUIR LA HETEROGENEIDAD DE LA FECHA DE INGRESO
# FORMAS DE CONSTREÃIR LA VARIABLE:
#CONS_C1_df_dup_SEP_2020_match$fech_ing_num<-round(CONS_C1_df_dup_SEP_2020_match$fech_ing_num/10,0)
#CONS_C1_df_dup_SEP_2020_match$fech_ing_num<-cut(CONS_C1_df_dup_SEP_2020_match$fech_ing_num,100)
#CONS_C1_df_dup_SEP_2020_match$fech_ing_num<-CONS_C1_df_dup_SEP_2020_match_fech_ing_num
#CONS_C1_df_dup_SEP_2020_match_fech_ing_num<-CONS_C1_df_dup_SEP_2020_match$fech_ing_num
#length(unique(round(CONS_C1_df_dup_SEP_2020_match$fech_ing_num,0)))
#length(unique(round(CONS_C1_df_dup_SEP_2020_match$fech_ing_num/10,0)))

#CONS_C1_df_dup_SEP_2020_match$fech_ing_num<-round(CONS_C1_df_dup_SEP_2020_match$fech_ing_num/10,0)
#:#:#:#:#: 

attr(CONS_C1_df_dup_SEP_2020_match_not_miss2$sus_ini_mod_mvv,"label")<-"Starting Substance"
attr(CONS_C1_df_dup_SEP_2020_match_not_miss2$estado_conyugal_2,"label")<-"Marital Status"
attr(CONS_C1_df_dup_SEP_2020_match_not_miss2$escolaridad_rec,"label")<-"Educational Attainment"
attr(CONS_C1_df_dup_SEP_2020_match_not_miss2$edad_ini_cons,"label")<-"Age of Onset of Drug Use"
attr(CONS_C1_df_dup_SEP_2020_match_not_miss2$freq_cons_sus_prin,"label")<-"Frequency of use of primary drug"
attr(CONS_C1_df_dup_SEP_2020_match_not_miss2$nombre_region,"label")<-"Frequency of use of primary drug"

pre_tab1<-Sys.time()
tab1<-
CreateTableOne(vars = match.on.sel, strata = "tipo_de_plan_res", 
                       data = CONS_C1_df_dup_SEP_2020_match_not_miss2, factorVars = catVars, smd=T)
post_tab1<-Sys.time()
diff_time_tab1=post_tab1-pre_tab1

kableone(tab1, nonnormal= c("edad_ini_cons","edad_al_ing","fech_ing_num"),#"\\hline",
                       smd=T, test=T, varLabels=T,noSpaces=T, printToggle=T, dropEqual=F) %>% 
    kableExtra::kable_styling(bootstrap_options = c("striped", "hover","condensed"),font_size= 10) %>%
  #()
  row_spec(1, bold = T, italic =T,color ="black",hline_after=T,extra_latex_after="\\arrayrulecolor{white}",font_size= 10) %>%
  #footnote(general = "Here is a general comments of the table. ",
  #        number = c("Footnote 1; ", "Footnote 2; "),
  #         alphabet = c("Footnote A; ", "Footnote B; "),
  #         symbol = c("Footnote Symbol 1; ", "Footnote Symbol 2")
  #         )%>%
  scroll_box(width = "100%", height = "400px") 
#"tipo_de_plan_ambulatorio",
#https://cran.r-project.org/web/packages/tableone/vignettes/smd.html
#http://rstudio-pubs-static.s3.amazonaws.com/405765_2ce448f9bde24148a5f94c535a34b70e.html
#https://cran.r-project.org/web/packages/tableone/vignettes/introduction.html
#https://cran.r-project.org/web/packages/tableone/tableone.pdf
#https://www.rdocumentation.org/packages/tableone/versions/0.12.0/topics/CreateTableOne

## Construct a table 
#standardized mean differences of greater than 0.1
```

<br>

We checked the similarity in the samples using other measures, such as the variance ratio of the samples and Kolmogorov-Smirnov(KS) statistics.

<br>

```{r bal2,eval=T, echo=T, paged.print=TRUE}                                 
library(cobalt)
bal2<-bal.tab(CONS_C1_df_dup_SEP_2020_match_not_miss2[,..match.on.sel], treat = CONS_C1_df_dup_SEP_2020_match_not_miss2$tipo_de_plan_res,
         thresholds = c(m = .1, v = 2),
         binary = "std", 
         continuous = "std",
         stats = c("mean.diffs", "variance.ratios","ks.statistics"))
#"mean.diffs", "variance.ratios","ks.statistics","ovl.coefficient"

options(knitr.kable.NA = '')

bal2$Balance[,2]<-round(bal2$Balance[,2],2)
bal2$Balance[,4]<-round(bal2$Balance[,4],2)

bal2$Balance[,1:6] %>% 
    knitr::kable(.,format = "html", format.args = list(decimal.mark = ".", big.mark = ","),
               caption = paste0("Table 2. Covariate Balance in the Variables of Interest"),
               col.names = c("Nature of Variables", "Unadjusted SMDs","Threshold","Unadjusted Variance Ratios","Threshold","Unadjusted KS"),
               align =rep('c', 101)) %>%
  kableExtra::kable_styling(bootstrap_options = c("striped", "hover"),font_size = 10) %>%
  kableExtra::add_footnote( c(paste("Note. ")), 
                            notation = "none") %>%zoo
  kableExtra::scroll_box(width = "10bal.tab0%", height = "375px")
```

<br>

We generated a plot to focus on unbalanced data.

<br>

```{r  Fig 1_dist_no_treat_treat, warning=FALSE, fig.align = "center", message=F, fig.height=10, cache=T, eval=T, fig.cap="Figure 5. Covariates Balance on Different Values"}

love.plot(bal2, binary = "std", 
          thresholds = c(m = .1, m=.2),
          var.order = "unadjusted")+
  theme_bw()+
  ggtitle(NULL)+
  labs(caption="Note. Vertical dashed line= Standardized Differences of .1")+
  theme( plot.caption=element_text(hjust=0))

#ggplot(idh_pre, aes(idh_pre$quintil_0,idh_pre$idh_0)) + 
#  geom_point(aes(colour = idh_pre$groups), size = 5) + labs(x="Quintiles", y="Percentage")  + 
#  theme_bw() +  
#  scale_fill_manual(values=c("black", "gray60") ) + 
#  scale_colour_manual(name="Groups",values =c("Control"="black", "Exposed"="gray60")) + 
#  theme(legend.key = element_rect(colour = NA)) + 
#  theme(text = element_text(size=20)) + 
#  scale_y_continuous( limits = c(0,0.4), breaks = seq(.05,.4,by=.05))

#bal.tab(bal2, treat = "tipo_de_plan_res",var.name = "fech_ing_num", data = CONS_C1_df_dup_SEP_2020_match_not_miss2)
```

```{r bal3,eval=T, echo=T, paged.print=TRUE, eval=F}                                 

columna_dummy <- function(df, columna) {
  df %>% 
  mutate_at(columna, ~paste(columna, eval(as.symbol(columna)), sep = "_")) %>% 
    mutate(valor = 1) %>% 
    spread(key = columna, value = valor, fill = 0)
}

match.on<-c("sus_ini_mod_mvv","estado_conyugal_2","escolaridad_rec","condicion_ocupacional_corr","edad_ini_cons","freq_cons_sus_prin","origen_ingreso_mod","dg_cie_10_rec","nombre_region","abandono_temprano_rec","tipo_de_plan_res","evaluacindelprocesoteraputico_min","prev_treat","sexo_2","edad_al_ing")

#nrow(CONS_C1_df_dup_SEP_2020_match[complete.cases(CONS_C1_df_dup_SEP_2020_match[,match.on_tot]),match.on_tot]) #101,384

for (i in c(1:length(catVars[-10]))){
  cat<-as.character(catVars[-10][i])
  CONS_C1_df_dup_SEP_2020_match2<-columna_dummy(CONS_C1_df_dup_SEP_2020_match2,cat)
}
match.on.sel2<-names(CONS_C1_df_dup_SEP_2020_match2)[-c(1,2,5)]

#dim(CONS_C1_df_dup_SEP_2020_match[complete.cases(CONS_C1_df_dup_SEP_2020_match[,..match.on_tot]),..match.on_tot]) #94,097
library(MatchingFrontier)
mahal.frontier <- makeFrontier(dataset =CONS_C1_df_dup_SEP_2020_match2,
 treatment = 'tipo_de_plan_res',
 #outcome = 'diff_bet_treat',
 match.on = match.on.sel2)

L1.frontier <- makeFrontier(dataset =CONS_C1_df_dup_SEP_2020_match2,
 treatment = 'tipo_de_plan_res',
 #outcome = 'abandono_temprano_rec',
 match.on = match.on.sel2,
 QOI = 'SATT',
 metric = 'L1',
 ratio = 'fixed')
 
 #Error: In makeFrontier(), missing values in the data; remove them (or impute) and try again.

# By default, makeFrontier() calculates the frontier with the Average Mahalanobis Imbalance. However, as we demonstrate, MatchingFrontier works just as easily with L1 difference.
#The default quantity of interest is the feasible sample average treatment effect on the treated or FSATT
```

# Specification

First, we had to discretize categorical variables into logical parameters, and for countinous covariates, we created quantiles

<br>

```{r spec1, eval=T, echo=T, paged.print=TRUE}                                 
columna_dummy <- function(df, columna) {
  df %>% 
  mutate_at(columna, ~paste(columna, eval(as.symbol(columna)), sep = "_")) %>% 
    mutate(valor = 1) %>% 
    spread(key = columna, value = valor, fill = 0)
}

quantiles = function(covar, n_q) {
	p_q = seq(0, 1, 1/n_q)
	val_q = quantile(covar, probs = p_q, na.rm = TRUE)
	covar_out = rep(NA, length(covar))
	for (i in 1:n_q) {
		if (i==1) {covar_out[covar<val_q[i+1]] = i}
		if (i>1 & i<n_q) {covar_out[covar>=val_q[i] & covar<val_q[i+1]] = i}
		if (i==n_q) {covar_out[covar>=val_q[i] & covar<=val_q[i+1]] = i}}
	covar_out
}

CONS_C1_df_dup_SEP_2020_match_not_miss3<-CONS_C1_df_dup_SEP_2020_match_not_miss2
for (i in c(1:length(catVars))){#catVars[-10] excluding treatment indicator
  cat<-as.character(catVars[i])#catVars[-10] excluding treatment indicator
  CONS_C1_df_dup_SEP_2020_match_not_miss3<-columna_dummy(CONS_C1_df_dup_SEP_2020_match_not_miss3,cat)
}
CONS_C1_df_dup_SEP_2020_match_not_miss3$tipo_de_plan_res_FALSE<-NULL
CONS_C1_df_dup_SEP_2020_match_not_miss3$edad_ini_cons<-quantiles(CONS_C1_df_dup_SEP_2020_match_not_miss3$edad_ini_cons,20)
CONS_C1_df_dup_SEP_2020_match_not_miss3$edad_al_ing<-quantiles(CONS_C1_df_dup_SEP_2020_match_not_miss3$edad_al_ing,20)
CONS_C1_df_dup_SEP_2020_match_not_miss3$fech_ing_num<-quantiles(CONS_C1_df_dup_SEP_2020_match_not_miss3$fech_ing_num,20)
match.on.sel2<-names(CONS_C1_df_dup_SEP_2020_match_not_miss3)[-c(1,2,5)]
#"edad_ini_cons","edad_al_ing","fech_ing_num")

CONS_SEP_match = CONS_C1_df_dup_SEP_2020_match_not_miss2[order(CONS_C1_df_dup_SEP_2020_match_not_miss2$tipo_de_plan_res, decreasing = TRUE), ]
```

<br>

# Match

```{r match1,eval=T, echo=T, paged.print=TRUE, eval=T, error=T}                                 

library(designmatch)

#fine = list(covs = fine_covs)
#solver = list(name = name, t_max = t_max, approximate = 1, round_cplex = 0, trace_cplex = 0).
#:#:#:#:#:#:#:#:#:#:#:#:#:#:##:#:#:#:#:#:#:#:#:#:#:#:#:#:#:##:#:#:#:#:#:#:#:#:#:#:#:#:#:#:##:#:#:#:#:#:#:#:#:#:#:#:#:#:#:##:#:#:#:#:#:#:#:#:#:#:#:#:#:#:##:
#:#:#:#:#:#:#:#:#:#:#:#:#:#:##:#:#:#:#:#:#:#:#:#:#:#:#:#:#:##:#:#:#:#:#:#:#:#:#:#:#:#:#:#:##:#:#:#:#:#:#:#:#:#:#:#:#:#:#:##:#:#:#:#:#:#:#:#:#:#:#:#:#:#:##:
# 1. Gurobi installation

#For an exact solution, we strongly recommend running designmatch either with CPLEX or Gurobi.  Between these two solvers, the R interface of Gurobi is considerably easier to install.  Here we provide general instructions for manually installing Gurobi and its R interface in Mac and Windows machines.

#1. Create a free academic license
#	Follow the instructions in: http://www.gurobi.com/documentation/7.0/quickstart_windows/creating_a_new_academic_li.html

#2. Install the software
#	2.1. In http://www.gurobi.com/index, go to Downloads > Gurobi Software
#	2.2. Choose your operating system and press download
#
#3. Retrieve and set up your Gurobi license
#	2.1. Follow the instructions in: http://www.gurobi.com/documentation/7.0/quickstart_windows/retrieving_and_setting_up_.html
#	2.2. Then follow the instructions in: http://www.gurobi.com/documentation/7.0/quickstart_windows/retrieving_a_free_academic.html
#
#4. Test your license
#	Follow the instructions in: http://www.gurobi.com/documentation/7.0/quickstart_windows/testing_your_license.html
#
#5. Install the R interface of Gurobi	
#	Follow the instructions in: http://www.gurobi.com/documentation/7.0/quickstart_windows/r_installing_the_r_package.html
#	* In Windows, in R run the command install.packages("PATH\\gurobi_7.X-Y.zip", repos=NULL) where path leads to the file gurobi_7.X-Y.zip (for example PATH=C:\\gurobi702\\win64\\R; note that the path may be different in your computer), and "7.X-Y" refers to the version you are installing.
#	* In MAC, in R run the command install.packages('PATH/gurobi_7.X-Y.tgz', repos=NULL) where path leads to the file gurobi_7.X-Y.tgz (for example PATH=/Library/gurobi702/mac64/R; note that the path may be different in your computer), and "7.X-Y" refers to the version you are installing.
#		
#6. Test the installation 
#	Load the library and run the examples therein
#	* A possible error that you may get is the following: "Error: package âslamâ required by âgurobiâ could not be found". If that case, install.packages('slam') and try again.
#	You should be all set!

#:#:#:#:#:#:#:#:#:#:#:#:#:#:##:#:#:#:#:#:#:#:#:#:#:#:#:#:#:##:#:#:#:#:#:#:#:#:#:#:#:#:#:#:##:#:#:#:#:#:#:#:#:#:#:#:#:#:#:##:#:#:#:#:#:#:#:#:#:#:#:#:#:#:##:
#:#:#:#:#:#:#:#:#:#:#:#:#:#:##:#:#:#:#:#:#:#:#:#:#:#:#:#:#:##:#:#:#:#:#:#:#:#:#:#:#:#:#:#:##:#:#:#:#:#:#:#:#:#:#:#:#:#:#:##:#:#:#:#:#:#:#:#:#:#:#:#:#:#:##:
require(slam)
# Solver options
#default solver is glpk with approximate = 1
#For an exact solution, we strongly recommend using cplex or gurobi as they are much faster than the other solvers, but they do require a license (free for academics, but not for people outside universities)
t_max = 60*6
solver = "gurobi" #cplex, glpk, gurobi and symphony
solver = list(name = solver, 
t_max = t_max, #t_max is a scalar with the maximum time limit for finding the matches.within this time limit, a partial, suboptimal solution is given
approximate = 1,#. If approximate = 1 (the default), an approximate solution is found via a relaxation of the original integer program
round_cplex = 0, 
trace = 1)#turns the optimizer output on

#Indicador de tratamiento
t_ind= CONS_C1_df_dup_SEP_2020_match_not_miss2$tipo_de_plan_res

# Moment balance: constrain differences in means to be at most 0.1 standard deviations apart
#:#:#:#:#:#:#:#:#:#:#:#:#:
#######mom_covs is a matrix where each column is a covariate whose mean is to be balanced
#######mom_tols is a vector of tolerances for the maximum difference in means for the covariates in mom_covs
#######mom_targets is a vector of target moments (e.g., means) of a distribution to be approximated by matched sampling. is optional, but if #######mom_covs is specified then mom_tols needs to be specified too
#######The lengths of mom_tols and mom_target have to be equal to the number of columns of mom_covs
mom_covs = cbind(CONS_SEP_match$edad_al_ing, CONS_SEP_match$fech_ing_num, CONS_SEP_match$edad_ini_cons)
mom_tols = absstddif(mom_covs, t_ind, .05)
mom = list(covs = mom_covs, tols = mom_tols, targets = NULL)

# Mean balance
covs = cbind(CONS_SEP_match$edad_al_ing, CONS_SEP_match$fech_ing_num, CONS_SEP_match$edad_ini_cons)
meantab(covs, t_ind)

# Fine balance
#is a matrix where each column is a nominal covariate for fine balance
fine_covs = cbind(CONS_SEP_match$nombre_region, CONS_SEP_match$sus_ini_mod_mvv, CONS_SEP_match$estado_conyugal_2, CONS_SEP_match$escolaridad_rec, CONS_SEP_match$condicion_ocupacional_corr, CONS_SEP_match$freq_cons_sus_prin, CONS_SEP_match$origen_ingreso_mod, CONS_SEP_match$dg_cie_10_rec, CONS_SEP_match$prev_treat, CONS_SEP_match$sexo_2)
fine = list(covs = fine_covs)

#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_#_
#MATCH
start.time <- Sys.time()
set.seed(2125)
out = cardmatch(t_ind, #ES NECESARIO QUE LOS TRATAMIENTOS ESTEN ORDENADOS Y LOS OTROS VECTORES TAMBIÃN 
                mom = mom,# ya los definÃ­ list(covs = mom_covs, tols = mom_tols, targets = mom_targets), 
          fine = fine, 
          solver = solver)
end.time <- Sys.time()
time.taken <- end.time - start.time
# Fine balance (note here we are getting an approximate solution)
#for (i in 1:ncol(fine_covs)) {		
#	print(finetab(fine_covs[, i], t_id_1, c_id_1))
#}
# Indices of the treated units and matched controls
t_id_1 = out$t_id  
c_id_1 = out$c_id	

paste0("No. of treatments: ",table(table(t_id_1)) %>% formatC(big.mark = ","),"; No. of controls: ",table(table(c_id_1))%>% formatC(big.mark = ","))

d_match = CONS_SEP_match[c(t_id_1, c_id_1), ]
#cuidado, el anterior me encontrÃ³ mÃ¡s del mismo control para un tratado
#por eso ocuparÃ© el de mÃ¡s abajo
d_match_no_duplicates = CONS_SEP_match[which(CONS_SEP_match$row %in% c(t_id_1, c_id_1)), ]
```

<br>

## Explore Results of the Matching {.tabset .tabset-fade}

<br>

```{r  Fig 5_dist_no_treat_treat, warning=FALSE, fig.align = "center", message=F, fig.height=10, cache=T, eval=T, fig.cap="Figure 5. Empirical Cumulative Distribution Functions on the Matched Sample", results='asis'}

vars_ecdf<- c('edad_al_ing', 'edad_ini_cons', 'fech_ing_num')
headings <- c("Age at Admission", "Age of Onset of Drug Use", "Date of Admission")
for (i in 1:length(headings)) {
  cat("### ",headings[i],"\n")
  f<-vars_ecdf[i]
  ecdfplot(as.data.frame(CONS_SEP_match)[,f], t_id_1, c_id_1, main_title = "", legend_position = "right")
  cat('\n\n')
}
```

<br>

```{r  Fig 6_dist_no_treat_treat, warning=FALSE, fig.align = "center", message=F, fig.height=10, cache=T, eval=T, fig.cap="Figure 6. Love plot of the Matched Sample in Covariates v/s Unmatched Sample", results='asis'}

cat("### ","Love plot","\n")

X_mat<-cbind(CONS_SEP_match$nombre_region, CONS_SEP_match$sus_ini_mod_mvv, CONS_SEP_match$estado_conyugal_2, CONS_SEP_match$escolaridad_rec, CONS_SEP_match$condicion_ocupacional_corr, CONS_SEP_match$freq_cons_sus_prin, CONS_SEP_match$origen_ingreso_mod, CONS_SEP_match$dg_cie_10_rec, CONS_SEP_match$prev_treat, CONS_SEP_match$sexo_2, CONS_SEP_match$edad_al_ing, CONS_SEP_match$edad_ini_cons, CONS_SEP_match$fech_ing_num)

vline = 0.1
loveplot(X_mat=X_mat, t_id=t_id_1, c_id=c_id_1, v_line=vline, legend_position = "topright")
```

<br>

## {-}

</div>

```{r match2,eval=T, echo=T, paged.print=TRUE, eval=T, error=T}                                 
t_max = 60*6
solver = "gurobi" #cplex, glpk, gurobi and symphony
solver2 = list(name = solver, 
t_max = t_max, #t_max is a scalar with the maximum time limit for finding the matches.within this time limit, a partial, suboptimal solution is given
approximate = 0,#. If approximate = 1 (the default), an approximate solution is found via a relaxation of the original integer program
round_cplex = 0, 
trace = 1)#turns the optimizer output on

# Moment balance: constrain differences in means to be at most 0.1 standard deviations apart
#:#:#:#:#:#:#:#:#:#:#:#:#:

mom_covs2 = cbind(CONS_SEP_match$edad_al_ing, CONS_SEP_match$fech_ing_num, CONS_SEP_match$edad_ini_cons)
mom_tols2 = absstddif(mom_covs, t_ind, .03)
mom2 = list(covs = mom_covs2, tols = mom_tols2, targets = NULL)

# Mean balance
covs2 = cbind(CONS_SEP_match$edad_al_ing, CONS_SEP_match$fech_ing_num, CONS_SEP_match$edad_ini_cons)
meantab(covs2, t_ind)

# Fine balance
#is a matrix where each column is a nominal covariate for fine balance
fine_covs2 = cbind(CONS_SEP_match$nombre_region, CONS_SEP_match$sus_ini_mod_mvv, CONS_SEP_match$estado_conyugal_2, CONS_SEP_match$escolaridad_rec, CONS_SEP_match$condicion_ocupacional_corr, CONS_SEP_match$freq_cons_sus_prin, CONS_SEP_match$origen_ingreso_mod, CONS_SEP_match$dg_cie_10_rec, CONS_SEP_match$prev_treat, CONS_SEP_match$sexo_2)
fine2 = list(covs = fine_covs2)

#MATCH
start.time2 <- Sys.time()
set.seed(2125)
out2 = cardmatch(t_ind, #ES NECESARIO QUE LOS TRATAMIENTOS ESTEN ORDENADOS Y LOS OTROS VECTORES TAMBIÃN 
                mom = mom,# ya los definÃ­ list(covs = mom_covs, tols = mom_tols, targets = mom_targets), 
          fine = fine2, 
          solver = solver2)
end.time2 <- Sys.time()
time.taken2 <- end.time2 - start.time2

t_id_2 = out2$t_id  
c_id_2 = out2$c_id	

paste0("No. of treatments: ",table(table(t_id_2)) %>% formatC(big.mark = ","),"; No. of controls: ",table(table(c_id_2))%>% formatC(big.mark = ","))
d_match2 = CONS_SEP_match[c(t_id_2, c_id_2), ]
d_match2_no_duplicates = CONS_SEP_match[which(CONS_SEP_match$row %in% c(t_id_2, c_id_2)), ]
```

<br>

## Explore Results of the Matching {.tabset .tabset-fade}

<br>

```{r  Fig 7_plot, warning=FALSE, fig.align = "center", message=F, fig.height=10, cache=T, eval=T, fig.cap="Figure 7. Empirical Cumulative Distribution Functions on the Matched Sample", results='asis'}

vars_ecdf<- c('edad_al_ing', 'edad_ini_cons', 'fech_ing_num')
headings <- c("Age at Admission", "Age of Onset of Drug Use", "Date of Admission")
for (i in 1:length(headings)) {
  cat("### ",headings[i],"\n")
  f<-vars_ecdf[i]
  df<-as.data.frame(CONS_SEP_match)[,f]
  ecdfplot(df, t_id_2, c_id_2, main_title = "", legend_position = "right")
  cat('\n\n')
}
```

<br>

```{r  Fig 8_plot, warning=FALSE, fig.align = "center", message=F, fig.height=10, cache=T, eval=T, fig.cap="Figure 8. Love plot of the Matched Sample in Covariates v/s Unmatched Sample", results='asis'}

cat("### ","Love plot","\n")

X_mat<-cbind(CONS_SEP_match$nombre_region, CONS_SEP_match$sus_ini_mod_mvv, CONS_SEP_match$estado_conyugal_2, CONS_SEP_match$escolaridad_rec, CONS_SEP_match$condicion_ocupacional_corr, CONS_SEP_match$freq_cons_sus_prin, CONS_SEP_match$origen_ingreso_mod, CONS_SEP_match$dg_cie_10_rec, CONS_SEP_match$prev_treat, CONS_SEP_match$sexo_2, CONS_SEP_match$edad_al_ing, CONS_SEP_match$edad_ini_cons, CONS_SEP_match$fech_ing_num)

vline = 0.1
loveplot(X_mat=X_mat, t_id=t_id_2, c_id=c_id_2, v_line=vline, legend_position = "topright")
```

<br>

## {-}

</div>

## Moment Balance

<br>

Covariates are discretized to be binary and have only two categories

<br>

```{r match3,eval=T, echo=T, paged.print=TRUE, eval=T, error=T}                                 
CONS_SEP_match2= CONS_C1_df_dup_SEP_2020_match_not_miss3[order(CONS_C1_df_dup_SEP_2020_match_not_miss3$tipo_de_plan_res, decreasing = TRUE), ]

t_max = 60*6
solver = "gurobi" #cplex, glpk, gurobi and symphony
solver3 = list(name = solver, 
t_max = t_max, #t_max is a scalar with the maximum time limit for finding the matches.within this time limit, a partial, suboptimal solution is given
approximate = 0,#. If approximate = 1 (the default), an approximate solution is found via a relaxation of the original integer program
round_cplex = 1,  #ound_cplex = 1 ensures that the solution found is integral by rounding and all the constraints are exactly statisfied
trace = 1)#turns the optimizer output on

# Moment balance: constrain differences in means to be at most 0.1 standard deviations apart
#:#:#:#:#:#:#:#:#:#:#:#:#:

mom_covs3 = cbind(CONS_SEP_match2$edad_ini_cons, 
                   CONS_SEP_match2$edad_al_ing, 
                   CONS_SEP_match2$fech_ing_num, 
                   CONS_SEP_match2$sus_ini_mod_mvv_Alcohol, 
                   CONS_SEP_match2$`sus_ini_mod_mvv_Cocaine hydrochloride`, 
                   CONS_SEP_match2$`sus_ini_mod_mvv_Cocaine paste`, 
                   CONS_SEP_match2$`sus_ini_mod_mvv_Marijuana`, 
                   CONS_SEP_match2$sus_ini_mod_mvv_Other, 
                   CONS_SEP_match2$`estado_conyugal_2_Married/Shared living arrangements`, 
                   CONS_SEP_match2$`estado_conyugal_2_Separated/Divorced`,
                   CONS_SEP_match2$estado_conyugal_2_Single, 
                   CONS_SEP_match2$estado_conyugal_2_Widower,
                   CONS_SEP_match2$`escolaridad_rec_1-More than high school`,
                   CONS_SEP_match2$`escolaridad_rec_2-Completed high school or less`,
                   CONS_SEP_match2$`escolaridad_rec_3-Completed primary school or less`,
                   CONS_SEP_match2$condicion_ocupacional_corr_Employed,
                   CONS_SEP_match2$condicion_ocupacional_corr_Inactive,
                   CONS_SEP_match2$`condicion_ocupacional_corr_Looking for a job for the first time`,
                   CONS_SEP_match2$`condicion_ocupacional_corr_No activity`,
                   CONS_SEP_match2$`condicion_ocupacional_corr_Not seeking for work`,
                   CONS_SEP_match2$condicion_ocupacional_corr_Unemployed,
                   CONS_SEP_match2$`freq_cons_sus_prin_1 day a week or more`,
                   CONS_SEP_match2$`freq_cons_sus_prin_2 to 3 days a week`,
                   CONS_SEP_match2$`freq_cons_sus_prin_4 to 6 days a week`,
                   CONS_SEP_match2$freq_cons_sus_prin_Daily,
                   CONS_SEP_match2$`freq_cons_sus_prin_Did not use`,
                   CONS_SEP_match2$`freq_cons_sus_prin_Less than 1 day a week`,
                   CONS_SEP_match2$`origen_ingreso_mod_Assisted Referral`,
                   CONS_SEP_match2$`origen_ingreso_mod_Health Sector`,
                   CONS_SEP_match2$`origen_ingreso_mod_Justice Sector`,
                   CONS_SEP_match2$origen_ingreso_mod_Other,
                   CONS_SEP_match2$origen_ingreso_mod_Spontaneous,
                   CONS_SEP_match2$`dg_cie_10_rec_Diagnosis unknown (under study)`,
                   CONS_SEP_match2$`dg_cie_10_rec_With psychiatric comorbidity`,
                   CONS_SEP_match2$`dg_cie_10_rec_Without psychiatric comorbidity`,
                   CONS_SEP_match2$`nombre_region_Antofagasta (02)`,
                   CONS_SEP_match2$`nombre_region_AraucanÃ­a (09)`,
                   CONS_SEP_match2$`nombre_region_Arica (15)`,
                   CONS_SEP_match2$`nombre_region_Atacama (03)`,
                   CONS_SEP_match2$`nombre_region_AysÃ©n (11)`,
                   CONS_SEP_match2$`nombre_region_BiobÃ­o (08)`,
                   CONS_SEP_match2$`nombre_region_Coquimbo (04)`,
                   CONS_SEP_match2$`nombre_region_Los Lagos (10)`,
                   CONS_SEP_match2$`nombre_region_Magallanes (12)`,
                   CONS_SEP_match2$`nombre_region_Maule (07)`,
                   CONS_SEP_match2$`nombre_region_Metropolitana (13)`,
                   CONS_SEP_match2$`nombre_region_Ãuble (16)`,
                   CONS_SEP_match2$`nombre_region_O'Higgins (06)`,
                   CONS_SEP_match2$`nombre_region_TarapacÃ¡ (01)`,
                   CONS_SEP_match2$`nombre_region_ValparaÃ­so (05)`,
                   CONS_SEP_match2$tipo_centro_pub_FALSE,
                   CONS_SEP_match2$tipo_centro_pub_TRUE,
                   CONS_SEP_match2$prev_treat_0,
                   CONS_SEP_match2$prev_treat_1,
                   CONS_SEP_match2$`prev_treat_2 or more`,
                   CONS_SEP_match2$sexo_2_Men,
                   CONS_SEP_match2$sexo_2_Women)
mom_tols3 = absstddif(mom_covs, t_ind, .03)
mom3 = list(covs = mom_covs3, tols = mom_tols3, targets = NULL)

# Mean balance
covs3 = cbind(CONS_SEP_match2$edad_al_ing,CONS_SEP_match2$fech_ing_num,CONS_SEP_match2$edad_ini_cons)
meantab(covs3, t_ind)

# Fine balance
#is a matrix where each column is a nominal covariate for fine balance
fine_covs3 = cbind(CONS_SEP_match2$edad_ini_cons, 
                   CONS_SEP_match2$edad_al_ing, 
                   CONS_SEP_match2$fech_ing_num, 
                   CONS_SEP_match2$sus_ini_mod_mvv_Alcohol, 
                   CONS_SEP_match2$`sus_ini_mod_mvv_Cocaine hydrochloride`, 
                   CONS_SEP_match2$`sus_ini_mod_mvv_Cocaine paste`, 
                   CONS_SEP_match2$`sus_ini_mod_mvv_Marijuana`, 
                   CONS_SEP_match2$sus_ini_mod_mvv_Other, 
                   CONS_SEP_match2$`estado_conyugal_2_Married/Shared living arrangements`, 
                   CONS_SEP_match2$`estado_conyugal_2_Separated/Divorced`,
                   CONS_SEP_match2$estado_conyugal_2_Single, 
                   CONS_SEP_match2$estado_conyugal_2_Widower,
                   CONS_SEP_match2$`escolaridad_rec_1-More than high school`,
                   CONS_SEP_match2$`escolaridad_rec_2-Completed high school or less`,
                   CONS_SEP_match2$`escolaridad_rec_3-Completed primary school or less`,
                   CONS_SEP_match2$condicion_ocupacional_corr_Inactive,
                   CONS_SEP_match2$`condicion_ocupacional_corr_Looking for a job for the first time`,
                   CONS_SEP_match2$`condicion_ocupacional_corr_No activity`,
                   CONS_SEP_match2$`condicion_ocupacional_corr_Not seeking for work`,
                   CONS_SEP_match2$condicion_ocupacional_corr_Unemployed,
                   CONS_SEP_match2$`freq_cons_sus_prin_1 day a week or more`,
                   CONS_SEP_match2$`freq_cons_sus_prin_2 to 3 days a week`,
                   CONS_SEP_match2$`freq_cons_sus_prin_4 to 6 days a week`,
                   CONS_SEP_match2$freq_cons_sus_prin_Daily,
                   CONS_SEP_match2$`freq_cons_sus_prin_Did not use`,
                   CONS_SEP_match2$`freq_cons_sus_prin_Less than 1 day a week`,
                   CONS_SEP_match2$`origen_ingreso_mod_Assisted Referral`,
                   CONS_SEP_match2$`origen_ingreso_mod_Health Sector`,
                   CONS_SEP_match2$`origen_ingreso_mod_Justice Sector`,
                   CONS_SEP_match2$origen_ingreso_mod_Other,
                   CONS_SEP_match2$origen_ingreso_mod_Spontaneous,
                   CONS_SEP_match2$`dg_cie_10_rec_Diagnosis unknown (under study)`,
                   CONS_SEP_match2$`dg_cie_10_rec_With psychiatric comorbidity`,
                   CONS_SEP_match2$`dg_cie_10_rec_Without psychiatric comorbidity`,
                   CONS_SEP_match2$`nombre_region_Antofagasta (02)`,
                   CONS_SEP_match2$`nombre_region_AraucanÃ­a (09)`,
                   CONS_SEP_match2$`nombre_region_Arica (15)`,
                   CONS_SEP_match2$`nombre_region_Atacama (03)`,
                   CONS_SEP_match2$`nombre_region_AysÃ©n (11)`,
                   CONS_SEP_match2$`nombre_region_BiobÃ­o (08)`,
                   CONS_SEP_match2$`nombre_region_Coquimbo (04)`,
                   CONS_SEP_match2$`nombre_region_Los Lagos (10)`,
                   CONS_SEP_match2$`nombre_region_Magallanes (12)`,
                   CONS_SEP_match2$`nombre_region_Maule (07)`,
                   CONS_SEP_match2$`nombre_region_Metropolitana (13)`,
                   CONS_SEP_match2$`nombre_region_Ãuble (16)`,
                   CONS_SEP_match2$`nombre_region_O'Higgins (06)`,
                   CONS_SEP_match2$`nombre_region_TarapacÃ¡ (01)`,
                   CONS_SEP_match2$`nombre_region_ValparaÃ­so (05)`,
                   CONS_SEP_match2$tipo_centro_pub_FALSE,
                   CONS_SEP_match2$tipo_centro_pub_TRUE,
                   CONS_SEP_match2$prev_treat_0,
                   CONS_SEP_match2$prev_treat_1,
                   CONS_SEP_match2$`prev_treat_2 or more`,
                   CONS_SEP_match2$sexo_2_Men,
                   CONS_SEP_match2$sexo_2_Women)
fine3 = list(covs = fine_covs3)

#MATCH
start.time3 <- Sys.time()
set.seed(2125)
out3= cardmatch(t_ind, #ES NECESARIO QUE LOS TRATAMIENTOS ESTEN ORDENADOS Y LOS OTROS VECTORES TAMBIÃN 
                #mom= mom3,
                fine = fine3,# ya los definÃ­ list(covs = mom_covs, tols = mom_tols, targets = mom_targets), 
          solver = solver3)
end.time3 <- Sys.time()
time.taken3 <- end.time3 - start.time3

t_id_3 = out2$t_id  
c_id_3 = out2$c_id	

paste0("No. of treatments: ",table(table(t_id_3)) %>% formatC(big.mark = ","),"; No. of controls: ",table(table(c_id_3))%>% formatC(big.mark = ","))
d_match3 = CONS_SEP_match2[c(t_id_3, c_id_3), ]
d_match3_no_duplicates = CONS_SEP_match2[which(CONS_SEP_match2$row %in% c(t_id_3, c_id_3)), ]
```

<br>

## Explore Results of the Matching {.tabset .tabset-fade}

<br>

```{r  Fig 9_plot, warning=FALSE, fig.align = "center", message=F, fig.height=10, cache=T, eval=T, fig.cap="Figure 9. Empirical Cumulative Distribution Functions on the Matched Sample", results='asis'}

vars_ecdf<- c('edad_al_ing', 'edad_ini_cons', 'fech_ing_num')
headings <- c("Age at Admission", "Age of Onset of Drug Use", "Date of Admission")
for (i in 1:length(headings)) {
  cat("### ",headings[i],"\n")
  f<-vars_ecdf[i]
  df<-as.data.frame(CONS_SEP_match2)[,f]
  ecdfplot(df, t_id_3, c_id_3, main_title = "", legend_position = "right")
  cat('\n\n')
}
```

<br>

```{r  Fig 10_plot, warning=FALSE, fig.align = "center", message=F, fig.height=10, cache=T, eval=T, fig.cap="Figure 10. Love plot of the Matched Sample in Covariates v/s Unmatched Sample", results='asis'}

cat("### ","Love plot","\n")

X_mat<-subset(CONS_SEP_match2, select = -c(row, hash_key, evaluacindelprocesoteraputico_min, abandono_temprano_rec))


vline = 0.1
loveplot(X_mat=X_mat, t_id=t_id_3, c_id=c_id_3, v_line=vline, legend_position = "topright")
```

## {-}

</div>

```{r  Fig 11_plot, warning=FALSE, fig.align = "center", message=F, fig.height=10, cache=T, eval=T, fig.cap="Figure 11. Love plot of the Matched Sample in Covariates v/s Unmatched Sample", results='asis'}
love.plot(bal2, binary = "std", thresholds = c(m = .1, m=.2))+
  theme_bw()+
  ggtitle(NULL)+
  labs(caption="Note. Vertical dashed line= Standardized Differences of .1")+
  theme( plot.caption=element_text(hjust=0))

love.plot(out3, 
          drop.distance = TRUE, 
          var.order = "unadjusted",
          abs = TRUE,
          line = TRUE, 
          thresholds = c(m = .1),
          #var.names = new.names,
          colors = c("red", "blue"),
          shapes = c("triangle filled", "circle filled"))

bal.tab(out3, treat = CONS_SEP_match2$tipo_de_plan_res, covs = covs0)
```

# Inference

```{r  Fig tab2, warning=FALSE, fig.align = "center", message=F, fig.height=10, cache=T, eval=T}
total_sample<-CONS_C1_df_dup_SEP_2020_match_not_miss2 %>% 
  dplyr::filter(row %in% unlist(CONS_SEP_match$row))
matched_sample1<-CONS_C1_df_dup_SEP_2020_match_not_miss2 %>%  dplyr::filter(row %in% c(t_id_1, c_id_1))
matched_sample2<-CONS_C1_df_dup_SEP_2020_match_not_miss2[which(CONS_C1_df_dup_SEP_2020_match_not_miss2$row %in% c(t_id_2, c_id_2)), ]
matched_sample3<-CONS_C1_df_dup_SEP_2020_match_not_miss2[which(CONS_C1_df_dup_SEP_2020_match_not_miss2$row %in% c(t_id_3, c_id_3)), ]
tab1 <- table(total_sample$abandono_temprano_rec,total_sample$tipo_de_plan_res)
tab2 <- table(matched_sample1$abandono_temprano_rec,matched_sample1$tipo_de_plan_res)
tab3 <- table(matched_sample2$abandono_temprano_rec,matched_sample2$tipo_de_plan_res)
tab4 <- table(matched_sample3$abandono_temprano_rec,matched_sample3$tipo_de_plan_res)
#mhLS(tab1,tab2,Gamma=1,alpha=0.05,double=FALSE,inc=0.25)
mh(tab2,Gamma=1)
mh(tab2,Gamma=1.5)
mh(tab3,Gamma=2)

mh(tab3,Gamma=1)
mh(tab3,Gamma=1.5)

mh(tab4,Gamma=1)
mh(tab4,Gamma=1.5)

```
<br>

# Sensitiviy Analyses


<br>


# Session Info

```{r session_info, echo=T, paged.print=TRUE}
Sys.getenv("R_LIBS_USER")
rstudioapi::getSourceEditorContext()
sessionInfo()
```
